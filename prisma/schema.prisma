generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String             @id @default(uuid())
  clientId             String             @unique @default(cuid())
  email                String             @unique
  password             String
  name                 String?
  phone                String?
  country              String?
  createdAt            DateTime           @default(now())
  emailVerified        Boolean            @default(false)
  lastLoginAt          DateTime?
  role                 String             @default("user")
  status               String             @default("active")
  twoFactorEnabled     Boolean            @default(false)
  twoFactorSecret      String?
  twoFactorBackupCodes String[]           @default([])
  resetToken           String?
  resetTokenExpires    DateTime?
  accounts             Account[]          @relation("accounts")
  activityLogs         ActivityLog[]      @relation("activityLogs")
  DefaultMT5Account    DefaultMT5Account?
  deposits             Deposit[]          @relation("deposits")
  kyc                  KYC?               @relation("kyc")
  mt5Accounts          MT5Account[]       @relation("mt5Accounts")
  notifications        Notification[]     @relation("notifications")
  RefreshToken         RefreshToken[]
  terminalSettings     TerminalSettings?
  UserFavorite         UserFavorite[]
  userLoginLogs        UserLoginLog[]     @relation("userLoginLogs")
  suggestions          Suggestion[]
  priceAlerts          PriceAlert[]

  @@index([resetToken], map: "idx_user_reset_token")
}

model KYC {
  id                  String    @id @default(uuid())
  isDocumentVerified  Boolean   @default(false)
  isAddressVerified   Boolean   @default(false)
  verificationStatus  String    @default("Pending")
  documentReference   String?
  addressReference    String?
  amlReference        String?
  documentSubmittedAt DateTime?
  addressSubmittedAt  DateTime?
  rejectionReason     String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  userId              String    @unique
  user                User      @relation("kyc", fields: [userId], references: [id])
}

model MT5Account {
  id                String              @id @default(uuid())
  accountId         String              @unique
  userId            String?
  accountType       String              @default("Live")
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  password          String?
  leverage          Int?
  nameOnAccount     String?
  package           String?
  group             String?
  balance           Float?              @default(0)
  credit            Float?              @default(0)
  currency          String?             @default("USD")
  equity            Float?              @default(0)
  lastSyncedAt      DateTime?
  margin            Float?              @default(0)
  marginFree        Float?              @default(0)
  marginLevel       Float?              @default(0)
  profit            Float?              @default(0)
  archived          Boolean             @default(false)
  archived_at       DateTime?           @db.Timestamptz(6)
  DefaultMT5Account DefaultMT5Account[]
  deposits          Deposit[]           @relation("deposits")
  user              User?               @relation("mt5Accounts", fields: [userId], references: [id])
  mt5Transactions   MT5Transaction[]    @relation("mt5Transactions")
  UserFavorite      UserFavorite[]

  @@index([archived], map: "idx_mt5account_archived")
  @@index([userId, archived], map: "idx_mt5account_userid_archived")
  @@index([archived], map: "ix_MT5Account_archived")
}

model MT5Transaction {
  id            String     @id @default(uuid()) @db.VarChar
  type          String     @db.VarChar
  amount        Float
  status        String?    @db.VarChar
  paymentMethod String?    @db.VarChar
  transactionId String?    @db.VarChar
  comment       String?    @db.VarChar
  mt5AccountId  String     @db.VarChar
  createdAt     DateTime?  @default(now()) @db.Timestamptz(6)
  currency      String?    @db.VarChar
  depositId     String?    @db.VarChar
  withdrawalId  String?    @db.VarChar
  userId        String?    @db.VarChar
  processedBy   String?    @db.VarChar
  processedAt   DateTime?  @db.Timestamptz(6)
  updatedAt     DateTime?  @default(now()) @updatedAt @db.Timestamptz(6)
  mt5Account    MT5Account @relation("mt5Transactions", fields: [mt5AccountId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([depositId], map: "ix_MT5Transaction_depositId")
  @@index([mt5AccountId], map: "ix_MT5Transaction_mt5AccountId")
  @@index([status], map: "ix_MT5Transaction_status")
  @@index([type], map: "ix_MT5Transaction_type")
  @@index([userId], map: "ix_MT5Transaction_userId")
  @@index([withdrawalId], map: "ix_MT5Transaction_withdrawalId")
}

model Account {
  id          String   @id @default(uuid())
  userId      String
  accountType String
  balance     Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation("accounts", fields: [userId], references: [id])
}

model Deposit {
  id                    String     @id @default(uuid())
  userId                String
  mt5AccountId          String
  amount                Float
  currency              String     @default("USD")
  method                String
  paymentMethod         String?
  transactionHash       String?
  proofFileUrl          String?
  bankDetails           String?
  cryptoAddress         String?
  depositAddress        String?
  externalTransactionId String?
  status                String     @default("pending")
  rejectionReason       String?
  approvedBy            String?
  approvedAt            DateTime?
  rejectedAt            DateTime?
  processedAt           DateTime?
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
  mt5Account            MT5Account @relation("deposits", fields: [mt5AccountId], references: [id])
  user                  User       @relation("deposits", fields: [userId], references: [id])
  cregisDeposit         CregisDeposit?

  @@index([userId])
  @@index([mt5AccountId])
  @@index([status])
  @@index([createdAt])
}

model CregisDeposit {
  id            String    @id @default(uuid())
  depositId     String    @unique @map("deposit_id")
  cregisOrderId String    @unique @map("cregis_order_id")
  cregisStatus  String    @default("pending") @map("cregis_status")
  amount        Float
  currency      String    @default("USDT")
  paymentUrl    String?   @map("payment_url")
  qrCodeUrl     String?   @map("qr_code_url")
  expiresAt     DateTime? @map("expires_at")
  webhookData   Json?     @map("webhook_data")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")
  deposit       Deposit   @relation(fields: [depositId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([depositId], map: "CregisDeposit_deposit_id_idx")
  @@index([cregisOrderId], map: "CregisDeposit_cregis_order_id_idx")
  @@index([cregisStatus], map: "CregisDeposit_cregis_status_idx")
  @@map("CregisDeposit")
}

model Withdrawal {
  id                    String    @id @default(dbgenerated("gen_random_uuid()"))
  userId                String
  amount                Float
  method                String
  bankDetails           String?
  cryptoAddress         String?
  status                String    @default("pending")
  rejectionReason       String?
  approvedBy            String?
  approvedAt            DateTime?
  rejectedAt            DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @default(now()) @updatedAt
  currency              String    @default("USD")
  externalTransactionId String?
  paymentMethod         String?
  processedAt           DateTime?
  walletAddress         String?
  walletId              String?
  mt5AccountId          String?

  @@index([userId])
  @@index([mt5AccountId])
  @@index([status])
  @@index([createdAt])
  @@index([walletId])
}

model Wallet {
  id           String   @id @default(uuid())
  userId       String   @unique
  balance      Float    @default(0)
  currency     String   @default("USD")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt
  walletNumber String?  @default(dbgenerated("('ZUP'::text || (floor(((random() * (9000000)::double precision) + (1000000)::double precision)))::text)"))
}

model WalletTransaction {
  id           String   @id @default(uuid())
  walletId     String
  userId       String
  type         String
  amount       Float
  status       String   @default("completed")
  description  String?
  mt5AccountId String?
  withdrawalId String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  @@index([walletId])
  @@index([userId])
  @@index([type])
  @@index([withdrawalId])
}

model ActivityLog {
  id        String   @id @default(uuid())
  userId    String?
  adminId   String
  action    String
  entity    String
  entityId  String?
  ipAddress String?
  userAgent String?
  oldValues String?
  newValues String?
  createdAt DateTime @default(now())
  admin     User     @relation("activityLogs", fields: [adminId], references: [id])
}

model SystemSetting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  category    String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  permissions String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PaymentMethod {
  id              String    @id @default(uuid())
  userId          String
  address         String?
  currency        String    @default("USDT")
  network         String    @default("TRC20")
  status          String    @default("pending")
  submittedAt     DateTime  @default(now())
  approvedAt      DateTime?
  approvedBy      String?
  rejectionReason String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  methodType      String    @default("crypto")
  bankName        String?
  accountName     String?
  accountNumber   String?
  ifscSwiftCode   String?
  accountType     String?

  @@index([userId])
  @@index([status])
}

model UserRole {
  id         String   @id @default(uuid())
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  assignedBy String
}

model DefaultMT5Account {
  id           String     @id @default(uuid())
  userId       String     @unique
  mt5AccountId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  MT5Account   MT5Account @relation(fields: [mt5AccountId], references: [accountId])
  User         User       @relation(fields: [userId], references: [id])

  @@index([mt5AccountId])
}

model Instrument {
  id           String         @id
  symbol       String         @unique
  name         String?
  description  String?
  category     String
  group        String?
  digits       Int            @default(5)
  contractSize Float          @default(100000)
  minVolume    Float          @default(0.01)
  maxVolume    Float          @default(100)
  volumeStep   Float          @default(0.01)
  spread       Float          @default(0)
  isActive     Boolean        @default(true)
  tradingHours String?
  lastUpdated  DateTime
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  // New fields from MT5 API
  path              String?  @db.Text
  accountGroup      String?  @db.Text
  isin              String?
  sector            Int?
  industry          Int?
  country           String?
  currency          String?
  currencyProfit    String?
  currencyMargin    String?
  point             Float?
  multiply          Int?
  tickSize          Float?
  tickValue         Float?
  volumeLimit       Float?
  marginInitial     Float?
  marginMaintenance Float?
  tradeMode         Int?
  tradeFlags        Int?
  calcMode          Int?
  execMode          Int?
  swapLong          Float?
  swapShort         Float?
  swapMode          Int?
  UserFavorite UserFavorite[]
}

model RefreshToken {
  id           String    @id @db.VarChar
  userId       String    @db.VarChar
  token        String    @unique(map: "ix_RefreshToken_token") @db.VarChar
  expiresAt    DateTime  @db.Timestamptz(6)
  createdAt    DateTime? @default(now()) @db.Timestamptz(6)
  revoked      Boolean?
  deviceName   String?   @db.VarChar(255)
  ipAddress    String?   @db.VarChar(255)
  userAgent    String?   @db.VarChar(255)
  lastActivity DateTime? @default(now()) @db.Timestamptz(6)
  User         User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([expiresAt], map: "ix_RefreshToken_expiresAt")
  @@index([userId], map: "ix_RefreshToken_userId")
  @@index([lastActivity], map: "ix_RefreshToken_lastActivity")
}

model UserFavorite {
  id           String     @id @default(uuid())
  userId       String
  instrumentId String
  mt5AccountId String?    // Optional for backward compatibility during migration, but should be populated
  sortOrder    Int        @default(0)
  addedAt      DateTime   @default(now())
  Instrument   Instrument @relation(fields: [instrumentId], references: [id])
  User         User       @relation(fields: [userId], references: [id])
  MT5Account   MT5Account? @relation(fields: [mt5AccountId], references: [id])

  @@unique([userId, instrumentId, mt5AccountId])
  @@index([instrumentId])
  @@index([userId])
  @@index([mt5AccountId])
}

model UserLoginLog {
  id             String   @id @default(uuid())
  userId         String
  user_agent     String?
  device         String?
  browser        String?
  success        Boolean  @default(true)
  failure_reason String?
  createdAt      DateTime @default(now())
  user           User     @relation("userLoginLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model TerminalSettings {
  id                           String   @id @default(uuid())
  userId                       String   @unique
  showOnChart                  Boolean  @default(true)
  showSignals                  Boolean  @default(false)
  showHMR                      Boolean  @default(true)
  showPriceAlerts              Boolean  @default(true)
  showOpenPositions            Boolean  @default(true)
  showTPSL                     Boolean  @default(true)
  showEconomicCalendar         Boolean  @default(true)
  economicCalendarHighImpact   Boolean  @default(true)
  economicCalendarMiddleImpact Boolean  @default(false)
  economicCalendarLowImpact    Boolean  @default(false)
  economicCalendarLowestImpact Boolean  @default(false)
  priceAlertSound              Boolean  @default(false)
  closingSound                 Boolean  @default(false)
  autoTPSL                     Boolean  @default(false)
  openOrderMode                String   @default("regular")
  priceSource                  String   @default("bid")
  appearance                   String   @default("dark")
  timezone                     String   @default("utc")
  createdAt                    DateTime @default(now())
  updatedAt                    DateTime @updatedAt
  user                         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model admin {
  id                        Int                         @id @default(autoincrement())
  username                  String                      @unique @db.VarChar(255)
  email                     String                      @unique @db.VarChar(255)
  password_hash             String                      @db.VarChar(255)
  admin_role                String?                     @default("admin") @db.VarChar(50)
  is_active                 Boolean?                    @default(true)
  last_login                DateTime?                   @db.Timestamptz(6)
  login_attempts            Int?                        @default(0)
  locked_until              DateTime?                   @db.Timestamptz(6)
  created_at                DateTime?                   @default(now()) @db.Timestamptz(6)
  updated_at                DateTime?                   @default(now()) @db.Timestamptz(6)
  admin_login_log           admin_login_log[]
  balance_operation_history balance_operation_history[]
}

model admin_login_log {
  id             Int      @id @default(autoincrement())
  admin_id       Int
  ip_address     String   @db.VarChar(45)
  user_agent     String?
  location       String?  @db.VarChar(255)
  device         String?  @db.VarChar(255)
  browser        String?  @db.VarChar(255)
  os             String?  @db.VarChar(255)
  success        Boolean  @default(true)
  failure_reason String?  @db.VarChar(255)
  created_at     DateTime @default(now()) @db.Timestamptz(6)
  admin          admin    @relation(fields: [admin_id], references: [id], onDelete: Cascade)

  @@index([admin_id])
  @@index([created_at])
}

model balance_operation_history {
  id             Int      @id @default(autoincrement())
  admin_id       Int
  mt5_login      String   @db.VarChar(50)
  operation_type String   @db.VarChar(50)
  amount         Float
  currency       String   @default("USD") @db.VarChar(10)
  description    String?
  status         String   @default("completed") @db.VarChar(20)
  error_message  String?
  ip_address     String?  @db.VarChar(45)
  user_agent     String?
  created_at     DateTime @default(now()) @db.Timestamptz(6)
  admin          admin    @relation(fields: [admin_id], references: [id], onDelete: Cascade)

  @@index([admin_id])
  @@index([created_at])
  @@index([mt5_login])
  @@index([operation_type])
}

model chat_conversations {
  id                 Int                 @id @default(autoincrement())
  user_id            String              @db.VarChar(255)
  user_name          String              @db.VarChar(255)
  user_email         String              @db.VarChar(255)
  admin_id           String?             @db.VarChar(255)
  status             String?             @default("open") @db.VarChar(20)
  priority           String?             @default("normal") @db.VarChar(20)
  subject            String?             @db.VarChar(500)
  last_message_at    DateTime?           @default(now()) @db.Timestamptz(6)
  created_at         DateTime?           @default(now()) @db.Timestamptz(6)
  updated_at         DateTime?           @default(now()) @db.Timestamptz(6)
  closed_at          DateTime?           @db.Timestamptz(6)
  closed_by          String?             @db.VarChar(255)
  tags               String[]            @default([])
  unread_count_admin Int?                @default(0)
  unread_count_user  Int?                @default(0)
  chat_messages      chat_messages[]
  chat_participants  chat_participants[]
}

model chat_messages {
  id                 Int                 @id @default(autoincrement())
  conversation_id    Int?
  sender_id          String              @db.VarChar(255)
  sender_name        String              @db.VarChar(255)
  sender_type        String              @db.VarChar(20)
  message_type       String?             @default("text") @db.VarChar(20)
  content            String
  metadata           Json?               @default("{}")
  is_read            Boolean?            @default(false)
  read_at            DateTime?           @db.Timestamptz(6)
  created_at         DateTime?           @default(now()) @db.Timestamptz(6)
  updated_at         DateTime?           @default(now()) @db.Timestamptz(6)
  chat_conversations chat_conversations? @relation(fields: [conversation_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model chat_participants {
  id                 Int                 @id @default(autoincrement())
  conversation_id    Int?
  user_id            String              @db.VarChar(255)
  user_name          String              @db.VarChar(255)
  user_type          String              @db.VarChar(20)
  role               String?             @default("participant") @db.VarChar(20)
  joined_at          DateTime?           @default(now()) @db.Timestamptz(6)
  left_at            DateTime?           @db.Timestamptz(6)
  is_active          Boolean?            @default(true)
  chat_conversations chat_conversations? @relation(fields: [conversation_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([conversation_id, user_id])
}

model group_commission_structures {
  id                      Int       @id @default(autoincrement())
  group_id                String    @db.VarChar(255)
  structure_name          String    @db.VarChar(100)
  usd_per_lot             Decimal   @default(0.00) @db.Decimal(10, 2)
  spread_share_percentage Decimal   @default(0.00) @db.Decimal(5, 2)
  is_active               Boolean   @default(true)
  created_at              DateTime? @default(now()) @db.Timestamptz(6)
  updated_at              DateTime? @default(now()) @db.Timestamptz(6)
  level_order             Int       @default(1)
  min_trading_volume      Decimal?  @default(0) @db.Decimal(15, 2)
  max_trading_volume      Decimal?  @db.Decimal(15, 2)
  min_active_clients      Int?      @default(0)

  @@unique([group_id, structure_name])
  @@unique([group_id, level_order], map: "ux_commission_group_level")
  @@index([group_id], map: "idx_commission_structures_group")
  @@index([level_order], map: "idx_commission_structures_level_order")
}

model ib_admin {
  id             Int       @id @default(autoincrement())
  email          String    @unique @db.VarChar(255)
  password_hash  String    @db.VarChar(255)
  role           String?   @default("admin") @db.VarChar(50)
  is_active      Boolean?  @default(true)
  last_login     DateTime? @db.Timestamptz(6)
  login_attempts Int?      @default(0)
  locked_until   DateTime? @db.Timestamptz(6)
  created_at     DateTime? @default(now()) @db.Timestamptz(6)
  updated_at     DateTime? @default(now()) @db.Timestamptz(6)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model ib_requests {
  id                        Int                    @id @default(autoincrement())
  full_name                 String                 @db.VarChar(255)
  email                     String                 @unique @db.VarChar(255)
  password_hash             String                 @db.VarChar(255)
  status                    String                 @default("pending") @db.VarChar(50)
  ib_type                   String                 @default("common") @db.VarChar(255)
  submitted_at              DateTime?              @default(now()) @db.Timestamptz(6)
  approved_at               DateTime?              @db.Timestamptz(6)
  usd_per_lot               Decimal?               @db.Decimal(10, 2)
  spread_percentage_per_lot Decimal?               @db.Decimal(5, 2)
  admin_comments            String?
  group_id                  String?                @db.VarChar(255)
  structure_id              Int?
  created_at                DateTime?              @default(now()) @db.Timestamptz(6)
  updated_at                DateTime?              @default(now()) @db.Timestamptz(6)
  referral_code             String?                @unique @db.VarChar(8)
  referred_by               Int?
  country                   String?                @db.VarChar(100)
  ib_group_assignments      ib_group_assignments[]

  @@index([referral_code], map: "idx_ib_requests_referral_code")
  @@index([referred_by], map: "idx_ib_requests_referred_by")
}

model manual_gateway {
  id             Int      @id @default(autoincrement())
  type           String   @db.VarChar(50)
  name           String   @db.VarChar(255)
  details        String
  icon_url       String?  @db.VarChar(500)
  qr_code_url    String?  @db.VarChar(500)
  is_active      Boolean  @default(true)
  created_at     DateTime @default(now()) @db.Timestamptz(6)
  updated_at     DateTime @db.Timestamptz(6)
  vpa_address    String?  @db.VarChar(255)
  crypto_address String?  @db.VarChar(255)
  bank_name      String?  @db.VarChar(255)
  account_name   String?  @db.VarChar(255)
  account_number String?  @db.VarChar(255)
  ifsc_code      String?  @db.VarChar(50)
  swift_code     String?  @db.VarChar(50)
  account_type   String?  @db.VarChar(50)
  country_code   String?  @db.VarChar(2)

  @@index([is_active])
  @@index([type])
}

model mt5_groups {
  id          Int       @id @default(autoincrement())
  group_id    String    @unique @db.VarChar(255)
  name        String    @db.VarChar(255)
  description String?
  synced_at   DateTime? @default(now()) @db.Timestamptz(6)
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @default(now()) @db.Timestamptz(6)
}

model payment_gateway {
  id                     Int      @id @default(autoincrement())
  wallet_name            String   @db.VarChar(255)
  deposit_wallet_address String   @db.VarChar(255)
  api_key                String
  secret_key             String
  gateway_type           String   @db.VarChar(50)
  is_active              Boolean  @default(true)
  description            String?
  created_at             DateTime @default(now()) @db.Timestamptz(6)
  updated_at             DateTime @db.Timestamptz(6)

  @@index([gateway_type])
  @@index([is_active])
}

model symbols {
  id            Int       @id @default(autoincrement())
  symbol_name   String    @unique @db.VarChar(50)
  description   String?
  symbol_type   String?   @db.VarChar(20)
  group_name    String?   @db.VarChar(100)
  digits        Int?      @default(5)
  spread        Float?    @default(0)
  contract_size Int?      @default(100000)
  profit_mode   String?   @default("forex") @db.VarChar(20)
  enable        Boolean?  @default(true)
  swap_mode     String?   @default("disabled") @db.VarChar(20)
  swap_long     Float?    @default(0)
  swap_short    Float?    @default(0)
  swap3_day     String?   @default("wednesday") @db.VarChar(10)
  created_at    DateTime? @default(now()) @db.Timestamp(6)
  updated_at    DateTime? @default(now()) @db.Timestamp(6)
}

model ib_group_assignments {
  id                      Int          @id @default(autoincrement())
  ib_request_id           Int?
  group_id                String       @db.VarChar(255)
  group_name              String?      @db.VarChar(255)
  structure_id            Int?
  structure_name          String?      @db.VarChar(255)
  usd_per_lot             Decimal      @default(0) @db.Decimal(10, 2)
  spread_share_percentage Decimal      @default(0) @db.Decimal(5, 2)
  created_at              DateTime?    @default(now()) @db.Timestamptz(6)
  updated_at              DateTime?    @default(now()) @db.Timestamptz(6)
  ib_requests             ib_requests? @relation(fields: [ib_request_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model ib_trade_history {
  id            String    @id
  order_id      String    @unique
  account_id    String
  user_id       String?
  ib_request_id Int?
  symbol        String
  order_type    String
  volume_lots   Decimal   @db.Decimal
  open_price    Decimal?  @db.Decimal
  close_price   Decimal?  @db.Decimal
  profit        Decimal?  @db.Decimal
  ib_commission Decimal?  @default(0) @db.Decimal
  take_profit   Decimal?  @db.Decimal
  stop_loss     Decimal?  @db.Decimal
  created_at    DateTime? @default(now()) @db.Timestamp(6)
  updated_at    DateTime? @default(now()) @db.Timestamp(6)
  synced_at     DateTime? @default(now()) @db.Timestamp(6)
  group_id      String?

  @@index([account_id], map: "idx_ib_trade_account")
  @@index([group_id], map: "idx_ib_trade_group")
  @@index([ib_request_id], map: "idx_ib_trade_ib")
  @@index([symbol], map: "idx_ib_trade_symbol")
  @@index([user_id], map: "idx_ib_trade_user")
}

model support_tickets {
  id             Int       @id @default(autoincrement())
  ticket_no      String    @unique @db.VarChar(50)
  parent_id      String    @db.VarChar(255)
  title          String    @db.VarChar(500)
  description    String?
  ticket_type    String?   @db.VarChar(100)
  status         String    @default("New") @db.VarChar(50)
  priority       String    @default("normal") @db.VarChar(20)
  assigned_to    String?   @db.VarChar(255)
  account_number String?   @db.VarChar(50)
  tags           String[]  @default([])
  created_at     DateTime  @default(now()) @db.Timestamptz(6)
  updated_at     DateTime  @default(now()) @db.Timestamptz(6)
  last_reply_at  DateTime?
  closed_at      DateTime?
  closed_by      String?   @db.VarChar(255)

  @@index([parent_id])
  @@index([status])
  @@index([ticket_no])
  @@index([created_at])
}

model support_ticket_replies {
  id          Int      @id @default(autoincrement())
  ticket_id   Int
  reply_id    Int?
  sender_id   String   @db.VarChar(255)
  sender_name String   @db.VarChar(255)
  sender_type String   @db.VarChar(20)
  content     String
  is_internal Boolean  @default(false)
  attachments String[] @default([])
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @db.Timestamptz(6)
  is_read     Boolean  @default(false)

  @@index([ticket_id])
  @@index([reply_id])
  @@index([created_at])
}

model support_articles {
  id                Int       @id @default(autoincrement())
  title             String    @db.VarChar(500)
  slug              String    @unique @db.VarChar(500)
  content           String
  excerpt           String?   @db.VarChar(1000)
  category          String    @db.VarChar(100)
  tags              String[]
  views             Int       @default(0)
  helpful_count     Int       @default(0)
  not_helpful_count Int       @default(0)
  is_published      Boolean   @default(false)
  author_id         String    @db.VarChar(255)
  created_at        DateTime  @default(now()) @db.Timestamptz(6)
  updated_at        DateTime  @default(now()) @db.Timestamptz(6)
  published_at      DateTime?

  @@index([slug])
  @@index([category])
  @@index([is_published])
  @@index([created_at])
}

model support_faq {
  id                Int      @id @default(autoincrement())
  question          String   @db.VarChar(500)
  answer            String
  category          String   @db.VarChar(100)
  tags              String[]
  helpful_count     Int      @default(0)
  not_helpful_count Int      @default(0)
  display_order     Int      @default(0)
  is_active         Boolean  @default(true)
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @default(now()) @db.Timestamptz(6)

  @@index([category])
  @@index([is_active])
  @@index([display_order])
}

model support_categories {
  id            Int      @id @default(autoincrement())
  name          String   @unique @db.VarChar(100)
  slug          String   @unique @db.VarChar(100)
  description   String?  @db.VarChar(500)
  icon          String?  @db.VarChar(100)
  display_order Int      @default(0)
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  updated_at    DateTime @default(now()) @db.Timestamptz(6)

  @@index([slug])
  @@index([is_active])
}

model support_replies {
  id          Int      @id @default(autoincrement())
  ticket_id   Int
  sender_id   String   @db.VarChar(255)
  sender_name String   @db.VarChar(255)
  sender_type String   @db.VarChar(20)
  content     String
  is_internal Boolean  @default(false)
  created_at  DateTime @default(now()) @db.Timestamptz(6)

  @@index([ticket_id])
}

model Notification {
  id        String    @id @default(uuid())
  userId    String    @map("userId")
  type      String    @db.VarChar(50)
  title     String    @db.VarChar(255)
  message   String
  isRead    Boolean   @default(false) @map("isRead")
  metadata  Json?
  createdAt DateTime  @default(now()) @map("createdAt") @db.Timestamptz(6)
  readAt    DateTime? @map("readAt") @db.Timestamptz(6)
  user      User      @relation("notifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([type])
  @@map("Notification")
}

model group_management {
  id                Int       @id @default(autoincrement())

  group             String    @unique @db.VarChar(255)
  server            Int?      @default(1)
  auth_mode         Int?      @default(0)
  auth_password_min Int?      @default(8)
  currency          String?   @db.VarChar(10)
  is_active         Boolean?  @default(true)
  synced_at         DateTime? @db.Timestamptz(6)
  created_at        DateTime? @default(now()) @db.Timestamptz(6)
  updated_at        DateTime? @default(now()) @db.Timestamptz(6)
  dedicated_name    String?   @db.VarChar(255)
  account_type      String?   @db.VarChar(10)
  leverage          Int?
  min_deposit       Decimal?  @db.Decimal(10, 2)
  spread            Decimal?  @db.Decimal(5, 2)
  commission        Decimal?  @db.Decimal(5, 2)

  @@index([group])
  @@index([is_active])
  @@index([server])
  @@index([account_type])
}

model SymbolGroupAccess {
  id                Int       @id @default(autoincrement())
  symbol            String    @db.VarChar(100)
  group_name        String    @db.VarChar(255)
  is_allowed        Boolean   @default(true)
  created_at        DateTime  @default(now()) @db.Timestamptz(6)
  updated_at        DateTime  @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([symbol, group_name])
  @@index([symbol])
  @@index([group_name])
  @@index([is_allowed])
}

model Transaction {
  id            String   @id
  userId        String
  type          String
  amount        Float
  status        String   @default("pending")
  currency      String   @default("USD")
  paymentMethod String?
  transactionId String?
  description   String?
  metadata      String?
  depositId     String?
  withdrawalId  String?
  updatedAt     DateTime
  createdAt     DateTime @default(now())

  @@index([depositId])
  @@index([status])
  @@index([type])
  @@index([userId])
  @@index([withdrawalId])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model admin_transactions {
  id                      BigInt   @id @default(autoincrement())
  admin_id                Int
  user_id                 String?  @db.VarChar(255)
  mt5_account_id          String?  @db.VarChar(255)
  mt5_login               String   @db.VarChar(64)
  operation_type          String   @db.VarChar(20)
  amount                  Decimal  @db.Decimal(18, 2)
  currency                String   @default("USD") @db.VarChar(10)
  status                  String   @default("completed") @db.VarChar(20)
  comment                 String?
  external_transaction_id String?
  ip_address              String?  @db.VarChar(45)
  user_agent              String?
  error_message           String?
  created_at              DateTime @default(now()) @db.Timestamptz(6)
  updated_at              DateTime @default(now()) @db.Timestamptz(6)

  @@index([admin_id], map: "idx_admin_tx_admin")
  @@index([created_at(sort: Desc)], map: "idx_admin_tx_created_at")
  @@index([external_transaction_id], map: "idx_admin_tx_ext_tx")
  @@index([mt5_login], map: "idx_admin_tx_mt5_login")
  @@index([operation_type, status], map: "idx_admin_tx_op_status")
  @@index([user_id], map: "idx_admin_tx_user")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model countries {
  code         String  @id @db.VarChar(2)
  country      String? @db.VarChar(100)
  country_code String? @db.VarChar(6)
}

model country_admins {
  id           Int       @id @default(autoincrement())
  name         String    @db.VarChar(100)
  email        String    @unique @db.VarChar(150)
  status       String?   @default("inactive") @db.VarChar(50)
  country_code String?   @db.VarChar(2)
  features     String?
  created_at   DateTime? @default(now()) @db.Timestamp(6)
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model email_templates {
  id                Int       @id @default(autoincrement())
  name              String    @unique @db.VarChar(255)
  description       String?
  html_code         String
  variables         String[]  @default([])
  is_default        Boolean?  @default(false)
  preview_image_url String?   @db.VarChar(500)
  created_at        DateTime? @default(now()) @db.Timestamp(6)
  updated_at        DateTime? @default(now()) @db.Timestamp(6)
  created_by        String?   @db.VarChar(255)

  @@index([created_at], map: "idx_email_templates_created_at")
  @@index([created_by], map: "idx_email_templates_created_by")
  @@index([is_default], map: "idx_email_templates_is_default")
  @@index([name], map: "idx_email_templates_name")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model ib_client_linking {
  id                 Int       @id @default(autoincrement())
  user_id            String
  user_name          String    @db.VarChar(255)
  user_email         String    @db.VarChar(255)
  user_account_id    String?
  current_ib_id      Int?
  current_ib_name    String?   @db.VarChar(255)
  current_ib_code    String?   @db.VarChar(100)
  assigned_ib_id     Int
  assigned_ib_name   String    @db.VarChar(255)
  assigned_ib_code   String?   @db.VarChar(100)
  assigned_ib_email  String?   @db.VarChar(255)
  status             String?   @default("active") @db.VarChar(20)
  direct_volume_lots Decimal?  @default(0.00) @db.Decimal(15, 2)
  direct_commission  Decimal?  @default(0.00) @db.Decimal(15, 2)
  linked_at          DateTime? @default(now()) @db.Timestamptz(6)
  created_at         DateTime? @default(now()) @db.Timestamptz(6)
  updated_at         DateTime? @default(now()) @db.Timestamptz(6)
  created_by         Int?

  @@unique([user_id, assigned_ib_id, status])
  @@index([assigned_ib_id], map: "idx_ib_client_linking_assigned_ib_id")
  @@index([status], map: "idx_ib_client_linking_status")
  @@index([user_id], map: "idx_ib_client_linking_user_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model ib_client_linking_history {
  id            Int       @id @default(autoincrement())
  linking_id    Int?
  user_id       String
  user_name     String    @db.VarChar(255)
  user_email    String    @db.VarChar(255)
  from_ib_id    Int?
  from_ib_name  String?   @db.VarChar(255)
  from_ib_code  String?   @db.VarChar(100)
  to_ib_id      Int
  to_ib_name    String    @db.VarChar(255)
  to_ib_code    String?   @db.VarChar(100)
  action        String    @db.VarChar(20)
  moved_by      Int?
  moved_by_name String?   @db.VarChar(255)
  notes         String?
  created_at    DateTime? @default(now()) @db.Timestamptz(6)

  @@index([created_at(sort: Desc)], map: "idx_ib_client_linking_history_created_at")
  @@index([linking_id], map: "idx_ib_client_linking_history_linking_id")
  @@index([user_id], map: "idx_ib_client_linking_history_user_id")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model ib_commission {
  id                Int       @id @default(autoincrement())
  ib_request_id     Int
  user_id           String
  total_commission  Decimal?  @default(0) @db.Decimal(15, 2)
  last_updated      DateTime? @default(now()) @db.Timestamptz(6)
  created_at        DateTime? @default(now()) @db.Timestamptz(6)
  updated_at        DateTime? @default(now()) @db.Timestamptz(6)
  total_trades      Int?      @default(0)
  total_lots        Decimal?  @default(0) @db.Decimal(15, 2)
  fixed_commission  Decimal?  @default(0) @db.Decimal(15, 2)
  spread_commission Decimal?  @default(0) @db.Decimal(15, 2)

  @@unique([ib_request_id, user_id])
  @@index([ib_request_id], map: "idx_ib_commission_ib_request")
  @@index([last_updated], map: "idx_ib_commission_updated")
  @@index([user_id], map: "idx_ib_commission_user")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model ib_level_up_history {
  id                        Int       @id @default(autoincrement())
  ib_request_id             Int
  from_structure_id         Int?
  to_structure_id           Int
  from_structure_name       String?   @db.VarChar(255)
  to_structure_name         String?   @db.VarChar(255)
  trading_volume_at_upgrade Decimal?  @db.Decimal(15, 2)
  active_clients_at_upgrade Int?
  upgraded_at               DateTime? @default(now()) @db.Timestamptz(6)
  created_at                DateTime? @default(now()) @db.Timestamptz(6)

  @@index([ib_request_id], map: "idx_ib_level_up_history_ib_request_id")
  @@index([upgraded_at(sort: Desc)], map: "idx_ib_level_up_history_upgraded_at")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model ib_referrals {
  id            Int       @id @default(autoincrement())
  ib_request_id Int
  user_id       String?
  email         String
  referral_code String    @db.VarChar(16)
  source        String?   @default("crm")
  created_at    DateTime? @default(now()) @db.Timestamptz(6)

  @@index([referral_code], map: "ix_ib_referrals_code")
  @@index([ib_request_id], map: "ix_ib_referrals_ib")
  @@index([user_id], map: "ix_ib_referrals_user")
}

model ib_reward_claims {
  id                           Int       @id @default(autoincrement())
  ib_request_id                Int
  user_id                      String    @db.VarChar(255)
  reward_id                    Int
  reward_value                 String    @db.VarChar(50)
  reward_description           String    @db.VarChar(255)
  reward_type                  String    @db.VarChar(50)
  claimant_name                String    @db.VarChar(255)
  claimant_phone               String    @db.VarChar(50)
  claimant_email               String    @db.VarChar(255)
  claimant_address_street      String?
  claimant_address_city        String?   @db.VarChar(100)
  claimant_address_state       String?   @db.VarChar(100)
  claimant_address_country     String?   @db.VarChar(100)
  claimant_address_postal_code String?   @db.VarChar(50)
  status                       String    @default("pending") @db.VarChar(50)
  total_volume_mln             Decimal   @db.Decimal(15, 2)
  admin_notes                  String?
  claimed_at                   DateTime? @default(now()) @db.Timestamptz(6)
  updated_at                   DateTime? @default(now()) @db.Timestamptz(6)
  created_at                   DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([ib_request_id, reward_id])
  @@index([claimed_at], map: "idx_ib_reward_claims_claimed_at")
  @@index([ib_request_id], map: "idx_ib_reward_claims_ib_request")
  @@index([reward_id], map: "idx_ib_reward_claims_reward_id")
  @@index([status], map: "idx_ib_reward_claims_status")
  @@index([user_id], map: "idx_ib_reward_claims_user")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model ib_withdrawal_requests {
  id              Int       @id @default(autoincrement())
  ib_request_id   Int
  amount          Decimal   @db.Decimal
  method          String
  account_details String?
  status          String    @default("pending")
  created_at      DateTime? @default(now()) @db.Timestamp(6)
  transaction_id  String?
  updated_at      DateTime? @default(now()) @db.Timestamp(6)

  @@index([ib_request_id], map: "idx_ib_withdrawal_ib")
  @@index([status], map: "idx_ib_withdrawal_status")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model sent_emails {
  id                Int       @id @default(autoincrement())
  recipient_email   String    @db.VarChar(255)
  recipient_name    String?   @db.VarChar(255)
  subject           String
  content_body      String
  is_html           Boolean?  @default(true)
  recipient_type    String?   @db.VarChar(50)
  status            String?   @default("pending") @db.VarChar(20)
  error_message     String?
  sent_at           DateTime? @db.Timestamp(6)
  created_at        DateTime? @default(now()) @db.Timestamp(6)
  updated_at        DateTime? @default(now()) @db.Timestamp(6)
  admin_id          String?   @db.VarChar(255)
  attachments_count Int?      @default(0)

  @@index([admin_id], map: "idx_sent_emails_admin_id")
  @@index([created_at], map: "idx_sent_emails_created_at")
  @@index([recipient_email], map: "idx_sent_emails_recipient_email")
  @@index([recipient_type], map: "idx_sent_emails_recipient_type")
  @@index([sent_at], map: "idx_sent_emails_sent_at")
  @@index([status], map: "idx_sent_emails_status")
}

model symbols_with_categories {
  id            Int       @id @default(autoincrement())
  symbol        String    @unique @db.VarChar(100)
  pair          String?   @db.VarChar(50)
  group_name    String?   @db.VarChar(100)
  category      String?   @db.VarChar(100)
  pip_per_lot   Decimal?  @default(1.00) @db.Decimal(10, 2)
  pip_value     Decimal?  @db.Decimal(15, 2)
  commission    Decimal?  @db.Decimal(15, 2)
  currency      String?   @default("USD") @db.VarChar(10)
  status        String?   @default("active") @db.VarChar(20)
  contract_size Int?      @default(100000)
  digits        Int?      @default(5)
  spread        Decimal?  @db.Decimal(10, 6)
  profit_mode   String?   @default("forex") @db.VarChar(20)
  is_override   Boolean?  @default(false)
  created_at    DateTime? @default(now()) @db.Timestamp(6)
  updated_at    DateTime? @default(now()) @db.Timestamp(6)

  @@index([category], map: "idx_symbols_category")
  @@index([group_name], map: "idx_symbols_group")
  @@index([status], map: "idx_symbols_status")
  @@index([symbol], map: "idx_symbols_symbol")
}

model Country {
  id        String    @id @db.VarChar
  code      String    @unique(map: "ix_Country_code") @db.VarChar(2)
  name      String    @db.VarChar(100)
  phoneCode String?   @db.VarChar(10)
  currency  String?   @db.VarChar(3)
  region    String?   @db.VarChar(50)
  isActive  Boolean?
  createdAt DateTime? @default(now()) @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @db.Timestamptz(6)

  @@index([isActive], map: "ix_Country_isActive")
}

model Suggestion {
  id        String   @id @default(uuid())
  userId    String
  userName  String?
  userEmail String?
  comment   String
  remarks   String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
}

model PriceAlert {
  id          String    @id @default(uuid())
  userId      String
  symbol      String
  targetPrice Float
  condition   String    // "above" or "below"
  isActive    Boolean   @default(true)
  isTriggered Boolean   @default(false)
  triggeredAt DateTime?
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
  @@index([symbol])
}
