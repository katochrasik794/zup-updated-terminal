"use strict";(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[1652],{697540:(t,e,i)=>{i.r(e),i.d(e,{TradedSourcesManager:()=>Ft,canCreateOrUpdateSourceByContext:()=>Rt});var r=i(154834),s=i(650151),o=i(671945),a=(i(601227),i(290484)),n=i(728019),d=i(673748),c=i(549084),l=i(123188),p=i(561882);const h=function(t,e,i){for(var r=-1,s=e.length,o={};++r<s;){var a=e[r],n=(0,c.default)(t,a);i(n,a)&&(0,l.default)(o,(0,p.default)(a,t),n)}return o};var u=i(596842);const _=function(t,e){if(null==t)return{};var i=(0,n.default)((0,u.default)(t),(function(t){return[t]}));return e=(0,d.default)(e),h(t,i,(function(t,i){return e(t,i[0])}))};var m,y,g=i(144421),f=i(668167),P=i(90461),v=i(917053),b=i(884684),k=i(887084),S=i(780284),O=i(963632),C=i(707211),I=i(236941),T=i(232390),B=i(748838);!function(t){t.NoOverlapOnboardingShown="noOverlapOnboardingShown"}(m||(m={}));class D{constructor(){this._transientStorage={},this._persistentStorageKey="trading.ChartTrading",this._transientStorage=B.getJSON(this._persistentStorageKey,{})}setNoOverlapOnboarding(t){this._transientStorage[m.NoOverlapOnboardingShown]=t,this._syncStorage()}isNoOverlapOnboardingShown(){return this._transientStorage[m.NoOverlapOnboardingShown]??!1}_syncStorage(){B.setJSON(this._persistentStorageKey,this._transientStorage,{forceFlush:!0})}}!function(t){t[t.Threshold=4]="Threshold",t[t.TopViewportThreshold=20]="TopViewportThreshold"}(y||(y={}));class x{constructor(t,e=!0){this._prevPixelRatio=null,this._prevMediaWidth=null,this._horizontalBorderPoint=null,this._renderers=[],this._visibleItemsRenderers=null,this._sortedItemRenderers=null,this._isNoOverlapMode=new O.WatchedValue(!1),this._isItemsOverlap=!1,this._isOnboardingNotificationShown=!1,this._invalidated=!1,this._notificationsContainerGetter=t,this._chartTradingSettingsStorage=new D,this._withOnboarding=e}registerRenderer(t){this._renderers.push(t)}removeRenderer(t){if(null!==t)for(let e=0;e<this._renderers.length;e++){if(this._renderers[e]===t){this._renderers.splice(e,1);break}}}invalidateCache(){this._renderers.forEach((t=>t.clearCache())),this._horizontalBorderPoint=null,this._visibleItemsRenderers=null,this._sortedItemRenderers=null,this._invalidated=!0}isItemsOverlap(){return this._isItemsOverlap}setNoOverlapMode(t){this.invalidateCache(),this._isNoOverlapMode.setValue(t)}isNoOverlapMode(){return this._isNoOverlapMode.value()}noOverlapModeChanged(){return this._isNoOverlapMode}getBorderPoint(t){return this._horizontalBorderPoint}alignItems(t){if(this._invalidated){if(this._checkCacheValid(t),this._alignItemsHorizontally(t),this._checkIfItemsOverlap(t),this._showOnboardingNotificationIfNeeded(t),this._isNoOverlapMode.value()){if(!this._isItemsOverlap)return void this.setNoOverlapMode(!1);this._alignItemsVertically(t)}this._invalidated=!1}}_showOnboardingNotificationIfNeeded(t){this._chartTradingSettingsStorage.isNoOverlapOnboardingShown()||this._withOnboarding}_findLowestOverlapingItem(t){const e=this._getSortedRenderers(t),i=[];for(let r=1;r<e.length;r++){const s=e[r],o=e[r-1]
;s.rect(t).top-o.rect(t).bottom+y.Threshold<=0&&(i.includes(s)||i.push(s),i.includes(o)||i.push(o))}return i.map((e=>e.rect(t))).sort(((t,e)=>e.top-t.top))[0]}_checkCacheValid(t){const{horizontalPixelRatio:e,verticalPixelRatio:i}=t,r=null===this._prevPixelRatio||!(0,T.equalPixelRatios)(this._prevPixelRatio,t),s=this._prevMediaWidth!==t.mediaSize.width;(r||s)&&(this._prevPixelRatio={horizontalPixelRatio:e,verticalPixelRatio:i},this._prevMediaWidth=t.mediaSize.width,r&&this._renderers.forEach((t=>t.clearTextCache())),this.invalidateCache())}_alignItemsHorizontally(t){if(null===this._horizontalBorderPoint){const e=this._getVisibleItemRenderers(t);if(0===e.length)return;const i=e.map((e=>e.rect(t)));let r=i[0].right,o=i[0].left;for(const t of i)t.right>r&&(r=t.right),t.left<o&&(o=t.left);this._horizontalBorderPoint={rightmostBorder:r,leftmostBorder:o},this._renderers.forEach((e=>e.applyHorizontalOffset((0,s.ensureNotNull)(this._horizontalBorderPoint),t)))}}_checkIfItemsOverlap(t){const e=this._getSortedRenderers(t);let i=!1;for(let r=1;r<e.length;r++){const s=e[r],o=e[r-1];if(s.rect(t).top-o.rect(t).bottom+y.Threshold<=0){i=!0;break}}this._isItemsOverlap=i}_alignItemsVertically(t){const e=this._getSortedRenderers(t);for(let i=1;i<e.length;i++){const r=e[i],s=e[i-1];r.rectWithOffsets(t).top-s.rectWithOffsets(t).bottom+y.Threshold<=0&&(r.clearCache(),r.setAlignedTopCoordinate(s.rectWithOffsets(t).bottom))}}_getSortedRenderers(t){return null===this._sortedItemRenderers&&(this._sortedItemRenderers=this._getVisibleItemRenderers(t).sort(((t,e)=>e.data().sortingIndex-t.data().sortingIndex))),this._sortedItemRenderers}_getVisibleItemRenderers(t){if(null===this._visibleItemsRenderers){this._visibleItemsRenderers=[];for(const e of this._renderers){const i=e.itemRenderers().filter((e=>{const i=e.rect(t);return e.data().visible&&i.top-y.TopViewportThreshold<t.bitmapSize.height&&i.bottom>0&&!e.data().id.toString().startsWith("ProjectionBracket")}));this._visibleItemsRenderers.push(...i)}}return this._visibleItemsRenderers}}var w=i(130557),G=i(986900),E=i(932473),M=i(627692);const N=(0,o.getLogger)("Trading.Source.SymbolDataProvider");var L;!function(t){t[t.Order=0]="Order",t[t.Position=1]="Position"}(L||(L={}));class R{constructor(t,e,i,r,s){this._symbol=null,this._actualTradingSymbol=null,this._isStarted=!1,this._isSubscribed=!1,this._symbolData=null,this._last=null,this._currencies={},this._specificTradingOptions=null,this._pipValueType=null,this._pipValuesSpawn=null,this._onUpdate=new M.Delegate,this._mainSeries=t,this._realtimeProvider=e,this._symbolSpecificTradingOptionsGetter=s.symbolSpecificTradingOptionsGetter,this._positionSupportReverseGetter=s.positionSupportReverseGetter,this._positionSupportBracketsGetter=s.positionSupportBracketsGetter,this._symbolData={minTick:1/this._mainSeries.base(),pipSize:1,lotSize:1,priceMagnifier:1,quantityFormatter:new G.QuantityFormatter,priceFormatter:new E.PriceFormatter,isTradable:!1},this._currencyGetters={1:s.positionCurrencyGetter,0:s.orderCurrencyGetter},this._pipValueType$=i,
N.logNormal(`[Symbol_${this._symbol}] Init with default values: minTick ${this._symbolData.minTick}, pipSize ${this._symbolData.pipSize}, pipValue: ${JSON.stringify(this.pipValue())}, pipValueType ${this._pipValueType}`),this._updateLastHandler=this._updateLast.bind(this),this._makeActualTradingSymbolObservable=r,this._mainSeries.dataEvents().symbolResolved().subscribe(this,(()=>this._updateActualTradingSymbol())),this._mainSeries.dataEvents().symbolError().subscribe(this,(()=>this._updateActualTradingSymbol())),this._hibernated=t.model().collapsed().spawn(),this._hibernated.subscribe((t=>{this.isActualSymbol()&&!t?this._subscribe():this._unsubscribe()})),this._updateActualTradingSymbol()}start(t){null!==this._symbol&&null===t&&(this._stop(),N.logNormal("Current symbol null")),this._symbol=t;const e=this.isActualSymbol();if(e&&!this._hibernated.value()?this._subscribe():this._unsubscribe(),!e||this._isStarted)return;const i=(0,s.ensureNotNull)(this._symbol);N.logNormal(`Start symbol ${i}`),this._isStarted=!0,this._updateSymbolData(),this._updateCurrencies(),this._updateSpecificTradingOptions()}destroy(){this._stop(),this._mainSeries.dataEvents().symbolResolved().unsubscribeAll(this),this._mainSeries.dataEvents().symbolError().unsubscribeAll(this),this._hibernated.destroy()}symbol(){return this._symbol}isActualSymbol(){if(null===this._symbol)return!1;if(null===this._mainSeries.symbolInfo())return!1;return!(this._mainSeries.isConvertedToOtherCurrency()||this._mainSeries.isConvertedToOtherUnit())&&(this._mainSeries.symbolSameAsCurrent(this._symbol)||this._actualTradingSymbol===this._symbol)}onUpdate(){return this._onUpdate}positionCurrency(){return this._currencies[1]}orderCurrency(){return this._currencies[0]}supportOrderBrackets(){return this._specificTradingOptions?.supportOrderBrackets??!1}supportModifyPositionBrackets(){return!1!==this._specificTradingOptions?.supportModifyBrackets&&(this._specificTradingOptions?.supportModifyPositionBrackets??!1)}supportModifyOrderBrackets(){return Boolean(this._specificTradingOptions?.supportModifyBrackets&&this._specificTradingOptions?.supportModifyOrderBrackets)}supportAddBracketsToExistingOrder(){return Boolean(this._specificTradingOptions?.supportAddBracketsToExistingOrder)}supportPositionBrackets(){return null!==this._specificTradingOptions&&this._positionSupportBracketsGetter(this._specificTradingOptions)}supportPositionReverse(){return null!==this._specificTradingOptions&&this._positionSupportReverseGetter(this._specificTradingOptions)}supportModifyBrackets(){return this._specificTradingOptions?.supportModifyBrackets??!0}supportRiskControlsAndInfo(){return this._specificTradingOptions?.supportRiskControlsAndInfo??!0}async qtyInfo(){return null===this._symbol?null:(await this._realtimeProvider.symbolInfo(this._symbol)).qty}lastData(){return this._last}symbolData(){return this._symbolData}pipValue(){return this._pipValuesSpawn?.value()??null}pipValueType(){return this._pipValueType}getMinTick(t){const e=(0,s.ensureNotNull)(this._symbolData);return(0,w.getMinTick)({
minTick:e.minTick,price:t,variableMinTickData:e.variableMinTickData})}_subscribe(){this._isSubscribed||(this._isSubscribed=!0,this._realtimeProvider.subscribeRealtime((0,s.ensureNotNull)(this._symbol),this._updateLastHandler),this._realtimeProvider.onStatusChanged.subscribe(this,this._updateSymbolData),this._createPipsHelpersSpawns())}_unsubscribe(){this._isSubscribed&&(this._isSubscribed=!1,this._realtimeProvider.unsubscribeRealtime((0,s.ensureNotNull)(this._symbol),this._updateLastHandler),this._realtimeProvider.onStatusChanged.unsubscribeAll(this),this._removePipsHelpersSpawns())}_updateActualTradingSymbol(){this._actualTradingSymbol=null,this._actualTradingSymbolSubscription?.unsubscribe();const t=this._mainSeries.symbolInfo();null!==t?this._actualTradingSymbolSubscription=this._makeActualTradingSymbolObservable(t.pro_name).subscribe((({symbol:t})=>{t!==this._actualTradingSymbol&&(this._actualTradingSymbol=t,this.start(this._symbol))})):this.start(this._symbol)}_stop(){N.logNormal(`Stop symbol ${this._symbol}`),this._unsubscribe(),this._actualTradingSymbolSubscription?.unsubscribe(),this._symbolData=null,this._last=null,this._currencies={},this._symbol=null,this._isStarted=!1}async _updateSymbolData(){if(!this._isValidSymbol())return void N.logNormal(`Can't update symbol data because symbol '${this._symbol}' not valid (isActualSymbol ${this.isActualSymbol()})`);const t=(0,s.ensureNotNull)(this._symbol),[e,i,r,{tradable:o}]=await Promise.all([this._realtimeProvider.quantityFormatter(t),this._realtimeProvider.formatter(t),this._realtimeProvider.symbolInfo(t),this._realtimeProvider.isTradable(t)]);this._symbolData={quantityFormatter:e,priceFormatter:i,minTick:r.minTick,pipSize:r.pipSize,variableMinTickData:r.variableMinTick?(0,w.makeVariableMinTickData)(r.minTick,r.variableMinTick):void 0,lotSize:r.lotSize,priceMagnifier:r.priceMagnifier??1,type:r.type,isTradable:o},N.logNormal(`[Symbol_${this._symbol}] Update symbol data values: minTick ${this._symbolData.minTick}, pipSize ${this._symbolData.pipSize}, pipValue: ${JSON.stringify(this.pipValue())}, pipValueType ${this._pipValueType}`),this._onUpdate.fire()}_updateLast(t,e){(this._last?.ask!==e.ask||this._last?.bid!==e.bid||this._last?.trade!==e.trade)&&this._isValidSymbol()&&(this._last={trade:e.trade??NaN,ask:e.ask??NaN,bid:e.bid??NaN},this._onUpdate.fire())}_updateCurrencies(){this._updateCurrency(1),this._updateCurrency(0)}async _updateCurrency(t){void 0===this._currencies[t]&&this._isValidSymbol()&&(this._currencies[t]="",this._currencies[t]=await this._currencyGetters[t]((0,s.ensureNotNull)(this._symbol)),this._onUpdate.fire())}async _updateSpecificTradingOptions(){null===this._specificTradingOptions&&this._isValidSymbol()&&(this._specificTradingOptions={},this._specificTradingOptions=await this._symbolSpecificTradingOptionsGetter((0,s.ensureNotNull)(this._symbol))??null,this._onUpdate.fire())}_createPipsHelpersSpawns(){if(!this._isValidSymbol())return;const t=null===this._pipValuesSpawn;if(t){const t=(0,s.ensureNotNull)(this._realtimeProvider.activeBroker())
;this._pipValuesSpawn=function(t,e,i,r){const s=t=>({sellPipValue:t,buyPipValue:t}),o=new O.WatchedValue(s(1));let a=!1;(async()=>{if(!a){const i=await e(t);o.setValue(s(i.pipValue))}})();const n=(t,e)=>{a=!0,o.setValue(e)};return i(t,n),o.readonly().spawn((()=>r(t,n)))}((0,s.ensureNotNull)(this._symbol),this._realtimeProvider.symbolInfo.bind(this._realtimeProvider),t.subscribePipValue.bind(t),t.unsubscribePipValue.bind(t)),this._pipValuesSpawn.subscribe((t=>{N.logNormal(`[Symbol_${this._symbol}] Update pipValues ${JSON.stringify(this.pipValue())}`),this._onUpdate.fire()}))}const e=void 0===this._pipValueTypeSubscription;e&&(this._pipValueTypeSubscription=this._pipValueType$.subscribe((t=>this._updatePipValueType(t)))),(t||e)&&this._onUpdate.fire()}_removePipsHelpersSpawns(){this._pipValuesSpawn?.destroy(),this._pipValuesSpawn=null,this._pipValueTypeSubscription?.unsubscribe(),this._pipValueTypeSubscription=void 0}_updatePipValueType(t){this._pipValueType=t,N.logNormal(`[Symbol_${this._symbol}] Update pipValueType ${this._pipValueType}`),this._onUpdate.fire()}_isValidSymbol(){return Boolean(this._symbol&&this.isActualSymbol())}}const F=()=>{},A=()=>{};function V(t,e,i=!1){const r=t.properties().childs().tradingProperties.childs(),s=(0,P.combineProperty)(((t,e)=>e),(0,I.createPrimitivePropertyFromWatchedValue)(t.isInReplay().weakReference()).ownership(),r.showOrders.weakReference()),o=(0,P.combineProperty)(((t,e)=>e),(0,I.createPrimitivePropertyFromWatchedValue)(t.isInReplay().weakReference()).ownership(),r.showPositions.weakReference());return{lineProperties:{width:r.lineWidth,style:r.lineStyle,extend:r.extendLeft},horizontalAlignment:r.horizontalAlignment,showOrders:s,showPositions:o,showReverse:r.showReverse,positionPL:{visibility:(0,P.combineProperty)(((t,e)=>!!t&&e),r.positionAndBracketsPL.weakReference(),r.positionPL.childs().visibility.weakReference()),display:r.positionPL.childs().display},bracketsPL:{visibility:(0,P.combineProperty)(((t,e)=>!!t&&e),r.positionAndBracketsPL.weakReference(),r.bracketsPL.childs().visibility.weakReference()),display:r.bracketsPL.childs().display},plusButtonVisibility:C.addPlusButtonProperty}}function W(t){const{chartWidgetCollection:e,chartModel:i,configFlags:r,externalCustomSourceServices:o,tradedGroupRenderersControllerMap:a,specialCtor:n,properties:d}=t,c=e.getAll().find((t=>t.model().id()===i.id())),l=c?.paneWidgets().find((t=>t.containsMainSeries())),p=function(t,e,i){return t.has(e)||t.set(e,new x(i)),(0,s.ensureDefined)(t.get(e))}(a,i,(()=>l?.getElement())),{realtimeProvider:h,qtySuggester:u,pipValueType$:_,positionSupportBracketsGetter:m,positionSupportReverseGetter:y,positionCurrencyGetter:g,orderCurrencyGetter:f,symbolSpecificTradingOptionsGetter:P,makeActualTradingSymbolObservable:v}=o,b=new R(i.mainSeries(),h,_,v,{positionSupportReverseGetter:y,positionSupportBracketsGetter:m,positionCurrencyGetter:g,orderCurrencyGetter:f,symbolSpecificTradingOptionsGetter:P}),k=window.TradingView.bottomWidgetBar?.isVisible(),C=void 0===k?new O.WatchedValue(!1):k
;return n(r,d,(()=>e.activeChartWidget.value().exitTrackingMode()),p,b,u,(0,S.combine)((t=>!t),C.weakReference()).ownership())}var U=i(609838),j=i(17076),$=i(721762),q=i(414903),H=i(764146),Q=i(360887),z=i(739695),K=i(166554),J=i(610555);const X=document.createElement("div");async function Y(t){const{isOpened:e,position:r,qtyInfoGetter:s,valueGetter:o,onClose:a,onDestroy:n,onValueChange:d,closeOnClickOutside:c}=t,[l,p]=await Promise.all([Promise.all([i.e(1086),i.e(8894),i.e(5743),i.e(3329),i.e(9117),i.e(8490),i.e(6644),i.e(3250),i.e(7125),i.e(3809)]).then(i.bind(i,713191)),s()]);if(null===p)return void l.render(!1,X);const h={...p,withInput:!0,valueGetter:o,position:function(t){return new J.Point(r.x-t.contentWidth,r.y)},targetEl:null,onClickOutside:function(t){if(t){const e=t.target.getBoundingClientRect()||{left:0,top:0};a(new J.Point(t.clientX-e.left,t.clientY-e.top))}},onClose:u,onKeyboardClose:u,onValueChange:d,closeOnClickOutside:c};function u(){n()}e?l.render(!0,X,h):l.render(!1,X)}var Z,tt=i(986775),et=i(597346),it=i(538453),rt=i(465688),st=i(753552),ot=i(484686),at=i(926032);function nt(t){const{isDisabled:e,moveGroupItems:i,moveSelectedItem:r,sendOrder:s,description:o}=t,a=at.createGroup({desc:o,modal:!1});return a.add({desc:"Shift+KeyUp",hotkey:at.Modifiers.Shift+38,handler:()=>i(1),isDisabled:e,isRepeatAccepted:!0}),a.add({desc:"Shift+KeyDown",hotkey:at.Modifiers.Shift+40,handler:()=>i(-1),isDisabled:e,isRepeatAccepted:!0}),a.add({desc:"KeyUp",hotkey:38,handler:()=>r(1),isDisabled:e,isRepeatAccepted:!0}),a.add({desc:"KeyDown",hotkey:40,handler:()=>r(-1),isDisabled:e,isRepeatAccepted:!0}),a.add({desc:"Enter",hotkey:13,handler:()=>s(),isDisabled:e,isRepeatAccepted:!1}),a}!function(t){t[t.Up=1]="Up",t[t.Down=-1]="Down"}(Z||(Z={}));var dt,ct=i(794671);class lt extends tt.TradedGroupBase{constructor(t,e,i,r,s,o,a,n,d,c,l,p,h,u,_){super(t,e,i,r,s,o,d,c,l,p),this._supportedOrderTypes=[],this._dataUpdated=new M.Delegate,this._confirmWidget=null,this._confirmWidgetShown=!1,this.onQtyModify=async(t,e)=>{if(void 0===this.mainItem())return;const i=this.mainItem().data();i.qty=t,this.items().brackets.forEach((e=>{e.data().qty=t})),await this._modifyPlaceOrder(this._makePreOrderData(i),void 0,e),this.redraw()},this._onToggleQtyCalcHandler=t=>(t.isOpened&&this._onCalculatorOpened(),Y(t)),this._moveSelectedItem=t=>{const e=this.selectedItem();if(null===e)return;const i=this.findItem(e.id);this._moveItem(i,t),this.redraw()},this._moveGroupItems=t=>{if(null===this.selectedItem())return;const e=this.items(!0);for(const i of e)this._moveItem(i,t);this.redraw()},this._moveItem=(t,e)=>{const i=this._model.mainSeries().priceStep();null!==i&&null!==t.price()&&(t.applyPriceDiff(i*e),this.modifyAllItems(t.id()),t.setInEdit(!1))},this._onConfirm=async(t,e)=>!this.disabled()&&!this.hasError()&&(this._callbacks.trackEvent("Chart Place Order","Order placed"),this._sendOrder()),this._modifyPlaceOrder=d.modifyOrder,this._cancelPlaceOrder=d.cancelOrder,this._sendOrder=d.sendOrder,this._openOrderTicket=d.openOrderTicket,
this._onCalculatorOpened=d.onCalculatorOpened,this._onModifyPlaceOrderFinished=d.onModifyOrderFinished,this._supportedOrderTypes=h,this._setData(this._rawDataSpawn.value(),!1),this._rawDataSpawn.subscribe((()=>this._dataUpdated.fire())),this._isActiveSource=u,this._isActiveSource.subscribe((()=>this._updateConfirmButtonDisplay())),this._isConfirmButtonOnDomWidgetWV=_,this._isConfirmButtonOnDomWidgetWV.subscribe((()=>this._updateConfirmButtonDisplay()),{callWithLast:!0}),this._disabled=(0,S.combine)((t=>t===z.PlaceOrEditContextStatus.Loading),n.ownership()),this._disabled.subscribe((()=>this.redraw())),this._errors=(0,S.combine)((t=>t),a.ownership()),this._errors.subscribe((()=>this.redraw())),this._hotKeysActionGroup=nt({isDisabled:()=>!this._isActiveSource.value(),moveGroupItems:this._moveGroupItems,moveSelectedItem:this._moveSelectedItem,sendOrder:async()=>!!this.items(!0).map((t=>t.id())).includes(this.selectedItem()?.id??NaN)&&(await this._onConfirm(this.items().main.id(),{}),!0),description:"TradedGroupPlace"})}destroy(){this._hideConfirmWidgetIfNeeded(),this._isActiveSource.release(),this._isConfirmButtonOnDomWidgetWV.release(),this._disabled.destroy(),this._errors.destroy(),this._hotKeysActionGroup.destroy(),super.destroy()}isPlaced(){return!1}hasConfirmButton(){return!0}hasCancelButton(){return!1}disabled(){return this._disabled.value()}hasError(){return Object.keys(this._errors.value()).length>0}isConfirmButtonOnDomWidget(){return!1}mainItem(){return this.items().main}items(t=!1,e){return super.items(t,e)}async setMainOrderType(t){const e=this.mainItem().data();e.type=t;const i=(0,K.orderTypeToText)({orderType:t,uppercase:!1,shorten:!1});this._callbacks.trackEvent("Chart Place Order","Change order type",i),await this._modifyPlaceOrder(this._makePreOrderData(e)),this.redraw()}onClose(t){const{origin:e="Chart Place Order",event:i="Cancel order",label:r=""}=t;this._callbacks.trackEvent(e,i,r),this._cancelPlaceOrder()}onModify(t){const{origin:e="Chart Place Order",event:i="Modify order",label:r=""}=t;this._callbacks.trackEvent(e,i,r),this._onOpenOrderTicket()}onMove(t,e){super.onMove(t,e,!0),this.modifyAllItems(t)}async onFinishMove(t,e){this.setIsBlocked(!1);const{origin:i="Chart Place Order",event:r="Move Order",label:o=""}=e;e=(0,q.mergeGaParams)({origin:i,event:r,label:o},{label:this._hadBeenModifiedAllItems?"group":"single"});const a=this.findItem(t);return(0,s.assert)((0,H.isOrderLikeItem)(a),"This item does not support move"),await a.onFinishMove(e),await this.modifyAllItems(t,e),this._onModifyPlaceOrderFinished(),this.setIsBlocked(!1),this.items(!0).forEach((t=>{t.setInEdit(!1),t.setIsMoving(!1)})),this._hadBeenModifiedAllItems=!1,this.syncData(),this.redraw(),!0}async onFinishMoveProjectionBracket(t,e){return this.onFinishMove(t,e)}async onConfirm(t,e){return this._onConfirm(t,e)}async onCancel(t,e){return!0}async modifyAllItems(t,e){if(void 0!==e){const{origin:t="Chart Place Order",event:i="Modify order",label:r=""}=e;this._callbacks.trackEvent(t,i,r)}
const i=this._makePreOrderData(this.mainItem().data());return await this._modifyPlaceOrder(i),!0}isActiveSource(){return this._isActiveSource.value()}isInErrorState(){return Object.keys(this._errors.value()).length>0}extractItemErrorMessage(t){const e=this._errors.value();if(0===Object.keys(e).length)return null;const i=pt[t];if(void 0===i)return null;let r="";for(const t of i){const i=e[t];if(void 0===i)continue;const s=(0,j.getErrorMessage)(i);r=`${r}${0===r.length?"":", "}${s}`}return r.length>0?r:null}_createMainItem(t){const e=(0,s.ensureDefined)(t.main);if("PreOrder"!==e.dataType)throw new Error(`Unexpected data type for main item, it should be pre-order, not ${e.dataType}`);const i=(0,it.createItem)(it.TradedGroupItemType.PreOrder,e,this,this._model,{itemExternalServices:{symbolDataProvider:this._symbolDataProvider,qtySuggester:this._qtySuggester,tradedGroupRenderersController:this._tradedGroupRenderersController},visibilityGetters:{order:this._orderVisibilityGetter.bind(this),position:this._positionVisibilityGetter.bind(this)},sourceCallbacks:this._callbacks,menuCallbacks:{onToggleTypeMenuHandler:this._getToggleOrderTypeMenuHandler(),closeDropdownMenuHandler:Q.closeDropdownMenu},qtyModifyCallbacks:{onToggleQtyCalcHandler:this._onToggleQtyCalcHandler,onQtyApplyHandler:t=>this.onQtyModify(t),onQtyProviderUpdate:t=>this.onQtyModify(t,!0),qtyInfoGetter:()=>this._symbolDataProvider.qtyInfo()}},this._createTexts());return i.setSupportOrderType(this._supportedOrderTypes),i}_updateMainItem(t){const e=this.items().main;if(!(0,H.isPreOrderItemRawData)(t)||!(0,et.isPreOrderItem)(e))return;const{dataType:i,...r}=t;e.setData(r)}_createStopLimitItem(t,e){let i;const r=(0,s.ensureDefined)(t.main);if("PreOrder"!==r.dataType)throw new Error(`Unexpected data type for main item, it should be pre-order, not ${r.dataType}`);if(4===e.type()){const t=this._dataForStopLimitOrder(r);i=(0,it.createItem)(it.TradedGroupItemType.LimitPartStopLimitOrder,t,this,this._model,{itemExternalServices:{symbolDataProvider:this._symbolDataProvider,qtySuggester:this._qtySuggester,tradedGroupRenderersController:this._tradedGroupRenderersController},visibilityGetters:{order:this._orderVisibilityGetter.bind(this),position:this._positionVisibilityGetter.bind(this)},sourceCallbacks:this._callbacks,qtyModifyCallbacks:{onToggleQtyCalcHandler:this._onToggleQtyCalcHandler,onQtyApplyHandler:t=>this.onQtyModify(t),onQtyProviderUpdate:t=>this.onQtyModify(t,!0),qtyInfoGetter:()=>this._symbolDataProvider.qtyInfo()}},this._createTexts())}return i}_dataForStopLimitOrder(t){const{seenPrice:e,...i}=(0,r.default)(t);return{...i,id:ct.projectionStopPartStopLimitId,dataType:"Order",status:6,considerFilledQty:!1,price:(0,s.ensureDefined)(t.limitPrice),callbacks:{modifyOrder:()=>this._onOpenOrderTicket(),modifyOrderFromContextMenu:()=>this._onOpenOrderTicket()}}}_convertStopLimitOrderToMainItem(t,e){const i=this.items().main;if(void 0===i||!(0,H.isOrderLikeItem)(i)||void 0===t||(0,H.isPositionItemRawData)(t))return
;const s=this._calculateSeenPrice(t),o=this._getCurrentQuotes();i.setData({...(0,r.default)(t),seenPrice:s,currentQuotes:o})}_processedBracketData(t){if(t.callbacks.cancelOrder=async t=>{const e=this.items().main,i=this.items().brackets;if(e.supportOnlyPairBrackets())i.length=0;else{const e=i.findIndex((e=>e.data().id===t));-1!==e&&i.splice(e,1)}return await this.modifyAllItems(t),!0},t.stopType===$.StopType.TrailingStop){const e=this._symbolDataProvider.symbolData()?.pipSize,i=void 0!==this.items().stopLimit?this.items().main.data().limitPrice:this.items().main?.price();t.price=(0,st.calcPriceByPips)(t.trailingStopPips??0,i??0,t.side,e??0)}return t.callbacks.modifyOrder=(t,e,i,r)=>Promise.resolve(!0),t.callbacks.modifyOrderFromContextMenu=(t,e,i)=>this._onOpenOrderTicket(i),t}_createBracketItem(t){return(0,it.createItem)(it.TradedGroupItemType.Order,this._processedBracketData(t),this,this._model,{itemExternalServices:{symbolDataProvider:this._symbolDataProvider,qtySuggester:this._qtySuggester,tradedGroupRenderersController:this._tradedGroupRenderersController},visibilityGetters:{order:this._orderVisibilityGetter.bind(this),position:this._positionVisibilityGetter.bind(this)},sourceCallbacks:this._callbacks,gaOrigin:"Chart Place Order"},{...this._createTexts(),qty:{title:U.t(null,void 0,i(784570))}})}_isSourceShouldBeShown(){return!!this._symbolDataProvider.isActualSymbol()&&!(window.TradingView.printing&&!(0,ot.isTradingObjVisibleOnScreenshot)())}_createTexts(){const t=this._symbolDataProvider.symbolData()?.type;return{contextMenu:{cancel:U.t(null,void 0,i(206979)),edit:U.t(null,void 0,i(784570))},qty:{title:"spread"===t?U.t(null,void 0,i(106200)):U.t(null,void 0,i(899255))},close:{title:U.t(null,void 0,i(206979))}}}async _onOpenOrderTicket(t){const e=this._makePreOrderData(this.mainItem().data());return this._openOrderTicket(e,t),!0}async _updateConfirmButtonDisplay(){const t=this._isActiveSource.value(),e=this.isConfirmButtonOnDomWidget();if(t&&e&&!this._confirmWidgetShown){this._confirmWidgetShown=!0;const{ConfirmWidgetRenderer:t}=await Promise.all([i.e(5237),i.e(3989)]).then(i.bind(i,165301));if(this._confirmWidgetShown&&!this._isDestroyed){const e=(0,s.ensureDefined)(this.baseItem()),i=(0,P.createWVFromGetterAndSubscription)((()=>e.confirmText(!1)),this._dataUpdated),r=(0,P.createWVFromGetterAndSubscription)((()=>e.data().side),this._dataUpdated),o=(0,S.combine)((t=>this.hasError()),this._errors.weakReference());this._confirmWidget=new t(i.ownership(),r.ownership(),this._disabled.spawnOwnership(),o.ownership(),(()=>this.onConfirm(this.mainItem().id(),{})))}}else t&&e||this._hideConfirmWidgetIfNeeded();this.redraw()}_hideConfirmWidgetIfNeeded(){this._confirmWidget?.destroy(),this._confirmWidget=null,this._confirmWidgetShown=!1}_makePreOrderData(t){const e=this._calculateSeenPrice(t),i=this._getCurrentQuotes(),{symbol:r,type:o,side:a,qty:n,isClose:d,stopType:c}=t,l={symbol:r,type:o,side:a,qty:n,isClose:d,seenPrice:e,currentQuotes:i,stopType:c},p=t.price;switch(t.type){case 4:if(l.stopPrice=p??void 0,null===p){
l.limitPrice=void 0;break}const t=this._symbolDataProvider.getMinTick(p),e=1===l.side?1:-1;l.limitPrice=this.items().stopLimit?.price()??p+e*t;break;case 1:l.limitPrice=p??void 0;break;case 3:l.stopPrice=p??void 0}const{takeProfit:h,stopLoss:u,trailingStop:_,guaranteedStop:m}=(0,rt.bracketsByType)(this.items().projectionBrackets),{takeProfit:y,stopLoss:g,trailingStop:f,guaranteedStop:P}=(0,rt.bracketsByType)(this.items().brackets);l.takeProfit=y?.price()??h?.price()??void 0,l.stopLoss=g?.price()??u?.price()??void 0;const v=f||_,b=v?.price()??void 0,k=P||m,S=k?.price()??void 0;if(void 0!==u?l.stopType=$.StopType.StopLoss:void 0!==m?l.stopType=$.StopType.GuaranteedStop:void 0!==_&&(l.stopType=$.StopType.TrailingStop),void 0!==v&&void 0!==b){const e=(0,s.ensureNotNull)(this._symbolDataProvider.lastData()),i=e?.bid??void 0,r=e?.ask??void 0,{pipSize:o}=this._symbolDataProvider.symbolData()??{};if(void 0!==i&&void 0!==r&&void 0!==o){const e=v.data(),i=4===t.type?this.items().stopLimit?.price()??p:p;null!==i&&(l.trailingStopPips=(0,st.calcPipsByPrice)(b,i,e.side,o)),l.trailingStopPrice=b}}return void 0!==k&&void 0!==S&&(l.guaranteedStop=S),l}_calculateSeenPrice(t){const e=this._symbolDataProvider.lastData();return(1===t.side?e?.ask:e?.bid)??0}_getCurrentQuotes(){const t=this._symbolDataProvider.lastData();return null===t?void 0:{ask:t.ask,bid:t.bid}}_getToggleOrderTypeMenuHandler(){return(t,e,i,r,s)=>{const o=this.mainItem();if(o.canSwitchType()){this._callbacks.trackEvent("Chart Place Order","Order type menu opening",i.label??"");const a=o.orderTypesItems().map((({type:t,typeText:e})=>({title:e,value:t}))),n=this._model.timeScale(),d=[n.onScroll(),n.barSpacingChanged(),this._model.mainSeries().onSymbolIntervalChanged()],c=a.findIndex((t=>t.value===o.data().type));(0,Q.updateDropdownMenu)(t,e,a,c,"Order type",d,(t=>this.setMainOrderType(t)),r,s)}}}}!function(t){t[t.StopLoss=0]="StopLoss",t[t.TakeProfit=1]="TakeProfit",t[t.TrailingStop=2]="TrailingStop",t[t.GuaranteedStop=3]="GuaranteedStop",t.MainOrder="preOrder",t.ProjectionBracketStopLoss="ProjectionBracketStopLoss",t.ProjectionBracketTakeProfit="ProjectionBracketTakeProfit",t.ProjectionBracketTrailingStop="ProjectionBracketTrailingStop",t.ProjectionBracketGuaranteedStop="ProjectionBracketGuaranteedStop"}(dt||(dt={}));const pt={preOrder:["qty","limitPrice","stopPrice"],ProjectionBracketStopLoss:["stopLoss"],ProjectionBracketTakeProfit:["takeProfit"],ProjectionBracketTrailingStop:["trailingStopPips"],ProjectionBracketGuaranteedStop:["guaranteedStop"],0:["stopLoss"],1:["takeProfit"],2:["trailingStopPips"],3:["guaranteedStop"]};var ht=i(379465),ut=i(287104),_t=i(941520);const mt=ht.tradedGroupPlaceOrderPrefix,yt=[1,3,4];function gt(t){t.removeCustomSource(`${mt}`)}var ft=i(851310),Pt=i(894862);const vt={contextMenu:{cancel:U.t(null,void 0,i(719634)),edit:(0,ft.appendEllipsis)(U.t(null,void 0,i(224522)))},qty:{title:(0,ft.appendEllipsis)(U.t(null,void 0,i(284014)))},close:{title:U.t(null,void 0,i(719634))}};class bt extends tt.TradedGroupBase{
constructor(t,e,i,r,s,o,a,n,d,c,l,p,h,u,_,m){super(t,e,i,r,s,o,c,l,p,h),this._resetProjBracketsTimeout=null,this._onToggleQtyCalcHandler=t=>(t.isOpened&&this._onCalculatorOpened(),Y(t)),this._moveSelectedItem=t=>{const e=this.selectedItem();if(null===e)return;const i=this.findItem(e.id);(0,H.isOrderLikeItem)(i)&&(this._moveItems([i],t),this.redraw())},this._moveGroupItems=t=>{if(null===this.selectedItem())return;const e=this.items(!0).filter(H.isOrderLikeItem);this._moveItems(e,t),this.redraw()},this._moveItems=(t,e)=>{const i=this._model.mainSeries().priceStep();if(null!==i&&0!==t.length){for(const r of t)null!==r.price()&&r.applyPriceDiff(i*e);this.modifyAllItems(t[0].id(),{},!0)}},this._getIsNoConfirmEnabled=m,this._setData(this._rawDataSpawn.value(),!1),this._onCalculatorOpened=c.onCalculatorOpened,this._onQtyApplyHandler=c.onQtyApplyHandler,this._sendOrder=c.sendOrder,this._cancel=c.cancel,this._isLoading=(0,S.combine)((t=>t),n.ownership()),this._isEdited=(0,S.combine)((t=>t),d.ownership()),this._errors=(0,S.combine)((t=>t),a.ownership()),this._errors.subscribe((()=>this.redraw())),this._isLoading.subscribe(this.setIsBlocked.bind(this)),this._callbacks.onDataUpdateRejected.subscribe(this,this._resetProjBracketsHandler),this._styleOverrides=u,this._isActiveSource=_,this._isActiveSource.subscribe((()=>this.redraw())),this._hotKeysActionGroup=nt({moveGroupItems:this._moveGroupItems,moveSelectedItem:this._moveSelectedItem,isDisabled:()=>!this._isActiveSource.value()||!this.hasConfirmButton(),sendOrder:async()=>!(!this.hasConfirmButton()||null===this.selectedItem())&&(await this._sendOrder(),!0),description:"TradedGroupEdit"})}destroy(){this._clearResetProjBracketsTimeout(),this._callbacks.onDataUpdateRejected.unsubscribeAll(this),this._isActiveSource.release(),this._errors.destroy(),this._isLoading.destroy(),this._isEdited.destroy(),this._hotKeysActionGroup.destroy(),super.destroy()}isEdited(){return this._isEdited.value()}isPlaced(){return!0}hasConfirmButton(){return this._isEdited.value()&&this.isActiveSource()}hasCancelButton(){return this._isEdited.value()&&this.isActiveSource()}async onConfirm(t,e){return!this.disabled()&&!this.hasError()&&this._sendOrder()}async onCancel(t,e){return this._cancel(),!0}isActiveSource(){return this._isActiveSource.value()}items(t=!1,e){return super.items(t,e)}mainItem(){return this.items().main}async onFinishMove(t,e){const i=this.items().main,r=i?.id()===t&&this.items().brackets.some((t=>t.bracketType()===Pt.BracketType.TrailingStop)),o=this._hadBeenModifiedAllItems||r;if(i&&o)return this.modifyAllItems(t,e,!0);const a=this.findItem(t);(0,s.assert)((0,H.isOrderLikeItem)(a),"This item does not support move"),this._getIsNoConfirmEnabled(a.data().parentId??a.data().id)&&this.setIsBlocked(!0),e=(0,q.mergeGaParams)(e,{event:"Move Order",label:"single"});const n=await a.onFinishMove(e,void 0,!1);return!this._isDestroyed&&(this.setIsBlocked(!1),this.syncData(),this.redraw(),this.allItemsSupportMove(this.items(!0))&&this._callbacks.showChartHint(),n)}cancelMove(){
for(const t of this.items(!0))(0,H.isOrderLikeItem)(t)&&(t.setInEdit(!1),t.setIsMoving(!1));return this._resetProjBracketsHandler(),this.syncData(),this.redraw(),!0}async onFinishMoveProjectionBracket(t,e){return this.items(!0).forEach((t=>{(0,H.isOrderLikeItem)(t)&&t.setIsMoving(!1)})),this.modifyAllItems(t,e,!0)}async modifyAllItems(t,e,i){const r=(0,s.ensureDefined)(this.items().main);this._getIsNoConfirmEnabled(r.data().id)&&this.setIsBlocked(!0);const{takeProfit:o,stopLoss:a,guaranteedStop:n,trailingStop:d}=(0,rt.bracketsByType)(this.items().projectionBrackets),{takeProfit:c,stopLoss:l,guaranteedStop:p,trailingStop:h}=(0,rt.bracketsByType)(this.items().brackets),u={limitPrice:this.items().stopLimit?.price()??void 0,takeProfit:c?.price()??o?.price()??void 0,stopLoss:l?.price()??a?.price()??void 0,guaranteedStop:p?.price()??n?.price()??void 0,trailingStop:h?.price()??d?.price()??void 0},_=this.findItem(t);(0,s.assert)((0,H.isOrderLikeItem)(_),"This item does not support move");const m=this._hadBeenModifiedAllItems?"Move Order":"Add bracket from btn",y=function(t,e,i){return(0,H.isPositionLikeItem)(i)||"Move Order"===t?"group":(0,et.isPositionItem)(e)&&e.supportOnlyPairBrackets()?"both bracket":i.bracketType()===Pt.BracketType.TakeProfit?"take profit":i.bracketType()===Pt.BracketType.TrailingStop?"trailing stop":i.bracketType()===Pt.BracketType.GuaranteedStop?"guaranteed stop":"stop loss"}(m,r,_);e=(0,q.mergeGaParams)(e,{event:m,label:y});const g=this._ticketFocus(_);let f=!1;if(f=(0,H.isPositionLikeItem)(r)?i?await r.onFinishMove(e,u,!1,g):(0,et.isProjectionBracketItem)(_)?await r.onModifyWithBracket(e,u,!1,g):await _.onMoveItem(u,!1):i?await r.onFinishMove(e,u,!1,g):await r.onMoveItem(u,!1,g),this._isDestroyed)return!1;if(this.setIsBlocked(!1),this.syncData(),this.redraw(),i){this._hadBeenModifiedAllItems=!1;for(const t of this.items(!0))(0,H.isOrderLikeItem)(t)&&t.setInEdit(!1)}return f}styleOverrides(){return this._styleOverrides}isInErrorState(){return Object.keys(this._errors.value()).length>0}hasError(){return Object.keys(this._errors.value()).length>0}extractItemErrorMessage(t){const e=this._errors.value();if(0===Object.keys(e).length)return null;let i;if(i=St[t],void 0===i){if("string"!=typeof t)return null;i=["qty","limitPrice","stopPrice"]}let r="";for(const t of i){const i=e[t];if(void 0===i)continue;const s=(0,j.getErrorMessage)(i);r=`${r}${0===r.length?"":", "}${s}`}return r.length>0?r:null}onMove(t,e,i){super.onMove(t,e,i)}_createMainItem(t){const e=t.main;let i;return void 0!==e&&((0,H.isOrderItemRawData)(e)?i=(0,it.createItem)(it.TradedGroupItemType.Order,e,this,this._model,{itemExternalServices:{symbolDataProvider:this._symbolDataProvider,qtySuggester:this._qtySuggester,tradedGroupRenderersController:this._tradedGroupRenderersController},visibilityGetters:{order:this._orderVisibilityGetter.bind(this),position:this._positionVisibilityGetter.bind(this)},sourceCallbacks:this._callbacks,qtyModifyCallbacks:this._configFlags.supportEditAmount?{onToggleQtyCalcHandler:this._onToggleQtyCalcHandler,
onQtyApplyHandler:t=>this._onQtyModify(t),qtyInfoGetter:()=>this._symbolDataProvider.qtyInfo()}:void 0},vt):(0,H.isPositionItemRawData)(e)&&(i=(0,it.createItem)(it.TradedGroupItemType.Position,e,this,this._model,{itemExternalServices:{symbolDataProvider:this._symbolDataProvider,qtySuggester:this._qtySuggester,tradedGroupRenderersController:this._tradedGroupRenderersController},visibilityGetters:{order:this._orderVisibilityGetter.bind(this),position:this._positionVisibilityGetter.bind(this)},sourceCallbacks:this._callbacks},vt))),i}_updateMainItem(t){const e=this.items().main;if(void 0!==e&&void 0!==t)if((0,et.isPositionItem)(e)&&(0,H.isPositionItemRawData)(t)){const{dataType:i,...r}=t;e.setData(r)}else{if(!(0,H.isOrderLikeItem)(e)||!(0,H.isOrderItemRawData)(t))throw new Error(`Main item and main data are incompatible, main item type ${typeof e}, main data type ${t.dataType}`);{const{dataType:i,...r}=t;e.setData(r)}}}_dataForStopLimitOrder(t){return(0,s.assert)(!(0,H.isPositionItemRawData)(t)&&void 0!==t.limitPrice),{...(0,r.default)(t),price:t.limitPrice,considerFilledQty:!1}}_convertStopLimitOrderToMainItem(t,e){const i=this.items().main;if(void 0===i||!(0,H.isOrderLikeItem)(i)||void 0===t||(0,H.isPositionItemRawData)(t))return;const s={...(0,r.default)(e.data()),type:t.type,price:i.price(),callbacks:t.callbacks};i.setData(s)}_createBracketItem(t){return(0,it.createItem)(it.TradedGroupItemType.Order,this._processedBracketData(t),this,this._model,{itemExternalServices:{symbolDataProvider:this._symbolDataProvider,qtySuggester:this._qtySuggester,tradedGroupRenderersController:this._tradedGroupRenderersController},visibilityGetters:{order:this._orderVisibilityGetter.bind(this),position:this._positionVisibilityGetter.bind(this)},sourceCallbacks:this._callbacks,gaOrigin:"Chart Order"},vt)}_createTexts(){return vt}_handleBracketWithoutParentItemMove(t){const e=this.findItem(t),i=e.data();(0,et.isOrderItem)(e)&&"parentId"in i&&void 0!==i&&null!==i.price&&(1===i.type?i.limitPrice=i.price:i.stopPrice=i.price,e.moveBracketWithoutParent({...i,dataType:"Order"}))}_onQtyModify(t){const e=this.mainItem();if(void 0===e)return;const i=e.data();i.qty=t,this.items().brackets.forEach((e=>{e.data().qty=t})),this._onQtyApplyHandler(i.id,i.qty),this.redraw()}_ticketFocus(t){if(!(0,H.isPositionLikeItem)(t)){if(null!==t.bracketType())return t.bracketType()===Pt.BracketType.TakeProfit?3:4;switch(t.type()){case 4:return(0,et.isLimitPartStopLimitOrderItem)(t)?1:2;case 1:return 1;case 3:return 2}}return 5}_clearResetProjBracketsTimeout(){null!==this._resetProjBracketsTimeout&&(clearTimeout(this._resetProjBracketsTimeout),this._resetProjBracketsTimeout=null)}_resetProjBracketsHandler(){this._clearResetProjBracketsTimeout();const{takeProfit:t,stopLoss:e,guaranteedStop:i,trailingStop:r}=(0,rt.bracketsByType)(this.items().projectionBrackets);t?.setPrice(null),e?.setPrice(null),i?.setPrice(null),r?.setPrice(null),this.redraw()}}var kt;!function(t){t[t.StopLoss=0]="StopLoss",t[t.TakeProfit=1]="TakeProfit",t[t.TrailingStop=2]="TrailingStop",
t[t.GuaranteedStop=3]="GuaranteedStop"}(kt||(kt={}));const St={0:["stopLoss"],1:["takeProfit"],2:["trailingStopPips"],3:["guaranteedStop"]},Ot=`${ht.tradedGroupEditOrderPrefix}EditOrder`;var Ct=i(687039),It=i(959026),Tt=i(760775),Bt=i(668019);const Dt=(0,o.getLogger)("Trading.Source.Manager");function xt(t){let e="",i="",r="";return t.main&&("Position"===t.main.dataType?(e="Position",i=JSON.stringify((0,It.cropPositionData)(t.main))):"Order"===t.main.dataType?(e="Order",i=JSON.stringify((0,Ct.cropOrderData)(t.main))):(e="PreOrder",i=JSON.stringify(t.main))),t.brackets.forEach(((t,e)=>{const i=(0,rt.getBracketType)(t),s=null!==i?Pt.BracketType[i]:"";r=0===e?`\nbracketData: ${s} - ${JSON.stringify((0,Ct.cropOrderData)(t))}`:`${r};\n ${s} - ${JSON.stringify((0,Ct.cropOrderData)(t))}`})),`mainType: ${e};\nmainData: ${i};${r}`}const wt="chart-trading",Gt=100,Et=["stopLoss","guaranteedStop","trailingStopPips","trailingStopPrice"],Mt=new Set(["stopLoss","takeProfit","guaranteedStop","trailingStopPips","trailingStopPrice"]),Nt={stopLoss:Pt.BracketType.StopLoss,takeProfit:Pt.BracketType.TakeProfit,guaranteedStop:Pt.BracketType.GuaranteedStop,trailingStopPips:Pt.BracketType.TrailingStop,trailingStopPrice:Pt.BracketType.TrailingStop};function Lt(t){return Mt.has(t)&&"trailingStopPrice"!==t}function Rt(t){return 2!==t?.data().type}class Ft{constructor(t){this._tradedGroupData=new Map,this._tradedGroupPlaceData=null,this._tradedGroupPlaceStatus=null,this._ordersData=new Map,this._positionsData=new Map,this._positionsRealToParentIds=new Map,this._positionsParentIdToReals=new Map,this._preBracketsData=new Map,this._tradedGroupRenderersControllerMap=new WeakMap,this._prevTradedContext=null,this._symbolDataProviders=new Map,this._isMovingEditSource=!1,this._createEditOrderContext=async t=>{this._createEditIndividualPositionContextDebounced.cancel(),this._createEditPositionContextDebounced.cancel();const e=await(0,s.ensureNotNull)(this._realtimeProvider.activeBroker()).createEditOrderContext({order:t,source:wt,isDisposable:!1,orderById:async t=>this._ordersData.get(t)});this._tradedContextLinking.setContext(e)},this._createEditPositionContext=async t=>{this._createEditIndividualPositionContextDebounced.cancel(),this._createEditOrderContextDebounced.cancel();const e=await(0,s.ensureNotNull)(this._realtimeProvider.activeBroker()).createEditPositionContext({position:t,source:wt,isDisposable:!1});this._tradedContextLinking.setContext(e)},this._createEditIndividualPositionContext=async t=>{this._createEditOrderContextDebounced.cancel(),this._createEditPositionContextDebounced.cancel();const e=await(0,s.ensureNotNull)(this._realtimeProvider.activeBroker()).createEditIndividualPositionContext({position:t,source:wt,isDisposable:!1});this._tradedContextLinking.setContext(e)};const{ordersService:e,tradingServices:i,positionsService:r,styleOverridesGetter:o,chartWidgetCollection:n,noConfirmEnabledGetter:d,noConfirmEnabled:c}=t;this._createEditOrderContextDebounced=(0,a.default)(this._createEditOrderContext,Gt,{leading:!0,trailing:!0,maxWait:Gt
}),this._createEditIndividualPositionContextDebounced=(0,a.default)(this._createEditIndividualPositionContext,Gt,{leading:!0,trailing:!0,maxWait:Gt}),this._createEditPositionContextDebounced=(0,a.default)(this._createEditPositionContext,Gt,{leading:!0,trailing:!0,maxWait:Gt}),this._getStyleOverrides=o,this._getNoConfirmEnabled=t=>!0,this._noConfirmEnabled=c.spawn(),this._ordersService=e,this._positionsService=r,this._chartWidgetCollection=n,this._realtimeProvider=i.realtimeProvider,this._qtySuggester=i.qtySuggester,this._brokerCommandsUIGetter=i.brokerCommandsUI,this._closeTradingPanel=i.tradingPanelCloser,this._onCalculatorOpened=i.onCalculatorOpened,this._trackEvent=i.trackEvent,this._showTradedGroup=i.showTradedSources,this._pipValueType$=i.pipValueType$,this._makeActualTradingSymbolObservable=i.makeActualSymbolObservable,this._symbolSpecificTradingOptionsGetter=i.getSymbolSpecificTradingOptions,this._tradedContextLinking=i.activeTradedLinking,this._tradedContextLinking.onContextChanged().subscribe(this,this._updateTradedGroupFromLinking),this._noConfirmEnabled.subscribe((()=>this._tradedContextLinking.clear())),this._addOrderItems(this._ordersService.activeOrders()),this._ordersService.activeOrdersUpdated().subscribe(this,(t=>{const e=this._tradedContextLinking.context(),i=((0,z.isContextEditIndividualPositionContext)(e)||(0,z.isContextEditPositionContext)(e))&&(e.data().id===t.parentId||this._positionsRealToParentIds.get(e.data().id)===t.parentId),r=(0,z.isContextEditOrderContext)(e)&&e.data().id===t.parentId;if(!i&&!r)return(0,z.isContextEditOrderContext)(e)&&e.data().id===t.id?void this._addOrderItems([{...t,...e.data()}]):this._addOrderItems([t])})),this._ordersService.activeOrdersRemoved().subscribe(this,(t=>this._removeTradedGroupItems(t))),this._addPositionItems(this._positionsService.positions().map((t=>({data:t,type:It.PositionsUpdateType.Full})))),this._positionsService.positionUpdate().subscribe(this,(t=>{const e=this._tradedContextLinking.context();if(!(0,z.isContextEditPositionContext)(e)&&!(0,z.isContextEditIndividualPositionContext)(e)||e.data().id!==t.data.id)return this._addPositionItems([t]);const i=(0,rt.getBracketsFromOrderOrPosition)(e.data());this._addPositionItems([{data:{...t.data,...i},type:t.type}])})),this._positionsService.positionsRemoved().subscribe(this,(t=>{const e=this._tradedContextLinking.context(),i=(0,z.isContextEditPositionContext)(e)||(0,z.isContextEditIndividualPositionContext)(e)?e.data().id:void 0;i&&t.some((t=>i===t))&&this._tradedContextLinking.clear(),this._removeTradedGroupItems(t)}))}destroy(){this._createEditIndividualPositionContextDebounced.cancel(),this._createEditPositionContextDebounced.cancel(),this._createEditOrderContextDebounced.cancel(),this._noConfirmEnabled.destroy(),this._tradedContextLinking.onContextChanged().unsubscribeAll(this),this._ordersService.activeOrdersUpdated().unsubscribeAll(this),this._ordersService.activeOrdersRemoved().unsubscribeAll(this),this._ordersData.clear(),this._positionsService.positionUpdate().unsubscribeAll(this),
this._positionsService.positionsRemoved().unsubscribeAll(this),this._positionsData.clear(),this._tradedGroupData.clear()}_configFlags(){return(0,s.ensureNotNull)(this._realtimeProvider.activeBroker()).metainfo().configFlags}_getBracketsBasedOnParentOrderOrPosition(t){const e=[],i=this._getPositionRealIdByParentId(t)??t,s=this._ordersData.get(t)||this._positionsData.get(i);if(void 0===s)return this._ordersData.forEach((i=>{i.parentId===t&&e.push({dataType:"Order",...i,callbacks:this._createCallbacksForOrder(i)})})),e;let o=$.StopType.StopLoss;return void 0!==s.guaranteedStop&&(o=$.StopType.GuaranteedStop),void 0!==s.trailingStopPips&&(o=$.StopType.TrailingStop),this._ordersData.forEach((t=>{(0,rt.isBracketAbsentInParentOrderOrPosition)(t,s)&&this._ordersData.delete(t.id)})),this._preBracketsData.size>0?(this._preBracketsData.forEach((t=>{e.push({...t,dataType:"Order",callbacks:this._createCallbacksForOrder(t)})})),e):(this._ordersData.forEach((i=>{if(i.parentId===t){const t={};if(o!==$.StopType.StopLoss||void 0===s?.stopLoss||void 0!==s?.trailingStopPips||3!==i.type||void 0!==i.stopType&&i.stopType!==$.StopType.StopLoss)if(o===$.StopType.TrailingStop&&void 0!==s?.trailingStopPips&&3===i.type&&i.stopType===$.StopType.TrailingStop){const e=s.trailingStopPrice??i.trailingStopPrice??i.stopPrice??i.price??void 0;t.trailingStopPips=s.trailingStopPips,t.trailingStopPrice=e,t.price=e}else o===$.StopType.GuaranteedStop&&void 0!==s?.guaranteedStop&&3===i.type&&i.stopType===$.StopType.GuaranteedStop?(t.price=s.guaranteedStop,t.stopPrice=s.guaranteedStop):void 0!==s?.takeProfit&&1===i.type&&(t.price=s.takeProfit,t.limitPrice=s.takeProfit);else t.price=s.stopLoss,t.stopPrice=s.stopLoss;if(0===Object.values(t).length)return;const a={...(0,r.default)(i),stopLoss:void 0,takeProfit:void 0,guaranteedStop:void 0,trailingStopPips:void 0,trailingStopPrice:void 0,...t,...this._getSupportFlagsForOrderItem(i)};Object.assign(a,this._getSupportFlagsForOrderItem(a)),(0,rt.isBracketOrderOfPosition)(a)||(a.qty=s.qty),e.push({dataType:"Order",...a,callbacks:this._createCallbacksForOrder(a)}),this._ordersData.set(i.id,a)}})),e)}_getBracketsBasedOnBracketOrders(t){const e=[],i=this._ordersData.get(t);return this._ordersData.forEach((s=>{if(s.parentId===t){const t={dataType:"Order",...(0,r.default)(s),...this._getSupportFlagsForOrderItem(s),callbacks:{}};t.callbacks=this._createCallbacksForOrder(t),void 0===i||(0,rt.isBracketOrderOfPosition)(t)||(t.qty=i.qty),e.push(t)}})),e}_getPreBracketsByParentId(t){const e=[];for(const i of this._preBracketsData.values())i.parentId===t&&e.push(i);return e}_getSupportFlagsForOrderItem(t){const e={};return null!==this._realtimeProvider.activeBroker()&&(e.supportMove=(0,Tt.isMoveOrderSupported)(t,this._configFlags()),e.supportModify=(0,Tt.isModifyOrderSupported)(t,this._configFlags()),e.supportModifyOrderPrice=(0,Tt.isModifyOrderSupported)(t,this._configFlags())),e}_getBrackets(t){let e=t;this._ordersData.has(t)||(e=this._positionsRealToParentIds.get(t)??e);const i=this._tradedContextLinking.context();return((0,
z.isContextEditOrderContext)(i)||(0,z.isContextEditIndividualPositionContext)(i)||(0,z.isContextEditPositionContext)(i))&&i?.data().id===t?this._getBracketsBasedOnParentOrderOrPosition(e):this._getBracketsBasedOnBracketOrders(e)}_updateTradedGroupFromLinking(t){const e=this._prevTradedContext;if(this._prevTradedContext=t,null===this._realtimeProvider.activeBroker())return this._preBracketsData.clear(),void(null!==this._tradedGroupPlaceData&&(gt(this._chartWidgetCollection),this._tradedGroupPlaceData=null));const i=(0,z.isContextEditOrderContext)(t)||(0,z.isContextEditPositionContext)(t)||(0,z.isContextEditIndividualPositionContext)(t);if(t?.status()===z.PlaceOrEditContextStatus.Destroyed)return;if((0,z.isContextPlaceOrderContext)(t)&&Rt(t)){const e=this._createPlaceSourceData(t);null!==this._tradedGroupPlaceData?this._tradedGroupPlaceData.setValue(e):(this._tradedGroupPlaceData=new f.WatchedObject(e),r=this._configFlags(),s=this._tradedGroupPlaceData,o=this._createProjectionOrderErrorWV().ownership(),a=this._createProjectionOrderStatusW().ownership(),n=this._ordersService.orderRejected(),d=this._showTradedGroup,c=this._chartWidgetCollection,l={realtimeProvider:this._realtimeProvider,qtySuggester:this._qtySuggester,pipValueType$:this._pipValueType$,positionSupportReverseGetter:this._positionsService.supportReverse.bind(this._positionsService),positionSupportBracketsGetter:this._positionsService.supportBrackets.bind(this._positionsService),positionCurrencyGetter:this._positionsService.getCurrency.bind(this._positionsService),orderCurrencyGetter:this._ordersService.getCurrency.bind(this._ordersService),symbolSpecificTradingOptionsGetter:this._symbolSpecificTradingOptionsGetter,makeActualTradingSymbolObservable:this._makeActualTradingSymbolObservable},p=this._tradedGroupRenderersControllerMap,h=this._createCallbacksForPlaceOrder(),u=this._trackEvent,c.addCustomSource(`${mt}`,((t,e)=>{const i=V(e,c.getAll(),!0);return W({chartWidgetCollection:c,chartModel:e,configFlags:r,externalCustomSourceServices:l,tradedGroupRenderersControllerMap:p,specialCtor:(i,r,p,_,m,y,g)=>{const f=function(t){if(null===t||1!==t.connectionStatus())return[2];const e=[],{supportMarketOrders:i,supportLimitOrders:r,supportStopOrders:s,supportStopLimitOrders:o}=t.metainfo().configFlags;return i&&e.push(2),r&&e.push(1),s&&e.push(3),o&&e.push(4),e}(l.realtimeProvider.activeBroker()).filter((t=>yt.includes(t))),P=(0,S.combine)((t=>t.model().model()===e),c.activeChartWidget.weakReference()),v=new lt(t,e,r,i,d,s,o.ownership(),a.ownership(),{exitTrackingMode:p,onDataUpdateRejected:n,trackEvent:u,showChartHint:F,hideChartHint:A,...h},m,y,_,f,P.ownership(),g.ownership());return P.value()&&c.activeChartWidget.value().model().model().selectionMacro((t=>{const e=new b.HitTestResult(b.HitTarget.Custom,{cursorType:k.PaneCursorType.Default,hideCrosshairLinesOnHover:!0,...(0,ut.activeItemToHitTestResultData)({id:_t.preOrderItemId,part:9})});t.addSourceToSelection(v,e.data())})),v},properties:i})}),v.CustomSourceLayer.Topmost))
}else null!==this._tradedGroupPlaceData&&(gt(this._chartWidgetCollection),this._tradedGroupPlaceData=null);var r,s,o,a,n,d,c,l,p,h,u;const _=null!==t&&((0,z.isContextEditOrderContext)(e)||(0,z.isContextEditPositionContext)(e)||(0,z.isContextEditIndividualPositionContext)(e));if(_&&(e.type!==t.type||e.data().id!==t.data().id)){if(this._preBracketsData.clear(),(0,z.isContextEditOrderContext)(e)){const t=this._ordersService.activeOrders().filter((t=>t.id===e.data().id||t.parentId===e.data().id));0!==t.length&&this._addOrderItems(t)}if((0,z.isContextEditPositionContext)(e)||(0,z.isContextEditIndividualPositionContext)(e)){const t=this._positionsService.find(e.data().id),i=this._getPositionRealIdByParentId(e.data().id),r=this._ordersService.activeOrders().filter((t=>t.parentId===i));0!==r.length&&this._addOrderItems(r),t&&this._addPositionItems([{data:t,type:It.PositionsUpdateType.Full}])}}if((0,z.isContextEditOrderContext)(t)&&Rt(t)&&t.source()!==wt&&!this._isMovingEditSource){const e=t.data(),i=this._ordersData.get(e.id)??null;if(null===i)return;const r=(0,Ct.makeBracketPatch)({parentId:this._ordersService.find(e.id)?.parentId,parentType:e.parentType,stopType:e.stopType}),s=(0,Ct.applyBracketPatch)((0,g.merge)((0,g.clone)(i),{...e}),r);this._applyProjectionBrackets(s.id,s),this._addOrderItems([s])}if(((0,z.isContextEditPositionContext)(t)||(0,z.isContextEditIndividualPositionContext)(t))&&Rt(t)&&t.source()!==wt&&!this._isMovingEditSource){const e=t.data(),i=this._positionsData.get(e.id)??null;if(null===i)return void Dt.logError("Projection order data is not defined");const r=(0,g.merge)((0,g.clone)(i),(0,g.clone)(e));this._applyProjectionBrackets(r.id,r),this._addPositionItems([{data:r,type:It.PositionsUpdateType.Full}])}(null===t||_&&!i)&&this._cancelEditing()}_cancelEditing(){this._removeTradedGroupItems([...this._ordersData.keys()]),this._removeTradedGroupItems([...this._positionsData.keys()]),this._preBracketsData.clear(),this._addOrderItems(this._ordersService.activeOrders()),this._addPositionItems(this._positionsService.positions().map((t=>({data:t,type:It.PositionsUpdateType.Full}))))}_createProjectionOrderErrorWV(){return(0,P.createWVFromGetterAndSubscription)((()=>this._tradedContextLinking.context()?.errors()??{}),this._tradedContextLinking.onContextChanged())}_createTradedGroupErrorWV(t){return(0,P.createWVFromGetterAndSubscription)((()=>{const e=this._tradedContextLinking.context();return null===e||(0,z.isContextPlaceOrderContext)(e)||e.data().id!==t?{}:e.errors()??{}}),this._tradedContextLinking.onContextChanged())}_createTradedGroupIsLoadingWV(t){return(0,P.createWVFromGetterAndSubscription)((()=>{const e=this._tradedContextLinking.context();return!(!((0,z.isContextEditIndividualPositionContext)(e)||(0,z.isContextEditPositionContext)(e)||(0,z.isContextEditOrderContext)(e))||e.data().id!==t)&&e.status()===z.PlaceOrEditContextStatus.Loading}),this._tradedContextLinking.onContextChanged())}_createTradedGroupIsEditedWV(t){return(0,
P.createWVFromGetterAndSubscription)((()=>!1),this._tradedContextLinking.onContextChanged())}_createProjectionOrderStatusW(){return(0,P.createWVFromGetterAndSubscription)((()=>this._tradedContextLinking.context()?.status()??z.PlaceOrEditContextStatus.Undefined),this._tradedContextLinking.onContextChanged())}_createTradedGroupData(t){let e;const i=this._ordersData.get(t),s=this._positionsData.get(t);void 0!==i?(e={dataType:"Order",...(0,r.default)(i),callbacks:this._createCallbacksForOrder(i)},i.flags?.isReadOnly&&(e={...e,supportModify:!1,supportModifyOrderPrice:!1,supportMove:!1,callbacks:{...e.callbacks,modifyOrder:void 0}})):void 0!==s&&(e={dataType:"Position",...(0,r.default)(s),callbacks:this._createCallbacksForPosition()});const o=this._getBrackets(t);return{main:void 0!==e?{...e,...(0,rt.getBracketsPricesFromBracketOrders)(o)}:e,brackets:o}}_createPlaceSourceData(t){const e=(0,r.default)(t.data()),i=(0,Ct.getOrderPriceByType)(e),s=t.errors(),o=1===e.type&&s.limitPrice||(3===e.type||4===e.type)&&s.stopPrice||2===e.type&&s.limitPrice;(0,g.isNumber)(i)||o||Dt.logError("pre-order price is not defined");const a={dataType:"PreOrder",...e,price:Object.is(i,NaN)?null:i,callbacks:{},supportModify:!0,supportModifyOrderPrice:!0,supportMove:!0,supportCancel:!0,supportStopLoss:(0,Bt.checkStopLossAvailability)(this._configFlags()),supportTrailingStop:(0,Bt.checkTrailingStopAvailability)(this._configFlags()),supportGuaranteedStop:(0,Bt.checkGuaranteedStopAvailability)(this._configFlags()),supportOnlyPairBrackets:Boolean(this._configFlags().supportOnlyPairOrderBrackets),plBasedOnLast:!0};return{main:a,brackets:this._createBracketsFromPlaceContextData(a)}}_createBracketsFromPlaceContextData(t){const e=[];return void 0!==t.takeProfit&&e.push(this._createBracketDataForPlaceOrder(t,Pt.BracketType.TakeProfit,t.takeProfit)),void 0!==t.stopLoss&&e.push(this._createBracketDataForPlaceOrder(t,Pt.BracketType.StopLoss,t.stopLoss)),void 0!==t.trailingStopPips&&e.push(this._createBracketDataForPlaceOrder(t,Pt.BracketType.TrailingStop,null)),void 0!==t.guaranteedStop&&e.push(this._createBracketDataForPlaceOrder(t,Pt.BracketType.GuaranteedStop,t.guaranteedStop)),e}_createBracketDataForPlaceOrder(t,e,i){return{...(0,rt.buildProjectionBracketData)(ct.projectBracketPrefix,e,t),dataType:"Order",price:i,parentId:"preOrder",parentType:1,callbacks:{},supportModify:!0,supportMove:!0,supportCancel:!0,plBasedOnLast:!1}}_recreateTradedGroupSource(t,e=!0,i=""){const r=this._createTradedGroupData(t),o=this._tradedGroupData.get(t);if(void 0!==o)o.setValue({...o.value(),...r}),e&&Dt.logNormal(`Source updated${i}: ${xt(r)}`);else{const e=new f.WatchedObject(r);a=t,n=this._configFlags(),d=e,c=this._createTradedGroupErrorWV(t).ownership(),l=this._createTradedGroupIsLoadingWV(t).ownership(),p=this._createTradedGroupIsEditedWV(t).ownership(),h=this._ordersService.orderRejected(),u=this._showTradedGroup,_=this._chartWidgetCollection,m={styleOverrides:this._getStyleOverrides(),realtimeProvider:this._realtimeProvider,qtySuggester:this._qtySuggester,
pipValueType$:this._pipValueType$,positionSupportReverseGetter:this._positionsService.supportReverse.bind(this._positionsService),positionSupportBracketsGetter:this._positionsService.supportBrackets.bind(this._positionsService),positionCurrencyGetter:this._positionsService.getCurrency.bind(this._positionsService),orderCurrencyGetter:this._ordersService.getCurrency.bind(this._ordersService),symbolSpecificTradingOptionsGetter:this._symbolSpecificTradingOptionsGetter,makeActualTradingSymbolObservable:this._makeActualTradingSymbolObservable},y=this._tradedGroupRenderersControllerMap,g=this._trackEvent,P=this._getNoConfirmEnabled,b=e=>this._symbolDataProviders.set(t,e),k={onCalculatorOpened:this._onCalculatorOpened.bind(this),onQtyApplyHandler:(t,e)=>{const i=(0,s.ensureDefined)(this._ordersData.get(t));e!==i.qty&&this._processingModifyOrder({...i,qty:e},!0)},...this._createCallbacksForEditSource()},_.addCustomSource(`${Ot}${a}`,((t,e)=>{const i=V(e,_.getAll(),!1);return W({chartWidgetCollection:_,chartModel:e,configFlags:n,externalCustomSourceServices:m,tradedGroupRenderersControllerMap:y,specialCtor:(i,r,s,o,a,n)=>{const y=(0,S.combine)((t=>t.model().model()===e),_.activeChartWidget.weakReference());return b(a),new bt(t,e,r,i,u,d,c.ownership(),l.ownership(),p.ownership(),{exitTrackingMode:s,onDataUpdateRejected:h,trackEvent:g,showChartHint:F,hideChartHint:A,...k},a,n,o,m.styleOverrides??null,y.ownership(),P)},properties:i})}),v.CustomSourceLayer.Topmost),this._tradedGroupData.set(t,e),Dt.logNormal(`Source created: ${xt(r)}`)}var a,n,d,c,l,p,h,u,_,m,y,g,P,b,k}async _findPositionRealIdByParentId(t){const e=this._positionsData.get(t);let i;if(void 0!==e)i=e.id;else if(i=await this._positionsService.realIdFromBroker(t),null===i){const e=this._currentRealPositionIdByParentId(t);return null!==e&&(this._positionsRealToParentIds.delete(e),this._positionsParentIdToReals.delete(t)),null}return this._positionsRealToParentIds.set(i,t),this._positionsParentIdToReals.set(t,i),i}_currentRealPositionIdByParentId(t){for(const e of Array.from(this._positionsRealToParentIds.keys()))if(this._positionsRealToParentIds.get(e)===t)return e;return null}async _findAndUpdateParentPosition(t,e=!1,i){const r=this._currentRealPositionIdByParentId(t),s=await this._findPositionRealIdByParentId(t);if(null!==r&&null===s&&this._tradedGroupData.has(r)&&(Dt.logNormal(`Position update (brackets unlink from position), id: ${t}`),this._recreateTradedGroupSource(r)),null===r&&null!==s){const e=this._tradedGroupData.get(t);void 0!==e&&void 0===e.value().main&&(Dt.logNormal(`Position remove (brackets link to position), id: ${t}`),this._removeTradedGroupEditSource(t))}if(e&&r===s)return;const o=this._positionsData.get(t);if(i&&o){const e=(0,rt.createBracketsFromBracketOrderAndParent)(i,o);this._positionsData.set(t,{...o,...e})}this._recreateTradedGroupSource(s||t,void 0," after parent position been found (async operation)")}_findAndUpdateParentOrder(t,e){const i=this._ordersData.get(t);let r={};e&&i&&(r=(0,rt.createBracketsFromBracketOrderAndParent)(e,i),
this._ordersData.set(t,{...i,...r})),this._recreateTradedGroupSource(t)}_addOrderItems(t){for(const e of t){this._removeSourceIfChangedParent(e),this._ordersData.set(e.id,e);const t=void 0!==e.parentId?e.parentId:e.id;(0,Ct.isBracketOrderRawData)(e)&&(0,rt.isBracketOrderOfPosition)(e)?this._findAndUpdateParentPosition(t,void 0,e):(0,Ct.isBracketOrderRawData)(e)?this._findAndUpdateParentOrder(t,e):this._recreateTradedGroupSource(t)}}_addPositionItems(t){for(const e of t){const t=e.data,i=t.id;this._positionsData.set(i,t),this._recreateTradedGroupSource(i,e.type===It.PositionsUpdateType.Full);this._ordersService.activeOrders().filter(Ct.isBracketOrderRawData).filter((e=>2===e.parentType&&e.symbol===t.symbol)).forEach((t=>{this._findAndUpdateParentPosition(t.parentId,!0)}))}}_removeSourceIfChangedParent(t){const e=this._ordersData.get(t.id);void 0===e||e.parentId===t.parentId&&e.parentType===t.parentType||this._removeTradedGroupItems([e.id])}_removeTradedGroupItems(t){for(const e of t){let t=e;if(!this._tradedGroupData.has(e))for(const i of this._tradedGroupData.keys()){for(const r of(0,s.ensureDefined)(this._tradedGroupData.get(i)).value().brackets)if(r.id===e){t=i;break}if(t===i)break}this._positionsData.delete(e),this._ordersData.delete(e);const i=this._createTradedGroupData(t);if(void 0===i.main&&0===i.brackets.length&&this._tradedGroupData.has(t))this._removeTradedGroupEditSource(t);else{const e=this._tradedGroupData.get(t);if(void 0!==e){e.setValue(i),Dt.logNormal(`Source updated: ${xt(i)}`);const t=i.main;if(!t)continue;"Order"===t.dataType&&this._ordersData.set(t.id,t),"Position"===t.dataType&&this._positionsData.set(t.id,t)}}}}_removeTradedGroupEditSource(t){var e,i;this._tradedGroupData.delete(t),this._symbolDataProviders.delete(t),e=this._chartWidgetCollection,i=t,e.removeCustomSource(`${Ot}${i}`),Dt.logNormal(`Traded-source removed, mainItemId: ${t}`)}_createCallbacksForOrder(t){const e={};return t.supportModify&&(e.modifyOrder=this._modifyOrder.bind(this),e.modifyOrderFromContextMenu=this._modifyOrderFromContextMenu.bind(this)),t.supportMove&&(e.moveOrder=this._moveOrder.bind(this)),t.supportCancel&&(e.cancelOrder=this._cancelOrder.bind(this)),e}async _sendEditContext(){const t=(0,s.ensureNotNull)(this._tradedContextLinking.context());if(!(0,z.isContextEditOrderContext)(t)&&!(0,z.isContextEditIndividualPositionContext)(t)&&!(0,z.isContextEditPositionContext)(t))return!1;const e=await t.send();return this._tradedContextLinking.clear(),e}_createCallbacksForEditSource(){return{sendOrder:()=>this._sendEditContext(),cancel:()=>this._tradedContextLinking.clear()}}_createCallbacksForPlaceOrder(){const t=(0,a.default)((async(t,e,i)=>{const o=(0,r.default)(t),a=await(0,s.ensureNotNull)(this._realtimeProvider.activeBroker()).createPlaceOrderContext({order:o,source:wt,silent:i});return this._tradedContextLinking.setContext(a,i),!0}),100,{leading:!0,trailing:!0,maxWait:100});return{modifyOrder:t,onModifyOrderFinished:()=>t.flush(),openOrderTicket:(t,e)=>{this._brokerCommandsUIGetter()?.placeOrder(t,!1,void 0,e)},
cancelOrder:()=>{this._tradedContextLinking.clear()},sendOrder:async()=>{const t=await(0,s.ensureNotNull)(this._tradedContextLinking.context()).send();return this._tradedContextLinking.clear(),t},onCalculatorOpened:()=>this._onCalculatorOpened()}}async _protectPosition(t,e={},i,r){const o=this._tradedContextLinking.context(),a=(0,z.isContextEditIndividualPositionContext)(o)||(0,z.isContextEditPositionContext)(o)&&o.data().id===t,n=a?o.data():this._positionsService.find(t);if(!n)return!1;const d=a?{...(0,rt.getBracketsFromOrderOrPosition)(n),...this._getBracketsBasedOnParentOrderOrPosition(n.id)}:(0,rt.getBracketsFromBracketOrdersRawData)(this._getBracketsBasedOnBracketOrders(t));await this._fillTrailingStopDataInBracketsIfNeeded(n,d);const c=void 0!==d.trailingStopPips&&this._hasPositionTrailingStopBracket(n.id);return this._positionsService.isDisplayModeIndividualPositions()?(0,s.ensureNotNull)(this._brokerCommandsUIGetter()).editIndividualPositionBrackets?.(t,d,void 0,void 0,c):(0,s.ensureNotNull)(this._brokerCommandsUIGetter()).editPositionBrackets(t,d,void 0,void 0,c),!0}_hasPositionTrailingStopBracket(t){const e=this._positionsRealToParentIds.get(t)??t;return[...this._ordersData.values()].some((t=>e===t.parentId&&t.stopType===$.StopType.TrailingStop))}async _fillTrailingStopDataInBracketsIfNeeded(t,e){if(!t.supportTrailingStop||void 0!==e.trailingStopPips&&void 0!==e.trailingStopPrice)return;let i=!1,r=t.id;this._ordersData.has(r)||(i=!0,r=this._positionsRealToParentIds.get(t.id)??t.id);const o=[...this._ordersData.values(),...this._preBracketsData.values()].find((t=>r===t.parentId&&3===t.type&&t.stopType===$.StopType.TrailingStop));if(void 0===o)return;const{price:a,trailingStopPips:n}=o,d=o.trailingStopPrice??a;if(void 0!==n)return e.trailingStopPips=n,void(e.trailingStopPrice=d??void 0);if(null===d)return;const c=(0,s.ensureNotNull)(this._realtimeProvider.activeBroker()),l=t.symbol,p=1===t.side?-1:1;let h="type"in t&&4===t.type?t.limitPrice:t.price;if(i){const{ask:t,bid:e}=await c.quotesSnapshot(l);h=1===p?t:e}const u=this._symbolDataProviders.get(t.id)?.symbolData()?.pipSize;void 0!==h&&void 0!==u&&(e.trailingStopPips=(0,st.calcPipsByPrice)(d,h,p,u),e.trailingStopPrice=d)}_createCallbacksForPosition(){return{reversePosition:this._reversePosition.bind(this),modifyPosition:(t,e={},i,r)=>(this._isMovingEditSource=!0,this._modifyPosition(t,e,i,r)),closePosition:this._closePosition.bind(this),onFinishModify:this._onFinishModifyPosition.bind(this),protectPosition:this._protectPosition.bind(this)}}async _processingModifyOrder(t,e=!1){return(0,Ct.isBracketOrderRawData)(t)&&(0,rt.isBracketOrderOfPosition)(t)&&(0,rt.isPreBracketOrder)(t.id)?this._modifyPositionPreBracketOrder(t):(0,Ct.isBracketOrderRawData)(t)&&1===t.parentType&&(0,rt.isPreBracketOrder)(t.id)?this._modifyOrderPreBracketOrder(t):(0,Ct.isBracketOrderRawData)(t)&&(0,rt.isBracketOrderOfPosition)(t)?this._modifyBracketOfPosition(t):(0,Ct.isBracketOrderRawData)(t)?this._modifyBracketOfOrder(t,e):this._modifyMainOrder(t,e)}
async _modifyBracketOfOrder(t,e=!1){this._ordersData.set(t.id,t);const i=t.parentId,r=(0,rt.getBracketKeyFromBracketOrderRawData)(t),s=this._ordersData.get(i);if(!s)return this._modifyMainOrder(t,e);if(!s||!r)return!1;const o=(0,rt.getBracketsFromOrderOrPosition)(s),a=(0,rt.getBracketsFromPreBracketsDataByParentId)(i,[...this._preBracketsData.values()]);if(void 0===(s.price??([1,4].includes(s.type)?s.limitPrice:s.stopPrice)))return!1;switch(r){case"guaranteedStop":o.guaranteedStop=t.stopPrice,a.guaranteedStop=t.stopPrice,a.stopLoss=void 0;break;case"trailingStopPips":o.trailingStopPips=t.trailingStopPips,o.trailingStopPrice=t.trailingStopPrice,a.trailingStopPips=t.trailingStopPips,a.trailingStopPrice=t.trailingStopPrice,a.stopLoss=void 0;break;case"stopLoss":o.stopLoss=t.stopPrice,a.stopLoss=t.stopPrice;break;case"takeProfit":o.takeProfit=t.limitPrice,a.takeProfit=t.limitPrice}return this._modifyMainOrder({...s,...o,...a},e)}async _modifyBracketOfPosition(t){this._ordersData.set(t.id,t);const e=this._getPositionRealIdByParentId(t.parentId)??t.parentId,i=(0,rt.getBracketKeyFromBracketOrderRawData)(t),r=this._positionsData.get(e);if(!r)return this._createEditOrderContextDebounced(t),this._addOrderItems([t]),!0;if(!r||!i)return!1;const s=(0,rt.getBracketsFromOrderOrPosition)(r),o=(0,rt.getBracketsFromPreBracketsDataByParentId)(e,[...this._preBracketsData.values()]);switch(i){case"guaranteedStop":s.guaranteedStop=t.stopPrice,o.guaranteedStop=t.stopPrice;break;case"trailingStopPips":s.trailingStopPips=t.trailingStopPips,s.trailingStopPrice=t.trailingStopPrice,o.trailingStopPips=t.trailingStopPips,o.trailingStopPrice=t.trailingStopPrice;break;case"stopLoss":s.stopLoss=t.stopPrice,o.stopLoss=t.stopPrice;break;case"takeProfit":s.takeProfit=t.limitPrice,o.takeProfit=t.limitPrice}return await this._fillTrailingStopDataInBracketsIfNeeded(r,s),this._modifyPosition(e,{...s,...o})}async _modifyMainOrder(t,e=!1){const i=this._ordersService.find(t.id);if(!i)return!1;const{price:r,stopLoss:o,stopPrice:a,takeProfit:n,limitPrice:d,guaranteedStop:c,trailingStopPips:l,trailingStopPrice:p,qty:h,customFields:u}=(0,rt.alignOrderRawDataPrices)(t),m={takeProfit:n,stopLoss:o,trailingStopPips:l,trailingStopPrice:p,guaranteedStop:c};await this._fillTrailingStopDataInBracketsIfNeeded(t,m);const y={...i,price:r,stopPrice:a,limitPrice:d,qty:h,...m,customFields:{...await this._createCustomFieldsByParentOrder(i),..._(u,(t=>void 0!==t))}};if(!e&&this._getNoConfirmEnabled(y.id)){this._tradedContextLinking.context()&&this._tradedContextLinking.clear();const t=await(0,s.ensureNotNull)(this._brokerCommandsUIGetter()).modifyOrder(y,!0);return t||this._cancelEditing(),t}return this._createEditOrderContextDebounced(y),this._addOrderItems([y]),!0}async _createCustomFieldsByParentOrder(t){const e=await(0,s.ensureNotNull)(this._realtimeProvider.activeBroker()).getOrderDialogOptions(t.symbol),i={};return e?.customFields?.forEach((t=>i[t.id]=t.value)),i}async _modifyOrder(t,e,i,r){this._getNoConfirmEnabled(e.parentId??e.id)||(this._isMovingEditSource=!1,
this._createEditOrderContextDebounced.flush());const s=e.parentId?this._ordersData.get(e.parentId)??this._positionsData.get(this._getPositionRealIdByParentId(e.parentId)??e.parentId):e;return s&&this._applyProjectionBrackets(s.id,s),this._processingModifyOrder(e)}async _modifyBracketOfOrderFromContextMenu(t){if(!t.parentId)return!1;const e=this._ordersData.get(t.parentId),i=e?(0,rt.getBracketsFromPreBracketsDataByParentId)(t.parentId,[...this._preBracketsData.values()]):void 0,r={};return e&&await this._fillTrailingStopDataInBracketsIfNeeded(e,r),(0,s.ensureNotNull)(this._brokerCommandsUIGetter()).modifyOrder(e?{...e,...r,...i}:t,void 0,this._getOrderTicketFocusControl(t)),!0}_getOrderTicketFocusControl(t){return void 0!==t.limitPrice?3:4}async _modifyBracketOfPositionFromContextMenu(t){if(!t.parentId)return!1;const e=this._getPositionRealIdByParentId(t.parentId),i=e?this._positionsData.get(e):void 0;if(!i)return(0,s.ensureNotNull)(this._brokerCommandsUIGetter()).modifyOrder(t),!0;const r=(0,rt.getBracketsFromPreBracketsDataByParentId)(i.id,[...this._preBracketsData.values()]),o=(0,rt.getBracketsFromOrderOrPosition)(i);await this._fillTrailingStopDataInBracketsIfNeeded(i,o);const a=void 0!==o.trailingStopPips&&this._hasPositionTrailingStopBracket(i.id),n=[i.id,{...o,...r},this._getOrderTicketFocusControl(t),void 0,a];return 3===t.parentType?(0,s.ensureNotNull)(this._brokerCommandsUIGetter()).editIndividualPositionBrackets?.(...n):(0,s.ensureNotNull)(this._brokerCommandsUIGetter()).editPositionBrackets(...n),!0}async _modifyOrderFromContextMenu(t,e,i,r){return e.parentId?1===e.parentType?this._modifyBracketOfOrderFromContextMenu(e):2===e.parentType||3===e.parentType?this._modifyBracketOfPositionFromContextMenu(e):((0,s.ensureNotNull)(this._brokerCommandsUIGetter()).modifyOrder(e),!0):((0,s.ensureNotNull)(this._brokerCommandsUIGetter()).modifyOrder(e),!0)}async _handleModifyPositionBracketsWhenNoConfirmEnabled(t,e={}){this._tradedContextLinking.context()&&this._tradedContextLinking.clear();if(!this._positionsData.get(t))return!1;const i=(0,s.ensureNotNull)(this._brokerCommandsUIGetter()),r=this._positionsService.isDisplayModeIndividualPositions()&&i.editIndividualPositionBrackets?await i.editIndividualPositionBrackets(t,e,void 0,!0):await i.editPositionBrackets(t,e,void 0,!0);return!1===r&&this._cancelEditing(),r}async _moveOrder(t,e,i){return this._isMovingEditSource=!0,this._getNoConfirmEnabled(e.parentId??e.id)?(this._tradedContextLinking.context()&&this._tradedContextLinking.clear(),!0):this._processingModifyOrder(e)}async _cancelOrder(t,e){return(0,rt.isPreBracketOrder)(t)?this._cancelPreBracketOrder(t):e?this._cancelMainOrBracketOrder(t):(0,s.ensureNotNull)(this._brokerCommandsUIGetter()).cancelOrder(t)}_reversePosition(t){const e=this._tradedContextLinking.context();return((0,z.isContextEditPositionContext)(e)||(0,z.isContextEditIndividualPositionContext)(e))&&t===e.data().id&&this._tradedContextLinking.clear(),(0,s.ensureNotNull)(this._brokerCommandsUIGetter()).reversePosition(t)}
async _onFinishModifyPosition(t,e={},i,r){return this._getNoConfirmEnabled(t)?this._handleModifyPositionBracketsWhenNoConfirmEnabled(t,e):(this._isMovingEditSource=!1,this._positionsService.isDisplayModeIndividualPositions()?this._createEditIndividualPositionContextDebounced.flush():this._createEditPositionContextDebounced.flush(),this._applyProjectionBrackets(t,e),this._modifyPosition(t,e,i,r))}_applyProjectionBrackets(t,e={}){if(this._preBracketsData.clear(),this._getNoConfirmEnabled(t))return;const i=this._ordersService.find(t)??this._positionsService.find(this._getPositionRealIdByParentId(t)??t);if(!i)return;const r={...i,...e};for(const t of Object.keys(e).filter(Lt)){const e=Nt[t],s=(0,rt.buildOrderBracketData)({bracketType:e,idPrefix:ct.projectBracketPrefix,parentData:r,isDisplayModeIndividualPositions:this._positionsService.isDisplayModeIndividualPositions(),configFlags:this._configFlags(),hadTrailingStopInitially:void 0!==i.trailingStopPips});null!==s&&this._preBracketsData.set(s.id,s)}}async _modifyPosition(t,e={},i,r){const o=this._getPositionRealIdByParentId(t)??t;if(this._positionsService.isDisplayModeIndividualPositions())return this._modifyIndividualPosition(o,e);const a=this._positionsData.get(o);if(!a)return!1;const n={...a,...e};if(n.hasTrailingStopBracket=void 0!==n.trailingStopPips&&this._hasPositionTrailingStopBracket(o),this._getNoConfirmEnabled(t)){this._tradedContextLinking.context()&&this._tradedContextLinking.clear();const t=await(0,s.ensureNotNull)(this._brokerCommandsUIGetter()).editPositionBrackets(n.id,e,void 0,!0);return!1===t&&this._cancelEditing(),t}return this._createEditPositionContextDebounced(n),this._addPositionItems([{data:n,type:It.PositionsUpdateType.Full}]),!0}_closePosition(t){const e=(0,s.ensureNotNull)(this._brokerCommandsUIGetter());return this._positionsService.isDisplayModeIndividualPositions()?e.closeIndividualPosition(t):e.closePosition(t)}async _modifyPositionPreBracketOrder(t){const e=this._positionsData.get(t.parentId);if(!e)return!1;const i=(0,rt.createBracketsFromBracketOrderAndParent)(t,e);return this._modifyPosition(t.parentId,i)}async _modifyOrderPreBracketOrder(t){const e=this._ordersData.get(t.parentId);if(!e)return!1;const i=(0,rt.createBracketsFromBracketOrderAndParent)(t,e),r={...e,...i};return this._getNoConfirmEnabled(r.id)?(this._tradedContextLinking.context()&&this._tradedContextLinking.clear(),(0,s.ensureNotNull)(this._brokerCommandsUIGetter()).modifyOrder(r,!0)):(this._createEditOrderContextDebounced(r),this._addOrderItems([r]),!0)}async _cancelPreBracketOrder(t){const e=this._preBracketsData.get(t);if(!e)return!1;this._preBracketsData.delete(t);const i=Array.from(this._ordersData.values()).find((t=>t.parentId===e.parentId&&t.stopType===e.stopType&&t.type===e.type&&t.side===e.side));i&&this._ordersData.delete(i.id);let r=!1;return r=(0,rt.isBracketOrderOfPosition)(e)?await this._cancelBracketOrderOfPosition(e):await this._cancelBracketOrderOfOrder(e),r||(this._preBracketsData.set(t,e),i&&this._ordersData.set(i.id,i)),r}
async _cancelMainOrBracketOrder(t){const e=this._ordersData.get(t);if(!e)return!1;let i=!1;return i=(0,Ct.isBracketOrderRawData)(e)&&!1!==e.supportMove?(0,rt.isBracketOrderOfPosition)(e)?await this._cancelBracketOrderOfPosition(e):await this._cancelBracketOrderOfOrder(e):await this._cancelMainOrder(t),i&&this._ordersData.delete(e.id),i}_deleteOrderOrPositionBracket(t,e){const i={...(0,rt.getBracketsFromOrderOrPosition)(t),[e]:void 0};return Et.includes(e)&&(i.stopLoss=void 0,i.guaranteedStop=void 0,i.trailingStopPips=void 0,i.trailingStopPrice=void 0),i}async _cancelBracketOrderOfPosition(t){const e=this._getPositionRealIdByParentId(t.parentId)??t.parentId,i=this._positionsData.get(e);if(!i)return this._cancelMainOrder(t.id);const r=(0,rt.getBracketKeyFromBracketOrderRawData)(t);if(this._ordersData.delete(t.id),!r)return!1;const o=(0,rt.getBracketsFromBracketOrdersRawData)([...this._getBracketsBasedOnBracketOrders(e),...this._getPreBracketsByParentId(e)]);await this._fillTrailingStopDataInBracketsIfNeeded(i,o);let a=this._deleteOrderOrPositionBracket({...i,...o},r);return i.supportOnlyPairBrackets&&(this._clearBrackets(e),a={stopLoss:void 0,takeProfit:void 0,guaranteedStop:void 0,trailingStopPips:void 0,trailingStopPrice:void 0}),this._getNoConfirmEnabled(t.parentId)?!(0,rt.isPreBracketOrder)(t.id)&&(0,s.ensureNotNull)(this._brokerCommandsUIGetter()).cancelOrder(t.id):this._modifyPosition(i.id,a)}_clearBrackets(t){this._preBracketsData.clear(),Array.from(this._ordersData.values()).filter((e=>e.parentId===t)).forEach((t=>{this._ordersData.delete(t.id)}))}async _cancelBracketOrderOfOrder(t){const e=this._ordersData.get(t.parentId);if(!e)return this._cancelMainOrder(t.id);const i=(0,rt.getBracketKeyFromBracketOrderRawData)(t);if(this._ordersData.delete(t.id),!i)return!1;const r={};await this._fillTrailingStopDataInBracketsIfNeeded(e,r);let o=this._deleteOrderOrPositionBracket({...e,...r},i);return e.supportOnlyPairBrackets&&(this._clearBrackets(t.parentId),o={stopLoss:void 0,takeProfit:void 0,guaranteedStop:void 0,trailingStopPips:void 0,trailingStopPrice:void 0}),this._getNoConfirmEnabled(t.parentId)?!(0,rt.isPreBracketOrder)(t.id)&&(0,s.ensureNotNull)(this._brokerCommandsUIGetter()).cancelOrder(t.id):this._processingModifyOrder({...e,...o})}_cancelMainOrder(t){return(0,s.ensureNotNull)(this._brokerCommandsUIGetter()).cancelOrder(t)}async _modifyIndividualPosition(t,e){const i=this._positionsData.get(t);if(!i)return!1;const r={...i,...e};if(this._getNoConfirmEnabled(t)){this._tradedContextLinking.context()&&this._tradedContextLinking.clear();return await((0,s.ensureNotNull)(this._brokerCommandsUIGetter()).editIndividualPositionBrackets?.(r.id,e,void 0,!0))??!1}return this._createEditIndividualPositionContextDebounced(r),this._addPositionItems([{data:r,type:It.PositionsUpdateType.Full}]),!0}_getPositionRealIdByParentId(t){return this._positionsParentIdToReals.get(t)}}}}]);