(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[5142,4579],{24654:e=>{"use strict";e.exports=function(e){for(var t=[],i=e.length,s=0;s<i;s++){var r=e.charCodeAt(s);if(r>=55296&&r<=56319&&i>s+1){var o=e.charCodeAt(s+1);o>=56320&&o<=57343&&(r=1024*(r-55296)+o-56320+65536,s+=1)}r<128?t.push(r):r<2048?(t.push(r>>6|192),t.push(63&r|128)):r<55296||r>=57344&&r<65536?(t.push(r>>12|224),t.push(r>>6&63|128),t.push(63&r|128)):r>=65536&&r<=1114111?(t.push(r>>18|240),t.push(r>>12&63|128),t.push(r>>6&63|128),t.push(63&r|128)):t.push(239,191,189)}return new Uint8Array(t).buffer}},9995:(e,t,i)=>{var s=i(939340);e.exports=function(e){return e=s(e^=e>>>16,2246822507),e=s(e^=e>>>13,3266489909),(e^=e>>>16)>>>0}},939340:e=>{"use strict";e.exports=Math.imul||function(e,t){var i=65535&e,s=65535&t;return i*s+((e>>>16&65535)*s+i*(t>>>16&65535)<<16>>>0)|0}},138672:e=>{e.exports={"nav-button":"nav-button-znwuaSC1",link:"link-znwuaSC1",background:"background-znwuaSC1",icon:"icon-znwuaSC1","flip-icon":"flip-icon-znwuaSC1","size-large":"size-large-znwuaSC1","preserve-paddings":"preserve-paddings-znwuaSC1","size-medium":"size-medium-znwuaSC1","size-small":"size-small-znwuaSC1","size-xsmall":"size-xsmall-znwuaSC1","size-xxsmall":"size-xxsmall-znwuaSC1","visually-hidden":"visually-hidden-znwuaSC1"}},241427:e=>{e.exports={dialog:"dialog-aRAWUDhF",rounded:"rounded-aRAWUDhF",shadowed:"shadowed-aRAWUDhF",fullscreen:"fullscreen-aRAWUDhF",darker:"darker-aRAWUDhF",backdrop:"backdrop-aRAWUDhF"}},649107:e=>{e.exports={loader:"loader-UL6iwcBa",static:"static-UL6iwcBa",item:"item-UL6iwcBa","tv-button-loader":"tv-button-loader-UL6iwcBa",medium:"medium-UL6iwcBa",small:"small-UL6iwcBa",black:"black-UL6iwcBa",white:"white-UL6iwcBa",gray:"gray-UL6iwcBa",primary:"primary-UL6iwcBa"}},153895:e=>{e.exports={disableSelfPositioning:"disableSelfPositioning-dYiqkKAE"}},467922:e=>{e.exports={lightTabButton:"lightTabButton-_v4jz9BC",disabled:"disabled-_v4jz9BC",selected:"selected-_v4jz9BC",content:"content-_v4jz9BC",xsmall:"xsmall-_v4jz9BC",small:"small-_v4jz9BC",medium:"medium-_v4jz9BC"}},333714:e=>{e.exports={lightTabs:"lightTabs-LqEaU5HP",medium:"medium-LqEaU5HP"}},71237:e=>{e.exports={hotkeyBox:"hotkeyBox-tKlfK60Y"}},325826:e=>{e.exports={separator:"separator-gVkHdN_4"}},593854:e=>{e.exports={header:"header-W5uTS8cc",wrapper:"wrapper-W5uTS8cc",statusLine:"statusLine-W5uTS8cc",informer:"informer-W5uTS8cc",title:"title-W5uTS8cc",logoWrapper:"logoWrapper-W5uTS8cc",logo:"logo-W5uTS8cc",button:"button-W5uTS8cc",headerContainer:"headerContainer-W5uTS8cc",description:"description-W5uTS8cc"}},632379:e=>{e.exports={delayedDataTitleColor:"var(--color-delay-mode)",batsQuotesTitleColor:"var(--color-notaccurate-mode)",button:"button-ljwP914Q",icon:"icon-ljwP914Q",wrapper:"wrapper-ljwP914Q",infoContainer:"infoContainer-ljwP914Q",title:"title-ljwP914Q",text:"text-ljwP914Q",actionButton:"actionButton-ljwP914Q",delayedDataIcon:"delayedDataIcon-ljwP914Q",batsQuotesIcon:"batsQuotesIcon-ljwP914Q"}},654259:e=>{e.exports={rootContainer:"rootContainer-LlInYWMC",
hidden:"hidden-LlInYWMC","trading-panel-content":"trading-panel-content-LlInYWMC","trading-panel-spinner":"trading-panel-spinner-LlInYWMC","trading-panel-header":"trading-panel-header-LlInYWMC","trading-panel-tabs":"trading-panel-tabs-LlInYWMC","trading-panel-handle":"trading-panel-handle-LlInYWMC",cover:"cover-LlInYWMC"}},251284:e=>{e.exports={"tablet-normal-breakpoint":"(max-width: 768px)","small-height-breakpoint":"(max-height: 360px)","tablet-small-breakpoint":"(max-width: 440px)"}},772908:e=>{e.exports={dialog:"dialog-b8SxMnzX",wrapper:"wrapper-b8SxMnzX",separator:"separator-b8SxMnzX",bounded:"bounded-b8SxMnzX"}},174714:e=>{e.exports={"small-height-breakpoint":"(max-height: 360px)",container:"container-BZKENkhT",unsetAlign:"unsetAlign-BZKENkhT",title:"title-BZKENkhT",subtitle:"subtitle-BZKENkhT",textWrap:"textWrap-BZKENkhT",ellipsis:"ellipsis-BZKENkhT",close:"close-BZKENkhT",icon:"icon-BZKENkhT"}},947156:e=>{e.exports={"tablet-normal-breakpoint":"(max-width: 768px)","tooltip-offset":"20px",dialog:"dialog-qyCw0PaN",dragging:"dragging-qyCw0PaN",mobile:"mobile-qyCw0PaN",fullscreen:"fullscreen-qyCw0PaN",dialogAnimatedAppearance:"dialogAnimatedAppearance-qyCw0PaN",dialogAnimation:"dialogAnimation-qyCw0PaN",dialogTooltip:"dialogTooltip-qyCw0PaN"}},315015:e=>{e.exports={separator:"separator-Pf4rIzEt"}},855385:(e,t,i)=>{var s=i(939340),r=i(9995),o=i(24654),n=new Uint32Array([3432918353,461845907]);function a(e,t){return e<<t|e>>>32-t}e.exports=function(e,t){if(t=t?0|t:0,"string"==typeof e&&(e=o(e)),!(e instanceof ArrayBuffer))throw new TypeError("Expected key to be ArrayBuffer or string");var i=new Uint32Array([t]);return function(e,t){for(var i=e.byteLength/4|0,r=new Uint32Array(e,0,i),o=0;o<i;o++)r[o]=s(r[o],n[0]),r[o]=a(r[o],15),r[o]=s(r[o],n[1]),t[0]=t[0]^r[o],t[0]=a(t[0],13),t[0]=s(t[0],5)+3864292196}(e,i),function(e,t){var i=e.byteLength/4|0,r=e.byteLength%4,o=0,l=new Uint8Array(e,4*i,r);switch(r){case 3:o^=l[2]<<16;case 2:o^=l[1]<<8;case 1:o^=l[0],o=a(o=s(o,n[0]),15),o=s(o,n[1]),t[0]=t[0]^o}}(e,i),function(e,t){t[0]=t[0]^e.byteLength,t[0]=r(t[0])}(e,i),i.buffer}},389986:(e,t,i)=>{"use strict";i.d(t,{CloseButton:()=>y});var s=i(50959),r=i(270762),o=i(117105),n=i.n(o),a=i(315130),l=i.n(a),d=i(238822),u=i.n(d),c=i(663346),h=i.n(c),p=i(534983),_=i.n(p);function g(e="large"){switch(e){case"large":return n();case"medium":default:return l();case"small":return u();case"xsmall":return h();case"xxsmall":return _()}}const y=s.forwardRef(((e,t)=>s.createElement(r.NavButton,{...e,ref:t,icon:g(e.size)})))},270762:(e,t,i)=>{"use strict";i.d(t,{NavButton:()=>c});var s=i(50959),r=i(497754),o=i.n(r),n=i(878112),a=(i(15378),i(138672)),l=i.n(a);function d(e){const{size:t="large",preservePaddings:i,isLink:s,flipIconOnRtl:r,className:n}=e;return o()(l()["nav-button"],l()[`size-${t}`],i&&l()["preserve-paddings"],r&&l()["flip-icon"],s&&l().link,n)}function u(e){const{children:t,icon:i}=e;return s.createElement(s.Fragment,null,s.createElement("span",{className:l().background}),s.createElement(n.Icon,{icon:i,className:l().icon,
"aria-hidden":!0}),t&&s.createElement("span",{className:l()["visually-hidden"]},t))}const c=(0,s.forwardRef)(((e,t)=>{const{icon:i,type:r="button",preservePaddings:o,flipIconOnRtl:n,size:a,"aria-label":l,...c}=e;return s.createElement("button",{...c,className:d({...e,children:l}),ref:t,type:r},s.createElement(u,{icon:i},l))}));c.displayName="NavButton";var h=i(591365),p=i(273388);(0,s.forwardRef)(((e,t)=>{const{icon:i,renderComponent:r,"aria-label":o,...n}=e,a=r??h.CustomComponentDefaultLink;return s.createElement(a,{...n,className:d({...e,children:o,isLink:!0}),reference:(0,p.isomorphicRef)(t)},s.createElement(u,{icon:i},o))})).displayName="NavAnchorButton"},80137:(e,t,i)=>{"use strict";i.d(t,{Dialog:()=>c});var s=i(50959),r=i(497754),o=i.n(r),n=i(682925),a=i(801808),l=i(800417),d=i(241427),u=i.n(d);class c extends s.PureComponent{constructor(){super(...arguments),this._manager=new a.OverlapManager,this._handleSlot=e=>{this._manager.setContainer(e)}}render(){const{rounded:e=!0,shadowed:t=!0,fullscreen:i=!1,darker:r=!1,className:a,backdrop:d,containerTabIndex:c=-1}=this.props,h=o()(a,u().dialog,e&&u().rounded,t&&u().shadowed,i&&u().fullscreen,r&&u().darker),p=(0,l.filterDataProps)(this.props),_=this.props.style?{...this._createStyles(),...this.props.style}:this._createStyles();return s.createElement(s.Fragment,null,s.createElement(n.SlotContext.Provider,{value:this._manager},d&&s.createElement("div",{onClick:this.props.onClickBackdrop,className:u().backdrop}),s.createElement("div",{...p,className:h,style:_,ref:this.props.reference,onFocus:this.props.onFocus,onMouseDown:this.props.onMouseDown,onMouseUp:this.props.onMouseUp,onClick:this.props.onClick,onKeyDown:this.props.onKeyDown,tabIndex:c,"aria-label":this.props.containerAriaLabel},this.props.children)),s.createElement(n.Slot,{reference:this._handleSlot}))}_createStyles(){const{bottom:e,left:t,width:i,right:s,top:r,zIndex:o,height:n}=this.props;return{bottom:e,left:t,right:s,top:r,zIndex:o,maxWidth:i,height:n}}}},234404:(e,t,i)=>{"use strict";i.d(t,{Loader:()=>d});var s,r=i(50959),o=i(497754),n=i.n(o),a=i(649107),l=i.n(a);function d(e){const{className:t,size:i="medium",staticPosition:s,color:o="black"}=e,a=n()(l().item,l()[o],l()[i]);return r.createElement("span",{className:n()(l().loader,s&&l().static,t)},r.createElement("span",{className:a}),r.createElement("span",{className:a}),r.createElement("span",{className:a}))}!function(e){e.Medium="medium",e.Small="small"}(s||(s={}))},672511:(e,t,i)=>{"use strict";i.d(t,{Spinner:()=>d});var s=i(50959),r=i(497754),o=i.n(r),n=i(843442),a=(i(140987),i(153895)),l=i.n(a);function d(e){const{ariaLabel:t,ariaLabelledby:i,className:r,style:a,size:d,id:u,disableSelfPositioning:c}=e;return s.createElement("div",{className:o()(r,"tv-spinner","tv-spinner--shown",`tv-spinner--size_${n.spinnerSizeMap[d||n.DEFAULT_SIZE]}`,c&&l().disableSelfPositioning),style:a,role:"progressbar",id:u,"aria-label":t,"aria-labelledby":i})}},896009:(e,t,i)=>{"use strict";i.d(t,{HotkeyBox:()=>n});var s=i(50959),r=i(71237),o=i.n(r)
;function n({keyboardKey:e}){return s.createElement("span",{className:o().hotkeyBox},e)}},738036:(e,t,i)=>{"use strict";i.d(t,{OutsideEvent:()=>r});var s=i(908783);function r(e){const{children:t,...i}=e;return t((0,s.useOutsideEvent)(i))}},586816:(e,t,i)=>{"use strict";i.d(t,{ORDERS_GROUP_ID:()=>s});const s="orders"},242843:(e,t,i)=>{"use strict";i.d(t,{getHeadingText:()=>d,getOrderInfoTexts:()=>u});var s=i(609838),r=i(721762),o=i(980956);const n={0:e=>s.t(null,{replace:{symbol:e}},i(877889)),5:e=>s.t(null,{replace:{symbol:e}},i(735055)),3:e=>s.t(null,{replace:{symbol:e}},i(184536)),2:e=>s.t(null,{replace:{symbol:e}},i(425034)),1:e=>s.t(null,{replace:{symbol:e}},i(107364)),4:e=>s.t(null,{replace:{symbol:e}},i(978630))},a={[r.StopType.StopLoss]:{0:e=>s.t(null,{replace:{symbol:e}},i(533423)),5:e=>s.t(null,{replace:{symbol:e}},i(256969)),3:e=>s.t(null,{replace:{symbol:e}},i(465730)),2:e=>s.t(null,{replace:{symbol:e}},i(141089)),1:e=>s.t(null,{replace:{symbol:e}},i(25141)),4:e=>s.t(null,{replace:{symbol:e}},i(258578))},[r.StopType.TrailingStop]:{0:e=>s.t(null,{replace:{symbol:e}},i(581861)),5:e=>s.t(null,{replace:{symbol:e}},i(543655)),3:e=>s.t(null,{replace:{symbol:e}},i(490645)),2:e=>s.t(null,{replace:{symbol:e}},i(107497)),1:e=>s.t(null,{replace:{symbol:e}},i(538030)),4:e=>s.t(null,{replace:{symbol:e}},i(428941))},[r.StopType.GuaranteedStop]:{0:e=>s.t(null,{replace:{symbol:e}},i(131629)),5:e=>s.t(null,{replace:{symbol:e}},i(728481)),3:e=>s.t(null,{replace:{symbol:e}},i(779598)),2:e=>s.t(null,{replace:{symbol:e}},i(888894)),1:e=>s.t(null,{replace:{symbol:e}},i(666391)),4:e=>s.t(null,{replace:{symbol:e}},i(508106))}},l={1:{0:e=>s.t(null,{replace:{symbol:e}},i(900493)),5:e=>s.t(null,{replace:{symbol:e}},i(586246)),3:e=>s.t(null,{replace:{symbol:e}},i(133480)),2:e=>s.t(null,{replace:{symbol:e}},i(570694)),1:e=>s.t(null,{replace:{symbol:e}},i(743087)),4:e=>s.t(null,{replace:{symbol:e}},i(804352))},2:{0:e=>s.t(null,{replace:{symbol:e}},i(649642)),5:e=>s.t(null,{replace:{symbol:e}},i(924681)),3:e=>s.t(null,{replace:{symbol:e}},i(771010)),2:e=>s.t(null,{replace:{symbol:e}},i(847816)),1:e=>s.t(null,{replace:{symbol:e}},i(404107)),4:e=>s.t(null,{replace:{symbol:e}},i(623851))},3:{0:e=>s.t(null,{replace:{symbol:e}},i(447530)),5:e=>s.t(null,{replace:{symbol:e}},i(321105)),3:e=>s.t(null,{replace:{symbol:e}},i(920175)),2:e=>s.t(null,{replace:{symbol:e}},i(27267)),1:e=>s.t(null,{replace:{symbol:e}},i(543880)),4:e=>s.t(null,{replace:{symbol:e}},i(897978))},4:{0:e=>s.t(null,{replace:{symbol:e}},i(531955)),5:e=>s.t(null,{replace:{symbol:e}},i(347693)),3:e=>s.t(null,{replace:{symbol:e}},i(875482)),2:e=>s.t(null,{replace:{symbol:e}},i(407371)),1:e=>s.t(null,{replace:{symbol:e}},i(672173)),4:e=>s.t(null,{replace:{symbol:e}},i(976044))}};function d(e){const{displaySymbol:t,orderType:i,toastType:s,parentId:o,stopType:d}=e;return o?1===i?n[s](t):a[d??r.StopType.StopLoss][s](t):l[i][s](t)}function u(e){const{side:t,orderType:r,quantity:n,primaryPrice:a,secondaryPrice:l}=e,d=o.defaultQuantityFormatter.format(n);if(!a)return{
primaryText:1===t?s.t(null,{replace:{quantity:d}},i(581591)):s.t(null,{replace:{quantity:d}},i(117112))};let u;4===r&&l&&(u=1===t?s.t(null,{replace:{quantity:d,limitPrice:a,stopPrice:l}},i(379498)):s.t(null,{replace:{quantity:d,limitPrice:a,stopPrice:l}},i(754789))),void 0===u&&(u=1===t?s.t(null,{replace:{quantity:d,price:a}},i(880512)):s.t(null,{replace:{quantity:d,price:a}},i(162734)));const[c,h]=u.split("{separatorTag}");return{primaryText:c,secondaryText:h}}},153894:(e,t,i)=>{"use strict";i.d(t,{TRADING_NOTIFICATIONS_GROUP_ID:()=>s});const s="trading-notifications"},763281:(e,t,i)=>{"use strict";i.d(t,{OrderTicketProvider:()=>c,SettingsContext:()=>a,WidgetContext:()=>l});var s=i(50959),r=i(661851),o=i(895318),n=i(363111);const a=s.createContext(o.defaultSettings),l=s.createContext({mode:n.OrderEditorDisplayMode.Panel,orderPanelStatus:n.OrderPanelStatus.Active});function d(e){const{children:t,settings$:i}=e,n=(0,r.useObservable)(i,o.defaultSettings);return s.createElement(a.Provider,{value:n},t)}function u(e){const{children:t,mode:i,orderPanelStatus$:o,isFractional:a}=e,d=(0,r.useObservable)(o);return s.createElement(l.Provider,{value:{mode:i,orderPanelStatus:d??n.OrderPanelStatus.Active,isFractional:a}},t)}function c(e){const{children:t,settings$:i,mode:r,orderPanelStatus$:o,isFractional:n}=e;return s.createElement(u,{mode:r,orderPanelStatus$:o,isFractional:n},s.createElement(d,{settings$:i},t))}},363111:(e,t,i)=>{"use strict";i.d(t,{BracketDefaultPips:()=>l,BracketSubControlType:()=>c,CalculatorDecKeyCodes:()=>_,CalculatorIncKeyCodes:()=>g,OrderEditorDisplayMode:()=>o,OrderPanelStatus:()=>s,OrderPlacingStatus:()=>r,PriceSubControlType:()=>p,QuantitySubControlType:()=>h,orderTypes:()=>v});var s,r,o,n,a,l,d,u,c,h,p,_,g,y,b,m=i(609838);!function(e){e[e.Wait=0]="Wait",e[e.Active=1]="Active",e[e.Editing=2]="Editing",e[e.Preview=3]="Preview"}(s||(s={})),function(e){e[e.Creating=0]="Creating",e[e.Placed=1]="Placed"}(r||(r={})),function(e){e.Popup="popup",e.Panel="panel",e.ResizableDrawer="resizabledrawer"}(o||(o={})),function(e){e[e.AbsolutePrice=0]="AbsolutePrice",e[e.RelativePrice=1]="RelativePrice"}(n||(n={})),function(e){e[e.Quantity=0]="Quantity",e[e.BaseCurrencyQuantity=1]="BaseCurrencyQuantity",e[e.QuoteCurrencyQuantity=2]="QuoteCurrencyQuantity",e[e.OrderSizeCalculator=3]="OrderSizeCalculator"}(a||(a={})),function(e){e[e.TakeProfit=75]="TakeProfit",e[e.StopLoss=25]="StopLoss"}(l||(l={})),function(e){e.Price="Price",e.PriceEquivalent="PriceEquivalent"}(d||(d={})),function(e){e.Pips="Pips",e.RiskInCurrency="RiskInCurrency",e.RiskInPercent="RiskInPercent",e.ParentPricePercent="ParentPricePercent"}(u||(u={})),function(e){e.Price="Price",e.Pips="Pips",e.Money="Money",e.Percent="Percent",e.ParentPricePercent="ParentPricePercent"}(c||(c={})),function(e){e.Units="Units",e.BaseCurrency="BaseCurrency",e.QuoteCurrency="QuoteCurrency"}(h||(h={})),function(e){e.Absolute="Absolute",e.Relative="Relative"}(p||(p={})),function(e){e[e.Minus=189]="Minus",e[e.NumMinus=109]="NumMinus",e[e.FirefoxMinus=173]="FirefoxMinus"
}(_||(_={})),function(e){e[e.Plus=187]="Plus",e[e.NumPlus=107]="NumPlus",e[e.FirefoxPlus=61]="FirefoxPlus"}(g||(g={})),function(e){e[e.SideBuy=0]="SideBuy",e[e.SideSell=1]="SideSell"}(y||(y={})),function(e){e[e.Ready=0]="Ready",e[e.Loading=1]="Loading",e[e.Error=2]="Error",e[e.NoData=3]="NoData"}(b||(b={}));const v={1:m.t(null,void 0,i(790258)),2:m.t(null,void 0,i(490138)),3:m.t(null,void 0,i(898251)),4:m.t(null,void 0,i(978369))}},895318:(e,t,i)=>{"use strict";i.d(t,{defaultSettings:()=>s});const s={showRelativePriceControl:!0,showOrderPreview:!0,enableQuantityInRisk:!1}},600297:(e,t,i)=>{"use strict";i.d(t,{Button:()=>n,ButtonType:()=>s});var s,r=i(50959),o=i(228837);function n(e){const{value:t,buttonType:i,className:n,icon:a,onClick:l,reference:d}=e;let u;switch(i){case s.PlusValue:case s.IncDec:u=t;break;case s.Clear:u="clear";break;case s.Default:u="default"}return r.createElement(o.SquareButton,{reference:d,className:n,"data-value":u,"data-name":`qtyButtonCalculator-${u}`,onClick:()=>{l(t,i)},size:"xsmall",variant:"secondary",color:"gray"},a||t)}!function(e){e[e.PlusValue=0]="PlusValue",e[e.IncDec=1]="IncDec",e[e.Clear=2]="Clear",e[e.Default=3]="Default"}(s||(s={}))},820660:(e,t,i)=>{"use strict";i.d(t,{useEnterAndSpaceKeyDownHandler:()=>o});var s=i(50959),r=i(930202);function o(e,t){return(0,s.useCallback)((i=>{t?.stopAllPropagation&&i.stopPropagation();const s=(0,r.hashFromEvent)(i);13!==s&&32!==s||(i.stopPropagation(),i.preventDefault(),e?.())}),[e])}},157129:(e,t,i)=>{"use strict";i.d(t,{createReactRoot:()=>c});var s=i(50959),r=i(632227),o=i(904237),n=i(201290),a=i(69111),l=i(229144);const d={iOs:"old",android:"new",old:"old",new:"new",any:"any"};function u(e){const[t]=(0,s.useState)({isOnMobileAppPage:e=>(0,a.isOnMobileAppPage)(d[e]),isRtl:(0,l.isRtl)(),locale:window.locale,renderMode:e.renderMode??"legacy"});return s.createElement(n.AppContext.Provider,{value:t},e.children)}function c(e,t,i="legacy"){const n=s.createElement(u,{renderMode:i},e);if("modern"===i){const e=(0,o.createRoot)(t);return e.render(n),{render(t){e.render(s.createElement(u,{renderMode:i},t))},unmount(){e.unmount()}}}return r.render(n,t),{render(e){r.render(s.createElement(u,{renderMode:i},e),t)},unmount(){r.unmountComponentAtNode(t)}}}},909702:(e,t,i)=>{"use strict";i.d(t,{alertSounds:()=>p,enableAlertSoundsForMobile:()=>b,onStopped:()=>y,play:()=>_,stop:()=>g});var s=i(609838),r=i(69111),o=i(671945),n=i(963632);const a=i.p+"alarm_clock.6f8cd36a9014a21689b4.mp3";var l;!function(e){e.Classic="classic",e.Soft="soft",e.Nature="nature",e.Voices="voices",e.Funny="funny"}(l||(l={}));const d=(0,o.getLogger)("Lib.Sound",{color:"#dea433"}),u={sound:"notification/notification",alert:"alert/fired"},c=[{title:s.t(null,void 0,i(510526)),path:"alert/alarm_clock",soundForAlerts:!0,filePath:a,group:l.Classic}];const h={};function p(){return c.filter((e=>!!e.soundForAlerts&&e.group===l.Classic))}function _(e=u.sound,t,i){if((0,r.isOnMobileAppPage)("any"))return Promise.resolve();d.logNormal(`Sound play attempt for "${e}" duration-${t||0}s;`)
;return v(e).play(t,i)}function g(e,t=!1){if((0,r.isOnMobileAppPage)("any"))return;let i=[];e?i.push(v(e)):i=Object.values(h),i.forEach((e=>{e.stop(t)}))}function y(e,t){(0,r.isOnMobileAppPage)("any")||v(e).playing.subscribe((e=>{e||t()}),{once:!0})}function b(){m(p().map((e=>e.path)))}function m(e){if((0,r.isOnMobileAppPage)("any"))return;if(!e)return;if(!/iPhone|iPad|iPod|Android|BlackBerry|BB10|Silk|Mobi/i.test(window.navigator.userAgent))return;if(Array.isArray(e)||(e=[e]),0===(e=e.filter((e=>{const t=v(e);return!(!t||!t.el.load||t._mobilePreloadActive)&&(t._mobilePreloadActive=!0,!0)}))).length)return void d.logNormal("enableForMobile no sounds passed");const t=()=>{const s=[];Array.isArray(e)&&e.forEach((e=>{const t=v(e);t.el.load();const i=t.play().catch((e=>{if("AbortError"!==e.name)throw d.logError(`enableForMobile for "${t.el.src}" preload error: - ${e.message}`),e}));t.el.pause(),s.push(i)})),Promise.all(s).then((()=>{d.logNormal("enableForMobile sounds initialized")})),i.forEach((e=>{document.removeEventListener(e,t,!0)}))},i=["click","touchend","keydown"];i.forEach((e=>{document.addEventListener(e,t,!0)}))}const v=e=>{if(e in h)return h[e];d.logNormal(`requested sound  ${e} not cached, building a new audio element`);const t=c.find((t=>t.path===e));if(void 0===t)throw new Error(`Cannot find sound "${e}"`);const i=new Audio(t.filePath),s=new n.WatchedValue(t.soundForAlerts?.5:1);let r=s;const o=()=>{i.volume=r.value(),d.logNormal(`Volume for sound ${e} is set to ${i.volume}`)},a=()=>{r.unsubscribe(o),r=s,o()};o();const l={el:i,playing:new n.WatchedValue(!1),play:(t=0,i)=>l.playing.value()?(d.logNormal("sound already playing"),Promise.reject("already playing")):(l.playing.setValue(!0),new Promise(((s,n)=>{let a=t>0;const u=()=>{const t=function(e){try{d.logNormal(`"${e.el.src}" triggering html5 play method, readyState - ${e.el.readyState}; muted - ${e.el.muted}; volume - ${e.el.volume}; currentTime - ${e.el.currentTime}`);let t=e.el.play();return t||(t=Promise.resolve()),t}catch(t){return d.logError(`play method for "${e.el.src}" catch error - ${t.message}`),Promise.reject(t)}}(l);t.catch((t=>{d.logNormal(`stop counting sound "${e}"; as playing due to an error: ${t.message}`),l.stop(),n(t)}))};l._onEnded=()=>{a?u():(l.stop(),s())},l.el.addEventListener("ended",l._onEnded),a&&setTimeout((()=>{d.logNormal(`"${e}" repeat timeout - ${t}s off`),a=!1}),1e3*t),i&&(e=>{r.unsubscribe(o),r=e,r.subscribe(o),o()})(i),u()})).finally(a)),stop:(e=!1)=>{l.el.pause(),e&&(l.el.currentTime=0),l.playing.setValue(!1),l._onEnded&&l.el.removeEventListener("ended",l._onEnded)}};h[e]=l;return["canplaythrough","error"].forEach((t=>{i.addEventListener(t,(()=>{d.logNormal(`for sound "${e}", event - ${t} is fired`)}),!1)})),d.logNormal(`canPlayType - ${i.canPlayType("audio/mp3")}`),h[e]};m(c.filter((e=>!!e.common)).map((e=>e.path)))},650733:(e,t,i)=>{"use strict";i.d(t,{batsToRealtimeCrucialHtml:()=>S,batsToRealtimeHtml1:()=>v,batsToRealtimeHtml2WithExchange:()=>P,batsToRealtimeHtml2WithoutExchange:()=>f,delayHtml:()=>u,
delayNoRealtimeHtml:()=>p,delayToRealtimeHtml:()=>h,delayTooltip:()=>o,delayWithoutMarketAgreement:()=>m,eodHtml:()=>_,eodTooltip:()=>n,exchangeByOriginalExchangeTooltip:()=>d,notAccurate1PerSecondTooltip:()=>a,notAccurateCboeTooltip:()=>l,overnightQuotesText:()=>C,overnightQuotesTitle:()=>k,rtFreeForRegisteredUsersHtml:()=>c,tickByTickHtml1:()=>y,tickByTickHtml1FullInfo:()=>g,tickByTickHtml2:()=>b});var s=i(609838),r=i(871645);const o=s.t(null,void 0,i(543348)),n=s.t(null,void 0,i(705805)),a=s.t(null,void 0,i(991006)),l=s.t(null,void 0,i(58796)),d=s.t(null,void 0,i(655154)),u=(s.t(null,void 0,i(944138)),s.t(null,void 0,i(994972)),s.t(null,void 0,i(295246)),s.t(null,void 0,i(50035)),s.t(null,void 0,i(619481)),s.t(null,void 0,i(675119)),s.t(null,void 0,i(667607)),s.t(null,void 0,i(484484)),(e,t)=>(0,r.htmlEscape)(s.t(null,{plural:"{symbolName} data is delayed by {time} minutes because of exchange requirements.",count:t,replace:{symbolName:e,time:t.toString()}},i(881227)))),c=(0,r.htmlEscape)(s.t(null,void 0,i(651211))),h=(0,r.htmlEscape)(s.t(null,void 0,i(807281))),p=(0,r.htmlEscape)(s.t(null,void 0,i(920987))),_=(0,r.htmlEscape)(s.t(null,void 0,i(932925))),g=(0,r.htmlEscape)(s.t(null,void 0,i(138368))),y=(0,r.htmlEscape)(s.t(null,void 0,i(833039))),b=(0,r.htmlEscape)(s.t(null,void 0,i(23998))),m=(0,r.htmlEscape)(s.t(null,void 0,i(195400))),v=s.t(null,void 0,i(131539)),f=(s.t(null,{context:'Part of: "Real-time data for {symbolName} is provided by {exchange} exchange."'},i(348473)),s.t(null,{context:'Part of: "Real-time data for {symbolName} is provided by {exchange} exchange."'},i(684455)),s.t(null,void 0,i(624669))),P=s.t(null,void 0,i(352668)),S=s.t(null,void 0,i(344492)),k=(s.t(null,void 0,i(840225)),s.t(null,void 0,i(871847)),s.t(null,void 0,i(439664)),s.t(null,void 0,i(172723)),s.t(null,void 0,i(925608)),s.t(null,void 0,i(733161)),s.t(null,void 0,i(199452)),s.t(null,void 0,i(90589)),s.t(null,void 0,i(443383)),s.t(null,void 0,i(414181)),s.t(null,void 0,i(419679)),s.t(null,void 0,i(284937)),s.t(null,void 0,i(934987)),s.t(null,void 0,i(759269)),s.t(null,void 0,i(801356)),s.t(null,void 0,i(396341)),s.t(null,void 0,i(342457))),C=s.t(null,void 0,i(50277));s.t(null,void 0,i(105888))},190787:(e,t,i)=>{"use strict";function s(e,t){null===e.firstChild?e.textContent=t:e.firstChild.nodeValue=t}i.d(t,{updateTextNode:()=>s})},996038:(e,t,i)=>{"use strict";i.d(t,{DialogBreakpoints:()=>r});var s=i(251284);const r={SmallHeight:s["small-height-breakpoint"],TabletSmall:s["tablet-small-breakpoint"],TabletNormal:s["tablet-normal-breakpoint"]}},533408:(e,t,i)=>{"use strict";i.d(t,{AdaptivePopupDialog:()=>M});var s=i(50959),r=i(650151),o=i(497754),n=i.n(o),a=i(180185),l=i(229144),d=i(698043),u=i(714579),c=i(494707),h=i(996038),p=i(930052),_=i(910549);var g=i(206594),y=i(559410),b=i(609838),m=i(389986),v=i(190410),f=i(174714);function P(e){
const{titleId:t,title:r,titleTextWrap:o=!1,titleClassName:a,subtitle:l,showCloseIcon:d=!0,onClose:u,onCloseButtonKeyDown:c,renderBefore:h,renderAfter:p,draggable:_,className:g,unsetAlign:y,closeAriaLabel:P=b.t(null,void 0,i(47742)),closeButtonReference:S}=e,[k,C]=(0,s.useState)(!1);return s.createElement(v.DialogHeaderContext.Provider,{value:{setHideClose:C}},s.createElement("div",{className:n()(f.container,g,(l||y)&&f.unsetAlign)},h,s.createElement("div",{id:t,className:f.title,"data-dragg-area":_},s.createElement("div",{className:n()(o?f.textWrap:f.ellipsis,a)},r),l&&s.createElement("div",{className:n()(f.ellipsis,f.subtitle)},l)),p,d&&!k&&s.createElement(m.CloseButton,{className:f.close,"data-qa-id":"close","aria-label":P,onClick:u,onKeyDown:c,ref:S,size:"medium",preservePaddings:!0})))}var S=i(273388),k=i(800417),C=i(284170),T=i(534934),w=i(772908);const B={vertical:20},O={vertical:0};class M extends s.PureComponent{constructor(){super(...arguments),this._controller=null,this._reference=null,this._orientationMediaQuery=null,this._embedResizerOverridesEnabled=T.enabled("embed_resizer_overrides"),this._titleId=`title_${(0,C.randomHash)()}`,this._renderChildren=(e,t)=>(this._controller=e,this.props.render({requestResize:this._requestResize,centerAndFit:this._centerAndFit,isSmallWidth:t})),this._handleReference=e=>this._reference=e,this._handleCloseBtnClick=()=>{this.props.onKeyboardClose&&this.props.onKeyboardClose(),this._handleClose()},this._handleClose=()=>{this.props.onClose()},this._handleOpen=()=>{void 0!==this.props.onOpen&&this.props.isOpened&&this.props.onOpen(this.props.fullScreen||window.matchMedia(h.DialogBreakpoints.TabletSmall).matches)},this._handleKeyDown=e=>{if(!e.defaultPrevented){if(this.props.onKeyDown&&this.props.onKeyDown(e),27===(0,a.hashFromEvent)(e)){if(e.defaultPrevented)return;if(this.props.forceCloseOnEsc&&this.props.forceCloseOnEsc())return this.props.onKeyboardClose&&this.props.onKeyboardClose(),void this._handleClose();const{activeElement:i}=document;if(null!==i){if(e.preventDefault(),"true"===(t=i).getAttribute("data-haspopup")&&"true"!==t.getAttribute("data-expanded"))return void this._handleClose();const s=this._reference;if(null!==s&&(0,d.isTextEditingField)(i))return void s.focus();if(s?.contains(i))return this.props.onKeyboardClose&&this.props.onKeyboardClose(),void this._handleClose()}}var t,i;(function(e){if("function"==typeof e)return e();return Boolean(e)})(this.props.disableTabNavigationContainment)||(i=e,[9,a.Modifiers.Shift+9].includes((0,a.hashFromEvent)(i))&&i.stopPropagation())}},this._requestResize=()=>{null!==this._controller&&this._controller.recalculateBounds()},this._centerAndFit=()=>{null!==this._controller&&this._controller.centerAndFit()},this._calculatePositionWithOffsets=(e,t)=>{const i=(0,r.ensureDefined)(this.props.fullScreenViewOffsets).value();return{top:i.top,left:(0,l.isRtl)()?-i.right:i.left,width:t.clientWidth-i.left-i.right,height:t.clientHeight-i.top-i.bottom}}}componentDidMount(){
this.props.ignoreClosePopupsAndDialog||y.subscribe(g.CLOSE_POPUPS_AND_DIALOGS_COMMAND,this._handleClose,null),this._handleOpen(),void 0!==this.props.onOpen&&(this._orientationMediaQuery=window.matchMedia("(orientation: portrait)"),this._orientationMediaQuery.addEventListener("change",this._handleOpen)),this.props.fullScreenViewOffsets&&this.props.fullScreen&&this.props.fullScreenViewOffsets.subscribe(this._requestResize);const{backdrop:e,draggable:t=!e,centerOnResize:i=!t}=this.props;i&&window.addEventListener("resize",this._centerAndFit)}componentWillUnmount(){this.props.ignoreClosePopupsAndDialog||y.unsubscribe(g.CLOSE_POPUPS_AND_DIALOGS_COMMAND,this._handleClose,null),null!==this._orientationMediaQuery&&this._orientationMediaQuery.removeEventListener("change",this._handleOpen),this.props.fullScreenViewOffsets&&this.props.fullScreen&&this.props.fullScreenViewOffsets.unsubscribe(this._requestResize),window.removeEventListener("resize",this._centerAndFit)}focus(){(0,r.ensureNotNull)(this._reference).focus()}getElement(){return this._reference}contains(e){return this._reference?.contains(e)??!1}render(){const{className:e,wrapperClassName:t,headerClassName:i,isOpened:r,title:o,titleTextWrap:a,titleClassName:l,dataName:d,dataQaId:g,onClickOutside:y,onClickBackdrop:b,additionalElementPos:m,additionalHeaderElement:v,backdrop:f,shouldForceFocus:C=!0,shouldReturnFocus:T,onForceFocus:M,showSeparator:E,subtitle:I,draggable:V=!f,fullScreen:$=!1,showCloseIcon:D=!0,rounded:L=!0,isAnimationEnabled:x,growPoint:A,dialogTooltip:q,unsetHeaderAlign:R,onDragStart:F,dataDialogName:N,closeAriaLabel:Q,containerAriaLabel:U,reference:W,containerTabIndex:z,closeButtonReference:j,onCloseButtonKeyDown:H,shadowed:G,fullScreenViewOffsets:K,onClick:Y}=this.props,X=this.props.fixedBody??(!!f||void 0),J="after"!==m?v:void 0,Z="after"===m?v:void 0,ee="string"==typeof o?o:N||"",te=(0,k.filterDataProps)(this.props),ie=(0,S.mergeRefs)([this._handleReference,W]);return s.createElement(p.MatchMedia,{rule:h.DialogBreakpoints.SmallHeight},(m=>s.createElement(p.MatchMedia,{rule:h.DialogBreakpoints.TabletSmall},(h=>s.createElement(u.PopupDialog,{rounded:!(h||$)&&L,className:n()(w.dialog,$&&K&&w.bounded,e),isOpened:r,reference:ie,onKeyDown:this._handleKeyDown,onClickOutside:y,onClickBackdrop:b??y,fullscreen:h||$,guard:m?O:B,boundByScreen:h||$,shouldForceFocus:C,onForceFocus:M,shouldReturnFocus:T,backdrop:f,draggable:V,isAnimationEnabled:x,growPoint:A,name:this.props.dataName,dialogTooltip:q,onDragStart:F,containerAriaLabel:U,containerTabIndex:z,calculateDialogPosition:$&&K?this._calculatePositionWithOffsets:void 0,shadowed:G,fixedBody:X,onClick:Y,...te},s.createElement("div",{role:"dialog","aria-labelledby":void 0!==o?this._titleId:void 0,className:n()(w.wrapper,t),"data-name":d,"data-qa-id":g,"data-dialog-name":ee},void 0!==o&&s.createElement(P,{draggable:V&&!(h||$),onClose:this._handleCloseBtnClick,renderAfter:Z,renderBefore:J,subtitle:I,title:o,titleId:this._titleId,titleTextWrap:a,showCloseIcon:D,className:i,titleClassName:l,unsetAlign:R,closeAriaLabel:Q,
closeButtonReference:j,onCloseButtonKeyDown:H}),E&&s.createElement(c.Separator,{className:w.separator}),s.createElement(_.PopupContext.Consumer,null,(e=>this._renderChildren(e,h||$)))))))))}}},190410:(e,t,i)=>{"use strict";i.d(t,{DialogHeaderContext:()=>s});const s=i(50959).createContext({setHideClose:()=>{}})},910549:(e,t,i)=>{"use strict";i.d(t,{PopupContext:()=>s});const s=i(50959).createContext(null)},714579:(e,t,i)=>{"use strict";i.d(t,{PopupDialog:()=>I});var s,r=i(50959),o=i(497754),n=i(650151),a=i(80137),l=i(874485),d=i(738036),u=i(825850),c=i(32556);function h(e,t,i,s){return e+t>s&&(e=s-t),e<i&&(e=i),e}function p(e){return{x:(0,u.clamp)(e.x,20,document.documentElement.clientWidth-20),y:(0,u.clamp)(e.y,20,window.innerHeight-20)}}function _(e){return{x:e.clientX,y:e.clientY}}function g(e){return{x:e.touches[0].clientX,y:e.touches[0].clientY}}!function(e){e[e.MouseGuardZone=20]="MouseGuardZone"}(s||(s={}));class y{constructor(e,t,i={boundByScreen:!0}){this._drag=null,this._canBeTouchClick=!1,this._frame=null,this._onMouseDragStart=e=>{if(0!==e.button||this._isTargetNoDraggable(e))return;e.preventDefault(),document.addEventListener("mousemove",this._onMouseDragMove),document.addEventListener("mouseup",this._onMouseDragEnd);const t=p(_(e));this._dragStart(t)},this._onTouchDragStart=e=>{if(this._isTargetNoDraggable(e))return;this._canBeTouchClick=!0,e.preventDefault(),this._header.addEventListener("touchmove",this._onTouchDragMove,{passive:!1});const t=p(g(e));this._dragStart(t)},this._onMouseDragEnd=e=>{e.target instanceof Node&&this._header.contains(e.target)&&e.preventDefault(),document.removeEventListener("mousemove",this._onMouseDragMove),document.removeEventListener("mouseup",this._onMouseDragEnd),this._onDragStop()},this._onTouchDragEnd=e=>{this._header.removeEventListener("touchmove",this._onTouchDragMove),this._onDragStop(),this._canBeTouchClick&&(this._canBeTouchClick=!1,function(e){if(e instanceof SVGElement){const t=document.createEvent("SVGEvents");t.initEvent("click",!0,!0),e.dispatchEvent(t)}e instanceof HTMLElement&&e.click()}(e.target))},this._onMouseDragMove=e=>{const t=p(_(e));this._dragMove(t)},this._onTouchDragMove=e=>{this._canBeTouchClick=!1,e.preventDefault();const t=p(g(e));this._dragMove(t)},this._onDragStop=()=>{this._drag=null,this._header.classList.remove("dragging"),this._options.onDragEnd&&this._options.onDragEnd()},this._dialog=e,this._header=t,this._options=i,this._header.addEventListener("mousedown",this._onMouseDragStart),this._header.addEventListener("touchstart",this._onTouchDragStart),this._header.addEventListener("touchend",this._onTouchDragEnd)}destroy(){null!==this._frame&&cancelAnimationFrame(this._frame),this._header.removeEventListener("mousedown",this._onMouseDragStart),document.removeEventListener("mouseup",this._onMouseDragEnd),this._header.removeEventListener("touchstart",this._onTouchDragStart),this._header.removeEventListener("touchend",this._onTouchDragEnd),document.removeEventListener("mouseleave",this._onMouseDragEnd)}updateOptions(e){this._options=e}
_dragStart(e){const t=this._dialog.getBoundingClientRect();this._drag={startX:e.x,startY:e.y,finishX:e.x,finishY:e.y,dialogX:t.left,dialogY:t.top};const i=Math.round(t.left),s=Math.round(t.top);this._dialog.style.transform=`translate(${i}px, ${s}px)`,this._header.classList.add("dragging"),this._options.onDragStart&&this._options.onDragStart()}_dragMove(e){if(this._drag){if(this._drag.finishX=e.x,this._drag.finishY=e.y,null!==this._frame)return;this._frame=requestAnimationFrame((()=>{if(this._drag){const t=e.x-this._drag.startX,i=e.y-this._drag.startY;this._moveDialog(this._drag.dialogX+t,this._drag.dialogY+i)}this._frame=null}))}}_moveDialog(e,t){const i=this._dialog.getBoundingClientRect(),{boundByScreen:s}=this._options,r=h(e,i.width,s?0:-1/0,s?window.innerWidth:1/0),o=h(t,i.height,s?0:-1/0,s?window.innerHeight:1/0);this._dialog.style.transform=`translate(${Math.round(r)}px, ${Math.round(o)}px)`}_isTargetNoDraggable(e){return e.target instanceof Element&&null!==e.target.closest("[data-disable-drag]")}}const b={vertical:0};var m,v=i(8361),f=i(910549),P=i(285089),S=i(671945),k=i(284170);!function(e){e.Open="dialog-open",e.Close="dialog-close",e.FullscreenOn="dialog-fullscreen-on",e.FullscreenOff="dialog-fullscreen-off"}(m||(m={}));const C=(0,S.getLogger)("DialogEventDispatcher");class T{constructor(){this._openSessionId=null}dispatch(e){if("dialog-open"===e){if(null!==this._openSessionId)return void C.logError("Multiple calls to open dialog");this._openSessionId=(0,k.randomHash)()}null!==this._openSessionId?(window.dispatchEvent(new CustomEvent(e,{bubbles:!0,detail:{dialogSessionId:this._openSessionId}})),"dialog-close"===e&&(this._openSessionId=null)):C.logError("Empty open dialog session id")}}var w=i(69111),B=(i(534934),i(615617)),O=i(947156);O["tooltip-offset"];const M=class{constructor(e,t){this._frame=null,this._isFullscreen=!1,this._handleResize=()=>{null===this._frame&&(this._frame=requestAnimationFrame((()=>{this.recalculateBounds(),this._frame=null})))},this._dialog=e,this._guard=t.guard||b,this._calculateDialogPosition=t.calculateDialogPosition,this._initialHeight=e.style.height,window.addEventListener("resize",this._handleResize)}updateOptions(e){this._guard=e.guard||b,this._calculateDialogPosition=e.calculateDialogPosition}setFullscreen(e){this._isFullscreen!==e&&(this._isFullscreen=e,this.recalculateBounds())}centerAndFit(){const{x:e,y:t}=this.getDialogsTopLeftCoordinates(),i=this._calcAvailableHeight(),s=this._calcDialogHeight();if(i===s)if(this._calculateDialogPosition){const{left:e,top:t}=this._calculateDialogPosition(this._dialog,document.documentElement,this._guard);this._dialog.style.transform=`translate(${Math.round(e)}px, ${Math.round(t)}px)`}else this._dialog.style.height=s+"px";this._dialog.style.top="0px",this._dialog.style.left="0px",this._dialog.style.transform=`translate(${e}px, ${t}px)`}getDialogsTopLeftCoordinates(){const{clientWidth:e,clientHeight:t}=this._getClientDimensions(),i=this._calcDialogHeight(),s=e/2-this._dialog.clientWidth/2,r=t/2-i/2+this._getTopOffset();return{
x:Math.round(s),y:Math.round(r)}}recalculateBounds(){const{clientWidth:e,clientHeight:t}=this._getClientDimensions(),{vertical:i}=this._guard,s=this._calculateDialogPosition?.(this._dialog,{clientWidth:e,clientHeight:t},{vertical:i});if(this._isFullscreen){if(this._dialog.style.top="0px",this._dialog.style.left="0px",this._dialog.style.width="100%",this._dialog.style.height="100%",this._dialog.style.transform="none",s){const{left:e,top:t,width:i,height:r}=s;this._dialog.style.transform=`translate(${Math.round(e)}px, ${Math.round(t)}px)`,i&&(this._dialog.style.width=`${i}px`,this._dialog.style.minWidth="unset"),r&&(this._dialog.style.height=`${r}px`,this._dialog.style.minHeight="unset")}}else if(s){const{left:e,top:t}=s;this._dialog.style.transform=`translate(${Math.round(e)}px, ${Math.round(t)}px)`}else{this._dialog.style.width="",this._dialog.style.height="";const s=this._dialog.getBoundingClientRect(),r=t-2*i,o=h(s.left,s.width,0,e),n=h(s.top,s.height,i,t);this._dialog.style.top="0px",this._dialog.style.left="0px",this._dialog.style.transform=`translate(${Math.round(o)}px, ${Math.round(n)}px)`,this._dialog.style.height=r<s.height?r+"px":this._initialHeight}}destroy(){window.removeEventListener("resize",this._handleResize),null!==this._frame&&(cancelAnimationFrame(this._frame),this._frame=null)}_getClientDimensions(){return{clientHeight:document.documentElement.clientHeight,clientWidth:document.documentElement.clientWidth}}_getTopOffset(){return 0}_calcDialogHeight(){const e=this._calcAvailableHeight();return e<this._dialog.clientHeight?e:this._dialog.clientHeight}_calcAvailableHeight(){return this._getClientDimensions().clientHeight-2*this._guard.vertical}};class E extends r.PureComponent{constructor(e){super(e),this._dialog=null,this._cleanUpFunctions=[],this._prevActiveElement=null,this._eventDispatcher=new T,this._handleDialogRef=e=>{const{reference:t}=this.props;this._dialog=e,"function"==typeof t?t(e):null!=t&&(t.current=e)},this._handleFocus=()=>{this._moveToTop()},this._handleMouseDown=e=>{this._moveToTop()},this._handleTouchStart=e=>{this._moveToTop()},this.state={canFitTooltip:!1},this._prevActiveElement=document.activeElement}render(){return r.createElement(f.PopupContext.Provider,{value:this},r.createElement(d.OutsideEvent,{mouseDown:!0,touchStart:!0,handler:this.props.onClickOutside},(e=>r.createElement("div",{ref:e,"data-outside-boundary-for":this.props.name,onFocus:this._handleFocus,onMouseDown:this._handleMouseDown,onTouchStart:this._handleTouchStart,"data-dialog-name":this.props["data-dialog-name"],"data-tooltip-show-on-focus":"true","data-qa-id":(0,B.dataQaIds)("ui-lib-PopupDialog",this.props.dataQaId)},r.createElement(a.Dialog,{style:this._applyAnimationCSSVariables(),...this.props,reference:this._handleDialogRef,className:o(O.dialog,(0,w.isOnMobileAppPage)("any")&&!this.props.noMobileAppShadows&&O.mobile,this.props.fullscreen&&O.fullscreen,this.props.className)},!1,this.props.children)))))}componentDidMount(){const{draggable:e,boundByScreen:t,onDragStart:i}=this.props,s=(0,
n.ensureNotNull)(this._dialog);if(this._eventDispatcher.dispatch("dialog-open"),e){const e=s.querySelector("[data-dragg-area]");if(e&&e instanceof HTMLElement){const r=new y(s,e,{boundByScreen:Boolean(t),onDragStart:i});this._cleanUpFunctions.push((()=>r.destroy())),this._drag=r}}this.props.autofocus&&!s.contains(document.activeElement)&&s.focus(),(this._isFullScreen()||this.props.fixedBody)&&(0,P.setFixedBodyState)(!0);const{guard:r,calculateDialogPosition:o}=this.props;if(this.props.resizeHandler)this._resize=this.props.resizeHandler;else{const e=new M(s,{guard:r,calculateDialogPosition:o});this._cleanUpFunctions.push((()=>e.destroy())),this._resize=e}if(this._isFullScreen()&&this._eventDispatcher.dispatch("dialog-fullscreen-on"),this.props.isAnimationEnabled&&this.props.growPoint&&this._applyAppearanceAnimation(this.props.growPoint),this.props.centeredOnMount&&this._resize.centerAndFit(),this._resize.setFullscreen(this._isFullScreen()),this.props.shouldForceFocus){if(this.props.onForceFocus)return void this.props.onForceFocus(s);s.focus()}if(!s.contains(document.activeElement)){const e=function(e){const t=e.querySelector("[autofocus]:not([disabled])");if(t)return t;if(e.tabIndex>=0)return e;const i=(0,c.getActiveElementSelectors)(),s=Array.from(e.querySelectorAll(i)).filter((0,c.createScopedVisibleElementFilter)(e));let r=Number.NEGATIVE_INFINITY,o=null;for(let e=0;e<s.length;e++){const t=s[e],i=t.getAttribute("tabindex");if(null!==i){const e=parseInt(i,10);!isNaN(e)&&e>r&&(r=e,o=t)}}return o}(s);e instanceof HTMLElement&&e.focus()}}componentDidUpdate(e){const t=e.fullscreen;if(this._resize){const{guard:e,calculateDialogPosition:t}=this.props;this._resize.updateOptions({guard:e,calculateDialogPosition:t}),this._resize.setFullscreen(this._isFullScreen())}if(this._drag&&this._drag.updateOptions({boundByScreen:Boolean(this.props.boundByScreen),onDragStart:this.props.onDragStart}),e.fullscreen!==this.props.fullscreen){const e=this.props.fullscreen;e&&!t?this._eventDispatcher.dispatch("dialog-fullscreen-on"):!e&&t&&this._eventDispatcher.dispatch("dialog-fullscreen-off")}}componentWillUnmount(){if(this.props.shouldReturnFocus&&this._prevActiveElement&&document.body.contains(this._prevActiveElement)&&(null===document.activeElement||document.activeElement===document.body||this._dialog?.contains(document.activeElement)))try{setTimeout((()=>{this._prevActiveElement.focus({preventScroll:!0})}))}catch{}for(const e of this._cleanUpFunctions)e();(this._isFullScreen()||this.props.fixedBody)&&(0,P.setFixedBodyState)(!1),this._isFullScreen()&&this._eventDispatcher.dispatch("dialog-fullscreen-off"),this._eventDispatcher.dispatch("dialog-close")}focus(){this._dialog&&this._dialog.focus()}centerAndFit(){this._resize&&this._resize.centerAndFit()}recalculateBounds(){this._resize&&this._resize.recalculateBounds()}_moveToTop(){this.props.isZIndexFixed||null!==this.context&&this.context.moveToTop()}_applyAnimationCSSVariables(){return{"--animationTranslateStartX":null,"--animationTranslateStartY":null,"--animationTranslateEndX":null,
"--animationTranslateEndY":null}}_applyAppearanceAnimation(e){if(this._resize&&this._dialog){const{x:t,y:i}=e,{x:s,y:r}=this._resize.getDialogsTopLeftCoordinates();this._dialog.style.setProperty("--animationTranslateStartX",`${t}px`),this._dialog.style.setProperty("--animationTranslateStartY",`${i}px`),this._dialog.style.setProperty("--animationTranslateEndX",`${s}px`),this._dialog.style.setProperty("--animationTranslateEndY",`${r}px`),this._dialog.classList.add(O.dialogAnimatedAppearance)}}_handleTooltipFit(){0}_isFullScreen(){return Boolean(this.props.fullscreen)}}E.contextType=v.PortalContext,E.defaultProps={boundByScreen:!0,draggable:!0,centeredOnMount:!0,shouldReturnFocus:!0};const I=(0,l.makeOverlapable)(E,!0)},965800:(e,t,i)=>{"use strict";i.d(t,{useTheme:()=>o});var s=i(297265),r=i(702054);function o(){return(0,s.useWatchedValueReadonly)({watchedValue:r.watchedTheme})}},494707:(e,t,i)=>{"use strict";i.d(t,{Separator:()=>n});var s=i(50959),r=i(497754),o=i(315015);function n(e){return s.createElement("div",{className:r(o.separator,e.className)})}},874485:(e,t,i)=>{"use strict";i.d(t,{makeOverlapable:()=>o});var s=i(50959),r=i(8361);function o(e,t){return class extends s.PureComponent{render(){const{isOpened:i,root:o}=this.props;if(!i)return null;const n=s.createElement(e,{...this.props,ref:this.props.componentRef,zIndex:150});return"parent"===o?n:s.createElement(r.Portal,{shouldTrapFocus:t},n)}}}},132455:(e,t,i)=>{"use strict";i.d(t,{Spinner:()=>s.Spinner});var s=i(672511)},904237:(e,t,i)=>{"use strict";var s=i(632227);t.createRoot=s.createRoot,s.hydrateRoot},265728:(e,t,i)=>{"use strict";i.d(t,{ReplaySubject:()=>n});var s=i(446685),r=i(737538),o=i(712813),n=function(e){function t(t,i,s){void 0===t&&(t=1/0),void 0===i&&(i=1/0),void 0===s&&(s=o.dateTimestampProvider);var r=e.call(this)||this;return r._bufferSize=t,r._windowTime=i,r._timestampProvider=s,r._buffer=[],r._infiniteTimeWindow=!0,r._infiniteTimeWindow=i===1/0,r._bufferSize=Math.max(1,t),r._windowTime=Math.max(1,i),r}return(0,s.__extends)(t,e),t.prototype.next=function(t){var i=this,s=i.isStopped,r=i._buffer,o=i._infiniteTimeWindow,n=i._timestampProvider,a=i._windowTime;s||(r.push(t),!o&&r.push(n.now()+a)),this._trimBuffer(),e.prototype.next.call(this,t)},t.prototype._subscribe=function(e){this._throwIfClosed(),this._trimBuffer();for(var t=this._innerSubscribe(e),i=this._infiniteTimeWindow,s=this._buffer.slice(),r=0;r<s.length&&!e.closed;r+=i?1:2)e.next(s[r]);return this._checkFinalizedStatuses(e),t},t.prototype._trimBuffer=function(){var e=this,t=e._bufferSize,i=e._timestampProvider,s=e._buffer,r=e._infiniteTimeWindow,o=(r?1:2)*t;if(t<1/0&&o<s.length&&s.splice(0,s.length-o),!r){for(var n=i.now(),a=0,l=1;l<s.length&&s[l]<=n;l+=2)a=l;a&&s.splice(0,a+1)}},t}(r.Subject)},749401:(e,t,i)=>{"use strict";i.d(t,{firstValueFrom:()=>o});var s=(0,i(530634).createErrorClass)((function(e){return function(){e(this),this.name="EmptyError",this.message="no elements in sequence"}})),r=i(620210);function o(e,t){var i="object"==typeof t;return new Promise((function(o,n){
var a=new r.SafeSubscriber({next:function(e){o(e),a.unsubscribe()},error:n,complete:function(){i?o(t.defaultValue):n(new s)}});e.subscribe(a)}))}},958261:(e,t,i)=>{"use strict";i.d(t,{combineLatest:()=>g});var s=i(26722),r=Array.isArray,o=Object.getPrototypeOf,n=Object.prototype,a=Object.keys;function l(e){if(1===e.length){var t=e[0];if(r(t))return{args:t,keys:null};if((s=t)&&"object"==typeof s&&o(s)===n){var i=a(t);return{args:i.map((function(e){return t[e]})),keys:i}}}var s;return{args:e,keys:null}}var d=i(476161),u=i(472484),c=i(91034),h=i(595940);var p=i(138966),_=i(72117);function g(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=(0,h.popScheduler)(e),r=(0,h.popResultSelector)(e),o=l(e),n=o.args,a=o.keys;if(0===n.length)return(0,d.from)([],i);var _=new s.Observable(function(e,t,i){void 0===i&&(i=u.identity);return function(s){y(t,(function(){for(var r=e.length,o=new Array(r),n=r,a=r,l=function(r){y(t,(function(){var l=(0,d.from)(e[r],t),u=!1;l.subscribe(new p.OperatorSubscriber(s,(function(e){o[r]=e,u||(u=!0,a--),a||s.next(i(o.slice()))}),(function(){--n||s.complete()})))}),s)},u=0;u<r;u++)l(u)}),s)}}(n,i,a?function(e){return function(e,t){return e.reduce((function(e,i,s){return e[i]=t[s],e}),{})}(a,e)}:u.identity));return r?_.pipe((0,c.mapOneOrManyArgs)(r)):_}function y(e,t,i){e?(0,_.executeSchedule)(i,e,t):t()}},423869:(e,t,i)=>{"use strict";i.d(t,{EMPTY:()=>s});var s=new(i(26722).Observable)((function(e){return e.complete()}))},323002:(e,t,i)=>{"use strict";i.d(t,{merge:()=>l});var s=i(925186),r=i(771035),o=i(423869),n=i(595940),a=i(476161);function l(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=(0,n.popScheduler)(e),l=(0,n.popNumber)(e,1/0),d=e;return d.length?1===d.length?(0,r.innerFrom)(d[0]):(0,s.mergeAll)(l)((0,a.from)(d,i)):o.EMPTY}},586639:(e,t,i)=>{"use strict";i.d(t,{of:()=>o});var s=i(595940),r=i(476161);function o(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=(0,s.popScheduler)(e);return(0,r.from)(e,i)}},218286:(e,t,i)=>{"use strict";i.d(t,{distinctUntilChanged:()=>n});var s=i(472484),r=i(116217),o=i(138966);function n(e,t){return void 0===t&&(t=s.identity),e=null!=e?e:a,(0,r.operate)((function(i,s){var r,n=!0;i.subscribe(new o.OperatorSubscriber(s,(function(i){var o=t(i);!n&&e(r,o)||(n=!1,r=o,s.next(i))})))}))}function a(e,t){return e===t}},169977:(e,t,i)=>{"use strict";i.d(t,{filter:()=>o});var s=i(116217),r=i(138966);function o(e,t){return(0,s.operate)((function(i,s){var o=0;i.subscribe(new r.OperatorSubscriber(s,(function(i){return e.call(t,i,o++)&&s.next(i)})))}))}},312694:(e,t,i)=>{"use strict";i.d(t,{share:()=>d});var s=i(446685),r=i(476161),o=i(346502),n=i(737538),a=i(620210),l=i(116217);function d(e){void 0===e&&(e={});var t=e.connector,i=void 0===t?function(){return new n.Subject}:t,s=e.resetOnError,o=void 0===s||s,d=e.resetOnComplete,c=void 0===d||d,h=e.resetOnRefCountZero,p=void 0===h||h;return function(e){var t=null,s=null,n=null,d=0,h=!1,_=!1,g=function(){null==s||s.unsubscribe(),s=null},y=function(){g(),t=n=null,h=_=!1
},b=function(){var e=t;y(),null==e||e.unsubscribe()};return(0,l.operate)((function(e,l){d++,_||h||g();var m=n=null!=n?n:i();l.add((function(){0!==--d||_||h||(s=u(b,p))})),m.subscribe(l),t||(t=new a.SafeSubscriber({next:function(e){return m.next(e)},error:function(e){_=!0,g(),s=u(y,o,e),m.error(e)},complete:function(){h=!0,g(),s=u(y,c),m.complete()}}),(0,r.from)(e).subscribe(t))}))(e)}}function u(e,t){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];return!0===t?(e(),null):!1===t?null:t.apply(void 0,(0,s.__spreadArray)([],(0,s.__read)(i),!1)).pipe((0,o.take)(1)).subscribe((function(){return e()}))}},173587:(e,t,i)=>{"use strict";i.d(t,{skip:()=>r});var s=i(169977);function r(e){return(0,s.filter)((function(t,i){return e<=i}))}},233064:(e,t,i)=>{"use strict";i.d(t,{switchMap:()=>n});var s=i(771035),r=i(116217),o=i(138966);function n(e,t){return(0,r.operate)((function(i,r){var n=null,a=0,l=!1,d=function(){return l&&!n&&r.complete()};i.subscribe(new o.OperatorSubscriber(r,(function(i){null==n||n.unsubscribe();var l=0,u=a++;(0,s.innerFrom)(e(i,u)).subscribe(n=new o.OperatorSubscriber(r,(function(e){return r.next(t?t(i,e,u,l++):e)}),(function(){n=null,d()})))}),(function(){l=!0,d()})))}))}},346502:(e,t,i)=>{"use strict";i.d(t,{take:()=>n});var s=i(423869),r=i(116217),o=i(138966);function n(e){return e<=0?function(){return s.EMPTY}:(0,r.operate)((function(t,i){var s=0;t.subscribe(new o.OperatorSubscriber(i,(function(t){++s<=e&&(i.next(t),e<=s&&i.complete())})))}))}},712813:(e,t,i)=>{"use strict";i.d(t,{dateTimestampProvider:()=>s});var s={now:function(){return(s.delegate||Date).now()},delegate:void 0}},233465:e=>{e.exports={blockHidden:"blockHidden-e6PF69Df","pane-button":"pane-button-e6PF69Df"}},189369:e=>{e.exports={"css-value-padding":"4px"}},704609:e=>{e.exports={"css-value-padding":"4px",container:"container-hw_3o_pb",informerWrapper:"informerWrapper-hw_3o_pb",notAvailableOnMobile:"notAvailableOnMobile-hw_3o_pb",sellBuyAndPresetsButtonsContainer:"sellBuyAndPresetsButtonsContainer-hw_3o_pb",sellBuyButtonsContainer:"sellBuyButtonsContainer-hw_3o_pb",buttonsWrapper:"buttonsWrapper-hw_3o_pb",column:"column-hw_3o_pb",button:"button-hw_3o_pb",sellButton:"sellButton-hw_3o_pb",buyButton:"buyButton-hw_3o_pb",buttonTextWrapper:"buttonTextWrapper-hw_3o_pb",buttonText:"buttonText-hw_3o_pb",title:"title-hw_3o_pb",withoutBg:"withoutBg-hw_3o_pb",lastCharSup:"lastCharSup-hw_3o_pb",spreadQtyWrapper:"spreadQtyWrapper-hw_3o_pb",spread:"spread-hw_3o_pb",withoutQty:"withoutQty-hw_3o_pb",brokerButton:"brokerButton-hw_3o_pb",qty:"qty-hw_3o_pb",activeQty:"activeQty-hw_3o_pb",loader:"loader-hw_3o_pb",circleLoader:"circleLoader-hw_3o_pb",loading:"loading-hw_3o_pb",brokerButtonIconWrap:"brokerButtonIconWrap-hw_3o_pb",brokerButtonDefault:"brokerButtonDefault-hw_3o_pb"}},642714:e=>{e.exports={tooltip:"tooltip-_XsQMwYk",slText:"slText-_XsQMwYk",tpText:"tpText-_XsQMwYk"}},680757:e=>{e.exports={tabs:"tabs-oqHzGqN1"}},752971:e=>{e.exports={popupWrapper:"popupWrapper-sxxSUmLh"}},21928:e=>{e.exports={
"small-height-breakpoint":"(max-height: 360px)",moreButton:"moreButton-LjodxXHh",header:"header-LjodxXHh",title:"title-LjodxXHh",brokerSelectScreenWrapper:"brokerSelectScreenWrapper-LjodxXHh",mobile:"mobile-LjodxXHh"}},167772:e=>{e.exports={content:"content-iSoiahCU",contentInner:"contentInner-iSoiahCU"}},497560:(e,t,i)=>{"use strict";i.d(t,{reactLoaderRendererCreator:()=>n});var s=i(904237),r=i(50959),o=i(233465);function n(e,t){return(i,n)=>function(e,t,i,n){const a=document.createElement("span"),l=(0,s.createRoot)(a);u(!1);const{className:d}=n??{};return d&&a.classList.add(d),l.render((0,r.createElement)(t,i)),e&&c(e),{toggleVisibility:u,destroy:function(){l.unmount()},mountTo:c};function u(e){a.classList.toggle(o.blockHidden,!e)}function c(e){e.appendChild(a)}}(i,e,t,n)}},903963:(e,t,i)=>{"use strict";i.d(t,{createPointsLoaderRenderer:()=>r});var s=i(234404);const r=(0,i(497560).reactLoaderRendererCreator)(s.Loader,{staticPosition:!0,size:"small"})},175472:(e,t,i)=>{"use strict";i.d(t,{trackingModeIsAvailable:()=>s});const s=i(601227).CheckMobile.any()},502586:(e,t,i)=>{"use strict";i.d(t,{parentPricePercentToPrice:()=>c,pipsToPrice:()=>a,pipsToRiskInCurrency:()=>l,pipsToRiskInPercent:()=>d,priceToParentPricePercent:()=>u,priceToPips:()=>r,riskInCurrencyToPips:()=>o,riskInPercentToPips:()=>n});var s=i(960521);function r(e,t,i,r){return(0,s.Big)(e).minus(t).div(r).div(i).toNumber()}function o(e,t,i,r,o){const n=(0,s.Big)(i).mul(t).mul(o||1);if(n.eq(0))return 0;return(0,s.Big)(e).div(n).mul(r).toNumber()}function n(e,t,i,r,o,n){const a=(0,s.Big)(r).mul(t).mul(n||1).mul(100);if(a.eq(0))return 0;return(0,s.Big)(e).mul(i).div(a).mul(o).toNumber()}function a(e,t,i,r){return(0,s.Big)(i).mul(e).mul(r).plus(t).toNumber()}function l(e,t,i,r,o){return(0,s.Big)(e).mul(i).mul(t).mul(o||1).div(r).toNumber()}function d(e,t,i,r,o,n){return i?(0,s.Big)(e).mul(r).mul(t).mul(n||1).mul(100).div(i).div(o).toNumber():0}function u(e,t,i){if(0===e)return 0;const r=(0,s.Big)(t).minus(e).mul(i).mul(100).div(e).toNumber();return Object.is(r,-0)?0:r}function c(e,t,i){return(0,s.Big)(i).mul(e).mul(t).div(100).add(e).toNumber()}},995379:(e,t,i)=>{"use strict";i.d(t,{BrokerService:()=>o});var s,r=i(650151);!function(e){e.PositionsWatcher="PositionsWatcher",e.TradingNotificationsHandler="TradingNotificationsHandler",e.TradingStat="TradingStat",e.ExecutionsService="ExecutionsService",e.OrdersService="OrdersService",e.PositionsService="PositionsService"}(s||(s={}));class o{constructor(e,t){this._activeBroker=null,this._trading=e,this._serviceName=t,this._trading.onConnectionStatusChange.subscribe(this,this._onStatusChange),this._onStatusChange(this._trading.connectStatus())}destroy(){this.stopService(),this._trading.onConnectionStatusChange.unsubscribeAll(this)}activeBroker(){return this._activeBroker}trading(){return this._trading}_stopService(){this.stopService();const e=(0,r.ensureNotNull)(this._activeBroker,"activeBroker");switch(e.currentAccountUpdate.unsubscribeAll(this),this._serviceName){case"PositionsService":case"PositionsWatcher":
e.positionsFullUpdate.unsubscribe(this,this._restartService),e.individualPositionsFullUpdate.unsubscribe(this,this._restartService);break;case"OrdersService":e.ordersFullUpdate.unsubscribe(this,this._restartService)}}_startService(){this.startService();const e=(0,r.ensureNotNull)(this._activeBroker,"activeBroker");switch(e.currentAccountUpdate.subscribe(this,this._onCurrentAccountUpdate),this._serviceName){case"PositionsService":case"PositionsWatcher":e.positionsFullUpdate.subscribe(this,this._restartService),e.individualPositionsFullUpdate.subscribe(this,this._restartService);break;case"OrdersService":e.ordersFullUpdate.subscribe(this,this._restartService)}}_onStatusChange(e){const t=this._trading.activeBroker();this._activeBroker===t&&1===e||(null!==this._activeBroker&&(this._stopService(),this._activeBroker=null),null!==t&&1===e&&(this._activeBroker=t,this._startService(),this._lastAccountId=t.currentAccount()))}_restartService(){this.stopService(),this.startService()}_onCurrentAccountUpdate(){const e=(0,r.ensureNotNull)(this._activeBroker);this._lastAccountId!==e.currentAccount()&&(this._restartService(),this._lastAccountId=e.currentAccount())}}},950147:(e,t,i)=>{"use strict";i.r(t),i.d(t,{addBroker:()=>Ve,brokersList:()=>$e,createBrokerConnection:()=>Le,getBrokerMetainfo:()=>xe});var s=i(609838),r=i(25043),o=i(298670),n=i(586639),a=i(275734),l=i(534934),d=i(894862),u=i(144421),c=i(627692),h=i(650151);class p{constructor(e){this._objects={},this._started=!1,this._isObjectsRequestActual=!1,this._ordersPromise=null,this._getter=e,this.updateDelegate=new c.Delegate,this.partialUpdateDelegate=new c.Delegate}start(){this._started||(this._started=!0,this._ordersPromise=this._requestObjects())}stop(){this._objects={},this._started=!1,this._ordersPromise=null,this._isObjectsRequestActual=!1}update(e,t){this._started&&(this._isObjectsRequestActual?this._isObjectsRequestActual=!1:(this._objects[e.id]=e,this._onObjectUpdated(e,t)))}partialUpdate(e,t){if(!this._started)return;if(this._isObjectsRequestActual)return void(this._isObjectsRequestActual=!1);let i,s;(0,u.isObject)(e)?(i=e.id,s=e):(i=e,s=(0,h.ensure)(t));const r=this._objects[i];r&&(Object.assign(r,s),this.partialUpdateDelegate.fire(r,s))}fullUpdate(){this._started&&(this._isObjectsRequestActual?this._isObjectsRequestActual=!1:this._ordersPromise=this._requestObjects())}getObjects(){return this._ordersPromise||Promise.resolve(Object.values(this._objects))}_onObjectUpdated(e,t){this.updateDelegate.fire(e,t)}_onAllObjectsUpdated(){this._objectsCache().forEach((e=>this.updateDelegate.fire(e,!0)))}_objectsCache(){return Object.values(this._objects)}async _requestObjects(){let e=[];do{this._isObjectsRequestActual=!0,e=await this._getter()}while(!this._isObjectsRequestActual);var t;return this._objects=(t="id",e.reduce(((e,i)=>(e[i[t]]=i,e)),{})),this._ordersPromise=null,this._isObjectsRequestActual=!1,this._onAllObjectsUpdated(),e}}var _=i(671945),g=i(649008);class y extends p{constructor(e,t){super(e),this._brokerConfigGetter=t}_onObjectUpdated(e,t){
this._patchIndividualPositions(this._objectsCache().filter((t=>t.symbol===e.symbol&&0!==t.qty)),e,t),super._onObjectUpdated(e,t)}_onAllObjectsUpdated(){this._patchIndividualPositions(this._objectsCache().filter((e=>0!==e.qty))),super._onAllObjectsUpdated()}_patchIndividualPositions(e,t,i){const s=this._brokerConfigGetter();let r;r=s.requiresFIFOCloseIndividualPositions?s.fifoOnlyForSameQty?v:m:b;const o=r(e);for(const e of o)t!==e&&super._onObjectUpdated(e,i)}}function b(e){const t=[];for(const i of e)void 0===i.canBeClosed&&(i.canBeClosed=!0,t.push(i));return t}function m(e){const t={};for(const i of e){let e=t[i.symbol];void 0===e&&(e={oldest:null,all:[]},t[i.symbol]=e),(null===e.oldest||e.oldest.date>i.date)&&(e.oldest=i),e.all.push(i)}const i=[];for(const e of Object.keys(t)){const s=(0,h.ensureDefined)(t[e]);for(const e of s.all){const t=s.oldest===e,r=t!==e.canBeClosed;e.canBeClosed=t,r&&i.push(e)}}return i}function v(e){const t={};for(const i of e){let e=t[i.symbol];void 0===e&&(e={},t[i.symbol]=e);let s=e[i.qty];void 0===s&&(s={oldest:null,all:[]},e[i.qty]=s),(null===s.oldest||s.oldest.date>i.date)&&(s.oldest=i),s.all.push(i)}const i=[];for(const e of Object.keys(t)){const s=(0,h.ensureDefined)(t[e]);for(const e of Object.keys(s)){const t=(0,h.ensureDefined)(s[e]);for(const e of t.all){const s=t.oldest===e,r=s!==e.canBeClosed;e.canBeClosed=s,r&&i.push(e)}}}return i}const f=(0,_.getLogger)("Trading.Migrations");var P=i(166554),S=i(871645),k=i(372097),C=i(284170),T=i(17076),w=i(760775),B=i(160471),O=i(739695),M=i(51170);function E(e,t,i){const s={symbol:t.symbol,type:2,side:1===t.side?-1:1,qty:Math.abs(e),seenPrice:null,isClose:!0};return void 0===i?.bid||void 0===i?.ask?s:{...s,currentQuotes:{bid:i.bid,ask:i.ask}}}class I{constructor(){this._validators=new Map}add(e,t){this._validators.set(t,e)}validate(e){const t={};let i=!0;for(const[s,r]of this._validators.entries()){const o=r.validate(e);o.isValid||(i=!1,t[s]=o.error)}return i?{isValid:i}:{isValid:i,errors:t}}}class V{constructor(e,t,i=[]){this._status=O.PlaceOrEditContextStatus.Undefined,this._onStatusChange=new c.Delegate,this._onDataChange=new c.Delegate,this._errors={},this._setData=async(e,t,i,s)=>{const r=await this._processOrderData(t);!0!==e?.aborted&&(this._orderData=r,this._source=i,this._assertOrderIsValid(),s||this._onDataChange.fire())},this._isValidationEnabled=t,this._source=e,this._setData=(0,o.respectLatest)(this._setData),this._validator=new I;for(const{validator:e,validatorName:t}of i)this._validator.add(e,t)}onReady(){return this._onReady}source(){return this._source}data(){return this._orderData}async setData(e,t,i){return this._setData(null,e,t,i)}status(){return this._status}errors(){return this._errors}onStatusChange(){return this._onStatusChange}onDataChange(){return this._onDataChange}async send(e){try{if(this._status===O.PlaceOrEditContextStatus.Error){const e=Object.values(this._errors)[0];return this._processError(e instanceof Error?e:new Error(e)),!1}if(this._status!==O.PlaceOrEditContextStatus.Undefined)return!1
;this._setStatus(O.PlaceOrEditContextStatus.Loading),await this._onReady;const t=await this._processSend(e),i=t?O.PlaceOrEditContextStatus.Sent:O.PlaceOrEditContextStatus.Error;return this._setStatus(i),t}finally{this.destroy()}}destroy(){this._setStatus(O.PlaceOrEditContextStatus.Destroyed)}async preview(){return this._status===O.PlaceOrEditContextStatus.Error?{sections:[]}:(await this._onReady,this._preview(this._orderData))}_assertOrderIsValid(){if(this._status===O.PlaceOrEditContextStatus.Loading)return;const{isValid:e,errors:t}=this._validate();e?(this._errors={},this._setStatus(O.PlaceOrEditContextStatus.Undefined)):(this._errors=t,this._setStatus(O.PlaceOrEditContextStatus.Error))}_setStatus(e){this._status!==e&&(this._status=e,this._onStatusChange.fire())}_validate(){return this._isValidationEnabled?this._validator.validate(this._orderData):{isValid:!0}}}var $=i(769242),D=i(130557);class L{constructor(e){this._stopLimitPercentPriceRuleCheckers=[],this.validate=e=>{const{type:t,side:r,stopPrice:o,limitPrice:n}=e,a=2===this._priceType;if(2===t||a&&1===t||!a&&3===t)return{isValid:!0};const l=a?o:n;if(void 0===l||isNaN(l))return{isValid:!1,error:s.t(null,void 0,i(845542))};const d=(0,w.getPriceStep)({price:l,priceType:this._priceType,minTick:this._minTick,variableMinTickData:this._variableMinTickData,limitPriceStep:this._limitPriceStep,stopPriceStep:this._stopPriceStep}),u=(0,w.roundToStepRequired)({priceType:this._priceType,minTick:this._minTick,limitPriceStep:this._limitPriceStep,stopPriceStep:this._stopPriceStep}),c=(0,w.getQuotePrice)(this._getQuotes(),r),h=(0,$.validatePrice)({price:l,askOrBid:c,orderType:t,side:r,priceType:this._priceType,isForex:"forex"===this._symbolType,formatter:this._formatter,isStatusEditing:this._isStatusEditing,stopLimitPercentPriceRuleCheckers:this._stopLimitPercentPriceRuleCheckers,supportStopOrdersInBothDirections:this._supportStopOrdersInBothDirections,supportStopLimitOrdersInBothDirections:this._supportStopLimitOrdersInBothDirections,supportStrictCheckingLimitOrderPrice:this._supportStrictCheckingLimitOrderPrice,step:d,roundedToStep:u}),p=1===r?"Buy":"Sell",_=1===this._priceType?"Limit":"Stop";return h.res?{isValid:!1,error:new T.UserFriendlyError({userFriendlyMessage:h.msg,detailedErrorMessage:`${h.msg}: side = ${p}, askOrBid = ${c}, price = ${l}, priceType = ${_}`})}:{isValid:!0}};const{priceType:t,quotesGetter:r,formatter:o,instrumentInfo:n,validationRules:a,isStatusEditing:l,supportStopOrdersInBothDirections:d,supportStopLimitOrdersInBothDirections:u,supportStrictCheckingLimitOrderPrice:c}=e;this._priceType=t,this._getQuotes=r,this._formatter=o,this._isStatusEditing=l,this._supportStopOrdersInBothDirections=Boolean(d),this._supportStopLimitOrdersInBothDirections=Boolean(u),this._supportStrictCheckingLimitOrderPrice=Boolean(c),this._symbolType=n.type||"",this._minTick=n.minTick,this._limitPriceStep=n.limitPriceStep,this._stopPriceStep=n.stopPriceStep,this._variableMinTickData=n.variableMinTick?(0,D.makeVariableMinTickData)(this._minTick,n.variableMinTick):void 0
;for(const e of a)this._stopLimitPercentPriceRuleCheckers.push((0,$.makeStopLimitPercentPriceRuleChecker)(e.options.min,e.options.max))}}var x=i(514970);class A{constructor(e){this._quantityMetainfo=e}validate(e){const t=(0,x.checkQtyError)(this._quantityMetainfo,e.qty,!0);return t.res?{isValid:!1,error:t.msg}:{isValid:!0}}}var q=i(960521),R=i(558042);class F{constructor(e){const{instrumentInfo:t,originalOrder:i,quotesGetter:s,baseCurrencyCryptoBalanceGetter:r,quoteCurrencyCryptoBalanceGetter:o}=e;this._originalOrder=i,this._quantityMetainfo=t.qty,this._baseCurrency=t.baseCurrency,this._quoteCurrency=t.quoteCurrency,this._getQuotes=s,this._getBaseCurrencyCryptoBalance=r,this._getQuoteCurrencyCryptoBalance=o}validate(e){const t=(0,x.checkQtyError)(this._quantityMetainfo,e.qty,!0);if(t.res)return{isValid:!1,error:t.msg};const r=(0,w.getOrderPrice)(e,this._getQuotes()),o=this._originalOrder?(0,w.getOrderPrice)(this._originalOrder,this._getQuotes()):void 0,n=e.hasOwnProperty("id");if(void 0===r)return{isValid:!1,error:s.t(null,void 0,i(845542))};const a=this._originalOrder?.qty??e.qty,l=o??r,d=(0,w.getCryptoBalanceValue)({balance:this._getBaseCurrencyCryptoBalance(),side:e.side,isExistingOrder:n,qty:a,orderPrice:l}),u=(0,w.getCryptoBalanceValue)({balance:this._getQuoteCurrencyCryptoBalance(),side:e.side,isExistingOrder:n,qty:a,orderPrice:l}),c=(0,R.validateBalance)({side:e.side,baseValue:e.qty,baseBalanceValue:d,baseCurrency:this._baseCurrency,quoteValue:(0,q.Big)(e.qty).mul(r).toNumber(),quoteBalanceValue:u,quoteCurrency:this._quoteCurrency});return c.res?{isValid:!1,error:c.msg}:{isValid:!0}}}var N=i(91603),Q=i(195321),U=i(502586);class W{constructor(e){this._bracketPercentPriceRuleCheckers=[],this._useValidationAgainstMarket=!1;const{bracketType:t,priceType:i,parentType:s,quotesGetter:r,formatter:o,isStatusEditing:n,instrumentInfo:a,validationRules:l,useValidationAgainstMarket:d=!1,supportMarketBrackets:u=!0,originalBracketPrice:c}=e;if(this._bracketType=t,this._priceType=i,this._parentType=s,this._getQuotes=r,this._formatter=o,this._isStatusEditing=n,this._pipSize=a.pipSize,this._useValidationAgainstMarket=d,this._supportMarketBrackets=u,this._originalBracketPrice=c,this._priceStep=(0,w.getPriceStep)({priceType:i,minTick:a.minTick||a.pipSize,limitPriceStep:a.limitPriceStep,stopPriceStep:a.stopPriceStep}),this._roundToStepRequired=(0,w.roundToStepRequired)({priceType:i,minTick:a.minTick||a.pipSize,limitPriceStep:a.limitPriceStep,stopPriceStep:a.stopPriceStep}),void 0!==l){const e=!1;for(const t of l)this._bracketPercentPriceRuleCheckers.push((0,Q.makeBracketPercentPriceRuleChecker)({minPercent:t.options.min,maxPercent:t.options.max,isExpandedBoundary:e}))}}validate(e){const{side:t,takeProfit:r,stopLoss:o,trailingStopPips:n,guaranteedStop:a,type:l}=e;if(this._bracketType===N.BracketType.TakeProfit&&void 0===r||this._bracketType===N.BracketType.StopLoss&&void 0===o||this._bracketType===N.BracketType.TrailingStop&&void 0===n||this._bracketType===N.BracketType.GuaranteedStop&&void 0===a)return{isValid:!0}
;if(2===l&&!1===this._supportMarketBrackets)return{isValid:!1,error:`${(0,P.getTranslatedBracketName)(this._bracketType)} ${s.t(null,void 0,i(321431))}`};const d=(0,w.getOrderPrice)(e,this._getQuotes());if(void 0===d||isNaN(d))return{isValid:!1,error:s.t(null,void 0,i(675236))};const u=(this._bracketType!==N.BracketType.TakeProfit?-1:1)*t,c=this._getPrice(e,d,u),h=this._getPips(e,d,u),p=(0,Q.checkBracketError)({quotes:this._getQuotes(),side:t,price:c,pips:h,priceType:this._priceType,priceStep:this._priceStep,parentPrice:d,parentType:this._parentType,bracketType:this._bracketType,isStatusEditing:this._isStatusEditing,isEnabled:!0,bracketPercentPriceRuleCheckers:this._bracketPercentPriceRuleCheckers,priceFormatter:this._formatter,isRoundToPriceStep:this._roundToStepRequired,validateAgainstMarket:this._useValidationAgainstMarket,originalBracketPrice:this._originalBracketPrice});return p.res?{isValid:!1,error:p.msg}:{isValid:!0}}_getPrice(e,t,i){switch(this._bracketType){case N.BracketType.TakeProfit:return e.takeProfit??null;case N.BracketType.StopLoss:return e.stopLoss??null;case N.BracketType.TrailingStop:return void 0===e.trailingStopPips?null:(0,U.pipsToPrice)(e.trailingStopPips,t,i,this._pipSize);case N.BracketType.GuaranteedStop:return e.guaranteedStop??null;default:return null}}_getPips(e,t,i){switch(this._bracketType){case N.BracketType.TakeProfit:return void 0===e.takeProfit?null:(0,U.priceToPips)(e.takeProfit,t,i,this._pipSize);case N.BracketType.StopLoss:return void 0===e.stopLoss?null:(0,U.priceToPips)(e.stopLoss,t,i,this._pipSize);case N.BracketType.TrailingStop:return e.trailingStopPips??null;case N.BracketType.GuaranteedStop:return void 0===e.guaranteedStop?null:(0,U.priceToPips)(e.guaranteedStop,t,i,this._pipSize);default:return null}}}class z{constructor(e){const{orderDialogOptions:t}=e;this._orderDialogOptions=t}validate(e){const{customFields:t,type:r}=e;if(void 0===this._orderDialogOptions?.customFields||0===this._orderDialogOptions.customFields.length)return{isValid:!0};const o=[];return this._orderDialogOptions.customFields.forEach((e=>{const i=t?.[e.id];void 0===i&&(0,M.isSupportedField)(e,r)&&o.push(e.title)})),0===o.length?{isValid:!0}:{isValid:!1,error:s.t(null,void 0,i(811195)).format({customFields:o.join(", ")})}}}var j,H,G=i(503503);function K(e,t){let i,s=!1;const r=(0,G.createDeferredPromise)(),o=e=>{s=!0,r.resolve(),i=e,t?.onValueChange?.()},n=e.subscribe(o);!s&&function(e){return void 0!==e&&"immediateDefaultValue"in e}(t)&&o(t.immediateDefaultValue);return{subscription:n,getter:()=>i,ready:r.promise}}class Y extends V{constructor(e){const{orderData:t,source:i,instrumentInfo:s,quotes$:r,configFlags:o,formatter:n,tpValidationRules:a,slValidationRules:l,guaranteedStopValidationRules:u,isValidationEnabled:c,orderDialogOptions:h,callbacks:p,limitOrderRules:_,stopOrderRules:g,isStatusEditing:y,baseCurrencyCryptoBalance$:b,quoteCurrencyCryptoBalance$:m}=e,v={onValueChange:()=>{}},f={...v,immediateDefaultValue:null
},P=Boolean(o.supportCryptoExchangeOrderTicket||o.supportSymbolSpecificCryptoOrderTicket&&"crypto"===s.type),S=Boolean(o.supportValidationAgainstMarket),k=P?f:v,{subscription:C,getter:T,ready:w}=K(r,v),{subscription:B,getter:O,ready:M}=K(b,k),{subscription:E,getter:I,ready:V}=K(m,k),$=P?new F({instrumentInfo:s,quotesGetter:T,baseCurrencyCryptoBalanceGetter:O,quoteCurrencyCryptoBalanceGetter:I}):new A(s.qty);super(i,c,[{validator:$,validatorName:"qty"},{validator:new L({priceType:2,quotesGetter:T,formatter:n,instrumentInfo:s,validationRules:g,isStatusEditing:y,supportStopOrdersInBothDirections:o.supportStopOrdersInBothDirections,supportStopLimitOrdersInBothDirections:o.supportStopLimitOrdersInBothDirections}),validatorName:"stopPrice"},{validator:new L({priceType:1,quotesGetter:T,formatter:n,instrumentInfo:s,validationRules:_,isStatusEditing:y,supportStopOrdersInBothDirections:o.supportStopOrdersInBothDirections,supportStopLimitOrdersInBothDirections:o.supportStopLimitOrdersInBothDirections,supportStrictCheckingLimitOrderPrice:o.supportStrictCheckingLimitOrderPrice}),validatorName:"limitPrice"},{validator:new z({orderDialogOptions:h}),validatorName:"customFields"},{validator:new W({bracketType:d.BracketType.TakeProfit,priceType:1,parentType:1,quotesGetter:T,formatter:n,isStatusEditing:y,instrumentInfo:s,validationRules:a,useValidationAgainstMarket:S}),validatorName:"takeProfit"},{validator:new W({bracketType:d.BracketType.StopLoss,priceType:2,parentType:1,quotesGetter:T,isStatusEditing:y,formatter:n,instrumentInfo:s,validationRules:l,useValidationAgainstMarket:S}),validatorName:"stopLoss"},{validator:new W({bracketType:d.BracketType.TrailingStop,priceType:2,parentType:1,quotesGetter:T,formatter:n,isStatusEditing:y,instrumentInfo:s,validationRules:l,useValidationAgainstMarket:S}),validatorName:"trailingStopPips"},{validator:new W({bracketType:d.BracketType.GuaranteedStop,priceType:2,parentType:1,quotesGetter:T,isStatusEditing:y,formatter:n,instrumentInfo:s,validationRules:u,useValidationAgainstMarket:S}),validatorName:"guaranteedStop"}]),this._quotesSubscription=C,this._quoteCurrencyCryptoBalanceSubscription=E,this._baseCurrencyCryptoBalanceSubscription=B,this._createInitialPreOrder=p.createInitialPreOrder,this._placeOrder=p.placeOrder,this._previewOrder=p.previewOrder,this._handleError=p.handleError;const D=P?[M,V]:[];this._onReady=Promise.all([w,...D]).then((()=>this.setData(t,i))).then((()=>{v.onValueChange=()=>this._assertOrderIsValid()}))}externalContext(){return{type:O.PlaceOrEditContextType.PlaceOrder,source:()=>this.source(),data:()=>this.data(),preview:()=>this.preview(),send:e=>this.send(e),status:()=>this.status(),errors:()=>this.errors()}}destroy(){super.destroy(),this._quotesSubscription.unsubscribe(),this._quoteCurrencyCryptoBalanceSubscription.unsubscribe(),this._baseCurrencyCryptoBalanceSubscription.unsubscribe()}_processSend(e){return this._placeOrder(this._orderData,e)}_processError(e){this._handleError(e)}_processOrderData(e){return this._createInitialPreOrder(e)}_preview(e){
return this._previewOrder(e)}}class X extends V{constructor(e){const{orderData:t,source:i,callbacks:s,configFlags:r,isValidationEnabled:o,instrumentInfo:n,quotes$:a,baseCurrencyCryptoBalance$:l,quoteCurrencyCryptoBalance$:u,stopOrderRules:c,limitOrderRules:h,formatter:p,isStatusEditing:_,orderDialogOptions:g,tpValidationRules:y,slValidationRules:b,guaranteedStopValidationRules:m,originalOrder:v}=e,f={onValueChange:()=>{}},P={...f,immediateDefaultValue:null},S=Boolean(r.supportCryptoExchangeOrderTicket||r.supportSymbolSpecificCryptoOrderTicket&&"crypto"===n.type),k=Boolean(r.supportValidationAgainstMarket),C=S?P:f,{subscription:T,getter:w,ready:B}=K(a,f),{subscription:O,getter:M,ready:E}=K(l,C),{subscription:I,getter:V,ready:$}=K(u,C),D=S?new F({instrumentInfo:n,quotesGetter:w,baseCurrencyCryptoBalanceGetter:M,quoteCurrencyCryptoBalanceGetter:V,originalOrder:v}):new A(n.qty);super(i,o,[{validator:D,validatorName:"qty"},{validator:new L({priceType:2,quotesGetter:w,formatter:p,instrumentInfo:n,validationRules:c,isStatusEditing:_,supportStopOrdersInBothDirections:r.supportStopOrdersInBothDirections,supportStopLimitOrdersInBothDirections:r.supportStopLimitOrdersInBothDirections}),validatorName:"stopPrice"},{validator:new L({priceType:1,quotesGetter:w,formatter:p,instrumentInfo:n,validationRules:h,isStatusEditing:_,supportStopOrdersInBothDirections:r.supportStopOrdersInBothDirections,supportStopLimitOrdersInBothDirections:r.supportStopLimitOrdersInBothDirections,supportStrictCheckingLimitOrderPrice:r.supportStrictCheckingLimitOrderPrice}),validatorName:"limitPrice"},{validator:new z({orderDialogOptions:g}),validatorName:"customFields"},{validator:new W({bracketType:d.BracketType.TakeProfit,priceType:1,parentType:1,quotesGetter:w,formatter:p,isStatusEditing:_,instrumentInfo:n,validationRules:y,useValidationAgainstMarket:k,originalBracketPrice:v.takeProfit}),validatorName:"takeProfit"},{validator:new W({bracketType:d.BracketType.StopLoss,priceType:2,parentType:1,quotesGetter:w,isStatusEditing:_,formatter:p,instrumentInfo:n,validationRules:b,useValidationAgainstMarket:k,originalBracketPrice:v.stopLoss}),validatorName:"stopLoss"},{validator:new W({bracketType:d.BracketType.TrailingStop,priceType:2,parentType:1,quotesGetter:w,formatter:p,isStatusEditing:_,instrumentInfo:n,validationRules:b,useValidationAgainstMarket:k,originalBracketPrice:v.trailingStopPrice}),validatorName:"trailingStopPips"},{validator:new W({bracketType:d.BracketType.GuaranteedStop,priceType:2,parentType:1,quotesGetter:w,isStatusEditing:_,formatter:p,instrumentInfo:n,validationRules:m,useValidationAgainstMarket:k,originalBracketPrice:v.guaranteedStop}),validatorName:"guaranteedStop"}]),this._modifyOrder=s.modifyOrder,this._metainfo=s.metainfo,this._symbolInfo=s.symbolInfo,this._orderById=s.orderById,this._previewOrder=s.previewOrder,this._handleError=s.handleError,this._quotesSubscription=T,this._quoteCurrencyCryptoBalanceSubscription=I,this._baseCurrencyCryptoBalanceSubscription=O;const x=S?[E,$]:[]
;this._onReady=Promise.all([B,...x]).then((()=>this.setData(t,i))).then((()=>{f.onValueChange=()=>this._assertOrderIsValid()}))}externalContext(){return{type:O.PlaceOrEditContextType.EditOrder,source:()=>this.source(),data:()=>this.data(),send:e=>this.send(e),status:()=>this.status(),errors:()=>this.errors(),preview:()=>this.preview()}}destroy(){super.destroy(),this._quotesSubscription.unsubscribe(),this._quoteCurrencyCryptoBalanceSubscription.unsubscribe(),this._baseCurrencyCryptoBalanceSubscription.unsubscribe()}async _processOrderData(e){if(!this._metainfo().configFlags.supportModifyTrailingStop){const t=await this._orderById(e.id);e.hasTrailingStopBracket=void 0!==t&&void 0!==t.trailingStopPips}const{limitPriceStep:t,stopPriceStep:i}=await this._symbolInfo(e.symbol);return e.limitPrice=void 0!==t&&void 0!==e.limitPrice?(0,P.roundToStepByPriceTypeAndSide)(e.limitPrice,t,1,e.side):e.limitPrice,e.stopPrice=void 0!==i&&void 0!==e.stopPrice?(0,P.roundToStepByPriceTypeAndSide)(e.stopPrice,i,2,e.side):e.stopPrice,e}async _processSend(e){return this._modifyOrder(this._orderData,e)}_processError(e){this._handleError(e)}_preview(e){return this._previewOrder({...e,seenPrice:null})}_configureValidator(){}}class J extends V{constructor(e){const{positionData:t,source:i,callbacks:s,configFlags:r,isValidationEnabled:o,instrumentInfo:n,quotes$:a,formatter:l,isStatusEditing:u,tpValidationRules:c,slValidationRules:h,guaranteedStopValidationRules:p,originalPosition:_}=e,g={onValueChange:()=>{}},y=Boolean(r.supportValidationAgainstMarket),{subscription:b,getter:m,ready:v}=K(a,g);super(i,o,[{validator:new W({bracketType:d.BracketType.TakeProfit,priceType:1,parentType:2,quotesGetter:m,formatter:l,isStatusEditing:u,instrumentInfo:n,validationRules:c,useValidationAgainstMarket:y,originalBracketPrice:_.takeProfit}),validatorName:"takeProfit"},{validator:new W({bracketType:d.BracketType.StopLoss,priceType:2,parentType:2,quotesGetter:m,isStatusEditing:u,formatter:l,instrumentInfo:n,validationRules:h,useValidationAgainstMarket:y,originalBracketPrice:_.stopLoss}),validatorName:"stopLoss"},{validator:new W({bracketType:d.BracketType.TrailingStop,priceType:2,parentType:2,quotesGetter:m,formatter:l,isStatusEditing:u,instrumentInfo:n,validationRules:h,useValidationAgainstMarket:y,originalBracketPrice:_.trailingStopPrice}),validatorName:"trailingStopPips"},{validator:new W({bracketType:d.BracketType.GuaranteedStop,priceType:2,parentType:2,quotesGetter:m,isStatusEditing:u,formatter:l,instrumentInfo:n,validationRules:p,useValidationAgainstMarket:y,originalBracketPrice:_.guaranteedStop}),validatorName:"guaranteedStop"}]),this._editPositionBrackets=s.editPositionBrackets,this._handleError=s.handleError,this._quotesSubscription=b,this._onReady=Promise.all([v]).then((()=>this.setData(t,i))).then((()=>{g.onValueChange=()=>this._assertOrderIsValid()}))}externalContext(){return{type:O.PlaceOrEditContextType.EditPosition,source:()=>this.source(),data:()=>this.data(),send:()=>this.send(),status:()=>this.status(),errors:()=>this.errors(),
preview:()=>this.preview()}}destroy(){super.destroy(),this._quotesSubscription.unsubscribe()}async _processOrderData(e){return e}async _processSend(e){const{id:t,stopLoss:i,trailingStopPips:s,guaranteedStop:r,takeProfit:o}=this._orderData;return this._editPositionBrackets(t,{stopLoss:i,trailingStopPips:s,guaranteedStop:r,takeProfit:o})}async _preview(e){throw new Error("Not implemented")}_processError(e){this._handleError(e)}_configureValidator(){}}class Z extends V{constructor(e){const{individualPositionData:t,source:i,callbacks:s,configFlags:r,isValidationEnabled:o,instrumentInfo:n,quotes$:a,formatter:l,isStatusEditing:d,tpValidationRules:u,slValidationRules:c,guaranteedStopValidationRules:h,originalIndividualPosition:p}=e,_={onValueChange:()=>{}},g=Boolean(r.supportValidationAgainstMarket),{subscription:y,getter:b,ready:m}=K(a,_);super(i,o,[{validator:new W({bracketType:N.BracketType.TakeProfit,priceType:1,parentType:3,quotesGetter:b,formatter:l,isStatusEditing:d,instrumentInfo:n,validationRules:u,useValidationAgainstMarket:g,originalBracketPrice:p.takeProfit}),validatorName:"takeProfit"},{validator:new W({bracketType:N.BracketType.StopLoss,priceType:2,parentType:3,quotesGetter:b,isStatusEditing:d,formatter:l,instrumentInfo:n,validationRules:c,useValidationAgainstMarket:g,originalBracketPrice:p.stopLoss}),validatorName:"stopLoss"},{validator:new W({bracketType:N.BracketType.TrailingStop,priceType:2,parentType:3,quotesGetter:b,formatter:l,isStatusEditing:d,instrumentInfo:n,validationRules:c,useValidationAgainstMarket:g,originalBracketPrice:p.trailingStopPrice}),validatorName:"trailingStopPips"},{validator:new W({bracketType:N.BracketType.GuaranteedStop,priceType:2,parentType:3,quotesGetter:b,isStatusEditing:d,formatter:l,instrumentInfo:n,validationRules:h,useValidationAgainstMarket:g,originalBracketPrice:p.guaranteedStop}),validatorName:"guaranteedStop"}]),this._editIndividualPositionBrackets=s.editIndividualPositionBrackets,this._handleError=s.handleError,this._quotesSubscription=y,this._onReady=Promise.all([m]).then((()=>this.setData(t,i))).then((()=>{_.onValueChange=()=>this._assertOrderIsValid()}))}externalContext(){return{type:O.PlaceOrEditContextType.EditIndividualPosition,source:()=>this.source(),data:()=>this.data(),send:()=>this.send(),status:()=>this.status(),errors:()=>this.errors(),preview:()=>this.preview()}}destroy(){super.destroy(),this._quotesSubscription.unsubscribe()}async _processOrderData(e){return e}async _processSend(e){const{id:t,stopLoss:i,trailingStopPips:s,guaranteedStop:r,takeProfit:o}=this._orderData;return this._editIndividualPositionBrackets(t,{stopLoss:i,trailingStopPips:s,guaranteedStop:r,takeProfit:o})}async _preview(e){throw new Error("Not implemented")}_processError(e){this._handleError(e)}_configureValidator(){}}!function(e){e[e.ConnectingTimeLimit=6e4]="ConnectingTimeLimit",e[e.OAuthConnectingTimeLimit=3e5]="OAuthConnectingTimeLimit",e[e.ResolveTimeLimit=1e4]="ResolveTimeLimit",e[e.PositionReverseTimeLimit=3e4]="PositionReverseTimeLimit",
e[e.PositionCloseTimeLimit=3e4]="PositionCloseTimeLimit",e[e.ModifyTimeLimit=3e4]="ModifyTimeLimit"}(j||(j={})),function(e){e[e.Unknown=0]="Unknown",e[e.BrokerRealtimeProvider=1]="BrokerRealtimeProvider",e[e.Broker=2]="Broker"}(H||(H={}));const ee=(0,_.getLogger)("Trading.BrokerConnectionAdapter"),te=s.t(null,void 0,i(834737)),ie=s.t(null,void 0,i(628412));function se(e){(0,h.assert)("object"!=typeof e,"Expected not an object")}const re=[1,2,3,4];class oe{constructor({brokerMetainfo:e,brokerConnection:t,host:r,brokerRealtimeAdapter:o,tradingStat:n,tradingSettingsStorageGetter:a,brokerPlan:l}){this.connectionStatusUpdate=new c.Delegate,this.executionUpdate=new c.Delegate,this.tradingOperationFinished=new c.Delegate,this.currentAccountUpdate=new c.Delegate,this.ordersFullUpdate=new c.Delegate,this.positionsFullUpdate=new c.Delegate,this.individualPositionsFullUpdate=new c.Delegate,this._brokerPlan=null,this._subscriptions={},this._lastFireResult={},this._fakeDOMSubscriptions={},this._formattersCache={},this._spreadFormattersCache={},this._quantityFormattersCache={},this._individualPositionsCache=null,this._fakePositionUpdateDelegate=null,this._realtimeSubscriptionState=[],this._loggedInManually=!1,this._pendingSubscriptions=[],this._sessionId=(0,C.guid)(),this.createAccount=e=>{if(this.config.supportCreateAccount&&this._brokerConnection.createAccount)return this._brokerConnection.createAccount(e);throw new Error("Method createAccount is not implemented")},this.accountSettingsInfo=e=>{if((this.config.supportCreateAccount||this.config.supportResetAccount||this.config.supportChangeAccountSettings)&&this._brokerConnection.accountSettingsInfo)return this._brokerConnection.accountSettingsInfo(e);throw new Error("Method accountSettingsInfo is not implemented")},this.resetAccount=e=>{if(this.config.supportResetAccount&&this._brokerConnection.resetAccount)return this._brokerConnection.resetAccount(e);throw new Error("Method resetAccount is not implemented")},this.changeAccountSettings=e=>{if(this.config.supportChangeAccountSettings&&this._brokerConnection.changeAccountSettings)return this._brokerConnection.changeAccountSettings(e);throw new Error("Method changeAccountSettings is not implemented")},this.deleteAccount=e=>{if(this.config.supportDeleteAccount&&this._brokerConnection.deleteAccount)return this._brokerConnection.deleteAccount(e);throw new Error("Method deleteAccount is not implemented")},this.leverageInfo=e=>{if(this.config.supportLeverage&&this._brokerConnection.leverageInfo)return this._brokerConnection.leverageInfo(e);throw new Error("Method leverage is not implemented")},this.setLeverage=e=>{if(this.config.supportLeverage&&this._brokerConnection.setLeverage)return this._brokerConnection.setLeverage(e);throw new Error("Method setLeverage is not implemented")},this.previewLeverage=e=>{if(this.config.supportLeverage&&this._brokerConnection.previewLeverage)return this._brokerConnection.previewLeverage(e);throw new Error("Method previewLeverage is not implemented")},this.maintenanceStatus=async()=>{try{
return void 0!==this._brokerConnection.maintenanceStatus?await this._brokerConnection.maintenanceStatus():{isMaintenance:!1}}catch(e){return this._brokerLogger.logError(`Failed to fetch maintenance status: ${(0,T.getLoggerMessage)(e)}`),{isMaintenance:!0,message:s.t(null,{replace:{brokerName:this._brokerMetainfo.title}},i(136106))}}},this._handleStatusChange=e=>{1!==e&&this._placeOrderContextWithMetaInfo?.context.destroy()},this.config=Object.assign({},e.configFlags),this._brokerMetainfo=this._patchMetainfo(e),this._brokerPlan=l||null,this._brokerConnection=t,this._host=r,this._tradingStat=n,this._getTradingSettingsStorage=a,this._brokerLogger=(0,_.getLogger)("Trading."+this._brokerMetainfo.id+".Connection"),r.setBrokerConnectionAdapter(this),this._initializeConnectProtection(),this._positionsCache=t.positions?new p((()=>t.positions?t.positions():Promise.resolve([]))):null,this._individualPositionsCache=t.individualPositions?new y((()=>t.individualPositions?t.individualPositions():Promise.resolve([])),(()=>this.config)):null,this._ordersCache=new p((()=>t.orders()));const d=e=>{1===e?(null!==this._positionsCache&&this._positionsCache.start(),this._ordersCache.start(),this._individualPositionsCache&&this._individualPositionsCache.start()):(null!==this._positionsCache&&this._positionsCache.stop(),this._ordersCache.stop(),this._individualPositionsCache&&this._individualPositionsCache.stop())};this.connectionStatusUpdate.subscribe(null,d),d(this.connectionStatus()),this.connectionStatusUpdate.subscribe(null,this._handleStatusChange),this._originalDOMSubscriptionMethods={subscribeDOM:t.subscribeDOM,unsubscribeDOM:t.unsubscribeDOM},this._patchBrokerSubscribeUnsubscribeDOMMethods(),this.connectionStatusUpdate.subscribe(null,(e=>{1===e&&this._patchBrokerSubscribeUnsubscribeDOMMethods()})),e.configFlags.supportPositions||(this._fakePositionUpdateDelegate=new c.Delegate),this._brokerRealtimeAdapter=o}tryRestoreSession(){if(this._brokerConnection.tryRestoreSession)return this._brokerConnection.tryRestoreSession()}get orderUpdate(){return this._ordersCache.updateDelegate}get positionUpdate(){return null===this._fakePositionUpdateDelegate?(0,h.ensure)(this._positionsCache).updateDelegate:this._fakePositionUpdateDelegate}get individualPositionUpdate(){return(0,h.ensure)(this._individualPositionsCache).updateDelegate}get orderPartialUpdate(){return this._ordersCache.partialUpdateDelegate}get positionPartialUpdate(){return null===this._fakePositionUpdateDelegate?(0,h.ensure)(this._positionsCache).partialUpdateDelegate:this._fakePositionUpdateDelegate}get individualPositionPartialUpdate(){return(0,h.ensure)(this._individualPositionsCache).partialUpdateDelegate}onOrderUpdate(e){this._ordersCache.update(e)}onOrdersFullUpdate(){this._ordersCache.fullUpdate(),this.ordersFullUpdate.fire()}onOrderPartialUpdate(e,t){this._ordersCache.partialUpdate(e,t)}onPositionUpdate(e,t){if((0,h.assert)(!!this.config.supportPositions,"Broker doesn`t support positions"),0===e.qty){const t=this._lastFireResult[e.id];t&&delete t.PL}(0,
h.ensure)(this._positionsCache).update(e,t)}onPositionsFullUpdate(){(0,h.assert)(!!this.config.supportPositions,"Broker doesn`t support positions"),this._positionsCache?.fullUpdate(),this.positionsFullUpdate.fire()}onPositionPartialUpdate(e,t){(0,h.assert)(!!this.config.supportPositions,"Broker doesn`t support positions"),(0,h.ensure)(this._positionsCache).partialUpdate(e,t)}onIndividualPositionUpdate(e,t){if((0,h.assert)(!!this.config.supportPositionNetting,"Broker doesn`t support individual positions"),0===e.qty){const t=this._lastFireResult[e.symbol];t&&delete t.IndividualPositionPL}(0,h.ensure)(this._individualPositionsCache).update(e,t)}onIndividualPositionPartialUpdate(e,t){(0,h.ensure)(this._individualPositionsCache).partialUpdate(e,t)}onIndividualPositionsFullUpdate(){(0,h.assert)(!!this.config.supportPositionNetting,"Broker doesn`t support individual positions"),this._individualPositionsCache?.fullUpdate(),this.individualPositionsFullUpdate.fire()}onCurrentAccountChanged(){null!==this._positionsCache&&this._positionsCache.fullUpdate(),this._ordersCache.fullUpdate(),this._individualPositionsCache&&this._individualPositionsCache.fullUpdate();const e=this.currentAccount();this.currentAccountUpdate.fire(e)}patchConfig(e){var t;!(t=e).hasOwnProperty("supportBrackets")||t.hasOwnProperty("supportOrderBrackets")||t.hasOwnProperty("supportPositionBrackets")||(f.logWarn("supportBrackets is deprecated. Use supportOrderBrackets and supportPositionBrackets instead."),t.supportOrderBrackets=t.supportBrackets,t.supportPositionBrackets=t.supportBrackets),t.hasOwnProperty("supportModifyOrder")&&(f.logWarn("supportModifyOrder is deprecated. Use supportModifyOrderPrice, supportEditAmount and supportModifyBrackets instead."),t.supportModifyOrderPrice=t.supportModifyOrder,t.supportEditAmount=t.supportModifyOrder,t.supportModifyBrackets=t.supportModifyOrder),Object.assign(this.config,e),Object.assign(this._brokerMetainfo.configFlags,e),this._brokerMetainfo=this._patchMetainfo(this._brokerMetainfo),this._updateConfigDependentProperties()}async getOrderDialogOptions(e){if(void 0!==this._brokerConnection.getOrderDialogOptions)try{return await this._brokerConnection.getOrderDialogOptions(e)}catch(e){return void this._brokerLogger.logError(`Failed to fetch options for the order dialog: ${(0,T.getLoggerMessage)(e)}`)}}async getPositionDialogOptions(e){try{return await(this._brokerConnection.getPositionDialogOptions?.(e))}catch(e){return void this._brokerLogger.logError(`Failed to fetch options for the position dialog: ${(0,T.getLoggerMessage)(e)}`)}}async getSymbolSpecificTradingOptions(e){try{const{allowedDurations:t,allowedOrderTypes:i}=await this.symbolInfo(e),{supportOrderBrackets:s,supportPositionBrackets:r,supportIndividualPositionBrackets:o,supportReversePosition:n,supportModifyBrackets:a,supportAddBracketsToExistingOrder:l,supportModifyPositionBrackets:d,supportModifyOrderBrackets:u,supportRiskControlsAndInfo:c}=this._brokerMetainfo.configFlags;return{allowedDurations:t,allowedOrderTypes:i,supportOrderBrackets:s,
supportPositionBrackets:r,supportIndividualPositionBrackets:o,supportReversePosition:n,supportModifyBrackets:a,supportAddBracketsToExistingOrder:l,supportModifyPositionBrackets:d,supportModifyOrderBrackets:u,supportBracketsInPips:!0,supportRiskControlsAndInfo:c,...await(this._brokerConnection.getSymbolSpecificTradingOptions?.(e))}}catch(e){return void this._brokerLogger.logWarn((0,T.getLoggerMessage)(e))}}async getValidationRules(e){return void 0!==this._brokerConnection.getValidationRules?this._brokerConnection.getValidationRules(e):void 0}chartContextMenuActions(e,t){return this._brokerConnection.chartContextMenuActions(e,t)}buttonDropdownActions(){return this._host.buttonDropdownActions()}connectionStatus(){if(this._brokerConnection.connectionStatus){const e=this._brokerConnection.connectionStatus();if(function(e){return re.includes(e)}(e))return e;throw new Error("Method connectionStatus is not properly implemented - Invalid returned value")}throw new Error("Method connectionStatus is not properly implemented")}isConnected(){return 1===this._brokerConnection.connectionStatus()}signIn(e,t,i,s){const r=""===e.trim()?"Attempting to log in user":`Attempting to log in with username: ${e}`;return this._brokerLogger.logNormal(r),this._loggedInManually=!0,this._brokerConnection.signIn(e,t,i,s)}loggedInManually(){return this._loggedInManually}disconnect(e=!1){try{return this._brokerConnection.disconnect(e)}catch{ee.logWarn("Failed to disconnect")}}currentAccount(){return this._brokerConnection.currentAccount?this._brokerConnection.currentAccount():""}currentAccountType(){return this._brokerConnection.currentAccountType?this._brokerConnection.currentAccountType():void 0}checkUserHasLiveAccount(){return void 0!==this._brokerConnection.checkUserHasLiveAccount?this._brokerConnection.checkUserHasLiveAccount():this.currentAccountType()===d.AccountType.Live}metainfo(){return this._brokerMetainfo}brokerPlan(){return this._brokerPlan}bro(){return this._brokerConnection}fireSubscription(e,t,i,s){if(void 0===this._lastFireResult[t]&&(this._lastFireResult[t]={Realtime:null,PL:null,Equity:null,DOM:null,IndividualPositionPL:null,PipValue:null,MarginAvailable:null,CryptoBalance:null}),(0,h.ensure)(this._lastFireResult[t])[e]={data:i,time:Date.now()},void 0===this._subscriptions[t])return;const r=(0,h.ensure)(this._subscriptions[t]);(0,h.ensure)(r[e]).forEach((e=>e(t,i,s)))}positions(e){return this.config.supportPositions?(this._makeSureBrokerIsConnected(),this._positions().then((t=>t.filter((t=>void 0===e||t.symbol===e))))):Promise.resolve([])}disconnectWarningMessage(){return this._brokerConnection.disconnectWarningMessage?this._brokerConnection.disconnectWarningMessage():null}connectWarningMessages(){return this._brokerConnection.connectWarningMessages?this._brokerConnection.connectWarningMessages():null}individualPositions(e){return this._makeSureBrokerIsConnected(),(0,h.assert)(!!this.config.supportPositionNetting,"Broker doesn`t support individual positions"),
this._individualPositions().then((t=>t.filter((t=>void 0===e||t.symbol===e))))}positionById(e){return this._brokerConnection.positionById?this._brokerConnection.positionById(e):this.positions().then((t=>t.find((t=>t.id===e))))}individualPositionById(e){return(0,h.assert)(!!this.config.supportPositionNetting,"Broker doesn`t support individual positions"),this.individualPositions().then((t=>t.find((t=>t.id===e))))}orders(e){return this._makeSureBrokerIsConnected(),this._orders().then((t=>t.filter((t=>void 0===e||t.symbol===e))))}ordersHistory(){return this._makeSureBrokerIsConnected(),this.config.supportOrdersHistory&&this._brokerConnection.ordersHistory?this._brokerConnection.ordersHistory():Promise.resolve([])}async executions(e){return this.config.supportExecutions?(this._makeSureBrokerIsConnected(),this._brokerConnection.executions(e)):[]}async allExecutions(){return void 0===this._brokerConnection.allExecutions?[]:this._brokerConnection.allExecutions()}orderById(e){return this._makeSureBrokerIsConnected(),this._brokerConnection.orders().then((t=>t.find((t=>t.id===e))))}accountManagerInfo(){return this._brokerConnection.accountManagerInfo()}isTradable(e){return this._makeSureBrokerIsConnected(),this._brokerConnection.isTradable(e).then((t=>("object"!=typeof t&&(t={tradable:t}),t.tradable||void 0!==t.reason||(t.reason=(0,P.makeNonTradableSymbolText)((0,S.htmlEscape)(e),this._brokerMetainfo.title)),t)))}formatter(e,t=!0){return this._makeSureBrokerIsConnected(),this._formattersCache[e]||(this._formattersCache[e]=this._brokerConnection.formatter&&this._brokerConnection.formatter(e,t)||this._host.defaultFormatter(e,t)),(0,g.makeTimeLimited)(this._formattersCache[e],1e4,"formatter not received")}spreadFormatter(e){return this._makeSureBrokerIsConnected(),this._spreadFormattersCache[e]||(this._spreadFormattersCache[e]=this._brokerConnection.spreadFormatter&&this._brokerConnection.spreadFormatter(e)||this._host.defaultFormatter(e,!1)),(0,g.makeTimeLimited)(this._spreadFormattersCache[e],1e4,"spreadFormatter not received")}quantityFormatter(e){return this._makeSureBrokerIsConnected(),this._quantityFormattersCache[e]||(this._quantityFormattersCache[e]=this._brokerConnection.quantityFormatter&&this._brokerConnection.quantityFormatter(e)||this._host.quantityFormatter()),(0,g.makeTimeLimited)(this._quantityFormattersCache[e],1e4,"quantityFormatter not received")}async createInitialPreOrder(e){const[t,i]=await Promise.all([this.getOrderDialogOptions(e.symbol),this.symbolInfo(e.symbol)]);return this._createInitialPreOrder(e,i,t)}async createPlaceOrderContext(e){const{order:t,source:i,isDisposable:s,isValidationEnabled:r,silent:n,signal:a=null}=e;if(s)return this._createPlaceOrderContext(e);const l=this._placeOrderContextWithMetaInfo;if(void 0!==l&&l.context.status()!==O.PlaceOrEditContextStatus.Destroyed&&l.context.data().symbol===t.symbol&&l.isValidationEnabled===r)return await l.context.setData(t,i,n),l.context;this._placeOrderContextWithMetaInfo?.context.destroy();const d=await this._createPlaceOrderContext(e)
;if(a?.aborted)throw d.destroy(),(0,o.createAbortError)();return l===this._placeOrderContextWithMetaInfo&&(this._placeOrderContextWithMetaInfo={context:d,isValidationEnabled:r}),d}async createEditOrderContext(e){const{order:t,source:i,isDisposable:s,isValidationEnabled:r,silent:n,signal:a=null}=e;if(s)return this._createEditOrderContext(e);const l=this._editOrderContextWithMetaInfo;if(void 0!==l&&l.context.status()!==O.PlaceOrEditContextStatus.Destroyed&&l.context.data().id===t.id&&l.isValidationEnabled===r)return await l.context.setData(t,i,n),l.context;this._editOrderContextWithMetaInfo?.context.destroy();const d=await this._createEditOrderContext(e);if(a?.aborted)throw d.destroy(),(0,o.createAbortError)();return l===this._editOrderContextWithMetaInfo&&(this._editOrderContextWithMetaInfo={context:d,isValidationEnabled:r}),d}async createEditPositionContext(e){const{isDisposable:t,position:i,isValidationEnabled:s,source:r,silent:n,signal:a}=e;if(t)return this._createEditPositionContext(e);const l=this._editPositionContextWithMetainfo;if(void 0!==l&&l.context.status()!==O.PlaceOrEditContextStatus.Destroyed&&l.context.data().id===i.id&&l.isValidationEnabled===s)return await l.context.setData(i,r,n),l.context;this._editPositionContextWithMetainfo?.context.destroy();const d=await this._createEditPositionContext(e);if(a?.aborted)throw d.destroy(),(0,o.createAbortError)();return l===this._editPositionContextWithMetainfo&&(this._editPositionContextWithMetainfo={context:d,isValidationEnabled:s}),d}async createEditIndividualPositionContext(e){const{isDisposable:t,position:i,isValidationEnabled:s,source:r,silent:n,signal:a}=e;if(t)return this._createEditIndividualPositionContext(e);const l=this._editIndividualPositionContextWithMetainfo;if(void 0!==l&&l.context.status()!==O.PlaceOrEditContextStatus.Destroyed&&l.context.data().id===i.id&&l.isValidationEnabled===s)return await l.context.setData(i,r,n),l.context;this._editIndividualPositionContextWithMetainfo?.context.destroy();const d=await this._createEditIndividualPositionContext(e);if(a?.aborted)throw d.destroy(),(0,o.createAbortError)();return l===this._editIndividualPositionContextWithMetainfo&&(this._editIndividualPositionContextWithMetainfo={context:d,isValidationEnabled:s}),d}placeOrder(e,t){return this._placeOrder(e,t)}previewOrder(e){return this._previewOrder(e)}previewClosePosition(e,t,i){if(void 0===this._brokerConnection.previewClosePosition)throw new Error("Close position preview is not supported");return this._brokerConnection.previewClosePosition(e,t,i)}modifyOrder(e,t){return this._modifyOrder(e,t)}cancelOrder(e){return se(e),this._makeSureBrokerIsConnected(),this.processErrors(this._brokerConnection.cancelOrder(e),!0,s.t(null,void 0,i(919116)))}cancelOrders(e,t,r){return this._makeSureBrokerIsConnected(),this._brokerConnection.cancelOrders?this.processErrors(this._brokerConnection.cancelOrders(e,t,r),!0,s.t(null,void 0,i(759469))):this.processErrors(Promise.reject("`cancelOrders` method is not implemented in your broker."),!1)}async closePosition(e,t,i){let s
;se(e),this._makeSureBrokerIsConnected(),(0,h.assert)(void 0===t||!!this.config.supportPartialClosePosition,"Broker doesn`t support partial position closing");const r=new Promise((async(r,o)=>{try{const o=await this._positionCopyById(e);s=e=>{void 0!==o&&e.id===o.id&&e.symbol===o.symbol&&e.qty!==o.qty&&(this.positionUpdate.unsubscribe(this,s),r(!0))},this.positionUpdate.subscribe(this,s),await this._closePosition(e,t,i)}catch(e){o(e)}}));return(0,g.makeTimeLimited)(r,3e4,"Position closing timeout").catch((e=>(this._brokerLogger.logError(`${te}: ${(0,T.getLoggerMessage)(e)}`),this.positionUpdate.unsubscribe(this,s),!1)))}async closeIndividualPosition(e,t,r){se(e),this._makeSureBrokerIsConnected(),(0,h.assert)(!!this.config.supportPositionNetting,"Broker doesn`t support individual positions"),(0,h.assert)(void 0===t||(this.config.supportPartialCloseIndividualPosition??!1),"Broker doesn`t support partial individual position closing");const o=(0,h.ensureDefined)(await this.individualPositionById(e));if(0===o.qty)return this._host.showNotification(s.t(null,void 0,i(139924)),s.t(null,void 0,i(445863)),0),!1;if(void 0===t||t<=Math.abs(o.qty)){if(this._brokerConnection.closeIndividualPosition){const i=E(t??Math.abs(o.qty),o);return this.processErrors(this._brokerConnection.closeIndividualPosition(e,t,r),!0,te,(()=>(0,h.ensureNotNull)(this._tradingStat).trackOrderPlaced({order:i})))}throw new Error("Method closeIndividualPosition is not implemented")}return this._host.showNotification(s.t(null,void 0,i(139924)),s.t(null,void 0,i(819189)),0),!1}reversePosition(e){if(se(e),this._makeSureBrokerIsConnected(),this.config.supportMultiposition&&!this.config.supportNativeReversePosition)throw new Error("Cannot reverse position on multiposition account");let t;const i=new Promise((async(i,s)=>{try{const s=await this._positionCopyById(e);t=e=>{void 0!==s&&e.symbol===s.symbol&&e.side!==s.side&&(this.positionUpdate.unsubscribe(this,t),i(!0))},this.positionUpdate.subscribe(this,t),await this._reversePosition(e)}catch(e){s(e)}}));return(0,g.makeTimeLimited)(i,3e4,"Position reversing timeout").catch((e=>(this._brokerLogger.logError(`${ie}: ${(0,T.getLoggerMessage)(e)}`),this.positionUpdate.unsubscribe(this,t),!1)))}editPositionBrackets(e,t,r){if(this._makeSureBrokerIsConnected(),this._brokerConnection.editPositionBrackets)return this.processErrors(this._brokerConnection.editPositionBrackets(e,t,r),!0,s.t(null,void 0,i(209877)));throw new Error("Method editPositionBrackets is not implemented")}editIndividualPositionBrackets(e,t){if(this._makeSureBrokerIsConnected(),(0,h.assert)(!!this.config.supportIndividualPositionBrackets,"Broker doesn`t support brackets on individual positions"),this._brokerConnection.editIndividualPositionBrackets)return this.processErrors(this._brokerConnection.editIndividualPositionBrackets(e,t),!0,s.t(null,void 0,i(209877)));throw new Error("Method editIndividualPositionBrackets is not implemented")}async subscribeRealtime(e,t){this._makeSureBrokerIsConnected();const i={symbol:e,listener:t,provider:0}
;this._realtimeSubscriptionState.push(i);const s=await this.symbolInfo(e),r=this._realtimeSubscriptionState.findIndex((i=>i.symbol===e&&i.listener===t));if(-1!==r)return void 0!==s.hasQuotes&&!1===s.hasQuotes?(this._realtimeSubscriptionState[r].provider=1,(0,h.ensure)(this._brokerRealtimeAdapter).subscribeRealtime(e,t)):(this._realtimeSubscriptionState[r].provider=2,this._addSubscription("Realtime",e,t))}async quotesSnapshot(e){let t,i;const s=(e,r)=>{i=r,(r.ask||r.bid)&&(this.unsubscribeRealtime(e,s),t?.(r))},r=new Promise((i=>{t=i,this.subscribeRealtime(e,s)}));try{return await(0,g.makeTimeLimited)(r,1e4,"quotesSnapshot not received")}catch(t){if(this.unsubscribeRealtime(e,s),void 0!==i)return i;throw t}}subscribeDOM(e,t){return this._makeSureBrokerIsConnected(),this._addSubscription("DOM",e,t)}subscribePipValue(e,t){return this._makeSureBrokerIsConnected(),this._addSubscription("PipValue",e,t)}subscribePL(e,t){this._makeSureBrokerIsConnected(),this._addSubscription("PL",e,t)}subscribeIndividualPositionPL(e,t){return this._makeSureBrokerIsConnected(),this._addSubscription("IndividualPositionPL",e,t)}subscribeCryptoBalance(e,t){return this._makeSureBrokerIsConnected(),this._addSubscription("CryptoBalance",e,t)}subscribeEquity(e){return this._makeSureBrokerIsConnected(),this._addSubscription("Equity","Equity",e)}subscribeMarginAvailable(e){return this._makeSureBrokerIsConnected(),this._addSubscription("MarginAvailable","MarginAvailable",e)}unsubscribeRealtime(e,t){const i=this._realtimeSubscriptionState.findIndex((i=>i.symbol===e&&i.listener===t));-1!==i&&(1===this._realtimeSubscriptionState[i].provider?(0,h.ensure)(this._brokerRealtimeAdapter).unsubscribeRealtime(e,t):this._removeSubscription("Realtime",e,t),this._realtimeSubscriptionState.splice(i,1))}unsubscribeDOM(e,t){this._removeSubscription("DOM",e,t)}unsubscribePipValue(e,t){this._removeSubscription("PipValue",e,t)}unsubscribePL(e,t){this._removeSubscription("PL",e,t)}unsubscribeIndividualPositionPL(e,t){this._removeSubscription("IndividualPositionPL",e,t)}unsubscribeCryptoBalance(e,t){this._removeSubscription("CryptoBalance",e,t)}unsubscribeEquity(e){this._removeSubscription("Equity","Equity",e)}unsubscribeMarginAvailable(e){this._removeSubscription("MarginAvailable","MarginAvailable",e)}subscribeExecutions(e){void 0!==this._brokerConnection.subscribeExecutions&&this._brokerConnection.subscribeExecutions(e)}unsubscribeExecutions(e){void 0!==this._brokerConnection.unsubscribeExecutions&&this._brokerConnection.unsubscribeExecutions(e)}async accountMetainfo(){const e=await this.accountsMetainfo(),t=this.currentAccount(),i=e.find((e=>e.id===t));if(void 0===i)throw new Error("accountMetainfo not received");return i}accountsMetainfo(){return(0,g.makeTimeLimited)(this._brokerConnection.accountsMetainfo(),1e4,"accountsMetainfo not received")}setCurrentAccount(e){if(void 0===this._brokerConnection.setCurrentAccount)throw new Error(`${this._brokerMetainfo.title} doesn't support sub-accounts`);this._brokerConnection.setCurrentAccount(e)}symbolInfo(e){return(0,
g.makeTimeLimited)(this._brokerConnection.symbolInfo(e),1e4,"symbolInfo not received")}async getPositionCurrency(e){try{const t=await this._brokerConnection.symbolInfo(e);if(this._brokerMetainfo.configFlags.positionPLInInstrumentCurrency)return t.currency;const i=await this.accountMetainfo();return(0,w.getCurrency)(i,!0)}catch(e){return void ee.logError(e)}}sessionId(){return this._sessionId}bugReportInfo(){function e(e){return JSON.parse(JSON.stringify(e))}function t(e){if("object"!=typeof e)return e;if((0,u.isArray)(e))return e.map(t);const i={};for(const t in e)"object"!=typeof e[t]&&(i[t]=e[t]);return i}return Promise.all([this.orders(),this.positions(),this.config.supportPositionNetting?this.individualPositions():Promise.resolve([])]).then((i=>({activeBroker:this.metainfo().title,orders:t(e(i[0])),positions:t(e(i[1])),individualPositions:t(e(i[2])),silentOrdersPlacement:this._host.silentOrdersPlacement().value(),floatingPanel:(0,h.ensureNotNull)(this._host.sellBuyButtonsVisibility()).value(),account:this.currentAccount(),accountType:this.currentAccountType(),lastUpdates:this._lastFireResult,time:Date.now(),brokerSpecific:this._brokerConnection.bugReportInfo?this._brokerConnection.bugReportInfo():null,sessionId:this._sessionId,deviceId:getDeviceId()})))}processErrors(e,t,i,s){if(!(0,u.isPromise)(e))throw new Error("Broker incorrectly implements API, should return Promise");return e.then((e=>s&&s(e))).then((e=>"boolean"!=typeof e||e)).catch((e=>((0,o.isAbortError)((0,P.getErrorCauses)(e)[0])||(t&&l.enabled("trading_notifications")?this._showErrorNotification({error:e,notificationTitle:i}):ee.logWarn(e)),Promise.resolve(!1)))).then((e=>(this.tradingOperationFinished.fire(e),e)))}setDurations(e){this._brokerMetainfo.durations=e.slice()}setSymbolSearchId(e){this._brokerMetainfo.backendBrokerName=e}getRealtimeDataCheckParams(){return this._brokerConnection.getRealtimeDataCheckParams?this._brokerConnection.getRealtimeDataCheckParams():{}}getVerifyLiveAccountParams(){if(void 0===this._brokerConnection.getVerifyLiveAccountParams)throw new Error(`Method getVerifyLiveAccountParams for broker ${this._brokerMetainfo.id} is not implemented`);return this._brokerConnection.getVerifyLiveAccountParams()}unhideSymbolSearchGroups(){return this._brokerConnection.unhideSymbolSearchGroups?this._brokerConnection.unhideSymbolSearchGroups():[]}destroy(){void 0!==this._brokerConnection.destroy&&this._brokerConnection.destroy()}currentBroker(){return this._brokerMetainfo.id}resetConfirmations(){this._brokerConnection?.resetConfirmations?.()}orderInfo(e){if(!this._brokerConnection.orderInfo)throw new Error("Broker Provided Order Info is not supported");return this._brokerConnection.orderInfo(e)}_showErrorNotification(e){const{error:t,notificationTitle:r,showErrorNotificationEnding:o=!0}=e;let n="";"string"==typeof t?n=t:"object"==typeof t&&null!==t&&"message"in t&&"string"==typeof t.message&&(n=(0,S.removeTags)(t.message)),0!==n.length&&(n=(0,w.addAsciiDotIfTextDoesNotEndWithSentenceEndingMark)(n)+" "),
o&&(n+=this._brokerMetainfo.customErrorNotificationEnding??s.t(null,void 0,i(926986))),this._host.showNotification(r||"",n.trim(),0)}_makeContextErrorHandler(e){return l.enabled("trading_notifications")?t=>{t instanceof Error&&this._brokerLogger.logNormal(`Failed to validate context: ${(0,T.getLoggerMessage)(t)}`),this._showErrorNotification({error:t,notificationTitle:e,showErrorNotificationEnding:!1})}:e=>ee.logWarn((0,T.getErrorMessage)(e))}async _createEditOrderContext(e){const{order:t,source:r,isValidationEnabled:o=!0,orderById:l}=e,[d,u,c]=await Promise.all([this.symbolInfo(t.symbol),this.formatter(t.symbol),this.getOrderDialogOptions(t.symbol)]),{configFlags:p,orderRules:_=[]}=this.metainfo(),g=p.supportBalances&&d.baseCurrency?this._cryptoBalanceObservable(d.baseCurrency):(0,n.of)(null),y=p.supportBalances&&d.quoteCurrency?this._cryptoBalanceObservable(d.quoteCurrency):(0,n.of)(null),b=await(0,B.extractTakeProfitValidationRules)(this,t.symbol),m=await(0,B.extractStopLossValidationRules)(this,t.symbol),v=await(0,B.extractGuaranteedStopValidationRules)(this,t.symbol),f=_.filter(B.isLimitPercentValidationRule),P=_.filter(B.isStopPercentValidationRule);p.supportStopOrdersInBothDirections&&p.supportStopLimitOrdersInBothDirections||(f.push(...await(0,B.extractLimitValidationRules)(this,t.symbol)??[]),P.push(...await(0,B.extractStopValidationRules)(this,t.symbol)??[]));const S=(0,a.fromEventPattern)((e=>this.subscribeRealtime(t.symbol,e)),(e=>this.unsubscribeRealtime(t.symbol,e)),((e,t)=>t)),k=(0,h.ensureDefined)(await this.orderById(t.id)),C=new X({orderData:t,originalOrder:k,source:r,configFlags:p,isValidationEnabled:o,instrumentInfo:d,tpValidationRules:b,slValidationRules:m,guaranteedStopValidationRules:v,limitOrderRules:f,stopOrderRules:P,quotes$:S,formatter:u,orderDialogOptions:c,baseCurrencyCryptoBalance$:g,quoteCurrencyCryptoBalance$:y,isStatusEditing:!0,callbacks:{modifyOrder:this._modifyOrder.bind(this),metainfo:this.metainfo.bind(this),symbolInfo:this.symbolInfo.bind(this),orderById:l||this.orderById.bind(this),previewOrder:this._previewOrder.bind(this),handleError:this._makeContextErrorHandler(s.t(null,void 0,i(663504)))}});return await C.onReady(),C}async _createEditPositionContext(e){const{position:t,source:r,isValidationEnabled:o=!0}=e,[n,l]=await Promise.all([this.symbolInfo(t.symbol),this.formatter(t.symbol)]),{configFlags:d,orderRules:u=[]}=this.metainfo(),c=await(0,B.extractTakeProfitValidationRules)(this,t.symbol),p=await(0,B.extractStopLossValidationRules)(this,t.symbol),_=await(0,B.extractGuaranteedStopValidationRules)(this,t.symbol),g=u.filter(B.isLimitPercentValidationRule),y=u.filter(B.isStopPercentValidationRule);d.supportStopOrdersInBothDirections&&d.supportStopLimitOrdersInBothDirections||(g.push(...await(0,B.extractLimitValidationRules)(this,t.symbol)??[]),y.push(...await(0,B.extractStopValidationRules)(this,t.symbol)??[]));const b=(0,a.fromEventPattern)((e=>this.subscribeRealtime(t.symbol,e)),(e=>this.unsubscribeRealtime(t.symbol,e)),((e,t)=>t)),m=(0,
h.ensureDefined)(await this.positionById(t.id)),v=new J({positionData:t,originalPosition:m,source:r,configFlags:d,isValidationEnabled:o,instrumentInfo:n,tpValidationRules:c,slValidationRules:p,guaranteedStopValidationRules:_,quotes$:b,formatter:l,isStatusEditing:!0,callbacks:{metainfo:this.metainfo.bind(this),orderById:this.orderById.bind(this),symbolInfo:this.symbolInfo.bind(this),handleError:this._makeContextErrorHandler(s.t(null,void 0,i(444065))),editPositionBrackets:this.editPositionBrackets.bind(this)}});return await v.onReady(),v}async _createEditIndividualPositionContext(e){const{position:t,source:r,isValidationEnabled:o=!0}=e,[n,l]=await Promise.all([this.symbolInfo(t.symbol),this.formatter(t.symbol)]),{configFlags:d,orderRules:u=[]}=this.metainfo(),c=await(0,B.extractTakeProfitValidationRules)(this,t.symbol),p=await(0,B.extractStopLossValidationRules)(this,t.symbol),_=await(0,B.extractGuaranteedStopValidationRules)(this,t.symbol),g=u.filter(B.isLimitPercentValidationRule),y=u.filter(B.isStopPercentValidationRule);d.supportStopOrdersInBothDirections&&d.supportStopLimitOrdersInBothDirections||(g.push(...await(0,B.extractLimitValidationRules)(this,t.symbol)??[]),y.push(...await(0,B.extractStopValidationRules)(this,t.symbol)??[]));const b=(0,a.fromEventPattern)((e=>this.subscribeRealtime(t.symbol,e)),(e=>this.unsubscribeRealtime(t.symbol,e)),((e,t)=>t)),m=(0,h.ensureDefined)(await this.individualPositionById(t.id)),v=new Z({individualPositionData:t,originalIndividualPosition:m,source:r,configFlags:d,isValidationEnabled:o,instrumentInfo:n,tpValidationRules:c,slValidationRules:p,guaranteedStopValidationRules:_,quotes$:b,formatter:l,isStatusEditing:!0,callbacks:{metainfo:this.metainfo.bind(this),orderById:this.orderById.bind(this),symbolInfo:this.symbolInfo.bind(this),handleError:this._makeContextErrorHandler(s.t(null,void 0,i(858040))),editIndividualPositionBrackets:this.editIndividualPositionBrackets.bind(this)}});return await v.onReady(),v}async _createPlaceOrderContext(e){const{order:t,source:r,isValidationEnabled:o=!0}=e,[l,d,u]=await Promise.all([this.symbolInfo(t.symbol),this.formatter(t.symbol),this.getOrderDialogOptions(t.symbol)]),{configFlags:c,orderRules:h=[]}=this.metainfo(),p=c.supportBalances&&l.baseCurrency?this._cryptoBalanceObservable(l.baseCurrency):(0,n.of)(null),_=c.supportBalances&&l.quoteCurrency?this._cryptoBalanceObservable(l.quoteCurrency):(0,n.of)(null),g=await(0,B.extractTakeProfitValidationRules)(this,t.symbol),y=await(0,B.extractStopLossValidationRules)(this,t.symbol),b=await(0,B.extractGuaranteedStopValidationRules)(this,t.symbol),m=h.filter(B.isLimitPercentValidationRule),v=h.filter(B.isStopPercentValidationRule);c.supportStopOrdersInBothDirections&&c.supportStopLimitOrdersInBothDirections||(m.push(...await(0,B.extractLimitValidationRules)(this,t.symbol)??[]),v.push(...await(0,B.extractStopValidationRules)(this,t.symbol)??[]));const f=(0,a.fromEventPattern)((e=>this.subscribeRealtime(t.symbol,e)),(e=>this.unsubscribeRealtime(t.symbol,e)),((e,t)=>t)),P=new Y({orderData:t,source:r,
instrumentInfo:l,quotes$:f,configFlags:c,formatter:d,isValidationEnabled:o,orderDialogOptions:u,tpValidationRules:g,slValidationRules:y,guaranteedStopValidationRules:b,limitOrderRules:m,stopOrderRules:v,isStatusEditing:!1,baseCurrencyCryptoBalance$:p,quoteCurrencyCryptoBalance$:_,callbacks:{createInitialPreOrder:async e=>this._createInitialPreOrder(e,l,u),placeOrder:(e,t)=>this._placeOrder(e,t),previewOrder:e=>this._previewOrder(e),handleError:this._makeContextErrorHandler(s.t(null,void 0,i(74390)))}});return await P.onReady(),P}_createInitialPreOrder(e,t,i){if(void 0===e.duration){const{durations:i}=this.metainfo(),s=(0,w.getOrderDuration)({orderDuration:void 0,orderType:e.type,savedDuration:this._getTradingSettingsStorage?.()?.duration(e.symbol,e.type)??null,orderDurations:i,symbolDurations:t.allowedDurations});null!==s&&(e.duration=s)}if(void 0===e.customFields){const t=this._getSavedCustomFields(e.symbol,e.type,i);void 0!==t&&(e.customFields=t)}return e}_getSavedCustomFields(e,t,i){const s=this._getTradingSettingsStorage?.()??void 0;if(void 0===s||void 0===i?.customFields||0===i.customFields.length)return;const r=(0,M.filterAllowedCustomFields)(t,i.customFields).map((e=>e.id)),o=s.customFields(e,t,r),n=(0,w.adjustSavedCustomFieldsValues)(o,i);return 0!==Object.keys(n).length?n:void 0}_placeOrder(e,t){return this._makeSureBrokerIsConnected(),this.processErrors(this._brokerConnection.placeOrder(e,t),!0,s.t(null,void 0,i(74390)),(t=>{(0,h.ensureNotNull)(this._tradingStat).trackOrderPlaced({order:{...e,id:t.orderId},label:t.label,source:e.source}),this._host.trackEvent("","SilentMode",this._host.silentOrdersPlacement().value()?"On":"Off")}))}async _modifyOrder(e,t){this._makeSureBrokerIsConnected();const r=new Set((await this._orders()).map((({id:e})=>e)));r.delete(e.id);return await this.processErrors(this._brokerConnection.modifyOrder(e,t),!0,s.t(null,void 0,i(663504)),(()=>(0,h.ensureNotNull)(this._tradingStat).trackOrderModified(e)))&&this._waitForOrderModification(e,r)}_previewOrder(e){if(!this._brokerConnection.previewOrder)throw new Error("Order preview is not supported");return this._brokerConnection.previewOrder(e)}_initializeConnectProtection(){let e=null;this.connectionStatusUpdate.subscribe(null,(t=>{if(e&&(clearTimeout(e),e=null),2===t){const t=(0,w.isOAuthAuthType)(this.config.authorizationType)?3e5:6e4;e=setTimeout((()=>{this._host.selectBroker(),this._host.showNotification(s.t(null,void 0,i(369635)),s.t(null,void 0,i(949880)))}),t)}}))}_fakeSubscribeDOM(e){this._fakeDOMSubscriptions[e]=(e,t)=>{const i=t.ask||t.trade,s=t.bid||t.trade,r={snapshot:!0,asks:i?[{price:i,volume:t.ask_size||1/0}]:[],bids:s?[{price:s,volume:t.bid_size||1/0}]:[]};this._host.domUpdate(e,r)},this.subscribeRealtime(e,this._fakeDOMSubscriptions[e])}_fakeUnsubscribeDOM(e){this.unsubscribeRealtime(e,this._fakeDOMSubscriptions[e])}_isMaintenance(){return isFeatureEnabled((0,w.makeMaintananceFeatureToggleName)(this._brokerMetainfo.id))}_isBrokerSideMaintenance(){return isFeatureEnabled((0,
w.makeBrokerSideMaintananceFeatureToggleName)(this._brokerMetainfo.id))}async _positionCopyById(e){const t=await this.positionById(e);return void 0!==t?(0,r.default)(t):void 0}_patchBrokerSubscribeUnsubscribeDOMMethods(){const e=!this._brokerMetainfo.configFlags.supportLevel2Data;this._brokerConnection.subscribeDOM=e?e=>{this._fakeSubscribeDOM(e)}:this._originalDOMSubscriptionMethods.subscribeDOM,this._brokerConnection.unsubscribeDOM=e?e=>{this._fakeUnsubscribeDOM(e)}:this._originalDOMSubscriptionMethods.unsubscribeDOM}_patchMetainfo(e){const t=(0,k.deepCopy)(e);t.configFlags.supportNativeReversePosition=!this.config.supportMultiposition||this.config.supportNativeReversePosition,t.configFlags.supportClosePosition=!0,t.configFlags.supportPLUpdate=!0;const i=!Boolean(this.config.supportStopLoss)&&!Boolean(this.config.supportGuaranteedStop)&&!Boolean(this.config.supportTrailingStop);return t.configFlags.supportStopLoss=!!i||this.config.supportStopLoss,t}_addSubscription(e,t,i){this._pendingSubscriptions.push({brokerMethodName:e,symbol:t,listener:i});const s=this._lastFireResult[t];if(void 0!==s&&void 0!==s[e]&&null!==s[e]&&i(t,s[e].data),!this._removePendingSubscription({brokerMethodName:e,symbol:t,listener:i}))return;void 0===this._subscriptions[t]&&(this._subscriptions[t]={Realtime:[],PL:[],Equity:[],DOM:[],IndividualPositionPL:[],PipValue:[],MarginAvailable:[],CryptoBalance:[]});const r=(0,h.ensure)(this._subscriptions[t]),o=r[e].length>0;if(r[e].push(i),!o&&(r[e].length>0||"CryptoBalance"===e)){const i="subscribe"+e;this._brokerConnection[i]&&this._brokerConnection[i](t)}}_removePendingSubscription(e){const t=this._pendingSubscriptions.findIndex((t=>t.symbol===e.symbol&&t.brokerMethodName===e.brokerMethodName&&t.listener===e.listener));return-1!==t&&(this._pendingSubscriptions.splice(t,1),!0)}_removeSubscription(e,t,i){if(this._removePendingSubscription({brokerMethodName:e,symbol:t,listener:i}))return;if(void 0===this._subscriptions[t])return;const s=(0,h.ensure)(this._subscriptions[t]),r=s[e].indexOf(i);if(r>-1&&s[e].splice(r,1),0===s[e].length){const i="unsubscribe"+e;this._brokerConnection[i]&&this._brokerConnection[i](t)}}_positions(){return this._positionsCache?this._positionsCache.getObjects():Promise.resolve([])}_individualPositions(){return this._individualPositionsCache?this._individualPositionsCache.getObjects():Promise.resolve([])}_orders(){return this._ordersCache.getObjects()}_makeSureBrokerIsConnected(){(0,h.assert)(1===this.connectionStatus(),"Broker is not connected")}async _placeReversePositionOrder(e){const t=await this.quotesSnapshot(e.symbol),i=E(2*e.qty,e,t);return this._placeOrder(i)}async _closePosition(e,t,r){const o=(0,h.ensureDefined)(await this.positionById(e));if(!(0,w.checkIsExistingPosition)(o)){const e=s.t(null,void 0,i(445863));throw this._host.showNotification(te,e,0),new Error(e)}if(!(void 0===t||t<=Math.abs(o.qty))){const e=s.t(null,void 0,i(819189));throw this._host.showNotification(te,e,0),new Error(e)}{const i=await this.quotesSnapshot(o.symbol),s=E(t??Math.abs(o.qty),o,i)
;if(this.config.supportClosePosition&&this._brokerConnection.closePosition){if(!await this.processErrors(this._brokerConnection.closePosition(e,t,r),!0,te,(()=>(0,h.ensureNotNull)(this._tradingStat).trackOrderPlaced({order:s}))))throw new Error(te)}else{if(!await this.processErrors(this._brokerConnection.placeOrder(s),!0,te,(()=>(0,h.ensureNotNull)(this._tradingStat).trackOrderPlaced({order:s}))))throw new Error(te)}}}async _reversePosition(e){const t=(0,h.ensureDefined)(await this.positionById(e));if(0===t.qty){const e=s.t(null,void 0,i(887411));throw this._host.showNotification(ie,e,0),new Error(e)}this.config.supportNativeReversePosition&&this._brokerConnection.reversePosition?await this.processErrors(this._brokerConnection.reversePosition(e),!0,ie):await this.processErrors(this._placeReversePositionOrder(t),!0,ie,(()=>(0,h.ensureNotNull)(this._tradingStat).trackOrderPlaced()))}async _waitForOrderModification(e,t){return new Promise((async i=>{const s=()=>{i(!0),o(),clearTimeout(n)},r=t=>{this._areOrdersEqual(t,e)&&s()},o=()=>this.orderUpdate.unsubscribe(this,r),n=setTimeout((()=>{i(!1),this._brokerLogger.logError("Failed to modify order: timeout waiting for new order"),o()}),3e4);this.orderUpdate.subscribe(this,r);for(const i of await this._orders())if(!t.has(i.id)&&this._areOrdersEqual(e,i))return void s()}))}_areOrdersEqual(e,t){const{checkBracketsAfterOrderModification:i,supportModifyTrailingStop:s}=this._brokerMetainfo.configFlags,r=i&&(0,w.isOrderActive)(e.status)&&(0,w.isOrderActive)(t.status);return function(e,t){const i=3===e.type||4===e.type;return e.type===t.type&&e.qty===t.qty&&e.limitPrice===t.limitPrice&&(!i||e.stopPrice===t.stopPrice)}(e,t)&&(!r||function(e,t,i){const s=void 0!==e.trailingStopPips&&void 0===t.trailingStopPips||void 0===e.trailingStopPips&&void 0!==t.trailingStopPips,r=!!i&&e.trailingStopPips!==t.trailingStopPips,o=!s&&!r;return e.stopLoss===t.stopLoss&&e.takeProfit===t.takeProfit&&o&&e.guaranteedStop===t.guaranteedStop}(e,t,s))}_updateConfigDependentProperties(){const{supportPositions:e}=this._brokerMetainfo.configFlags;e?(this._fakePositionUpdateDelegate?.destroy(),this._fakePositionUpdateDelegate=null):this._fakePositionUpdateDelegate??=new c.Delegate}_cryptoBalanceObservable(e){return(0,a.fromEventPattern)((t=>this.subscribeCryptoBalance(e,t)),(t=>this.unsubscribeCryptoBalance(e,t)),((e,t)=>t))}}var ne=i(453253),ae=i(748838),le=i(963632),de=i(714635),ue=i(986900),ce=i(333250),he=i(932473),pe=i(153055),_e=i(469021),ge=i(10857);var ye=i(828750),be=i(904958),me=i(464703),ve=i(782860);class fe{constructor(e,t,i,s){this._lastPL=0,this._isActive=!1,this._realtimeUpdate=(e,t)=>{this._realtimeData=t,this._updatePL()},this._symbol=e.symbol,this._adapter=i,this._onPlUpdate=t,this._side=e.side,this._qty=e.qty,this._avgPrice=e.avgPrice||e.price,this._instrumentInfo=s,this.positionUpdate(e)}positionUpdate(e){this._avgPrice=e.avgPrice||e.price,this._qty=e.qty,this._side=e.side,this._updatePL()}lastPL(){return this._lastPL}start(){
this._isActive||(this._adapter.subscribeRealtime(this._symbol,this._realtimeUpdate),this._isActive=!0)}stop(){this._isActive&&(this._adapter.unsubscribeRealtime(this._symbol,this._realtimeUpdate),this._isActive=!1)}_updatePL(){if(!this._realtimeData||void 0===this._realtimeData.bid||void 0===this._realtimeData.ask)return;const e=Number(new q.Big(1===this._side?this._realtimeData.bid:this._realtimeData.ask).minus(Math.abs(this._avgPrice)).mul(1===this._side?1:-1).mul(this._qty).mul(this._instrumentInfo.lotSize??1).div(this._instrumentInfo.pipSize).mul(this._instrumentInfo.pipValue));this._lastPL=e,this._onPlUpdate(e)}}var Pe=i(34598);class Se{constructor(e,t,i,s){this._setDefaultDropdownActionsBound=this._setDefaultDropdownActions.bind(this),this._buttonDropdownActions=[],this._qtyChangedSubscriptions=new Map,this.checkRealtimeDataPermissions=e=>(0,h.ensureNotNull)(this._trading,"Trading in realtime data permission checker").checkRealtimeDataPermissions(e),this.serverLogger=()=>this._serverLogger,this.showNotification=(e,t,i=0)=>{null!==this._trading&&(0===i?this._trading.showErrorNotification(e,t):this._trading.showSuccessNotification(e,t))},this.orderPartialUpdate=(e,t)=>{this._adapter.onOrderPartialUpdate(e,t)},this.positionPartialUpdate=(e,t)=>{this._adapter.onPositionPartialUpdate(e,t)},this.individualPositionPartialUpdate=(e,t)=>{this._adapter.onIndividualPositionPartialUpdate(e,t)},this.createMapperAsync=(e,t)=>({ready:async()=>Promise.resolve(),tvToBroker:async e=>e,brokerToTv:async e=>e}),this.createMapperSync=(e,t)=>{let i=null;{const e=Promise.resolve();i={ready:()=>e,tvToBroker:e=>e,brokerToTv:e=>e}}return i},this._trading=e,this._metainfo=t,this._serverLogger=null!==i?this._makeServerLoggerWithFilledInfo(i):null,this._setDefaultDropdownActionsBound=this._setDefaultDropdownActions.bind(this),this._defaultDropdownActions=!0,this._credentialsStorage=s,this._setDefaultDropdownActions(),null!==this._trading&&(this.sellBuyButtonsVisibility()?.subscribe(this._setDefaultDropdownActionsBound),(0,h.ensureNotNull)(this.orderPanelVisibility()).subscribe(this._setDefaultDropdownActionsBound),(0,h.ensureNotNull)(this.domPanelVisibility()).subscribe(this._setDefaultDropdownActionsBound))}createPLEmitter(e,t,i){return new fe(e,t,this._adapter,i)}getLogger(e){const t=`Trading.${this._metainfo.id}`;if(void 0===e)return(0,_.getLogger)(t);const{brokerSubsystemId:i,metainfo:s}=e,r=void 0!==i?`.${i}`:"";return(0,_.getLogger)(`${t}${r}`,s)}translate(e){return e}setBrokerConnectionAdapter(e){this._adapter=e}patchConfig(e){this._adapter.patchConfig(e)}showOrderDialog(e,t){{const i=this._adapter.metainfo();if(i.customUI?.showOrderDialog)return i.customUI.showOrderDialog(e,t)}return(0,h.ensureNotNull)(this._trading).orderViewController().showOrderView({order:e,focus:t})}showPositionBracketsDialog(e,t,i){{const s=this._adapter.metainfo();if(s.customUI?.showPositionDialog)return s.customUI.showPositionDialog(e,t,i)}return(0,h.ensureNotNull)(this._trading).orderViewController().showPositionView(e,t,i)}async showCancelOrderDialog(e,t){
{const t=this._adapter.metainfo();if(t.customUI?.showCancelOrderDialog){const i=await this._adapter.orderById(e);return i?void await t.customUI.showCancelOrderDialog(i):void console.warn(`Can't find order with id ${e} to cancel`)}}return be.ConfirmOrderCancelDialog.get().open(e).then((e=>{e&&this._adapter.processErrors(t(),!0,s.t(null,void 0,i(919116)))}))}showCancelMultipleOrdersDialog(e,t,r,o){return be.ConfirmOrderCancelDialog.get().multiple(e,t,r).then((e=>{e&&this._adapter.processErrors(o(),!0,s.t(null,void 0,i(759469)))}))}showCancelBracketsDialog(e,t){return me.ConfirmBracketsCancelDialog.get().open(e).then((e=>{e&&this._adapter.processErrors(t(),!0,s.t(null,void 0,i(83683)))}))}showCancelMultipleBracketsDialog(e,t){return me.ConfirmBracketsCancelDialog.get().multiple(e).then((e=>{e&&this._adapter.processErrors(t(),!0,s.t(null,void 0,i(83683)))}))}async showReversePositionDialog(e,t){{const t=this._adapter.metainfo();if(t.customUI?.showReversePositionDialog){const i=await this._adapter.positionById(e);return i?t.customUI.showReversePositionDialog(i):(console.warn(`Can't find position with id ${e} to reverse`),!1)}}return(0,ve.reversePositionDialog)({positionId:e,showErrorNotification:(0,h.ensureNotNull)(this._trading).showErrorNotification,handler:t})}showMessageDialog(e,t,i=!1){i?(0,pe.showWarning)({title:e,html:t}):(0,pe.showWarning)({title:e,text:t})}showConfirmDialog(e,t,r,n,a){return async function(e){const{title:t,content:r,mainButtonText:n,cancelButtonText:a,showDisableConfirmationsCheckbox:l,onOpen:d,onClose:u,abortSignal:c,showBackdrop:h}=e,p=new ge.DisabledConfirmations,_=(0,_e.makeConfirmation)(r);if(l&&void 0!==_&&p.has(_))return!0;const{ConfirmDialogRenderer:g}=await Promise.all([i.e(7172),i.e(8894),i.e(5743),i.e(4495),i.e(9487),i.e(9323),i.e(159),i.e(683),i.e(1144),i.e(775),i.e(9658),i.e(7882),i.e(4952),i.e(5789),i.e(3905),i.e(3566)]).then(i.bind(i,741463)),y=new g(p),b={title:t,message:r,closeButton:a??s.t(null,void 0,i(38733)),confirmButton:n??s.t(null,void 0,i(955512)),showDisableConfirmationsCheckbox:l,onOpen:d,onClose:u,abortSignal:c,showBackdrop:h};try{return(await y.open(b)).status}catch(e){if((0,o.isAbortError)(e))return!1;throw e}}({title:e,content:t,mainButtonText:r,cancelButtonText:n,showDisableConfirmationsCheckbox:a})}showSimpleConfirmDialog(e,t,i,s,r){return(0,ye.showSimpleConfirmDialog)({title:e,text:Array.isArray(t)?t.join(" "):t,mainButtonText:i,mainButtonIntent:"primary",cancelButtonText:s,showDisableConfirmationsCheckbox:r})}showSimpleConfirmDialogAndRespectAbort(e,t,i,s,r,o){return(0,ye.showSimpleConfirmDialog)({title:e,text:Array.isArray(t)?t.join(" "):t,abortSignal:i,mainButtonText:s,mainButtonIntent:"primary",cancelButtonText:r,showDisableConfirmationsCheckbox:o})}showOrderQuestionDialog(e,t,s,r,n,a){return async function(e){const{onConfirm:t,onClose:s,onCancel:r,abortSignal:n,showDisableConfirmationsCheckbox:a,text:l}=e,d=new ge.DisabledConfirmations;if(a&&d.has(l))return Promise.resolve({isConfirmed:!0,dontShowAgain:!0});if(n?.aborted)return Promise.resolve({
isConfirmed:!1,dontShowAgain:!1});const[{showSimpleDialog:u},{SimpleConfirmDialog:c}]=await Promise.all([Promise.all([i.e(7172),i.e(8894),i.e(5743),i.e(4495),i.e(9487),i.e(9323),i.e(159),i.e(683),i.e(1144),i.e(775),i.e(9658),i.e(7882),i.e(4952),i.e(5789),i.e(3905),i.e(3566)]).then(i.bind(i,480994)),Promise.all([i.e(7172),i.e(8894),i.e(5743),i.e(4495),i.e(9487),i.e(9323),i.e(159),i.e(683),i.e(1144),i.e(775),i.e(9658),i.e(7882),i.e(4952),i.e(5789),i.e(3905),i.e(3566)]).then(i.bind(i,20066))]);return new Promise(((i,a)=>{if(n?.aborted)return void a((0,o.createAbortError)());const l=u({...e,disabledConfirmations:d,onConfirm:(e,s)=>{i({isConfirmed:!0,dontShowAgain:s}),void 0!==t&&t(),e.dialogClose()},onClose:()=>{i({isConfirmed:!1,dontShowAgain:!1}),void 0!==s&&s()},onCancel:e=>{i({isConfirmed:!1,dontShowAgain:!1}),void 0!==r&&r(e),e.dialogClose()}},c);n?.addEventListener("abort",(()=>{l(),a((0,o.createAbortError)())}),{once:!0})}))}({title:e,text:Array.isArray(t)?t.join(" "):t,abortSignal:s,mainButtonText:r,mainButtonIntent:"primary",cancelButtonText:n,showDisableConfirmationsCheckbox:a})}setDurations(e){this._adapter.setDurations(e)}setSymbolSearchId(e){this._adapter.setSymbolSearchId(e)}activateBottomWidget(){return null!==this._trading?(console.warn('"activateBottomWidget" is now deprecated. Please use "setAccountManagerVisibilityMode" instead '),this._trading.toggleTradingWidget()):Promise.reject("Activate bottom widget failed: trading is not defined")}getAccountManagerVisibilityMode(){if(null===this._trading)throw new Error("Unable to interact with the account manager: trading is not defined");return this._trading.getAccountManagerVisibilityMode()}setAccountManagerVisibilityMode(e){if(l.enabled("trading_account_manager")){if(null===this._trading)throw new Error("Unable to interact with the account manager: trading is not defined");this._trading.setAccountManagerVisibilityMode(e)}}bottomWidgetMode(){if(null===this._trading)throw new Error("Unable to provide bottom widget mode: trading is not defined");return this._trading.bottomWidgetBarMode()}trackEvent(e,t,i){null!==this._trading&&this._trading.trackEvent(e,t,i)}defaultFormatter(e,t){return(0,ce.getQuoteSessionInstance)("simple").formatter(e,t)}numericFormatter(e){return Promise.resolve(new de.NumericFormatter({precision:e}))}quantityFormatter(e){return Promise.resolve(new ue.QuantityFormatter(e))}selectBroker(){null!==this._trading&&this._trading.selectBroker(null)}showTradingProperties(){null!==this._trading&&this._trading.showTradingProperties()}async getSymbolTypespecs(e){return(0,Pe.getSymbolTypespecs)(e)}async getSymbolType(e){return(0,Pe.getSymbolType)(e)}async getSymbolMinTick(e){return(0,Pe.getSymbolMinTick)(e)}silentOrdersPlacement(){return(0,h.ensureNotNull)(this._trading).noConfirmEnabled}sellBuyButtonsVisibility(){return null!==this._trading&&l.enabled("buy_sell_buttons")?this._trading.showSellBuyButtons:null}domPanelVisibility(){return null!==this._trading?this._trading.domPanelVisibility():null}orderPanelVisibility(){
return null!==this._trading?this._trading.orderPanelVisibility():null}showPricesWithZeroVolume(){return(0,h.ensureNotNull)(this._trading).showPricesWith().zeroVolume}async getOrderTicketSetting(e){return(await this._getOrderTicketSettings())[e]}async setOrderTicketSetting(e,t){const i={...await this._getOrderTicketSettings(),[e]:t};(await(0,h.ensureNotNull)(this._trading).findOrCreateOrderViewController()).setOrderTicketSetting(i)}connectionStatusUpdate(e,t){this._adapter.connectionStatusUpdate.fire(e,t),1===e&&this._setDefaultDropdownActions()}orderUpdate(e){this._adapter.onOrderUpdate(e)}ordersFullUpdate(){this._adapter.onOrdersFullUpdate()}positionUpdate(e,t){this._adapter.onPositionUpdate(e,t)}positionsFullUpdate(){this._adapter.onPositionsFullUpdate()}individualPositionUpdate(e,t){this._adapter.onIndividualPositionUpdate(e,t)}individualPositionsFullUpdate(){this._adapter.onIndividualPositionsFullUpdate()}executionUpdate(e){this._adapter.executionUpdate.fire(e)}currentAccountUpdate(){this._adapter.onCurrentAccountChanged()}realtimeUpdate(e,t){this._adapter.fireSubscription("Realtime",e,t)}domUpdate(e,t){this._adapter.fireSubscription("DOM",e,t)}pipValueUpdate(e,t){this._adapter.fireSubscription("PipValue",e,t)}setQty(e,t){(0,h.ensureNotNull)(this._trading).getQtySuggester().setQty(e,t)}getQty(e){return(0,h.ensureNotNull)(this._trading).getQtySuggester().getQty(e)}subscribeSuggestedQtyChange(e,t){const i=this._qtyChangedSubscriptions.get(e)??new Map;if(i.has(t))return;this._qtyChangedSubscriptions.has(e)||this._qtyChangedSubscriptions.set(e,i);const s=(0,h.ensureNotNull)(this._trading).getQtySuggester().suggestedQtyChanged(e);i.set(t,s.subscribe(t))}unsubscribeSuggestedQtyChange(e,t){const i=this._qtyChangedSubscriptions.get(e);if(void 0===i)return;const s=i.get(t);void 0!==s&&(s.unsubscribe(),i.delete(t),0===i.size&&this._qtyChangedSubscriptions.delete(e))}plUpdate(e,t){this._adapter.fireSubscription("PL",e,t)}individualPositionPLUpdate(e,t){this._adapter.fireSubscription("IndividualPositionPL",e,t)}equityUpdate(e){this._adapter.fireSubscription("Equity","Equity",e)}marginAvailableUpdate(e){this._adapter.fireSubscription("MarginAvailable","MarginAvailable",e)}cryptoBalanceUpdate(e,t){this._adapter.fireSubscription("CryptoBalance",e,t)}setButtonDropdownActions(e){null!==this._trading&&this._defaultDropdownActions&&(this._defaultDropdownActions=!1,this.sellBuyButtonsVisibility()?.unsubscribe(this._setDefaultDropdownActionsBound),(0,h.ensureNotNull)(this.orderPanelVisibility()).unsubscribe(this._setDefaultDropdownActionsBound),(0,h.ensureNotNull)(this.domPanelVisibility()).unsubscribe(this._setDefaultDropdownActionsBound)),this._buttonDropdownActions=e}buttonDropdownActions(){return this._buttonDropdownActions}defaultContextMenuActions(...e){return null!==this._trading?this._trading.defaultContextMenuActions(...e):Promise.resolve([])}defaultDropdownMenuActions(e){return null!==this._trading?this._trading.defaultDropdownMenuActions(e):[]}get factory(){return{createDelegate:()=>new c.Delegate,
createWatchedValue:e=>new le.WatchedValue(e),createPriceFormatter:(e,t,i,s,r)=>new he.PriceFormatter({priceScale:e,minMove:t,fractional:i,minMove2:s,variableMinTick:r})}}get settings(){return{save:(e,t)=>ae.default.setJSON(`${this._metainfo.id}.${e}`,t),load:(e,t)=>ae.default.getJSON(`${this._metainfo.id}.${e}`,t),clear:(e,t)=>ae.default.remove(`${this._metainfo.id}.${e}`,t)}}get credentialsStorage(){return this._credentialsStorage}convertTimezone(e,t,i){const s=(0,ne.get_timezone)(t),r=(0,ne.get_timezone)(i),o=(0,ne.cal_to_utc)(s,e);return(0,ne.utc_to_cal)(r,o)}language(){return window.language}getUserSpecificHash(){return window.user.private_channel||""}migrateFXCMCFDSettings(){ae.default.remove("fxcm_cfd")}async isFractional(e){return(0,Pe.isFractional)(e)}suppressedOrderQuestions(){const e=this._trading?.getBrokerTradingSettingsStorage()??null;return null===e?[]:e.getSuppressedQuestions()}saveOrderQuestions(e){const t=this._trading?.getBrokerTradingSettingsStorage()??null;null!==t&&t.setSuppressedQuestions(e)}resetOrderQuestions(){this._trading?.getBrokerTradingSettingsStorage()?.clearSuppressedQuestions()}_makeServerLoggerWithFilledInfo(e){return{log:t=>e.log({...this._makeServerLoggerEventAdditionalInfo(),...t}),debounceLog:(t,i,s)=>e.debounceLog({...this._makeServerLoggerEventAdditionalInfo(),...t},i,s)}}_makeServerLoggerEventAdditionalInfo(){return{accountType:this._adapter.currentAccountType(),brokerId:this._adapter.metainfo().id,sessionId:this._adapter.sessionId(),deviceId:getDeviceId(),ref:location.href,online:navigator.onLine,platform:getPlatform()}}_setDefaultDropdownActions(){null!==this._trading&&this._defaultDropdownActions&&(this._buttonDropdownActions=this.defaultDropdownMenuActions())}async _getOrderTicketSettings(){return(await(0,h.ensureNotNull)(this._trading).findOrCreateOrderViewController()).orderTicketSettings()}}var ke=i(891495);const Ce=(0,_.getLogger)("Trading.EncryptedWebStorage");class Te{constructor({prefix:e,storageName:t,storage:i,cryptographer:s}){this._transientStorage={},this._handleStorageStateChange=e=>{const{key:t,storageArea:i}=e;i===this._persistentStorage&&this._storageName===t&&this._decryptStorage()},this._storageName=t,this._prefix=e?.toLowerCase(),this._persistentStorage=i,this._cryptographer=s,this._decryptStorage=(0,ke.sequentialize)(this._decryptStorage),window.addEventListener("storage",this._handleStorageStateChange)}async setItem(e,t){const i=this._addPrefix(e);this._transientStorage[i]=JSON.stringify(t);try{await this._encryptStorageAndSave()}catch(e){Ce.logError(`Unable to save value using key ${i}: ${(0,T.getLoggerMessage)(e)}`)}}getItem(e,t=null){const i=this._transientStorage[this._addPrefix(e)];if(void 0===i)return t;if("string"!=typeof i)return i;try{return JSON.parse(i)}catch{return i}}async removeItem(e){delete this._transientStorage[this._addPrefix(e)],await this._encryptStorageAndSave()}destroy(){window.removeEventListener("storage",this._handleStorageStateChange)}static async create(e,t,i,s){const r=new Te({prefix:e,storageName:t,storage:i,
cryptographer:s});return await r._decryptStorage(),r}_addPrefix(e){return void 0!==this._prefix?`${this._prefix}.${e}`:e}async _decryptStorage(){const e=this._persistentStorage.getItem(this._storageName);if(null===e)return void(this._transientStorage={});const t=await this._cryptographer.decrypt(e);if(null===t)return this._persistentStorage.removeItem(this._storageName),void(this._transientStorage={});try{this._transientStorage=JSON.parse(t)}catch{this._transientStorage={}}}async _encryptStorageAndSave(){const e=await this._cryptographer.encrypt(JSON.stringify(this._transientStorage));this._persistentStorage.setItem(this._storageName,e)}}const we="credentials-storage";class Be{constructor(e,t,i){this._rememberCredentials=e,this._encryptedLocalStorage=t,this._encryptedSessionStorage=i}async save(e,t){this._currentEncryptedStorage().setItem(e,t)}load(e,t){return this._currentEncryptedStorage().getItem(e,t)}async clear(e){this._currentEncryptedStorage().removeItem(e)}destroy(){this._encryptedLocalStorage.destroy(),this._encryptedSessionStorage.destroy()}static async create(e,t,i){const s=await Te.create(e,we,localStorage,i),r=await Te.create(e,we,sessionStorage,i);return new Be(t,s,r)}_currentEncryptedStorage(){return this._rememberCredentials.value()?this._encryptedLocalStorage:this._encryptedSessionStorage}}var Oe=i(423075);const Me={excludeInstrumentForOrderModify:!1,isSuspended:!1,supportDemoLiveSwitcher:!0,supportModifyOrderPrice:!0,supportEditAmount:!0,supportModifyBrackets:!0,supportMarketBrackets:!0,supportMarketOrders:!0,supportStopOrders:!0,supportLimitOrders:!0,supportLeverageButton:!0,supportStopLimitOrders:!1,supportPositions:!0,supportDOM:!0,supportModifyTrailingStop:!0,supportAddBracketsToExistingOrder:!0,supportVerifyLiveAccount:!0,supportReversePosition:!0,showNotificationsLog:!0,supportPLUpdate:!0,supportTwoFactorAuthorization:!1,supportDisplayBrokerNameInSymbolSearch:!0,supportCurrencyInOrderPreview:!0,supportRiskControlsAndInfo:!0,supportCreateAccount:!1,supportDeleteAccount:!1,checkBracketsAfterOrderModification:!0,hideMarginIfNoLeverage:!1,supportStrictCheckingLimitOrderPrice:!1,supportOrdersHistory:!0,supportOrderBrackets:!1,supportPositionBrackets:!1,supportMultiposition:!1,supportClosePosition:!1,supportPartialClosePosition:!1,supportNativeReversePosition:!1,supportTrailingStop:!1,supportStopOrdersInBothDirections:!1,supportStopLimitOrdersInBothDirections:!1,supportModifyDuration:!1,supportCryptoExchangeOrderTicket:!1,supportPlaceOrderPreview:!1,supportModifyOrderPreview:!1,showQuantityInsteadOfAmount:!1,supportBalances:!1,supportExecutions:!0,supportLeverage:!1,supportLevel2Data:!1,supportTrackLatency:!1,supportPositionNetting:!1,supportIndividualPositionBrackets:!1,supportPartialCloseIndividualPosition:!1,supportStopLoss:!0,supportGuaranteedStop:!1,supportPartialOrderExecution:!1,supportDigitalSignature:!1,supportLogout:!1,supportCustomAccountSummaryRow:!1,supportPositionCustomFields:!1,supportOrderCustomFields:!1,supportOrderHistoryCustomFields:!1,supportCryptoBrackets:!1,
supportCloseIndividualPosition:!1,supportSymbolSearch:!1,supportMargin:!1,calculatePLUsingLast:!1,closePositionCancelsOrders:!1,supportOnlyPairPositionBrackets:!1,supportOnlyPairOrderBrackets:!1,supportConfirmations:!1,positionPLInInstrumentCurrency:!1,showRiskInInstrumentCurrency:!1,supportCancellingBothBracketsOnly:!1,supportUnformattedAvgFillPrice:!1,forceLogoutAfterUnauthorizedResponse:!1,forceLogoutAfterTooManyRequestsResponse:!1,useJsonContentType:!1,supportHyperlinksInOrderDialog:!1,supportHyperlinksInOrderPreview:!1,supportModifyPositionBrackets:!0,supportModifyOrderBrackets:!0,supportOAuthCodeFlowMultiplexing:!1,supportClearPositionsStateAfterStreamReconnect:!1,supportClearIndividualPositionsStateAfterStreamReconnect:!1,supportClearOrdersStateAfterStreamReconnect:!1,supportCustomOrderInfo:!1,supportPreviewClosePosition:!1,supportValidationAgainstMarket:!1,supportNotifications:!1,disableIsTradableCaching:!1,keepOriginalDurationOnOrderModification:!1,supportEditContexts:!0,supportCloseAllOrdersForSymbol:!1,supportClosingMultipleOrdersById:!1};class Ee{constructor(e,t){this._settingsKey=`trading.${e}.rememberCredentials`,this._trackEvent=t;const i=ae.default.getBool(this._settingsKey);void 0!==i&&(localStorage.setItem(this._settingsKey,JSON.stringify(i)),ae.default.remove(this._settingsKey))}value(){const e=localStorage.getItem(this._settingsKey);return null===e||Boolean(JSON.parse(e))}setValue(e){this._trackEvent?.("Don't remember me",String(!e)),localStorage.setItem(this._settingsKey,JSON.stringify(e))}}const Ie=[];function Ve(e,t){var i;e.configFlags=(i=e.configFlags,Object.assign({},Me,i)),Ie.push({metainfo:e,createBrokerFunction:t})}function $e(){return Ie.map((e=>e.metainfo))}let De;async function Le(e,t,i,s,r){const o=Ie.filter((e=>e.metainfo.id===t))[0];let n;if(null===s){const i=await Be.create(t,new Ee(t),De),s=r=>{r?.metainfo().id!==t&&(e?.onBrokerChange.unsubscribe(null,s),i.destroy())};e?.onBrokerChange.subscribe(null,s),n=i}else n=s;const a=new Se(e,o.metainfo,i,n);try{const t=await o.createBrokerFunction(a,e?.brokerTelemetry),i=new Oe.BrokerRealtimeAdapter(o.metainfo.id);return new oe({brokerMetainfo:o.metainfo,brokerConnection:t,host:a,brokerRealtimeAdapter:i,tradingStat:e&&e.tradingStat(),tradingSettingsStorageGetter:e&&e.getBrokerTradingSettingsStorage,brokerPlan:r})}catch(e){return Promise.reject(`${t} broker creation error: ${(0,T.getLoggerMessage)(e)}`)}}function xe(e){return $e().filter((t=>t.id===e))[0]}De={encrypt:async e=>e,decrypt:async e=>e}},483670:(e,t,i)=>{"use strict";i.d(t,{DialogVisibility:()=>o});var s=i(947488),r=i(218286);class o{constructor(){this._value$=new s.BehaviorSubject({isVisible:!1}),this.value$=this._value$.asObservable().pipe((0,r.distinctUntilChanged)(((e,t)=>e.isVisible===t.isVisible&&e.isFullScreen===t.isFullScreen)))}getValue(){return this._value$.getValue()}setValue(e){this._value$.next(e)}}},10857:(e,t,i)=>{"use strict";i.d(t,{DisabledConfirmations:()=>u});var s=i(748838),r=i(855385),o=i.n(r);var n=i(617998)
;const a=/[0-9]+([\.,][0-9]+)*([\.,][0-9]+)?|\.[0-9]+/gm,l=/[A-Z]+/gm,d=n.settingsKeys.DISABLED_CONFIRMATIONS;class u{add(e){const t=this._getAll(),i=this._makeMessageHash(e);t.add(i),s.default.setJSON(d,Array.from(t))}has(e){const t=this._getAll(),i=this._makeMessageHash(e);return t.has(i)}clear(){s.default.remove(d)}_getAll(){return new Set(s.default.getJSON(d))}_makeMessageHash(e){const t=e.replace(a,"").replace(l,"");return i=o()(t),btoa(String.fromCharCode.apply(null,new Uint8Array(i)));var i}}},469021:(e,t,i)=>{"use strict";function s(e){return"string"==typeof e?e:Array.isArray(e)?e.join(""):void 0}i.d(t,{makeConfirmation:()=>s})},828750:(e,t,i)=>{"use strict";i.d(t,{showSimpleConfirmDialog:()=>o});var s=i(298670),r=i(10857);async function o(e){const{showDisableConfirmationsCheckbox:t,text:o,onConfirm:n,onClose:a,onCancel:l,onOpen:d,abortSignal:u}=e,c=new r.DisabledConfirmations;if(t&&c.has(o))return Promise.resolve(!0);if(u?.aborted)return Promise.resolve(!1);const[{showSimpleDialog:h},{SimpleConfirmDialog:p}]=await Promise.all([Promise.all([i.e(7172),i.e(8894),i.e(5743),i.e(4495),i.e(9487),i.e(9323),i.e(159),i.e(683),i.e(1144),i.e(775),i.e(9658),i.e(7882),i.e(4952),i.e(5789),i.e(3905),i.e(3566)]).then(i.bind(i,480994)),Promise.all([i.e(7172),i.e(8894),i.e(5743),i.e(4495),i.e(9487),i.e(9323),i.e(159),i.e(683),i.e(1144),i.e(775),i.e(9658),i.e(7882),i.e(4952),i.e(5789),i.e(3905),i.e(3566)]).then(i.bind(i,20066))]);return new Promise(((t,i)=>{if(u?.aborted)return void i((0,s.createAbortError)());void 0!==d&&d();const r=h({...e,disabledConfirmations:c,onConfirm:e=>{t(!0),void 0!==n&&n(),e.dialogClose()},onClose:()=>{t(!1),void 0!==a&&a()},onCancel:e=>{t(!1),void 0!==l&&l(e),e.dialogClose()}},p);u?.addEventListener("abort",(()=>{r(),i((0,s.createAbortError)())}),{once:!0})}))}},464703:(e,t,i)=>{"use strict";i.d(t,{ConfirmBracketsCancelDialog:()=>o});var s=i(609838),r=i(828750);const o={get(){return this},open:(e,t)=>(0,r.showSimpleConfirmDialog)({title:s.t(null,void 0,i(937129)),text:s.t(null,void 0,i(970322)).replace("{orderId}",""!==e?e+" ":""),mainButtonIntent:"primary",abortSignal:t}),multiple:(e,t)=>(0,r.showSimpleConfirmDialog)({title:s.t(null,void 0,i(937129)),text:s.t(null,void 0,i(569850)).replace("{orderId}",""!==e?e+" ":""),mainButtonIntent:"primary",abortSignal:t})}},904958:(e,t,i)=>{"use strict";i.d(t,{ConfirmOrderCancelDialog:()=>n});i(460351);var s=i(609838),r=i(828750),o=i(760775);const n={get(){return this},open:(e,t)=>(0,r.showSimpleConfirmDialog)({title:s.t(null,void 0,i(719634)),text:s.t(null,void 0,i(223615)).replace("{orderId}",e),mainButtonIntent:"primary",abortSignal:t}),multiple(e,t,n,a){let l=(0,o.getSymbolNameOverFullname)(e);if(void 0!==t){l=`${l} ${1===t?s.t(null,void 0,i(846369)):s.t(null,void 0,i(424426))}`}return(0,r.showSimpleConfirmDialog)({title:s.t(null,void 0,i(719634)),text:s.t(null,void 0,i(333739)).replace("{qty}",String(n)).replace("{side}",l),mainButtonIntent:"primary",abortSignal:a})}}},782860:(e,t,i)=>{"use strict";i.d(t,{reversePositionDialog:()=>n})
;var s=i(609838),r=i(828750),o=i(760775);async function n(e){const{positionId:t,showErrorNotification:n,handler:a,closePositionCancelsOrders:l,abortSignal:d,closePositionCancelsOrdersMessage:u=s.t(null,void 0,i(352355))}=e,c=(0,o.getSymbolNameOverFullname)(t);if(!await(0,r.showSimpleConfirmDialog)({title:s.t(null,void 0,i(178170)).replace("{positionId}",c),text:s.t(null,void 0,i(431110)).replace("{positionId}",c)+(l?" "+u:""),mainButtonText:s.t(null,void 0,i(360196)),mainButtonIntent:"primary",cancelButtonText:s.t(null,void 0,i(904543)),showBackdrop:!0,abortSignal:d}))return!1;try{return await a()}catch(e){return n(s.t(null,void 0,i(628412)),function(e){let t="";null!==e&&"object"==typeof e&&e.message?t=e.message:"string"==typeof e&&(t=e);return t}(e)),!1}}},386848:(e,t,i)=>{"use strict";i.d(t,{checkIsDOMAvailable:()=>r});var s=i(534934);function r(){return s.enabled("dom_widget")&&!0}},923978:(e,t,i)=>{"use strict";i.d(t,{formatInfoValue:()=>a});var s=i(441219),r=i(621363),o=i(209957),n=i(773743);function a(e){const t=(0,s.numberFormattersParsersChain)({chain:[(0,r.prohibitNanOnParseStep)(),(0,o.fixedNumberMagnitudeStep)({decimalPlaces:2}),(0,n.signumStep)({negativeSign:n.longMinusSign})]});return Number.isInteger(e)||e>=1?t.format(e):function(e){if(Number.isInteger(e))return e+"";return e<1?function(e){const t=(e+"").split(".")[1]||"";let i=t.length;for(let e=0;e<t.length;e++)if("0"!==t[e]){i=e+1;break}return e.toFixed(i)}(e):e.toFixed(2)}(e)}},28156:(e,t,i)=>{"use strict";i.d(t,{HeaderContainer:()=>se,mountHeader:()=>re,unmountHeader:()=>oe});var s,r=i(50959),o=i(632227),n=i(32133),a=i(661851),l=i(497754),d=i.n(l),u=i(972535),c=i(595943),h=i(229144),p=i(965800),_=i(363111),g=i(763281),y=i(609838),b=i(878112),m=i(152601),v=i(925286),f=(i(241032),i(930202)),P=i(273388),S=i(650733),k=i(588714),C=i(73221),T=i(871645),w=i(512646),B=i(552828),O=i(632379);!function(e){e[e.Delayed=0]="Delayed",e[e.DelayedWithOffer=1]="DelayedWithOffer",e[e.Bats=2]="Bats"}(s||(s={}));const M=y.t(null,void 0,i(28117)),E=y.t(null,void 0,i(668510)),I=y.t(null,void 0,i(295271)),V=(y.t(null,void 0,i(327741)),{0:w,1:w,2:B}),$={0:O.delayedDataIcon,1:O.delayedDataIcon,2:O.batsQuotesIcon},D={0:O.delayedDataTitleColor,1:O.delayedDataTitleColor,2:O.batsQuotesTitleColor};function L(e){const{statusType:t,symbol:i,onClick:s}=e;return r.createElement(r.Fragment,null)}function x(){return r.createElement(r.Fragment,null,M)}function A(e){const{symbol:t}=e,i=useIsRealTimeAvailable(t)?E:I;return r.createElement(r.Fragment,null,i)}function q(e){const{symbol:t}=e,[i,s]=t.split(":"),o=S.batsToRealtimeHtml1.replace("{symbolName}",s).replace("{exchange}",S.notAccurateCboeTooltip),n=S.batsToRealtimeHtml2WithExchange.replace("{exchange}",i);return r.createElement(r.Fragment,null,`${o} ${n}`)}function R(e){const{statusType:t,symbol:i}=e;switch(t){case 0:return r.createElement(x,null);case 1:return r.createElement(A,{symbol:i});case 2:return r.createElement(q,{symbol:i});default:return r.createElement(r.Fragment,null)}}function F(e){return r.createElement("span",{
className:O.text},r.createElement(R,{...e}))}function N(e){const{statusType:t,symbol:s,reference:o,...n}=e,{isOpen:a,onClose:l,anchorButtonRef:u,onOpen:c}=(0,v.useDefaultButtonAnchorProps)();if(!s)return r.createElement(r.Fragment,null);const h=function(e,t){switch(e){case 0:case 1:return y.t(null,void 0,i(759158));case 2:{const[e]=t.split(":");return(0,T.htmlEscape)(S.exchangeByOriginalExchangeTooltip).format({exchange:e,originalExchange:S.notAccurateCboeTooltip})}default:return""}}(t,s);return r.createElement(r.Fragment,null,r.createElement(k.ClickableIconButton,{...n,ref:(0,P.mergeRefs)([u,o]),role:"button",colorClassName:O.button,iconClassName:d()(O.icon,$[t]),title:h,icon:V[t],onClick:function(e){e.stopPropagation(),c()},onKeyDown:function(e){switch(a&&(e.stopPropagation(),e.preventDefault()),(0,f.hashFromEvent)(e)){case 27:a&&l(!0);break;case 32:case 13:a||(e.stopPropagation(),e.preventDefault(),c())}}}),r.createElement(m.PopoverKeyboardNavigator,{anchored:{type:"element",at:u},isOpen:a,onClose:l,closeOnClickAway:!0,closeOnScrollOutside:!0,mobileBreakpoint:C.TradingLayoutBreakpoint.Mobile},r.createElement("div",{className:O.wrapper,onKeyDown:function(e){if(e.stopPropagation(),e.preventDefault(),27===(0,f.hashFromEvent)(e))l(!0)}},r.createElement(b.Icon,{icon:V[t],className:d()(O.icon,$[t])}),r.createElement("div",{className:O.infoContainer},r.createElement("span",{className:O.title,style:{color:D[t]}},h),r.createElement(F,{statusType:t,symbol:s}),r.createElement(L,{statusType:t,symbol:s,onClick:()=>l(!0)})))))}var Q=i(898237),U=i(820660),W=i(513729);function z({closeHandler:e}){const t=(0,U.useEnterAndSpaceKeyDownHandler)(e);return r.createElement(Q.LightButton,{iconOnly:!0,onClick:e,"data-name":"button-close","aria-label":y.t(null,void 0,i(945233)),size:"small",onKeyDown:t,variant:"quiet-primary",startSlot:r.createElement(b.Icon,{icon:W}),title:y.t(null,{context:"action"},i(433334))})}var j=i(528457),H=i(723991),G=i(354648);const K=e=>{const{value$:t,onIcon:i,onClick:s,offIcon:o,onLabel:n,offLabel:l,dataName:d}=e,u=(0,a.useObservable)(t);return r.createElement(H.PopoverItem,{onClick:s,"data-name":d,title:u?n:l,leftSlot:r.createElement(G.SvgIconPopoverItemPart,{icon:u?i:o})})};var Y=i(778240);const X=e=>{const{label:t,value$:i,onClick:s,dataName:o}=e,n=(0,a.useObservable)(i);return r.createElement(Y.CheckboxPopoverItem,{title:t,onClick:s,checked:n??!1,"data-name":o,ariaChecked:n})};var J=i(29834);const Z=({settings:e,isFocused:t})=>{const s=(0,r.useRef)(null),{isOpen:o,onOpen:n,onClose:a}=(0,j.useRootPopoverOpenState)(s);(0,r.useEffect)((()=>{t&&s.current?.focus()}),[t]);const l=(0,r.useMemo)((()=>e.map((e=>0===e.settingType?r.createElement(X,{key:e.label,...e}):r.createElement(K,{key:e.onLabel,...e})))),[e]);return r.createElement(r.Fragment,null,r.createElement(c.Tooltip,{isRtl:(0,h.isRtl)(),trigger:u.mobiletouch?[c.Trigger.Focus]:[c.Trigger.Hover,c.Trigger.Focus],content:y.t(null,void 0,i(232514))},r.createElement(Q.LightButton,{iconOnly:!0,isActive:o,reference:s,onClick:function(){o?a(!0):n()},size:"small",
onKeyDown:function(e){13===(0,f.hashFromEvent)(e)&&e.stopPropagation()},"data-name":"header-settings",variant:"quiet-primary",startSlot:r.createElement(b.Icon,{icon:J})})),r.createElement(m.PopoverKeyboardNavigator,{isOpen:o,onClose:a,anchored:{at:s,type:"element"}},r.createElement("div",{"data-name":"popup-menu-container"},l)))};var ee=i(593854);u.mobiletouch||c.Trigger.Hover,c.Trigger.Focus;function te(e){const{settings:t,title:i,symbol:s,hasDelayedWarning:o,hasBatsQuotes:n,informerMessage:a,brokerId:l,close:u,orderPresetsManagerConsumer:c,getOrderTemplate:h,isTradable:y,isSendingDisabled:b,applyOrderTemplate:m,focusedControl:v,brokerLogo:f,brokerName:P,accountType:S}=e,k=(0,r.useContext)(g.WidgetContext);(0,p.useTheme)();let C;o&&(C={statusType:"Paper"===l?1:0,symbol:s}),n&&(C={statusType:2,symbol:s});const T=k.mode===_.OrderEditorDisplayMode.Popup?{"data-dragg-area":!0}:{},w=!1;return r.createElement("div",{className:ee.header},r.createElement("div",{className:ee.wrapper,...T},!1,r.createElement("span",{className:d()(ee.title,"apply-overflow-tooltip"),title:i},i),(void 0!==a||void 0!==C)&&r.createElement("div",{className:ee.statusLine},void 0!==a&&r.createElement(TradingInformer,{informerMessage:a}),void 0!==C&&r.createElement(N,{...C}))),w,void 0!==t&&t.length>0&&r.createElement(Z,{settings:t,isFocused:1===v}),void 0!==u&&r.createElement(z,{closeHandler:u}))}function ie(e){return e.description?r.createElement("div",{className:ee.headerContainer},r.createElement(te,{...e}),r.createElement("div",{className:ee.description},e.description)):r.createElement(te,{...e})}function se(e){const{title$:t,description$:i,closeFunction$:s,orderTemplateFunction$:o,informerMessage$:l,symbol$:d,hasBatsQuotes$:u,hasDelayedQuotes$:c,isTradable$:h,settings$:p,brokerId$:_,orderPresetsManagerConsumer$:g,isSendingDisabled$:y,applyOrderTemplateFunction$:b,focusedControl$:m,brokerLogo$:v,brokerName$:f,accountType$:P}=e,S=(0,a.useObservable)(t),k=(0,a.useObservable)(i),C=(0,a.useObservable)(b),T=(0,a.useObservable)(s),w=(0,a.useObservable)(o),B=(0,a.useObservable)(d),O=(0,a.useObservable)(u),M=(0,a.useObservable)(c),E=(0,a.useObservable)(h),I=((0,a.useObservable)(l),(0,a.useObservable)(_)),V=(0,a.useObservable)(P),$=(0,a.useObservable)(y),D=(0,a.useObservable)(g),L=(0,a.useObservable)(m),x=(0,a.useObservable)(p),A=(0,a.useObservable)(v),q=(0,a.useObservable)(f),R=(0,r.useMemo)((()=>void 0!==T?()=>{(0,n.trackEvent)("GUI","Close Order Panel from panel"),T()}:void 0),[T]);return r.createElement(ie,{title:S||"",description:k,symbol:B??"",settings:void 0!==x&&E?x:void 0,brokerId:I,hasDelayedWarning:M,hasBatsQuotes:O,isTradable:E,informerMessage:void 0,close:R,orderPresetsManagerConsumer:D,getOrderTemplate:w,isSendingDisabled:$,applyOrderTemplate:C,focusedControl:L,brokerLogo:A,brokerName:q,accountType:V})}function re(e,t){o.render(r.createElement(se,{...t}),e)}function oe(e){o.unmountComponentAtNode(e)}},324889:(e,t,i)=>{"use strict";i.d(t,{makeObservableFromWatchedValue:()=>r});var s=i(275734);function r(e){return(0,
s.fromEventPattern)((t=>e.subscribe(t,{callWithLast:!0})),(t=>e.unsubscribe(t)))}},523090:(e,t,i)=>{"use strict";i.d(t,{alignQuotesToMinTick:()=>b,calculatePipValue:()=>h,calculateQty:()=>p,calculatedMarginRatio:()=>_,checkPriceByOrderType:()=>m,convertToBaseMonetaryUnit:()=>P,formatRiskReward:()=>y,prepareCalculatorEventText:()=>v,prepareTradableSolution:()=>f,shouldShowTotal:()=>c,simplifyControlErrorFormat:()=>S,simplifyControlErrorObservableFormat:()=>k});var s=i(609838),r=i(551442),o=i(960521),n=i(997345),a=i(760775),l=i(611821),d=i(600297),u=i(130557);function c(e){return void 0!==e&&Boolean(e.showTotal)}function h(e,t,i){return null!==e?(void 0!==i?e*i:e)*t:0}function p(e,t,i,s,r){return(0,o.Big)(e).mul(s).div(i).div(t).div(r||1).toNumber()}function _(e,t){if(t<0)return 100;const i=0!==t?100*e/t:0;return i>100?100:i}const g=(0,l.getVolumeFormatter)(2);function y(e,t){const i=null!==e&&null!==t?e/t:0;return i>0?g.format(i):""}function b(e,t,i){const s=Object.assign({},e);return["trade","ask","bid"].forEach((e=>{const r=s[e];if(void 0!==r){const o=(0,u.getMinTick)({minTick:t,price:r,variableMinTickData:i});s[e]=(0,a.alignToMinTick)(r,o)}})),s}function m(e,t,i){return 4===e?null===t||null===i:3===e?null===i:null===t}function v(e,t){switch(t){case d.ButtonType.IncDec:return e<0?"-":"+";case d.ButtonType.PlusValue:return String(e);case d.ButtonType.Clear:return"Clear";default:return"Default"}}async function f(e,t){if(void 0!==e.solutions){if("changeSymbol"in e.solutions){const t=e.solutions.changeSymbol;return{title:s.t(null,void 0,i(531410)),apply:()=>r.linking.setSymbolAndLogInitiator(t,"order ticket")}}if("changeAccount"in e.solutions){const r=e.solutions.changeAccount,o=(await t.accountsMetainfo()).filter((e=>e.id===r))[0].name;return{title:s.t(null,void 0,i(704707)).replace("{accountName}",o),apply:()=>t.setCurrentAccount(r)}}if("openUrl"in e.solutions){const t=e.solutions.openUrl.url;return{title:e.solutions.openUrl.text,apply:()=>window.open(t,"_blank")}}}}function P(e,t){return void 0===t?e:(0,o.Big)(e).div(t).toNumber()}function S(e,t){return e.res&&t.includes(e.severity)}function k(e,t){return e.pipe((0,n.map)((e=>S(e,t))))}},802672:(e,t,i)=>{"use strict";i.r(t),i.d(t,{OrderViewController:()=>ci,isResizableDrawerEnabled:()=>ai});var s=i(748838),r=(i(601227),i(650151)),o=i(737538),n=i(947488),a=i(116217),l=i(138966),d=i(771035),u=i(177441);function c(e){return(0,a.operate)((function(t,i){(0,d.innerFrom)(e).subscribe(new l.OperatorSubscriber(i,(function(){return i.complete()}),u.noop)),!i.closed&&t.subscribe(i)}))}var h=i(173587),p=i(851387),_=i(446685),g=i(472484),y=i(595940);function b(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=(0,y.popResultSelector)(e);return(0,a.operate)((function(t,s){for(var r=e.length,o=new Array(r),n=e.map((function(){return!1})),a=!1,c=function(t){(0,d.innerFrom)(e[t]).subscribe(new l.OperatorSubscriber(s,(function(e){o[t]=e,a||n[t]||(n[t]=!0,(a=n.every(g.identity))&&(n=null))}),u.noop))},h=0;h<r;h++)c(h);t.subscribe(new l.OperatorSubscriber(s,(function(e){
if(a){var t=(0,_.__spreadArray)([e],(0,_.__read)(o),!1);s.next(i?i.apply(void 0,(0,_.__spreadArray)([],(0,_.__read)(t),!1)):t)}})))}))}var m=i(997345),v=i(671945),f=i(180185),P=i(698043),S=i(534934),k=i(17076),C=i(609838),T=i(503503),w=i(275734),B=i(757604),O=i(312694),M=i(265728),E=i(26722);var I={connector:function(){return new o.Subject},resetOnDisconnect:!0};function V(e,t){void 0===t&&(t=I);var i=null,s=t.connector,r=t.resetOnDisconnect,o=void 0===r||r,n=s(),a=new E.Observable((function(e){return n.subscribe(e)}));return a.connect=function(){var t;return i&&!i.closed||(i=(t=function(){return e},new E.Observable((function(e){(0,d.innerFrom)(t()).subscribe(e)}))).subscribe(n),o&&i.add((function(){return n=s()}))),i},a}var $=i(169977),D=i(749401),L=i(958261),x=i(233064),A=i(586639),q=i(721762),R=i(894862),F=i(363111),N=i(760775),Q=i(160471),U=i(996038),W=i(284170),z=i(627692),j=i(932473),H=i(144421),G=i(130557),K=i(958607),Y=i(218286);class X{constructor(e){const{inputType$:t,inputUnits$:i,inputValue$:s,converters:r}=e;this._inputType$=t,this._inputValue$=s,this._convertedValues$=new M.ReplaySubject(1),this.convertedValues$=this._convertedValues$.asObservable(),this._units$=new M.ReplaySubject(1),this._converters=r,this._unitsSubscription=t.pipe((0,x.switchMap)((e=>"units"===e?i:this._converters[e]?.units$??(0,A.of)(null))),(0,Y.distinctUntilChanged)()).subscribe((e=>{this._units$.next(e)})),this._subscribe()}destroy(){this._unitsSubscription.unsubscribe(),this._convertedValuesSubscription?.unsubscribe();for(const e of Object.values(this._converters))e.destroy()}_subscribe(){const e={units:this._units$};for(const[t,i]of Object.entries(this._converters))e[t]=i.value$,i.start({isValueInputActive$:this._inputType$.pipe((0,m.map)((e=>e===t)),(0,Y.distinctUntilChanged)()),unitsInput$:(0,L.combineLatest)({inputType:this._inputType$,inputValue:this._units$}).pipe((0,$.filter)((e=>e.inputType!==t)),(0,m.map)((e=>e.inputValue)),(0,Y.distinctUntilChanged)()),valueInput$:(0,L.combineLatest)({inputType:this._inputType$,inputValue:this._inputValue$}).pipe((0,$.filter)((e=>e.inputType===t)),(0,m.map)((e=>e.inputValue)),(0,Y.distinctUntilChanged)())});this._convertedValuesSubscription=(0,L.combineLatest)(e).pipe((0,Y.distinctUntilChanged)(((e,t)=>(0,H.deepEquals)(e,t)[0]))).subscribe((e=>{const{units:t,...i}=e,s={units:e.units};for(const[e,t]of Object.entries(i))s[e]=t;this._convertedValues$.next(s)}))}}class J{constructor(e){this._subscriptions=[],this._qtySuggester=e.qtySuggester,this._symbol=e.symbol,this._setInputTypeAndValue=e.setInputTypeAndValue,this._converter=new X(e.converterParams),this.convertedValues$=this._converter.convertedValues$,e.existingOrder||this._subscribe()}destroy(){for(const e of this._subscriptions)e.unsubscribe();this._subscriptions=[],this._converter.destroy()}_subscribe(){let e=!1;this._subscriptions=[this._converter.convertedValues$.subscribe((t=>{t.units&&(e=!0,this._qtySuggester.setQty(this._symbol,t.units),e=!1)})),this._qtySuggester.suggestedQtyChanged(this._symbol).pipe((0,
h.skip)(1)).subscribe((t=>{e||this._setInputTypeAndValue("units",t)}))]}}var Z=i(960521),ee=i.n(Z),te=i(523090);i(150335);function ie(e,t,i,s,r){return se(e,t,i/s,r)}function se(e,t,i,s){return(0,Z.Big)(e).mul(t).mul(i).mul(s||1).toNumber()}function re(e,t){return null===e?void 0!==t&&t>0?t:1:0!==e.leverage?ee()(1).div(e.leverage).toNumber():1}class oe{constructor(e){this._units$=new n.BehaviorSubject(null),this._value$=new n.BehaviorSubject(null),this._subscriptions=[],this._pricePerUnit$=e.pricePerUnit$,this._pipValue$=e.pipValue$,this._leverageInfo$=e.leverageInfo$,this._instrumentInfo=e.instrumentInfo,this._priceMagnifier=this._instrumentInfo.priceMagnifier,this.value$=this._value$.asObservable(),this.units$=this._units$.asObservable()}start(e){const{pipSize:t,lotSize:i,type:s,marginRate:r}=this._instrumentInfo;this._subscriptions=[(0,L.combineLatest)({isValueInputActive:e.isValueInputActive$,input:e.valueInput$,pricePerUnit:this._pricePerUnit$,pipValue:this._pipValue$,leverageInfo:this._leverageInfo$}).subscribe((e=>{const{isValueInputActive:o,input:n,pricePerUnit:a,pipValue:l,leverageInfo:d}=e;if(!o)return;if(null===n)return void this._units$.next(null);if(0===a)return;const u=re(d,r),c=(0,Z.Big)(n).div(u),h="crypto"===s?c.div(a).toNumber():(0,te.calculateQty)(c.toNumber(),a,l,t,i),p=(0,Z.Big)(h).mul(this._priceMagnifier??1).toNumber();this._value$.next(n),this._units$.next(p)})),(0,L.combineLatest)({isValueInputActive:e.isValueInputActive$,input:e.unitsInput$,pricePerUnit:this._pricePerUnit$,pipValue:this._pipValue$,leverageInfo:this._leverageInfo$}).subscribe((e=>{const{isValueInputActive:o,input:n,pricePerUnit:a,pipValue:l,leverageInfo:d}=e;if(o)return;if(null===n)return void this._value$.next(null);const u=re(d,r),c=(0,Z.Big)(n).mul(u),h="crypto"===s?c.mul(a).toNumber():ie(c.toNumber(),a,l,t,i),p=(0,te.convertToBaseMonetaryUnit)(h,this._priceMagnifier);this._value$.next(p)}))]}destroy(){for(const e of this._subscriptions)e.unsubscribe()}}function ne(e,t){return t?(0,Z.Big)(e).mul(t).toNumber():0}class ae{constructor(e){this._units$=new n.BehaviorSubject(null),this._value$=new n.BehaviorSubject(null),this._subscriptions=[],this._valueFormatter=e.valueFormatter,this._equity$=e.equity$,this._pricePerUnit$=e.pricePerUnit$,this._leverageInfo$=e.leverageInfo$,this._pipValue$=e.pipValue$,this._instrumentInfo=e.instrumentInfo,this.value$=this._value$.asObservable(),this.units$=this._units$.asObservable()}start(e){const{pipSize:t,lotSize:i,type:s,marginRate:r}=this._instrumentInfo;this._subscriptions=[(0,L.combineLatest)({isValueInputActive:e.isValueInputActive$,input:e.valueInput$,equity:this._equity$,pricePerUnit:this._pricePerUnit$,pipValue:this._pipValue$,leverageInfo:this._leverageInfo$}).subscribe((e=>{if(!e.isValueInputActive)return;const{input:o,equity:n,pricePerUnit:a,pipValue:l,leverageInfo:d}=e;if(null===o)return void this._units$.next(null);if(0===a)return;const u=re(d,r),c=(0,Z.Big)(o).mul(n).div(100).div(u),h="crypto"===s?c.div(a).toNumber():(0,te.calculateQty)(c.toNumber(),a,l,t,i)
;this._value$.next((0,N.applyRounding)(o,this._valueFormatter)),this._units$.next(h)})),(0,L.combineLatest)({isValueInputActive:e.isValueInputActive$,input:e.unitsInput$,equity:this._equity$,pricePerUnit:this._pricePerUnit$,pipValue:this._pipValue$,leverageInfo:this._leverageInfo$}).subscribe((e=>{if(e.isValueInputActive)return;const{input:o,equity:n,pricePerUnit:a,pipValue:l,leverageInfo:d}=e;if(null===o||0===n)return void this._value$.next(null);const u=re(d,r),c="crypto"===s?(0,Z.Big)(o).mul(a).toNumber():ie(o,a,l,t,i),h=(0,Z.Big)(100).mul(ne(c,u)).div(n).toNumber();this._value$.next((0,N.applyRounding)(h,this._valueFormatter))}))]}destroy(){for(const e of this._subscriptions)e.unsubscribe()}}class le{constructor(e){this._units$=new n.BehaviorSubject(null),this._value$=new n.BehaviorSubject(null),this._subscriptions=[],this._pipValue$=e.pipValue$,this._stopLossPips$=e.stopLossPips$,this._instrumentInfo=e.instrumentInfo,this._priceMagnifier=this._instrumentInfo.priceMagnifier,this.value$=this._value$.asObservable(),this.units$=this._units$.asObservable()}start(e){const{lotSize:t,qty:{step:i}}=this._instrumentInfo;this._subscriptions=[(0,L.combineLatest)({isValueInputActive:e.isValueInputActive$,input:e.valueInput$,stopLossPips:this._stopLossPips$,pipValue:this._pipValue$}).subscribe((e=>{if(!e.isValueInputActive)return;const{input:s,stopLossPips:r,pipValue:o}=e;if(null===s||null===r)return void this._units$.next(null);const n=function(e){const{pips:t,lotSize:i,pipValue:s,riskInCurrency:r,priceMagnifier:o}=e;return t?(0,Z.Big)(r).mul(o||1).div(t).div(s).div(i||1).toNumber():0}({step:i,lotSize:t,pipValue:o,pips:r,riskInCurrency:s,priceMagnifier:this._priceMagnifier});this._value$.next(s),this._units$.next(n)})),(0,L.combineLatest)({isValueInputActive:e.isValueInputActive$,input:e.unitsInput$,stopLossPips:this._stopLossPips$,pipValue:this._pipValue$}).subscribe((e=>{if(e.isValueInputActive)return;const{input:i,stopLossPips:s,pipValue:r}=e;if(null===i||null===s)return void this._value$.next(null);const o=function(e){const{pips:t,amount:i,lotSize:s,pipValue:r,priceMagnifier:o}=e;return(0,Z.Big)(t).mul(r).mul(i).mul(s||1).div(o||1).toNumber()}({amount:i,pips:s,pipValue:r,priceMagnifier:this._priceMagnifier,lotSize:t});this._value$.next(o)}))]}destroy(){for(const e of this._subscriptions)e.unsubscribe()}}class de{constructor(e){this._units$=new n.BehaviorSubject(null),this._value$=new n.BehaviorSubject(null),this._subscriptions=[],this._pipValue$=e.pipValue$,this._equity$=e.equity$,this._stopLossPips$=e.stopLossPips$,this._instrumentInfo=e.instrumentInfo,this._valueFormatter=e.valueFormatter,this.value$=this._value$.asObservable(),this.units$=this._units$.asObservable()}start(e){const{lotSize:t,qty:{step:i},priceMagnifier:s}=this._instrumentInfo;this._subscriptions=[(0,L.combineLatest)({isValueInputActive:e.isValueInputActive$,input:e.valueInput$,stopLossPips:this._stopLossPips$,pipValue:this._pipValue$,equity:this._equity$}).subscribe((e=>{if(!e.isValueInputActive)return
;const{input:r,stopLossPips:o,pipValue:n,equity:a}=e;if(null===r||null===o)return void this._units$.next(null);const l=function(e){const{step:t,pips:i,equity:s,lotSize:r,pipValue:o,riskInPercent:n,priceMagnifier:a}=e;if(!i)return 0;const l=function(e,t){return e.div(t).round(0,0).mul(t)}((0,Z.Big)(n).mul(a||1).mul(s).div(i).div(o).div(r||1).div(100),t);return l.toNumber()}({step:i,equity:a,lotSize:t,pipValue:n,priceMagnifier:s,pips:o,riskInPercent:r});this._value$.next((0,N.applyRounding)(r,this._valueFormatter)),this._units$.next(l)})),(0,L.combineLatest)({isValueInputActive:e.isValueInputActive$,input:e.unitsInput$,stopLossPips:this._stopLossPips$,pipValue:this._pipValue$,equity:this._equity$}).subscribe((e=>{if(e.isValueInputActive)return;const{input:i,stopLossPips:r,pipValue:o,equity:n}=e;if(null===i||null===r)return void this._value$.next(null);const a=function(e){const{pips:t,amount:i,equity:s,lotSize:r,pipValue:o,priceMagnifier:n}=e;return s&&i?(0,Z.Big)(t).mul(o).mul(i).mul(r||1).mul(100).div(s).div(n||1).toNumber():0}({equity:n,lotSize:t,pipValue:o,amount:i,priceMagnifier:s,pips:r});this._value$.next((0,N.applyRounding)(a,this._valueFormatter))}))]}destroy(){for(const e of this._subscriptions)e.unsubscribe()}}var ue=i(992282),ce=i(346502);function he(){return(0,a.operate)((function(e,t){var i,s=!1;e.subscribe(new l.OperatorSubscriber(t,(function(e){var r=i;i=e,s&&t.next([r,e]),s=!0})))}))}var pe=function(e){function t(t,i){return e.call(this)||this}return(0,_.__extends)(t,e),t.prototype.schedule=function(e,t){return void 0===t&&(t=0),this},t}(i(303448).Subscription),_e={setInterval:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=_e.delegate;return((null==i?void 0:i.setInterval)||setInterval).apply(void 0,(0,_.__spreadArray)([],(0,_.__read)(e),!1))},clearInterval:function(e){var t=_e.delegate;return((null==t?void 0:t.clearInterval)||clearInterval)(e)},delegate:void 0},ge=i(3955),ye=function(e){function t(t,i){var s=e.call(this,t,i)||this;return s.scheduler=t,s.work=i,s.pending=!1,s}return(0,_.__extends)(t,e),t.prototype.schedule=function(e,t){if(void 0===t&&(t=0),this.closed)return this;this.state=e;var i=this.id,s=this.scheduler;return null!=i&&(this.id=this.recycleAsyncId(s,i,t)),this.pending=!0,this.delay=t,this.id=this.id||this.requestAsyncId(s,this.id,t),this},t.prototype.requestAsyncId=function(e,t,i){return void 0===i&&(i=0),_e.setInterval(e.flush.bind(e,this),i)},t.prototype.recycleAsyncId=function(e,t,i){if(void 0===i&&(i=0),null!=i&&this.delay===i&&!1===this.pending)return t;_e.clearInterval(t)},t.prototype.execute=function(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var i=this._execute(e,t);if(i)return i;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},t.prototype._execute=function(e,t){var i,s=!1;try{this.work(e)}catch(e){s=!0,i=e||new Error("Scheduled action threw falsy error")}if(s)return this.unsubscribe(),i},t.prototype.unsubscribe=function(){if(!this.closed){
var t=this.id,i=this.scheduler,s=i.actions;this.work=this.state=this.scheduler=null,this.pending=!1,(0,ge.arrRemove)(s,this),null!=t&&(this.id=this.recycleAsyncId(i,t,null)),this.delay=null,e.prototype.unsubscribe.call(this)}},t}(pe),be=function(e){function t(t,i){var s=e.call(this,t,i)||this;return s.scheduler=t,s.work=i,s}return(0,_.__extends)(t,e),t.prototype.schedule=function(t,i){return void 0===i&&(i=0),i>0?e.prototype.schedule.call(this,t,i):(this.delay=i,this.state=t,this.scheduler.flush(this),this)},t.prototype.execute=function(t,i){return i>0||this.closed?e.prototype.execute.call(this,t,i):this._execute(t,i)},t.prototype.requestAsyncId=function(t,i,s){return void 0===s&&(s=0),null!=s&&s>0||null==s&&this.delay>0?e.prototype.requestAsyncId.call(this,t,i,s):t.flush(this)},t}(ye),me=i(712813),ve=function(){function e(t,i){void 0===i&&(i=e.now),this.schedulerActionCtor=t,this.now=i}return e.prototype.schedule=function(e,t,i){return void 0===t&&(t=0),new this.schedulerActionCtor(this,e).schedule(i,t)},e.now=me.dateTimestampProvider.now,e}(),fe=function(e){function t(t,i){void 0===i&&(i=ve.now);var s=e.call(this,t,i)||this;return s.actions=[],s._active=!1,s._scheduled=void 0,s}return(0,_.__extends)(t,e),t.prototype.flush=function(e){var t=this.actions;if(this._active)t.push(e);else{var i;this._active=!0;do{if(i=e.execute(e.state,e.delay))break}while(e=t.shift());if(this._active=!1,i){for(;e=t.shift();)e.unsubscribe();throw i}}},t}(ve),Pe=new(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return(0,_.__extends)(t,e),t}(fe))(be),Se=i(195321),ke=i(502586),Ce=i(166554);class Te{constructor(e){this._formatter=e}format(e,t){return this._formatter.format(e,{...t,ignoreLocaleNumberFormat:!0,noExponentialForm:!0})}parse(e,t){return this._formatter.parse?this._formatter.parse(e,{...t,ignoreLocaleNumberFormat:!0}):{res:!1,error:"Formatter does not support parse"}}}function we(e){const{currency:t,symbolType:s,parentType:r,bracketType:o,priceEquivalentType:n}=e;switch(n){case"Pips":return{title:"forex"===s?C.t(null,void 0,i(394408)):C.t(null,void 0,i(824821)),type:n};case"RiskInCurrency":return{title:o===R.BracketType.TakeProfit?C.t(null,{replace:{currency:t}},i(262527)):C.t(null,{replace:{currency:t}},i(63076)),type:n};case"RiskInPercent":return{title:o===R.BracketType.TakeProfit?C.t(null,void 0,i(331789)):C.t(null,void 0,i(65868)),type:n,informerText:C.t(null,void 0,i(40702))};case"ParentPricePercent":return{title:C.t(null,void 0,i(697114)),type:n,isNew:!0,informerText:1===r?C.t(null,void 0,i(963989)):C.t(null,void 0,i(982133))};default:return}}const Be={Pips:F.BracketSubControlType.Pips,RiskInCurrency:F.BracketSubControlType.Money,RiskInPercent:F.BracketSubControlType.Percent,ParentPricePercent:F.BracketSubControlType.ParentPricePercent},Oe={Pips:1,RiskInCurrency:.01,RiskInPercent:.01,ParentPricePercent:.01};function Me({error:e,controlError:t}){return t.res?t:e}function Ee(e,t){const i={res:e};return e&&(i.severity="error"),t&&(i.msg=t),i}var Ie;!function(e){
e.makeInitialSLPrice=e=>e.trailingStopPips||e.stopType===q.StopType.TrailingStop?null:e.guaranteedStop||e.stopType===q.StopType.GuaranteedStop?e.guaranteedStop??null:e.stopLoss??null,e.makeInitialSLPips=e=>e.trailingStopPips??e.stopLossPips??null,e.makeInitialSLRiskInPercent=e=>e.riskInPercent??null,e.makeInitialSLParentPricePercent=e=>e.parentPricePercent??null,e.makeInitialSLEnabled=e=>Boolean(e.riskInPercent||e.trailingStopPips||e.stopLossPips||e.guaranteedStop||e.stopLoss),e.makeInitialSLBracketType=e=>e.stopLossPips||e.stopType===q.StopType.StopLoss?R.BracketType.StopLoss:e.trailingStopPips||e.stopType===q.StopType.TrailingStop?R.BracketType.TrailingStop:e.guaranteedStop||e.stopType===q.StopType.GuaranteedStop?R.BracketType.GuaranteedStop:e.supportStopLoss?R.BracketType.StopLoss:e.supportTrailingStop?R.BracketType.TrailingStop:e.supportGuaranteedStop?R.BracketType.GuaranteedStop:R.BracketType.StopLoss}(Ie||(Ie={}));class Ve{constructor({initialPrice:e,initialPips:t,initialRiskInPercent:s,initialParentPricePercent:r,initialAmount:o,initialEnabled:a,initialBracketType:l,initialPriceEquivalentType:d,initialFocusedControl:u,formatter:c,equity$:h,quotes$:p,info:_,pipValue$:g,side$:y,amount$:b,parentPrice$:v,orderType$:f,currency:P,parentType:S,savedPips:k,orderWidgetStat:T,showRiskControlsAndInfo:w,showRiskInInstrumentCurrency:B,status:O,validationRulesByType:M,supportStopLoss:E,supportTrailingStop:I,supportGuaranteedStop:V,supportModifyBrackets:$,supportModifyTrailingStop:D,supportBracketsInPips:x,supportAddBracketsToExistingOrder:A,hasTrailingStopBracket:q,existingBracketPrice:Q,useContextValidation:U,beforeFocusedControlChangeHandler:W,beforePriceEquivalentTypeChangeHandler:H,useValidationAgainstMarket:K=!1}){this.onControlFocused=new z.Delegate,this.roundToPriceStepRequired=!1,this._price$=new n.BehaviorSubject(null),this._priceEquivalent$=new n.BehaviorSubject(null),this._pips$=new n.BehaviorSubject(null),this._parentPricePercent$=new n.BehaviorSubject(null),this._riskInCurrency$=new n.BehaviorSubject(null),this._riskInPercent$=new n.BehaviorSubject(null),this._focusedControl$=new n.BehaviorSubject("Price"),this._error$=new n.BehaviorSubject({res:!1}),this._controlError$=new n.BehaviorSubject({res:!1}),this._isValuesInitialized$=new n.BehaviorSubject(!1),this._subscriptions=[],this._useValidationAgainstMarket=!1,this.getFocusedControl=()=>this._focusedControl$.getValue(),this.getEnabled=()=>this._enabled$.getValue(),this.getBracketType=()=>this._bracketType$.getValue(),this.getError=()=>Me({error:this._error$.getValue(),controlError:this._controlError$.getValue()}),this.setFocusedControl=e=>{this._handleBeforeFocusedControlChange?.(e),this._focusedControl$.next(e)},this.setEnabled=e=>{this._enabled$.next(e)},this.setBracketType=e=>{this._bracketType$.next(e),this._bracketPercentPriceRuleCheckers=this._makeBracketPercentPriceRuleCheckers(!1)},this.setError=(e,t)=>{this._error$.next(Ee(e,t))},this.setControlError=(e,t)=>{this._controlError$.next(Ee(e,t))},
this.getPriceEquivalentType=()=>this._priceEquivalentType$.getValue(),this.setPriceEquivalentType=e=>{e!==this._priceEquivalentType$.value&&this.availablePriceEquivalentsInfo.some((({type:t})=>t===e))&&(this._handleBeforePriceEquivalentTypeChange?.(e),this._priceEquivalentType$.next(e))},this._getPriceEquivalentFormatter=()=>{switch(this.getPriceEquivalentType()){case"Pips":return this._pipsFormatter;case"RiskInCurrency":return this._riskInCurrencyFormatter;case"RiskInPercent":return this._riskInPercentFormatter;case"ParentPricePercent":return this._parentPricePercentFormatter}},this._handleValueChange=([e,t])=>{if(!t)return;const{enabled:i,parentPrice:s,sideSign:r,pipValue:o,equity:n,amount:a,focusedControl:l,price:d,priceEquivalentType:u,priceEquivalent:c}=t;if(!i||null===a)return;const h=void 0!==e?.priceEquivalentType&&e.priceEquivalentType!==u,{price:p,priceEquivalent:_}=this._calculateBracketValue({sideSign:r,pipValue:o,equity:n,parentPrice:s,amount:a,focusedControl:l,price:d,priceEquivalentType:u,priceEquivalent:h?null:c});e?.price===p&&e?.priceEquivalent===_||this._setPriceEquivalents({sideSign:r,pipValue:o,equity:n,parentPrice:s,amount:a,focusedControl:l,price:p,priceEquivalentType:u,priceEquivalent:_}),"PriceEquivalent"===l&&h&&c!==_?this.priceEquivalent.setValue(_):("PriceEquivalent"===l&&d!==p||"Price"===l&&c!==_)&&this._setUnfocusedControlsValues(l,p,_)},this._getPriceStep=e=>void 0===this._variableMinTickData||null===e?this._priceStep:(0,N.getPriceStep)({priceType:this._priceType,minTick:this._minTick,variableMinTickData:this._variableMinTickData,price:e}),this._getPriceEquivalent=()=>this._priceEquivalent$.getValue(),this._setPriceEquivalent=e=>{this._priceEquivalent$.next((0,N.applyRounding)(e,this._getPriceEquivalentFormatter()))},this._getPrice=()=>this._price$.getValue(),this._setPrice=e=>{this._price$.next((0,N.applyRounding)(e,this._priceFormatter))},this._makeBracketPercentPriceRuleCheckers=e=>{const t=[],i=this._validationRulesByType?.[this._bracketType$.value];if(void 0!==i)for(const s of i)t.push((0,Se.makeBracketPercentPriceRuleChecker)({minPercent:s.options.min,maxPercent:s.options.max,isExpandedBoundary:e}));return t},this._handleBeforeFocusedControlChange=W,this._handleBeforePriceEquivalentTypeChange=H,this.stopLossTypes=function(e,t,i){const s=[];return e&&s.push(R.BracketType.StopLoss),t&&s.push(R.BracketType.TrailingStop),i&&s.push(R.BracketType.GuaranteedStop),s}(Boolean(E),Boolean(I),Boolean(V)),this._enabled$=new n.BehaviorSubject(a),this._bracketType$=new n.BehaviorSubject(l),this._equity$=h,this._pipValue$=g,this._side$=y,this._sideSign$=y.pipe((0,m.map)((e=>(l!==R.BracketType.TakeProfit?-1:1)*e))),this._quotes$=p,this._amount$=b.pipe((0,Y.distinctUntilChanged)()),this._pipSize=_.pipSize,this._lotSize=_.lotSize,this._minTick=_.minTick,this._useValidationAgainstMarket=K,this.symbolType=_.type,_.variableMinTick&&(this._variableMinTickData=(0,G.makeVariableMinTickData)(_.minTick,_.variableMinTick)),this._parentType=S,this._priceType=l===R.BracketType.TakeProfit?1:2,
this._isStatusEditing=1!==S||O===F.OrderPanelStatus.Editing,this._pipsFormatter=new j.PriceFormatter({priceScale:_.pipSize!==_.minTick?10:1,ignoreLocaleNumberFormat:!0,noExponentialForm:!0}),this._priceFormatter=new Te(c),this._riskInCurrencyFormatter=new j.PriceFormatter({priceScale:100,ignoreLocaleNumberFormat:!0,noExponentialForm:!0}),this._riskInPercentFormatter=new j.PriceFormatter({priceScale:100,ignoreLocaleNumberFormat:!0,noExponentialForm:!0}),this._parentPricePercentFormatter=new j.PriceFormatter({priceScale:100,ignoreLocaleNumberFormat:!0,noExponentialForm:!0}),this._priceMagnifier=_.priceMagnifier||1,this._hasTrailingStopBracket=q,this._validationRulesByType=M,this._existingBracketPrice=Q,this._useContextValidation=U,this._bracketPercentPriceRuleCheckers=this._makeBracketPercentPriceRuleCheckers(!1),this._parentPrice$=(0,L.combineLatest)({parentPrice:v,orderType:f,bracketType:this._bracketType$,quotes:this._quotes$,parentSide:this._side$}).pipe((0,m.map)((e=>{const{parentPrice:t,orderType:i,bracketType:s,quotes:r,parentSide:o}=e;if(s===R.BracketType.TrailingStop){if(2===i)return 1===o?(0,N.getAsk)(r):(0,N.getBid)(r);if(1!==this._parentType)return 1===o?(0,N.getBid)(r):(0,N.getAsk)(r)}return t})),(0,Y.distinctUntilChanged)()),this._priceStep=(0,N.getPriceStep)({priceType:this._priceType,minTick:_.minTick||_.pipSize,limitPriceStep:_.limitPriceStep,stopPriceStep:_.stopPriceStep}),this.roundToPriceStepRequired=(0,N.roundToStepRequired)({priceType:this._priceType,minTick:_.minTick||_.pipSize,limitPriceStep:_.limitPriceStep,stopPriceStep:_.stopPriceStep})||!1===x;const X=Boolean(B)?_.currency:void 0;this.currency=P||X||C.t(null,void 0,i(808249)),this.showRiskControlsAndInfo=w,this.supportTrailingStop=I,this.supportGuaranteedStop=V,this.availablePriceEquivalentsInfo=function(e){const{currency:t,symbolType:i,bracketType:s,parentType:r,isPipsControlHidden:o,showRiskControlsAndInfo:n}=e,a={currency:t,symbolType:i,parentType:r,bracketType:s};return[o?void 0:we({...a,priceEquivalentType:"Pips"}),we({...a,priceEquivalentType:"ParentPricePercent"}),n?we({...a,priceEquivalentType:"RiskInCurrency"}):void 0,n?we({...a,priceEquivalentType:"RiskInPercent"}):void 0].filter((e=>void 0!==e))}({currency:this.currency,symbolType:this.symbolType,parentType:this._parentType,isPipsControlHidden:this.roundToPriceStepRequired,showRiskControlsAndInfo:this.showRiskControlsAndInfo,bracketType:this.getBracketType()}),this._priceEquivalentType$=new n.BehaviorSubject(this.availablePriceEquivalentsInfo[0].type),this.priceEquivalentType$=this._priceEquivalentType$.asObservable(),this.priceEquivalent={value$:this._priceEquivalent$.pipe((0,ue.observeOn)(Pe),(0,Y.distinctUntilChanged)()),step:()=>Oe[this.getPriceEquivalentType()],getValue:this._getPriceEquivalent,setValue:this._setPriceEquivalent,onModifiedCallback:null!==T?()=>T.setBracketControlModifiedProperty(l,Be[this.getPriceEquivalentType()]):()=>{},formatter:this.priceEquivalentType$.pipe((0,m.map)((e=>{switch(e){case"Pips":return this._pipsFormatter;case"RiskInCurrency":
return this._riskInCurrencyFormatter;case"RiskInPercent":return this._riskInPercentFormatter;case"ParentPricePercent":return this._parentPricePercentFormatter}})))},this.price={value$:this._price$.pipe((0,ue.observeOn)(Pe),(0,Y.distinctUntilChanged)()),step:this._getPriceStep,getValue:this._getPrice,setValue:this._setPrice,onModifiedCallback:null!==T?()=>T.setBracketControlModifiedProperty(l,F.BracketSubControlType.Price):()=>{},formatter:this._priceFormatter},this.pips$=this._pips$.asObservable().pipe((0,Y.distinctUntilChanged)()),this.riskInCurrency$=this._riskInCurrency$.asObservable().pipe((0,Y.distinctUntilChanged)()),this.riskInPercent$=this._riskInPercent$.asObservable().pipe((0,Y.distinctUntilChanged)()),this.enabled$=this._enabled$.asObservable(),this.bracketType$=this._bracketType$.asObservable(),this.focusedControl$=this._focusedControl$.asObservable(),this.error$=(0,L.combineLatest)({error:this._error$,controlError:this._controlError$}).pipe((0,m.map)(Me)),this.isValuesInitialized$=this._isValuesInitialized$.asObservable(),this.controlState=this._computeControlState(S,l,$,D,A),(0,L.combineLatest)({parentPrice:this._parentPrice$,sideSign:this._sideSign$,pipValue:this._pipValue$,equity:this._equity$,amount:this._amount$}).pipe((0,ce.take)(1)).subscribe((i=>{const{parentPrice:n,sideSign:a,pipValue:c,equity:h,amount:p}=i,_=e||s||r?void 0:k??this._getDefaultPips(l),g=e||s||r||!_?void 0:(0,ke.pipsToPrice)(_,n,a,this._pipSize),{focusedControl:y,priceEquivalentType:b,...m}=this._getInitialBracketValueWithControlsInfo({initialPrice:e,initialPriceFallback:g,initialRiskInPercent:s,initialPips:t,initialPipsFallback:_,initialParentPricePercent:r,initialPriceEquivalentType:d,initialFocusedControl:u}),v=p??o??null,{price:f,priceEquivalent:P}=this._calculateBracketValue({sideSign:a,pipValue:c,equity:h,parentPrice:n,amount:v,focusedControl:y,priceEquivalentType:b,...m});this._setPriceEquivalents({sideSign:a,pipValue:c,equity:h,parentPrice:n,amount:v,focusedControl:y,price:f,priceEquivalentType:b,priceEquivalent:P}),this.setFocusedControl(y),this.setPriceEquivalentType(b),this.price.setValue(f),this.priceEquivalent.setValue(P),this._isValuesInitialized$.next(!0)}))}setBracketValueWithControlsInfo(e){const{price:t,priceEquivalentType:i,priceEquivalent:s,focusedControl:r}=e;let o=!1;r&&this.setFocusedControl(r),i&&(this.setPriceEquivalentType(i),o=!0),null!=s&&(this.priceEquivalent.setValue(s),o=!0),null!=t&&(this.price.setValue(t),o=!0),o&&this.setEnabled(!0)}subscribe(){const e=(0,L.combineLatest)({enabled:this._enabled$,parentPrice:this._parentPrice$,sideSign:this._sideSign$,pipValue:this._pipValue$,equity:this._equity$,amount:this._amount$,price:this.price.value$,focusedControl:this.focusedControl$,priceEquivalent:this.priceEquivalent.value$,priceEquivalentType:this.priceEquivalentType$}).pipe((0,B.startWith)(void 0),he()).subscribe(this._handleValueChange);return this._subscriptions=[e],this._useContextValidation||this._subscriptions.push(this._subscribeError()),this._subscriptions}unsubscribe(){
this._subscriptions.forEach((e=>e.unsubscribe()))}getPips(){return this._pips$.value}getRiskInCurrency(){return this._riskInCurrency$.value}getRiskInPercent(){return this._riskInPercent$.value}getParentPricePercent(){return this._parentPricePercent$.value}_setPriceEquivalents(e){const{priceEquivalentType:t,priceEquivalent:i,sideSign:s,pipValue:r,equity:o,parentPrice:n,amount:a,price:l}=e,d="Pips"===t?i:this._calculateBracketValue({sideSign:s,pipValue:r,equity:o,parentPrice:n,amount:a,focusedControl:"Price",price:l,priceEquivalentType:"Pips",priceEquivalent:null}).priceEquivalent;this._pips$.next((0,N.applyRounding)(d,this._pipsFormatter));const u="ParentPricePercent"===t?i:this._calculateBracketValue({sideSign:s,pipValue:r,equity:o,parentPrice:n,amount:a,focusedControl:"Price",price:l,priceEquivalentType:"ParentPricePercent",priceEquivalent:null}).priceEquivalent;this._parentPricePercent$.next((0,N.applyRounding)(u,this._parentPricePercentFormatter));const c="RiskInCurrency"===t?i:this._calculateBracketValue({sideSign:s,pipValue:r,equity:o,parentPrice:n,amount:a,focusedControl:"Price",price:l,priceEquivalentType:"RiskInCurrency",priceEquivalent:null}).priceEquivalent;this._riskInCurrency$.next((0,N.applyRounding)(c,this._riskInCurrencyFormatter));const h="RiskInPercent"===t?i:this._calculateBracketValue({sideSign:s,pipValue:r,equity:o,parentPrice:n,amount:a,focusedControl:"Price",price:l,priceEquivalentType:"RiskInPercent",priceEquivalent:null}).priceEquivalent;this._riskInPercent$.next((0,N.applyRounding)(h,this._riskInPercentFormatter))}_getDefaultPips(e){return e===R.BracketType.TakeProfit?F.BracketDefaultPips.TakeProfit:F.BracketDefaultPips.StopLoss}_setUnfocusedControlsValues(e,t,i){return"PriceEquivalent"===e?this.price.setValue(t):this.priceEquivalent.setValue(i)}_getInitialBracketValueWithControlsInfo({initialPrice:e,initialPriceFallback:t,initialPips:i,initialPipsFallback:s,initialRiskInPercent:r,initialParentPricePercent:o,initialPriceEquivalentType:n,initialFocusedControl:a}){const l={focusedControl:this._existingBracketPrice?"Price":a??"PriceEquivalent",price:null,priceEquivalentType:n??this.availablePriceEquivalentsInfo[0].type,priceEquivalent:null};return r&&this._isPriceEquivalentSupported("RiskInPercent")?(l.focusedControl="PriceEquivalent",l.priceEquivalentType="RiskInPercent",l.priceEquivalent=r,l):o&&this._isPriceEquivalentSupported("ParentPricePercent")?(l.focusedControl="PriceEquivalent",l.priceEquivalentType="ParentPricePercent",l.priceEquivalent=o,l):i&&this._isPriceEquivalentSupported("Pips")?(l.focusedControl="PriceEquivalent",l.priceEquivalentType="Pips",l.priceEquivalent=i,l):e?(l.focusedControl="Price",l.price=e,l):s&&"PriceEquivalent"===l.focusedControl&&[null,void 0,"Pips"].includes(n)&&this._isPriceEquivalentSupported("Pips")?(l.priceEquivalentType="Pips",l.priceEquivalent=s,l):t?(l.price=t,l):l}_subscribeError(){return(0,L.combineLatest)({side:this._side$,enabled:this._enabled$,controlError:this._controlError$,price:this.price.value$,focusedControl:this.focusedControl$,
parentPrice:this._parentPrice$,pips:this.pips$,quotes:this._quotes$,bracketType:this._bracketType$}).subscribe((e=>{const{side:t,enabled:i,controlError:s,focusedControl:r,price:o,pips:n,parentPrice:a,quotes:l,bracketType:d}=e;i&&this._setError({side:t,originalBracketPrice:this._existingBracketPrice,parentPrice:a,quotes:l,bracketType:d,controlError:s,focusedControl:r,pips:n,price:o})}))}_setError(e){const{side:t,parentPrice:i,originalBracketPrice:s,quotes:r,bracketType:o,controlError:n,focusedControl:a,pips:l,price:d}=e;n.res?this._error$.next(n):this._error$.next((0,Se.checkBracketError)({quotes:r,side:t,price:d,originalBracketPrice:s,pips:l,priceType:this._priceType,priceStep:this._getPriceStep(d),parentPrice:i,parentType:this._parentType,bracketType:o,isStatusEditing:this._isStatusEditing,isEnabled:this.getEnabled(),bracketPercentPriceRuleCheckers:this._bracketPercentPriceRuleCheckers,priceFormatter:this._priceFormatter,isRoundToPriceStep:this.roundToPriceStepRequired&&"Price"===a,validateAgainstMarket:this._useValidationAgainstMarket}))}_calculateBracketValue(e){const t=this._calculatePips(e)??this._calculateRiskInCurrency(e)??this._calculateRiskInPercent(e)??this._calculateParentPricePercent(e);return{price:this._calculatePrice({...e,priceEquivalent:t}),priceEquivalent:t}}_calculatePips(e){const{sideSign:t,parentPrice:i,focusedControl:s,price:r,priceEquivalentType:o,priceEquivalent:n}=e;return"Pips"!==o?null:"PriceEquivalent"===s&&null!==n?n:null===r?null:(0,ke.priceToPips)(r,i,t,this._pipSize)}_calculatePrice(e){const{sideSign:t,pipValue:i,equity:s,parentPrice:r,amount:o,focusedControl:n,price:a,priceEquivalentType:l,priceEquivalent:d}=e;if("Price"===n)return a;let u,c;switch(l){case"Pips":if(null===d)return null;c=(0,ke.pipsToPrice)(d,r,t,this._pipSize);break;case"RiskInCurrency":if(null===d||null===o)return null;u=(0,ke.riskInCurrencyToPips)(d,o,i,this._priceMagnifier,this._lotSize),c=(0,ke.pipsToPrice)(u,r,t,this._pipSize);break;case"RiskInPercent":if(null===d||null===o)return null;u=(0,ke.riskInPercentToPips)(d,o,s,i,this._priceMagnifier,this._lotSize),c=(0,ke.pipsToPrice)(u,r,t,this._pipSize);break;case"ParentPricePercent":if(null===d)return null;c=(0,ke.parentPricePercentToPrice)(r,d,t)}return this.roundToPriceStepRequired?(0,Ce.roundToStepByPriceTypeAndSide)(c,this._getPriceStep(c),this._priceType,t):c}_calculateRiskInCurrency(e){const{sideSign:t,pipValue:i,parentPrice:s,amount:r,focusedControl:o,price:n,priceEquivalentType:a,priceEquivalent:l}=e;if("RiskInCurrency"!==a)return null;if("PriceEquivalent"===o&&null!==l)return l;if(null===n||null===r)return null;const d=(0,ke.priceToPips)(n,s,t,this._pipSize);return(0,ke.pipsToRiskInCurrency)(d,r,i,this._priceMagnifier,this._lotSize)}_calculateRiskInPercent(e){const{sideSign:t,pipValue:i,equity:s,parentPrice:r,amount:o,focusedControl:n,price:a,priceEquivalentType:l,priceEquivalent:d}=e;if("RiskInPercent"!==l)return null;if("PriceEquivalent"===n&&null!==d)return d;if(null===a||null===o)return null;const u=(0,ke.priceToPips)(a,r,t,this._pipSize);return(0,
ke.pipsToRiskInPercent)(u,o,s,i,this._priceMagnifier,this._lotSize)}_calculateParentPricePercent(e){const{sideSign:t,parentPrice:i,focusedControl:s,price:r,priceEquivalentType:o,priceEquivalent:n}=e;return"ParentPricePercent"!==o?null:"PriceEquivalent"===s&&null!==n?n:null===r?null:(0,ke.priceToParentPricePercent)(i,r,t)}_computeControlState(e,t,i,s,r){const o=this._isStatusEditing&&t===R.BracketType.TrailingStop&&!s&&this._hasTrailingStopBracket,n=this._isStatusEditing&&t!==R.BracketType.TakeProfit&&this.getEnabled()&&!s&&this._hasTrailingStopBracket||1===this.stopLossTypes.length,a=this._isStatusEditing&&!i,l=Boolean(1===e&&this._isStatusEditing&&!this.getEnabled()&&!r);return{inputDisabled:o||a||l,labelDisabled:n||a||l,checkboxDisabled:a||l}}_isPriceEquivalentSupported(e){return this.availablePriceEquivalentsInfo.some((t=>t.type===e))}}var $e,De=i(769242);!function(e){e.Ask="ask",e.Bid="bid",e.Stop="stop",e.None=""}($e||($e={}));const Le=C.t(null,void 0,i(402043));function xe(e,t){return e.res===t.res&&e.msg===t.msg&&e.severity===t.severity}class Ae{constructor({priceType:e,quotes$:t,side$:s,info:r,status$:o,formatter:a,orderType$:l,settings$:d,brokerTitle:u,orderWidgetStat:c,getSettings:h,initialPrice:p,initialOffset:_,orderRules:g,stopPriceControlData$:y,supportStopOrdersInBothDirections:b,supportStopLimitOrdersInBothDirections:v,supportStrictCheckingLimitOrderPrice:f,useContextValidation:P,originalOrderPrice:S}){this.id=(0,W.randomHashN)(6),this.onControlFocused=new z.Delegate,this._focusedControl$=new n.BehaviorSubject(0),this._priceControlData$=new n.BehaviorSubject(null),this._value$=new n.BehaviorSubject(null),this._error$=new n.BehaviorSubject({res:!1}),this._controlError$=new n.BehaviorSubject({res:!1}),this._subscriptions=[],this._symbolType="",this._priceRules=[],this._stopLimitPercentPriceRuleCheckers=[],this.getError=()=>this._error$.getValue(),this.setControlError=(e,t)=>{this._controlError$.next({res:e,severity:"error",msg:t})},this.setAbsolutePrice=e=>{(0,L.combineLatest)({focusedControl:this._focusedControl$,quotes:this.quotes$,stopPriceControlData:this._stopPriceControlData$,side:this.side$,orderType:this.orderType$}).pipe((0,ce.take)(1)).subscribe((t=>{const{quotes:i,stopPriceControlData:s,side:r,orderType:o}=t,n=this._getBase(r,o),a=(0,N.parseValue)(e,this.formatter);if(!a.res){const t=this.getPriceControlData()??{index:0,value:0,absolutePrice:"",offset:0,base:n};return void this._setPrice({...t,absolutePrice:e,value:null})}const l=a.value,d=this._priceToIndex(l);let u=0;switch(n){case"stop":null!==s&&(u=Math.round(d-s.index));break;case"ask":const e=this._priceToIndex((0,N.getAsk)(i));u=Math.round(d-e);break;case"bid":const t=this._priceToIndex((0,N.getBid)(i));u=Math.round(d-t)}this._setPrice({index:d,value:l,absolutePrice:e,offset:u,base:n})}))},this.setPriceValue=(e,t=!1)=>{(0,L.combineLatest)({focusedControl:this._focusedControl$,quotes:this.quotes$,stopPriceControlData:this._stopPriceControlData$,side:this.side$,orderType:this.orderType$}).pipe((0,ce.take)(1)).subscribe((i=>{
const{quotes:s,stopPriceControlData:r,side:o,orderType:n}=i;(this._roundToStepRequired()||t)&&(e=(0,Ce.roundToStepByPriceTypeAndSide)(e,this.getStep(e),this.priceType,o));const a=this._priceToIndex(e),l=this._getBase(o,n);let d=0;switch(l){case"stop":null!==r&&(d=Math.round(a-r.index));break;case"ask":const e=this._priceToIndex((0,N.getAsk)(s));d=Math.round(a-e);break;case"bid":const t=this._priceToIndex((0,N.getBid)(s));d=Math.round(a-t)}this._setPrice({index:a,value:e,absolutePrice:this.formatter.format(e),offset:d,base:l})}))},this.setPriceOffset=e=>{(0,L.combineLatest)({focusedControl:this._focusedControl$,quotes:this.quotes$,stopPriceControlData:this._stopPriceControlData$,side:this.side$,orderType:this.orderType$}).pipe((0,ce.take)(1)).subscribe((t=>{const{quotes:i,stopPriceControlData:s,side:r,orderType:o}=t;let n=0;const a=this._getBase(r,o);if(null===e){const e=this.getPriceControlData()??{index:0,value:0,absolutePrice:"",offset:0,base:a};return void this._setPrice({...e,offset:null,value:null})}switch(a){case"stop":null!==s&&(n=Math.round(s.index+e));break;case"ask":const t=this._priceToIndex((0,N.getAsk)(i));n=Math.round(t+e);break;case"bid":const r=this._priceToIndex((0,N.getBid)(i));n=Math.round(r+e)}const l=this.indexToPrice(n);this._setPrice({index:n,value:l,absolutePrice:this.formatter.format(l),offset:e,base:a})}))},this.forcePriceUpdate=e=>{null!==e&&(this.setControlError(!1),this.setFocusedControl(0),this.setPriceValue(e,!0))},this.getPriceControlData=()=>this._priceControlData$.getValue(),this.getPrice=()=>this.getPriceControlData()?.value??null,this.getValue=()=>this._value$.getValue(),this.getFocusedControl=()=>this._focusedControl$.getValue(),this.getStep=e=>void 0===e?this._minTick:(0,N.getPriceStep)({price:e,priceType:this.priceType,minTick:this._minTick,variableMinTickData:this._variableMinTickData,limitPriceStep:this._instrumentInfo.limitPriceStep,stopPriceStep:this._instrumentInfo.stopPriceStep}),this.setFocusedControl=e=>{this._focusedControl$.next(e)},this._isPriceRules=e=>"limitPriceDistance"===e.id||"stopPriceDistance"===e.id,this._updateFocusIfNeeded=e=>{1!==this.getFocusedControl()||!this.isRelativePriceControlHidden&&e.showRelativePriceControl||this.setFocusedControl(0)},this._setPrice=e=>{this._priceControlData$.next(e)},this._setError=e=>{const{priceControlData:t,quotes:s,side:r,orderType:o,controlError:n,status:a}=e;if(a===F.OrderPanelStatus.Wait)return void this._error$.next({res:!1});if(n.res)return void this._error$.next(n);let l={res:!1},d={res:!1};if(null===t||null===t.value)l={res:!0,severity:"error",msg:C.t(null,void 0,i(845542))};else if(!this._useContextValidation){const e=this.getStep(t.value);if(d=this._checkPriceWarning(t.value,s,r),null!==o&&2!==o){const i=(0,N.getQuotePrice)(s,r);l=(0,De.validatePrice)({price:t.value,originalOrderPrice:this._originalOrderPrice,askOrBid:i,orderType:o,side:r,priceType:this.priceType,isForex:"forex"===this._symbolType,formatter:this.formatter,stopLimitPercentPriceRuleCheckers:this._stopLimitPercentPriceRuleCheckers,
supportStopOrdersInBothDirections:this.supportStopOrdersInBothDirections,supportStopLimitOrdersInBothDirections:this.supportStopLimitOrdersInBothDirections,supportStrictCheckingLimitOrderPrice:this.supportStrictCheckingLimitOrderPrice,step:e,isStatusEditing:a===F.OrderPanelStatus.Editing,roundedToStep:this._roundToStepRequired()})}}l.res?this._error$.next(l):d.res?this._error$.next(d):this._error$.next({res:!1})},this.quotes$=t,this.side$=s,this._instrumentInfo=r,this._status$=o,this.formatter=new Te(a),this.orderType$=l,this.priceType=e,this._settings$=d,this._getSettings=h,this._brokerTitle=u,this.orderWidgetStat=c,this.supportStopOrdersInBothDirections=Boolean(b),this.supportStopLimitOrdersInBothDirections=Boolean(v),this.supportStrictCheckingLimitOrderPrice=Boolean(f),this._useContextValidation=P,this._symbolType=r.type||"",this._pipSize=r.pipSize,this._minTick=r.minTick||r.pipSize,this._variableMinTickData=r.variableMinTick?(0,G.makeVariableMinTickData)(this._minTick,r.variableMinTick):void 0;const k=this.getStep();this.indexToPrice=(0,G.makePriceIndexToPriceConverter)(k,this._variableMinTickData),this._priceToIndex=(0,G.makePriceToPriceIndexConverter)(k,this._variableMinTickData),this.priceControlData$=this._priceControlData$.asObservable(),this.value$=this._value$.asObservable(),this.focusedControl$=this._focusedControl$.asObservable(),this.error$=this._error$.pipe((0,Y.distinctUntilChanged)(xe)),this._originalOrderPrice=S,this._stopPriceControlData$=(0,L.combineLatest)({stopPriceControlData:y??(0,A.of)(null),orderType:this.orderType$}).pipe((0,m.map)((t=>{const{stopPriceControlData:i,orderType:s}=t;return 1===e&&4===s?i:null})),(0,Y.distinctUntilChanged)()),this.isRelativePriceControlHidden=this._roundToStepRequired(),this.setPriceValues({price:p,offset:_}),this.modifiedAbsolutePriceControlStat=null!==c?()=>c.setPriceControlModifiedProperty(F.PriceSubControlType.Absolute):()=>{},this.modifiedRelativePriceControlStat=null!==c?()=>c.setPriceControlModifiedProperty(F.PriceSubControlType.Relative):()=>{};const T=g??[];this._priceRules=T.filter(this._isPriceRules)??[];const w=T.filter(Q.isStopLimitPercentValidationRule)??[],B=1===this.priceType?Q.isLimitPercentValidationRule:Q.isStopPercentValidationRule;w.filter(B).forEach((e=>{this._stopLimitPercentPriceRuleCheckers.push((0,De.makeStopLimitPercentPriceRuleChecker)(e.options.min,e.options.max))}))}setPriceValues(e){const{price:t,offset:i}=e;void 0!==i&&!this.isRelativePriceControlHidden&&this._getSettings().showRelativePriceControl?(this.setFocusedControl(1),this.setPriceOffset(i)):void 0!==t&&(this.setFocusedControl(0),this.setPriceValue(t,!0))}subscribe(){const e=this._settings$.subscribe(this._updateFocusIfNeeded),t=(0,L.combineLatest)({quotes:this.quotes$,side:this.side$,focusedControl:this.focusedControl$,status:this._status$}).pipe(b(this._priceControlData$)).subscribe((([e,t])=>{const{quotes:i,side:s,focusedControl:r,status:o}=e
;null!==t&&o!==F.OrderPanelStatus.Wait?this._isInvalidInputFocused(r,t)||(0===r?this.setAbsolutePrice(t.absolutePrice):this.setPriceOffset(t.offset)):this.setPriceValue(1===s?(0,N.getAsk)(i):(0,N.getBid)(i),!1)})),i=(0,L.combineLatest)({priceControlData:this._priceControlData$,quotes:this.quotes$,side:this.side$,orderType:this.orderType$,controlError:this._controlError$.pipe((0,Y.distinctUntilChanged)(xe)),status:this._status$}).subscribe(this._setError),s=(0,L.combineLatest)({priceControlData:this._priceControlData$,error:this.error$}).subscribe((e=>{const{priceControlData:t,error:i}=e;let s=null===t?null:t.value;this._useContextValidation||(s=i.res&&"error"===i.severity?null:s),this._value$.next(s)}));this._subscriptions=[e,t,i,s]}unsubscribe(){this._subscriptions.map((e=>e.unsubscribe()))}resetPrice(){this.setControlError(!1),this.setFocusedControl(this._getSettings().showRelativePriceControl&&!this.isRelativePriceControlHidden?1:0),(0,L.combineLatest)([this.quotes$,this.side$]).pipe((0,ce.take)(1)).subscribe((([e,t])=>{this.setPriceValue(1===t?(0,N.getAsk)(e):(0,N.getBid)(e),!1)}))}_checkPriceWarning(e,t,i){const s=this._priceRules.find((s=>this._isDistanceRuleViolated(e,t,s,i)));return s?{res:!0,severity:s.severity,msg:Le.format({brokerTitle:this._brokerTitle})}:{res:!1,msg:void 0}}_isDistanceRuleViolated(e,t,i,s){if("limitPriceDistance"===i.id&&2===this.priceType||"stopPriceDistance"===i.id&&1===this.priceType)return!1;const r=1===s,o=(0,N.getQuotePrice)(t,s);let n=null;if(r&&"buyDirectionPips"in i.options&&(n=i.options.buyDirectionPips),!r&&"sellDirectionPips"in i.options&&(n=i.options.sellDirectionPips),null===n)return!1;return Math.abs(o-e)<n*this._pipSize}_getBase(e,t){return 1===this.priceType&&4===t?"stop":1===e?"ask":"bid"}_isInvalidInputFocused(e,t){const{value:i,offset:s,absolutePrice:r}=t;return null===i&&(0===e?""===r:null===s)}_roundToStepRequired(){return(0,N.roundToStepRequired)({priceType:this.priceType,minTick:this._minTick,limitPriceStep:this._instrumentInfo.limitPriceStep,stopPriceStep:this._instrumentInfo.stopPriceStep})}}class qe{constructor({displaySymbolName:e,symbol:t,brokerName:i,quotes$:s,mode$:r,status$:n,parentType:a,isExistingOrder:l,isTradable:d,data:u,formatter:h,isBats:p=!1,informerMessage$:_,headerState:g,orderTemplateGetter:y,isOrderPresetsEnabled:b=!1,brokerId:m,isSendButtonDisabled$:v,brokerLogo:f,accountType:P}){this._stopSubscriptions$=new o.Subject,this._pinButtonClicked=new z.Delegate,this._closeButtonClicked=new z.Delegate,this._onStatusChanged=(e,t)=>{this._headerState.setTitle(this._title(e)),this._headerState.setDescription(this._description(e)),this._headerState.setCloseFunction(this._hasCloseButton(t)?()=>this.close():void 0),this._headerState.setIsTabsAvailable(this._isTabsAvailable(e,t)),this._headerState.setOrderTemplateFunction(this._hasPresetsButton(e)?this._orderTemplateGetter:void 0),this._headerState.setBrokerId(this._brokerId),this._headerState.setAccountType(this._accountType),this._headerState.setBrokerLogo(this._brokerLogo),
this._headerState.setBrokerName(this._brokerName)},this._onQuotes=e=>{this._headerState.setHasDelayedQuotes(Boolean(e.isDelayed))},this._handleSendingDisability=e=>{this._headerState.setIsSendingDisabled(e)},this._headerState=g,this._orderTemplateGetter=y,this._data=u,this._displaySymbolName=e,this._formatter=h,this._brokerName=i,this._brokerId=m,this._accountType=P,this._brokerLogo=f,this._parentType=a,this._isExistingOrder=l,this._isOrderPresetsEnabled=b,(0,L.combineLatest)({status:n,mode:r}).pipe(c(this._stopSubscriptions$)).subscribe((({status:e,mode:t})=>this._onStatusChanged(e,t))),(0,L.combineLatest)({status:n,mode:r}).pipe((0,ce.take)(1)).subscribe((({status:e,mode:i})=>{this._onStatusChanged(e,i),this._headerState.setSymbol(t),this._headerState.setHasDelayedQuotes(!1),this._headerState.setHasBatsQuotes(p),this._headerState.setIsTradable(d)})),s&&s.pipe(c(this._stopSubscriptions$)).subscribe(this._onQuotes),void 0!==_&&_.pipe(c(this._stopSubscriptions$)).subscribe((e=>this._headerState.setInformerMessage(e))),void 0!==v&&v.pipe(c(this._stopSubscriptions$)).subscribe(this._handleSendingDisability)}unsubscribe(){this._stopSubscriptions$.next(),this._stopSubscriptions$.complete(),this._headerState.setFocusedControl(void 0)}pin(){this._pinButtonClicked.fire()}close(){this._closeButtonClicked.fire()}pinButtonClicked(){return this._pinButtonClicked}closeButtonClicked(){return this._closeButtonClicked}_isTabsAvailable(e,t){return t===F.OrderEditorDisplayMode.Panel&&!this._isExistingOrder&&1===this._parentType&&e!==F.OrderPanelStatus.Preview}_hasPresetsButton(e){return this._isOrderPresetsEnabled&&(e===F.OrderPanelStatus.Active||e===F.OrderPanelStatus.Wait)&&1===this._parentType}_hasCloseButton(e){return e!==F.OrderEditorDisplayMode.ResizableDrawer&&S.enabled("order_panel_close_button")}_title(e){return e===F.OrderPanelStatus.Preview?C.t(null,void 0,i(88346)):this._isExistingOrder&&void 0!==this._data&&void 0!==this._formatter&&1===this._parentType?`${this._displaySymbolName}, ${C.t(null,void 0,i(258063))+" "+this._data.id}`:this._displaySymbolName}_description(e){if(e===F.OrderPanelStatus.Wait||e===F.OrderPanelStatus.Preview||void 0===this._data||void 0===this._formatter||1===this._parentType&&e===F.OrderPanelStatus.Active)return;const t=this._data.qty,i=this._formatter.format(this._data.price||this._data.avgPrice||this._data.limitPrice);return`${this._getDescriptionLabel()} ${t} @ ${i}`}_getDescriptionLabel(){if(!this._data)return"";const e=1===this._data.side;return 2===this._parentType?e?C.t(null,void 0,i(728257)):C.t(null,void 0,i(13009)):this._data.limitPrice?e?C.t(null,void 0,i(193693)):C.t(null,void 0,i(461944)):this._data.stopPrice?e?C.t(null,void 0,i(324925)):C.t(null,void 0,i(934717)):e?C.t(null,void 0,i(169961)):C.t(null,void 0,i(168222))}}var Re=new fe(ye),Fe=Re,Ne={leading:!0,trailing:!1};var Qe=i(337160);function Ue(e,t,i){void 0===e&&(e=0),void 0===i&&(i=Fe);var s=-1;return null!=t&&((0,Qe.isScheduler)(t)?i=t:s=t),new E.Observable((function(t){var r,o=(r=e)instanceof Date&&!isNaN(r)?+e-i.now():e
;o<0&&(o=0);var n=0;return i.schedule((function(){t.closed||(t.next(n++),0<=s?this.schedule(void 0,s):t.complete())}),o)}))}function We(e,t,i){void 0===t&&(t=Re),void 0===i&&(i=Ne);var s,r,o,n,u,c=Ue(e,t);return s=function(){return c},n=(o=void 0===(r=i)?Ne:r).leading,u=o.trailing,(0,a.operate)((function(e,t){var i=!1,r=null,o=null,a=!1,c=function(){null==o||o.unsubscribe(),o=null,u&&(_(),a&&t.complete())},h=function(){o=null,a&&t.complete()},p=function(e){return o=(0,d.innerFrom)(s(e)).subscribe(new l.OperatorSubscriber(t,c,h))},_=function(){if(i){i=!1;var e=r;r=null,t.next(e),!a&&p(e)}};e.subscribe(new l.OperatorSubscriber(t,(function(e){i=!0,r=e,(!o||o.closed)&&(n?_():p(e))}),(function(){a=!0,(!(u&&i&&o)||o.closed)&&t.complete()})))}))}class ze{constructor({initialSide:e,quotes$:t,priceFormatter:i,spreadFormatter:s,baseCurrency:r}){this.baseCurrency=null,this.onControlFocused=new z.Delegate,this._formattedQuotes$=new n.BehaviorSubject({ask:" ",bid:" "}),this._restrictionTypes$=new n.BehaviorSubject([]),this._quotes={ask:0,bid:0},this._waitQuotesTimeout=void 0,this._subscriptions=[],this.getValue=()=>this._value$.getValue(),this.setValue=e=>{this._value$.next(e)},this.getFormattedQuotes=()=>this._formattedQuotes$.getValue(),this.currentQuotes=()=>this._quotes,this.getRestrictionTypes=()=>this._restrictionTypes$.getValue(),this._value$=new n.BehaviorSubject(e),this.value$=this._value$.asObservable(),this.formattedQuotes$=this._formattedQuotes$.asObservable(),this.restrictionTypes$=this._restrictionTypes$.asObservable(),this.baseCurrency=r,this._quotes$=t,this._priceFormatter=i,this._spreadFormatter=s}subscribe(){this._waitQuotesTimeout=setTimeout((()=>{this._formattedQuotes$.next({}),this._quotes={}}),5e3);const e=this._quotes$.subscribe((e=>{this._formattedQuotes$.next(this._generateText(e)),this._quotes=e,clearTimeout(this._waitQuotesTimeout)})),t=this._quotes$.pipe(We(2e3,Re,{leading:!0,trailing:!0})).subscribe((e=>{this._restrictionTypes$.next(this._generateRestrictionTypes(e))}));return this._subscriptions=[e,t],this._subscriptions}unsubscribe(){this._subscriptions.forEach((e=>e.unsubscribe())),clearTimeout(this._waitQuotesTimeout)}_generateText(e){const t={},i=(0,N.getAsk)(e),s=(0,N.getBid)(e);return t.ask=this._priceFormatter.format(i),t.bid=this._priceFormatter.format(s),t.spread=(0,H.isNumber)(e.spread)?this._spreadFormatter.format(e.spread):this._priceFormatter.format(i-s),t}_generateRestrictionTypes(e){const t=[];return e.isHalted&&t.push(R.RestrictionType.Halted),e.isHardToBorrow&&t.push(R.RestrictionType.HardToBorrow),e.isNotShortable&&t.push(R.RestrictionType.NotShortable),t}}function je(e,t){return(0,N.getLast)(e)||(0,N.getQuotePrice)(e,t)||0}class He{constructor({stopPriceModel:e,limitPriceModel:t,orderType$:i,side$:s,quotes$:r}){this._subscriptions=[],this._calculateLimitModelPrice=e=>{const t=this._stopPriceModel.getPrice();if(null===t)return null;const i=this._limitPriceModel.getStep(t),s=1===e?1:-1;return new(ee())(i).mul(s).plus(t).toNumber()},this._orderType$=i,this._side$=s,
this._stopPriceModel=e,this._limitPriceModel=t,this.price$=(0,L.combineLatest)({orderType:i,side:s,quotes:r,stopPrice:e.value$,limitPrice:t.value$}).pipe((0,m.map)((e=>{const{orderType:t,side:i,quotes:s,stopPrice:r,limitPrice:o}=e;switch(t){case 1:case 4:return o??je(s,i);case 3:return r??je(s,i);default:return(0,N.getQuotePrice)(s,i)}})),(0,Y.distinctUntilChanged)())}subscribe(){const e=this._orderType$.pipe(he(),b(this._side$),(0,m.map)((([e,t])=>{const[i,s]=e,r=this._stopPriceModel.getPrice(),o=this._limitPriceModel.getPrice();if(1===s&&null!==i&&[3,4].includes(i))this._limitPriceModel.forcePriceUpdate(r);else if(3!==s||1!==i){if(4===s){1===i&&this._stopPriceModel.forcePriceUpdate(o);const e=this._calculateLimitModelPrice(t);this._limitPriceModel.forcePriceUpdate(e)}}else this._stopPriceModel.forcePriceUpdate(o)}))).subscribe();this._subscriptions.push(e)}unsubscribe(){this._subscriptions.map((e=>e.unsubscribe()))}}var Ge=i(650279);var Ke=i(441219),Ye=i(621363),Xe=i(209957),Je=i(773743),Ze=i(514970),et=i(980956);class tt{constructor({stopLossAvailable$:e,settings$:t,initialQty:s,initialOrderSizeCalculatorQuantityType:r,initialOrderSizeCalculatorValue:o,initialLastRiskQuantityType:a,stopLossAvailableGetter:l,initialLastUsedQuantityType:d,info:u,currency:c,orderWidgetStat:h,showRiskControlsAndInfo:p,accountCurrencyPrecision:_,useContextValidation:g,beforeQuantityTypeChangeHandler:y}){this.formatter=(0,Ke.numberFormattersParsersChain)({chain:[(0,Ye.prohibitNanOnParseStep)(),(0,Xe.decimalNumberMagnitudeStep)({standardNotationOnly:!0}),(0,Je.signumStep)({negativeSign:Je.longMinusSign})]}),this.convertedValues$=new M.ReplaySubject(1),this.riskStep=.01,this.onControlFocused=new z.Delegate,this._subscriptions=[],this._value$=new n.BehaviorSubject(null),this._inputType$=new n.BehaviorSubject("units"),this._focusedControl$=new n.BehaviorSubject(0),this._error$=new n.BehaviorSubject({res:!1}),this._controlError$=new n.BehaviorSubject({res:!1}),this.setControlError=(e,t)=>{this._controlError$.next({res:e,msg:t})},this.getFormatter=e=>{if("units"===e)return(0,et.quantityFormatter)({ignoreLocaleNumberFormat:!0,noExponentialForm:!0});const t="money"===e&&this._accountCurrencyPrecision?this._accountCurrencyPrecision:100;return new j.PriceFormatter({priceScale:t,ignoreLocaleNumberFormat:!0,noExponentialForm:!0})},this.setInputTypeAndValue=(e,t)=>{this._handleBeforeQuantityTypeChange(e),this._setInputType(e),"units"===e?(this._setRawQuantity(t),this._setRoundedDownToStepQuantity(t)):(this._setRawOrderSizeCalculator(t),this._setFormattedOrderSizeCalculator(t)),this.setControlError(!1)},this.getInputType=()=>this._inputType$.getValue(),this.getOrderSizeCalculatorQuantityType=()=>this._orderSizeCalculatorQuantityType$.getValue(),this.setOrderSizeCalculatorQuantityType=e=>{this._orderSizeCalculatorQuantityType$.next(e)},this.getLastRiskQuantityType=()=>this._lastRiskQuantityType$.getValue(),this.getLastUsedQuantityType=()=>this._lastUsedQuantityType$.getValue(),this.getFocusedControl=()=>this._focusedControl$.getValue(),
this.getError=()=>this._error$.getValue(),this.getQuantityMetainfo=()=>this._quantityMetainfo$.getValue(),this.setFocusedControl=e=>{this._focusedControl$.next(e)},this.stopLossAvailable=()=>this._stopLossAvailableGetter(),this.setConvertedValues=e=>{this.convertedValues$.next(e)},this._setInputType=e=>{"riskInCurrency"!==e&&"riskInPercent"!==e||this._lastRiskQuantityType$.next(e),"units"!==e&&this.setOrderSizeCalculatorQuantityType(e),this._lastUsedQuantityType$.next(e),this._inputType$.next(e)},this._setQuantity=e=>{this._quantity$.next(e)},this._setOrderSizeCalculator=e=>{this._orderSizeCalculator$.next(e)},this._handleBeforeQuantityTypeChange=y,this.qty=u.qty,this.units=u.units,this._useContextValidation=g,this._accountCurrencyPrecision=_,this.showRiskControlsAndInfo=p,this.currency=c,this.stopLossAvailable$=e,this._settings$=t,this._stopLossAvailableGetter=l,this.calculatorTitle="spread"===u.type?C.t(null,void 0,i(106200)):C.t(null,void 0,i(899255)),this._quantity$=new n.BehaviorSubject(s??this.qty.default??null),this._rawQuantity$=new n.BehaviorSubject(this._quantity$.value),this.rawQuantity$=this._rawQuantity$.asObservable();const b=null!==r?(0,N.applyRounding)(o,this.getFormatter(r)):o;this._orderSizeCalculator$=new n.BehaviorSubject(b),this._rawOrderSizeCalculator$=new n.BehaviorSubject(o),this.rawOrderSizeCalculator$=this._rawOrderSizeCalculator$.asObservable(),this._orderSizeCalculatorQuantityType$=new n.BehaviorSubject(r),this._lastRiskQuantityType$=new n.BehaviorSubject(a),this._lastUsedQuantityType$=new n.BehaviorSubject(d??"units"),this._quantityMetainfo$=new n.BehaviorSubject(u.qty),this.value$=this._value$.asObservable(),this.inputType$=this._inputType$.asObservable(),this.orderSizeCalculatorQuantityType$=this._orderSizeCalculatorQuantityType$.asObservable(),this.lastRiskQuantityType$=this._lastRiskQuantityType$.asObservable(),this.lastUsedQuantityType$=this._lastUsedQuantityType$.asObservable(),this.focusedControl$=this._focusedControl$.asObservable(),this.error$=this._error$.asObservable(),this.quantityMetainfo$=this._quantityMetainfo$.asObservable(),this.orderWidgetStat=h;const m=()=>{if(null===h)return;const e=this.getOrderSizeCalculatorQuantityType();e&&h.setQtyTypeModifiedProperty(e)};this.quantity={value$:this._quantity$.asObservable(),getValue:()=>this._quantity$.getValue(),setValue:e=>{this._setQuantity(e),this._setRawQuantity(e)},onModifiedCallback:m,calculatorUsedStat:()=>null!==h?h.setCalculatorUsedProperty():()=>{}},this.orderSizeCalculator={value$:this._orderSizeCalculator$.asObservable(),getValue:()=>this._orderSizeCalculator$.getValue(),setValue:e=>{this._setOrderSizeCalculator(e),this._setRawOrderSizeCalculator(e)},onModifiedCallback:m,calculatorUsedStat:()=>null!==h?h.setCalculatorUsedProperty():()=>{}};const v=l()||"riskInCurrency"!==d&&"riskInPercent"!==d;o&&null!==d&&d===r&&"units"!==d&&v&&this.setInputTypeAndValue(d,o)}subscribe(){const e=[],t=this._inputType$.subscribe((e=>{this.setFocusedControl("units"===e?0:3),
this._quantityMetainfo$.next(this._availableQuantityTypeInfos?.[e]?.quantityMetainfo??this.qty)})),i=this.convertedValues$.pipe((0,$.filter)((e=>null!==e.units)),(0,ce.take)(1),(d=!1,(s=1)&&"object"==typeof s?(l=null!==(n=s.bufferSize)&&void 0!==n?n:1/0,r=null!==(a=s.windowTime)&&void 0!==a?a:1/0,d=!!s.refCount,o=s.scheduler):l=null!=s?s:1/0,(0,O.share)({connector:function(){return new M.ReplaySubject(l,r,o)},resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:d})));var s,r,o,n,a,l,d;const u=i.pipe((0,x.switchMap)((()=>this._focusedControl$.pipe((0,x.switchMap)((e=>(0,L.combineLatest)({convertedValues:this.convertedValues$,orderSizeCalculatorQuantityType:this._orderSizeCalculatorQuantityType$,focusedControl:(0,A.of)(e)}))))))).subscribe((e=>{const{focusedControl:t,orderSizeCalculatorQuantityType:i,convertedValues:s}=e;if(0===t&&null!==i){const e=s[i];void 0!==e&&e!==this._orderSizeCalculator$.value&&(this._setRawOrderSizeCalculator(e),this._setFormattedOrderSizeCalculator(e))}if(3===t&&this._quantity$.value!==s.units){const e=s.units;this._setRawQuantity(e),this._setRoundedDownToStepQuantity(e)}})),c=i.pipe((0,x.switchMap)((()=>this.stopLossAvailable$.pipe((0,Y.distinctUntilChanged)(),b(this._settings$,this._lastRiskQuantityType$,this._orderSizeCalculatorQuantityType$,this.convertedValues$,this._inputType$))))).subscribe((([e,t,i,s,r,o])=>{e||o!==i?t.enableQuantityInRisk&&e&&null!==i&&void 0!==this.getAvailableQuantityTypeInfos()?.[i]&&"riskInCurrency"!==s&&"riskInPercent"!==s&&("units"!==o&&null!==r.units&&this.setInputTypeAndValue("units",r.units),this.setOrderSizeCalculatorQuantityType(i)):this.setInputTypeAndValue("units",r.units)}));e.push(t,c,u);const h=(0,L.combineLatest)({units:this._quantity$,controlError:this._controlError$,focus:this._focusedControl$,orderSizeCalculator:this._orderSizeCalculator$,orderSizeCalculatorQuantityType:this._orderSizeCalculatorQuantityType$}).pipe((0,Y.distinctUntilChanged)(Ge.default)).subscribe((e=>{const{units:t,controlError:i,focus:s,orderSizeCalculator:r,orderSizeCalculatorQuantityType:o}=e;if(this._useContextValidation)return this._error$.next({res:i.res,msg:i.msg,severity:"error"}),void this._value$.next(t);const n=null!==o?this._availableQuantityTypeInfos?.[o]?.quantityMetainfo:void 0,a=3===s&&void 0!==n?(0,Ze.checkQtyError)(n,r,!0):void 0,l=(0,Ze.checkQtyError)(this.qty,t,!0),d=i.res?i.msg:a?.msg||l.msg;this._error$.next({res:i.res||a?.res||l.res,msg:d}),this._value$.next(i.res||a?.res||l.res||null===s?null:t)}));e.push(h),this._subscriptions=e}unsubscribe(){this._subscriptions.map((e=>e.unsubscribe()))}getValue(){return this._value$.getValue()}setAvailableQuantityTypeInfos(e){this._availableQuantityTypeInfos=e}getAvailableQuantityTypeInfos(){return this._availableQuantityTypeInfos}_setRoundedDownToStepQuantity(e){const t=null!==e?function(e,t){return(0,Z.Big)(e).div(t).round(0,1).mul(t)}(e,this.qty.step).toNumber():e;this._setQuantity(t)}_setRawQuantity(e){this._rawQuantity$.next(e)}_setRawOrderSizeCalculator(e){this._rawOrderSizeCalculator$.next(e)}
_setFormattedOrderSizeCalculator(e){const t=this.getOrderSizeCalculatorQuantityType(),i=null!==e&&null!==t?(0,N.applyRounding)(e,this.getFormatter(t)):e;this._setOrderSizeCalculator(i)}}var it=i(558042),st=i(401498);class rt{constructor({info:e,price$:t,baseCurrencyCryptoBalance$:i,quoteCurrencyCryptoBalance$:s,initialQty:r,side$:o,sideGetter:a,orderWidgetStat:l,isExistingOrder:d,orderQty:u,orderPrice:c,useContextValidation:h}){this.formatter=et.defaultQuantityFormatter,this.onControlFocused=new z.Delegate,this._value$=new n.BehaviorSubject(null),this._quoteCurrencyQuantity$=new n.BehaviorSubject(null),this._error$=new n.BehaviorSubject({res:!1}),this._focusedControl$=new n.BehaviorSubject(1),this._controlError$=new n.BehaviorSubject({res:!1}),this._baseCurrencyCryptoBalanceValue$=new n.BehaviorSubject(null),this._quoteCurrencyCryptoBalanceValue$=new n.BehaviorSubject(null),this._subscriptions=[],this.setControlError=(e,t)=>{this._controlError$.next({res:e,msg:t})},this.getFocusedControl=()=>this._focusedControl$.getValue(),this.setFocusedControl=e=>{this._focusedControl$.next(e)},this._setBaseCurrencyQuantity=e=>{this._baseCurrencyQuantity$.next((0,N.applyRounding)(e,this.formatter))},this._setQuoteCurrencyQuantity=e=>{this._quoteCurrencyQuantity$.next((0,N.applyRounding)(e,this.formatter))},this.info=e,this.side$=o,this.getSide=a,this._price$=t,this._orderQty=u,this._orderPrice=c,this._isExistingOrder=d,this._baseCurrencyCryptoBalance$=i,this._quoteCurrencyCryptoBalance$=s,this._useContextValidation=h,this._baseCurrencyQuantity$=new n.BehaviorSubject(null!==r?r:e.qty.default||e.qty.step),this.value$=this._value$.asObservable(),this.focusedControl$=this._focusedControl$.asObservable(),this.error$=this._error$.asObservable(),this.baseCurrencyCryptoBalanceValue$=this._baseCurrencyCryptoBalanceValue$.asObservable(),this.quoteCurrencyCryptoBalanceValue$=this._quoteCurrencyCryptoBalanceValue$.asObservable(),this.quoteCurrencyUiParams$=t.pipe((0,m.map)((t=>{const i=(0,Z.Big)(t).mul(e.qty.step).toNumber(),s=(0,Ce.roundUpToPowerOf10)(i),r=(0,Z.Big)(t).mul(e.qty.min).toNumber();return{min:(0,st.alignToStep)(r,s),step:s}}))),this.quantity={value$:this._baseCurrencyQuantity$.asObservable(),getValue:()=>this._baseCurrencyQuantity$.getValue(),setValue:this._setBaseCurrencyQuantity,onModifiedCallback:null!==l?()=>l.setQtyControlModifiedProperty(F.QuantitySubControlType.BaseCurrency):()=>{}},this.quoteCurrencyQuantity={value$:this._quoteCurrencyQuantity$.asObservable(),getValue:()=>this._quoteCurrencyQuantity$.getValue(),setValue:this._setQuoteCurrencyQuantity,onModifiedCallback:null!==l?()=>l.setQtyControlModifiedProperty(F.QuantitySubControlType.QuoteCurrency):()=>{}},this._quantityValuesWithFocusedControl$=this._quantityValuesWithFocusedControlObservable()}subscribe(){null!==this._baseCurrencyCryptoBalance$&&this._subscriptions.push((0,L.combineLatest)([this.side$,this._baseCurrencyCryptoBalance$]).subscribe((e=>{const[t,i]=e;this._baseCurrencyCryptoBalanceValue$.next((0,N.getCryptoBalanceValue)({side:t,balance:i,
isExistingOrder:this._isExistingOrder,qty:this._orderQty,orderPrice:this._orderPrice}))}))),null!==this._quoteCurrencyCryptoBalance$&&this._subscriptions.push((0,L.combineLatest)([this.side$,this._quoteCurrencyCryptoBalance$]).subscribe((e=>{const[t,i]=e;this._quoteCurrencyCryptoBalanceValue$.next((0,N.getCryptoBalanceValue)({side:t,balance:i,isExistingOrder:this._isExistingOrder,qty:this._orderQty,orderPrice:this._orderPrice}))})));const e=(0,L.combineLatest)({price:this._price$,quantityValuesWithFocusedControl:this._quantityValuesWithFocusedControl$}).subscribe((e=>{const{price:t,quantityValuesWithFocusedControl:i}=e,{focusedControl:s,baseCurrencyQuantity:r,quoteCurrencyQuantity:o}=i,{baseCurrencyQuantity:n,quoteCurrencyQuantity:a}=this._calculateQuantityValues({focusedControl:s,price:t,baseCurrencyQuantity:r,quoteCurrencyQuantity:o});r===n&&o===a||this._setUnfocusedControlsValues(s,n,a)})),t=(0,L.combineLatest)({baseValue:this._baseCurrencyQuantity$,quoteValue:this._quoteCurrencyQuantity$,controlError:this._controlError$,focus:this._focusedControl$,side:this.side$,baseBalanceValue:this._baseCurrencyCryptoBalanceValue$,quoteBalanceValue:this._quoteCurrencyCryptoBalanceValue$}).subscribe((e=>{const{baseValue:t,quoteValue:i,controlError:s,focus:r,side:o,baseBalanceValue:n,quoteBalanceValue:a}=e;if(this._useContextValidation)return this._error$.next({res:s.res,msg:s.msg,severity:"error"}),void this._value$.next(t);const l=(0,Ze.checkQtyError)(this.info.qty,t),d=(0,it.validateBalance)({side:o,baseValue:t,baseBalanceValue:n,baseCurrency:this.info.baseCurrency,quoteValue:i,quoteBalanceValue:a,quoteCurrency:this.info.quoteCurrency});this._error$.next({res:l.res||d.res||s.res,msg:l.msg||d.msg||s.msg}),this._value$.next(l.res||d.res||s.res||null===r?null:t)}));this._subscriptions.push(e,t)}getError(){return this._error$.getValue()}unsubscribe(){this._subscriptions.forEach((e=>e&&e.unsubscribe()))}getValue(){return this._value$.getValue()}_quantityValuesWithFocusedControlObservable(){return this._focusedControl$.pipe((0,x.switchMap)((e=>{const t=1===e,i=t?this._baseCurrencyQuantity$:this._quoteCurrencyQuantity$,s=t?this._quoteCurrencyQuantity$:this._baseCurrencyQuantity$;return i.pipe((0,x.switchMap)((i=>s.pipe((0,m.map)((s=>({focusedControl:e,baseCurrencyQuantity:t?i:s,quoteCurrencyQuantity:t?s:i})))))))})))}_setUnfocusedControlsValues(e,t,i){1!==e&&this._setBaseCurrencyQuantity(t),2!==e&&this._setQuoteCurrencyQuantity(i)}_calculateQuantityValues(e){const{focusedControl:t,price:i,baseCurrencyQuantity:s,quoteCurrencyQuantity:r}=e;let o=s,n=r;switch(t){case 1:null!==s&&(n=(0,Z.Big)(s).mul(i).toNumber());break;case 2:null!==r&&(o=(0,Z.Big)(r).div(i).div(this.info.qty.step).round(0,0).mul(this.info.qty.step).toNumber())}return{baseCurrencyQuantity:(0,N.applyRounding)(o,this.formatter),quoteCurrencyQuantity:(0,N.applyRounding)(n,this.formatter)}}}class ot{constructor({initialDuration:e,orderType$:t,orderWidgetStat:i,orderDurations:s,symbolDurations:r,getOrderType:a}){this.onControlFocused=new z.Delegate,
this._value$=new n.BehaviorSubject(null),this._stopSubscriptions$=new o.Subject,this._error$=new n.BehaviorSubject({res:!1}),this.setError=e=>{this._error$.next(e)},this.getValue=()=>{const e=this._value$.value;if(null===e)return null;const t=this.getDurationMetaInfo(e);if(void 0===t)return null;const i={type:e.type};return(t.hasDatePicker||t.hasTimePicker)&&(i.datetime=e.datetime),i},this.setValue=(e,t)=>{const i=this._getDurationByOrderType(e,t);this._value$.next(i)},this.getOrderType=a,this.orderType$=t,this.durationMetaInfoList=void 0!==s?(0,N.filterDurationsBySymbolDurations)(s,r):[],this.value$=this._value$.asObservable(),this.error$=this._error$.asObservable(),this.onModifiedCallback=null!==i?()=>i.setDurationControlModifiedProperty():()=>{},this.setValue(e,a())}isDurationsAvailable(){return null!==this._getDurationByOrderType(this._value$.value,this.getOrderType())}subscribe(){this._stopSubscriptions$=new o.Subject,this.orderType$.pipe(c(this._stopSubscriptions$)).subscribe((e=>{this.setValue(this.getValue(),e)}))}unsubscribe(){this._stopSubscriptions$.next(),this._stopSubscriptions$.complete()}getDurationMetaInfo(e){if(null!==e)return this.durationMetaInfoList.find((t=>e.type===t.value))}_getDurationByOrderType(e,t){const i=(0,N.filterDurationsByOrderType)(this.durationMetaInfoList,t);if(0===i.length)return null;return null!==e&&i.some((t=>e.type===t.value))?e:(0,N.makeInitialOrderDuration)(t,i)}}var nt=Array.isArray;var at=i(423869);function lt(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=(0,y.popResultSelector)(e),s=function(e){return 1===e.length&&nt(e[0])?e[0]:e}(e);return s.length?new E.Observable((function(e){var t=s.map((function(){return[]})),r=s.map((function(){return!1}));e.add((function(){t=r=null}));for(var o=function(o){(0,d.innerFrom)(s[o]).subscribe(new l.OperatorSubscriber(e,(function(s){if(t[o].push(s),t.every((function(e){return e.length}))){var n=t.map((function(e){return e.shift()}));e.next(i?i.apply(void 0,(0,_.__spreadArray)([],(0,_.__read)(n),!1)):n),t.some((function(e,t){return!e.length&&r[t]}))&&e.complete()}}),(function(){r[o]=!0,!t[o].length&&e.complete()})))},n=0;!e.closed&&n<s.length;n++)o(n);return function(){t=r=null}})):at.EMPTY}function dt(e,t=100,i){const s=new Map,r=new Map;return function(...o){const n=String(i?i.apply(null,o):o),a=Date.now();if(s.has(n)&&(r.get(n)??-1/0)>a)return s.get(n);const l=e.apply(this,o);return s.set(n,l),r.set(n,a+t),l}}var ut=i(298670);const ct=(0,v.getLogger)("Trading.LeverageViewModel");class ht{constructor({adapterLeverageInfo:e,adapterSetLeverage:t,adapterPreviewLeverage:s,brokerName:o,symbol:a,displaySymbol:l,orderType$:d,getOrderType:u,side$:c,initialSide:h,customFieldsInputValues$:p,blocked$:_,isBlockedGetter:g,onBlockedClick:y,initialLeverageInfo:b}){this.onControlFocused=new z.Delegate,this._leveragePreviewResult$=new n.BehaviorSubject(null),this._subscription=void 0,this._abortController=new AbortController,this.leverageInfo=()=>this._leverageInfo$.getValue(),
this.leveragePreviewResult=()=>this._leveragePreviewResult$.getValue(),this.setLeverage=async e=>{try{const t=await this._adapterSetLeverage(e),i=this.leverageInfo();null!==i&&t&&this._leverageInfo$.next({...i,leverage:t.leverage})}catch(e){throw ct.logError(`Failed to set leverage: ${(0,k.getLoggerMessage)(e)}`),new Error(C.t(null,void 0,i(252888)))}},this.previewLeverage=async e=>{try{const t=await this._adapterPreviewLeverage(e);return this._leveragePreviewResult$.next(t),t}catch(e){throw this._leveragePreviewResult$.next(null),ct.logError(`Failed to preview leverage: ${(0,k.getLoggerMessage)(e)}`),new Error(C.t(null,void 0,i(48048)))}},this._updateLeverageInfo=async e=>{const t=await this.getLeverageInfo({symbol:this.symbol,orderType:this.orderType,side:this.side,customFields:this.customFields});e?.aborted||this._leverageInfo$.next(t)},this._customFieldsInputValues$=p,this._adapterLeverageInfo=e,this._updateLeverageInfo=(0,ut.respectLatest)(this._updateLeverageInfo),this._adapterSetLeverage=t,this._adapterPreviewLeverage=s,this.symbol=a,this.displaySymbol=l,this._orderType$=d,this._side$=c,this.brokerName=o,this._leverageInfo$=new n.BehaviorSubject(b),this.leverageInfo$=this._leverageInfo$.asObservable(),this.orderType=(0,r.ensureNotNull)(u()),this.side=h,this.blocked$=_,this.getBlocked=g,this.onBlockedClick=y,this.getLeverageInfo=dt(this.getLeverageInfo)}async getLeverageInfo(e){try{return await this._adapterLeverageInfo(e)}catch(e){return ct.logError(`Failed to get leverage info: ${(0,k.getLoggerMessage)(e)}`),null}}subscribe(){this._subscription=(0,L.combineLatest)({orderType:this._orderType$,side:this._side$,customFieldsDependencies:lt(this._customFieldsInputValues$,this.blocked$).pipe((0,m.map)((([e,t])=>({customFields:e,blocked:t}))))}).subscribe((({orderType:e,side:t,customFieldsDependencies:i})=>{if(this.orderType=(0,r.ensureNotNull)(e),this.side=t,this.customFields=i.customFields,i.blocked)return this._abortController.abort(),this._abortController=new AbortController,void this._leverageInfo$.next(null);this._updateLeverageInfo(this._abortController.signal)}))}unsubscribe(){this._subscription?.unsubscribe()}static async create(e){const{initialOrderType:t,initialCustomFieldsInputValues:i,initialSide:s,symbol:r,adapterLeverageInfo:o}=e;try{const n=await o({symbol:r,side:s,orderType:t,customFields:i});return new this({...e,initialSide:s,symbol:r,adapterLeverageInfo:o,initialLeverageInfo:n})}catch(e){return void ct.logError(`Failed to create Leverage View Model: ${(0,k.getLoggerMessage)(e)}`)}}}i(460351);const pt="",_t=(e,t)=>C.t(null,void 0,i(733740)).format({qty:e,symbol:t,whitespaceNoBreak:pt}),gt=(e,t,s)=>C.t(null,void 0,i(925609)).format({qty:e,symbol:t,stopPrice:s,whitespaceNoBreak:pt}),yt=(e,t,s)=>C.t(null,void 0,i(416342)).format({qty:e,symbol:t,limitPrice:s,whitespaceNoBreak:pt}),bt=(e,t,s,r)=>C.t(null,void 0,i(991313)).format({qty:e,symbol:t,stopPrice:s,limitPrice:r,whitespaceNoBreak:pt}),mt=C.t(null,void 0,i(874115));class vt{constructor(e,t,s){this._cancelButtonShown$=new n.BehaviorSubject(!1),
this._isBlocked$=new n.BehaviorSubject(!1),this.getValue=()=>this._value$.getValue(),this.isCancelButtonShown=()=>this._cancelButtonShown$.getValue(),this.getIsBlocked=()=>this._isBlocked$.getValue(),this.setIsBlocked=e=>{this._isBlocked$.next(e)},this.subscribe=()=>{if(this._tradingEntityType===R.TradingEntityType.Position)return void(this._displayModeSubscription=this._displayMode$.subscribe(this._handleDisplayModeValueChange));const e=(0,r.ensureDefined)(this._props);if(e.existingOrder)return void(this._displayModeSubscription=this._displayMode$.subscribe(this._handleDisplayModeValueChange));const t={status:e.status,orderType:e.orderType,orderPlacingStatus:e.orderPlacingStatus,side:e.side,quantity:e.quantity,stopPrice:e.stopPrice,limitPrice:e.limitPrice};this._orderSubscription=(0,L.combineLatest)(t).subscribe(this._orderSubscriptionValues)},this.unsubscribe=()=>{this._orderSubscription&&this._orderSubscription.unsubscribe(),this._displayModeSubscription&&this._displayModeSubscription.unsubscribe()},this._handleDisplayModeValueChange=e=>this._cancelButtonShown$.next(e===F.OrderEditorDisplayMode.Panel),this._orderSubscriptionValues=e=>{const t=(0,r.ensureDefined)(this._props),{status:s,orderType:o,orderPlacingStatus:n,side:a,quantity:l,stopPrice:d,limitPrice:u}=e;if(s===F.OrderPanelStatus.Preview)return this._cancelButtonShown$.next(!0),this._value$.next({primaryText:C.t(null,void 0,i(454674))});if(this._cancelButtonShown$.next(!1),s===F.OrderPanelStatus.Wait)return n===F.OrderPlacingStatus.Placed?this._value$.next({primaryText:C.t(null,void 0,i(348649))}):this._value$.next({primaryText:C.t(null,void 0,i(279856))});const c=1===a?C.t(null,void 0,i(169961)):C.t(null,void 0,i(168222));if(this._props?.shouldHideSecondaryText)return this._value$.next({primaryText:c});const h=null!==d?t.formatter.format(d):"",p=null!==u?t.formatter.format(u):"",_=null!==l?t.quantityFormatter.format(l):"";switch(o){case 2:return this._value$.next({primaryText:c,secondaryText:_t(_,t.symbol)});case 3:return this._value$.next({primaryText:c,secondaryText:gt(_,t.symbol,h)});case 1:return this._value$.next({primaryText:c,secondaryText:yt(_,t.symbol,p)});case 4:return this._value$.next({primaryText:c,secondaryText:bt(_,t.symbol,h,p)})}},this._tradingEntityType=e,this._value$=new n.BehaviorSubject({primaryText:""}),this._displayMode$=t,this.value$=this._value$.asObservable(),this.cancelButtonShown$=this._cancelButtonShown$.asObservable(),this.isBlocked$=this._isBlocked$.asObservable(),this._props=s,this._setInitialValue()}_setInitialValue(){switch(this._tradingEntityType){case R.TradingEntityType.Order:const e=!0===this._props?.existingOrder?mt:"";this._value$.next({primaryText:e});break;case R.TradingEntityType.Position:this._value$.next({primaryText:mt})}}}var ft=i(923978);function Pt({leverage:e,marginRate:t}){return void 0!==e?e:void 0===t?void 0:`${Math.round(1/t)}:1`}var St=i(229144);function kt(e){const{percentValue:t,currencyValue:i,formatter:s}=e;return(0,St.isRtl)()?`${s.format(i)} / %${s.format(t)}`:`${s.format(t)}% / ${s.format(i)}`}
class Ct{constructor({marginAvailable$:e,qty$:t,currency:i,pipValue$:s,price$:r,side$:o,stopLossType$:a,showTotalInsteadOfTradeValue:l,showRiskControlsAndInfo:d,info:u,tpInfo:c,slInfo:h,supportMargin:p,hideMarginIfNoLeverage:_,pipValueType$:g,leverageInfo$:y,marginMeterConfig:b,dependencies:m,supportCustomOrderInfo:v,brokerProvidedOrderInfoGetter:f,duration$:P,selectedPriceControl$:S,quotes$:k,relativePrice$:C,isBlocked$:T,leverageInfo:w}){this._infoTableData$=new n.BehaviorSubject({rows:[]}),this._availableMargin$=new n.BehaviorSubject(0),this._usedMargin$=new n.BehaviorSubject(0),this._leverageInfo=null,this._subscriptions=[],this._tpEnabled$=null,this._tpRiskInCurrency$=null,this._tpRiskInPercent$=null,this._tpPrice$=null,this._tpPriceEquivalent$=null,this._slEnabled$=null,this._slRiskInCurrency$=null,this._slRiskInPercent$=null,this._slPrice$=null,this._slPriceEquivalent$=null,this._riskFormatter=new j.PriceFormatter({priceScale:100}),this._brokerProvidedData$=new n.BehaviorSubject(void 0),this._brokerProvidedDataStatus$=new n.BehaviorSubject(3),this._brokerProvidedDataError$=new n.BehaviorSubject(void 0),this._isBrokerProvidedDataApproximate$=new n.BehaviorSubject(!1),this._abortController=new AbortController,this._setIsBrokerProvidedDataApproximate=e=>{this._isBrokerProvidedDataApproximate$.getValue()!==e&&this._isBrokerProvidedDataApproximate$.next(e)},this._updateBrokerProvidedOrderInfo=async e=>{},this._updateBrokerProvidedOrderInfo=(0,ut.respectLatest)(this._updateBrokerProvidedOrderInfo),this.infoTableData$=this._infoTableData$.asObservable(),this.availableMargin$=this._availableMargin$.asObservable(),this.usedMargin$=this._usedMargin$.asObservable(),this._leverageInfo=w,this._marginAvailable$=e,this._qty$=t,this._pipValue$=s,this._side$=o,this._type=u.type,this._pipValueType$=g,this._currency=i,this._marginRate=u.marginRate,this._stopLossType$=a,this._hasMarginMeter=Boolean(p&&(void 0!==y||(_?this._marginRate&&1!==Math.round(1/this._marginRate):void 0!==this._marginRate))),this._marginMeterConfig=b,this._price$=r,this._showTotalInsteadOfTradeValue=l,this._showRiskControlsAndInfo=d,this._bigPointValue=u.bigPointValue||1,this._instrumentCurrency=u.currency,this._leverageInfo$=y,this._leverage=u.leverage,this._lotSize=u.lotSize,this._symbolPipSize=u.pipSize,this._pipValueForCurrentQuantity=0,this._tradeValueInSymbolCurrency=0,this._tradeValue=0,this._priceMagnifier=u.priceMagnifier,this._getBrokerProvidedOrderInfo=f,this._duration$=P,this._selectedPriceControl$=S,this._quotes$=k,this._relativePrice$=C,this._isBlocked$=T,this._dependencies=m,this._supportCustomOrderInfo=v,this.brokerProvidedData$=this._brokerProvidedData$.asObservable(),this.brokerProvidedDataStatus$=this._brokerProvidedDataStatus$.asObservable(),this.brokerProvidedDataError$=this._brokerProvidedDataError$.asObservable(),this.isBrokerProvidedDataApproximate$=this._isBrokerProvidedDataApproximate$.asObservable(),c&&h&&(this._tpEnabled$=c.enabled,this._tpRiskInCurrency$=c.riskInCurrency,this._tpRiskInPercent$=c.riskInPercent,
this._tpPrice$=c.price$,this._tpPriceEquivalent$=c.priceEquivalent$,this._tpFocusedControl$=c.focusedControl$,this._slEnabled$=h.enabled,this._slRiskInCurrency$=h.riskInCurrency,this._slRiskInPercent$=h.riskInPercent,this._slPrice$=h.price$,this._slPriceEquivalent$=h.priceEquivalent$,this._slFocusedControl$=h.focusedControl$)}subscribe(){this._subscriptions=[(0,L.combineLatest)({price:this._price$,pipValue:this._pipValue$,pipValueType:this._pipValueType$,side:this._side$,qty:this._qty$,leverageInfo:void 0!==this._leverageInfo$?this._leverageInfo$:(0,A.of)(null),tpEnabled:null!==this._tpEnabled$?this._tpEnabled$:(0,A.of)(null),tpRiskInCurrency:null!==this._tpRiskInCurrency$?this._tpRiskInCurrency$:(0,A.of)(null),tpRiskInPercent:null!==this._tpRiskInPercent$?this._tpRiskInPercent$:(0,A.of)(null),slEnabled:null!==this._slEnabled$?this._slEnabled$:(0,A.of)(null),slRiskInCurrency:null!==this._slRiskInCurrency$?this._slRiskInCurrency$:(0,A.of)(null),slRiskInPercent:null!==this._slRiskInPercent$?this._slRiskInPercent$:(0,A.of)(null)}).pipe(We(100,void 0,{trailing:!0,leading:!0})).subscribe((e=>{const{price:t,pipValue:i,pipValueType:s,qty:r,leverageInfo:o,tpEnabled:n,tpRiskInCurrency:a,tpRiskInPercent:l,slEnabled:d,slRiskInCurrency:u,slRiskInPercent:c}=e;if(this._leverageInfo=o,this._pipValueForCurrentQuantity=(0,te.convertToBaseMonetaryUnit)((0,te.calculatePipValue)(r,i,this._lotSize),this._priceMagnifier),null===r)this._tradeValue=0,this._tradeValueInSymbolCurrency=0;else{const e="crypto"===this._type?(0,Z.Big)(r).mul(t).toNumber():ie(r,t,i,this._symbolPipSize,this._lotSize);this._tradeValue=(0,te.convertToBaseMonetaryUnit)(e,this._priceMagnifier);const s=se(r,t,this._bigPointValue,this._lotSize);this._tradeValueInSymbolCurrency=(0,te.convertToBaseMonetaryUnit)(s,this._priceMagnifier)}const h=[];h.push(...this._makeLotSizeInfo(),...this._makePipValueInfo(s),...this._makeTradeValueInfo(),...this._makeRewardInfo(n,a,l),...this._makeRiskInfo(d,u,c));const p=this.getMarginRate();null===o&&h.unshift(...this._makeLeverageInfo()),this._usedMargin$.next(ne(this._tradeValue,p)),this._infoTableData$.next({rows:h})}))],this._subscribeDependentFields(),this._hasMarginMeter&&this._subscriptions.push((0,r.ensureNotNull)(this._marginAvailable$).subscribe((e=>this._updateAvailableMargin(e))))}unsubscribe(){this._subscriptions.map((e=>e.unsubscribe())),this._abortController.abort()}title(){return C.t(null,void 0,i(330569))}getOrderInfoTableRowsCount(){return this._infoTableData$.getValue().rows.length+(this._brokerProvidedData$.getValue()?.rows.length??0)}hasMarginMeter(){return this._hasMarginMeter}marginMeterConfig(){return this._marginMeterConfig}hasTradeValue(){const e=this.getMarginRate();return Boolean(this._showRiskControlsAndInfo&&Number.isFinite(this._tradeValue)&&(this._isSymbolTypeSupportTradeValue()||void 0!==e))}getMarginRate(){return null!==this._leverageInfo?0!==this._leverageInfo.leverage?(0,Z.Big)(1).div(this._leverageInfo.leverage).toNumber():void 0:void 0!==this._marginRate&&this._marginRate>0?this._marginRate:void 0}
getBrokerProvidedData(){return this._brokerProvidedData$.value}_getTradeValue(){if(!this.hasTradeValue())return;const e=this._hasMarginMeter?1:this.getMarginRate()??1;return(0,ft.formatInfoValue)(this._tradeValue*e)}_setBrokerProvidedData(e){this._brokerProvidedData$.next(e)}_setIsBrokerProvidedDataStatus(e,t){2===e&&this._brokerProvidedDataError$.next(t),this._brokerProvidedDataStatus$.getValue()!==e&&this._brokerProvidedDataStatus$.next(e)}_makeObservableIfDependant(e,t){return void 0!==t&&this._dependencies?.includes(e)?t.pipe(distinctUntilChanged()):(0,A.of)(null)}_subscribeDependentFields(){}_updateAvailableMargin(e){this._availableMargin$.next(e)}_makeLeverageInfo(){const e=Pt({leverage:this._leverage,marginRate:this._marginRate});return void 0===e?[]:[{title:C.t(null,void 0,i(824813)),value:e}]}_makeLotSizeInfo(){return"number"==typeof this._lotSize&&Number.isFinite(this._lotSize)?[{title:C.t(null,void 0,i(574045)),value:String(this._lotSize)}]:[]}_makePipValueInfo(e){return this._showRiskControlsAndInfo&&e!==R.PipValueType.None&&Number.isFinite(this._pipValueForCurrentQuantity)?[{title:e===R.PipValueType.Pips?C.t(null,void 0,i(207074)):C.t(null,void 0,i(414285)),value:(0,ft.formatInfoValue)(this._pipValueForCurrentQuantity),currency:this._currency}]:[]}_makeTradeValueInfo(){const e=this._getTradeValue();if(void 0===e)return[];const t=this._showTotalInsteadOfTradeValue?C.t(null,void 0,i(408007)):C.t(null,void 0,i(248410)),s=this._getTradeValueInSymbolCurrency();return void 0===s?[{title:t,value:e,currency:this._currency}]:[{title:t},{title:C.t(null,void 0,i(902456)),value:e,currency:this._currency,listMarker:!0},{title:C.t(null,void 0,i(270743)),value:s,currency:this._instrumentCurrency,listMarker:!0}]}_getTradeValueInSymbolCurrency(){const e=this.getMarginRate()??1;if(void 0!==this._instrumentCurrency&&this._instrumentCurrency!==this._currency&&Number.isFinite(this._tradeValueInSymbolCurrency))return(0,ft.formatInfoValue)(this._tradeValueInSymbolCurrency*e)}_isSymbolTypeSupportTradeValue(){return void 0!==this._type&&["stock","dr","right","bond","warrant","structured"].includes(this._type)}_makeRewardInfo(e,t,s){return this._showRiskControlsAndInfo&&e&&null!==t&&null!==s?[{title:C.t(null,void 0,i(65183)),value:kt({percentValue:s,currencyValue:t,formatter:this._riskFormatter}),currency:this._currency}]:[]}_makeRiskInfo(e,t,s){return this._showRiskControlsAndInfo&&e&&null!==t&&null!==s?[{title:C.t(null,void 0,i(663886)),value:kt({percentValue:s,currencyValue:t,formatter:this._riskFormatter}),currency:this._currency}]:[]}}const Tt=(0,v.getLogger)("PromiseWithDefault");function wt(e,t,i){return e.catch((e=>(Tt.logError(e),i&&i(),t)))}const Bt={symbol:C.t(null,void 0,i(595481)),ask:C.t(null,void 0,i(535928)),askSize:C.t(null,void 0,i(313518)),bid:C.t(null,void 0,i(395506)),bidSize:C.t(null,void 0,i(912059)),orderType:C.t(null,void 0,i(998413)),side:C.t(null,void 0,i(777630)),quantity:C.t(null,void 0,i(598721)),price:C.t(null,void 0,i(7953)),stopPrice:C.t(null,void 0,i(475299)),
limitPrice:C.t(null,void 0,i(277646)),currency:C.t(null,void 0,i(381849)),stopLoss:C.t(null,void 0,i(719702)),takeProfit:C.t(null,void 0,i(255739)),buy:C.t(null,void 0,i(169961)),sell:C.t(null,void 0,i(168222)),warning:C.t(null,void 0,i(627822)),last:C.t(null,void 0,i(440846)),lastSize:C.t(null,void 0,i(274485))};class Ot{constructor(e,t,i,s,r,o,a,l){this.warnings=[],this.errors=[],this._infoTableQuotesData$=new n.BehaviorSubject({rows:[]}),this._infoTableOrderData={rows:[]},this._infoTableCustomData=[],this.order=e,this.confirmId=t.confirmId,this.onCancelClick=s,this.onPlaceClick=r,this._quotes$=i,this._currency=l,this._formatter=o,this._quantityFormatter=a,this._infoTableCustomData=t.sections,this._fillQuotesInfo(),this._fillOrderInfo(),(e.takeProfit||e.stopLoss)&&this.warnings.push(Bt.warning),t.warnings&&this.warnings.push(...t.warnings),t.errors&&this.errors.push(...t.errors),this.infoTableQuotesData$=this._infoTableQuotesData$.asObservable()}subscribe(){return this._quotes$.pipe((0,Y.distinctUntilChanged)(((e,t)=>e.ask===t.ask&&e.bid===t.bid))).subscribe((e=>this._fillQuotesInfo(e)))}infoTableOrderData(){return this._infoTableOrderData}infoTableCustomData(){return this._infoTableCustomData}_fillQuotesInfo(e){const t=[{title:Bt.symbol,value:this.order.symbol},{title:Bt.ask,value:e?this._formatter.format(e.ask):""},void 0!==e?.ask_size?{title:Bt.askSize,value:this._formatter.format(e.ask_size)}:void 0,{title:Bt.bid,value:e?this._formatter.format(e.bid):""},void 0!==e?.bid_size?{title:Bt.bidSize,value:this._formatter.format(e.bid_size)}:void 0];void 0!==e?.trade&&(t.push({title:e?.lastExchange?`${Bt.last} (${e.lastExchange})`:Bt.last,value:this._formatter.format(e.trade)}),void 0!==e?.size&&t.push({title:Bt.lastSize,value:this._formatter.format(e.size)})),this._infoTableQuotesData$.next({rows:t.filter((e=>void 0!==e))})}_fillOrderInfo(){this._infoTableOrderData.rows.push({title:Bt.orderType,value:this.order.type?F.orderTypes[this.order.type]:""},{title:Bt.side,value:1===this.order.side?Bt.buy:Bt.sell,type:1===this.order.side?0:1},{title:Bt.quantity,value:this._quantityFormatter.format(this.order.qty)}),3!==this.order.type&&1!==this.order.type||this._infoTableOrderData.rows.push({title:Bt.price,value:this._formatter.format(3===this.order.type?this.order.stopPrice:this.order.limitPrice)}),4===this.order.type&&this._infoTableOrderData.rows.push({title:Bt.stopPrice,value:this._formatter.format(this.order.stopPrice)},{title:Bt.limitPrice,value:this._formatter.format(this.order.limitPrice)}),this.order.stopLoss&&this._infoTableOrderData.rows.push({title:Bt.stopLoss,value:this._formatter.format(this.order.stopLoss)}),this.order.takeProfit&&this._infoTableOrderData.rows.push({title:Bt.takeProfit,value:this._formatter.format(this.order.takeProfit)}),this._currency.length>0&&this._infoTableOrderData.rows.push({title:Bt.currency,value:this._currency})}}var Mt=i(73359),Et=i(350146);const It=S.enabled("order_panel_undock");function Vt(e){
const{pin:t,mode$:s,settings$:r,setFocusedControl:o,showRelativePriceControl:n,showRiskControlsAndInfo:a,supportBrackets:l,supportPlaceOrderPreview:d,supportModifyOrderPreview:u,isUndockAllowed:c,toggleSettings:h}=e,p=e=>()=>h(e),_=e=>r.pipe((0,m.map)((t=>!!t[e]))),g=[];return c&&It&&g.push({settingType:1,onLabel:C.t(null,void 0,i(702733)),offLabel:C.t(null,void 0,i(442956)),dataName:"dock-undock-order-panel-button",onIcon:Mt,offIcon:Et,onClick:e=>{e.nativeEvent instanceof KeyboardEvent&&o(1),t()},value$:s.pipe((0,m.map)((e=>e===F.OrderEditorDisplayMode.Panel)))}),n&&g.push({settingType:0,label:C.t(null,void 0,i(373447)),onClick:p("showRelativePriceControl"),value$:_("showRelativePriceControl"),dataName:"order-ticket-price-in-ticks"}),a&&l&&g.push({settingType:0,label:C.t(null,{context:"Stop Loss order"},i(995302)),onClick:p("enableQuantityInRisk"),value$:_("enableQuantityInRisk"),dataName:"order-ticket-sl-qty-in-risk"}),(d||u)&&g.push({settingType:0,label:C.t(null,void 0,i(74600)),onClick:p("showOrderPreview"),value$:_("showOrderPreview"),dataName:"order-ticket-confirmation"}),g}var $t=i(34598);const Dt=(0,v.getLogger)("Trading.OrderViewModel"),Lt=9e15,xt=.01;function At(e){try{return new URL(e.url),!0}catch{return!1}}class qt{constructor({adapter:e,order:t,settings$:s,isTradable:o,isUndockAllowed$:a,orderWidgetStat:l=null,pipValueType$:d,onNeedSelectBroker:u,displayMode$:c,getDisplayMode:h,trackEvent:p,toggleTradingWidget:_,toggleTradingPanelPopup:g,toggleMode:y,showErrorNotification:b,sendHandler:m,previewHandler:v,toggleSettings:f,getSettings:P,orderViewInputState:S,qtySuggester:E,isVisible:I,orderDialogOptions:L,informerMessage$:x,warningMessage$:A,headerState:Q,isOrderPresetsEnabled:U,existingPlacedOrder:H}){if(this.orderInfoModel=null,this.orderPreviewModel=null,this.isFractional=!1,this.onDoneButtonClicked=(0,T.createDeferredPromise)(),this.needSignIn=!1,this.noBroker=!1,this.symbolHasLotSize=!1,this.id=(0,W.randomHashN)(6),this.existingOrder=!1,this.existingPlacedOrder=null,this._supportStopLoss=!0,this._onInputStateChanged=new z.Delegate,this._onCloseButtonClicked=new z.Delegate,this._onBackButtonClicked=new z.Delegate,this._onFocusSubscriptions=[],this._subscriptions=[],this._orderType$=new n.BehaviorSubject(null),this._loading$=new n.BehaviorSubject(!1),this._isButtonDisabled$=new n.BehaviorSubject(!0),this._rewardRisk$=new n.BehaviorSubject(""),this._isNoQuotes$=new n.BehaviorSubject(!1),this._orderWidgetStat=null,this._marginAvailable$=null,this._baseCurrencyCryptoBalance$=null,this._quoteCurrencyCryptoBalance$=null,this._isUndockAllowed=!1,this._orderPlacingStatus$=new n.BehaviorSubject(F.OrderPlacingStatus.Creating),this._destroyed=!1,this._setSolutionAccount=null,this._isBats=!1,this._dataLoadingAbortController=new AbortController,this.doneButtonClick=async()=>{if(!this.buttonModel?.getIsBlocked()&&!this._loading$.getValue()){if(this.getStatus()===F.OrderPanelStatus.Wait)return this._unblockDoneButtonClickTimerId=setTimeout((()=>{this.buttonModel?.setIsBlocked(!1),
this._unblockDoneButtonClickTimerId=void 0}),1e3),this.buttonModel?.setIsBlocked(!0),void this._activateOrderTicket();this.setLoading(!0);try{await this._doneButtonClick()}finally{this.setLoading(!1)}}},this.getOrderType=()=>this._orderType$.value,this.setOrderType=e=>{this._orderType$.next(e)},this.preOrder=()=>{const e={symbol:this.symbol,type:(0,r.ensureNotNull)(this._orderType$.value,"Make pre-order: Order type value"),qty:this.quantityModel.getValue()??0,side:this.sideModel.getValue(),seenPrice:this._calculateSeenPrice(),currentQuotes:this._getCurrentQuotes(),source:this._orderTemplate.source,creationSource:this._orderTemplate.creationSource};4===this._orderType$.value?(e.stopPrice=this.stopPriceModel.getValue()??void 0,e.limitPrice=this.limitPriceModel.getValue()??void 0):3===this._orderType$.value?e.stopPrice=this.stopPriceModel.getValue()??void 0:1===this._orderType$.value&&(e.limitPrice=this.limitPriceModel.getValue()??void 0);const t=this.durationModel.getValue();null!==t&&(e.duration=t),this.stopLossModel&&(this.stopLossModel.getBracketType()===R.BracketType.StopLoss&&(e.stopLoss=this.stopLossModel.getEnabled()?this.stopLossModel.price.getValue()??void 0:void 0,e.trailingStopPips=void 0,e.guaranteedStop=void 0,e.stopType=q.StopType.StopLoss),this.stopLossModel.getBracketType()===R.BracketType.TrailingStop&&(e.trailingStopPips=this.stopLossModel.getEnabled()?this.stopLossModel.getPips()??void 0:void 0,e.stopLoss=void 0!==e.trailingStopPips?void 0:e.stopLoss,e.guaranteedStop=void 0,e.stopType=q.StopType.TrailingStop),this.stopLossModel.getBracketType()===R.BracketType.GuaranteedStop&&(e.guaranteedStop=this.stopLossModel.getEnabled()?this.stopLossModel.price.getValue()??void 0:void 0,e.stopLoss=void 0!==e.guaranteedStop?void 0:e.stopLoss,e.trailingStopPips=void 0,e.stopType=q.StopType.GuaranteedStop)),this.takeProfitModel&&(this.takeProfitModel.getEnabled()?e.takeProfit=this.takeProfitModel.price.getValue()??void 0:e.takeProfit=void 0),this.customFieldsModel.getCustomFieldsModels()&&(e.customFields=this.customFieldsModel.getCustomFieldsInputValues());const i=this.orderInfoModel?.getBrokerProvidedData();return void 0!==i&&(e.orderInfoId=i.id),e},this.activateOrderTicket=()=>{this._activateOrderTicket(),this._orderTypeSubscription?.unsubscribe(),this.sideModel&&this.sideModel.onControlFocused.unsubscribe(this,this.activateOrderTicket),this.limitPriceModel&&this.limitPriceModel.onControlFocused.unsubscribe(this,this.activateOrderTicket),this.stopPriceModel&&this.stopPriceModel.onControlFocused.unsubscribe(this,this.activateOrderTicket),this.quantityModel&&this.quantityModel.onControlFocused.unsubscribe(this,this.activateOrderTicket),this.leverageModel&&this.leverageModel.onControlFocused.unsubscribe(this,this.activateOrderTicket),this.takeProfitModel&&this.takeProfitModel.onControlFocused.unsubscribe(this,this.activateOrderTicket),this.stopLossModel&&this.stopLossModel.onControlFocused.unsubscribe(this,this.activateOrderTicket),
this.durationModel&&this.durationModel.onControlFocused.unsubscribe(this,this.activateOrderTicket),this._onFocusSubscriptions.forEach((e=>e.unsubscribe())),this.buttonModel?.getIsBlocked()&&this.buttonModel.setIsBlocked(!1),this._unblockDoneButtonClickTimerId&&(clearTimeout(this._unblockDoneButtonClickTimerId),this._unblockDoneButtonClickTimerId=void 0)},this.setLoading=e=>{this._loading$.next(e)},this.setStatus=e=>{this._status$.value!==e&&this._status$.next(e)},this.setOrderPlacingStatus=e=>{this._orderPlacingStatus$.getValue()!==e&&this._orderPlacingStatus$.next(e)},this._activateOrderTicket=()=>{this.setStatus(this.existingOrder?F.OrderPanelStatus.Editing:F.OrderPanelStatus.Active),this._orderPlacingStatus$.next(F.OrderPlacingStatus.Creating)},this._getBrokerProvidedOrderInfo=async()=>{const e={...this.preOrder(),id:this.existingPlacedOrder?.id};return this._adapter.orderInfo?.(e)},this._doneButtonClick=async()=>{const e=this.preOrder(),t=this.existingOrder?this.supportModifyOrderPreview:this.supportPlaceOrderPreview,s=this._getDisplayMode();if(t&&this._getSettings().showOrderPreview&&null===this.orderPreviewModel){const t=this.supportModifyOrderPreview&&null!==this.existingPlacedOrder?{...e,id:this.existingPlacedOrder.id}:e;try{const e=await this._previewHandler(t),i=this.supportCurrencyInOrderPreview&&void 0!==this._symbolInfo.currency?this._symbolInfo.currency:"";this.orderPreviewModel=new Ot(t,e,this._quotes$,this._back,this.doneButtonClick,this.formatter,this.quantityModel.formatter,i),this._subscriptions.push(this.orderPreviewModel.subscribe()),this.setStatus(F.OrderPanelStatus.Preview)}catch(e){this._isFullscreenPopup()&&this.headerModel.close(),s===F.OrderEditorDisplayMode.ResizableDrawer&&this.headerModel.close(),this._showErrorNotification(C.t(null,void 0,i(204395)),(0,k.getErrorMessage)(e))}return}await this._doneHandler(e,null!==this.orderPreviewModel?this.orderPreviewModel.confirmId:void 0)?(this.onDoneButtonClicked.resolve(!0),s===F.OrderEditorDisplayMode.Popup||s===F.OrderEditorDisplayMode.ResizableDrawer?this.headerModel.close():this._cancel(),this.existingOrder||this._orderPlacingStatus$.next(F.OrderPlacingStatus.Placed)):(this._isFullscreenPopup()&&this.headerModel.close(),s===F.OrderEditorDisplayMode.Panel&&null!==this.orderPreviewModel&&1===this._adapter.connectionStatus()&&this._back(),s===F.OrderEditorDisplayMode.ResizableDrawer&&this.headerModel.close()),this.orderPreviewModel=null},this._noQuotesCallback=()=>{this._trackEvent("Order Ticket","No Quotes")},this._resetPlacingStatusWithDelay=e=>{void 0!==this._resetPlacingStatusTimerId&&(clearTimeout(this._resetPlacingStatusTimerId),this._resetPlacingStatusTimerId=void 0),e===F.OrderPlacingStatus.Placed&&(this._resetPlacingStatusTimerId=setTimeout((()=>this._orderPlacingStatus$.next(F.OrderPlacingStatus.Creating)),1e3))},this._handleStatusChange=e=>{const t=e!==F.OrderPanelStatus.Preview&&this._isTradable?this._makeHeaderSettings():void 0;this._headerState.setSettings(t),
e===F.OrderPanelStatus.Wait&&(this.buttonModel?.getIsBlocked()&&this.buttonModel.setIsBlocked(!1),this._unblockDoneButtonClickTimerId&&(clearTimeout(this._unblockDoneButtonClickTimerId),this._unblockDoneButtonClickTimerId=void 0))},this._onUndockAllowedChanged=e=>{this._isUndockAllowed=e;const t=this._status$.value!==F.OrderPanelStatus.Preview&&this._isTradable?this._makeHeaderSettings():void 0;this._headerState.setSettings(t)},this._handleBeforeQuantityTypeChange=e=>{this.stopLossModel&&this._shouldChangeControlFocus(this.stopLossModel.getFocusedControl(),this.stopLossModel.getPriceEquivalentType(),"units"===e?0:3,e)&&this.stopLossModel.setFocusedControl("Price")},this._handleBeforeSLFocusedControlChange=e=>{this.stopLossModel&&this.quantityModel instanceof tt&&this._shouldChangeControlFocus(e,this.stopLossModel.getPriceEquivalentType(),this.quantityModel.getFocusedControl(),this.quantityModel.getInputType())&&this.quantityModel.setInputTypeAndValue("units",this.quantityModel.quantity.getValue())},this._handleBeforeSLPriceEquivalentTypeChange=e=>{this.stopLossModel&&this.quantityModel instanceof tt&&this._shouldChangeControlFocus(this.stopLossModel.getFocusedControl(),e,this.quantityModel.getFocusedControl(),this.quantityModel.getInputType())&&this.quantityModel.setInputTypeAndValue("units",this.quantityModel.quantity.getValue())},this._mergeInputStateDiff=e=>{void 0!==e.duration&&(this._currentInputState.duration=null),Object.assign(this._currentInputState,e)},this._back=()=>{this._cleanUp(),this._onBackButtonClicked.fire()},this._onSuggestedQtyChange=e=>{this._suggestedQty=e,!this._isOrderSizeCalculatorAvailable()&&this.quantityModel&&this.quantityModel.getValue()!==e&&(this.quantityModel.setFocusedControl(this.supportCryptoExchangeOrderTicket()?1:0),this.quantityModel.quantity.setValue(e))},this._onQtyChange=e=>{this._isOrderSizeCalculatorAvailable()||null===e||this._qtySuggester.setQty(this.symbol,e)},this._isOrderPresetsEnabled=U,this._isTradable=o.tradable,this._headerState=Q,this.headerStateValue=Q,this._headerState.setSettings(void 0),this._displayMode$=c,this._getDisplayMode=h,this._toggleTradingWidget=_,this._toggleTradingPanelPopup=g,this._toggleMode=y,this._toggleSettings=f,this._getSettings=P,this._onNeedSelectBroker=u,this._showErrorNotification=b,this._trackEvent=p,this._orderWidgetStat=l,this._pipValueType$=d,this._qtySuggester=E,this._informerMessage$=x,this._settings$=s,this._orderTemplate=Object.assign({},t),H&&(this.existingOrder=!0,this.existingPlacedOrder=H),this.useContextValidation=false,this.warningMessage$=A,this.symbol=t.symbol,this.displaySymbolName=this._getCurrentSymbolName(),this._isUndockAllowed$=a,this._isVisible=I,this._status$=new n.BehaviorSubject(this.existingOrder?F.OrderPanelStatus.Editing:F.OrderPanelStatus.Active),this._stopLossAvailable$=new n.BehaviorSubject(Boolean(t.trailingStopPips??t.guaranteedStop??t.stopLoss)),this.orderPlacingStatus$=this._orderPlacingStatus$.asObservable(),this.orderType$=this._orderType$.asObservable(),this.loading$=this._loading$.asObservable(),
this.status$=this._status$.asObservable(),this.rewardRisk$=this._rewardRisk$.asObservable(),this.isNoQuotes$=this._isNoQuotes$.asObservable(),this.isButtonDisabled$=this._isButtonDisabled$.asObservable(),null===e)return void(this.onReady=Promise.resolve());if(this._adapter=e,this.brokerName=e.metainfo().title,!o.tradable)return void(this.onReady=this._prepareTradableSolution(o));this._sendHandler=m,this._previewHandler=v,this.existingOrder=t.hasOwnProperty("id"),this.setStatus(this.existingOrder?F.OrderPanelStatus.Editing:F.OrderPanelStatus.Active);const K=e.metainfo().configFlags;this.supportModifyOrderPrice=K.supportModifyOrderPrice,this.supportModifyQuantity=!this.existingOrder||Boolean(this.existingOrder&&K.supportEditAmount),this.supportModifyDuration=K.supportModifyDuration,this.supportLeverage=K.supportLeverage,this.supportLeverageButton=K.supportLeverage&&K.supportLeverageButton,this.supportPlaceOrderPreview=K.supportPlaceOrderPreview,this.supportModifyOrderPreview=K.supportModifyOrderPreview,this.supportBalances=K.supportBalances,this.supportCryptoBrackets=K.supportCryptoBrackets,this.supportStopOrdersInBothDirections=K.supportStopOrdersInBothDirections,this.supportStopLimitOrdersInBothDirections=K.supportStopLimitOrdersInBothDirections,this.supportStrictCheckingLimitOrderPrice=K.supportStrictCheckingLimitOrderPrice,this.supportCurrencyInOrderPreview=K.supportCurrencyInOrderPreview,this.supportModifyOrderType=K.supportModifyOrderType,this.supportHyperlinksInOrderDialog=K.supportHyperlinksInOrderDialog,this._orderType$.next(t.type??S?.orderType??(0,N.getDefaultOrderType)(K)??null),this.onReady=Promise.all([e.symbolInfo(t.symbol),e.getSymbolSpecificTradingOptions(t.symbol),e.orders(t.symbol),(0,$t.isFractional)(t.symbol,{signal:this._dataLoadingAbortController.signal}),wt(e.accountMetainfo(),{id:e.currentAccount(),name:e.metainfo().title}),wt(e.quotesSnapshot(t.symbol),{},this._noQuotesCallback),wt(e.formatter(t.symbol,!1),new j.PriceFormatter),wt(e.spreadFormatter(t.symbol),new j.PriceFormatter)]).then((async([i,s,r,n,a,l,d,u])=>{if(this.isFractional=n,this._isBats=(0,N.isBatsQuotes)(l),this._supportCryptoExchangeOrderTicket=K.supportCryptoExchangeOrderTicket||K.supportSymbolSpecificCryptoOrderTicket&&"crypto"===i.type,this._symbolInfo=i,this._destroyed)return;this._supportMarketOrders=K.supportMarketOrders&&(0,N.isOrderTypeAllowed)(2,s?.allowedOrderTypes),this._supportLimitOrders=K.supportLimitOrders&&(0,N.isOrderTypeAllowed)(1,s?.allowedOrderTypes),this._supportStopOrders=K.supportStopOrders&&(0,N.isOrderTypeAllowed)(3,s?.allowedOrderTypes),this._supportStopLimitOrders=K.supportStopLimitOrders&&(0,N.isOrderTypeAllowed)(4,s?.allowedOrderTypes),this._supportBrackets=s?.supportOrderBrackets&&!(t.hasOwnProperty("parentId")&&t.parentId)&&!(t.hasOwnProperty("originalParentId")&&t.originalParentId),this._supportBracketsInPips=s?.supportBracketsInPips,this._supportModifyBrackets=this._supportBrackets&&K.supportModifyBrackets&&K.supportModifyOrderBrackets,
this._supportAddBracketsToExistingOrder=this._supportModifyBrackets&&K.supportAddBracketsToExistingOrder,this._supportStopLoss=Boolean(this._supportBrackets&&(K.supportStopLoss??!0)),this._supportTrailingStop=this._supportBrackets&&K.supportTrailingStop,this._supportGuaranteedStop=this._supportBrackets&&K.supportGuaranteedStop,this._supportMarketBrackets=this._supportBrackets&&K.supportMarketBrackets,this._supportOnlyPairOrderBrackets=this._supportBrackets&&K.supportOnlyPairOrderBrackets,this._supportModifyTrailingStop=this._supportTrailingStop&&this._supportModifyBrackets&&K.supportModifyTrailingStop,this._links=L?.links?.filter(At),this.displaySymbolName=this._getCurrentSymbolName(),this.symbolType=i.type,this.symbolSpecificWarningMessage=s?.warningMessage,this.currency=(0,N.getCurrency)(a),this._currencyName=(0,N.getCurrency)(a,!0),this._accountCurrencyPrecision=a.currencyPrecision,this.formatter=d,this.symbolHasLotSize=i.hasOwnProperty("lotSize")&&1!==i.lotSize,this.showRiskControlsAndInfo=s?.supportRiskControlsAndInfo&&0!==i.pipValue,this.showRiskInInstrumentCurrency=K.showRiskInInstrumentCurrency,this._suggestedQty=await this._qtySuggester.getQty(this.symbol),this._initialInputState=this._getInitialInputState(t,i,S,s),this._currentInputState=Object.assign({},this._initialInputState);const c=i.variableMinTick?(0,G.makeVariableMinTickData)(i.minTick,i.variableMinTick):void 0;this._quotes$=(0,w.fromEventPattern)((i=>e.subscribeRealtime(t.symbol,i)),(i=>e.unsubscribeRealtime(t.symbol,i)),((e,t)=>(0,te.alignQuotesToMinTick)(t,i.minTick,c))).pipe((0,B.startWith)(l),(0,O.share)({connector:()=>new M.ReplaySubject(1)})),this._equity$=(0,w.fromEventPattern)((t=>e.subscribeEquity(t)),(t=>e.unsubscribeEquity(t)),((e,t)=>t)).pipe((0,B.startWith)(NaN),(0,O.share)({connector:()=>new M.ReplaySubject(1)})),this._marginAvailable$=K.supportMargin?V((0,w.fromEventPattern)((t=>e.subscribeMarginAvailable(t)),(t=>e.unsubscribeMarginAvailable(t)),((e,t)=>t))):null,this._baseCurrencyCryptoBalance$=K.supportBalances?V((0,w.fromEventPattern)((t=>e.subscribeCryptoBalance(i.baseCurrency||"",t)),(t=>e.unsubscribeCryptoBalance(i.baseCurrency||"",t)),((e,t)=>t)).pipe((0,B.startWith)({symbol:i.baseCurrency||"",total:0,available:0}))):null,this._quoteCurrencyCryptoBalance$=K.supportBalances?V((0,w.fromEventPattern)((t=>e.subscribeCryptoBalance(i.quoteCurrency||"",t)),(t=>e.unsubscribeCryptoBalance(i.quoteCurrency||"",t)),((e,t)=>t)).pipe((0,B.startWith)({symbol:i.quoteCurrency||"",total:0,available:0}))):null,this._pipValues$=V((0,w.fromEventPattern)((i=>e.subscribePipValue(t.symbol,i)),(i=>e.unsubscribePipValue(t.symbol,i)),((e,t)=>t)).pipe((0,B.startWith)({buyPipValue:i.pipValue,sellPipValue:i.pipValue}))),this._orderTemplate=this._makeOrderTemplate(l),await this._createModels({order:t,info:i,spreadFormatter:u,isTradable:o.tradable,symbolSpecificTradingOptions:s,orderDialogOptions:L,orders:r}),this._subscribe();const h=this.stopLossModel?.isValuesInitialized$.pipe((0,$.filter)((e=>e))),p=this.takeProfitModel?.isValuesInitialized$.pipe((0,
$.filter)((e=>e)));await Promise.all([h?(0,D.firstValueFrom)(h):void 0,p?(0,D.firstValueFrom)(p):void 0]),this._headerState.setSettings(this._makeHeaderSettings())})).catch((e=>{throw Dt.logError("Failed to create order model: "+e),e})),this.onReady.then((()=>this._onInputStateChanged.fire(this._getCurrentInputState()))).catch((()=>{}))}destroy(){this._destroyed=!0,this._dataLoadingAbortController.abort(),this.onInputStateChanged().unsubscribe(this,this._mergeInputStateDiff),this._subscriptions.forEach((e=>e&&e.unsubscribe())),this.orderInfoModel?.unsubscribe(),this._orderTypeSubscription&&this._orderTypeSubscription.unsubscribe(),this._onFocusSubscriptions.forEach((e=>e.unsubscribe())),this.headerModel&&(this.headerModel.unsubscribe(),this.headerModel.pinButtonClicked().unsubscribe(this,this._toggleMode),this.headerModel.closeButtonClicked().unsubscribe(this,this._closeWidget)),this.sideModel&&(this.sideModel.unsubscribe(),this.sideModel.onControlFocused.unsubscribe(this,this.activateOrderTicket)),this.limitPriceModel&&(this.limitPriceModel.unsubscribe(),this.limitPriceModel.onControlFocused.unsubscribe(this,this.activateOrderTicket)),this.stopPriceModel&&(this.stopPriceModel.unsubscribe(),this.stopPriceModel.onControlFocused.unsubscribe(this,this.activateOrderTicket)),this.priceGroupModel&&this.priceGroupModel.unsubscribe(),this.quantityConverterController&&this.quantityConverterController.destroy(),this.quantityModel&&(this.quantityModel.unsubscribe(),this.quantityModel.onControlFocused.unsubscribe(this,this.activateOrderTicket)),this.takeProfitModel&&(this.takeProfitModel.unsubscribe(),this.takeProfitModel.onControlFocused.unsubscribe(this,this.activateOrderTicket)),this.stopLossModel&&(this.stopLossModel.unsubscribe(),this.stopLossModel.onControlFocused.unsubscribe(this,this.activateOrderTicket)),this.durationModel&&(this.durationModel.unsubscribe(),this.durationModel.onControlFocused.unsubscribe(this,this.activateOrderTicket)),void 0!==this.leverageModel&&(this.leverageModel.unsubscribe(),this.leverageModel.onControlFocused.unsubscribe(this,this.activateOrderTicket)),void 0!==this.customFieldsModel&&this.customFieldsModel.unsubscribe(),void 0!==this.buttonModel&&this.buttonModel.unsubscribe(),this._adapter&&this._adapter.orderUpdate.unsubscribe(this,this._orderUpdate),void 0!==this._unblockDoneButtonClickTimerId&&(clearTimeout(this._unblockDoneButtonClickTimerId),this._unblockDoneButtonClickTimerId=void 0)}links(){if(this.supportHyperlinksInOrderDialog&&this._links&&this._links.length)return this._links}supportCryptoExchangeOrderTicket(){return Boolean(this._supportCryptoExchangeOrderTicket)}supportLimitOrders(){return Boolean(this._supportLimitOrders)}supportMarketOrders(){return Boolean(this._supportMarketOrders)}supportStopOrders(){return Boolean(this._supportStopOrders)}supportStopLimitOrders(){return Boolean(this._supportStopLimitOrders)}supportBrackets(){return Boolean(this._supportBrackets)}supportAddBracketsToExistingOrder(){return Boolean(this._supportAddBracketsToExistingOrder)}
supportModifyBrackets(){return Boolean(this._supportModifyBrackets)}supportStopLoss(){return Boolean(this._supportStopLoss)}supportTrailingStop(){return Boolean(this._supportTrailingStop)}supportGuaranteedStop(){return Boolean(this._supportGuaranteedStop)}supportMarketBrackets(){return Boolean(this._supportMarketBrackets)}supportModifyTrailingStop(){return Boolean(this._supportModifyTrailingStop)}onInputStateChanged(){return this._onInputStateChanged}onCloseButtonClicked(){return this._onCloseButtonClicked}onBackButtonClicked(){return this._onBackButtonClicked}side(){return this.sideModel?.getValue()}setSolutionAccount(){null!==this._setSolutionAccount&&this._setSolutionAccount()}selectBroker(){this._toggleTradingWidget().then((()=>this._onNeedSelectBroker.fire()))}orderWidgetStat(){return this._orderWidgetStat}resetOrderPanel(){this._cancel()}deactivateOrderTicket(){this.getStatus()!==F.OrderPanelStatus.Wait&&(this.setStatus(F.OrderPanelStatus.Wait),this._orderTypeSubscription=this.orderType$.pipe((0,h.skip)(1)).subscribe(this.activateOrderTicket),this.sideModel&&this.sideModel.onControlFocused.subscribe(this,this.activateOrderTicket),this.limitPriceModel&&this.limitPriceModel.onControlFocused.subscribe(this,this.activateOrderTicket),this.stopPriceModel&&this.stopPriceModel.onControlFocused.subscribe(this,this.activateOrderTicket),this.quantityModel&&this.quantityModel.onControlFocused.subscribe(this,this.activateOrderTicket),void 0!==this.leverageModel&&this.leverageModel.onControlFocused.subscribe(this,this.activateOrderTicket),this.takeProfitModel&&(this.takeProfitModel.setEnabled(!1),this.takeProfitModel.onControlFocused.subscribe(this,this.activateOrderTicket)),this.stopLossModel&&(this.stopLossModel.setEnabled(!1),this.stopLossModel.onControlFocused.subscribe(this,this.activateOrderTicket)),this.durationModel&&this.durationModel.onControlFocused.subscribe(this,this.activateOrderTicket),this.customFieldsModel&&this._onFocusSubscriptions.push(this.customFieldsModel.onControlFocused$.subscribe(this.activateOrderTicket)))}setOrderCreationSource(e){this._orderTemplate.creationSource=e}orderTemplate(){const e=this.preOrder(),t=this.limitPriceModel.getPriceControlData()?.offset??void 0,i=this.stopPriceModel.getPriceControlData()?.offset??void 0;4===this._orderType$.value?(e.limitPriceOffset=t,e.stopPriceOffset=i):3===this._orderType$.value?e.stopPriceOffset=i:1===this._orderType$.value&&(e.limitPriceOffset=t);const s=!this.stopLossModel?.roundToPriceStepRequired&&!this.takeProfitModel?.roundToPriceStepRequired;if(this.stopLossModel?.getEnabled())if(this.showRiskControlsAndInfo&&"PriceEquivalent"===this.stopLossModel.getFocusedControl()&&"RiskInPercent"===this.stopLossModel.getPriceEquivalentType())e.stopLossPips=void 0,e.stopLossParentPricePercent=void 0,
e.stopLossRiskInPercent=this.stopLossModel.priceEquivalent.getValue()??void 0;else if("PriceEquivalent"===this.stopLossModel.getFocusedControl()&&"ParentPricePercent"===this.stopLossModel.getPriceEquivalentType())e.stopLossParentPricePercent=this.stopLossModel.priceEquivalent.getValue()??void 0,e.stopLossRiskInPercent=void 0,e.stopLossPips=void 0;else if(s)e.stopLossPips=this.stopLossModel.getPips()??void 0,e.stopLossRiskInPercent=void 0,e.stopLossParentPricePercent=void 0;else{const t=this.stopLossModel.getParentPricePercent()??void 0;t&&(e.stopLossPips=void 0,e.stopLossRiskInPercent=void 0,e.stopLossParentPricePercent=t)}if(this.takeProfitModel?.getEnabled())if(this.showRiskControlsAndInfo&&"PriceEquivalent"===this.takeProfitModel.getFocusedControl()&&"RiskInPercent"===this.takeProfitModel.getPriceEquivalentType())e.takeProfitPips=void 0,e.takeProfitParentPricePercent=void 0,e.takeProfitRiskInPercent=this.takeProfitModel.priceEquivalent.getValue()??void 0;else if("PriceEquivalent"===this.takeProfitModel.getFocusedControl()&&"ParentPricePercent"===this.takeProfitModel.getPriceEquivalentType())e.takeProfitParentPricePercent=this.takeProfitModel.priceEquivalent.getValue()??void 0,e.takeProfitPips=void 0,e.takeProfitRiskInPercent=void 0;else if(s)e.takeProfitPips=this.takeProfitModel.getPips()??void 0,e.takeProfitRiskInPercent=void 0,e.takeProfitParentPricePercent=void 0;else{const t=this.takeProfitModel.getParentPricePercent()??void 0;t&&(e.takeProfitPips=void 0,e.takeProfitRiskInPercent=void 0,e.takeProfitParentPricePercent=t)}return e}getStatus(){return this._status$.getValue()}isButtonDisabled(){return this._isButtonDisabled$.getValue()}_isFullscreenPopup(){return window.matchMedia(U.DialogBreakpoints.TabletSmall).matches&&this._getDisplayMode()===F.OrderEditorDisplayMode.Popup}_createSimpleDialog(e){this._orderType$.next(null),this.setStatus(F.OrderPanelStatus.Wait),this.headerModel=new qe({displaySymbolName:this.displaySymbolName,symbol:this.symbol,brokerName:e?e.metainfo().title:"",mode$:this._displayMode$,status$:this._status$,parentType:1,isExistingOrder:!1,isTradable:!1,quotes$:this._quotes$,data:void 0,formatter:void 0,isBats:this._isBats,informerMessage$:this._informerMessage$,isOrderPresetsEnabled:this._isOrderPresetsEnabled,headerState:this._headerState,orderTemplateGetter:()=>this.orderTemplate(),brokerId:this._adapter?.metainfo().id,accountType:this._adapter?.currentAccountType(),isSendButtonDisabled$:this.isButtonDisabled$,brokerLogo:{logo:this._adapter?.metainfo().logoMiniUrl,logoBlack:this._adapter?.metainfo().logoMiniBlackUrl}}),this.headerModel.closeButtonClicked().subscribe(this,this._closeWidget)}async _createModels(e){const{order:t,info:i,spreadFormatter:s,isTradable:o,symbolSpecificTradingOptions:n,orderDialogOptions:a,orders:l}=e,d=this.supportCryptoExchangeOrderTicket();this.sideModel=new ze({initialSide:this._initialInputState.side,quotes$:this._quotes$,priceFormatter:this.formatter,spreadFormatter:s,baseCurrency:d&&"crypto"===i.type&&i.baseCurrency||null}),this._pipValue$=(0,
L.combineLatest)([this._pipValues$,this.sideModel.value$]).pipe((0,m.map)((([e,t])=>1===t?e.buyPipValue:e.sellPipValue)));const{orderRules:u=[],title:c}=this._adapter.metainfo();let h=[],p=[];if(this.supportStopOrdersInBothDirections&&this.supportStopLimitOrdersInBothDirections||(h=await(0,Q.extractLimitValidationRules)(this._adapter,this.symbol)??[],p=await(0,Q.extractStopValidationRules)(this._adapter,this.symbol)??[]),this.stopPriceModel=new Ae({priceType:2,quotes$:this._quotes$,side$:this.sideModel.value$,info:i,status$:this._status$,formatter:this.formatter,orderType$:this.orderType$,settings$:this._settings$,brokerTitle:c,orderWidgetStat:this._orderWidgetStat,initialPrice:this._orderTemplate.stopPrice,initialOffset:this._orderTemplate.stopPriceOffset,orderRules:[...u,...p],supportStopOrdersInBothDirections:this.supportStopOrdersInBothDirections,supportStopLimitOrdersInBothDirections:this.supportStopLimitOrdersInBothDirections,getSettings:this._getSettings,useContextValidation:this.useContextValidation,originalOrderPrice:3===this._orderType$.getValue()||4===this._orderType$.getValue()?this.existingPlacedOrder?.stopPrice:void 0}),this.limitPriceModel=new Ae({priceType:1,quotes$:this._quotes$,side$:this.sideModel.value$,info:i,status$:this._status$,formatter:this.formatter,orderType$:this.orderType$,settings$:this._settings$,brokerTitle:c,orderWidgetStat:this._orderWidgetStat,getSettings:this._getSettings,initialPrice:this._orderTemplate.limitPrice,initialOffset:this._orderTemplate.limitPriceOffset,orderRules:[...u,...h],stopPriceControlData$:this.stopPriceModel.priceControlData$,supportStrictCheckingLimitOrderPrice:this.supportStrictCheckingLimitOrderPrice,useContextValidation:this.useContextValidation,originalOrderPrice:1===this._orderType$.getValue()||4===this._orderType$.getValue()?this.existingPlacedOrder?.limitPrice:void 0}),this.priceGroupModel=new He({stopPriceModel:this.stopPriceModel,limitPriceModel:this.limitPriceModel,orderType$:this.orderType$,side$:this.sideModel.value$,quotes$:this._quotes$}),d)this.quantityModel=new rt({info:i,price$:this.priceGroupModel.price$,baseCurrencyCryptoBalance$:this._baseCurrencyCryptoBalance$,quoteCurrencyCryptoBalance$:this._quoteCurrencyCryptoBalance$,initialQty:this._initialInputState.quantity,side$:this.sideModel.value$,sideGetter:this.sideModel.getValue,orderWidgetStat:this._orderWidgetStat,isExistingOrder:this.existingOrder,orderQty:t.qty,orderPrice:1===t.type?t.limitPrice:t.stopPrice,useContextValidation:this.useContextValidation});else{let e=this._initialInputState.lastUsedQuantityType;this._initialInputState.orderSizeCalculatorQuantityType&&["riskInPercent","riskInCurrency"].includes(this._initialInputState.orderSizeCalculatorQuantityType)&&this._initialInputState.stopLossPriceEquivalentType&&["RiskInCurrency","RiskInPercent"].includes(this._initialInputState.stopLossPriceEquivalentType)&&(e="units"),this.quantityModel=new tt({stopLossAvailable$:this._stopLossAvailable$,info:i,currency:this.currency??"",initialQty:this._initialInputState.quantity,
initialOrderSizeCalculatorValue:this._initialInputState.orderSizeCalculatorValue,initialOrderSizeCalculatorQuantityType:this._initialInputState.orderSizeCalculatorQuantityType,initialLastRiskQuantityType:this._initialInputState.lastRiskQuantityType,initialLastUsedQuantityType:e,stopLossAvailableGetter:()=>this._stopLossAvailable$.getValue(),settings$:this._settings$,orderWidgetStat:this._orderWidgetStat,showRiskControlsAndInfo:this.showRiskControlsAndInfo,accountCurrencyPrecision:this._accountCurrencyPrecision,useContextValidation:this.useContextValidation,beforeQuantityTypeChangeHandler:this._handleBeforeQuantityTypeChange})}const _=this.supportBrackets();(_||this.supportCryptoBrackets)&&await this._createBracketsModels(t,i,(0,r.ensureDefined)(this.currency),l),this.headerModel=new qe({displaySymbolName:this.displaySymbolName,symbol:this.symbol,brokerName:this._adapter.metainfo().title,mode$:this._displayMode$,status$:this._status$,parentType:1,isExistingOrder:this.existingOrder,isTradable:o,quotes$:this._quotes$,data:t,formatter:this.formatter,isBats:this._isBats,informerMessage$:this._informerMessage$,headerState:this._headerState,isOrderPresetsEnabled:this._isOrderPresetsEnabled,orderTemplateGetter:()=>this.orderTemplate(),brokerId:this._adapter?.metainfo().id,accountType:this._adapter?.currentAccountType(),isSendButtonDisabled$:this.isButtonDisabled$,brokerLogo:{logo:this._adapter?.metainfo().logoMiniUrl,logoBlack:this._adapter?.metainfo().logoMiniBlackUrl}}),this.customFieldsModel=new K.CustomFieldsViewModel({existingOrder:this.existingOrder,initialInputState:this._initialInputState.customFields??void 0,customFields:a?.customFields,orderType$:this.orderType$,initialOrderType:this._orderType$.getValue()}),this.supportLeverage&&(this.leverageModel=await ht.create({adapterLeverageInfo:this._adapter.leverageInfo,adapterSetLeverage:this._adapter.setLeverage,adapterPreviewLeverage:this._adapter.previewLeverage,brokerName:this._adapter.metainfo().title,symbol:this.symbol,displaySymbol:this.displaySymbolName,orderType$:this.orderType$,side$:this.sideModel.value$,initialSide:this.sideModel.getValue(),customFieldsInputValues$:this.customFieldsModel.customFieldsInputValues$,blocked$:this.customFieldsModel.isCustomFieldsNotSelected$,isBlockedGetter:()=>this.customFieldsModel.getIsCustomFieldsNotSelected(),onBlockedClick:()=>this.customFieldsModel.setIsEmptyRequiredCustomFieldsHighlighted(!0),getOrderType:this.getOrderType,initialCustomFieldsInputValues:this.customFieldsModel.getCustomFieldsInputValues(),initialOrderType:(0,r.ensureNotNull)(this._orderType$.value)})),this.durationModel=new ot({initialDuration:this._initialInputState.duration,orderType$:this.orderType$,orderWidgetStat:this._orderWidgetStat,orderDurations:this._adapter.metainfo().durations,symbolDurations:n?.allowedDurations,getOrderType:this.getOrderType}),d||(this.orderInfoModel=new Ct({marginAvailable$:this._marginAvailable$,qty$:this.quantityModel.value$,currency:(0,r.ensureDefined)(this._currencyName),pipValue$:this._pipValue$,
price$:this.priceGroupModel.price$,side$:this.sideModel.value$,stopLossType$:this.stopLossModel?.bracketType$,showTotalInsteadOfTradeValue:(0,te.shouldShowTotal)(a),showRiskControlsAndInfo:this.showRiskControlsAndInfo,info:i,tpInfo:_&&this.takeProfitModel?{enabled:this.takeProfitModel.enabled$,riskInCurrency:this.takeProfitModel.riskInCurrency$,riskInPercent:this.takeProfitModel.riskInPercent$,priceEquivalent$:this.takeProfitModel.priceEquivalent.value$,price$:this.takeProfitModel.price.value$,focusedControl$:this.takeProfitModel?.focusedControl$}:null,slInfo:_&&this.stopLossModel?{enabled:this.stopLossModel.enabled$,riskInCurrency:this.stopLossModel.riskInCurrency$,riskInPercent:this.stopLossModel.riskInPercent$,priceEquivalent$:this.stopLossModel.priceEquivalent.value$,price$:this.stopLossModel.price.value$,focusedControl$:this.stopLossModel?.focusedControl$}:null,supportMargin:this._adapter.metainfo().configFlags.supportMargin||!1,hideMarginIfNoLeverage:this._adapter.metainfo().configFlags.hideMarginIfNoLeverage||!1,marginMeterConfig:a?.marginMeterConfig,pipValueType$:this._pipValueType$,leverageInfo$:this.leverageModel?.leverageInfo$,leverageInfo:this.leverageModel?.leverageInfo()??null,supportCustomOrderInfo:this._adapter.metainfo().configFlags.supportCustomOrderInfo,dependencies:a?.orderInfoConfig?.dependencies,brokerProvidedOrderInfoGetter:this._getBrokerProvidedOrderInfo,duration$:this.durationModel.value$,isBlocked$:this.isButtonDisabled$,relativePrice$:this._orderType$.pipe((0,x.switchMap)((e=>{switch(e){case 1:case 4:return this.limitPriceModel.priceControlData$;case 3:return this.stopPriceModel.priceControlData$;default:return(0,A.of)(null)}})),(0,m.map)((e=>e?.offset??void 0))),selectedPriceControl$:this._orderType$.pipe((0,x.switchMap)((e=>{switch(e){case 1:case 4:return this.limitPriceModel.focusedControl$;case 3:return this.stopPriceModel.focusedControl$;case 2:return(0,A.of)(1);default:return(0,A.of)(null)}}))),quotes$:this._quotes$}));const g={orderType:this.orderType$,side:this.sideModel.value$,quantity:this.quantityModel.value$,symbol:this.displaySymbolName,stopPrice:this.stopPriceModel.value$,limitPrice:this.limitPriceModel.value$,formatter:this.formatter,quantityFormatter:this.quantityModel.formatter,orderPlacingStatus:this.orderPlacingStatus$,status:this._status$,existingOrder:this.existingOrder,shouldHideSecondaryText:"spread"===this._symbolInfo.type};this.buttonModel=new vt(R.TradingEntityType.Order,this._displayMode$,g),this._createQuantityConverterController()}_getUnitsTitle(){return this._symbolInfo.units?this._symbolInfo.units:"spread"===this._symbolInfo.type?C.t(null,void 0,i(482540)):this.symbolHasLotSize?C.t(null,void 0,i(833526)):"stock"===this._symbolInfo.type?C.t(null,void 0,i(288368)):C.t(null,void 0,i(715432))}_getAvailableQuantityTypeInfos(){if(!(this.quantityModel instanceof tt))return;const e={units:{quantityType:"units",title:this._getUnitsTitle(),quantityMetainfo:this._symbolInfo.qty}};if(this.orderInfoModel?.hasTradeValue()){
const t=this._accountCurrencyPrecision?1/this._accountCurrencyPrecision:xt;let s=this._currencyName||C.t(null,void 0,i(381849));const r=this.orderInfoModel?.getMarginRate();void 0!==r&&1!==r&&(s=this._currencyName?C.t(null,{replace:{currency:this._currencyName}},i(207359)):C.t(null,void 0,i(9055))),e.money={quantityType:"money",title:s,quantityMetainfo:{step:t,max:Lt,min:t},boundariesErrorMessages:{lessThanMin:C.t(null,{replace:{min:String(xt)}},i(220509)),greaterThanMax:C.t(null,{replace:{max:String(Lt)}},i(58451))},informerText:C.t(null,void 0,i(488368))},e.equityPercent={quantityType:"equityPercent",title:C.t(null,void 0,i(706992)),quantityMetainfo:{step:xt,max:Lt,min:xt},boundariesErrorMessages:{lessThanMin:C.t(null,{replace:{min:String(xt)}},i(324567)),greaterThanMax:C.t(null,{replace:{max:String(Lt)}},i(928316))},informerText:C.t(null,void 0,i(730086))}}if(this.quantityModel.showRiskControlsAndInfo&&this.supportBrackets()&&void 0!==this.stopLossModel&&!this.stopLossModel.controlState.inputDisabled&&(!this.stopLossModel.controlState.checkboxDisabled||this.stopLossModel.getEnabled())){const t=C.t(null,void 0,i(50659)),s=this._currencyName?C.t(null,{replace:{currency:this._currencyName}},i(63076)):C.t(null,void 0,i(799557));e.riskInCurrency={quantityType:"riskInCurrency",title:s,informerText:t.replace("{riskTitle}",s),quantityMetainfo:{step:xt,max:Lt,min:xt},boundariesErrorMessages:{lessThanMin:C.t(null,{replace:{min:String(xt)}},i(544265)),greaterThanMax:C.t(null,{replace:{max:String(Lt)}},i(164335))},onSelect:()=>{this.stopLossModel?.setEnabled(!0)},isValueShown$:this.stopLossModel?.enabled$};const r=C.t(null,void 0,i(65868));e.riskInPercent={quantityType:"riskInPercent",title:r,informerText:t.replace("{riskTitle}",r),quantityMetainfo:{step:xt,max:Lt,min:xt},boundariesErrorMessages:{lessThanMin:C.t(null,{replace:{min:String(xt)}},i(420276)),greaterThanMax:C.t(null,{replace:{max:String(Lt)}},i(301949))},onSelect:()=>{this.stopLossModel?.setEnabled(!0)},isValueShown$:this.stopLossModel?.enabled$}}return e}_createQuantityConverterController(){if(!(this.quantityModel instanceof tt))return;const e=this._getAvailableQuantityTypeInfos();if(this.quantityModel.setAvailableQuantityTypeInfos(e),void 0===e||Object.keys(e).length<=1)return this.quantityModel.setInputTypeAndValue("units",this._initialInputState.quantity),void this.quantityModel.setOrderSizeCalculatorQuantityType(null);const t=this.quantityModel.getOrderSizeCalculatorQuantityType();if(null===t||void 0===e[t])for(const{quantityType:t}of Object.values(e))if("units"!==t){this.quantityModel.setOrderSizeCalculatorQuantityType(t);break}const i=this._createQuantityConverters(e);this.quantityConverterController=new J({converterParams:{inputUnits$:this.quantityModel.rawQuantity$,inputValue$:this.quantityModel.rawOrderSizeCalculator$,inputType$:this.quantityModel.inputType$,converters:i},setInputTypeAndValue:this.quantityModel.setInputTypeAndValue,qtySuggester:this._qtySuggester,symbol:this.symbol,existingOrder:this.existingOrder})}_createQuantityConverters(e){
if(!(this.quantityModel instanceof tt))return{};const t={};return"money"in e&&(t.money=new oe({pricePerUnit$:this.priceGroupModel.price$,pipValue$:this._pipValue$,instrumentInfo:this._symbolInfo,leverageInfo$:this.leverageModel?.leverageInfo$??(0,A.of)(null)})),"equityPercent"in e&&(t.equityPercent=new ae({pricePerUnit$:this.priceGroupModel.price$,leverageInfo$:this.leverageModel?.leverageInfo$??(0,A.of)(null),pipValue$:this._pipValue$,equity$:this._equity$,instrumentInfo:this._symbolInfo,valueFormatter:this.quantityModel.getFormatter("equityPercent")})),void 0!==this.stopLossModel&&("riskInCurrency"in e&&(t.riskInCurrency=new le({pipValue$:this._pipValue$,stopLossPips$:this.stopLossModel.pips$,instrumentInfo:this._symbolInfo})),"riskInPercent"in e&&(t.riskInPercent=new de({pipValue$:this._pipValue$,stopLossPips$:this.stopLossModel.pips$,equity$:this._equity$,instrumentInfo:this._symbolInfo,valueFormatter:this.quantityModel.getFormatter("riskInPercent")}))),t}async _createBracketsModels(e,t,i,s){const r={[R.BracketType.TakeProfit]:await(0,Q.extractTakeProfitValidationRules)(this._adapter,this.symbol),[R.BracketType.StopLoss]:await(0,Q.extractStopLossValidationRules)(this._adapter,this.symbol),[R.BracketType.GuaranteedStop]:await(0,Q.extractGuaranteedStopValidationRules)(this._adapter,this.symbol),[R.BracketType.TrailingStop]:await(0,Q.extractStopLossValidationRules)(this._adapter,this.symbol)},o=this.supportModifyBrackets(),n=this.supportModifyTrailingStop(),a=this.supportAddBracketsToExistingOrder();this.takeProfitModel=new Ve({initialPrice:e.takeProfit??this.existingPlacedOrder?.takeProfit,initialPips:e.takeProfitPips,initialRiskInPercent:e.takeProfitRiskInPercent,initialParentPricePercent:e.takeProfitParentPricePercent,initialAmount:e.qty??this._orderTemplate.qty,initialEnabled:Boolean(e.takeProfit||e.takeProfitPips||e.takeProfitRiskInPercent),initialBracketType:R.BracketType.TakeProfit,initialPriceEquivalentType:this._currentInputState.takeProfitPriceEquivalentType,initialFocusedControl:this._currentInputState.takeProfitFocusedControl,existingBracketPrice:this.existingPlacedOrder?.takeProfit,formatter:this.formatter,equity$:this._equity$,quotes$:this._quotes$,info:t,pipValue$:this._pipValue$,side$:this.sideModel.value$,amount$:this.quantityModel.value$,parentPrice$:this.priceGroupModel.price$,orderType$:this.orderType$,currency:i,parentType:1,savedPips:this._currentInputState.takeProfitPips,orderWidgetStat:this._orderWidgetStat,showRiskControlsAndInfo:this.showRiskControlsAndInfo,showRiskInInstrumentCurrency:this.showRiskInInstrumentCurrency,status:this.getStatus(),supportTrailingStop:this.supportTrailingStop(),supportGuaranteedStop:this.supportGuaranteedStop(),useContextValidation:this.useContextValidation,validationRulesByType:r,supportModifyBrackets:o,supportModifyTrailingStop:n,supportAddBracketsToExistingOrder:a,supportBracketsInPips:this._supportBracketsInPips})
;const{makeInitialSLPrice:l,makeInitialSLPips:d,makeInitialSLRiskInPercent:u,makeInitialSLBracketType:c,makeInitialSLEnabled:h,makeInitialSLParentPricePercent:p}=Ie,_={stopLoss:e.stopLoss,trailingStopPips:e.trailingStopPips,guaranteedStop:e.guaranteedStop,stopType:e.stopType,stopLossPips:e.stopLossPips,riskInPercent:e.stopLossRiskInPercent,parentPricePercent:e.stopLossParentPricePercent,supportStopLoss:this._supportStopLoss,supportGuaranteedStop:this._supportGuaranteedStop,supportTrailingStop:this._supportTrailingStop},g={stopLoss:this.existingPlacedOrder?.stopLoss,trailingStopPips:this.existingPlacedOrder?.trailingStopPips,guaranteedStop:this.existingPlacedOrder?.guaranteedStop,stopType:this.existingPlacedOrder?.stopType,supportStopLoss:this._supportStopLoss,supportGuaranteedStop:this._supportGuaranteedStop,supportTrailingStop:this._supportTrailingStop},y=this.existingPlacedOrder?.stopLoss??this.existingPlacedOrder?.guaranteedStop,b=("id"in e?s.filter((t=>1===t.parentType&&t.parentId===e.id&&3===t.status)):[]).some((e=>e.stopType===q.StopType.TrailingStop)),m=h(_),v=l(m?_:g),f=d(m?_:g),P=c(m?_:g);this.stopLossModel=new Ve({initialPrice:v,initialPips:f,initialRiskInPercent:u(_),initialParentPricePercent:p(_),initialAmount:e.qty??this._orderTemplate.qty,initialEnabled:m,initialBracketType:P,initialPriceEquivalentType:this._currentInputState.stopLossPriceEquivalentType,initialFocusedControl:this._currentInputState.stopLossFocusedControl,existingBracketPrice:y,formatter:this.formatter,equity$:this._equity$,quotes$:this._quotes$,info:t,pipValue$:this._pipValue$,side$:this.sideModel.value$,amount$:this.quantityModel.value$,parentPrice$:this.priceGroupModel.price$,orderType$:this.orderType$,currency:i,parentType:1,savedPips:this._currentInputState.stopLossPips,orderWidgetStat:this._orderWidgetStat,showRiskControlsAndInfo:this.showRiskControlsAndInfo,status:this.getStatus(),hasTrailingStopBracket:b,supportStopLoss:this._supportStopLoss,supportTrailingStop:this._supportTrailingStop,supportGuaranteedStop:this._supportGuaranteedStop,useContextValidation:this.useContextValidation,validationRulesByType:r,supportModifyBrackets:o,supportModifyTrailingStop:n,supportAddBracketsToExistingOrder:a,supportBracketsInPips:this._supportBracketsInPips,beforeFocusedControlChangeHandler:this._handleBeforeSLFocusedControlChange,beforePriceEquivalentTypeChangeHandler:this._handleBeforeSLPriceEquivalentTypeChange})}_makeHeaderSettings(){return Vt({pin:()=>this.headerModel.pin(),toggleSettings:this._toggleSettings,mode$:this._displayMode$,settings$:this._settings$,setFocusedControl:this._headerState.setFocusedControl,showRelativePriceControl:!this.limitPriceModel.isRelativePriceControlHidden&&!this.stopPriceModel.isRelativePriceControlHidden,showRiskControlsAndInfo:this.showRiskControlsAndInfo,supportBrackets:this.supportBrackets(),supportPlaceOrderPreview:this.supportPlaceOrderPreview,supportModifyOrderPreview:this.supportModifyOrderPreview,isUndockAllowed:this._isUndockAllowed})}_subscribe(){
this._getDisplayMode()===F.OrderEditorDisplayMode.Popup&&this.getStatus()!==F.OrderPanelStatus.Preview&&this.activateOrderTicket();const e=this.status$.subscribe(this._handleStatusChange);this.onInputStateChanged().subscribe(this,this._mergeInputStateDiff),this.headerModel.pinButtonClicked().subscribe(this,this._toggleMode),this.headerModel.closeButtonClicked().subscribe(this,this._closeWidget);const t=(0,L.combineLatest)({orderType:this.orderType$,status:this.status$,orderPlacingStatus:this.orderPlacingStatus$,side:this.sideModel.value$,loading:this._loading$,quotes:this._quotes$,limitPrice:this.limitPriceModel.value$,hasLimitPriceError:this.useContextValidation?(0,te.simplifyControlErrorObservableFormat)(this.limitPriceModel.error$,["error"]):(0,A.of)(!1),stopPrice:this.stopPriceModel.value$,hasStopPriceError:this.useContextValidation?(0,te.simplifyControlErrorObservableFormat)(this.stopPriceModel.error$,["error"]):(0,A.of)(!1),hasStopLossError:this.stopLossModel?(0,te.simplifyControlErrorObservableFormat)(this.stopLossModel.error$,["error",void 0]):(0,A.of)(!1),hasTakeProfitError:this.takeProfitModel?(0,te.simplifyControlErrorObservableFormat)(this.takeProfitModel.error$,["error",void 0]):(0,A.of)(!1),quantity:this.quantityModel.value$,hasQuantityError:this.useContextValidation?(0,te.simplifyControlErrorObservableFormat)(this.quantityModel.error$,["error"]):(0,A.of)(!1),orderSizeCalculatorQuantityType:this.quantityModel instanceof tt?this.quantityModel.orderSizeCalculatorQuantityType$:(0,A.of)(null),lastRiskQuantityType:this.quantityModel instanceof tt?this.quantityModel.lastRiskQuantityType$:(0,A.of)(null),lastUsedQuantityType:this.quantityModel instanceof tt?this.quantityModel.lastUsedQuantityType$:(0,A.of)(null),orderSizeCalculatorValue:this.quantityModel instanceof tt?this.quantityModel.orderSizeCalculator.value$:(0,A.of)(null),takeProfitPips:this.takeProfitModel?.pips$??(0,A.of)(null),takeProfitPrice:this.takeProfitModel?.price.value$??(0,A.of)(null),takeProfitEnabled:this.takeProfitModel?.enabled$??(0,A.of)(!1),takeProfitPriceEquivalentType:this.takeProfitModel?.priceEquivalentType$??(0,A.of)(null),takeProfitFocusedControl:this.takeProfitModel?.focusedControl$??(0,A.of)(null),stopLossPips:this.stopLossModel?.pips$??(0,A.of)(null),stopLossPrice:this.stopLossModel?.price.value$??(0,A.of)(null),stopLossEnabled:this.stopLossModel?.enabled$??(0,A.of)(!1),stopLossPriceEquivalentType:this.stopLossModel?.priceEquivalentType$??(0,A.of)(null),stopLossFocusedControl:this.stopLossModel?.focusedControl$??(0,A.of)(null),duration:this.durationModel.value$,customFields:this.customFieldsModel.customFieldsInputValues$,durationError:this.durationModel.error$,bracketType:this.stopLossModel?.bracketType$??(0,A.of)(null)}).subscribe((e=>{
const{orderType:t,status:i,side:s,loading:r,quotes:o,limitPrice:n,hasLimitPriceError:a,stopPrice:l,hasStopPriceError:d,hasStopLossError:u,hasTakeProfitError:c,quantity:h,hasQuantityError:p,orderSizeCalculatorQuantityType:_,orderSizeCalculatorValue:g,lastRiskQuantityType:y,lastUsedQuantityType:b,takeProfitPips:m,takeProfitPrice:v,takeProfitEnabled:f,takeProfitPriceEquivalentType:P,takeProfitFocusedControl:S,stopLossPips:k,stopLossPrice:C,stopLossEnabled:T,stopLossPriceEquivalentType:w,stopLossFocusedControl:B,duration:O,customFields:M,durationError:E,bracketType:I}=e;this._setDisabledIfNeeded({status:i,loading:r,quotes:o,side:s,limitPrice:n,stopPrice:l,quantity:h,hasQuantityError:p,hasStopLossError:T&&u,hasTakeProfitError:f&&c,customFields:M,hasDurationError:E.res,hasLimitPriceError:a,hasStopPriceError:d}),this._compareInputStates({orderType:t,side:s,limitPrice:n,stopPrice:l,quantity:h,orderSizeCalculatorQuantityType:_,lastRiskQuantityType:y,lastUsedQuantityType:b,takeProfitPips:m,takeProfitPrice:v,takeProfitEnabled:f,takeProfitPriceEquivalentType:P,takeProfitFocusedControl:S,stopLossPips:k,stopLossPrice:C,stopLossEnabled:T,stopLossPriceEquivalentType:w,stopLossFocusedControl:B,duration:O,customFields:M,bracketType:I,orderSizeCalculatorValue:g})}));this._waitQuotesTimeout=setTimeout((()=>this._isNoQuotes$.next(!0)),5e3);const i=(0,L.combineLatest)([this._quotes$,this.sideModel.value$]).subscribe((([e,t])=>{const i=1===t?(0,N.getAsk)(e):(0,N.getBid)(e);this._initialInputState.limitPrice=i,this._initialInputState.stopPrice=i})),s=this._quotes$.subscribe((e=>{this._isNoQuotes$.next((0,N.isNoQuotes)(e)),clearTimeout(this._waitQuotesTimeout)}));if(this._subscriptions=[...this.sideModel.subscribe(),this._qtySuggester.suggestedQtyChanged(this.symbol).pipe((0,h.skip)(1)).subscribe(this._onSuggestedQtyChange),this.quantityModel.value$.subscribe(this._onQtyChange),this._isUndockAllowed$.subscribe(this._onUndockAllowedChanged),this.orderPlacingStatus$.subscribe(this._resetPlacingStatusWithDelay)],this.quantityModel instanceof tt&&void 0!==this.quantityConverterController&&this._subscriptions.push(this.quantityConverterController.convertedValues$.subscribe(this.quantityModel.setConvertedValues)),this.customFieldsModel.subscribe(),this.leverageModel?.subscribe(),this.limitPriceModel.subscribe(),this.stopPriceModel.subscribe(),this.priceGroupModel.subscribe(),this.quantityModel.subscribe(),this.orderInfoModel?.subscribe(),this.durationModel.subscribe(),this.buttonModel&&this.buttonModel.subscribe(),void 0!==this.takeProfitModel&&this._subscriptions.push(...this.takeProfitModel.subscribe()),void 0!==this.stopLossModel){if(!this.supportCryptoExchangeOrderTicket()){const e=(0,L.combineLatest)({enabled:this.stopLossModel.enabled$}).subscribe((({enabled:e})=>{this._stopLossAvailable$.next(e)}));this._subscriptions.push(e)}this._subscriptions.push(...this.stopLossModel.subscribe())}if(void 0!==this.takeProfitModel&&void 0!==this.stopLossModel){const e=(0,L.combineLatest)([this.takeProfitModel.enabled$.pipe((0,x.switchMap)((e=>e?(0,
r.ensureDefined)(this.takeProfitModel).pips$:(0,A.of)(null)))),this.stopLossModel.enabled$.pipe((0,x.switchMap)((e=>e?(0,r.ensureDefined)(this.stopLossModel).pips$:(0,A.of)(null))))]).subscribe((([e,t])=>{this._rewardRisk$.next((0,te.formatRiskReward)(e,t))}));this._subscriptions.push(e)}this._subscriptions.push(e,t,i,s,this._pipValues$.connect()),null!==this._marginAvailable$&&this._subscriptions.push(this._marginAvailable$.connect()),null!==this._baseCurrencyCryptoBalance$&&this._subscriptions.push(this._baseCurrencyCryptoBalance$.connect()),null!==this._quoteCurrencyCryptoBalance$&&this._subscriptions.push(this._quoteCurrencyCryptoBalance$.connect()),this._adapter.orderUpdate.subscribe(this,this._orderUpdate),this._supportOnlyPairOrderBrackets&&this._subscribeTakeProfitStopLossEnabled()}_subscribeTakeProfitStopLossEnabled(){if(void 0===this.stopLossModel||void 0===this.takeProfitModel)return;const e=this.stopLossModel.enabled$.pipe(b(this.takeProfitModel.enabled$)).subscribe((e=>{const[t,i]=e;i!==t&&this.takeProfitModel?.setEnabled(t)})),t=this.takeProfitModel?.enabled$.pipe(b(this.stopLossModel.enabled$)).subscribe((e=>{const[t,i]=e;i!==t&&this.stopLossModel?.setEnabled(t)}));this._subscriptions.push(t,e)}_orderUpdate(e){this._isVisible()&&!this._loading$.getValue()&&this.existingOrder&&e.id===this._orderTemplate.id&&6!==e.status&&(this._getDisplayMode()===F.OrderEditorDisplayMode.Popup?this.headerModel.close():this._back())}async _doneHandler(e,t){await this._getAndSendStatistics(e),null!==this._orderWidgetStat&&this._orderWidgetStat.clear();const i=this._sendHandler;if(this._isHandlerPlacedOrder(i)){const s=Object.assign({},this.existingPlacedOrder,e);return[2,1].includes(s.type)&&delete s.stopPrice,[2,3].includes(s.type)&&delete s.limitPrice,i(s,t)}return i(e,t)}_isHandlerPlacedOrder(e){return this.existingOrder}async _getAndSendStatistics(e){const t=this._isBracketStopTypeEnabled(R.BracketType.StopLoss),i=this.takeProfitModel&&this.takeProfitModel.getEnabled(),s=this._supportTrailingStop&&this._isBracketStopTypeEnabled(R.BracketType.TrailingStop),o=this._supportGuaranteedStop&&this._isBracketStopTypeEnabled(R.BracketType.GuaranteedStop),n=1===e.side?"Buy":"Sell",a=["Price","Pips"],l=["Units","BaseCurrencyQuantity","QuoteCurrencyQuantity","OrderSizeCalculator"],d=this.quantityModel.getFocusedControl(),u=["Limit","Market","Stop","StopLimit"][e.type-1],c=this.durationModel.getValue(),h=this.leverageModel?this.leverageModel.leverageInfo():null,p=4===e.type,_=3===e.type||p,g=1===e.type||p,y=Object.assign({},this._getSettings()),b=this.limitPriceModel&&!this.limitPriceModel.isRelativePriceControlHidden||this.stopPriceModel&&!this.stopPriceModel.isRelativePriceControlHidden;var m,v;y.showRelativePriceControl=y.showRelativePriceControl&&b,y.showOrderPreview=y.showOrderPreview&&Boolean(this.supportPlaceOrderPreview||this.supportModifyOrderPreview),null!==this._orderWidgetStat&&(this._orderWidgetStat.setStaticSnowplowEventDataProperty({userId:window.user.id,hashedUserId:void 0,
accountType:this._adapter.currentAccountType(),brokerId:this._adapter.metainfo().id,orderTicketMode:this._getDisplayMode(),source:this._orderTemplate.source??null,side:n,orderType:u,leverageInfo:h,symbolType:void 0!==this._symbolInfo.type?this._symbolInfo.type:null,operation:this.existingOrder?"Modify":"Place",stopLoss:t?(0,r.ensureDefined)(this.stopLossModel).getPips():null,takeProfit:i?(0,r.ensureDefined)(this.takeProfitModel).getPips():null,trailingStop:s?(0,r.ensureDefined)(this.stopLossModel).getPips():null,guaranteedStop:o?(0,r.ensureDefined)(this.stopLossModel).getPips():null,focusedTPField:i?(0,r.ensureDefined)(this.takeProfitModel).getFocusedControl()||"Price":null,focusedSLField:t?(0,r.ensureDefined)(this.stopLossModel).getFocusedControl()||"Price":null,focusedQtyField:l[null!==d?d:0]??null,focusedLimitPriceField:g||p&&this.limitPriceModel?(m=this.limitPriceModel.getFocusedControl(),v=a,v[null!==m?m:0]):null,focusedStopPriceField:_&&this.stopPriceModel?a[this.stopPriceModel.getFocusedControl()]:null,duration:null!==c?c.type:null,isDefaultDuration:null!==c?c.type===this._getDefaultDuration().value:null,showOrderPreview:y.showOrderPreview,showRelativePriceControl:y.showRelativePriceControl}),await this._orderWidgetStat.trackStat())}_isBracketStopTypeEnabled(e){return void 0!==this.stopLossModel&&this.stopLossModel.getEnabled()&&this.stopLossModel.getBracketType()===e}_getInitialInputState(e,t,i,s){const r=void 0!==e.customFields?{...e.customFields}:void 0;return{symbol:this.symbol,orderType:this._orderType$.value,side:e.side??i?.side??1,limitPrice:e.limitPrice||e.price||e.stopPrice||null,stopPrice:e.stopPrice||e.price||e.limitPrice||null,quantity:e.qty??(this._suggestedQty||i?.quantity||t.qty.min),orderSizeCalculatorQuantityType:i?.orderSizeCalculatorQuantityType??null,lastRiskQuantityType:i?.lastRiskQuantityType??"riskInPercent",lastUsedQuantityType:i?.lastUsedQuantityType??"units",orderSizeCalculatorValue:i?.orderSizeCalculatorValue??null,takeProfitPips:i?.takeProfitPips??F.BracketDefaultPips.TakeProfit,takeProfitPrice:null,takeProfitEnabled:!1,takeProfitPriceEquivalentType:i?.takeProfitPriceEquivalentType??null,takeProfitFocusedControl:i?.takeProfitFocusedControl??null,stopLossPips:i?.stopLossPips??F.BracketDefaultPips.StopLoss,stopLossPrice:null,stopLossEnabled:!1,stopLossPriceEquivalentType:i?.stopLossPriceEquivalentType??null,stopLossFocusedControl:i?.stopLossFocusedControl??null,customFields:r??i?.customFields??{},bracketType:null,duration:(0,N.getOrderDuration)({orderDuration:e.duration,orderType:this._orderType$.value,savedDuration:i?.duration??null,orderDurations:this._adapter.metainfo().durations,symbolDurations:s?.allowedDurations})}}_makeOrderTemplate(e){const t={...this._orderTemplate};return void 0===t.limitPrice&&!1===this.existingOrder&&(t.limitPrice=1===this._initialInputState.side?(0,N.getAsk)(e):(0,N.getBid)(e)),void 0===t.stopPrice&&!1===this.existingOrder&&(t.stopPrice=1===this._initialInputState.side?(0,N.getBid)(e):(0,N.getAsk)(e)),
void 0===t.side&&(t.side=this._initialInputState.side),void 0===t.symbol&&(t.symbol=this._initialInputState.symbol),void 0===t.type&&null!==this._initialInputState.orderType&&(t.type=this._initialInputState.orderType),void 0===t.qty&&null!==this._initialInputState.quantity&&(t.qty=this._initialInputState.quantity),void 0===t.stopLossPips&&null!==this._initialInputState.stopLossPips&&(t.stopLossPips=this._initialInputState.stopLossPips),void 0===t.takeProfitPips&&null!==this._initialInputState.takeProfitPips&&(t.takeProfitPips=this._initialInputState.takeProfitPips),t}_compareInputStates(e){const{orderType:t,side:i,limitPrice:s,stopPrice:r,quantity:o,orderSizeCalculatorQuantityType:n,lastRiskQuantityType:a,lastUsedQuantityType:l,orderSizeCalculatorValue:d,takeProfitPips:u,takeProfitPrice:c,takeProfitEnabled:h,takeProfitPriceEquivalentType:p,takeProfitFocusedControl:_,stopLossPips:g,stopLossPrice:y,stopLossEnabled:b,stopLossPriceEquivalentType:m,stopLossFocusedControl:v,duration:f,customFields:P,bracketType:S}=e,k={};t!==this._currentInputState.orderType&&(k.orderType=t),s!==this._currentInputState.limitPrice&&(k.limitPrice=s),r!==this._currentInputState.stopPrice&&(k.stopPrice=r),this._currentInputState.quantity!==o&&(k.quantity=o),this._currentInputState.orderSizeCalculatorQuantityType!==n&&(k.orderSizeCalculatorQuantityType=n),this._currentInputState.lastRiskQuantityType!==a&&(k.lastRiskQuantityType=a),this._currentInputState.lastUsedQuantityType!==l&&(k.lastUsedQuantityType=l),this._currentInputState.orderSizeCalculatorValue!==d&&(k.orderSizeCalculatorValue=d),this._currentInputState.takeProfitPips!==u&&(k.takeProfitPips=u),this._currentInputState.takeProfitPrice!==c&&(k.takeProfitPrice=c),this._currentInputState.takeProfitEnabled!==h&&(k.takeProfitEnabled=h),this._currentInputState.takeProfitPriceEquivalentType!==p&&(k.takeProfitPriceEquivalentType=p),this._currentInputState.takeProfitFocusedControl!==_&&(k.takeProfitFocusedControl=_),this._currentInputState.stopLossPips!==g&&(k.stopLossPips=g),this._currentInputState.stopLossPrice!==y&&(k.stopLossPrice=y),this._currentInputState.stopLossPriceEquivalentType!==m&&(k.stopLossPriceEquivalentType=m),this._currentInputState.stopLossFocusedControl!==v&&(k.stopLossFocusedControl=v),this._currentInputState.stopLossEnabled!==b&&(k.stopLossEnabled=b),this._currentInputState.duration?.type===f?.type&&this._currentInputState.duration?.datetime===f?.datetime||(k.duration=f),null!==i&&this._currentInputState.side!==i&&(k.side=i),null!==t&&this._currentInputState.orderType!==t&&(k.orderType=t),this._currentInputState.symbol!==this.symbol&&(k.symbol=this.symbol),0===Object.keys(P).length||(0,H.deepEquals)(this._currentInputState.customFields,P)[0]||(k.customFields=P),S!==this._currentInputState.bracketType&&(k.bracketType=S),0!==Object.keys(k).length&&this._onInputStateChanged.fire(k)}_getCurrentInputState(){return{symbol:this.symbol,orderType:this._orderType$.value,side:this.sideModel.getValue(),limitPrice:this.limitPriceModel.getValue(),stopPrice:this.stopPriceModel.getValue(),
quantity:this.quantityModel.getValue(),orderSizeCalculatorQuantityType:this.quantityModel instanceof tt?this.quantityModel.getOrderSizeCalculatorQuantityType():null,orderSizeCalculatorValue:this.quantityModel instanceof tt?this.quantityModel.orderSizeCalculator.getValue():null,lastRiskQuantityType:this.quantityModel instanceof tt?this.quantityModel.getLastRiskQuantityType():null,lastUsedQuantityType:this.quantityModel instanceof tt?this.quantityModel.getLastUsedQuantityType():null,takeProfitPips:this.takeProfitModel?this.takeProfitModel.getPips():null,takeProfitPrice:this.takeProfitModel?this.takeProfitModel.price.getValue():null,takeProfitEnabled:this.takeProfitModel?.getEnabled()??!1,takeProfitPriceEquivalentType:this.takeProfitModel?.getPriceEquivalentType()??null,takeProfitFocusedControl:this.takeProfitModel?.getFocusedControl()??null,stopLossPips:this.stopLossModel?this.stopLossModel.getPips():null,stopLossPrice:this.stopLossModel?this.stopLossModel.price.getValue():null,stopLossEnabled:this.stopLossModel?.getEnabled()??!1,stopLossPriceEquivalentType:this.stopLossModel?.getPriceEquivalentType()??null,stopLossFocusedControl:this.stopLossModel?.getFocusedControl()??null,duration:this.durationModel.getValue(),customFields:this.customFieldsModel.getCustomFieldsInputValues(),bracketType:this.stopLossModel?.getBracketType()??null}}_setDisabledIfNeeded({loading:e,quotes:t,side:i,limitPrice:s,stopPrice:r,quantity:o,customFields:n,hasDurationError:a,hasLimitPriceError:l,hasStopPriceError:d,hasQuantityError:u,hasStopLossError:c,hasTakeProfitError:h}){this._isButtonDisabled$.next(e||(0,N.isNoQuotes)(t)||null===i||(0,te.checkPriceByOrderType)(this._orderType$.value,s,r)||null===o||c||h||a||l||d||u||Object.values(n).some((e=>void 0===e))||this.customFieldsModel.getCustomFieldsModels().some((e=>!e.isValid())))}_closeWidget(){this._cleanUp(),this._onCloseButtonClicked.fire()}_cancel(){this._cleanUp(),this.deactivateOrderTicket(),this._currentInputState=Object.assign({},this._initialInputState),this.limitPriceModel&&this.limitPriceModel.resetPrice(),this.stopPriceModel&&this.stopPriceModel.resetPrice(),this.takeProfitModel&&this.takeProfitModel.setEnabled(!1),this.stopLossModel&&this.stopLossModel.setEnabled(!1),this._resetPlacingStatusTimerId||this._orderPlacingStatus$.next(F.OrderPlacingStatus.Creating),this.existingOrder&&this._back()}_cleanUp(){this.orderPreviewModel=null,this.onDoneButtonClicked.resolve(!1)}_getDefaultDuration(){const e=(0,r.ensureDefined)(this._adapter.metainfo().durations);return e.find((e=>Boolean(e.default)))||e[0]}async _prepareTradableSolution(e){this.tradableSolution=await(0,te.prepareTradableSolution)(e,this._adapter),this._createSimpleDialog(this._adapter),this.notTradableText=e.reason,this.notTradableReasonHeadingText=e.reasonHeading}_isOrderSizeCalculatorAvailable(){if(!(this.quantityModel instanceof tt))return!1;const e=this.quantityModel.getAvailableQuantityTypeInfos();return void 0!==e&&Object.keys(e).length>1}_calculateSeenPrice(){const e=this.sideModel.currentQuotes()
;return(1===this.sideModel.getValue()?e.ask:e.bid)??0}_getCurrentQuotes(){const e=this.sideModel.currentQuotes();if(void 0!==e.ask&&void 0!==e.bid)return{ask:e.ask,bid:e.bid}}_shouldChangeControlFocus(e,t,i,s){return 3===i&&null!==s&&("riskInCurrency"===s||"riskInPercent"===s)&&"PriceEquivalent"===e&&("RiskInCurrency"===t||"RiskInPercent"===t)}_getCurrentSymbolName(){return this._symbolInfo?.brokerSymbol??("brokerSymbol"in this._orderTemplate?this._orderTemplate.brokerSymbol:null)??(0,N.safeSplitSymbol)(this._orderTemplate.symbol)[1]}}class Rt{constructor({qty:e,currency:t,positionPrice:i,showTotalInsteadOfTradeValue:s,info:r,pipValueType$:o,tpInfo:a,slInfo:l,showRiskControlsAndInfo:d,supportMargin:u}){this._infoTableData$=new n.BehaviorSubject({rows:[]}),this._riskFormatter=new j.PriceFormatter({priceScale:100}),this._tpEnabled$=null,this._tpRiskInCurrency$=null,this._tpRiskInPercent$=null,this._slEnabled$=null,this._slRiskInCurrency$=null,this._slRiskInPercent$=null,this.infoTableData$=this._infoTableData$.asObservable(),this._currency=t,this._showTotalInsteadOfTradeValue=s,this._showRiskControlsAndInfo=d,this._type=r.type,this._leverage=r.leverage,this._marginRate=r.marginRate,this._lotSize=r.lotSize,this._pipValue=(0,te.calculatePipValue)(e,r.pipValue,this._lotSize),this._pipValueType$=o,this._supportMargin=u,null===e?this._tradeValue=0:"crypto"===this._type?this._tradeValue=e*i:this._tradeValue=ie(e,i,r.pipValue,r.pipSize,this._lotSize),a&&l&&(this._tpEnabled$=a.enabled,this._tpRiskInCurrency$=a.riskInCurrency,this._tpRiskInPercent$=a.riskInPercent,this._slEnabled$=l.enabled,this._slRiskInCurrency$=l.riskInCurrency,this._slRiskInPercent$=l.riskInPercent)}subscribe(){this._subscription=(0,L.combineLatest)({tpEnabled:null!==this._tpEnabled$?this._tpEnabled$:(0,A.of)(null),tpRiskInCurrency:null!==this._tpRiskInCurrency$?this._tpRiskInCurrency$:(0,A.of)(null),tpRiskInPercent:null!==this._tpRiskInPercent$?this._tpRiskInPercent$:(0,A.of)(null),slEnabled:null!==this._slEnabled$?this._slEnabled$:(0,A.of)(null),slRiskInCurrency:null!==this._slRiskInCurrency$?this._slRiskInCurrency$:(0,A.of)(null),slRiskInPercent:null!==this._slRiskInPercent$?this._slRiskInPercent$:(0,A.of)(null),pipValueType:this._pipValueType$}).subscribe((e=>{const{tpEnabled:t,tpRiskInCurrency:i,tpRiskInPercent:s,slEnabled:r,slRiskInCurrency:o,slRiskInPercent:n,pipValueType:a}=e,l=[];l.push(...this._makeLeverageInfo(),...this._makeLotSizeInfo(),...this._makePipValueInfo(a),...this._makeTradeValueInfo(),...this._makeRewardInfo(t,i,s),...this._makeRiskInfo(r,o,n)),this._infoTableData$.next({rows:l})}))}unsubscribe(){this._subscription?.unsubscribe()}title(){return C.t(null,void 0,i(798565))}infoTableData(){return this._infoTableData$.asObservable()}getOrderInfoTableRowsCount(){return this._infoTableData$.getValue().rows.length}_getTradeValue(){const e=this._supportMargin?1:this._getMarginRate()??1;if(this._showRiskControlsAndInfo&&Number.isFinite(this._tradeValue)&&(this._isSymbolTypeSupportTradeValue()||void 0!==e))return(0,
ft.formatInfoValue)(this._tradeValue*e)}_makeLeverageInfo(){const e=Pt({leverage:this._leverage,marginRate:this._marginRate});return void 0===e?[]:[{title:C.t(null,void 0,i(824813)),value:e}]}_makeLotSizeInfo(){return"number"==typeof this._lotSize&&Number.isFinite(this._lotSize)?[{title:C.t(null,void 0,i(574045)),value:String(this._lotSize)}]:[]}_makePipValueInfo(e){return this._showRiskControlsAndInfo&&e!==R.PipValueType.None&&Number.isFinite(this._pipValue)?[{title:e===R.PipValueType.Pips?C.t(null,void 0,i(207074)):C.t(null,void 0,i(414285)),value:(0,ft.formatInfoValue)(this._pipValue),currency:this._currency}]:[]}_makeTradeValueInfo(){const e=this._getTradeValue();if(void 0===e)return[];return[{title:this._showTotalInsteadOfTradeValue?C.t(null,void 0,i(408007)):C.t(null,void 0,i(248410)),value:e,currency:this._currency}]}_getMarginRate(){return void 0!==this._marginRate&&this._marginRate>0?this._marginRate:void 0}_isSymbolTypeSupportTradeValue(){return void 0!==this._type&&["stock","dr","right","bond","warrant","structured"].includes(this._type)}_makeRewardInfo(e,t,s){return this._showRiskControlsAndInfo&&e&&null!==t&&null!==s?[{title:C.t(null,void 0,i(65183)),value:kt({percentValue:s,currencyValue:t,formatter:this._riskFormatter}),currency:this._currency}]:[]}_makeRiskInfo(e,t,s){return this._showRiskControlsAndInfo&&e&&null!==t&&null!==s?[{title:C.t(null,void 0,i(663886)),value:kt({percentValue:s,currencyValue:t,formatter:this._riskFormatter}),currency:this._currency}]:[]}}var Ft;!function(e){e[e.Position=0]="Position",e[e.IndividualPosition=1]="IndividualPosition"}(Ft||(Ft={}));class Nt{constructor({adapter:e,position:t,existingPosition:i,brackets:s,settings$:r,realtimeProvider:o,isUndockAllowed$:a,isVisible:l,toggleMode:d,getDisplayMode:u,toggleSettings:c,displayMode$:h,viewType:p,pipValueType$:_,handler:g,trackEvent:y,orderDialogOptions:b,headerState:v,hasTrailingStopBracket:f,initialSLPriceEquivalentType:P,initialTPPriceEquivalentType:S}){this.positionInfoModel=null,this.id=(0,W.randomHashN)(6),this.onDoneButtonClicked=(0,T.createDeferredPromise)(),this.orderType$=new n.BehaviorSubject(null),this.isFractional=!1,this._onBackButtonClicked=new z.Delegate,this._onCloseButtonClicked=new z.Delegate,this._onBracketsStateChanged=new z.Delegate,this._dataLoadingAbortController=new AbortController,this._loading$=new n.BehaviorSubject(!1),this._rewardRisk$=new n.BehaviorSubject(""),this._isButtonDisabled$=new n.BehaviorSubject(!1),this._status$=new n.BehaviorSubject(F.OrderPanelStatus.Active),this._warning$=new n.BehaviorSubject(void 0),this._supportStopLoss=!0,this.doneButtonClick=async()=>{const e=this._getDisplayMode();this._loading$.next(!0);if(!await this._doneHandler())return e===F.OrderEditorDisplayMode.ResizableDrawer&&this.headerModel.close(),void this._loading$.next(!1);this.onDoneButtonClicked.resolve(!0),e===F.OrderEditorDisplayMode.Popup||e===F.OrderEditorDisplayMode.ResizableDrawer?this.headerModel.close():this._back(),this._loading$.next(!1),
this._trackEvent("Position Ticket","Modify Position",this._getDisplayMode()===F.OrderEditorDisplayMode.Panel?"Panel":"Popup")},this.setLoading=e=>{this._loading$.next(e)},this._onUndockAllowedChanged=e=>{this._headerState.setSettings(Vt({pin:()=>this.headerModel.pin(),setFocusedControl:this._headerState.setFocusedControl,toggleSettings:this._toggleSettings,mode$:this._displayMode$,settings$:this._settings$,showRiskControlsAndInfo:!0,supportBrackets:!0,isUndockAllowed:e}))},this._existingPosition=i,this._headerState=v,this.headerStateValue=v,this._headerState.setSettings(void 0),this._position=t,this._adapter=e,this._pipValueType$=_,this.position=t,this.symbol=t.symbol,this.brackets=s,this._handler=g,this._isUndockAllowed$=a,this._isVisible=l,this._toggleMode=d,this._getDisplayMode=u,this._displayMode$=h,this._toggleSettings=c,this._settings$=r,this.rewardRisk$=this._rewardRisk$.asObservable(),this.loading$=this._loading$.asObservable(),this.status$=this._status$.asObservable(),this.warning$=this._warning$.asObservable(),this.isButtonDisabled$=this._isButtonDisabled$.asObservable();const k=this._adapter.metainfo().configFlags;this.supportPositions=p===Ft.Position&&k.supportPositions,this.supportIndividualPositions=p===Ft.IndividualPosition&&k.supportPositionNetting,this.supportOnlyPairPositionBrackets=k.supportOnlyPairPositionBrackets,this.supportCryptoExchangeOrderTicket=k.supportCryptoExchangeOrderTicket,this._trackEvent=y,this.onReady=Promise.all([e.symbolInfo(t.symbol),e.getSymbolSpecificTradingOptions(t.symbol),this._adapter.orders(),this._adapter.getPositionDialogOptions(this.symbol),(0,$t.isFractional)(t.symbol,{signal:this._dataLoadingAbortController.signal}),wt(e.accountMetainfo(),{id:e.metainfo().id,name:e.metainfo().title}),wt(e.formatter(t.symbol,!1),new j.PriceFormatter)]).then((async([i,r,n,a,l,d,u])=>{this.showRiskControlsAndInfo=k.supportRiskControlsAndInfo&&0!==i.pipValue,this.currency=(0,N.getCurrency)(d),this.symbolType=i.type,this.brokerSymbol=(0,N.getSymbolNameOverFullname)(i.brokerSymbol||t.brokerSymbol||this.symbol),this.isFractional=l,this._supportBrackets=p===Ft.IndividualPosition?r?.supportIndividualPositionBrackets:r?.supportPositionBrackets,this._supportBracketsInPips=r?.supportBracketsInPips,this._supportModifyBrackets=this._supportBrackets&&k.supportModifyBrackets&&k.supportModifyPositionBrackets,this._supportStopLoss=Boolean(this._supportBrackets&&(k.supportStopLoss??!0)),this._supportTrailingStop=this._supportBrackets&&k.supportTrailingStop,this._supportGuaranteedStop=this._supportBrackets&&k.supportGuaranteedStop,this._supportModifyTrailingStop=this._supportTrailingStop&&this._supportModifyBrackets&&k.supportModifyTrailingStop,this._quotes$=V((0,w.fromEventPattern)((e=>o.subscribeRealtime(t.symbol,e)),(e=>o.unsubscribeRealtime(t.symbol,e)),((e,t)=>t))),this._equity$=V((0,w.fromEventPattern)((t=>e.subscribeEquity(t)),(t=>e.unsubscribeEquity(t)),((e,t)=>t))),this._pipValues$=V((0,
w.fromEventPattern)((i=>e.subscribePipValue(t.symbol,i)),(i=>e.unsubscribePipValue(t.symbol,i)),((e,t)=>t)).pipe((0,B.startWith)({buyPipValue:i.pipValue,sellPipValue:i.pipValue}))),this._pipValue$=this._pipValues$.pipe((0,m.map)((e=>1===t.side?e.buyPipValue:e.sellPipValue))),await this._createModels({brackets:s,info:i,accInfo:d,formatter:u,orderDialogOptions:b,orders:n,positionDialogOptions:a,hasTrailingStopBracket:f,initialSLPriceEquivalentType:P,initialTPPriceEquivalentType:S}),this.supportOnlyPairPositionBrackets&&this._updateWarning(),this._subscribe();const c=this.stopLossModel.isValuesInitialized$.pipe((0,$.filter)((e=>e))),h=this.takeProfitModel.isValuesInitialized$.pipe((0,$.filter)((e=>e)));await Promise.all([(0,D.firstValueFrom)(c),(0,D.firstValueFrom)(h)])}))}onBracketsStateChanged(){return this._onBracketsStateChanged}destroy(){this._onBracketsStateChanged.unsubscribeAll(this),this._subscriptions&&this._subscriptions.forEach((e=>e.unsubscribe())),this.headerModel&&(this.headerModel.unsubscribe(),this.headerModel.pinButtonClicked().unsubscribe(this,this._toggleMode),this.headerModel.closeButtonClicked().unsubscribe(this,this._closeWidget)),null!==this.positionInfoModel&&this.positionInfoModel.unsubscribe(),this.supportPositions&&this._adapter.positionUpdate.unsubscribe(this,this._positionOrIndividualPositionUpdate),this.supportIndividualPositions&&this._adapter.individualPositionUpdate.unsubscribe(this,this._positionOrIndividualPositionUpdate),this.supportOnlyPairPositionBrackets&&this._adapter.orderUpdate.unsubscribe(this,this._updateWarning),void 0!==this.buttonModel&&this.buttonModel.unsubscribe(),this._dataLoadingAbortController.abort()}side(){return this._position.side}onBackButtonClicked(){return this._onBackButtonClicked}onCloseButtonClicked(){return this._onCloseButtonClicked}supportBrackets(){return Boolean(this._supportBrackets)}supportStopLoss(){return Boolean(this._supportStopLoss)}supportTrailingStop(){return Boolean(this._supportTrailingStop)}supportGuaranteedStop(){return Boolean(this._supportGuaranteedStop)}supportModifyTrailingStop(){return Boolean(this._supportModifyTrailingStop)}getStatus(){return this._status$.getValue()}isButtonDisabled(){return this._isButtonDisabled$.getValue()}async _createModels(e){const{brackets:t,info:i,accInfo:s,formatter:r,orders:o,orderDialogOptions:a,positionDialogOptions:l,hasTrailingStopBracket:d,initialSLPriceEquivalentType:u,initialTPPriceEquivalentType:c}=e,h={[R.BracketType.TakeProfit]:await(0,Q.extractTakeProfitValidationRules)(this._adapter,this.symbol),[R.BracketType.StopLoss]:await(0,Q.extractStopLossValidationRules)(this._adapter,this.symbol),[R.BracketType.GuaranteedStop]:await(0,Q.extractGuaranteedStopValidationRules)(this._adapter,this.symbol),[R.BracketType.TrailingStop]:await(0,Q.extractStopLossValidationRules)(this._adapter,this.symbol)},p=(0,N.getCurrency)(s)||"$",_=new n.BehaviorSubject(this._position.side||-1);this.headerModel=new qe({displaySymbolName:this._getCurrentSymbolName(),symbol:this.symbol,mode$:this._displayMode$,
quotes$:this._quotes$,status$:this._status$,parentType:2,isExistingOrder:!0,isTradable:!0,data:this._position,formatter:this._position.priceFormatter?this._position.priceFormatter:r,headerState:this._headerState,brokerId:this._adapter?.metainfo().id,accountType:this._adapter?.currentAccountType(),brokerLogo:{logo:this._adapter?.metainfo().logoMiniUrl,logoBlack:this._adapter?.metainfo().logoMiniBlackUrl},brokerName:this._adapter?.metainfo().title});const g=this.supportModifyTrailingStop(),y="takeProfit"in t,b=y?Boolean(t.takeProfit):Boolean(this._position.takeProfit),m=y?t.takeProfit:this._position.takeProfit||null,v=b?m:this._existingPosition?.takeProfit;this.takeProfitModel=new Ve({initialPrice:v,initialEnabled:b,initialBracketType:R.BracketType.TakeProfit,initialFocusedControl:"Price",initialPriceEquivalentType:c,formatter:r,equity$:this._equity$,quotes$:this._quotes$,info:i,pipValue$:this._pipValue$,side$:_,amount$:new n.BehaviorSubject(this._position.qty),parentPrice$:new n.BehaviorSubject(this._position.avgPrice??this._position.price),orderType$:this.orderType$,currency:p,parentType:2,savedPips:null,orderWidgetStat:null,showRiskControlsAndInfo:this.showRiskControlsAndInfo,status:this._status$.getValue(),supportTrailingStop:this.supportTrailingStop(),supportGuaranteedStop:this.supportGuaranteedStop(),supportModifyBrackets:this._supportModifyBrackets,useContextValidation:!1,validationRulesByType:h,supportModifyTrailingStop:g,useValidationAgainstMarket:this._adapter.metainfo().configFlags.supportValidationAgainstMarket,supportBracketsInPips:this._supportBracketsInPips});const f=o.filter((e=>2===e.parentType&&e.parentId===this._position.id&&(0,N.isOrderActive)(e.status))),P=!0===d||f.some((e=>e.stopType===q.StopType.TrailingStop)),{makeInitialSLPrice:S,makeInitialSLBracketType:k,makeInitialSLEnabled:C,makeInitialSLPips:T}=Ie,w={stopLoss:"stopLoss"in t?t.stopLoss:this._position.stopLoss,trailingStopPips:"trailingStopPips"in t?t.trailingStopPips:this._position.trailingStopPips,guaranteedStop:"guaranteedStop"in t?t.guaranteedStop:this._position.guaranteedStop,supportStopLoss:this._adapter.metainfo().configFlags?.supportStopLoss,supportGuaranteedStop:this._adapter.metainfo().configFlags?.supportGuaranteedStop,supportTrailingStop:this._adapter.metainfo().configFlags?.supportTrailingStop},B={stopLoss:this._existingPosition?.stopLoss,trailingStopPips:this._existingPosition?.trailingStopPips,guaranteedStop:this._existingPosition?.guaranteedStop,supportStopLoss:this._adapter.metainfo().configFlags?.supportStopLoss,supportGuaranteedStop:this._adapter.metainfo().configFlags?.supportGuaranteedStop,supportTrailingStop:this._adapter.metainfo().configFlags?.supportTrailingStop},O=f[0]?.customFields;this.customFieldsModel=new K.CustomFieldsViewModel({existingOrder:Boolean(f.length),customFields:l?.customFields,initialInputState:O,orderType$:(0,A.of)(null),initialOrderType:null});const M=C(w),E=S(M?w:B),I=T(M?w:B),V=k(M?w:B);this.stopLossModel=new Ve({initialPrice:E,initialPips:I,initialEnabled:M,initialBracketType:V,
initialFocusedControl:"Price",initialPriceEquivalentType:u,formatter:r,equity$:this._equity$,quotes$:this._quotes$,info:i,pipValue$:this._pipValue$,side$:_,amount$:new n.BehaviorSubject(this._position.qty),parentPrice$:new n.BehaviorSubject(this._position.avgPrice),orderType$:this.orderType$,currency:p,parentType:2,savedPips:null,orderWidgetStat:null,showRiskControlsAndInfo:this.showRiskControlsAndInfo,status:this._status$.getValue(),supportStopLoss:this._supportStopLoss,supportTrailingStop:this._supportTrailingStop,supportGuaranteedStop:this._supportGuaranteedStop,supportModifyBrackets:this._supportModifyBrackets,useContextValidation:!1,validationRulesByType:h,supportModifyTrailingStop:g,hasTrailingStopBracket:P,useValidationAgainstMarket:this._adapter.metainfo().configFlags.supportValidationAgainstMarket,supportBracketsInPips:this._supportBracketsInPips});const $=(0,te.shouldShowTotal)(a),D=this.supportBrackets();this.supportCryptoExchangeOrderTicket||(this.positionInfoModel=new Rt({qty:this._position.qty,currency:(0,N.getCurrency)(s),positionPrice:this._position.avgPrice,showTotalInsteadOfTradeValue:$,info:i,pipValueType$:this._pipValueType$,tpInfo:D&&this.takeProfitModel?{enabled:this.takeProfitModel.enabled$,riskInCurrency:this.takeProfitModel.riskInCurrency$,riskInPercent:this.takeProfitModel.riskInPercent$}:null,slInfo:D&&this.stopLossModel?{enabled:this.stopLossModel.enabled$,riskInCurrency:this.stopLossModel.riskInCurrency$,riskInPercent:this.stopLossModel.riskInPercent$}:null,showRiskControlsAndInfo:this.showRiskControlsAndInfo,supportMargin:this._adapter.metainfo().configFlags.supportMargin??!1})),this.buttonModel=new vt(R.TradingEntityType.Position,this._displayMode$)}_updateWarning(){this._adapter.orders().then((e=>{const t=e.find((e=>e.symbol===this._position.symbol&&e.side!==this._position.side&&(6===e.status&&void 0===e.parentId||3===e.status)));this._warning$.next(t?C.t(null,void 0,i(913064)):void 0)}))}_subscribe(){if(this.headerModel.pinButtonClicked().subscribe(this,this._toggleMode),this.headerModel.closeButtonClicked().subscribe(this,this._closeWidget),this._buttonDataSubscription=(0,L.combineLatest)({loading:this._loading$,quotes:this._quotes$,takeProfitError:this.takeProfitModel.error$,stopLossError:this.stopLossModel.error$,takeProfitEnabled:this.takeProfitModel.enabled$,stopLossEnabled:this.stopLossModel.enabled$}).subscribe((e=>{const{loading:t,quotes:i,takeProfitError:s,stopLossError:r,takeProfitEnabled:o,stopLossEnabled:n}=e;this._isButtonDisabled$.next(t||(0,N.isNoQuotes)(i)||o&&(0,te.simplifyControlErrorFormat)(s,["error",void 0])||n&&(0,te.simplifyControlErrorFormat)(r,["error",void 0]))})),this._rewardRiskSubscription=(0,L.combineLatest)([this.takeProfitModel.enabled$.pipe((0,x.switchMap)((e=>e?(0,r.ensureDefined)(this.takeProfitModel).pips$:(0,A.of)(null)))),this.stopLossModel.enabled$.pipe((0,x.switchMap)((e=>e?(0,r.ensureDefined)(this.stopLossModel).pips$:(0,A.of)(null))))]).subscribe((([e,t])=>{this._rewardRisk$.next((0,te.formatRiskReward)(e,t))})),
this.customFieldsModel.subscribe(),this.buttonModel&&this.buttonModel.subscribe(),this._subscriptions=[...this.takeProfitModel.subscribe(),...this.stopLossModel.subscribe(),this._rewardRiskSubscription,this._buttonDataSubscription,this._equity$.connect(),this._quotes$.connect(),this._pipValues$.connect(),this._isUndockAllowed$.subscribe(this._onUndockAllowedChanged)],null!==this.positionInfoModel&&this.positionInfoModel.subscribe(),this.supportPositions&&this._adapter.positionUpdate.subscribe(this,this._positionOrIndividualPositionUpdate),this.supportIndividualPositions&&this._adapter.individualPositionUpdate.subscribe(this,this._positionOrIndividualPositionUpdate),this.supportOnlyPairPositionBrackets){this._adapter.orderUpdate.subscribe(this,this._updateWarning);const e=this.stopLossModel.enabled$.pipe(b(this.takeProfitModel.enabled$)).subscribe((e=>{const[t,i]=e;i!==t&&this.takeProfitModel.setEnabled(t)})),t=this.takeProfitModel.enabled$.pipe(b(this.stopLossModel.enabled$)).subscribe((e=>{const[t,i]=e;i!==t&&this.stopLossModel.setEnabled(t)}));this._subscriptions.push(t,e)}this._onBracketsStateChanged.subscribe(this,(e=>{this.brackets=e})),this._bracketsSubscription=(0,L.combineLatest)({stopLossEnabled:this.stopLossModel.enabled$,stopLossPrice:this.stopLossModel.price.value$,stopLossPips:this.stopLossModel.pips$,stopBracketType:this.stopLossModel.bracketType$,takeProfitEnabled:this.takeProfitModel.enabled$,takeProfitPrice:this.takeProfitModel.price.value$}).subscribe((e=>{const{stopLossEnabled:t,stopLossPrice:i,stopLossPips:s,takeProfitEnabled:r,takeProfitPrice:o}=e,n={takeProfit:r&&o?o:void 0,guaranteedStop:void 0,stopLoss:void 0,trailingStopPips:void 0,trailingStopPrice:void 0};if(!t||null===i)return this._onBracketsStateChanged.fire(n);switch(this.stopLossModel.getBracketType()){case R.BracketType.StopLoss:n.stopLoss=i??void 0;break;case R.BracketType.GuaranteedStop:n.guaranteedStop=i??void 0;break;case R.BracketType.TrailingStop:n.trailingStopPrice=i??void 0,n.trailingStopPips=s??void 0}this._onBracketsStateChanged.fire(n)})),this._subscriptions.push(this._bracketsSubscription)}_doneHandler(){const e={},t=this.stopLossModel.getEnabled(),i=this.stopLossModel.price.getValue(),s=this.stopLossModel.getPips(),r=this.stopLossModel.getError(),o=(0,te.simplifyControlErrorFormat)(r,["error",void 0]);t&&null!==s&&null!==i&&!o&&(this.stopLossModel.getBracketType()===R.BracketType.StopLoss&&(e.stopLoss=i),this.stopLossModel.getBracketType()===R.BracketType.TrailingStop&&(e.trailingStopPips=s),this.stopLossModel.getBracketType()===R.BracketType.GuaranteedStop&&(e.guaranteedStop=i));const n=this.takeProfitModel.getEnabled(),a=this.takeProfitModel.price.getValue(),l=this.takeProfitModel.getError(),d=(0,te.simplifyControlErrorFormat)(l,["error",void 0]);if(n&&null!==a&&!d&&(e.takeProfit=a),this.customFieldsModel.getCustomFieldsModels().length>0){const t=this.customFieldsModel.getCustomFieldsInputValues();return this._getAndSendStatistics(),this._handler(this.position.id,e,t)}return this._getAndSendStatistics(),
this._handler(this.position.id,e)}_getAndSendStatistics(){const e=this.stopLossModel.getEnabled(),t=this.stopLossModel.getFocusedControl(),i=this.takeProfitModel.getEnabled(),s=this.takeProfitModel.getFocusedControl(),r=this.stopLossModel&&this.stopLossModel.getBracketType(),o=[" Disabled"," Active"],n=["StopLoss","TakeProfit","TrailingStop"],a={SL:{active:o[+e],mode:t},TP:{active:o[+i],mode:s}};this.supportTrailingStop()&&(a.SLType={active:o[+e],mode:n[r]}),Object.keys(a).forEach((e=>{a[e].active&&this._trackEvent("Position Ticket",e,a[e].mode)}))}_positionOrIndividualPositionUpdate(e){!this._isVisible()||this._loading$.getValue()||e.id!==this.position.id||0!==e.qty&&this.position.side===e.side||(this._getDisplayMode()===F.OrderEditorDisplayMode.Popup?this.headerModel.close():this._back())}_closeWidget(){this.onDoneButtonClicked.resolve(!1),this._onCloseButtonClicked.fire()}_back(){this.onDoneButtonClicked.resolve(!1),this._onBackButtonClicked.fire()}_getCurrentSymbolName(){return(this.brokerSymbol?(0,N.safeSplitSymbol)(this.brokerSymbol)[1]:(0,N.safeSplitSymbol)(this.symbol)[1])??this.brokerSymbol}}var Qt=i(617998);class Ut{constructor(e){this._brokerId="",this._settingsAdapter=e}setBrokerId(e){this._brokerId=e}saveSettings(e){this._settingsAdapter.setValue(this._makeKey(Qt.settingsKeys.ORDER_PANEL_SETTINGS,this._brokerId),JSON.stringify(e))}getSettings(){const e=this._settingsAdapter.getValue(this._makeKey(Qt.settingsKeys.ORDER_PANEL_SETTINGS,this._brokerId));try{return JSON.parse(e)}catch{return null}}setWidgetMode(e){this._settingsAdapter.setValue(Qt.settingsKeys.ORDER_WIDGET_MODE,e)}widgetMode(){const e=this._settingsAdapter.getValue(Qt.settingsKeys.ORDER_WIDGET_MODE);return e||null}_makeKey(e,t,i){return e+t+("string"==typeof i?"."+i:"")}}var Wt,zt=i(474229),jt=i(324889),Ht=i(739695),Gt=i(895318),Kt=i(73221),Yt=i(91603),Xt=i(483670),Jt=i(963632);!function(e){let t=0;const i=new Jt.WatchedValue(!1);e.value=i.readonly(),e.wrap=function(e){return async(...s)=>{i.setValue(!0),t++;try{return await e(...s)}finally{t--,i.setValue(0!==t)}}}}(Wt||(Wt={}));var Zt=i(465688);const ei={[Ht.PlaceOrEditContextType.PlaceOrder]:F.OrderPanelStatus.Active,[Ht.PlaceOrEditContextType.EditOrder]:F.OrderPanelStatus.Editing,[Ht.PlaceOrEditContextType.EditPosition]:F.OrderPanelStatus.Editing,[Ht.PlaceOrEditContextType.EditIndividualPosition]:F.OrderPanelStatus.Editing};function ti(e){return void 0!==e&&["OrderPresetSource:Hotkey","OrderPresetSource:SellBuyButtons","OrderPresetSource:OrderTicketHeader"].includes(e)}const ii=(0,v.getLogger)("Trading.OrderViewController");function si(){return Promise.all([i.e(7664),i.e(8894),i.e(5743),i.e(3329),i.e(4391),i.e(9117),i.e(442),i.e(1450),i.e(5994),i.e(7702),i.e(2950),i.e(4059),i.e(5448),i.e(3585),i.e(5001),i.e(8490),i.e(4712),i.e(2568),i.e(5875),i.e(563),i.e(9365),i.e(6644),i.e(5787),i.e(3178),i.e(3250),i.e(2292),i.e(1553),i.e(7125),i.e(9643),i.e(987),i.e(1257),i.e(1054),i.e(7502)]).then(i.bind(i,523398))}function ri(){
return Promise.all([i.e(1521),i.e(8894),i.e(5743),i.e(3329),i.e(4391),i.e(9117),i.e(442),i.e(7702),i.e(2950),i.e(3585),i.e(5001),i.e(8490),i.e(4712),i.e(2568),i.e(5875),i.e(5787),i.e(2544),i.e(1553),i.e(7125),i.e(987),i.e(1257),i.e(8751)]).then(i.bind(i,22e3))}const oi="order-ticket",ni="position-panel",ai=!1;function li(e){return e.hasOwnProperty("id")}function di(e){if(0===e.length)return null;const t=new Set(e.flatMap((e=>e.saveToSettings?e.id:[])));return 0!==t.size?t:null}function ui(e){const{pips:t,riskInPercent:i,parentPricePercent:s}=e;let r,o,n="Price";return void 0!==t&&(r=t,o="Pips",n="PriceEquivalent"),void 0!==i&&(r=i,o="RiskInPercent",n="PriceEquivalent"),void 0!==s&&(r=s,o="ParentPricePercent",n="PriceEquivalent"),{priceEquivalent:r,priceEquivalentType:o,focusedControl:n}}class ci{constructor(e){this._orderViewModel=null,this._positionViewModel=null,this._dialogVisibility=new Xt.DialogVisibility,this._orderWidgetStat=null,this._stopSubscriptions$=new o.Subject,this._settings$=new n.BehaviorSubject(Gt.defaultSettings),this._mode$=new n.BehaviorSubject(F.OrderEditorDisplayMode.Panel),this.openPanel=async()=>{try{await this.closeDialogs(),this._setDisplayMode(F.OrderEditorDisplayMode.Panel),this._openTradingPanelPage(zt.TradingPage.OrderPanel);const e=this._tradedContextLinking?.context()??null;if(!e||(0,Ht.isContextPlaceOrderContext)(e)||(0,Ht.isContextEditOrderContext)(e)){const t=e?.data();t&&ti(t?.creationSource)&&(t.creationSource=void 0),await this._recreateOrderViewModel(null,t),await this._openOrderPanel(this._getDefaultOrderTicketFocus())}if((0,Ht.isContextEditIndividualPositionContext)(e)||(0,Ht.isContextEditPositionContext)(e)){const t=e.data();await this._createAndShowPositionViewModel({position:t,brackets:(0,Zt.getBracketsFromOrderOrPosition)(t),viewType:(0,Ht.isContextEditIndividualPositionContext)(e)?Ft.IndividualPosition:Ft.Position,hasTrailingStopBracket:t.hasTrailingStopBracket})}}catch(e){ii.logWarn(`Failed to open panel: ${(0,k.getLoggerMessage)(e)}`),this._closePanel()}},this.closePanel=e=>{this.getDisplayMode()===F.OrderEditorDisplayMode.Panel&&this._closePanel(e)},this.openOrderDialog=async()=>{try{await this.closeDialogs(),ai?this._setDisplayMode(F.OrderEditorDisplayMode.ResizableDrawer):this._setDisplayMode(F.OrderEditorDisplayMode.Popup);const e=this._tradedContextLinking?.context()??null;if((0,Ht.isContextEditIndividualPositionContext)(e)||(0,Ht.isContextEditPositionContext)(e))return await this._openPositionDialogFromContext(e);const t=(0,Ht.isContextEditOrderContext)(e)||(0,Ht.isContextPlaceOrderContext)(e)?e.data():void 0;await this._recreateOrderViewModel(null,t),this.getDisplayMode()===F.OrderEditorDisplayMode.ResizableDrawer?this._showOrderDrawer():this._showOrderDialog()}catch(e){ii.logWarn(`Failed to open order dialog: ${(0,k.getLoggerMessage)(e)}`),this.closeDialogs()}},this.closeDialogs=async()=>{this._unsubscribeViewModels(),await this._closeOrderDialog(),await this._closePositionDialog()},this.closeOrderView=()=>{
this.getDisplayMode()===F.OrderEditorDisplayMode.Panel?this._closePanel():this.closeDialogs()},this.isOrderDialogVisible=()=>null===this._positionViewModel&&!!this._dialogVisibility.getValue().isVisible,this.getDisplayMode=()=>this._mode$.getValue(),this.resetQuantityFocusToUnits=()=>{this._orderViewModel?.quantityModel instanceof tt&&"units"!==this._orderViewModel.quantityModel.getInputType()?this._orderViewModel.quantityModel.setInputTypeAndValue("units",this._orderViewModel.quantityModel.getValue()):this._orderViewModel?.quantityModel instanceof rt&&1!==this._orderViewModel?.quantityModel.getFocusedControl()&&this._orderViewModel.quantityModel.setFocusedControl(1)},this._openPositionDialogFromContext=async e=>{const t=e.data();await this._createAndShowPositionViewModel({position:t,brackets:(0,Zt.getBracketsFromOrderOrPosition)(t),viewType:(0,Ht.isContextEditIndividualPositionContext)(e)?Ft.IndividualPosition:Ft.Position,hasTrailingStopBracket:t.hasTrailingStopBracket})},this._onActiveTradingPanelChanged=e=>{e!==zt.TradingPage.OrderPanel&&(null!==this._positionViewModel&&(this._unmountPositionPanel(),this._unsubscribePositionViewModel()),null!==this._orderViewModel&&this.getDisplayMode()===F.OrderEditorDisplayMode.Panel&&(this._orderViewModel.existingOrder&&this._orderViewModel.onDoneButtonClicked.resolve(!1),this._unmountOrderPanel(),this._unsubscribeOrderViewModel()))},this._onStatusChanged=async e=>{try{const t=this._state,i=this._makeState();i.symbol===t.symbol&&i.broker===t.broker&&i.accountId===t.accountId&&i.isAuthenticated===t.isAuthenticated||(this._unsubscribeViewModels(),this._state=i,this._setSettings(),await this._closeOrderDialog(),await this._closePositionDialog(),!e?.aborted&&this._isTradingPanelOpened.value()&&this.getDisplayMode()===F.OrderEditorDisplayMode.Panel&&this._tradingPanelActivePage.value()===zt.TradingPage.OrderPanel&&(await this._recreateOrderViewModel(e),this._openOrderPanel()))}catch(e){ii.logWarn(`Failed to change status: ${(0,k.getLoggerMessage)(e)}`)}},this._recreateOrderViewModel=async(e,t,i=!0)=>{this._unsubscribeViewModels(),this._orderStub=t??this._createOrderStub();const{broker:s,symbol:o,side:n}=this._state;let a=null;if(null===s)a=new qt({...this._commonOrderViewModelProps(),adapter:s,isTradable:{tradable:!1},sendHandler:()=>Promise.resolve(!0),previewHandler:async()=>({sections:[]})});else{const i=await(0,ut.respectAbort)(e,s.isTradable(o)),l=e=>{ti(e)&&(this._trackOrderPresetSnowplowEvent("place_order_from_order_ticket_after_preset_was_applied"),this._clearOrderCreationSource())};let d=(e,t)=>(l(e.creationSource),s.placeOrder(e,t)),u=s.modifyOrder.bind(s);void 0!==this._tradedContextLinking&&(d=async(e,t)=>{l(e.creationSource);const i=(0,r.ensureDefined)(this._tradedContextLinking,"Recreate order view model: Trade context linking");return(0,r.ensureNotNull)(i.context(),"Recreate order view model: Place order handler trade context").send(t).finally((()=>i.clear()))},s.metainfo().configFlags.supportEditContexts&&(u=async(e,t)=>{const i=(0,
r.ensureDefined)(this._tradedContextLinking,"Recreate order view model: Trade context linking");return(0,r.ensureNotNull)(i.context(),"Recreate order view model: Edit order handler trade context").send(t).finally((()=>i.clear()))}));const c=this._orderStub.hasOwnProperty("id")?u:d,h=async e=>{const t=this._tradedContextLinking?.context();return t?t.preview():s.previewOrder(e)};let p=null;i.tradable&&(p=t?.type??this._getTradingSettingsStorage()?.orderType(o)??(0,N.getDefaultOrderType)(s.config)??null);const _=await(0,ut.respectAbort)(e,s.getOrderDialogOptions(o)),g=void 0!==_?.customFields?di(_.customFields):null;this._setState({orderType:p,savableCustomFields:g});const y=this._makeOrderViewInputState(o,p,n,g),b=void 0!==t&&li(t)?this._getOrderById(t.id):null;a=new qt({...this._commonOrderViewModelProps(),adapter:s,isTradable:i,sendHandler:c,previewHandler:h,orderViewInputState:y,orderDialogOptions:_,existingPlacedOrder:b})}this._orderViewModel=a;const[l=null]=await(0,ut.respectAbort)(e,Promise.all([this._orderPresetsManager?.createConsumer(o).then((t=>e?.aborted?(t?.destroy(),null):t)),a.onReady]));if(this._orderViewModel!==a)return Promise.reject("OrderViewModel was recreated during the initialization");const d=this._tradedContextLinking?.context()??null;(0,Ht.isContextEditOrderContext)(d)&&this._updateMainOrder(d),this._subscribeOrderViewModel(),this._orderPresetsManagerConsumer=l,this._orderViewHeaderState.setOrderPresetsManagerConsumer(l),this._placeOrderAbortController?.abort(),this._placeOrderAbortController=new AbortController,i&&this._updateTradedContextLinking(this._placeOrderAbortController.signal)},this._updateTradedContextLinking=async e=>{if((!this._orderViewModel?.existingOrder&&!this._positionViewModel||this._realtimeProvider.activeBroker()?.metainfo().configFlags.supportEditContexts)&&null!==this._state.broker&&void 0!==this._tradedContextLinking&&null!==this._orderViewModel&&this._orderViewModel.getStatus()!==F.OrderPanelStatus.Wait&&void 0!==this._orderViewModel.side()&&(void 0!==this._orderViewModel.preOrder().limitPrice||void 0!==this._orderViewModel.preOrder().stopPrice||0!==this._orderViewModel.preOrder().seenPrice||2===this._orderViewModel.preOrder().type))try{if(this._orderViewModel.getStatus()===F.OrderPanelStatus.Wait)return;let t;if(this._orderViewModel.getStatus()===F.OrderPanelStatus.Editing){if(!this._orderViewModel.existingOrder||!li(this._orderStub))return;const i=this._getPricesFromOrderViewModel(),s=this._getBracketsFromOrderViewModel();t=await(0,ut.respectAbort)(e,this._state.broker.createEditOrderContext({order:{...this._orderStub,...this._orderViewModel.preOrder(),...i,...s},source:oi,signal:e}))}else t=await(0,ut.respectAbort)(e,this._state.broker.createPlaceOrderContext({order:this._orderViewModel.preOrder(),source:oi,signal:e}));if(e?.aborted)return;this._tradedContextLinking.setContext(t),await this._setErrorsState(t.errors())}catch(e){(0,ut.skipAbortError)(e)}},this._handleTradedContextChange=async(e,t)=>{if(((0,Ht.isContextEditOrderContext)(t)||(0,
Ht.isContextEditIndividualPositionContext)(t)||(0,Ht.isContextEditPositionContext)(t))&&!this._realtimeProvider.activeBroker()?.metainfo().configFlags.supportEditContexts)return;if(t?.status()===Ht.PlaceOrEditContextStatus.Destroyed)return this._orderViewModel?.setLoading(!1),void this._positionViewModel?.setLoading(!1);if((0,Ht.isContextEditIndividualPositionContext)(t)||(0,Ht.isContextEditPositionContext)(t))return this._handleEditPositionContextChange(e,t);if((0,Ht.isContextEditOrderContext)(t))return this._handleEditOrderContextChange(e,t);if(null===t){const e=this.getDisplayMode(),t=this._positionViewModel??this._orderViewModel;if(!t)return;return void(e===F.OrderEditorDisplayMode.Popup||e===F.OrderEditorDisplayMode.ResizableDrawer?t.headerModel.close():this._orderViewModel?this._orderViewModel.resetOrderPanel():this._positionViewModel&&this._onPositionWidgetBackButtonClicked())}if(null===this._orderViewModel)return;if(t.status()===Ht.PlaceOrEditContextStatus.Sent&&this._orderViewModel.setOrderPlacingStatus(F.OrderPlacingStatus.Placed),t.source()===oi)return void this._setErrorsState(t.errors());if(this._orderViewModel.setLoading(t.status()===Ht.PlaceOrEditContextStatus.Loading),this._orderViewModel.setStatus(ei[t.type]),t.source()===oi)return void await this._setErrorsState(t.errors());const i=this._orderViewModel;await i.onReady,i===this._orderViewModel&&(this._updateOrderValues(t.data()),await this._setErrorsState(t.errors()))},this._updateOrderValues=e=>{if(null===this._orderViewModel)return;const{duration:t,limitPrice:i,type:s,qty:r,side:o,stopPrice:n,stopLoss:a,takeProfit:l,stopType:d,trailingStopPrice:u,guaranteedStop:c}=e;void 0!==i&&this._orderViewModel.limitPriceModel.setPriceValue(i),void 0!==n&&this._orderViewModel.stopPriceModel.setPriceValue(n),this._orderViewModel.sideModel.getValue()!==o&&this._orderViewModel.sideModel.setValue(o),this._orderViewModel.getOrderType()!==s&&this._orderViewModel.setOrderType(s),this._orderViewModel.quantityModel.quantity.getValue()!==r&&this._orderViewModel.quantityModel.quantity.setValue(r),this._orderViewModel.durationModel.getValue()!==t&&this._orderViewModel.durationModel.setValue(t??null,s),void 0!==this._orderViewModel.stopLossModel&&this._updateStopLossValues({stopLossModel:this._orderViewModel.stopLossModel,stopLoss:a,trailingStopPrice:u,guaranteedStop:c,stopType:d}),void 0!==this._orderViewModel.takeProfitModel&&this._updateTakeProfitValues(this._orderViewModel.takeProfitModel,l)},this._applyOrderTemplate=e=>{const{type:t,duration:i,limitPrice:s,limitPriceOffset:r,stopPrice:o,stopPriceOffset:n,takeProfit:a,takeProfitPips:l,takeProfitRiskInPercent:d,takeProfitParentPricePercent:u,stopLoss:c,stopLossPips:h,stopLossRiskInPercent:p,stopLossParentPricePercent:_,trailingStopPips:g,guaranteedStop:y,symbol:b,stopType:m,creationSource:v}=e;if(null===this._orderViewModel||b!==this._orderViewModel.symbol)return;const{limitPriceModel:f,stopPriceModel:P,takeProfitModel:S,stopLossModel:k,durationModel:C,setOrderType:T}=this._orderViewModel
;v&&this._orderViewModel.setOrderCreationSource(v),void 0!==t&&(T(t),i&&C.setValue(i,t)),3!==t&&4!==t||P.setPriceValues({price:o,offset:n}),1!==t&&4!==t||f.setPriceValues({price:s,offset:r}),S?.setEnabled(!1),S?.setBracketValueWithControlsInfo({price:a,...ui({pips:l,riskInPercent:d,parentPricePercent:u})}),k?.setEnabled(!1),k?.setBracketValueWithControlsInfo({price:y||c,...ui({pips:g||h,riskInPercent:p,parentPricePercent:_})}),k?.getEnabled()&&k.setBracketType(Ie.makeInitialSLBracketType({riskInPercent:p,trailingStopPips:g,stopLossPips:h,guaranteedStop:y,stopLoss:c,stopType:m,supportStopLoss:this._brokerConfigFlags?.supportStopLoss,supportGuaranteedStop:this._brokerConfigFlags?.supportGuaranteedStop,supportTrailingStop:this._brokerConfigFlags?.supportTrailingStop}))},this._onOrderWidgetModeChanged=async e=>{if(e===F.OrderEditorDisplayMode.Panel)await this._closeOrderDialog(),await this._openOrderPanel();else if(e===F.OrderEditorDisplayMode.Popup)await this._closeOrderPanel(),this._activateOrderTicket(),await this._showOrderDialog();else{const e=this._getDefaultOrderTicketFocus();await this._showOrderDrawer(e)}this._saveWidgetMode(e)},this._onOrderWidgetInputStateChanged=e=>{this._updateTradedContextLinking(this._placeOrderAbortController?.signal??null);const{symbol:t,orderType:i}=this._state;if((0,N.isDefined)(e.side)&&this._setState({side:e.side}),!(0,N.isDefined)(i))return;const o=this._getTradingSettingsStorage();if(null===o)return;const n=(0,r.ensureNotNull)(this._orderViewModel,"Order View Model").existingOrder;if((0,N.isDefined)(e.quantity)&&o.setSymbolQty(t,e.quantity),!n&&(0,N.isDefined)(e.orderSizeCalculatorQuantityType)&&o.setOrderSizeCalculatorQuantityType(t,e.orderSizeCalculatorQuantityType),(0,N.isDefined)(e.lastRiskQuantityType)&&s.setValue(Qt.settingsKeys.LAST_RISK_QUANTITY_TYPE,e.lastRiskQuantityType),(0,N.isDefined)(e.lastUsedQuantityType)&&o.setLastUsedQuantityType(t,e.lastUsedQuantityType),(0,N.isDefined)(e.orderSizeCalculatorValue)&&o.setOrderSizeCalculatorValue(t,e.orderSizeCalculatorValue),(0,N.isDefined)(e.takeProfitPips)&&o.setTakeProfitPips(t,e.takeProfitPips,F.BracketDefaultPips.TakeProfit),(0,N.isDefined)(e.stopLossPips)&&o.setStopLossPips(t,e.stopLossPips,F.BracketDefaultPips.StopLoss),(0,N.isDefined)(e.takeProfitPriceEquivalentType)&&o.setTakeProfitPriceEquivalentType(e.takeProfitPriceEquivalentType),(0,N.isDefined)(e.takeProfitFocusedControl)&&o.setTakeProfitFocusedControl(e.takeProfitFocusedControl),(0,N.isDefined)(e.stopLossPriceEquivalentType)&&o.setStopLossPriceEquivalentType(e.stopLossPriceEquivalentType),(0,N.isDefined)(e.stopLossFocusedControl)&&o.setStopLossFocusedControl(e.stopLossFocusedControl),(0,N.isDefined)(e.orderType)&&o.setOrderType(t,e.orderType),(0,N.isDefined)(e.duration)){const t=this._state.broker&&this._state.broker.metainfo().durations,s=t&&(t.find((e=>e.default))||t[0]),r=s&&s.name===e.duration.type?null:e.duration;o.setDuration(this._state.symbol,i,r)}if((0,N.isDefined)(e.customFields)&&null!==this._state.savableCustomFields){const s=function(e,t){const i={...e}
;if(void 0===t)return i;for(const e of Object.keys(i))t.has(e)||delete i[e];return i}(e.customFields,this._state.savableCustomFields);o.setCustomFields(t,i,s)}},this._onOrderWidgetCloseButtonClicked=()=>{this.getDisplayMode()===F.OrderEditorDisplayMode.Panel?this._closePanel():(this._closeOrderDialog(),this._unsubscribeViewModels())},this._onOrderWidgetStatusChanged=e=>{e===F.OrderPanelStatus.Wait&&(this._updateTradedContextLinking(null),this._tradedContextLinking?.clear()),e===F.OrderPanelStatus.Active&&void 0!==this._placeOrderAbortController&&this._updateTradedContextLinking(this._placeOrderAbortController.signal)},this._onOrderPlacingStatusChanged=e=>{this._mode$.value===F.OrderEditorDisplayMode.Panel&&this._setTradingPanelCoverIsShown(e===F.OrderPlacingStatus.Placed)},this._onOrderWidgetBackButtonClicked=()=>{if(this._orderViewModel&&this._orderViewModel.getStatus()===F.OrderPanelStatus.Preview){this._activateOrderTicket();const e=this._getDefaultOrderTicketFocus();this.getDisplayMode()===F.OrderEditorDisplayMode.Panel?this._openOrderPanel(e):this.getDisplayMode()===F.OrderEditorDisplayMode.Popup?this._showOrderDialog(e):this._showOrderDrawer(e)}else this.showOrderView({order:this._createOrderStub(),isDeactivated:!0})},this._onPositionWidgetModeChanged=async e=>{e===F.OrderEditorDisplayMode.ResizableDrawer?await this._showPositionDrawer():e===F.OrderEditorDisplayMode.Panel?(await this._closePositionDialog(),await this._openPositionPanel()):(await this._closePositionPanel(),this._activateOrderTicket(),await this._showPositionDialog()),this._saveWidgetMode(e)},this._onPositionWidgetBackButtonClicked=()=>{this._unmountPositionPanel(),this._unsubscribePositionViewModel(),this.showOrderView({order:this._createOrderStub(),isDeactivated:!0})},this._onPositionWidgetCloseButtonClicked=()=>{this.getDisplayMode()===F.OrderEditorDisplayMode.Panel?this._closePanel():(this._closePositionDialog(),this._unsubscribeViewModels())},this._isVisible=()=>this.getDisplayMode()===F.OrderEditorDisplayMode.Panel?this._isTradingPanelOpened.value():this._dialogVisibility.getValue().isVisible,this._onOrderTypeChanged=e=>{this._setState({orderType:e})},this._toggleMode=()=>{this._setDisplayMode(this.getDisplayMode()===F.OrderEditorDisplayMode.Panel?F.OrderEditorDisplayMode.Popup:F.OrderEditorDisplayMode.Panel)},this._getSettings=()=>this._settings$.getValue(),this._toggleSettings=e=>{const t=this._getSettings();this._settings$.next({...t,[e]:!t[e]})},this._handleSymbolChange=()=>{this._symbolChangePromise=this._onStatusChanged(null).then((()=>{this._orderViewModel?.deactivateOrderTicket()}))},this._unsubscribeViewModels=()=>{null!==this._positionViewModel&&(this._positionViewModel.onDoneButtonClicked.resolve(!1),this._unsubscribePositionViewModel()),null!==this._orderViewModel&&(this._orderViewModel.existingOrder&&this._orderViewModel.onDoneButtonClicked.resolve(!1),this._unsubscribeOrderViewModel()),this._clearOrderCreationSource()},this._closePanel=e=>{
null!==this._positionViewModel&&(this._positionViewModel.onDoneButtonClicked.resolve(!1),this._unmountPositionPanel(),this._unsubscribePositionViewModel()),null!==this._orderViewModel&&(this._orderViewModel.existingOrder&&this._orderViewModel.onDoneButtonClicked.resolve(!1),this._unmountOrderPanel(),this._unsubscribeOrderViewModel()),this._closeTradingPanel(e)},this._handleKeyDown=e=>{if(this.getDisplayMode()===F.OrderEditorDisplayMode.Panel&&27===(0,f.hashFromEvent)(e)){const{activeElement:e}=document;if(null!==e&&(0,P.isTextEditingField)(e))return void this._rootContainer.focus();if(this._rootContainer?.contains(e))return void this.closePanel()}};const{tradingCommands:t,tradingPanelCommands:i,qtySuggester:a,tradingLinking:l,orderViewHeaderState:d,tradedContextLinking:u,orderPresetsManager:c,orderByIdGetter:h,positionByIdGetter:p,abortSignalGetter:_,trackOrderPresetSnowplowEvent:g}=e;if(this._orderPresetsManager=c,this._orderViewHeaderState=d,c&&this._orderViewHeaderState.setOrderTemplateApplicationFunction((e=>{e.creationSource="OrderPresetSource:OrderTicketHeader",this._applyOrderTemplate(e)})),this._handleTradedContextChange=(0,ut.respectLatest)(this._handleTradedContextChange),this._updateTradedContextLinking=(0,ut.respectLatest)(this._updateTradedContextLinking),this._tradingCommands=t,this._trackEvent=t.trackEvent,this._realtimeProvider=t.realtimeProvider,this._brokerConfigFlags=this._realtimeProvider.activeBroker()?.metainfo().configFlags,this._orderViewDataStorage=new Ut(s),this._rootContainer=i.rootContainer,this._tradingPanelContainer=i.container,this._isOpeningTradingPanelAvailable$=(0,jt.makeObservableFromWatchedValue)(i.isOpeningAvailable),this._isTradingPanelOpened=i.isOpened,this._getAbortSignal=_,this._qtySuggester=a,this._tradingLinking=l,this._tradingPanelActivePage=i.activePage,this._closeTradingPanel=i.close,this._openTradingPanelPage=i.openPage,this._setTradingPanelCoverIsShown=i.setCoverIsShown,this._trackOrderPresetSnowplowEvent=g,this._getTradingSettingsStorage=t.getTradingSettingsStorage,this.dialogVisibility=this._dialogVisibility.value$,ai)this._setDisplayMode(F.OrderEditorDisplayMode.ResizableDrawer);else if(window.matchMedia(Kt.TradingLayoutBreakpoint.Mobile).matches)this._setDisplayMode(F.OrderEditorDisplayMode.Popup);else if(S.enabled("order_panel")&&i.isOpeningAvailable.value()){const e=this._orderViewDataStorage.widgetMode();this._setDisplayMode(e??F.OrderEditorDisplayMode.Panel)}else this._setDisplayMode(F.OrderEditorDisplayMode.Popup);i.isOpeningAvailable.subscribe((e=>{e||this.getDisplayMode()!==F.OrderEditorDisplayMode.Panel||this._setDisplayMode(F.OrderEditorDisplayMode.Popup)})),this._state=this._makeState(),this.stateChanging=Wt.value,this._onStatusChanged=(0,ut.respectLatest)(this._onStatusChanged),this._recreateOrderViewModel=Wt.wrap((0,ut.respectLatest)(this._recreateOrderViewModel)),this.openPanel=Wt.wrap(this.openPanel),this._realtimeProvider.onStatusChanged.subscribe(null,(()=>this._onStatusChanged(null))),
this._tradingLinking.valueObservable().subscribe(this._handleSymbolChange),window.loginStateChange&&window.loginStateChange.subscribe(this,(()=>this._onStatusChanged(null))),i.activePage.subscribe(this._onActiveTradingPanelChanged),this._tradedContextLinking=u,i.rootContainer.addEventListener("keydown",this._handleKeyDown,{capture:!1}),this._getOrderById=h,this._getPositionById=p,this._tradedContextLinking?.onContextChanged().subscribe(this,(e=>this._handleTradedContextChange(null,e)))}async showOrderView(e){try{const{order:t,focus:i,forceOrderDialog:s,isDeactivated:o=!1,forceCollapsedOrderDrawer:n=!1,shouldOpenOrderTicket:a=!0,needUpdateContext:l}=e;0,await this.closeDialogs(),!ai&&s&&this._setDisplayMode(F.OrderEditorDisplayMode.Popup);const d=Object.assign(this._createOrderStub(),t);t.symbol!==this._state.symbol&&this._setState({symbol:t.symbol}),await this._recreateOrderViewModel(null,d,l),o&&this._deactivateOrderTicket();const u=i??this._getDefaultOrderTicketFocus();return this.getDisplayMode()===F.OrderEditorDisplayMode.Panel?this._openOrderPanel(u):this.getDisplayMode()===F.OrderEditorDisplayMode.Popup?this._showOrderDialog(u):this._showOrderDrawer(u,n),await(0,r.ensureNotNull)(this._orderViewModel).onDoneButtonClicked.promise}catch(e){return ii.logWarn(`Failed to show order view: ${(0,k.getLoggerMessage)(e)}`),!1}}async showPositionView(e,t,i,s,o){try{return await this._symbolChangePromise,await this._createAndShowPositionViewModel({position:e,viewType:Ft.Position,brackets:t,focus:i,forceCollapsedPositionDrawer:s,hasTrailingStopBracket:o}),(0,r.ensureNotNull)(this._positionViewModel).onDoneButtonClicked.promise}catch(e){return ii.logWarn(`Failed to show position view: ${(0,k.getLoggerMessage)(e)}`),!1}}async showIndividualPositionView(e,t,i,s){try{return await this._symbolChangePromise,await this._createAndShowPositionViewModel({position:e,viewType:Ft.IndividualPosition,brackets:t,focus:i,hasTrailingStopBracket:s}),(0,r.ensureNotNull)(this._positionViewModel).onDoneButtonClicked.promise}catch(e){return ii.logWarn(`Failed to show individual position view: ${(0,k.getLoggerMessage)(e)}`),!1}}orderTicketSettings(){return this._settings$.value}setOrderTicketSetting(e){this._orderViewDataStorage.saveSettings(e),this._setSettings()}_setState(e){this._state={...this._state,...e}}_setDisplayMode(e){this._mode$.next(e),this._saveWidgetMode(e)}_makeState(){const e=window.is_authenticated,t=this._tradingLinking.value().symbol||"",i=this._realtimeProvider.activeBroker(),s=i?.metainfo().configFlags,r=void 0!==s?(0,N.getDefaultOrderType)(s):null,o=this._orderViewModel?.getOrderType()??r??null,n=i?.currentAccount()??null,a=i?i.metainfo().id:"";return this._orderViewDataStorage.setBrokerId(a),{isAuthenticated:e,broker:i,symbol:t,accountId:n,side:1,orderType:o,savableCustomFields:null}}async _createAndShowPositionViewModel({position:e,viewType:t,brackets:i,focus:s,forceCollapsedPositionDrawer:o,hasTrailingStopBracket:n}){await this.closeDialogs(),this._setTradingPanelCoverIsShown(!1),
e.symbol!==this._state.symbol&&this._setState({symbol:e.symbol});const{broker:a,symbol:l}=this._state,d=a?await a.isTradable(l):null;if(null===a||null===d||!d.tradable)return void await this.showOrderView({order:this._createOrderStub()});const u=await a.getOrderDialogOptions(l),c=void 0!==u?.customFields?di(u.customFields):void 0;this._setState({savableCustomFields:c});let h=t===Ft.Position?a.editPositionBrackets.bind(a):a.editIndividualPositionBrackets.bind(a);void 0!==this._tradedContextLinking&&a.metainfo().configFlags.supportEditContexts&&(h=async()=>{const e=(0,r.ensureDefined)(this._tradedContextLinking,"Recreate position view model: Trade context linking");return(0,r.ensureNotNull)(e.context(),"Recreate position view model: Edit position brackets handler trade context").send().finally((()=>e.clear()))});const p=new Nt({adapter:a,position:e,existingPosition:this._getPositionById(e.id)??void 0,brackets:i,settings$:this._settings$,displayMode$:this._mode$,realtimeProvider:this._tradingCommands.realtimeProvider,isUndockAllowed$:this._isOpeningTradingPanelAvailable$,isVisible:this._isVisible,toggleMode:this._toggleMode,getDisplayMode:this.getDisplayMode,toggleSettings:this._toggleSettings,viewType:t,pipValueType$:this._tradingCommands.pipValueType$,handler:h,trackEvent:this._tradingCommands.trackEvent,orderDialogOptions:u,headerState:this._orderViewHeaderState,hasTrailingStopBracket:n,initialSLPriceEquivalentType:this._getTradingSettingsStorage()?.stopLossPriceEquivalentType(),initialTPPriceEquivalentType:this._getTradingSettingsStorage()?.takeProfitPriceEquivalentType()});if(this._positionViewModel=p,await this._positionViewModel.onReady,this._positionViewModel!==p)return Promise.reject("PositionViewModel was recreated during the initialization");const _=this._tradedContextLinking?.context()??null;((0,Ht.isContextEditIndividualPositionContext)(_)||(0,Ht.isContextEditPositionContext)(_))&&this._updatePositionValues(_),this._onPositionBracketsStateChanged(this._positionViewModel.brackets),this._subscribePositionViewModel(),this.getDisplayMode()===F.OrderEditorDisplayMode.ResizableDrawer?this._showPositionDrawer(s,o):this.getDisplayMode()===F.OrderEditorDisplayMode.Panel?this._openPositionPanel(s):this._showPositionDialog(s)}_setSettings(){if(null===this._state.broker)return;this._settingsSubscription?.unsubscribe();const e=Object.assign({},Gt.defaultSettings,this._orderViewDataStorage.getSettings());this._settings$.next(e),this._settingsSubscription=this._settings$.subscribe((e=>this._orderViewDataStorage.saveSettings(e)))}_createOrderStub(){return{limitPrice:void 0,stopPrice:void 0,qty:void 0,side:void 0,symbol:this._state.symbol,type:void 0,takeProfit:void 0,stopLoss:void 0}}_activateOrderTicket(){this._orderViewModel?.activateOrderTicket()}_deactivateOrderTicket(){this._orderViewModel?.deactivateOrderTicket()}async _setOrderViewErrorsState(e){if(null===this._orderViewModel)return;const t=this._orderViewModel;if(await t.onReady,t!==this._orderViewModel)return
;const i=e.stopLoss||e.trailingStopPips||e.guaranteedStop;e.limitPrice?this._orderViewModel.limitPriceModel.setControlError(!0,(0,k.getErrorMessage)(e.limitPrice)):this._orderViewModel.limitPriceModel.setControlError(!1),void 0!==e.stopPrice?this._orderViewModel.stopPriceModel.setControlError(!0,(0,k.getErrorMessage)(e.stopPrice)):this._orderViewModel.stopPriceModel.setControlError(!1),void 0!==e.qty?this._orderViewModel.quantityModel.setControlError(!0,(0,k.getErrorMessage)(e.qty)):this._orderViewModel.quantityModel.setControlError(!1),i?this._orderViewModel.stopLossModel?.setError(!0,(0,k.getErrorMessage)(i)):this._orderViewModel.stopLossModel?.setError(!1),e.takeProfit?this._orderViewModel.takeProfitModel?.setError(!0,(0,k.getErrorMessage)(e.takeProfit)):this._orderViewModel.takeProfitModel?.setError(!1)}async _setPositionViewErrorsState(e){if(null===this._positionViewModel)return;const t=this._positionViewModel;if(await t.onReady,t!==this._positionViewModel)return;const i=e.stopLoss||e.trailingStopPips||e.guaranteedStop;i?this._positionViewModel.stopLossModel?.setControlError(!0,(0,k.getErrorMessage)(i)):this._positionViewModel.stopLossModel?.setControlError(!1),e.takeProfit?this._positionViewModel.takeProfitModel?.setControlError(!0,(0,k.getErrorMessage)(e.takeProfit)):this._positionViewModel.takeProfitModel?.setControlError(!1)}async _setErrorsState(e){await Promise.all([this._setOrderViewErrorsState(e),this._setPositionViewErrorsState(e)])}_updateTakeProfitValues(e,t){const i=void 0!==t;e.getEnabled()!==i&&e.setEnabled(i),i&&"Price"!==e.getFocusedControl()&&e.setFocusedControl("Price");const s=t??null;i&&e.price.getValue()!==s&&e.price.setValue(s)}_updateStopLossValues(e){const{stopLossModel:t,stopLoss:i,trailingStopPrice:s,guaranteedStop:r,stopType:o}=e,n=void 0!==i||void 0!==s||void 0!==r;t.getEnabled()!==n&&t.setEnabled(n),void 0!==o&&t.getBracketType()!==(0,N.getBracketTypeByStopType)(o)&&t.setBracketType((0,N.getBracketTypeByStopType)(o)),n&&t.setBracketValueWithControlsInfo({price:s||r||i,focusedControl:"Price"})}async _openOrderPanel(e){await this._mountOrderPanel(e),this._openTradingPanelPage(zt.TradingPage.OrderPanel)}async _mountOrderPanel(e){const{mountOrderPanel:t}=await si();null!==this._orderViewModel&&t({viewModel:this._orderViewModel,settings$:this._settings$,mode:this.getDisplayMode(),resizerBridgeElement:this._tradingPanelContainer,focus:e,trackEvent:this._trackEvent})}async _closeOrderPanel(){await this._unmountOrderPanel(),this._closeTradingPanel()}async _unmountOrderPanel(){const{unmountOrderPanel:e}=await si();e((0,r.ensureNotNull)(this._tradingPanelContainer)),this._clearOrderCreationSource()}async _showOrderDialog(e){const{showOrderDialog:t}=await si(),{broker:i,symbol:s}=this._state;null!==this._orderViewModel&&null!==i&&t({viewModel:this._orderViewModel,settings$:this._settings$,mode:this.getDisplayMode(),focus:e,trackEvent:this._trackEvent,onOpen:e=>{this._dialogVisibility.setValue({isVisible:!0,isFullScreen:e})},onClose:()=>{this._dialogVisibility.setValue({isVisible:!1}),
this._orderViewModel?.onDoneButtonClicked.resolve(!1),this._unsubscribeViewModels()}})}async _closeOrderDialog(){const{closeOrderDialog:e,closeOrderDrawer:t}=await si(),i=()=>{this._dialogVisibility.setValue({isVisible:!1}),this._clearOrderCreationSource()};this.getDisplayMode()!==F.OrderEditorDisplayMode.ResizableDrawer?e(i):t(i)}_clearOrderCreationSource(){this._orderViewModel?.setOrderCreationSource(void 0),this._orderStub&&(this._orderStub.creationSource=void 0)}async _showOrderDrawer(e,t){const{showOrderDrawer:i}=await si();null!==this._orderViewModel&&i({viewModel:this._orderViewModel,settings$:this._settings$,mode:this.getDisplayMode(),focus:e??this._getDefaultOrderTicketFocus(),forceCollapsedOrderDrawer:t,trackEvent:this._trackEvent,onOpen:e=>{this._dialogVisibility.setValue({isVisible:!0,isFullScreen:e})},onClose:()=>{this._tradedContextLinking?.clear(),this._dialogVisibility.setValue({isVisible:!1}),this._orderViewModel?.onDoneButtonClicked.resolve(!1),this._unsubscribeViewModels()}})}_subscribeOrderViewModel(){this._stopSubscriptions$=new o.Subject,(0,r.ensureNotNull)(this._orderViewModel).onInputStateChanged().subscribe(this,this._onOrderWidgetInputStateChanged),(0,r.ensureNotNull)(this._orderViewModel).onCloseButtonClicked().subscribe(this,this._onOrderWidgetCloseButtonClicked),(0,r.ensureNotNull)(this._orderViewModel).onBackButtonClicked().subscribe(this,this._onOrderWidgetBackButtonClicked),(0,r.ensureNotNull)(this._orderViewModel).orderType$.pipe(c(this._stopSubscriptions$)).subscribe(this._onOrderTypeChanged),(0,r.ensureNotNull)(this._orderViewModel).status$.pipe(c(this._stopSubscriptions$)).subscribe(this._onOrderWidgetStatusChanged),(0,r.ensureNotNull)(this._orderViewModel).orderPlacingStatus$.pipe(c(this._stopSubscriptions$)).subscribe(this._onOrderPlacingStatusChanged),this._mode$.pipe(c(this._stopSubscriptions$),(0,h.skip)(1)).subscribe(this._onOrderWidgetModeChanged)}_unsubscribeOrderViewModel(){this._orderPresetsManagerConsumer?.destroy(),delete this._orderPresetsManagerConsumer,this._orderViewHeaderState.setOrderPresetsManagerConsumer(null),this._stopSubscriptions$.next(),this._stopSubscriptions$.complete(),(0,r.ensureNotNull)(this._orderViewModel).onInputStateChanged().unsubscribe(this,this._onOrderWidgetInputStateChanged),(0,r.ensureNotNull)(this._orderViewModel).onCloseButtonClicked().unsubscribe(this,this._onOrderWidgetCloseButtonClicked),(0,r.ensureNotNull)(this._orderViewModel).onBackButtonClicked().unsubscribe(this,this._onOrderWidgetBackButtonClicked),(0,r.ensureNotNull)(this._orderViewModel).destroy(),this._orderViewModel=null}_getDefaultOrderTicketFocus(){switch(this._orderViewModel?.getOrderType()){case 2:return 5;case 1:case 4:return 1;case 3:return 2;default:return}}async _openPositionPanel(e){await this._mountPositionPanel(e),this._openTradingPanelPage(zt.TradingPage.OrderPanel)}async _mountPositionPanel(e){const{mountPositionPanel:t}=await ri();if(null!==this._positionViewModel)return t(this._positionViewModel,this._settings$,this.getDisplayMode(),this._tradingPanelContainer,e)
}async _closePositionPanel(){await this._unmountPositionPanel(),this._closeTradingPanel()}async _unmountPositionPanel(){const{unmountPositionPanel:e}=await ri();e(this._tradingPanelContainer)}async _showPositionDialog(e){const{showPositionDialog:t}=await ri();null!==this._positionViewModel&&t({viewModel:this._positionViewModel,settings$:this._settings$,mode:this.getDisplayMode(),focus:e,onOpen:e=>{this._dialogVisibility.setValue({isVisible:!0,isFullScreen:e})},onClose:()=>{this._dialogVisibility.setValue({isVisible:!1}),this._positionViewModel?.onDoneButtonClicked.resolve(!1),this._unsubscribeViewModels()}})}async _closePositionDialog(){const{closePositionDialog:e}=await ri();e((()=>this._dialogVisibility.setValue({isVisible:!1})))}async _showPositionDrawer(e,t){const{showPositionDrawer:i}=await ri();null!==this._positionViewModel&&i({viewModel:this._positionViewModel,settings$:this._settings$,mode:this.getDisplayMode(),focus:e,onOpen:e=>{this._dialogVisibility.setValue({isVisible:!0,isFullScreen:e})},onClose:()=>{this._tradedContextLinking?.clear(),this._dialogVisibility.setValue({isVisible:!1}),this._positionViewModel?.onDoneButtonClicked.resolve(!1),this._unsubscribeViewModels()},forceCollapsedPositionDrawer:t})}_subscribePositionViewModel(){this._stopSubscriptions$=new o.Subject,(0,r.ensureNotNull)(this._positionViewModel).onBackButtonClicked().subscribe(this,this._onPositionWidgetBackButtonClicked),(0,r.ensureNotNull)(this._positionViewModel).onCloseButtonClicked().subscribe(this,this._onPositionWidgetCloseButtonClicked),(0,r.ensureNotNull)(this._positionViewModel).onBracketsStateChanged().subscribe(this,this._onPositionBracketsStateChanged);const e=e=>{return(0,p.pipe)(c(this._stopSubscriptions$),b(e),(t=([,e])=>!e,(0,a.operate)((function(e,i){var s=!1,r=0;e.subscribe(new l.OperatorSubscriber(i,(function(e){return(s||(s=!t(e,r++)))&&i.next(e)})))}))),(0,m.map)((([e])=>e)));var t};this._positionViewModel?.stopLossModel&&(this._positionViewModel.stopLossModel.priceEquivalentType$.pipe(e(this._positionViewModel.stopLossModel.isValuesInitialized$)).subscribe((e=>{this._getTradingSettingsStorage()?.setStopLossPriceEquivalentType(e)})),this._positionViewModel.stopLossModel.focusedControl$.pipe(e(this._positionViewModel.stopLossModel.isValuesInitialized$)).subscribe((e=>{this._getTradingSettingsStorage()?.setStopLossFocusedControl(e)}))),this._positionViewModel?.takeProfitModel&&(this._positionViewModel.takeProfitModel.priceEquivalentType$.pipe(e(this._positionViewModel.takeProfitModel.isValuesInitialized$)).subscribe((e=>{this._getTradingSettingsStorage()?.setTakeProfitPriceEquivalentType(e)})),this._positionViewModel.takeProfitModel.focusedControl$.pipe(e(this._positionViewModel.takeProfitModel.isValuesInitialized$)).subscribe((e=>{this._getTradingSettingsStorage()?.setTakeProfitFocusedControl(e)}))),this._mode$.pipe(c(this._stopSubscriptions$),(0,h.skip)(1)).subscribe(this._onPositionWidgetModeChanged)}_unsubscribePositionViewModel(){this._stopSubscriptions$.next(),this._stopSubscriptions$.complete(),(0,
r.ensureNotNull)(this._positionViewModel).onBackButtonClicked().unsubscribe(this,this._onPositionWidgetBackButtonClicked),(0,r.ensureNotNull)(this._positionViewModel).onCloseButtonClicked().unsubscribe(this,this._onPositionWidgetCloseButtonClicked),(0,r.ensureNotNull)(this._positionViewModel).onBracketsStateChanged().unsubscribe(this,this._onPositionBracketsStateChanged),(0,r.ensureNotNull)(this._positionViewModel).onDoneButtonClicked.resolve(!1),(0,r.ensureNotNull)(this._positionViewModel).destroy(),this._positionViewModel=null}_makeOrderViewInputState(e,t,i,r){const o=this._getTradingSettingsStorage(),n=null!==r&&null!==t?o?.customFields(e,t,Array.from(r)):null,a=null!==t?o?.duration(e,t):null;return{symbol:e,side:i,orderType:t,limitPrice:null,stopPrice:null,quantity:o?.symbolQty(e)||null,orderSizeCalculatorQuantityType:o?.orderSizeCalculatorQuantityType(e)||null,lastRiskQuantityType:s.getValue(Qt.settingsKeys.LAST_RISK_QUANTITY_TYPE)??null,lastUsedQuantityType:o?.lastUsedQuantityType(e)||null,orderSizeCalculatorValue:o?.orderSizeCalculatorValue(e)||null,takeProfitPips:o?.takeProfitPips(e)||null,takeProfitPrice:null,takeProfitEnabled:!1,takeProfitPriceEquivalentType:o?.takeProfitPriceEquivalentType()??null,takeProfitFocusedControl:o?.takeProfitFocusedControl()??null,stopLossPips:o?.stopLossPips(e)||null,stopLossPrice:null,stopLossEnabled:!1,stopLossPriceEquivalentType:o?.stopLossPriceEquivalentType()??null,stopLossFocusedControl:o?.stopLossFocusedControl()??null,duration:a||null,customFields:n||null,bracketType:null}}_commonOrderViewModelProps(){return{order:this._orderStub,settings$:this._settings$,displayMode$:this._mode$,orderWidgetStat:this._orderWidgetStat,isUndockAllowed$:this._isOpeningTradingPanelAvailable$,pipValueType$:this._tradingCommands.pipValueType$,onNeedSelectBroker:this._tradingCommands.onNeedSelectBroker,trackEvent:this._tradingCommands.trackEvent,toggleTradingWidget:this._tradingCommands.toggleTradingWidget,toggleTradingPanelPopup:this._tradingCommands.toggleTradingPanelPopup,toggleMode:this._toggleMode,getDisplayMode:this.getDisplayMode,toggleSettings:this._toggleSettings,getSettings:this._getSettings,showErrorNotification:this._tradingCommands.showErrorNotification,qtySuggester:this._qtySuggester,isVisible:this._isVisible,headerState:this._orderViewHeaderState,isOrderPresetsEnabled:false}}_saveWidgetMode(e){e!==F.OrderEditorDisplayMode.ResizableDrawer&&this._orderViewDataStorage.setWidgetMode(e)}async _onPositionBracketsStateChanged(e){if(!this._positionViewModel||!this._realtimeProvider.activeBroker()?.metainfo().configFlags.supportEditContexts)return;const t=this._positionViewModel?.position.id;if(void 0===t)return;let i=null;if(this._positionViewModel.supportIndividualPositions){const s=await(0,r.ensureNotNull)(this._realtimeProvider.activeBroker()).individualPositionById(t);if(!s)return;i=await(0,r.ensureNotNull)(this._realtimeProvider.activeBroker()).createEditIndividualPositionContext({position:{...s,...e},source:ni,isDisposable:!1})}else{const s=await(0,
r.ensureNotNull)(this._realtimeProvider.activeBroker()).positionById(t);if(!s)return;i=await(0,r.ensureNotNull)(this._realtimeProvider.activeBroker()).createEditPositionContext({position:{...s,...e},source:ni,isDisposable:!1})}i&&this._tradedContextLinking?.setContext(i)}async _handleEditOrderContextChange(e,t){if(this._orderViewModel&&this._orderViewModel.setLoading(t.status()===Ht.PlaceOrEditContextStatus.Loading),t.source()===oi)return void await this._setErrorsState(t.errors());if(!1===this._dialogVisibility.getValue().isVisible&&this.getDisplayMode()===F.OrderEditorDisplayMode.ResizableDrawer)return void this.showOrderView({order:t.data(),needUpdateContext:!1,forceCollapsedOrderDrawer:!0});if(!this._orderViewModel&&!this._positionViewModel)return;const i=t.data();if(this._orderViewModel&&this._orderViewModel.existingPlacedOrder?.id===i.id){const e=this._orderViewModel;if(await e.onReady,e!==this._orderViewModel)return}else try{await this.closeDialogs(),await this._recreateOrderViewModel(null,i,!1),this.getDisplayMode()===F.OrderEditorDisplayMode.Panel?this._openOrderPanel():this.getDisplayMode()===F.OrderEditorDisplayMode.Popup?this._showOrderDialog():this._showOrderDrawer(void 0,!0)}catch{return}e?.aborted||(this._updateMainOrder(t),await this._setErrorsState(t.errors()))}async _handleEditPositionContextChange(e,t){if(this._positionViewModel&&this._positionViewModel.setLoading(t.status()===Ht.PlaceOrEditContextStatus.Loading),t.source()===ni)return void await this._setErrorsState(t.errors());if(!1===this._dialogVisibility.getValue().isVisible&&this.getDisplayMode()===F.OrderEditorDisplayMode.ResizableDrawer){const e=t.data(),i=(0,Zt.getBracketsFromOrderOrPosition)(e);return void this.showPositionView(e,i,void 0,!0,e.hasTrailingStopBracket)}if(!this._orderViewModel&&!this._positionViewModel)return;const i=t.data();if(this._positionViewModel&&this._positionViewModel.position.id===i.id){const e=this._positionViewModel;if(await e.onReady,e!==this._positionViewModel)return}else try{await this._createAndShowPositionViewModel({position:i,brackets:(0,Zt.getBracketsFromOrderOrPosition)(i),viewType:(0,Ht.isContextEditIndividualPositionContext)(t)?Ft.IndividualPosition:Ft.Position,hasTrailingStopBracket:i.hasTrailingStopBracket,forceCollapsedPositionDrawer:!0})}catch{return}e?.aborted||(this._updatePositionValues(t),await this._setErrorsState(t.errors()))}_updatePositionValues(e){const t=e.data();if(!this._positionViewModel||this._positionViewModel.position.id!==t.id)return;const i=(0,Zt.getBracketsFromOrderOrPosition)(t),{guaranteedStop:s,stopLoss:r,takeProfit:o,trailingStopPrice:n}=i;let a;void 0!==this._positionViewModel.takeProfitModel&&this._updateTakeProfitValues(this._positionViewModel.takeProfitModel,o),void 0!==s?a=Yt.StopType.GuaranteedStop:void 0!==n?a=Yt.StopType.TrailingStop:void 0!==r&&(a=Yt.StopType.StopLoss),this._updateStopLossValues({stopLossModel:this._positionViewModel.stopLossModel,stopLoss:r,trailingStopPrice:n,guaranteedStop:s,stopType:a})}_updateMainOrder(e){const t=e.data()
;if(!this._orderViewModel||this._orderViewModel.existingPlacedOrder?.id!==t.id)return;const i=Object.assign(this._createOrderStub(),this._orderStub);if(this._orderViewModel.quantityModel.quantity.setValue(t.qty),1===this._orderViewModel.getOrderType()&&this._orderViewModel.limitPriceModel&&1===t.type&&void 0!==t.limitPrice&&(this._orderViewModel.limitPriceModel.setPriceValues({price:t.limitPrice}),i.limitPrice=t.limitPrice),3===this._orderViewModel.getOrderType()&&this._orderViewModel.stopPriceModel&&3===t.type&&void 0!==t.stopPrice&&(this._orderViewModel.stopPriceModel.setPriceValue(t.stopPrice),i.stopPrice=t.stopPrice),4===this._orderViewModel.getOrderType()&&this._orderViewModel.stopPriceModel&&this._orderViewModel.limitPriceModel&&4===t.type&&void 0!==t.stopPrice&&void 0!==t.limitPrice&&(this._orderViewModel.stopPriceModel.setPriceValue(t.stopPrice),this._orderViewModel.limitPriceModel.setPriceValue(t.limitPrice),i.stopPrice=t.stopPrice=t.stopPrice,i.stopPrice=t.limitPrice=t.limitPrice),void 0!==this._orderViewModel.takeProfitModel&&this._updateTakeProfitValues(this._orderViewModel.takeProfitModel,t.takeProfit),i.takeProfit=t.takeProfit,this._orderViewModel.stopLossModel){let e;void 0!==t.guaranteedStop?e=Yt.StopType.GuaranteedStop:void 0!==t.trailingStopPips?e=Yt.StopType.TrailingStop:void 0!==t.stopLoss&&(e=Yt.StopType.StopLoss),this._updateStopLossValues({stopLossModel:this._orderViewModel.stopLossModel,stopLoss:t.stopLoss,trailingStopPrice:t.trailingStopPrice,guaranteedStop:t.guaranteedStop,stopType:e}),i.guaranteedStop=t.guaranteedStop,i.trailingStopPips=t.trailingStopPips,i.stopLoss=t.stopLoss}this._orderStub=i}_getBracketsFromOrderViewModel(){const e={stopLoss:void 0,guaranteedStop:void 0,trailingStopPips:void 0,trailingStopPrice:void 0,takeProfit:void 0};if(!this._orderViewModel)return e;const t=Boolean(this._orderViewModel.stopLossModel?.getEnabled()),i=this._orderViewModel.stopLossModel?.getBracketType(),s=this._orderViewModel.stopLossModel?.price.getValue(),r=this._orderViewModel.stopLossModel?.getPips();t&&i===R.BracketType.GuaranteedStop&&null!==s&&(e.guaranteedStop=s),t&&i===R.BracketType.TrailingStop&&null!==r&&null!==s&&(e.trailingStopPips=r,e.trailingStopPrice=s),!t||null===s||i!==R.BracketType.StopLoss&&void 0!==i||(e.stopLoss=s);const o=this._orderViewModel.takeProfitModel?.getEnabled(),n=this._orderViewModel.takeProfitModel?.price.getValue();return o&&null!==n&&(e.takeProfit=n),e}_getPricesFromOrderViewModel(){const e={price:void 0,limitPrice:void 0,stopPrice:void 0};if(!this._orderViewModel)return e;const t=this._orderViewModel.getOrderType(),i=this._orderViewModel.limitPriceModel.getPrice()??void 0,s=this._orderViewModel.stopPriceModel.getPrice()??void 0;switch(t){case 4:e.limitPrice=i,e.stopPrice=s,e.price=s;break;case 3:e.stopPrice=s,e.price=s;break;case 1:e.limitPrice=i,e.price=i}return e}}},739695:(e,t,i)=>{"use strict";var s,r;function o(e){return e?.type===r.PlaceOrder}function n(e){return e?.type===r.EditOrder}function a(e){return e?.type===r.EditPosition}function l(e){
return e?.type===r.EditIndividualPosition}i.d(t,{PlaceOrEditContextStatus:()=>s,PlaceOrEditContextType:()=>r,isContextEditIndividualPositionContext:()=>l,isContextEditOrderContext:()=>n,isContextEditPositionContext:()=>a,isContextPlaceOrderContext:()=>o}),function(e){e[e.Undefined=0]="Undefined",e[e.Loading=1]="Loading",e[e.Error=2]="Error",e[e.Destroyed=3]="Destroyed",e[e.Sent=4]="Sent"}(s||(s={})),function(e){e[e.PlaceOrder=0]="PlaceOrder",e[e.EditOrder=1]="EditOrder",e[e.EditPosition=2]="EditPosition",e[e.EditIndividualPosition=3]="EditIndividualPosition"}(r||(r={}))},34598:(e,t,i)=>{"use strict";i.d(t,{getSymbolMinTick:()=>u,getSymbolType:()=>d,getSymbolTypespecs:()=>l,isFractional:()=>c});var s=i(960521),r=i.n(s),o=i(333250);function n(e){const{fields:t,symbol:i,options:s}=e;return(0,o.getQuoteSessionInstance)("simple").snapshot(i)}function a(e){return"error"===e.status}async function l(e,t){const i=await n({symbol:e,fields:["typespecs"],options:t});return"values"in i?a(i)||void 0===i.values.typespecs?[]:i.values.typespecs:i.typespecs??[]}async function d(e,t){const i=await n({symbol:e,fields:["type"],options:t});return"values"in i?a(i)?"undefined":i.values.type:i.type??"undefined"}async function u(e,t){const i=await n({symbol:e,fields:["minmov","pricescale"],options:t});return"values"in i?a(i)||void 0===i.values.minmov||void 0===i.values.pricescale?1:r()(i.values.minmov).div(i.values.pricescale).toNumber():r()(i.minmov).div(i.pricescale).toNumber()}async function c(e,t){const i=await n({symbol:e,fields:["fractional"],options:t});return"values"in i?!a(i)&&void 0!==i.values.fractional&&i.values.fractional:i.fractional??!1}},653788:(e,t,i)=>{"use strict";function s(e){return e.properties().childs().paneProperties.childs().legendProperties.childs().showTradingButtons}i.d(t,{getBuySellButtonsVisibility:()=>s})},383326:(e,t,i)=>{"use strict";i.d(t,{setBuySellButtonsVisibility:()=>a,undoShowBuySellButtonsVisibility:()=>n});var s=i(609838),r=i(754617),o=i(653788);const n=new r.TranslatedString("change buy/sell buttons visibility",s.t(null,void 0,i(605598)));function a(e,t){e.setProperty((0,o.getBuySellButtonsVisibility)(e.model()),t,n)}},794671:(e,t,i)=>{"use strict";i.d(t,{projectBracketPrefix:()=>s,projectionStopPartStopLimitId:()=>r});const s="ProjectionBracket",r="projectionStopPartStopLimit"},764146:(e,t,i)=>{"use strict";var s;function r(e){return"onReverse"in e}function o(e){return function(e){return"isMovingEnabled"in e&&"onMove"in e&&"onFinishMove"in e}(e)&&"bracketType"in e&&"isWorking"in e}function n(e){return"Position"===e.dataType}function a(e){return"PreOrder"===e.dataType}function l(e){return"Order"===e.dataType}i.d(t,{isOrderItemRawData:()=>l,isOrderLikeItem:()=>o,isPositionItemRawData:()=>n,isPositionLikeItem:()=>r,isPreOrderItemRawData:()=>a}),function(e){e.PreOrder="PreOrder",e.Order="Order",e.Position="Position"}(s||(s={}))},687039:(e,t,i)=>{"use strict";i.d(t,{OrdersService:()=>m,applyBracketPatch:()=>g,cropOrderData:()=>b,getOrderPriceByType:()=>y,isBracketOrderRawData:()=>h,
isUnlinkedBracketOrderRawData:()=>p,makeBracketPatch:()=>_});var s=i(650151),r=i(627692),o=i(144421),n=i(671945),a=i(891495),l=i(995379),d=i(760775),u=i(668019);const c=(0,n.getLogger)("Trading.OrderService");function h(e){return"parentId"in e&&void 0!==e.parentId&&"parentType"in e&&void 0!==e.parentType}function p(e){return!h(e)&&"originalParentId"in e&&void 0!==e.originalParentId}function _(e){const{parentId:t,parentType:i,stopType:s}=e;return t?{parentId:t,parentType:i,stopType:s}:{parentId:void 0,parentType:void 0,stopType:void 0}}function g(e,t){const{parentId:i,parentType:s,stopType:r}=t;return void 0!==i?e.parentId=i:delete e.parentId,void 0!==s?e.parentType=s:delete e.parentType,void 0!==r?e.stopType=r:delete e.stopType,e}function y(e){let t;return 1===e.type&&(t=e.limitPrice),3!==e.type&&4!==e.type||(t=e.stopPrice),t??NaN}function b(e){return{id:e.id,parentId:e.parentId,parentType:e.parentType,symbol:e.symbol,type:e.type,side:e.side,avgPrice:e.avgPrice,limitPrice:e.limitPrice,stopPrice:e.stopPrice,price:e.price,stopLoss:e.stopLoss,trailingStopPips:e.trailingStopPips,stopType:e.stopType,takeProfit:e.takeProfit,status:e.status,qty:e.qty}}class m extends l.BrokerService{constructor(e,t){super(e,"OrdersService"),this._existingOrdersIds=new Set,this._activeOrders=new Map,this._activeOrderUpdate=new r.Delegate,this._activeOrdersRemoved=new r.Delegate,this._ordersRejected=new r.Delegate,this._positions=new Map,this._addActiveOrder=async e=>{this._logOrderUpdate(e);const t=e.id,i=this._activeOrders.has(t),s=5===e.status,r=6!==e.status&&3!==e.status,n=2===e.type;if(i){if(r||n)return this._activeOrders.delete(t),void this._activeOrdersRemoved.fire([t])}else{if(n||r&&!s)return;if(s)return void this._ordersRejected.fire(y(e))}const a=await this._getOrderData(e);(0,o.isNumber)(a.price)&&(this._activeOrders.set(t,a),this._activeOrderUpdate.fire(a))},this._addActiveOrder=(0,a.sequentialize)(this._addActiveOrder.bind(this)),[this._handlePositionsRemove,this._handlePositionUpdate,this._handleOrderUpdate]=(0,a.sequentializeAll)(this._handlePositionsRemove.bind(this),this._handlePositionUpdate.bind(this),this._handleOrderUpdate.bind(this)),this._positionsService=t}async getCurrency(){const e=(0,s.ensureNotNull)(this.activeBroker()),t=await e.accountMetainfo();return(0,d.getCurrency)(t,!0)||"USD"}orders(){return(0,s.ensureNotNull)(this.activeBroker()).orders()}find(e){return this._activeOrders.get(e)||null}activeOrders(){return Array.from(this._activeOrders.values())}activeOrdersUpdated(){return this._activeOrderUpdate}activeOrdersRemoved(){return this._activeOrdersRemoved}orderRejected(){return this._ordersRejected}stopService(){this._clearOrders();(0,s.ensureNotNull)(this.activeBroker()).orderUpdate.unsubscribeAll(this),this._positionsService.positionUpdate().unsubscribeAll(this),this._positionsService.positionsRemoved().unsubscribeAll(this)}startService(){this._clearOrders(),this._requestOrders()}_clearOrders(){const e=Array.from(this._activeOrders.keys());this._activeOrders.clear(),this._existingOrdersIds.clear(),
this._positions.clear(),e.length>0&&c.logNormal(`All orders removed, id's: ${e}`),this._activeOrdersRemoved.fire(e)}async _requestOrders(){const e=this.activeBroker();if(!e)return;const t=await e.orders();for(const e of this._positionsService.positions())this._positions.set(e.id,e);for(const e of t)this._handleOrderUpdate(e);e.orderUpdate.unsubscribeAll(this),this._positionsService.positionUpdate().unsubscribeAll(this),this._positionsService.positionsRemoved().unsubscribeAll(this),e.orderUpdate.subscribe(this,this._handleOrderUpdate),this._positionsService.positionUpdate().subscribe(this,this._handlePositionUpdate),this._positionsService.positionsRemoved().subscribe(this,this._handlePositionsRemove)}async _handleOrderUpdate(e){if(await this._addActiveOrder(e),void 0!==e.parentId)return;this.activeOrders().filter((({originalParentId:t,parentId:i})=>t===e.id||i===e.id)).forEach(this._addActiveOrder)}async _handlePositionsRemove(e){for(const t of e){this._positions.delete(t);this.activeOrders().filter((e=>e.originalParentId===t||e.parentId===t)).forEach(this._addActiveOrder)}}async _handlePositionUpdate(e){const t=this._positions.get(e.data.id)?.qty;if(this._positions.set(e.data.id,e.data),t===e.data.qty)return;this.activeOrders().filter((t=>t.originalParentId===e.data.id||t.parentId===e.data.id)).forEach(this._addActiveOrder)}_logOrderUpdate(e){const t=e.id;let i="update";this._existingOrdersIds.has(t)||(i="add",this._existingOrdersIds.add(t)),function(e,t){t(JSON.stringify(b(e)))}(e,(e=>{c.logNormal(`Order ${i}: ${e}`)}))}async _getParent(e){const t=e.parentId??e.originalParentId,i=e.parentType??e.originalParentType;if(t){if(2===i||3===i){const e=await this._positionsService.realIdFromBroker(t);return e?this._positions.get(e):void 0}if(1===i){const e=this.find(t)??void 0;return void 0!==e?.originalParentId||void 0!==e?.parentId?void 0:e}}}async _getOrderData(e){const t=y(e);(0,o.isNumber)(t)||c.logError(`order ${e.id} price is not defined`);const i=(0,s.ensureNotNull)(this.activeBroker()).metainfo().configFlags,r=await this._getParent(e),n=_({parentId:r&&Math.abs(r.qty)===Math.abs(e.qty)&&r.side!==e.side?r.id:void 0,parentType:e.parentType??e.originalParentType,stopType:e.stopType??e.originalStopType}),a={originalParentId:e.parentId??e.originalParentId,originalParentType:e.parentType??e.originalParentType,originalStopType:e.stopType??e.originalStopType},l={...e,parentId:a.originalParentId,parentType:a.originalParentType,stopType:a.originalStopType},h=(0,d.isModifyOrderSupported)(l,i),p=(0,d.isMoveOrderSupported)(l,i);return g((0,o.merge)((0,o.clone)(e),{price:t,...a,considerFilledQty:!0,supportModify:h,supportMove:p,supportCancel:!0,supportModifyOrderPrice:Boolean(i.supportModifyOrderPrice),supportTrailingStop:(0,u.checkTrailingStopAvailability)(i),supportGuaranteedStop:(0,u.checkGuaranteedStopAvailability)(i),supportStopLoss:(0,u.checkStopLossAvailability)(i),supportOnlyPairBrackets:Boolean(i.supportOnlyPairOrderBrackets)}),n)}}},959026:(e,t,i)=>{"use strict";i.d(t,{PositionsService:()=>g,PositionsUpdateType:()=>c,
cropPositionData:()=>_});var s=i(650151),r=i(627692),o=i(144421),n=i(671945),a=i(995379),l=i(668019);const d=(0,n.getLogger)("Trading.PositionService");var u,c;!function(e){e[e.IndividualPosition=0]="IndividualPosition",e[e.Position=1]="Position"}(u||(u={})),function(e){e[e.Full=0]="Full",e[e.Partial=1]="Partial"}(c||(c={}));const h=["qty","takeProfit","stopLoss","trailingStopPips","trailingStopPrice","guaranteedStop"],p=["qty","avgPrice","takeProfit","stopLoss","trailingStopPips","trailingStopPrice","guaranteedStop"];function _(e){const t=e;return{id:t.id,symbol:t.symbol,side:t.side,avgPrice:t.avgPrice,pl:t.pl,price:t.price,qtyBySide:t.qtyBySide,stopType:t.stopType,takeProfit:t.takeProfit,stopLoss:t.stopLoss,trailingStopPips:t.trailingStopPips}}class g extends a.BrokerService{constructor(e){super(e,"PositionsService"),this._existingPositionIds=new Set,this._positions=new Map,this._positionUpdate=new r.Delegate,this._positionsRemoved=new r.Delegate,this._displayMode=1,this._updatePositionPLHandler=this._updatePositionPL.bind(this)}positions(){return Array.from(this._positions.values())}find(e){return this._positions.get(e)||null}async realIdFromBroker(e){const t=(0,s.ensureNotNull)(this.activeBroker());if(1===this._displayMode){const i=await t.positionById(e);if(void 0!==i)return i.id}else{const i=await t.individualPositionById(e);if(void 0!==i)return i.id}return null}positionUpdate(){return this._positionUpdate}positionsRemoved(){return this._positionsRemoved}isDisplayModeIndividualPositions(){return 0===this._displayMode}async getCurrency(e){return await(0,s.ensureNotNull)(this.activeBroker()).getPositionCurrency(e)||""}supportBrackets(e){return Boolean(this.isDisplayModeIndividualPositions()?e.supportIndividualPositionBrackets:e.supportPositionBrackets)}supportReverse(e){return Boolean(!this.isDisplayModeIndividualPositions()&&e.supportReversePosition)}stopService(){this._clearPositions();const e=(0,s.ensureNotNull)(this.activeBroker());this.isDisplayModeIndividualPositions()?(e.individualPositionUpdate.unsubscribeAll(this),e.individualPositionPartialUpdate.unsubscribeAll(this)):(e.positionUpdate.unsubscribeAll(this),e.positionPartialUpdate.unsubscribeAll(this))}startService(){this._clearPositions(),this._displayMode=function(e){if(null===e)return 1;const t=e.metainfo().configFlags;return t.supportPositionNetting?t.supportPositionBrackets?1:t.supportCloseIndividualPosition?0:1:1}(this.activeBroker()),this._requestPositions()}_clearPositions(){const e=(0,s.ensureNotNull)(this.activeBroker()),t=Array.from(this._positions.keys());for(const i of t)this.isDisplayModeIndividualPositions()?e.unsubscribeIndividualPositionPL(i,this._updatePositionPLHandler):e.unsubscribePL(i,this._updatePositionPLHandler);this._positions.clear(),this._existingPositionIds.clear(),t.length>0&&d.logNormal(`All positions removed, id's: ${t}`),this._positionsRemoved.fire(t)}async _requestPositions(){const e=this.activeBroker();if(!e)return;const t=this.isDisplayModeIndividualPositions(),i=await(t?e.individualPositions():e.positions())
;for(const e of i)this._addPosition(e);t?(e.individualPositionUpdate.subscribe(this,this._addPosition),e.individualPositionPartialUpdate.subscribe(this,((e,t)=>this._handlePartialUpdate(e,t,h)))):(e.positionUpdate.subscribe(this,this._addPosition),e.positionPartialUpdate.subscribe(this,((e,t)=>this._handlePartialUpdate(e,t,p))))}_handlePartialUpdate(e,t,i){Object.keys(t).some((e=>i.includes(e)))&&this._addPosition(e)}_addPosition(e){const t=e.id,i=this._positions.has(t),r=(0,s.ensureNotNull)(this.activeBroker()),o=this.isDisplayModeIndividualPositions();if(!e.qty)return i&&(o?r.unsubscribeIndividualPositionPL(t,this._updatePositionPLHandler):r.unsubscribePL(t,this._updatePositionPLHandler),this._positions.delete(t),this._positionsRemoved.fire([t])),void this._logPositionUpdate(e,!0);const n=this._getPositionData(e),a=this._updateType(n);this._logPositionUpdate(n,a===c.Full),this._positions.set(t,n),this._firePositionUpdate(n,a),i||(o?r.subscribeIndividualPositionPL(t,this._updatePositionPLHandler):r.subscribePL(t,this._updatePositionPLHandler))}_updatePositionPL(e,t){const i=(0,s.ensureDefined)(this._positions.get(e));i.pl=(0,o.isNumber)(t)?t:null,this._firePositionUpdate(i,c.Partial)}_getPositionData(e){const t=(0,s.ensureNotNull)(this.activeBroker()).metainfo().configFlags,i=this._positions.get(e.id),r=this.isDisplayModeIndividualPositions(),o=Boolean(r?t.supportIndividualPositionBrackets:t.supportPositionBrackets);let n,a=!1,d=null;if(r){const t=e;n=t.price,a=Boolean(t.canBeClosed)}else{const t=e;n=t.avgPrice,d=t.pl??i?.pl??null}return{...e,pl:d,plBasedOnLast:t.calculatePLUsingLast||!1,price:Math.abs((0,s.ensureDefined)(n)),qtyBySide:Math.abs(e.qty)*(1===e.side?1:-1),supportClose:Boolean(r?t.supportCloseIndividualPosition&&a:t.supportClosePosition),supportReverse:Boolean(!r&&t.supportReversePosition),supportBrackets:o,supportOnlyPairBrackets:Boolean(t.supportOnlyPairPositionBrackets),supportStopLoss:(0,l.checkStopLossAvailability)(t),supportTrailingStop:(0,l.checkTrailingStopAvailability)(t),supportGuaranteedStop:(0,l.checkGuaranteedStopAvailability)(t)}}_firePositionUpdate(e,t){this._positionUpdate.fire({data:e,type:t})}_updateType(e){const t=this._positions.get(e.id);if(void 0===t)return c.Full;for(const i of Object.keys(t)){const s=i;if("pl"!==s&&"unrealizedPl"!==s&&t[s]!==e[s])return c.Full}return c.Partial}_logPositionUpdate(e,t){if(!t)return;const i=e.id;let s="update";this._existingPositionIds.has(i)||(s="add",this._existingPositionIds.add(i)),function(e,t){t(JSON.stringify(_(e)))}(e,(e=>{d.logNormal(`Position  ${s}: ${e}`)}))}}},668019:(e,t,i)=>{"use strict";function s(e){return Boolean(e.supportStopLoss&&e.supportAddBracketsToExistingOrder)}function r(e){return Boolean(e.supportTrailingStop&&e.supportAddBracketsToExistingOrder)}function o(e){return Boolean(e.supportGuaranteedStop&&e.supportAddBracketsToExistingOrder)}var n;function a(e,t,i=!0){switch(function(e,t=!0){const i=e??0,s=t?Math.round(100*i)/100:i;return s>0?"positive":s<0?"negative":"neutral"}(t,i)){case"negative":return e.negativePlColor
;case"positive":return e.positivePlColor;default:return e.text.textColor}}i.d(t,{checkGuaranteedStopAvailability:()=>o,checkStopLossAvailability:()=>s,checkTrailingStopAvailability:()=>r,profitLossTextColor:()=>a}),function(e){e.Positive="positive",e.Negative="negative",e.Neutral="neutral"}(n||(n={}))},465688:(e,t,i)=>{"use strict";i.d(t,{alignOrderRawDataPrices:()=>V,bracketsByType:()=>v,buildOrderBracketData:()=>P,buildProjectionBracketData:()=>f,createBracketsFromBracketOrderAndParent:()=>k,getBracketKeyFromBracketOrderRawData:()=>C,getBracketType:()=>b,getBracketTypeToText:()=>m,getBracketsFromBracketOrdersRawData:()=>T,getBracketsFromOrderOrPosition:()=>w,getBracketsFromPreBracketsDataByParentId:()=>M,getBracketsPricesFromBracketOrders:()=>E,isBracketAbsentInParentOrderOrPosition:()=>$,isBracketOrderOfPosition:()=>B,isParentItemSupportBracketModification:()=>S,isPreBracketOrder:()=>I,isProjectionStopPartStopLimit:()=>O});var s=i(609838),r=i(760775),o=i(894862),n=i(721762),a=i(764146),l=i(794671);const d=s.t(null,void 0,i(992201)),u=s.t(null,void 0,i(719702)),c=s.t(null,void 0,i(337539)),h=s.t(null,void 0,i(255739)),p=s.t(null,{context:"Trailing stop"},i(335363)),_=s.t(null,{context:"Stop loss"},i(867008)),g=s.t(null,{context:"Guaranteed stop"},i(389026)),y=s.t(null,{context:"Take profit"},i(607660));function b(e){return 3===e.type?void 0!==e.stopType?(0,r.getBracketTypeByStopType)(e.stopType):o.BracketType.StopLoss:1===e.type?o.BracketType.TakeProfit:null}function m(e,t,i){return 3===e?function(e,t){return e===n.StopType.TrailingStop?t?p:d:e===n.StopType.GuaranteedStop?t?g:c:t?_:u}(t,i):1===e?i?y:h:null}function v(e){let t,i,s,r;return e.forEach((e=>{switch((0,a.isOrderLikeItem)(e)?e.bracketType():b(e)){case o.BracketType.TakeProfit:t=e;break;case o.BracketType.TrailingStop:r=e;break;case o.BracketType.StopLoss:i=e;break;case o.BracketType.GuaranteedStop:s=e}})),{takeProfit:t,trailingStop:r,stopLoss:i,guaranteedStop:s}}function f(e,t,i){const s=(0,r.getStopTypeByBracketType)(t),n=t===o.BracketType.TakeProfit?1:3,a=-1===i.side?1:-1;let l;switch(t){case o.BracketType.TakeProfit:l=`${e}TakeProfit`;break;case o.BracketType.StopLoss:l=`${e}StopLoss`;break;case o.BracketType.GuaranteedStop:l=`${e}GuaranteedStop`;break;case o.BracketType.TrailingStop:l=`${e}TrailingStop`}return{dataType:"Order",id:l,price:null,type:n,stopType:s,side:a,bracketType:t,qty:i.qty,status:6,symbol:i.symbol,plBasedOnLast:"plBasedOnLast"in i&&i.plBasedOnLast,considerFilledQty:!1,supportModify:!1,supportModifyOrderPrice:!1,supportMove:!0,supportCancel:!1,supportStopLoss:!1,supportTrailingStop:!1,supportGuaranteedStop:!1,supportOnlyPairBrackets:i.supportOnlyPairBrackets,callbacks:{},trailingStopPips:i.trailingStopPips}}function P(e){const{idPrefix:t,parentData:i,bracketType:s,isDisplayModeIndividualPositions:n,configFlags:a,hadTrailingStopInitially:l}=e,d=(0,r.getStopTypeByBracketType)(s),u=s===o.BracketType.TakeProfit?1:3,c=-1===i.side?1:-1,h=i.id;let p,_,g,y=null;const b="type"in i?1:n?3:2;switch(s){case o.BracketType.TakeProfit:
if(p=`${t}TakeProfit`,void 0===i.takeProfit)return null;y=i.takeProfit,g=i.takeProfit;break;case o.BracketType.StopLoss:if(p=`${t}StopLoss`,void 0===i.stopLoss)return null;y=i.stopLoss,_=i.stopLoss;break;case o.BracketType.GuaranteedStop:if(p=`${t}GuaranteedStop`,void 0===i.guaranteedStop)return null;y=i.guaranteedStop,_=i.guaranteedStop;break;case o.BracketType.TrailingStop:if(void 0===i.trailingStopPips)return null;_=i.trailingStopPrice,y=i.trailingStopPrice??null,p=`${t}TrailingStop`}const m={id:p,side:c,price:y,parentId:h,stopType:d,stopPrice:_,parentType:b,limitPrice:g,type:u,isDelayed:!1,qty:i.qty,supportCancel:!0,supportStopLoss:!1,considerFilledQty:!0,symbol:i.symbol,supportTrailingStop:!1,supportGuaranteedStop:!1,status:3,supportModifyOrderPrice:!1,trailingStopPips:i.trailingStopPips,supportOnlyPairBrackets:i.supportOnlyPairBrackets,duration:"duration"in i?i.duration:void 0,plBasedOnLast:"plBasedOnLast"in i&&i.plBasedOnLast,guaranteedStop:s===o.BracketType.GuaranteedStop?i.guaranteedStop:void 0,trailingStopPrice:s===o.BracketType.TrailingStop?i.trailingStopPrice:void 0},v={...a,supportModifyTrailingStop:!l||a.supportModifyTrailingStop},f=(0,r.isModifyOrderSupported)(m,v),P=(0,r.isMoveOrderSupported)(m,v);return{...m,supportMove:P,supportModify:f}}function S(e,t){const i=e.mainItem();return void 0===i?t.supportModifyBrackets():!1===e.isPlaced()||((0,a.isPositionLikeItem)(i)?t.supportModifyPositionBrackets():t.supportModifyOrderBrackets())}function k(e,t){const{stopLoss:i,takeProfit:s,guaranteedStop:r,trailingStopPips:o,trailingStopPrice:a}=t,l={stopLoss:i,takeProfit:s,guaranteedStop:r,trailingStopPips:o,trailingStopPrice:a},d=e.price??void 0;if(1===e.type)l.takeProfit=d;else switch(l.stopLoss=void 0,l.guaranteedStop=void 0,l.trailingStopPips=void 0,l.trailingStopPrice=void 0,e.stopType){case n.StopType.GuaranteedStop:l.guaranteedStop=d;break;case n.StopType.StopLoss:l.stopLoss=d;break;case n.StopType.TrailingStop:l.trailingStopPips=e.trailingStopPips,l.trailingStopPrice=e.trailingStopPrice;break;default:l.stopLoss=d}return l}function C(e){if(1===e.type)return"takeProfit";switch(e.stopType){case n.StopType.StopLoss:return"stopLoss";case n.StopType.GuaranteedStop:return"guaranteedStop";case n.StopType.TrailingStop:return"trailingStopPips";default:return"stopLoss"}}function T(e){return e.reduce(((e,t)=>{switch(C(t)){case"guaranteedStop":e.guaranteedStop=t.stopPrice;break;case"trailingStopPips":e.trailingStopPips=t.trailingStopPips,e.trailingStopPrice=t.trailingStopPrice;break;case"stopLoss":e.stopLoss=t.stopPrice;break;case"takeProfit":e.takeProfit=t.limitPrice}return e}),{stopLoss:void 0,takeProfit:void 0,guaranteedStop:void 0,trailingStopPips:void 0,trailingStopPrice:void 0})}function w(e){return{stopLoss:e.stopLoss,takeProfit:e.takeProfit,guaranteedStop:e.guaranteedStop,trailingStopPips:e.trailingStopPips,trailingStopPrice:e.trailingStopPrice}}function B(e){return[2,3].includes(e.parentType)}function O(e){return e.id===l.projectionStopPartStopLimitId}function M(e,t){
return t.reduce(((t,i)=>(i.parentId!==e||(3!==i.type||void 0!==i.stopType&&i.stopType!==n.StopType.StopLoss?3===i.type&&i.stopType===n.StopType.TrailingStop?(t.trailingStopPips=i.trailingStopPips,t.trailingStopPrice=i.trailingStopPrice):3===i.type&&i.stopType===n.StopType.GuaranteedStop?t.guaranteedStop=i.guaranteedStop:1===i.type&&(t.takeProfit=i.limitPrice):t.stopLoss=i.stopPrice),t)),{})}function E(e){return e.reduce(((e,t)=>{const i=t.stopType;return t.limitPrice?e.takeProfit=t.limitPrice:[n.StopType.StopLoss,void 0].includes(i)&&void 0!==t.stopPrice?e.stopLoss=t.stopPrice:i===n.StopType.GuaranteedStop?e.guaranteedStop=t.stopPrice:i===n.StopType.TrailingStop&&(e.trailingStopPips=t.trailingStopPips,e.trailingStopPrice=t.trailingStopPrice),e}),{stopLoss:void 0,takeProfit:void 0,guaranteedStop:void 0,trailingStopPips:void 0,trailingStopPrice:void 0})}function I(e){return Boolean(e?.includes(l.projectBracketPrefix))}function V(e){const t={...e};return 1===t.type&&(t.limitPrice=t.price??t.limitPrice,delete t.stopPrice),4===t.type&&(t.price=t.stopPrice??t.price),t}function $(e,t){if(e.parentId!==t.id)return!1;if(3===e.type){if((void 0===e.stopType||e.stopType===n.StopType.StopLoss)&&void 0===t.stopLoss)return!0;if(e.stopType===n.StopType.TrailingStop&&void 0===t.trailingStopPips)return!0;if(e.stopType===n.StopType.GuaranteedStop&&void 0===t.guaranteedStop)return!0}return 1===e.type&&void 0===t.takeProfit}},906734:(e,t,i)=>{"use strict";i.r(t),i.d(t,{TradingNotificationsHandler:()=>v});var s=i(290484),r=i(650151),o=i(909702),n=i(995379),a=i(534934),l=i(372097),d=i(454307),u=i(166554),c=i(760775);const h=["qty","stopPrice","limitPrice","status","filledQty","stopType"];function p(e,t,i){if(void 0===e||void 0===t)return!1;const s=i.indexOf(".");if(-1!==s){const r=i.substring(0,s);return p(e[r],t[r],i.substring(s+1))}return e[i]===t[i]}function _(e){return 6===e||3===e}function g(e){if(2===e.status)return 2===e.type?e.avgPrice:1===e.type?e.limitPrice:e.stopPrice}function y(e){return 2===e.type?e.avgPrice:e.avgPrice||e.limitPrice||e.stopPrice}function b(e){if(4===e.type)return e.stopPrice}function m(e){const t=e.brokerSymbol||e.symbol;return(0,c.getSymbolNameOverFullname)(t)}class v extends n.BrokerService{constructor(e){super(e,"TradingNotificationsHandler"),this._orders=[],this._playSound=(0,s.default)(this._playSoundImpl,50),o.enableAlertSoundsForMobile()}startService(){const e=(0,r.ensure)(this.activeBroker());e.orders().then((e=>this._orders=(0,l.deepCopy)(e))),e.orderUpdate.subscribe(this,this._orderUpdate),this._shouldHidePriceInOrderExecutedNotifications=e.metainfo().configFlags.showAvgFillPriceColumnAsLastFillPrice}stopService(){(0,r.ensure)(this.activeBroker()).orderUpdate.unsubscribe(this,this._orderUpdate)}_showOrderStatusToast(e){a.enabled("trading_notifications")&&this.trading().showOrderToast(e)}_priceFormatter(e){return(0,r.ensureNotNull)(this.activeBroker()).formatter(e,!0)}_checkOrderModified(e,t){const i=this.activeBroker(),s=i&&i.metainfo().customNotificationFields||[],r=h.concat(s);let o=!1
;return r.forEach((i=>{o||p(e,t,i)||(o=!0)})),o}_generateNotificationsData(e,t){const i=[],s=this.trading().orderExecutedSoundParams,r=e.message?.text?(0,d.capitalizeFirstLetter)(e.message.text):void 0,o={orderId:e.id,side:e.side,quantity:Math.abs(e.qty),primaryPrice:y(e),secondaryPrice:b(e),symbol:e.symbol,displaySymbol:m(e),orderType:e.type,parentId:e.parentId,stopType:e.stopType,content:r};return t?(this._checkOrderModified(e,t)&&(1===e.status?i.push({toastData:{...o,toastType:1}}):5===e.status?i.push({toastData:{...o,toastType:2,content:e.message?.text||void 0}}):2===e.status?i.push({toastData:{...o,primaryPrice:this._shouldHidePriceInOrderExecutedNotifications?void 0:o.primaryPrice,secondaryPrice:this._shouldHidePriceInOrderExecutedNotifications?void 0:o.secondaryPrice,toastType:5},soundPath:s.enabled.value()?s.path.value():void 0,volume:s.enabled.value()?s.volume:void 0}):t.filledQty!==e.filledQty?i.push({toastData:{...o,quantity:void 0!==e.filledQty&&e.filledQty>0?e.filledQty:o.quantity,primaryPrice:this._shouldHidePriceInOrderExecutedNotifications?void 0:o.primaryPrice,secondaryPrice:this._shouldHidePriceInOrderExecutedNotifications?void 0:o.secondaryPrice,toastType:3},soundPath:s.enabled.value()?s.path.value():void 0,volume:s.enabled.value()?s.volume:void 0}):_(e.status)&&i.push({toastData:{...o,toastType:4}})),Object.assign(t,e)):_(e.status)?(this._orders.push(e),i.push({toastData:{...o,toastType:0}}),this.trading().trackEvent("","Order placed symbol",e.symbol)):1===e.status?(this._orders.push(e),i.push({toastData:{...o,toastType:1}})):5===e.status?(this._orders.push(e),i.push({toastData:{...o,toastType:2,content:e.message?.text||void 0}})):2===e.status&&(this._orders.push(e),i.push({toastData:{...o,primaryPrice:2!==e.type?g(e):void 0,toastType:0}},{toastData:{...o,primaryPrice:this._shouldHidePriceInOrderExecutedNotifications?void 0:o.primaryPrice,secondaryPrice:this._shouldHidePriceInOrderExecutedNotifications?void 0:o.secondaryPrice,toastType:5},soundPath:s.enabled.value()?s.path.value():void 0,volume:s.enabled.value()?s.volume:void 0}),this.trading().trackEvent("","Order placed symbol",e.symbol)),i}async _orderUpdate(e,t){const i=(0,l.deepCopy)(e),s=this._orders.find((e=>e.id===i.id));if(t)return void(void 0===s&&this._orders.push(i));if(s&&(0,u.isFinalOrderStatus)(s.status))return;const r=this._generateNotificationsData(i,s);if(0===r.length)return;const o=await this._priceFormatter(i.symbol);for(const{toastData:e,soundPath:t,volume:i}of r)void 0!==t&&this._playSound(t,i),this._showOrderStatusToast({...e,priceFormatter:o})}_playSoundImpl(e,t){if(this._playingSound){if(this._playingSound===e)return;o.stop(this._playingSound)}this._playingSound=e,o.play(e,void 0,t),o.onStopped(e,(()=>{delete this._playingSound}))}}},958607:(e,t,i)=>{"use strict";i.d(t,{CustomFieldsViewModel:()=>d});var s=i(947488),r=i(233064),o=i(323002),n=i(275734),a=i(586639),l=i(51170);class d{constructor({existingOrder:e,customFields:t,initialInputState:i,initialOrderType:a,orderType$:d}){
this._isEmptyRequiredCustomFieldsHighlighted$=new s.BehaviorSubject(!1),this._isCustomFieldsNotSelected$=new s.BehaviorSubject(!1),this._customFieldsInputValues$=new s.BehaviorSubject({}),this._subscriptions=[],this.getCustomFieldsInputValues=()=>this._customFieldsInputValues$.getValue(),this._handleAnyCustomFieldValueChange=()=>{this._calculateCustomFieldsInputValues(),this._checkIsCustomFieldsNotSelected()},this.isCustomFieldsNotSelected$=this._isCustomFieldsNotSelected$.asObservable(),this.customFieldsInputValues$=this._customFieldsInputValues$.asObservable(),this._orderType$=d,this._customFieldsModelOptions={modifyMode:e,existedValues:i,tradingDialogCustomFields:t,alwaysShowAttachedErrors$:this._isEmptyRequiredCustomFieldsHighlighted$.asObservable()},this._customFieldModels$=new s.BehaviorSubject((0,l.createCustomFieldModels)({...this._customFieldsModelOptions,currentOrderType:a})),this._handleAnyCustomFieldValueChange(),this.onControlFocused$=this._customFieldModels$.pipe((0,r.switchMap)((e=>(0,o.merge)(...e.map((e=>(0,n.fromEventPattern)((t=>e.onControlFocused.subscribe(null,t)),(t=>e.onControlFocused.unsubscribe(null,t)))))))))}subscribe(){const e=this._anyCustomFieldValueChangeObservable().subscribe(this._handleAnyCustomFieldValueChange),t=this._orderType$.subscribe((e=>this._customFieldModels$.next((0,l.createCustomFieldModels)({...this._customFieldsModelOptions,currentOrderType:e}))));this._subscriptions.push(e,t)}unsubscribe(){this._subscriptions.forEach((e=>e?.unsubscribe())),this._subscriptions=[],this._customFieldModels$.getValue().forEach((e=>e.destroy()))}setIsEmptyRequiredCustomFieldsHighlighted(e){this._isEmptyRequiredCustomFieldsHighlighted$.next(e)}getIsCustomFieldsNotSelected(){return this._isCustomFieldsNotSelected$.getValue()}getCustomFieldsModels(){return this._customFieldModels$.getValue()}_checkIsCustomFieldsNotSelected(){const e=this._customFieldModels$.getValue().flatMap((e=>"ComboBox"===e.type&&void 0===e.getSelectedItem()?e:[]));this._isCustomFieldsNotSelected$.next(0!==e.length)}_anyCustomFieldValueChangeObservable(){return this._customFieldModels$.pipe((0,r.switchMap)((e=>(0,o.merge)(...e.map((e=>"TextWithCheckBox"===e.type?(0,o.merge)(e.checked$,e.text$):"TextField"===e.type?e.text$:"Checkbox"===e.type?e.checked$:"ComboBox"===e.type?e.selectedItem$:(0,a.of)(void 0)))))))}_calculateCustomFieldsInputValues(){const e=this._customFieldModels$.getValue(),t=this._getCustomFieldsInputValues(e);this._customFieldsInputValues$.next(t)}_getCustomFieldsInputValues(e){const t={};return e.forEach((e=>{"TextWithCheckBox"===e.type&&(t[e.id]={text:e.getText().replace(/&quote;/g,'"'),checked:e.getChecked()}),"TextField"===e.type&&(t[e.id]=e.getText()),"Checkbox"===e.type&&(t[e.id]=e.getChecked()),"ComboBox"===e.type&&(t[e.id]=e.getSelectedItem())})),t}}},51170:(e,t,i)=>{"use strict";i.d(t,{createCustomFieldModels:()=>a,filterAllowedCustomFields:()=>l,isSupportedField:()=>n});var s=i(947488),r=i(627692);var o=i(586639);function n(e,t){
return void 0===e.supportedOrderTypes||e.supportedOrderTypes.includes(t)}function a(e){const{modifyMode:t,alwaysShowAttachedErrors$:i,currentOrderType:n,existedValues:a,tradingDialogCustomFields:d}=e;if(void 0===d||!Array.isArray(d)||0===d.length)return[];return(null!==n?l(n,d):d).map((e=>{if("TextField"===e.inputType)return function({customField:e,existedValues:t,modifyMode:i}){let o;const n=t?.[e.id];try{o=JSON.parse(n)}catch(e){o=n}const a=new s.BehaviorSubject(o??e.value),l=new s.BehaviorSubject(!0),d=new s.BehaviorSubject(void 0),u=e.validator,c=void 0!==u?e=>{const t=u(e);l.next(t.valid),d.next(t.valid?void 0:t.errorMessage)}:void 0,h=void 0!==c?a.subscribe(c):void 0;return{id:e.id,type:e.inputType,inputType:e.maskWithAsterisk?"password":"text",placeholder:e.placeHolder||"",title:e.title||"",text$:a.asObservable(),getText:a.getValue.bind(a),setText:a.next.bind(a),onControlFocused:new r.Delegate,errorMessage$:d,isValid:()=>l.getValue(),destroy:()=>h?.unsubscribe(),disabled:i&&e.preventModify}}({customField:e,existedValues:a,modifyMode:t});if("TextWithCheckBox"===e.inputType)return function({customField:e,existedValues:t}){let i;const o=t?.[e.id];try{i=JSON.parse(o)}catch(e){i=o}const n=new s.BehaviorSubject(i?.text??e.value.text),a=new s.BehaviorSubject(i?.checked??e.value.checked),l=new s.BehaviorSubject(!0),d=new s.BehaviorSubject(void 0),u=e.validator,c=void 0!==u?e=>{const t=u(e);l.next(t.valid),d.next(t.valid?void 0:t.errorMessage)}:void 0,h=void 0!==c?n.subscribe(c):void 0;return{id:e.id,type:e.inputType,inputType:e.customInfo.asterix?"password":"text",placeholder:e.placeHolder||"",title:e.title||"",checkboxTitle:e.customInfo.checkboxTitle,text$:n.asObservable(),getText:n.getValue.bind(n),setText:n.next.bind(n),checked$:a.asObservable(),getChecked:a.getValue.bind(a),setChecked:a.next.bind(a),onControlFocused:new r.Delegate,errorMessage$:d,isValid:()=>l.getValue(),destroy:()=>h?.unsubscribe()}}({customField:e,existedValues:a});if("Checkbox"===e.inputType)return function({customField:e,modifyMode:t,existedValues:i}){let n;const a=i?.[e.id];try{n=JSON.parse(a)}catch(e){n=a}const l=new s.BehaviorSubject(n??e.value);return{id:e.id,type:e.inputType,title:e.title,help:e.help,solutionId:e.solutionId,checked$:l.asObservable(),getChecked:l.getValue.bind(l),setChecked:l.next.bind(l),onControlFocused:new r.Delegate,disabled:t&&!e.supportModify,saveToSettings:e.saveToSettings,errorMessage$:(0,o.of)(void 0),isValid:()=>!0,destroy:()=>{}}}({customField:e,modifyMode:t,existedValues:a});if("ComboBox"===e.inputType&&Array.isArray(e.items))return function({customField:e,modifyMode:t,alwaysShowAttachedErrors$:i,existedValues:n}){let a=e.items[0];if(n&&e.id in n){const t=n[e.id],i=e.items.find((e=>e.value===t));void 0!==i&&(a=i)}else e.forceUserEnterInitialValue&&!t&&(a=void 0);const l=new s.BehaviorSubject(a?.value);return{id:e.id,type:e.inputType,title:e.title,items:e.preventModify&&t&&a?[a]:e.items,selectedItem$:l.asObservable(),getSelectedItem:l.getValue.bind(l),setSelectedItem:l.next.bind(l),
onControlFocused:new r.Delegate,saveToSettings:e.saveToSettings,alwaysShowAttachedErrors$:i,errorMessage$:(0,o.of)(void 0),isValid:()=>!0,destroy:()=>{}}}({customField:e,modifyMode:t,alwaysShowAttachedErrors$:i,existedValues:a});throw Error("Unknown inputType")}))}function l(e,t){return t.filter((t=>n(t,e)))}},316176:(e,t,i)=>{"use strict";i.r(t),i.d(t,{Trading:()=>$s,TradingActionName:()=>gs,showSellBuyButtonsDefault:()=>Ss});var s=i(650151),r=i(609838),o=i(551442),n=i(748838),a=i(926032),l=i(180185),d=i(909702),u=i(150335),c=i(947488),h=i(323002),p=i(997345),_=i(586639),g=i(275734),y=i(757604),b=i(958261),m=i(114501),v=i(476161),f=i(771035),P=i(138966),S=i(116217);function k(e){return(0,S.operate)((function(t,i){var s,r=null,o=!1;r=t.subscribe(new P.OperatorSubscriber(i,void 0,void 0,(function(n){s=(0,f.innerFrom)(e(n,k(e)(t))),r?(r.unsubscribe(),r=null,s.subscribe(i)):o=!0}))),o&&(r.unsubscribe(),r=null,s.subscribe(i))}))}var C=i(423869),T=i(960521),w=i.n(T),B=i(894862),O=i(760775),M=i(401498),E=i(721762),I=i(130557),V=i(17076),$=i(671945),D=i(851310),L=i(891495),x=i(534934),A=i(563859),q=i(780284),R=i(963632),F=i(627692),N=i(148565);var Q=i(626800),U=i(298670),W=i(50959),z=i(497754),j=i.n(z),H=i(325826);function G(e){return W.createElement("span",{className:H.separator})}var K=i(917036),Y=i(556239),X=i(483394),J=i(533408),Z=i(752971);const ee=W.forwardRef(((e,t)=>W.createElement("div",{ref:t,className:Z.popupWrapper,"aria-label":r.t(null,void 0,i(219486))},e.children)));var te=i(753327);const ie=(()=>{let e,t,s,r=null,o=null;return async(n,a,l,d)=>{const u=n?.currentAccount();if(null===r||o!==n||e!==u||s!==d){t?.remove();const{AccountManager:c}=await Promise.all([i.e(4958),i.e(8185),i.e(1681),i.e(3039),i.e(6612),i.e(8933),i.e(6032),i.e(3672),i.e(3425),i.e(8752),i.e(8158),i.e(4391),i.e(1462),i.e(6052),i.e(874),i.e(442),i.e(1450),i.e(7702),i.e(2950),i.e(4059),i.e(9964),i.e(5001),i.e(7691),i.e(9787),i.e(2568),i.e(563),i.e(8258),i.e(579),i.e(5728),i.e(8756),i.e(7727),i.e(3251),i.e(2433),i.e(2212),i.e(4134),i.e(4258),i.e(987),i.e(3760),i.e(1054),i.e(8354)]).then(i.bind(i,603903)),h={container:a,visible:new R.WatchedValue(!0)};r=a,o=n,e=u,s=d,t=await c.create({broker:n,bridge:h,mode:0,overlapManager:l,summaryFieldsVisibilityManager:d})}else a.appendChild(r)}})(),se=new R.WatchedValue(null);function re(e){const{broker:t,summaryFieldsVisibilityManager:i}=e,s=(0,W.useRef)(null),r=(0,W.useContext)(te.SlotContext);return(0,W.useEffect)((()=>{se.setValue(r)}),[r]),(0,W.useEffect)((()=>{null!==s.current&&ie(t,s.current,se.readonly(),i)}),[]),W.createElement(ee,{ref:s})}var oe=i(132455),ne=i(502395),ae=i(842960),le=i(157129),de=i(21928);const ue=r.t(null,void 0,i(276495));class ce extends X.DialogRenderer{constructor(e){super(),this._title=ue,this._isSubscribed=!1,this._showSeparator=!0,this._closeButtonReference=W.createRef(),this._handleClose=()=>{this._rootInstance?.unmount(),this._rootInstance=null,this._setVisibility(!1)},this._trading=e}visible(){return this._visibility.spawn().readonly()}show(){
this._isSubscribed||(this._isSubscribed=!0,this._onStatusChange(this._trading.connectStatus()),this._trading.onConnectionStatusChange.subscribe(this,this._onStatusChange)),this._setVisibility(!0),this._renderComponent()}hide(){this._handleClose()}_onStatusChange(e,t){this._trading.activeBroker()?.currentAccountUpdate.unsubscribe(this,this._renderAccountManager),this._connectStatus!==e&&(this._connectStatus=e,this._additionalHeaderElement=void 0,window.navigator.onLine?2!==e&&t?.disconnectType!==B.DisconnectType.Offline&&3!==e&&4!==e?1===e&&(this._trading.activeBroker()?.currentAccountUpdate.subscribe(this,this._renderAccountManager),this._renderAccountManager()):this._renderSpinner():this._renderOfflineScreen())}_renderComponent(){const e=W.createElement(J.AdaptivePopupDialog,{dataName:"trading-dialog",isOpened:this.visible().value(),onClose:this._handleClose,showSeparator:this._showSeparator,fullScreen:!0,draggable:!1,title:this._title,render:()=>this._content,additionalHeaderElement:this._additionalHeaderElement,additionalElementPos:"after",headerClassName:de.header,titleClassName:de.title,closeButtonReference:this._closeButtonReference});if(this._rootInstance)return this._rootInstance.render(e),void this._addCloseDialogButtonAriaLabel();this._rootInstance=(0,le.createReactRoot)(e,this._container),this._addCloseDialogButtonAriaLabel()}_renderSpinner(){this._showSeparator=!0,this._title=ue,this._changeDialogContent(W.createElement(oe.Spinner,null))}_renderOfflineScreen(){this._title=ue,this._changeDialogContent(W.createElement(Y.OfflineScreen,null))}async _renderBrokerSelectScreen(){0}async _renderAccountManager(){const e=(0,s.ensureNotNull)(this._trading.activeBroker()).accountManagerInfo().summary,t=new ae.SummaryFieldsVisibilityManager(e,this._trading.getBrokerTradingSettingsStorage),r=await(0,ne.makeAccountManagerHeaderDropdownsProps)(this._trading,t,0);if(this._showSeparator=!1,this._title=ue,void 0!==r){const{AccountManagerHeaderDropdowns:e}=await Promise.all([i.e(4958),i.e(8185),i.e(1681),i.e(3039),i.e(6612),i.e(8933),i.e(6032),i.e(3672),i.e(3425),i.e(8752),i.e(8158),i.e(4391),i.e(1462),i.e(6052),i.e(874),i.e(442),i.e(1450),i.e(7702),i.e(2950),i.e(4059),i.e(9964),i.e(5001),i.e(7691),i.e(9787),i.e(2568),i.e(563),i.e(8258),i.e(579),i.e(5728),i.e(8756),i.e(7727),i.e(3251),i.e(2433),i.e(2212),i.e(4134),i.e(4258),i.e(987),i.e(3760),i.e(1054),i.e(8354)]).then(i.bind(i,331632));this._title=W.createElement(e,{...r});{const e={...r.commonDropdownProps,iconSize:"big"};this._additionalHeaderElement=W.createElement("span",{className:de.moreButton},W.createElement(K.TerminalDropdown,{...e}),W.createElement(G,null))}}this._content=W.createElement(re,{broker:this._trading.activeBroker(),summaryFieldsVisibilityManager:t}),this._renderComponent()}_changeDialogContent(e){this._content=W.createElement(ee,null,e),this._renderComponent()}_addCloseDialogButtonAriaLabel(){this._closeButtonReference.current&&(this._closeButtonReference.current.ariaLabel=r.t(null,void 0,i(945233)))}}var he,pe=i(10857),_e=i(601227),ge=i(617998)
;async function ye(e,t){localStorage.setItem(e,t)}!function(e){e.get=async function(){return _e.CheckMobile.any()||await async function(){const e=n.getValue(ge.settingsKeys.ACTIVE_BROKER);if(n.remove(ge.settingsKeys.ACTIVE_BROKER,{forceFlush:!0}),void 0===e)return;await ye(ge.settingsKeys.ACTIVE_BROKER,e)}(),async function(e){return localStorage.getItem(e);const t=localStorage.getItem(e);if(null===t)return null;const i=await userSpecificDecrypt(t);null===i&&localStorage.removeItem(e);return i}(ge.settingsKeys.ACTIVE_BROKER)},e.set=async function(e){"REPLAYBROKER"!==e&&await ye(ge.settingsKeys.ACTIVE_BROKER,e)},e.clear=function(){n.remove(ge.settingsKeys.ACTIVE_BROKER,{forceFlush:!0}),localStorage.removeItem(ge.settingsKeys.ACTIVE_BROKER)}}(he||(he={}));var be=i(363111),me=i(166554),ve=i(483670),fe=i(474229),Pe=i(950147),Se=i(423075),ke=i(649008);const Ce=(0,$.getLogger)("Trading.RealtimeProvider");class Te{constructor(e){this._results={},this._getter=e}get(e){return this._results[e]||(this._results[e]=this._getter(e)),this._results[e]}}class we{constructor(e){this._getter=e}get(e){return this._getter(e)}}class Be{constructor(e){this._stopped=!1,this._subscribed=!1,this._provider=null,this._formatters=null;const{symbol:t,callback:i,providersDataAccessor:s,formattersDataAccessor:r,subscriptionType:o,actualSymbolGetter:n}=e;this._symbol=t,this._subscriptionType=o,this._callback=i,this._providersDataAccessor=s,this._formattersDataAccessor=r,this._getActualSymbol=n,"Realtime"===this._subscriptionType?this._handler=(e,t)=>{this._stopped||i(e,t,this._formatters)}:this._handler=(e,t)=>{this._stopped||i(e,t)},this._start().catch((e=>{}))}symbol(){return this._symbol}type(){return this._subscriptionType}callback(){return this._callback}destroy(){this._ensureNotStopped(),this._subscribed&&void 0!==this._actualSymbol&&("Realtime"===this._subscriptionType?(0,s.ensureNotNull)(this._provider).unsubscribeRealtime(this._actualSymbol,this._handler):(0,s.ensureNotNull)(this._provider).unsubscribeDOM(this._actualSymbol,this._handler)),this._stopped=!0}async _start(){const{symbol:e}=await this._getActualSymbol(this._symbol);this._ensureNotStopped(),this._provider=await this._providersDataAccessor.get(e),this._ensureNotStopped(),this._formatters=await this._formattersDataAccessor.get(e),(0,s.ensure)(this._formatters),this._ensureNotStopped(),this._actualSymbol=e,this._subscribed=!0,"Realtime"===this._subscriptionType?this._provider.subscribeRealtime(e,this._handler):this._provider.subscribeDOM(e,this._handler)}_ensureNotStopped(){(0,s.assert)(!this._stopped,"Should not be stopped")}}class Oe{constructor(e,t,i,s){this.onStatusChanged=new F.Delegate,this._subscriptions=[],this._currentBroker=null,this._activeBrokerGetter=e,this._actualSymbolGetter=s,t.subscribe(this,this._connectionStatusChanged),i.subscribe(this,this._connectionStatusChanged),this._tvProvider=new Se.BrokerRealtimeAdapter("RealtimeProvider"),this._connectionStatusChanged()}isTradable(e){return this._tradableDataAccessor.get(e)}subscribeRealtime(e,t){
this._subscriptions.some((i=>i.symbol()===e&&i.callback()===t&&"Realtime"===i.type()))||this._subscriptions.push(new Be({symbol:e,callback:t,providersDataAccessor:this._providersDataAccessor,formattersDataAccessor:this._formattersDataAccessor,subscriptionType:"Realtime",actualSymbolGetter:this._actualSymbolGetter}))}unsubscribeRealtime(e,t){const i=this._subscriptions.findIndex((i=>i.symbol()===e&&i.callback()===t&&"Realtime"===i.type()));if(-1===i)return;this._subscriptions[i].destroy(),this._subscriptions.splice(i,1)}subscribeDOM(e,t){this._subscriptions.some((i=>i.symbol()===e&&i.callback()===t&&"DOM"===i.type()))||this._subscriptions.push(new Be({symbol:e,callback:t,providersDataAccessor:this._providersDataAccessor,formattersDataAccessor:this._formattersDataAccessor,subscriptionType:"DOM",actualSymbolGetter:this._actualSymbolGetter}))}unsubscribeDOM(e,t){const i=this._subscriptions.findIndex((i=>i.symbol()===e&&i.callback()===t&&"DOM"===i.type()));if(-1===i)return void Ce.logWarn("Subscription not found");this._subscriptions[i].destroy(),this._subscriptions.splice(i,1)}formatter(e){return this._formattersDataAccessor.get(e).then((e=>e.formatter))}spreadFormatter(e){return this._formattersDataAccessor.get(e).then((e=>e.spreadFormatter))}quantityFormatter(e){return this._formattersDataAccessor.get(e).then((e=>e.quantityFormatter))}symbolInfo(e){if(!e){const e={minTick:NaN,qty:{min:NaN,max:NaN,step:NaN},pipValue:NaN,pipSize:NaN,description:"no symbol"};return Promise.resolve(e)}return this._providersDataAccessor.get(e).then((t=>t!==this._tvProvider?t.symbolInfo(e).then((t=>t||this._tvProvider.symbolInfo(e))).catch((t=>this._tvProvider.symbolInfo(e))):this._tvProvider.symbolInfo(e)))}quotesSnapshot(e){return this._providersDataAccessor.get(e).then((t=>t.quotesSnapshot(e)))}activeBroker(){return null!==this._currentBroker&&this._currentBroker!==this._tvProvider?this._currentBroker:null}_isTradable(e){if(null===this._currentBroker||this._currentBroker===this._tvProvider)return Promise.resolve({tradable:!1});try{return(0,ke.makeTimeLimited)(this._currentBroker.isTradable(e),6e4,"isTradable Promise Timeout").catch((()=>Promise.resolve({tradable:!1})))}catch(e){return Promise.resolve({tradable:!1})}}_haveRealtime(e){return this._tradableDataAccessor.get(e)||Promise.resolve(null===this._currentBroker)}_connectionStatusChanged(){const e=this._activeBrokerGetter(),t=this._currentBroker,i=e&&1===e.connectionStatus()?e:null;if(this._createDataAccessors(),t!==i){const e=this._subscriptions.map((e=>({symbol:e.symbol(),callback:e.callback(),type:e.type()})));this._unsubscribeAll(),this._currentBroker=i,this._subscribeAll(e),this.onStatusChanged.fire()}}_createDataAccessors(){const e=!this._activeBrokerGetter()?.metainfo().configFlags.disableIsTradableCaching?Te:we;this._providersDataAccessor=new e((e=>this._provider(e))),this._tradableDataAccessor=new e((e=>this._isTradable(e))),
this._formattersDataAccessor=new e((e=>this._providersDataAccessor.get(e).then((t=>Promise.all([t.formatter(e,!1),t.spreadFormatter(e),t.quantityFormatter(e)]))).then((([e,t,i])=>({formatter:e,spreadFormatter:t,quantityFormatter:i})))))}_provider(e){return x.enabled("enable_dom_data_for_untradable_symbols")?Promise.resolve(this._currentBroker||this._tvProvider):this._haveRealtime(e).then((e=>e.tradable&&this._currentBroker&&1===this._currentBroker.connectionStatus()?this._currentBroker:this._tvProvider))}_unsubscribeAll(){this._subscriptions.forEach((e=>{e.destroy()})),this._subscriptions=[]}_subscribeAll(e){e.forEach((e=>{this._subscriptions.push(new Be({symbol:e.symbol,callback:e.callback,providersDataAccessor:this._providersDataAccessor,formattersDataAccessor:this._formattersDataAccessor,subscriptionType:e.type,actualSymbolGetter:this._actualSymbolGetter}))}))}}var Me,Ee=i(995379);!function(e){e.Placed="Placed",e.Rejected="Rejected",e.Executed="Executed",e.Canceled="Canceled",e.Modified="Modified"}(Me||(Me={}));const Ie=["Placed","Executed","Canceled","Rejected"];class Ve extends Ee.BrokerService{constructor(e){super(e,"TradingStat"),this._userId=(window.user.id||"").toString(),this._lastBrokerId=null,this._trackedOrderIdsByEventNameMap=new Map,window.loginStateChange&&window.loginStateChange.subscribe(this,this._onLoginStateChange),this._initTrackedOrderIdsByEventNameMap()}trackOrderPlaced(e){this.activeBroker()?.metainfo().shouldNotTrackOrderEvents||(this._trackOrderEvent("Placed",e),this._trackOrderPlaced(e?.source))}trackOrderModified(e){this.activeBroker()?.metainfo().shouldNotTrackOrderEvents||this._trackOrderEvent("Modified",{order:e})}startService(){const e=(0,s.ensure)(this.activeBroker(),"activeBroker() at TradingStat startService");this._lastBrokerId!==e.metainfo().id&&this._resetTrackedOrderIdsByEventNameMap(),e.orderUpdate.subscribe(this,this._orderUpdate),this._trackTradingBrokerConnected()}stopService(){this._lastBrokerId=null;(0,s.ensure)(this.activeBroker()).orderUpdate.unsubscribe(this,this._orderUpdate)}_orderUpdate(e,t){t||this.activeBroker()?.metainfo().shouldNotTrackOrderEvents||(5===e.status?this._trackOrderEvent("Rejected",{order:e}):2===e.status?this._trackOrderEvent("Executed",{order:e}):1===e.status&&this._trackOrderEvent("Canceled",{order:e}))}_shouldSkipTrackEventByOrderId(e,t){return!!this._trackedOrderIdsByEventNameMap.get(t)?.has(e)}async _trackOrderPlaced(e){const t=this.activeBroker();if(!t?.metainfo().shouldNotTrackOrderEvents&&!t)throw new Error("no active broker")}async _trackOrderEvent(e,t){const i=this.trading().linking().value(),s=this.activeBroker(),r=t?.order;if(void 0===r||null===s||s.metainfo().shouldNotTrackOrderEvents)return;if(void 0!==r.id&&Ie.includes(e)){if(this._shouldSkipTrackEventByOrderId(r.id,e))return;this._trackedOrderIdsByEventNameMap.get(e)?.add(r.id)}const o=await s.symbolInfo(r.symbol),n=r.qty*(o.lotSize||1),a="Placed"===e&&void 0!==i.continuous&&i.symbol===r.symbol?"continuous":o.type,l={amount:n,orderId:r.id,instrumentType:a,eventName:"Order "+e,
symbol:r.symbol,currency:o.currency??null,label:t?.label,source:r.source};l.hashedUserId=await(this._hashedUserIdPromise?.catch((()=>{}))),this._trackTradingOrder(l)}_trackTradingOrder(e){const t=this.activeBroker();if(!t)throw new Error("no active broker")}_trackTradingBrokerConnected(){const e=this.activeBroker();null!==e&&e.metainfo().id;if(!e)throw new Error("no active broker")}_onLoginStateChange(){this._userId=(window.user.id||"").toString()}_initTrackedOrderIdsByEventNameMap(){for(const e of Ie)this._trackedOrderIdsByEventNameMap.set(e,new Set)}_resetTrackedOrderIdsByEventNameMap(){this._trackedOrderIdsByEventNameMap.clear(),this._initTrackedOrderIdsByEventNameMap()}}var $e=i(32133);class De{constructor(e){this._chartWidgetCollection=e}showTradingProperties(){this._chartWidgetCollection.activeChartWidget.value().showGeneralChartProperties(N.TabNames.trading)}showMaintenance(e){0}showBrokerSideMaintenance(e){0}trackEvent(e,t,i){!async function(e,t,i){(0,$e.trackEvent)(e,t,i)}(e,t,i)}showReplayConfirmationDialog(){return Promise.resolve()}reconnectChartApi(e){0}setBroker(e){const t=e?.metainfo().backendBrokerName||e?.metainfo().id.toLowerCase()||"";this._chartWidgetCollection.setBroker(t)}}var Le=i(154834),xe=i(802672),Ae=i(782860),qe=i(904958),Re=i(464703);i(523090),i(769762),i(576594);i(460351);async function Fe(e,t,s,o){const n=await async function(e,t){const{ClosePositionDialogRenderer:s}=await i.e(3446).then(i.bind(i,515068)),r=new s;return new Promise(((i,s)=>{t?.aborted?i({status:!1}):(r.open({...e,dialogActionHandler:i}),t?.addEventListener("abort",(()=>{r.close(),i({status:!1})}),{once:!0}))}))}(e,o);if(!n.status)return!1;try{return await t(n.qty,n.id)}catch(e){return s(r.t(null,void 0,i(139924)),function(e){let t="";null!==e&&"object"==typeof e&&e.message?t=e.message:"string"==typeof e&&(t=e);return t}(e)),!1}}var Ne=i(828750);const Qe={async show(e){const t=r.t(null,{replace:{symbol:e}},i(227617)),s=r.t(null,{replace:{symbol:e}},i(182914));return(0,Ne.showSimpleConfirmDialog)({title:s,text:t})}},Ue={async show(e){const t=r.t(null,{replace:{symbol:e}},i(156910)),s=r.t(null,{replace:{symbol:e}},i(830538));return(0,Ne.showSimpleConfirmDialog)({title:s,text:t})}};function We(e){const{symbol:t,side:s,qty:o,price:n,id:a,closePositionCancelsOrders:l,closePositionCancelsOrdersMessage:d}=e;return W.createElement(W.Fragment,null,W.createElement("div",null,void 0!==a?r.t(null,void 0,i(792417)).replace("{id}",a):r.t(null,void 0,i(267539))),W.createElement("div",null,W.createElement("b",null,t)),W.createElement("div",null,W.createElement("b",null,`${s} ${o} @ ${n}`)),W.createElement("div",null,l&&` ${d??r.t(null,void 0,i(178224))}`))}const ze=(0,$.getLogger)("Trading.BrokerCommandsUI"),je={symbol:1,qty:1,side:1,type:1,seenPrice:1};function He(e){for(const t in je)if(!(t in e))return!1;return!0}const Ge=!1;class Ke{
constructor({activeBroker:e,guiAccessor:t,noConfirmEnabled:i,orderViewController:s,showErrorNotification:r,trackEvent:o,tradingLinking:n,tradedContextLinking:a,abortSignalGetter:l,trackOrderPresetSnowplowEvent:d}){this._closePositionDialogVisibility=new ve.DialogVisibility,this._isClosePositionDialogLoading=!1,this._isCloseIndividualPositionDialogLoading=!1,this._onClosePositionDialogOpen=e=>{this._closePositionDialogVisibility.setValue({isVisible:!0,isFullScreen:e})},this._onClosePositionDialogClose=()=>{this._closePositionDialogVisibility.setValue({isVisible:!1})},this._tradingLinking=n,this._tradedContextLinking=a,this._activeBroker=e,this._guiAccessor=t,this._orderViewController=s,this._showErrorNotification=r,this._noConfirmEnabled=i,this._trackEvent=o,this._getAbortSignal=l,this._trackOrderPresetSnowplowEvent=d,this.closePositionDialogVisibility=this._closePositionDialogVisibility.value$}async placeOrder(e,t,i,s,r=!0){const o=t&&this._noConfirmEnabled.value(),n=await this._activeBroker.isTradable(e.symbol);if(o&&n.tradable&&He(e)){"OrderPresetSource:SellBuyButtons"===e.creationSource?this._trackOrderPresetSnowplowEvent("place_order_with_order_preset_instantly_using_sell_buy_buttons"):"OrderPresetSource:Hotkey"===e.creationSource&&this._trackOrderPresetSnowplowEvent("place_order_with_order_preset_instantly_using_hotkey");return(await this._activeBroker.createPlaceOrderContext({order:e,source:"instant",isValidationEnabled:!1,isDisposable:!0})).send()}{const t=this._activeBroker.metainfo();if(t.customUI&&void 0!==t.customUI.showOrderDialog)return t.customUI.showOrderDialog(e)}return this._orderViewController().then((t=>this._activeBroker?t.showOrderView({order:e,focus:s,forceOrderDialog:i,shouldOpenOrderTicket:xe.isResizableDrawerEnabled||r,forceCollapsedOrderDrawer:xe.isResizableDrawerEnabled&&!1===r&&Ge}):Promise.reject("Broker connection adapter is null")))}async modifyOrder(e,t,i,s){if(t&&this._noConfirmEnabled.value()&&1===e.parentType){return(await this._activeBroker.createEditOrderContext({order:e,source:"instant",isDisposable:!0,isValidationEnabled:!1})).send()}return this._modifyOrder(e,t,i,s)}async closePosition(e){if(this._makeSureBrokerIsConnected(),this._isClosePositionDialogLoading)return!1;let t,i;this._isClosePositionDialogLoading=!0;try{if(t=await this._activeBroker.positionById(e),void 0===t)return!1;const{tradable:s}=await this._activeBroker.isTradable(t.symbol);if(await this._assertPositionExistsAndNotClosed(t.id),!s)return this._closePositionForNonTradableSymbol(t);if(this._noConfirmEnabled.value())return this._activeBroker.closePosition(e);i=await this._obtainPositionClosingData(t)}finally{this._isClosePositionDialogLoading=!1,this._tradedContextLinking.clear()}if(void 0===i)return!1;const{supportPartialClosePosition:s,...r}=i,o=this._activeBroker.metainfo();if(void 0!==o.customUI?.showClosePositionDialog)return o.customUI?.showClosePositionDialog(t);return Fe({...r,positionOrIndividualPosition:t,onOpen:this._onClosePositionDialogOpen,onClose:this._onClosePositionDialogClose,
isPreviewClosePositionSupported:this._activeBroker.config.supportPreviewClosePosition??!1,previewClosePosition:this._activeBroker.previewClosePosition?.bind(this._activeBroker),isPartialCloseSupported:Boolean(s)},(async(i,s)=>{this._trackClosePositionEvent({event:"Close Position Dialog",positionQty:t.qty,qty:i});const r=await this._activeBroker.closePosition(e,i,s);return r&&this._tradedContextLinking.clear(),r}),this._showErrorNotification,this._getAbortSignal())}async closeIndividualPosition(e){if(this._makeSureBrokerIsConnected(),(0,s.assert)(!!this._activeBroker.config.supportPositionNetting,"Broker doesn`t support individual positions"),this._noConfirmEnabled.value())return this._activeBroker.closeIndividualPosition(e);{if(this._isCloseIndividualPositionDialogLoading)return!1;const t=await this._obtainIndividualPositionClosingData(e);if(void 0===t)return!1;const{supportPartialCloseIndividualPosition:i,individualPosition:s,...r}=t,o=this._activeBroker.metainfo().customUI?.showClosePositionDialog;if(void 0!==o)return o(s);const n=async(t,i)=>(this._trackClosePositionEvent({event:"Close Individual Position Dialog",positionQty:s.qty,qty:t}),this._activeBroker.closeIndividualPosition(e,t,i));return Fe({...r,positionOrIndividualPosition:s,onOpen:this._onClosePositionDialogOpen,onClose:this._onClosePositionDialogClose,isPreviewClosePositionSupported:this._activeBroker.config.supportPreviewClosePosition??!1,previewClosePosition:this._activeBroker.previewClosePosition?.bind(this._activeBroker),isPartialCloseSupported:Boolean(i)},n,this._showErrorNotification,this._getAbortSignal())}}async editPositionBrackets(e,t,i,r,o){if(this._makeSureBrokerIsConnected(),(0,s.assert)(!!this._activeBroker.config.supportPositionBrackets,"Broker doesn`t support brackets on positions"),r&&this._noConfirmEnabled.value()){const i=await this._activeBroker.positionById(e);if(!i)return!1;return(await this._activeBroker.createEditPositionContext({position:{...i,...t},source:"instant",isDisposable:!0,isValidationEnabled:!1})).send()}return this._activeBroker.positionById(e).then((e=>this._activeBroker?this._showPositionDialog((0,s.ensureDefined)(e),t,i,o):Promise.reject("Broker connection adapter is null")))}async editIndividualPositionBrackets(e,t,i,r,o){if(r&&this._noConfirmEnabled.value()){const i=await this._activeBroker.individualPositionById(e);if(!i)return!1;return(await this._activeBroker.createEditIndividualPositionContext({position:{...i,...t},source:"instant",isDisposable:!0,isValidationEnabled:!1})).send()}return this._activeBroker.individualPositionById(e).then((e=>this._activeBroker?this._showIndividualPositionDialog((0,s.ensureDefined)(e),t,i,o):Promise.reject("Broker connection adapter is null")))}reversePosition(e){const t=this._activeBroker.metainfo();return this._makeSureBrokerIsConnected(),
t.configFlags.supportMultiposition&&!this._activeBroker.config.supportNativeReversePosition?Promise.reject("Cannot reverse position on multiposition acount"):this._noConfirmEnabled.value()?this._activeBroker.reversePosition(e):this._activeBroker.positionById(e).then((i=>{if(!this._activeBroker)return Promise.reject("Broker connection adapter is null");if(void 0!==t.customUI?.showReversePositionDialog&&void 0!==i)return t.customUI.showReversePositionDialog(i);const s=this._activeBroker.reversePosition.bind(this._activeBroker,e);return(0,Ae.reversePositionDialog)({positionId:e,showErrorNotification:this._showErrorNotification,handler:s,closePositionCancelsOrders:this._activeBroker.config.closePositionCancelsOrders,closePositionCancelsOrdersMessage:this._activeBroker.metainfo().closePositionCancelsOrdersMessage,abortSignal:this._getAbortSignal()})}))}async cancelOrder(e){this._makeSureBrokerIsConnected();const t=await this._activeBroker.orderById(e);if(void 0===t)return Promise.reject("Failed to find order");const{tradable:i}=await this._activeBroker.isTradable(t.symbol);if(await this._assertOrderExistsAndNotCanceled(t.id),!i)return this._cancelOrderForNonTradableSymbol(t.symbol,t.id);if(this._noConfirmEnabled.value()){const t=await this._activeBroker.cancelOrder(e);return t&&this._tradedContextLinking.clear(),t}{const i=async()=>{const t=await this._activeBroker.cancelOrder(e);return t&&this._tradedContextLinking.clear(),t},s=this._activeBroker.metainfo();if(void 0!==s.customUI?.showCancelOrderDialog)return s.customUI?.showCancelOrderDialog(t);if(t.parentId){const e=(await this._activeBroker.orders()).filter((e=>e.refNumber===t.refNumber));return s.configFlags.supportCancellingBothBracketsOnly&&e.length>1?this._showCancelMultipleBracketsDialog(t.parentId,i):this._showCancelBracketsDialog(t.id,i)}return this._showCancelOrderDialog(t.id,i)}}cancelOrders(e,t){return this._makeSureBrokerIsConnected(),this._activeBroker.orders().then((i=>{if(!this._activeBroker)return Promise.reject("Broker connection adapter is null");const s=i.filter((i=>i.symbol===e&&(!t||i.side===t)&&function(e){return 4===e.status||3===e.status||6===e.status}(i)));if(!s.length)return Promise.resolve(!1);if(1===s.length)return this.cancelOrder(s[0].id);const r=s.map((e=>e.id));if(this._noConfirmEnabled.value())return this._activeBroker.cancelOrders(e,t,r);{const i=this._activeBroker.cancelOrders.bind(this._activeBroker);return this._showCancelMultipleOrdersDialog(e,t,r,i)}}))}_trackClosePositionEvent({event:e,positionQty:t,qty:i}){const s=void 0!==i&&i!==t?"partial":"full";this._trackEvent("",e,s)}async _modifyOrder(e,t,s,o){const n=this._activeBroker.metainfo();if(this._makeSureBrokerIsConnected(),e.flags&&e.flags.trailingStop)return ze.logError("Attempt to modify trailing stop loss order"+e.id),this._showErrorNotification(r.t(null,void 0,i(500864)),r.t(null,void 0,i(908940))),Promise.resolve(!1);await this._setSymbol(e.symbol);const a=await this._activeBroker.symbolInfo(e.symbol);if(e.limitPrice=void 0!==a.limitPriceStep&&void 0!==e.limitPrice?(0,
me.roundToStepByPriceTypeAndSide)(e.limitPrice,a.limitPriceStep,1,e.side):e.limitPrice,e.stopPrice=void 0!==a.stopPriceStep&&void 0!==e.stopPrice?(0,me.roundToStepByPriceTypeAndSide)(e.stopPrice,a.stopPriceStep,2,e.side):e.stopPrice,!n.configFlags.supportModifyTrailingStop){const t=await this._activeBroker.orderById(e.id);e.hasTrailingStopBracket=void 0!==t?.trailingStopPips}const l=t&&this._noConfirmEnabled.value();let d=s||(1===e.type?1:2);if(e.parentId&&!x.enabled("always_pass_called_order_to_modify")){const t=await this._getParentOrderOrPosition(e);if(void 0!==t){d=s||(1===e.type?3:4);const i={takeProfit:e.limitPrice??t.takeProfit,trailingStopPips:e.trailingStopPips??t.trailingStopPips,guaranteedStop:e.guaranteedStop??t.guaranteedStop};if(void 0===e.trailingStopPips&&void 0===t.guaranteedStop&&(i.stopLoss=e.stopPrice??t.stopLoss),3===e.parentType)return l?this._activeBroker.editIndividualPositionBrackets(t.id,i):this._showIndividualPositionDialog(t,i,d);if(2===e.parentType&&e.qty===Math.abs(t.qty))return l?this._activeBroker.editPositionBrackets(t.id,i):this._showPositionDialog(t,i,d);1===e.parentType&&(0,O.isOrderActive)(t.status)&&((e=(0,Le.default)(t)).takeProfit=i.takeProfit,e.trailingStopPips=i.trailingStopPips,e.stopLoss=i.stopLoss,e.guaranteedStop=i.guaranteedStop,e.hasTrailingStopBracket=void 0!==t.trailingStopPips)}}return l?this._activeBroker.modifyOrder(e):n.customUI&&void 0!==n.customUI.showOrderDialog?n.customUI.showOrderDialog(e,d):this._orderViewController().then((t=>this._activeBroker?t.showOrderView({order:e,focus:d,forceOrderDialog:o}):Promise.reject("Broker connection adapter is null")))}async _setSymbol(e){this._tradingLinking.value().symbol!==e&&await this._tradingLinking.setSymbol(e)}_makeSureBrokerIsConnected(){(0,s.assert)(1===this._activeBroker.connectionStatus(),"Broker is not connected")}async _showPositionDialog(e,t={},s,o){await this._setSymbol(e.symbol);const n=await this._activeBroker.isTradable(e.symbol);if(!n.tradable){const t=void 0!==n.reason?n.reason:(0,me.makeNonTradableSymbolText)(e.symbol,this._activeBroker.metainfo().title);return this._showErrorNotification(r.t(null,void 0,i(734567)),t),Promise.resolve(!1)}{const i=this._activeBroker.metainfo();if(i.customUI&&void 0!==i.customUI.showPositionDialog)return i.customUI.showPositionDialog(e,{stopLoss:t.stopLoss||e.stopLoss,takeProfit:t.takeProfit||e.takeProfit},s)}return this._orderViewController().then((i=>{if(!this._activeBroker)return Promise.reject("Broker connection adapter is null");const r=Object.fromEntries(Object.entries(t).filter((([e,t])=>void 0!==t)));return i.showPositionView(e,r,s||e.limitPrice&&3||e.stopPrice&&4,void 0,o)}))}async _showIndividualPositionDialog(e,t={},i,s){await this._setSymbol(e.symbol);{const s=this._activeBroker.metainfo();if(s.customUI&&void 0!==s.customUI.showPositionDialog)return s.customUI.showPositionDialog(e,{stopLoss:t.stopLoss||e.stopLoss,takeProfit:t.takeProfit||e.takeProfit},i)}return this._orderViewController().then((r=>{
if(!this._activeBroker)return Promise.reject("Broker connection adapter is null");const o=Object.fromEntries(Object.entries(t).filter((([e,t])=>void 0!==t)));return r.showIndividualPositionView(e,o,i||e.limitPrice&&3||e.stopPrice&&4,s)}))}_isMaintenance(){return isFeatureEnabled((0,O.makeMaintananceFeatureToggleName)(this._activeBroker.metainfo().id))}_isBrokerSideMaintenance(){return isFeatureEnabled((0,O.makeBrokerSideMaintananceFeatureToggleName)(this._activeBroker.metainfo().id))}_showCancelOrderDialog(e,t){return qe.ConfirmOrderCancelDialog.get().open(e,this._getAbortSignal()).then((i=>i?t(e):Promise.resolve(!1)))}_showCancelMultipleOrdersDialog(e,t,i,s){const r=i.length;return qe.ConfirmOrderCancelDialog.get().multiple(e,t,r,this._getAbortSignal()).then((r=>r?s(e,t,i):Promise.resolve(!1)))}async _showCancelBracketsDialog(e,t){return Re.ConfirmBracketsCancelDialog.get().open(e,this._getAbortSignal()).then((i=>i?t(e):Promise.resolve(!1)))}_showCancelMultipleBracketsDialog(e,t){return Re.ConfirmBracketsCancelDialog.get().multiple(e,this._getAbortSignal()).then((i=>i?t(e):Promise.resolve(!1)))}async _obtainPositionClosingData(e){try{const{supportLots:t,qtyStep:s,uiQtyStep:o,minQty:n,qtyLabel:a,qtyFormatter:l,priceFormatter:d}=await this._obtainPositionOrIndividualPositionClosingCommonData(e),u=this._activeBroker.metainfo().configFlags.supportPartialClosePosition,c=We({symbol:(0,O.getSymbolNameOverFullname)(e.symbol),side:1===e.side?r.t(null,void 0,i(728257)):r.t(null,void 0,i(13009)),qty:l.format(e.qty),price:d.format(e.avgPrice),closePositionCancelsOrders:this._activeBroker.config.closePositionCancelsOrders,closePositionCancelsOrdersMessage:this._activeBroker.metainfo().closePositionCancelsOrdersMessage});return{position:e,supportLots:t,qtyStep:s,uiQtyStep:o,minQty:n,qtyLabel:a,supportPartialClosePosition:u,qtyFormatter:l,message:c}}catch(e){return}}async _obtainIndividualPositionClosingData(e){try{this._isCloseIndividualPositionDialogLoading=!0;const t=(0,s.ensureDefined)(await this._activeBroker.individualPositionById(e)),{supportLots:o,qtyStep:n,uiQtyStep:a,minQty:l,qtyLabel:d,qtyFormatter:u,priceFormatter:c}=await this._obtainPositionOrIndividualPositionClosingCommonData(t),h=this._activeBroker.metainfo().configFlags.supportPartialCloseIndividualPosition,p=We({symbol:(0,O.getSymbolNameOverFullname)(t.symbol),side:1===t.side?r.t(null,void 0,i(728257)):r.t(null,void 0,i(13009)),qty:u.format(t.qty),price:c.format(t.price),id:e,closePositionCancelsOrders:this._activeBroker.config.closePositionCancelsOrders,closePositionCancelsOrdersMessage:this._activeBroker.metainfo().closePositionCancelsOrdersMessage});return this._isCloseIndividualPositionDialogLoading=!1,{individualPosition:t,supportLots:o,qtyStep:n,uiQtyStep:a,minQty:l,qtyLabel:d,supportPartialCloseIndividualPosition:h,qtyFormatter:u,message:p}}catch(e){return void(this._isCloseIndividualPositionDialogLoading=!1)}}async _obtainPositionOrIndividualPositionClosingCommonData(e){
const t=await this._activeBroker.symbolInfo(e.symbol),i=void 0!==t.lotSize,s=t.qty.step,r=t.qty.uiStep,o=t.qty.min,n=t.units;return{supportLots:i,qtyStep:s,uiQtyStep:r,minQty:o,qtyFormatter:await this._activeBroker.quantityFormatter(e.symbol),priceFormatter:await this._activeBroker.formatter(e.symbol,!1),qtyLabel:n}}async _closePositionForNonTradableSymbol(e){const{supportClosePositionForNonTradableSymbol:t,supportClosePosition:s}=this._activeBroker.metainfo().configFlags;if(!t||!s){const t=r.t(null,{replace:{symbol:e.symbol}},i(466690));return this._showErrorNotification(t,r.t(null,void 0,i(495610))),!1}return!!await Qe.show(e.symbol)&&this._activeBroker.closePosition(e.id)}async _cancelOrderForNonTradableSymbol(e,t){if(!this._activeBroker.metainfo().configFlags.supportCancelOrderForNonTradableSymbol){const t=r.t(null,{replace:{symbol:e}},i(947962));return this._showErrorNotification(t,r.t(null,void 0,i(746562))),!1}return!!await Ue.show(e)&&this._activeBroker.cancelOrder(t)}async _assertPositionExistsAndNotClosed(e){const t=await this._activeBroker.positionById(e);if(!(0,O.checkIsExistingPosition)(t))throw new V.UserFriendlyError({userFriendlyMessage:r.t(null,{replace:{positionId:e}},i(526672)),detailedErrorMessage:`Position ${e} doesn't exist or has already been closed`})}async _getParentOrderOrPosition(e){try{return 1===e.parentType?await this._activeBroker.orderById(e.parentId):2===e.parentType?await this._activeBroker.positionById(e.parentId):3===e.parentType?await this._activeBroker.individualPositionById(e.parentId):void 0}catch{return}}async _assertOrderExistsAndNotCanceled(e){const t=await this._activeBroker.orderById(e);if(void 0===t||1===t.status)throw new V.UserFriendlyError({userFriendlyMessage:r.t(null,{replace:{orderId:e}},i(733144)),detailedErrorMessage:`Order ${e} doesn't exist or has already been canceled`})}}class Ye{constructor(e){this._domPanel=null;const{resizerBridge:t,closeFn:i,trading:s,qtySuggester:r,tradingLinking:o,headerState:n,isLoading:a}=e;this._resizerBridge=t,this._trading=s,this._qtySuggester=r,this._tradingLinking=o,this._headerState=n,this._isLoading=a,this._getDOMPanel=(0,L.sequentialize)(this._getDOMPanel),this._close=()=>{this.unmount(),i()}}centerDOM(){this._domPanel?.centerDOM()}mount(){return this._getDOMPanel().then((e=>{e.setVisibility(!0)}))}unmount(){this._getDOMPanel().then((e=>{e.setVisibility(!1)}))}headerStateValue(){return this._headerState}async _getDOMPanel(){if(null!==this._domPanel)return this._domPanel;const{DOMPanel:e}=await Promise.all([i.e(3635),i.e(8894),i.e(5743),i.e(3329),i.e(4391),i.e(9117),i.e(5994),i.e(3585),i.e(5001),i.e(8490),i.e(5875),i.e(563),i.e(6644),i.e(3178),i.e(8539),i.e(7125),i.e(9643),i.e(4627)]).then(i.bind(i,179050)),t=this._domPanel=new e(this._trading,this._resizerBridge,this._qtySuggester,this._tradingLinking,this._headerState,this._isLoading);return t.setCloseHandler(this._close),t}}class Xe{constructor(e){this._headerState=e}mount(){return Promise.resolve()}unmount(){}headerStateValue(){return this._headerState}}
var Je,Ze=i(28156),et=i(632227);!function(e){e.XSmall="xsmall",e.Small="small",e.Medium="medium"}(Je||(Je={}));const tt=(0,W.createContext)("xsmall");var it=i(273388),st=i(467922),rt=i.n(st);function ot(e){const{startSlot:t,endSlot:i,children:s,title:r}=e;return W.createElement(W.Fragment,null,t,s&&W.createElement("span",{title:r,className:j()(rt().content,r?"apply-common-tooltip":"apply-overflow-tooltip")},s),i)}const nt=(0,W.forwardRef)(((e,t)=>{const{id:i,active:s,startSlot:r,children:o,endSlot:n,className:a,title:l,disabled:d,...u}=e,c=(0,W.useContext)(tt);return W.createElement("button",{...u,id:i,ref:t,className:j()(rt().lightTabButton,rt()[c],s&&rt().selected,d&&rt().disabled,a)},W.createElement(ot,{startSlot:r,endSlot:n,title:l},o))}));nt.displayName="LightTabBaseButton";const at=(0,W.forwardRef)(((e,t)=>{const{item:i,highlighted:s,handleItemRef:r,onClick:o,...n}=e,a=(0,W.useCallback)((()=>{o&&o(i)}),[o,i]),l=(0,W.useCallback)((e=>{r&&r(i,e),(0,it.isomorphicRef)(t)(e)}),[i,r,t]);return W.createElement(nt,{...n,id:i.id,title:i.title,onClick:a,ref:l,startSlot:i.startSlot,endSlot:i.endSlot},i.children)}));at.displayName="LightTabButton";var lt=i(540801),dt=i(865679),ut=i(333714),ct=i.n(ut);function ht(e){const{items:t,isRtl:i,classNameWrap:s,className:r,style:o,"data-name":n="light-tabs-buttons",dataQaId:a="light-tabs-buttons",size:l="xsmall"}=e,{getBindings:d,scrollWrapBinding:u,tablistBinding:c,handleActivate:h}=(0,dt.useTabsMainHandlers)(lt.TabNames.LightButtonTabs,e,{isRtl:i});return W.createElement(tt.Provider,{value:l},W.createElement("div",{...u,"data-name":n,"data-qa-id":a,className:s,style:o},W.createElement("div",{...c,className:j()(ct().lightTabs,ct()[l],r)},t.map(((e,t)=>W.createElement(at,{...d(e),key:e.id,item:e,onClick:()=>h(e),"data-name":`light-tab-${t}`}))))))}var pt=i(661851),_t=i(229144),gt=i(680757);function yt(e){const{items:t,activeTabId:i,isVisible$:s,onSelect:r}=e,o=(0,pt.useObservable)(s),n=(0,W.useCallback)((e=>e.id===i),[i]),a=(0,W.useCallback)((e=>{const t=e.id;r(t),(0,$e.trackEvent)("GUI",t===fe.TradingPage.OrderPanel?"Select Order Tab":"Select DOM Tab")}),[r]);return o?W.createElement(ht,{id:"trading-panel-page-tabs",classNameWrap:gt.tabs,items:t,isRtl:_t.isRtl,isActive:n,onActivate:a}):W.createElement(W.Fragment,null)}var bt=i(386848),mt=i(654259);class vt{constructor(e,t){this.isOpened=new R.WatchedValue(!1),this.isOpeningAvailable=new R.WatchedValue(!1),this.isLoading=new R.WatchedValue(!1),this._showOrderPanelOnStart=x.enabled("show_order_panel_on_start"),this._orderPanelEnabled=x.enabled("order_panel"),this._domPanelEnabled=(0,bt.checkIsDOMAvailable)(),this._isPanelCanBeOpened=this._domPanelEnabled||this._orderPanelEnabled,this._shouldPersistOrderPanelState=!1,this._pageTabs=null,this._pages={},this._panelWidth=fe.minPanelWidth,this.setPage=e=>{this.isOpened.value()&&this.activePage.value()!==e&&this._pages[this.activePage.value()]&&this._pages[this.activePage.value()].unmount(),this.activePage.setValue(e),n.setValue(ge.settingsKeys.TRADING_PANEL_ACTIVE_PAGE,e)},
this.openPage=e=>{this.setPage(e),this.open()},this.open=()=>{const e=this._pages[this.activePage.value()];if(this.isOpeningAvailable.value()&&e){this._togglePanel(!0),this.isOpened.setValue(!0);const s=e.headerStateValue();(0,Ze.mountHeader)(this._header,s),null!==this._tabsConfig&&null!==this._pageTabs&&(t=this._pageTabs,i={items:this._tabsConfig.items,activeTabId:this.activePage.value(),isVisible$:s.isTabsAvailable$,onSelect:this._tabsConfig.onSelect},et.render(W.createElement(yt,{...i}),t)),e.mount()}var t,i},this.close=e=>{this.isOpened.setValue(!1),this._pages[this.activePage.value()]&&this._pages[this.activePage.value()].unmount(),(0,Ze.unmountHeader)(this._header),this._togglePanel(!1,e)},this.setCoverIsShown=e=>{this._setCoverIsShown(e)},this._onLayoutResizeHandleMousedown=e=>{if(e.defaultPrevented||!e.cancelable)return;e.preventDefault();const t=Math.max(this._resizerBridge.width.value(),0);let i;i="touches"in e?e.touches[0].clientX:e.clientX;const s=e=>{let s;e.preventDefault(),s="touches"in e?e.touches[0].clientX:e.clientX;let r=t-(s-i);r<fe.minPanelWidth?r=fe.minPanelWidth:r>fe.maxPanelWidth&&(r=fe.maxPanelWidth),this._requestWidth(r)},r=()=>{document.removeEventListener("mousemove",s),document.removeEventListener("touchmove",s),document.removeEventListener("mouseup",r),document.removeEventListener("touchend",r),n.setValue(ge.settingsKeys.PANEL_WIDTH,this._panelWidth)};document.addEventListener("mousemove",s),document.addEventListener("touchmove",s,{passive:!1}),document.addEventListener("mouseup",r),document.addEventListener("touchend",r,{passive:!1})};let i=n.getValue(ge.settingsKeys.TRADING_PANEL_ACTIVE_PAGE,this._orderPanelEnabled?fe.TradingPage.OrderPanel:fe.TradingPage.DOMPanel);i!==fe.TradingPage.DOMPanel||this._domPanelEnabled||(i=fe.TradingPage.OrderPanel),i!==fe.TradingPage.OrderPanel||this._orderPanelEnabled||(i=fe.TradingPage.DOMPanel),this.activePage=new R.WatchedValue(i),this.isOpened.setValue(this._showOrderPanelOnStart&&this._isPanelCanBeOpened),this._tabsConfig=t,this._resizerBridge=e,this.rootContainer=e.container.value(),this.rootContainer.classList.add(mt.rootContainer),this.rootContainer.tabIndex=-1,this.rootContainer.classList.toggle(mt.hidden,!this.isOpened.value()),this.container=document.createElement("div"),this.container.classList.add(mt["trading-panel-content"],"trading-panel-content"),this._header=document.createElement("div"),this._header.classList.add(mt["trading-panel-header"]),this.rootContainer.appendChild(this._header),null!==this._tabsConfig&&(this._pageTabs=document.createElement("div"),this._pageTabs.classList.add(mt["trading-panel-tabs"]),this.rootContainer.appendChild(this._pageTabs)),this.rootContainer.appendChild(this.container),this._addSpinner(),this._addResizeHandler(),this._addCover(),this._subscribeVisibility(),this.isLoading.subscribe(this._setLoading.bind(this))}addPage(e,t){this._pages[e]=t}isPageOpened(e){return this.isOpened.value()&&this.activePage.value()===e}_setLoading(e){e?(this._header.style.display="none",
null!==this._pageTabs&&(this._pageTabs.style.opacity="0"),this.container.style.visibility="hidden",this.container.style.opacity="0",this.rootContainer.appendChild(this._spinnerContainer)):(this._header.style.removeProperty("display"),null!==this._pageTabs&&this._pageTabs.style.removeProperty("opacity"),this.container.style.removeProperty("visibility"),this.container.style.removeProperty("opacity"),this.rootContainer.contains(this._spinnerContainer)&&this.rootContainer.removeChild(this._spinnerContainer))}_setCoverIsShown(e){this._coverContainer&&(this._coverContainer.style.display=e?"block":"none")}_addSpinner(){this._spinnerContainer=document.createElement("div"),this._spinnerContainer.classList.add(mt["trading-panel-spinner"]),Promise.all([i.e(7833),i.e(7102)]).then(i.bind(i,974063)).then((e=>{e.render(this._spinnerContainer)}))}_addResizeHandler(){this._handle=document.createElement("div"),this._handle.classList.add(mt["trading-panel-handle"]),this.rootContainer.appendChild(this._handle),this._handle.addEventListener("mousedown",this._onLayoutResizeHandleMousedown,{passive:!1}),this._handle.addEventListener("touchstart",this._onLayoutResizeHandleMousedown,{passive:!1}),this._panelWidth=n.getInt(ge.settingsKeys.PANEL_WIDTH)||fe.minPanelWidth}_addCover(){this._coverContainer=document.createElement("div"),this._coverContainer.classList.add(mt.cover),this.rootContainer.appendChild(this._coverContainer)}_togglePanel(e,t=!0){this._resizerBridge.negotiateWidth(e?this._panelWidth:0),this._resizerBridge.negotiateHeight(e?fe.panelHeight:0),this.rootContainer.classList.toggle(mt.hidden,!e),this._shouldPersistOrderPanelState&&t&&n.setValue(ge.settingsKeys.TRADING_PANEL_VISIBLE,e)}_updateOpeningAvailability(){const e="visible"!==document.visibilityState||this._resizerBridge.visible.value();this.isOpeningAvailable.setValue(Boolean(e&&this._isPanelCanBeOpened&&this._resizerBridge.availHeight.value()>=fe.panelHeight&&this._resizerBridge.availWidth.value()>=this._panelWidth))}_subscribeVisibility(){this._updateOpeningAvailability(),this._resizerBridge.visible.subscribe((()=>{this._updateOpeningAvailability()})),this._resizerBridge.availHeight.subscribe((()=>{this._updateOpeningAvailability()})),this._resizerBridge.availWidth.subscribe((()=>{this._updateOpeningAvailability()}))}_requestWidth(e){this._canResizeWidth(e)&&this._resizerBridge.width.value()!==e&&(this._resizerBridge.negotiateWidth([{min:fe.minPanelWidth,max:e}]),this._panelWidth=e)}_canResizeWidth(e){return e+45<=this._resizerBridge.availWidth.value()}}var ft=i(707973);const Pt=(0,$.getLogger)("Chart.PointsetManager");let St=0;class kt{constructor(e,t,i,s,r){this._currentPointsetId=null,this._onUpdate=new F.Delegate,this._requestPoints=[],this._gateway=e,this._pointsetSuffix=t,this._isGatewayConnected=this._gateway.isConnected().spawn(),this._isGatewayConnected.subscribe(this._updateByGatewayConnection.bind(this)),this._addPoints(i,s,r)}onUpdate(){return this._onUpdate}destroy(){
this._isGatewayConnected.value()&&null!==this._currentPointsetId&&this._gateway.removePointset(this._currentPointsetId),this._requestPoints=[],this._currentPointsetId=null,this._isGatewayConnected.destroy()}_updateByGatewayConnection(e){e||(this._currentPointsetId=null,this._requestPoints=[])}_addPoints(e,t,i){var r,o;this._isGatewayConnected.value()&&((0,s.assert)(e.length>0,"Can't possible create point set for empty array of time points"),this._requestPoints=e.map((e=>[e.time_t,e.offset])),this._currentPointsetId=(r=this._pointsetSuffix,o=++St,`pointset_${r}_${o}`),this._gateway.createPointset(this._currentPointsetId,"turnaround",t,(0,ft.getServerInterval)(i),this._requestPoints,this._onMessage.bind(this)))}_onMessage(e){switch(e.method){case"pointset_error":Pt.logNormal(`Pointset error with id ${e.params[0]} turnaround ${e.params[1]}`);break;case"data_update":{const t=[];for(const i of e.params.plots)t.push({time_t:this._requestPoints[i.index][0],index:i.value[0],barTime:i.value[1]});this._onUpdate.fire(t);break}}}}var Ct=i(90461),Tt=i(236941),wt=i(993545);const Bt=(0,$.getLogger)("Trading.Executions");function Ot(e){const t=e.mainSeries().data().first();return null===t?null:t.value[0]}async function Mt(e,t,s){const[r,o,n]=await Promise.all([Promise.all([i.e(5018),i.e(4587),i.e(8865),i.e(6775),i.e(2650)]).then(i.bind(i,930783)),Promise.all([i.e(5018),i.e(4587),i.e(8865),i.e(6775),i.e(2650)]).then(i.bind(i,643144)),Promise.all([i.e(5018),i.e(4587),i.e(8865),i.e(6775),i.e(2650)]).then(i.bind(i,561583))]);e.addCustomSource("executions",((e,i)=>{const a=i.mainSeries(),l=a.dataEvents(),d=(0,Tt.createPrimitivePropertyFromWatchedValue)(i.isInReplay().weakReference()),u=(0,Ct.createPrimitivePropertyFromGetterAndSubscription)((()=>a.isConvertedToOtherCurrency()||a.isConvertedToOtherUnit()),a.symbolResolved()),c={arrowVisibility:(0,Ct.combineProperty)(((e,t,i)=>i&&!t),d.ownership(),u.ownership(),i.properties().childs().tradingProperties.childs().showExecutions.weakReference()),labelVisibility:i.properties().childs().tradingProperties.childs().showExecutionsLabels.weakReference()},h=function(e,t,i){return s=>{const r=i.seriesSource().symbolInstanceId(),o=i.interval();return null===r?null:new kt(e,t,s,r,o)}}(i.chartApi(),"executions",a),p=(0,Ct.createWVFromGetterAndSubscription)(Ot.bind(null,i),l.barReceived()),_=new r.ExecutionsService(t,l,function(e){return()=>{const t=e.symbolInfo();return null!==t?t.pro_name||t.full_name:e.proSymbol()}}(a)),g=new o.ExecutionsPointsManager(_,h,p),y=(0,wt.memoize)((e=>t.realtimeProvider().activeBroker()?.symbolInfo(e)));return new n.ExecutionsSource(e,i,c,s,g,(async e=>{const{symbol:i}=await t.getActualSymbol(e);try{if(null!==t.realtimeProvider().activeBroker()){const e=await y(i);return e?.minTick}}catch(t){return void Bt.logWarn(`Error fetching minTick for symbol: ${e} ${t}`)}}))}))}var Et,It=i(959026),Vt=i(687039),$t=i(50115),Dt=i(668167),Lt=i(932473),xt=i(144421),At=i(69111);function qt(){if((0,_e.isDesktopApp)())return"Desktop App";const e=(0,At.isOnMobileAppPage)("old")
;return _e.CheckMobile.isIPad()?e?"iPad App":"iPad Web":_e.CheckMobile.any()?_e.CheckMobile.Android()?(0,At.isOnMobileAppPage)("new")?"Android App":"Android Web":_e.CheckMobile.iOS()?e?"iPhone App":"iPhone Web":"Unknown Mobile Web":"Desktop Web"}!function(e){e.DesktopWeb="Desktop Web",e.DesktopApp="Desktop App",e.IPhoneWeb="iPhone Web",e.IPhoneApp="iPhone App",e.IPadWeb="iPad Web",e.IPadApp="iPad App",e.AndroidWeb="Android Web",e.AndroidApp="Android App",e.UnknownMobileWeb="Unknown Mobile Web"}(Et||(Et={}));const Rt=r.t(null,void 0,i(556445)),Ft=r.t(null,void 0,i(44402)),Nt=r.t(null,void 0,i(606569)),Qt=r.t(null,void 0,i(659707)),Ut=r.t(null,void 0,i(316183)),Wt=r.t(null,void 0,i(598721)),zt=x.enabled("broker_button");class jt{constructor({dataEvents:e,getSymbolName:t,isNonTradableInstrument:i,qtySuggester:s,tradingCommands:r,settings:o,hibernated:n,orderPresetsManager:a}){this.ask=new R.WatchedValue(null),this.nonTradableAskTooltip=new R.WatchedValue(void 0),this.bid=new R.WatchedValue(null),this.nonTradableBidTooltip=new R.WatchedValue(void 0),this.spread=new R.WatchedValue(null),this.spreadTooltip=new R.WatchedValue(Qt),this.qty=new R.WatchedValue(null),this.qtyTooltip=new R.WatchedValue(""),this.brokerIconVisible=new R.WatchedValue(!1),this.brokerIconLoading=new R.WatchedValue(!1),this.brokerIconUrl=new R.WatchedValue(null),this.isQtyVisible=new R.WatchedValue(!1),this.hasAskBidAdditionalPrecision=new R.WatchedValue(!1),this.canTrade=new R.WatchedValue(!0),this._isSymbolTradableResult=new Dt.WatchedObject(null),this._formatter=null,this._spreadFormatter=null,this._symbol=null,this._abortController=new AbortController,this.setQty=e=>{this.qty.setValue(String(e))},this._createTradedSymbol=()=>{const e=this._getSymbolName();this._symbolChangeSubscription?.unsubscribe(),this._clearTradedSymbol(),e.length>0&&this._initTradedSymbol(e)},this._onSuggestedQtyChange=e=>{this._lastSuggestedQty=e,this.setQty(e)},this._updateIsSymbolTradable=async e=>{if(null===this._symbol)return void this._isSymbolTradableResult.setValue(null);const t=await this._realtimeProvider.isTradable(this._symbol);e?.aborted||this._isSymbolTradableResult.setValue((0,xt.clone)(t))},this._updateOrderPresetsManagerConsumer=async e=>{},this._updateIsSymbolTradable=(0,U.respectLatest)(this._updateIsSymbolTradable),this._updateOrderPresetsManagerConsumer=(0,U.respectLatest)(this._updateOrderPresetsManagerConsumer);const{noConfirmEnabled:l,showSellBuyButtons:d,themeName:u,visuallyHidden:c}=o;this._isInstantMode=l,this._dataEvents=e,this._getSymbolName=t,this._qtySuggester=s,this._realtimeProvider=r.realtimeProvider,this._onNeedSelectBroker=r.onNeedSelectBroker,this._toggleTradingWidget=()=>r.toggleTradingWidget("chart_buy_sell_buttons"),this._toggleTradingPanelPopup=()=>r.toggleTradingPanelPopup("chart_buy_sell_buttons"),this._brokerCommandsUI=r.brokerCommandsUI,this._makeActualTradingSymbolObservable=r.makeActualSymbolObservable,this._trackOrderPresetSnowplowEvent=r.trackOrderPresetSnowplowEvent,
this._updateRealtimeDataHandler=this._updateRealtimeData.bind(this),this._isBrokerConnected=(0,Ct.createWVFromGetterAndSubscription)((()=>null!==this._realtimeProvider.activeBroker()),this._realtimeProvider.onStatusChanged),this._isBrokerConnected.subscribe(this._updateQtyTooltip.bind(this),{callWithLast:!0}),this._isBrokerConnected.subscribe(this._updateBrokerIcon.bind(this)),this._isBrokerConnected.subscribe(this._createTradedSymbol),this._isBrokerConnecting=(0,Ct.createWVFromGetterAndSubscription)((()=>2===r.brokerConnectionStatus()),r.onBrokerConnectionStatusChange),this._isBrokerConnecting.subscribe(this._updateBrokerIcon.bind(this)),this.visible=(0,q.combine)(((e,t,i,s)=>s?e&&!t&&!i&&function(){const e=qt();return"Desktop App"===e||"Desktop Web"===e||"iPad Web"===e}():e&&!t&&!i),d.weakReference(),i.weakReference(),c.weakReference(),r.isInReplay().weakReference()),this._enabled=(0,q.combine)(((e,t)=>e&&!t),this.visible.weakReference(),n.ownership()),this._enabled.subscribe(this._toggleState.bind(this),{callWithLast:!0}),this._themeName=u,this._themeName.subscribe(this._updateBrokerIcon.bind(this),{callWithLast:!0}),this._tradePossibilityComputedWV=(0,q.combine)((()=>({})),this._isBrokerConnected.weakReference(),this._isSymbolTradableResult.weakReference(),this.ask.weakReference(),this.bid.weakReference()),this._tradePossibilityComputedWV.subscribe(this._updateTradePossibilityAndTooltip.bind(this),{callWithLast:!0}),this._isQtyVisibleComputedWV=(0,q.combine)(((e,t)=>({})),this.canTrade.weakReference(),this._isInstantMode.weakReference()),this._isQtyVisibleComputedWV.subscribe(this._updateIsQtyVisible.bind(this),{callWithLast:!0})}destroy(){this._abortController?.abort(),this._abortController=null,this._stop(),this._isBrokerConnected.destroy(),this._isInstantMode.release(),this._tradePossibilityComputedWV.destroy(),this._isQtyVisibleComputedWV.destroy(),this._themeName.release(),this._isBrokerConnecting.destroy(),this._enabled.destroy(),this._orderPresetsManagerConsumer$?.value?.destroy(),this.visible.destroy()}async tryToPlaceSellOrder(){const e=this._currentQuotes;void 0!==e&&await this._tryToPlaceOrder((0,O.getBid)(e),-1)}async tryToPlaceBuyOrder(){const e=this._currentQuotes;void 0!==e&&await this._tryToPlaceOrder((0,O.getAsk)(e),1)}async getQtyInfo(){return null!==this._symbol&&this.canTrade.value()?(await this._realtimeProvider.symbolInfo(this._symbol)).qty:null}applyQty(){if(null===this._symbol||!this.canTrade.value())return;const e=this.qty.value(),t=null!==e?Number(e):null;null!==t&&this._qtySuggester.setQty(this._symbol,t),void 0!==this._lastSuggestedQty&&t!==this._lastSuggestedQty&&this.qty.setValue(String(this._lastSuggestedQty))}canShowMobileTrading(){return!window.TradingView.bottomWidgetBar?.isVisible().value()}async _tryToPlaceOrder(e,t){if(null===this._realtimeProvider.activeBroker())return this.canShowMobileTrading()?this._toggleTradingPanelPopup():await this._toggleTradingWidget(),void this._onNeedSelectBroker.fire()
;const i=Number(this.qty.value())||1,r=this._orderPresetsManagerConsumer$?.getValue();r?.activePreset();{const r=this._isMarketOrderSupported()?2:1,o=1===t?this._currentQuotes?.ask:this._currentQuotes?.bid,n={symbol:(0,s.ensureNotNull)(this._symbol),qty:i,side:t,type:r,seenPrice:o??null,currentQuotes:this._currentQuotes};1===r&&(n.limitPrice=e),await(0,s.ensureNotNull)(this._brokerCommandsUI()).placeOrder(n,!0)}}_toggleState(e){e?this._start():this._stop()}_start(){this._dataEvents.symbolResolved().subscribe(this,this._createTradedSymbol),this._dataEvents.symbolError().subscribe(this,this._createTradedSymbol),this._createTradedSymbol()}_stop(){this._symbolChangeSubscription?.unsubscribe(),this._clearTradedSymbol(),this._symbol=null,this._dataEvents.symbolResolved().unsubscribeAll(this),this._dataEvents.symbolError().unsubscribeAll(this)}_initTradedSymbol(e){this._symbol=e,this._updateIsSymbolTradable(this._abortController?.signal??null),this._updateOrderPresetsManagerConsumer(this._abortController?.signal??null),this._realtimeProvider.subscribeRealtime(this._symbol,this._updateRealtimeDataHandler),this._resubscribeQtySuggester()}_clearTradedSymbol(){this._currentQuotes=void 0,this.ask.setValue(null),this.bid.setValue(null),this.spread.setValue(null),this.qty.setValue(null),null!==this._symbol&&(this._realtimeProvider.unsubscribeRealtime(this._symbol,this._updateRealtimeDataHandler),this._qtySuggesterSubscription?.unsubscribe(),this._symbol=null,this._updateIsSymbolTradable(this._abortController?.signal??null),this._updateOrderPresetsManagerConsumer(this._abortController?.signal??null))}async _resubscribeQtySuggester(){const e=this._symbol;if(null===e)return;this._qtySuggesterSubscription?.unsubscribe();const t=this._suggestedQtyPromise=this._qtySuggester.getQty(e),i=await t;t===this._suggestedQtyPromise&&e===this._symbol&&(this._lastSuggestedQty=i,this.setQty(i),this._qtySuggesterSubscription=this._qtySuggester.suggestedQtyChanged(e).subscribe(this._onSuggestedQtyChange))}_isMarketOrderSupported(){const e=this._realtimeProvider.activeBroker();return null===e||Boolean(e.metainfo().configFlags.supportMarketOrders)}_updateTradePossibilityAndTooltip(){this._updateCanTrade(),this._updateSellBuyTooltip()}_updateCanTrade(){const e=this._isSymbolTradableResult.value(),t=this._isBrokerConnected.value()&&null!==e&&e.tradable;this.canTrade.setValue(t)}_updateSellBuyTooltip(){const e=this._getNonTradedTooltip();this.nonTradableAskTooltip.setValue(e??this._getNonTradableAskTooltip()),this.nonTradableBidTooltip.setValue(e??this._getNonTradableBidTooltip())}_getNonTradedTooltip(){const e=this._isSymbolTradableResult.value();if(this._isBrokerConnected.value()&&null!==e&&!e.tradable)return void 0!==e.solutions?"":void 0!==e.shortReason&&""!==e.shortReason?e.shortReason:Rt}_getNonTradableAskTooltip(){return null===this.ask.value()?Nt:void 0}_getNonTradableBidTooltip(){return null===this.bid.value()?Ft:void 0}_updateRealtimeData(e,t,i){this._formatter=i.formatter,this._spreadFormatter=i.spreadFormatter;const s=t.ask,r=t.bid,o=(0,
u.isNumber)(s),n=(0,u.isNumber)(r),a=o?this._formatter.format(s):null,l=n?this._formatter.format(r):null;this.ask.setValue(a),this.bid.setValue(l),o&&n&&(this._currentQuotes={ask:s,bid:r});const d=t.spread||(0,u.isNumber)(s)&&(0,u.isNumber)(r)&&s-r||0,c=(0,u.isNumber)(t.spread)?this._spreadFormatter:this._formatter;this.spread.setValue(c.format(d));let h=!1;(0,Lt.isFormatterHasForexAdditionalPrecision)(this._formatter)&&(h=this._formatter.hasForexAdditionalPrecision()),this.hasAskBidAdditionalPrecision.setValue(h)}_updateIsQtyVisible(){const e=this._isInstantMode.value()&&this.canTrade.value();this.isQtyVisible.setValue(e)}_updateQtyTooltip(){this.qtyTooltip.setValue(this._getQtyTooltip())}_getQtyTooltip(){const e=this._realtimeProvider.activeBroker();return null!==e&&e.metainfo().configFlags.showQuantityInsteadOfAmount?Wt:Ut}_updateBrokerIcon(){if(!zt)return;let e;const t=this._realtimeProvider.activeBroker();if(null!==t){const i=t.metainfo();e="dark"===this._themeName.value()&&i.logoMiniBlackUrl?i.logoMiniBlackUrl:i.logoMiniUrl}this.brokerIconVisible.setValue(this._isBrokerConnected.value()),this.brokerIconLoading.setValue(this._isBrokerConnecting.value()),this.brokerIconUrl.setValue(e||null)}}var Ht=i(243716),Gt=i(653788),Kt=i(383326),Yt=i(920057),Xt=i(190787),Jt=i(972535),Zt=i(724377),ei=i(752509),ti=i(72304),ii=i(903963),si=i(672511);const ri=(0,i(497560).reactLoaderRendererCreator)(si.Spinner,{size:"xxsmall"});var oi=i(175472),ni=i(765296);var ai=i(953757),li=i(896009),di=i(624092);i(642714);const ui=r.t(null,void 0,i(99234)),ci=r.t(null,void 0,i(527953)),hi=150,pi=e=>{const{sellButtonEl:t,buyButtonEl:i,nonTradableAskTooltip:s,nonTradableBidTooltip:r,orderPreset:o}=e,n=!r,a=!s,{open:l,close:d,visible:u}=(0,ai.useTooltipState)({openDelay:hi,closeDelay:hi}),{open:c,close:h,visible:p}=(0,ai.useTooltipState)({openDelay:hi,closeDelay:hi});(0,W.useEffect)((()=>{function e(e,t,i){return e.addEventListener("mouseenter",t),e.addEventListener("mouseleave",i),()=>{e.removeEventListener("mouseenter",t),e.removeEventListener("mouseleave",i)}}const s=e(t,c,h),r=e(i,l,d);return()=>{s(),r()}}),[t,i,c,h,l,d]);const _=p&&""!==r,g=u&&""!==s;return W.createElement(W.Fragment,null,W.createElement(di.TooltipStateless,{id:"sell-button-order-preset-tooltip",anchor:{current:t},content:W.createElement(_i,{defaultTooltip:ci,orderPreset:o,nonTradableTooltip:r}),endSlot:n?W.createElement(W.Fragment,null,W.createElement(li.HotkeyBox,{keyboardKey:"Shift"}),W.createElement(li.HotkeyBox,{keyboardKey:"S"})):void 0,open:_,onClose:h,placement:"bottom"}),W.createElement(di.TooltipStateless,{id:"buy-button-order-preset-tooltip",anchor:{current:i},content:W.createElement(_i,{defaultTooltip:ui,orderPreset:o,nonTradableTooltip:s}),endSlot:a?W.createElement(W.Fragment,null,W.createElement(li.HotkeyBox,{keyboardKey:"Shift"}),W.createElement(li.HotkeyBox,{keyboardKey:"B"})):void 0,open:g,onClose:d,placement:"bottom"}))},_i=e=>{const{defaultTooltip:t,orderPreset:i,nonTradableTooltip:s}=e
;return s?W.createElement(W.Fragment,null,s):W.createElement(W.Fragment,null,t)};class gi{constructor(e){this.setActiveOrderPreset=e=>{this._orderPreset=e??void 0,this._update()},this.setNonTradableAskTooltip=e=>{this._nonTradableAskTooltip=e,this._update()},this.setNonTradableBidTooltip=e=>{this._nonTradableBidTooltip=e,this._update()};const{sellButtonEl:t,buyButtonEl:i}=e;this._sellButtonEl=t,this._buyButtonEl=i,this._containerEl=document.createElement("div");const{render:s,unmount:r}=function(e,t){const i=(0,le.createReactRoot)(W.createElement(pi,{...t}),e,"modern");return{render:function(e){i.render(W.createElement(pi,{...e}))},unmount:function(){i.unmount()}}}(this._containerEl,{sellButtonEl:this._sellButtonEl,buyButtonEl:this._buyButtonEl});this._unmountFn=r,this._renderFn=s}destroy(){this._unmountFn(),this._containerEl.remove()}_update(){this._renderFn({sellButtonEl:this._sellButtonEl,buyButtonEl:this._buyButtonEl,nonTradableAskTooltip:this._nonTradableAskTooltip,nonTradableBidTooltip:this._nonTradableBidTooltip,orderPreset:this._orderPreset})}}var yi=i(704609),bi=i(233465),mi=i(189369),vi=i(829883);const fi=parseInt(mi["css-value-padding"]),Pi=r.t(null,void 0,i(168222)),Si=r.t(null,void 0,i(169961));var ki;!function(e){e.BidAskDefaultText="...",e.TrackEventOrigin="Sell/Buy Buttons"}(ki||(ki={}));const Ci=!1,Ti=e=>e?.stopPropagation();function wi(e,t){const i=document.createElement("span");i.append(t),i.classList.add(yi.title),e.appendChild(i)}function Bi(e){const{el:t,text:i,isLastCharSup:r,title:o}=e,n=t.querySelector(`.${yi.buttonText}`);if(!n)return;let a=t.querySelector(`.${yi.lastCharSup}`);const l=t.querySelector(`.${yi.title}`);if(null!==l&&l.remove(),!r)return null!==a&&a.remove(),(0,Xt.updateTextNode)(n,i),void(null!==o&&wi(t,o));null===a&&(a=document.createElement("span"),a.classList.add(yi.lastCharSup),n.appendChild(a)),(0,Xt.updateTextNode)((0,s.ensureNotNull)(a),i.slice(-1)),(0,Xt.updateTextNode)(n,i.slice(0,-1)),null!==o&&wi(t,o)}var Oi,Mi;!function(e){e[e.Hidden=0]="Hidden",e[e.Column=1]="Column",e[e.Row=2]="Row"}(Oi||(Oi={})),function(e){e[e.Width=567]="Width",e[e.Height=440]="Height"}(Mi||(Mi={}));class Ei{constructor({model:e,instantMode:t,trackEvent:i,toggleMinimizeBottomWidgetBar:s,backgroundTopColor:r,onCalculatorOpened:o,trackOrderPresetSnowplowEvent:n}){this.element=document.createElement("div"),this._buttonsWrapperEl=document.createElement("div"),this._informerWrapperEl=null,this._sellButtonEl=document.createElement("div"),this._sellButtonTextEl=document.createElement("span"),this._buyButtonEl=document.createElement("div"),this._buyButtonTextEl=document.createElement("span"),this._spreadQtyWrapper=document.createElement("div"),this._spreadEl=document.createElement("div"),this._qtyEl=document.createElement("div"),this._qtyTextEl=document.createElement("span"),this._brokerButtonEl=document.createElement("div"),this._brokerIconWrapEl=document.createElement("div"),this._sellBuyAndPresetsButtonsContainerEl=document.createElement("div"),
this._sellBuyButtonsContainerEl=document.createElement("div"),this._sellTitle=Pi,this._buyTitle=Si,this._isCalcOpened=!1,this._calcContainer=document.createElement("div"),this._sellLoader=(0,ii.createPointsLoaderRenderer)(this._sellButtonEl,{className:yi.loader}),this._buyLoader=(0,ii.createPointsLoaderRenderer)(this._buyButtonEl,{className:yi.loader}),this._brokerLoader=ri(this._brokerButtonEl,{className:yi.circleLoader}),this._windowResizeHandlerThrottle=(0,Yt.default)(this._windowResizeHandler.bind(this),100),this._isHiddenByViewport=!1,this._mode=2,this._height=new R.WatchedValue(0),this._resizeObserver=null,this._cachedBreakPoints={},this._parentWidth=0,this._destroyTradingInformer=null,this._setButtonsTitles=e=>{const t=this._sellButtonTextEl.querySelector(`.${yi.title}`),i=this._buyButtonTextEl.querySelector(`.${yi.title}`);this._sellTitle=e||Pi,this._buyTitle=e||Si,t&&(t.innerHTML=this._sellTitle),i&&(i.innerHTML=this._buyTitle)},this._changeOrderPresetsManagerConsumerHandler=e=>{this._orderPresetsMenuRenderer?.destroy(),this._activeOrderPresetSubscription?.unsubscribe(),this._setButtonsTitles(),e&&(this._mountOrderPresetsMenu(e),this._activeOrderPresetSubscription=e.activePreset$.subscribe((e=>{const t=e?.metainfo?.title;this._setButtonsTitles(t),this._sellBuyButtonsTooltipsRenderer?.setActiveOrderPreset(e)})))},this._handleBackgroundTopColorUpdate=e=>{const t=this._makeBackgroundColor(e);this._orderPresetsMenuRenderer&&this._orderPresetsMenuRenderer.updateButtonColor(t),null!==this._qtyEl&&(e?this._qtyEl.style.setProperty("--inline-background",t):this._qtyEl.style.removeProperty("--inline-background"))},this._getCurrentQty=()=>{const e=this._qty.value();return null!==e?Number(e):null},this._sellButtonEl.dataset.name="sell-order-button",this._buyButtonEl.dataset.name="buy-order-button",this._model=e,this._toggleMinimizeBottomWidgetBar=s,this._onCalculatorOpened=o,this._backgroundTopColor=r.spawn(),this._backgroundTopColor.subscribe(this._handleBackgroundTopColorUpdate),this._handleBackgroundTopColorUpdate(this._backgroundTopColor.value()),this._ask=this._model.ask.spawn(),this._ask.subscribe(this._updateBuyButton.bind(this)),this._bid=this._model.bid.spawn(),this._bid.subscribe(this._updateSellButton.bind(this)),this._spread=this._model.spread.spawn(),this._spread.subscribe(this._updateSpread.bind(this)),this._qty=this._model.qty.spawn(),this._qty.subscribe(this._updateQty.bind(this)),this._brokerIconVisible=this._model.brokerIconVisible.spawn(),this._brokerIconLoading=this._model.brokerIconLoading.spawn(),this._brokerIconUrl=this._model.brokerIconUrl.spawn(),x.enabled("trading_account_manager")&&(this._brokerIconVisible.subscribe(this._updateBrokerIconImage.bind(this)),this._brokerIconLoading.subscribe(this._updateBrokerIconImage.bind(this)),this._brokerIconUrl.subscribe(this._updateBrokerIconImage.bind(this),{callWithLast:!0})),this._trackEvent=i,this._trackOrderPresetSnowplowEvent=n,this._initTooltips(),this._render(),this._spreadTooltip=this._model.spreadTooltip.spawn(),
this._spreadTooltip.subscribe(this._updateButtonTooltip.bind(this,this._spreadEl),{callWithLast:!0}),this._qtyTooltip=this._model.qtyTooltip.spawn(),this._qtyTooltip.subscribe(this._updateButtonTooltip.bind(this,this._qtyEl),{callWithLast:!0}),this._canTrade=this._model.canTrade.spawn(),this._canTrade.subscribe(this._updateBgButtonsMode.bind(this),{callWithLast:!0}),this._isVisible=this._model.visible.spawn(),this._isVisible.subscribe(this._updateVisibility.bind(this),{callWithLast:!0}),this._isQtyVisible=this._model.isQtyVisible.spawn(),this._isQtyVisible.subscribe(this._updateQtyVisibility.bind(this),{callWithLast:!0}),this._isLastDigitSup=this._model.hasAskBidAdditionalPrecision.spawn(),this._isLastDigitSup.subscribe(this._updateLastDigitSup.bind(this)),this._instantMode=t.spawn(),this._sellButtonHandler=this._onSellButton.bind(this),this._buyButtonHandler=this._onBuyButton.bind(this),this._qtyHandler=this._toggleCalcVisibility.bind(this),this._brokerButtonHandler=this._onBrokerButton.bind(this),this._sellButtonEl.addEventListener("click",this._sellButtonHandler),this._buyButtonEl.addEventListener("click",this._buyButtonHandler),this._qtyEl.addEventListener("click",this._qtyHandler),this._brokerButtonEl.addEventListener("click",this._brokerButtonHandler),window.addEventListener("resize",this._windowResizeHandlerThrottle),this._windowResizeHandler()}destroy(){this._ask.destroy(),this._nonTradableAskTooltip?.destroy(),this._bid.destroy(),this._nonTradableBidTooltip?.destroy(),this._spread.destroy(),this._spreadTooltip.destroy(),this._qty.destroy(),this._qtyTooltip.destroy(),this._isVisible.destroy(),this._isQtyVisible.destroy(),this._isLastDigitSup.destroy(),this._instantMode.destroy(),this._backgroundTopColor.destroy(),this._canTrade.destroy(),this._brokerIconUrl.destroy(),this._sellLoader.destroy(),this._buyLoader.destroy(),this._brokerLoader.destroy(),this._orderPresetsMenuRenderer?.destroy(),this._sellBuyButtonsTooltipsRenderer?.destroy(),this._activeOrderPresetSubscription?.unsubscribe?.(),this._orderPresetsManagerConsumerSubscription?.unsubscribe(),this._sellButtonEl.removeEventListener("click",this._sellButtonHandler),this._buyButtonEl.removeEventListener("click",this._buyButtonHandler),this._qtyEl.removeEventListener("click",this._qtyHandler),this._brokerButtonEl.removeEventListener("click",this._brokerButtonHandler),this._resizeObserver?.disconnect(),this._resizeObserver=null,this._destroyTradingInformer?.(),this.element.remove(),delete this.element,window.removeEventListener("resize",this._windowResizeHandlerThrottle)}updateModeByWidth(e){const t=this._cachedBreakPoints[0],i=this._cachedBreakPoints[1],s=this._mode;this._mode=void 0!==t&&e<t?0:void 0!==i&&e<i?1:2,this._parentWidth=e;const r=1===this._mode;s!==this._mode&&(this._informerWrapperEl?.removeEventListener("click",Ti),this._informerWrapperEl?.remove(),this._initTradingInformer()),this._buttonsWrapperEl.classList.toggle(yi.column,r),this._informerWrapperEl?.classList.toggle(yi.column,r),this._updateVisibility()}height(){return this._height}
renderTo(e,t){void 0!==t?e.insertBefore(this.element,t):e.appendChild(this.element),null===this._resizeObserver&&(this._resizeObserver=new ResizeObserver(this._updateBreakPointsAndSize.bind(this))),this._resizeObserver.unobserve(this.element),this._resizeObserver.observe(this.element)}isHiddenByViewport(){return this._isHiddenByViewport}_render(){const e=document.createElement("span");e.classList.add(yi.buttonText),e.append(this._bid.value()||"..."),this._sellButtonTextEl.appendChild(e),this._bid.value()&&wi(this._sellButtonTextEl,this._sellTitle),this._sellButtonTextEl.classList.add(yi.buttonTextWrapper),this._sellButtonEl.append(this._sellButtonTextEl),this._sellButtonEl.classList.add("apply-common-tooltip",yi.button,yi.sellButton);const t=this._spread.value()||"";this._spreadEl.appendChild(document.createTextNode(String(t))),this._spreadEl.classList.add("apply-common-tooltip",yi.spread);const i=this._qty.value()||"";this._qtyTextEl.appendChild(document.createTextNode(i)),this._qtyEl.append(this._qtyTextEl),this._qtyEl.setAttribute("data-name","qtyEl"),this._qtyEl.classList.add("apply-common-tooltip",yi.button,yi.qty),this._spreadQtyWrapper.classList.add(yi.spreadQtyWrapper),this._spreadQtyWrapper.appendChild(this._spreadEl),this._spreadQtyWrapper.appendChild(this._qtyEl);const s=document.createElement("span");s.classList.add(yi.buttonText),s.append(this._ask.value()||"..."),this._buyButtonTextEl.appendChild(s),this._ask.value()&&wi(this._buyButtonTextEl,this._buyTitle),this._buyButtonTextEl.classList.add(yi.buttonTextWrapper),this._buyButtonEl.append(this._buyButtonTextEl),this._buyButtonEl.classList.add("apply-common-tooltip",yi.button,yi.buyButton),this._brokerButtonEl.appendChild(this._brokerIconWrapEl),this._brokerIconWrapEl.classList.add(yi.brokerButtonIconWrap),this._brokerButtonEl.classList.add(yi.brokerButton),this._sellBuyAndPresetsButtonsContainerEl.classList.add(yi.sellBuyAndPresetsButtonsContainer),this._sellBuyButtonsContainerEl.classList.add(yi.sellBuyButtonsContainer),this._sellBuyButtonsContainerEl.appendChild(this._sellButtonEl),this._sellBuyButtonsContainerEl.appendChild(this._spreadQtyWrapper),this._sellBuyButtonsContainerEl.appendChild(this._buyButtonEl),this._sellBuyAndPresetsButtonsContainerEl.appendChild(this._sellBuyButtonsContainerEl),this._buttonsWrapperEl.appendChild(this._sellBuyAndPresetsButtonsContainerEl),this._buttonsWrapperEl.appendChild(this._brokerButtonEl),this._buttonsWrapperEl.classList.add(yi.buttonsWrapper),this._buttonsWrapperEl.classList.toggle(yi.touchMode,oi.trackingModeIsAvailable),this._buttonsWrapperEl.classList.toggle(yi.notAvailableOnMobile,Ci),this.element.appendChild(this._buttonsWrapperEl),this._initTradingInformer(),this.element.classList.add(yi.container)}_initTooltips(){Jt.mobiletouch||(this._sellBuyButtonsTooltipsRenderer=new gi({sellButtonEl:this._sellButtonEl,buyButtonEl:this._buyButtonEl}),this._nonTradableAskTooltip=this._model.nonTradableAskTooltip.spawn(),
this._nonTradableAskTooltip.subscribe((e=>this._sellBuyButtonsTooltipsRenderer?.setNonTradableAskTooltip(e)),{callWithLast:!0}),this._nonTradableBidTooltip=this._model.nonTradableBidTooltip.spawn(),this._nonTradableBidTooltip.subscribe((e=>this._sellBuyButtonsTooltipsRenderer?.setNonTradableBidTooltip(e)),{callWithLast:!0}))}_mountOrderPresetsMenu(e){}_initTradingInformer(){0}_updateBreakPointsAndSize(e){const t=e[0],i=2*fi;2===this._mode&&(this._cachedBreakPoints[1]=Math.round(t.contentRect.width)+i),1===this._mode&&(this._cachedBreakPoints[0]=Math.round(t.contentRect.width)+i),this.updateModeByWidth(this._parentWidth);const s=t.contentRect.height>0?Math.round(t.contentRect.height)+i:0;this._height.setValue(s)}_updateBrokerIconImage(){const e=this._brokerIconLoading.value(),t=!this._brokerIconVisible.value()&&!e;if(this._brokerButtonEl.classList.toggle(bi.blockHidden,t),t)return;if(this._toggleLoaderVisibility(this._brokerButtonEl,this._brokerLoader,e),e)return void(this._brokerIconWrapEl.innerHTML="");const i=this._brokerIconUrl.value(),s=null===i;this._brokerIconWrapEl.innerHTML=s?vi:`<image src="${i}" alt="Account Manager" />`,this._brokerButtonEl.classList.toggle(yi.brokerButtonDefault,s)}_makeBackgroundColor(e){const[t,i,s]=(0,Zt.parseRgb)(e);return(0,Zt.rgbaToString)([t,i,s,(0,Zt.normalizeAlphaComponent)(.8)])}async _onSellButton(){if(null===this._bid.value())return;const e=this._instantMode.value();this._trackEvent("Sell/Buy Buttons","Sell",e?"Instant":"Not Instant"),e&&this._canTrade.value()&&this._toggleLoaderVisibility(this._sellButtonEl,this._sellLoader,!0),await this._model.tryToPlaceSellOrder(),e&&this._canTrade.value()&&setTimeout((()=>this._toggleLoaderVisibility(this._sellButtonEl,this._sellLoader,!1)),300)}async _onBuyButton(){if(null===this._ask.value())return;const e=this._instantMode.value();this._trackEvent("Sell/Buy Buttons","Buy",e?"Instant":"Not Instant"),e&&this._canTrade.value()&&this._toggleLoaderVisibility(this._buyButtonEl,this._buyLoader,!0),await this._model.tryToPlaceBuyOrder(),e&&this._canTrade.value()&&setTimeout((()=>this._toggleLoaderVisibility(this._buyButtonEl,this._buyLoader,!1)),300)}_onBrokerButton(){this._model.canShowMobileTrading()?async function(){(await(0,ni.waitTradingService)()).tradingPanelPopup.show()}():this._toggleMinimizeBottomWidgetBar()}_toggleLoaderVisibility(e,t,i){e.classList.toggle(yi.loading,i),t.toggleVisibility(i)}_updateBuyButton(e){const t=null!==e&&this._isLastDigitSup.value();Bi({el:this._buyButtonTextEl,text:`${e||"..."}`,isLastCharSup:t,title:e?this._buyTitle:null})}_updateSellButton(e){const t=null!==e&&this._isLastDigitSup.value();Bi({el:this._sellButtonTextEl,text:`${e||"..."}`,isLastCharSup:t,title:e?this._sellTitle:null})}_updateSpread(e){const t=`${e||""}`;(0,Xt.updateTextNode)(this._spreadEl,t),this._updateVisibilityForSpreadQtyWrapper()}_updateQty(e){let t=`${e||""}`;!this._isCalcOpened&&t.length>0&&(t=(0,A.abbreviatedNumber)(Number(t))),(0,Xt.updateTextNode)(this._qtyTextEl,t)}_updateBgButtonsMode(e){
this._buttonsWrapperEl.classList.toggle(yi.withoutBg,!e),this._informerWrapperEl?.classList.toggle(bi.blockHidden,!e)}_updateVisibilityForSpreadQtyWrapper(){const e=!this._isQtyVisible.value()&&null===this._spread.value();this._spreadQtyWrapper.classList.toggle(bi.blockHidden,e)}_updateQtyVisibility(e){this._qtyEl.classList.toggle(bi.blockHidden,!e),this._spreadQtyWrapper.classList.toggle(yi.withoutQty,!e),this._updateVisibilityForSpreadQtyWrapper()}_updateVisibility(){const e=this._isVisible.value()&&0!==this._mode&&!this._isHiddenByViewport;this._buttonsWrapperEl.classList.toggle(bi.blockHidden,!e),this._informerWrapperEl?.classList.toggle(bi.blockHidden,!e||!this._canTrade.value())}_updateLastDigitSup(){this._updateBuyButton(this._ask.value()),this._updateSellButton(this._bid.value())}_updateButtonTooltip(e,t){if(""===t)return(0,ti.setTooltipData)(e,"text",t),void e.removeAttribute("title");e.setAttribute("title",t)}_toggleCalcVisibility(){this._isCalcOpened=!this._isCalcOpened,this._qtyEl.classList.toggle(yi.activeQty,this._isCalcOpened),this._renderCalc(),this._isCalcOpened&&this._onCalculatorOpened()}_closeCalc(){this._isCalcOpened=!1,this._updateQty(this._qty.value()),this._qtyEl.classList.remove(yi.activeQty),this._model.applyQty(),this._renderCalc()}_renderCalc(){Promise.all([i.e(1086),i.e(8894),i.e(5743),i.e(3329),i.e(9117),i.e(8490),i.e(6644),i.e(3250),i.e(7125),i.e(3809)]).then(i.bind(i,713191)).then((async e=>{const t=await this._model.getQtyInfo();null!==t&&e.render(this._isCalcOpened,this._calcContainer,{...t,withInput:!0,valueGetter:this._getCurrentQty,position:this._getCalcPosition(),targetEl:this._qtyEl,onClose:this._closeCalc.bind(this),onValueChange:this._model.setQty,trackEventTarget:"Sell/Buy Buttons",trackEvent:this._trackEvent})}))}_getCalcPosition(){return(0,ei.getPopupPositioner)(this._qtyEl,{horizontalAttachEdge:ei.HorizontalAttachEdge.Left,horizontalDropDirection:ei.HorizontalDropDirection.FromLeftToRight})}_windowResizeHandler(){const e=Ci;this._isHiddenByViewport!==e&&(this._isHiddenByViewport=e,this._updateVisibility())}}const Ii=r.t(null,void 0,i(411258));class Vi{constructor(e){const{chartModel:t,dataEvents:i,getSymbolName:s,isNonTradableInstrument:r,qtySuggester:o,tradingCommands:n,settings:a,hibernated:l,backgroundTopColor:d,orderPresetsManager:u}=e;this._chartModel=t,this._isNonTradableInstrument=r,this._trackEvent=n.trackEvent,this._model=new jt({dataEvents:i,getSymbolName:s,isNonTradableInstrument:r.spawnOwnership(),qtySuggester:o,tradingCommands:n,settings:a,hibernated:l,orderPresetsManager:u}),this._renderer=new Ei({model:this._model,instantMode:a.noConfirmEnabled.spawnOwnership(),trackEvent:n.trackEvent,toggleMinimizeBottomWidgetBar:n.toggleMinimizeBottomWidgetBar,backgroundTopColor:d,onCalculatorOpened:n.onCalculatorOpened,trackOrderPresetSnowplowEvent:n.trackOrderPresetSnowplowEvent})}destroy(){this._model.destroy(),this._renderer.destroy(),this._isNonTradableInstrument.release()}renderTo(e,t){this._renderer.renderTo(e,t)}visibility(){return this._model.visible}
updateWidgetModeBySize(e){this._renderer.updateModeByWidth(e.width)}contextMenuActions(){if(this._renderer.isHiddenByViewport())return[];const e=(0,Gt.getBuySellButtonsVisibility)(this._chartModel);return[new Ht.Action({actionId:"Trading.SellBuyButtonsToggleVisibility",options:{checkable:!0,checked:e.value(),label:Ii,statName:"ShowSellBuyTitle",disabled:this._isNonTradableInstrument.value(),onExecute:()=>{const t=!e.value();(0,Kt.setBuySellButtonsVisibility)(this._chartModel.undoModel(),t),this._trackEvent("SellBuyButtonsWidget context menu","Show Sell/Buy Button",t?"Check":"Uncheck")}}})]}height(){return this._renderer.height()}}function $i(e){return()=>{const t=e.symbolInfo();return null!==t?t.pro_name||t.full_name||t.name||"":e.proSymbol()}}var Di=i(749401),Li=i(265728),xi=i(233064),Ai=i(218286),qi=i(169977),Ri=i(38323),Fi=i(472484);var Ni=i(312694),Qi=i(825850),Ui=i(514970);class Wi{constructor(e){this._rawAndFilteredQtyMap=new Map,this._qtyInfo=new Map;const{symbolInfoGetter:t,onResetNeeded:i,qtySettingsStorageGetter:s}=e;this._getQtySettingsStorage=s,this._getSymbolInfo=t,i.subscribe(this,this._reset)}async getQty(e){return(0,Di.firstValueFrom)(this._getRawAndFilteredQty(e).filteredQty$)}setQty(e,t){this._getRawAndFilteredQty(e).rawQty$.next(t)}suggestedQtyChanged(e){return this._getRawAndFilteredQty(e).filteredQty$}_getRawAndFilteredQty(e){return this._rawAndFilteredQtyMap.get(e)??this._makeRawAndFilteredQty(e)}_makeRawAndFilteredQty(e){const t=new Li.ReplaySubject(1),i=this._getQtySettingsStorage(),s=this._getInitialQty(e).pipe((0,xi.switchMap)((e=>t.pipe((0,y.startWith)(e)))),(0,Ai.distinctUntilChanged)(),(0,qi.filter)((t=>this._isQtyCorrect(e,t))),(r=t=>i?.setSymbolQty(e,t),(a=(0,Ri.isFunction)(r)||o||n?{next:r,error:o,complete:n}:r)?(0,S.operate)((function(e,t){var i;null===(i=a.subscribe)||void 0===i||i.call(a);var s=!0;e.subscribe(new P.OperatorSubscriber(t,(function(e){var i;null===(i=a.next)||void 0===i||i.call(a,e),t.next(e)}),(function(){var e;s=!1,null===(e=a.complete)||void 0===e||e.call(a),t.complete()}),(function(e){var i;s=!1,null===(i=a.error)||void 0===i||i.call(a,e),t.error(e)}),(function(){var e,t;s&&(null===(e=a.unsubscribe)||void 0===e||e.call(a)),null===(t=a.finalize)||void 0===t||t.call(a)})))})):Fi.identity),(0,Ni.share)({connector:()=>new Li.ReplaySubject(1),resetOnRefCountZero:!1}));var r,o,n,a;const l={rawQty$:t,filteredQty$:s};return this._rawAndFilteredQtyMap.set(e,l),l}_isQtyCorrect(e,t){const i=(0,s.ensureDefined)(this._qtyInfo.get(e));return!(0,Ui.checkQtyError)(i,t,!0).res}_getInitialQty(e){return(0,v.from)(this._getSymbolInfo(e)).pipe((0,p.map)((({qty:t})=>{this._qtyInfo.set(e,t);const i=this._getQtySettingsStorage()?.symbolQty(e),s=t.default||t.min;return void 0!==i&&i>0?(r=(0,Qi.clamp)(i,t.min,t.max),o=t.min,n=t.step,w()(r).minus(o).div(n).round(0,1).mul(n).plus(o).toNumber()):(0,Ui.checkQtyError)(t,s,!0).res?t.min:s;var r,o,n})))}_reset(){this._rawAndFilteredQtyMap.forEach((({rawQty$:e})=>e.complete())),this._rawAndFilteredQtyMap.clear(),this._qtyInfo.clear()}}
var zi=i(650279);class ji{constructor(){this._context=null,this._onContextChanged=new F.Delegate,this._contextChange=()=>{this._onContextChanged.fire(this.context())}}context(){return this._context?.externalContext()??null}setContext(e,t){this._isEqualContexts(e)||(this._clearSubscription(),this._context=e,this._context?.onStatusChange().subscribe(this,this._contextChange),this._context?.onDataChange().subscribe(this,this._contextChange),t||this._contextChange())}onContextChanged(){return this._onContextChanged}clear(){this._context?.destroy(),this.setContext(null)}_clearSubscription(){this._context?.onDataChange().unsubscribeAll(this),this._context?.onStatusChange().unsubscribeAll(this)}_isEqualContexts(e){return null===this._context||null===e?this._context===e:this.context()?.type===e?.externalContext().type&&(this._context.status()===e.status()&&(0,zi.default)(this._context.errors(),e.errors())&&(0,zi.default)(this._context.data(),e.data()))}}var Hi=i(173587);const Gi=(0,$.getLogger)("Trading Linking");class Ki{constructor(e){this._onSymbolChange=e=>{this._processSymbol(null,e)},this._processSymbol=async(e,t)=>{if(void 0===this._continuousFrontContractExtractor)return void this._value.next({symbol:t});const i=this._continuousFrontContractExtractor.makeValueObservable(t).subscribe((e=>this._value.next(e)));e?.addEventListener("abort",(()=>i.unsubscribe()),{once:!0})},this._getCurrentProSymbol=()=>this._source.ensuredProSymbol.value()??this._source.proSymbol.value();const{source:t,getContinuousFrontContractExtractor:i}=e;this._source=t,this._getContinuousFrontContractExtractor=i;const s=this._getCurrentProSymbol();this._value=new c.BehaviorSubject({symbol:s});void 0!==(this._continuousFrontContractExtractor=i())&&this._onSymbolChange(s),this._processSymbol=(0,U.respectLatest)(this._processSymbol),t.ensuredProSymbol.subscribe(this._onSymbolChange)}reset(){this._continuousFrontContractExtractor=this._getContinuousFrontContractExtractor(),this._onSymbolChange(this._getCurrentProSymbol())}value(){return this._value.getValue()}async setSymbol(e){const t=this.value(),s=t=>t.continuous===e||void 0===t.continuous&&t.symbol===e;if(s(t))return;const o=(0,Di.firstValueFrom)(this._value.pipe((0,Hi.skip)(1),(0,qi.filter)((t=>{const i=s(t);return i||Gi.logWarn(`Waiting for symbol ${e}, but got ${t.continuous||t.symbol}`),i}))));this._source.setSymbolAndLogInitiator(e,"trading linking"),await(0,ke.makeTimeLimited)(o,3e4,r.t(null,{replace:{symbol:e,actualSymbol:this.value().continuous||this.value().symbol}},i(992655)))}valueObservable(){return this._value.asObservable()}}class Yi{constructor(){this.setFocusedControl=e=>{this._focusedControl$.next(e)},this._title$=new c.BehaviorSubject(""),this._description$=new c.BehaviorSubject(void 0),this._symbol$=new c.BehaviorSubject(""),this._hasBatsQuotes$=new c.BehaviorSubject(!1),this._hasDelayedQuotes$=new c.BehaviorSubject(!1),this._isTradable$=new c.BehaviorSubject(!1),this._isTabsAvailable$=new c.BehaviorSubject(!0),this._closeFunction$=new c.BehaviorSubject(void 0),
this._orderTemplateFunction$=new c.BehaviorSubject(void 0),this._informerMessage$=new c.BehaviorSubject(void 0),this._brokerId$=new c.BehaviorSubject(void 0),this._accountType$=new c.BehaviorSubject(void 0),this._brokerLogo$=new c.BehaviorSubject(void 0),this._brokerName$=new c.BehaviorSubject(void 0),this._settings$=new c.BehaviorSubject(void 0),this._isSendingDisabled$=new c.BehaviorSubject(!0),this._applyOrderTemplateFunction$=new c.BehaviorSubject(void 0),this._orderPresetsManagerConsumer$=new c.BehaviorSubject(null),this._focusedControl$=new c.BehaviorSubject(void 0),this.title$=this._title$.asObservable(),this.description$=this._description$.asObservable(),this.symbol$=this._symbol$.asObservable(),this.hasBatsQuotes$=this._hasBatsQuotes$.asObservable(),this.hasDelayedQuotes$=this._hasDelayedQuotes$.asObservable(),this.isTradable$=this._isTradable$.asObservable(),this.isTabsAvailable$=this._isTabsAvailable$.asObservable(),this.closeFunction$=this._closeFunction$.asObservable(),this.orderTemplateFunction$=this._orderTemplateFunction$.asObservable(),this.informerMessage$=this._informerMessage$.asObservable(),this.settings$=this._settings$.asObservable(),this.brokerId$=this._brokerId$.asObservable(),this.accountType$=this._accountType$.asObservable(),this.brokerLogo$=this._brokerLogo$.asObservable(),this.brokerName$=this._brokerName$.asObservable(),this.isSendingDisabled$=this._isSendingDisabled$.asObservable(),this.applyOrderTemplateFunction$=this._applyOrderTemplateFunction$.asObservable(),this.orderPresetsManagerConsumer$=this._orderPresetsManagerConsumer$.asObservable(),this.focusedControl$=this._focusedControl$.asObservable()}setOrderPresetsManagerConsumer(e){this._orderPresetsManagerConsumer$.next(e)}setTitle(e){this._title$.next(e)}setDescription(e){this._description$.next(e)}setSymbol(e){this._symbol$.next(e)}setHasBatsQuotes(e){this._hasBatsQuotes$.next(e)}setHasDelayedQuotes(e){this._hasDelayedQuotes$.next(e)}setIsTradable(e){this._isTradable$.next(e)}setIsTabsAvailable(e){this._isTabsAvailable$.next(e)}setCloseFunction(e){this._closeFunction$.next(e)}setOrderTemplateFunction(e){this._orderTemplateFunction$.next(e)}setInformerMessage(e){this._informerMessage$.next(e)}setSettings(e){this._settings$.next(e)}setBrokerId(e){this._brokerId$.next(e)}setAccountType(e){this._accountType$.next(e)}setBrokerLogo(e){this._brokerLogo$.next(e)}setBrokerName(e){this._brokerName$.next(e)}setIsSendingDisabled(e){this._isSendingDisabled$.next(e)}setOrderTemplateApplicationFunction(e){this._applyOrderTemplateFunction$.next(e)}}var Xi=i(930202),Ji=i(725784),Zi=i(167772);function es(e){const{children:t,tooltipText:i,tooltipHotKey:s}=e;return W.createElement("span",{className:j()("apply-common-tooltip",Zi.content),"data-tooltip-hotkey":s,title:i},W.createElement("span",{className:Zi.contentInner},t))}const ts=(0,Ji.hotKeySerialize)({keys:[(0,Xi.humanReadableModifiers)(Xi.Modifiers.Shift,!1),"T"],text:"{0} + {1}"}),is=(0,Ji.hotKeySerialize)({keys:[(0,Xi.humanReadableModifiers)(Xi.Modifiers.Shift,!1),"D"],text:"{0} + {1}"})
;var ss=i(586816),rs=i(284170),os=i(348194),ns=i(286145),as=i(242843);var ls,ds=i(153894);!function(e){e.Qty="qty",e.StopLoss="stopLoss",e.StopLossPriceEquivalentType="stopLossPriceEquivalentType",e.StopLossFocusedControl="stopLossFocusedControl",e.TakeProfit="takeProfit",e.TakeProfitPriceEquivalentType="takeProfitPriceEquivalentType",e.TakeProfitFocusedControl="takeProfitFocusedControl",e.Duration="duration",e.DurationDatetime="durationDatetime",e.CustomFields="customFields",e.TableColumnsOrder="tableColumnsOrder",e.SummaryFields="summaryFields",e.OrderType="orderType",e.LastUsedQuantityType="lastUsedQuantityType",e.OrderSizeCalculatorQuantityType="orderSizeCalculatorQuantityType",e.OrderSizeCalculatorValue="orderSizeCalculatorValue",e.ActiveOrderPresetId="activeOrderPresetId",e.SuppressedQuestions="suppressedQuestions",e.OrderPresets="orderPresets"}(ls||(ls={}));class us{constructor(e){this._transientStorage={},this._persistentStorageKey=`trading.${e}`;const t=n.getJSON(this._persistentStorageKey,{});delete t.orderTicketQuantity,this._transientStorage=t}setTakeProfitPips(e,t,i){this._setPips("takeProfit",e,t,i)}takeProfitPips(e){return this._getSectionValue("takeProfit",e)}setTakeProfitPriceEquivalentType(e){this._setFlatSectionValue("takeProfitPriceEquivalentType",e),this._syncStorage()}takeProfitPriceEquivalentType(){return this._transientStorage.takeProfitPriceEquivalentType}setTakeProfitFocusedControl(e){this._setFlatSectionValue("takeProfitFocusedControl",e),this._syncStorage()}takeProfitFocusedControl(){return this._transientStorage.takeProfitFocusedControl}setStopLossPips(e,t,i){this._setPips("stopLoss",e,t,i)}stopLossPips(e){return this._getSectionValue("stopLoss",e)}setStopLossPriceEquivalentType(e){this._setFlatSectionValue("stopLossPriceEquivalentType",e),this._syncStorage()}stopLossPriceEquivalentType(){return this._transientStorage.stopLossPriceEquivalentType}setStopLossFocusedControl(e){this._setFlatSectionValue("stopLossFocusedControl",e),this._syncStorage()}stopLossFocusedControl(){return this._transientStorage.stopLossFocusedControl}setDuration(e,t,i){const s=this.duration(e,t);null!==i&&void 0!==s&&s.type===i.type&&s.datetime===i.datetime||null===i&&void 0===s||(this._setDuration(e,t,i),this._syncStorage())}duration(e,t){return this._migrateDuration(e,t),this._getSectionValue("duration",e)?.[t]}setSymbolQty(e,t){this._getOrCreateNestedSection("qty")[e]=t,this._syncStorage()}symbolQty(e){return this._getSectionValue("qty",e)}setCustomFields(e,t,i){const s=this._getOrCreateNestedSection("customFields");s[e]??={},s[e][t]??={};const r=s[e][t];for(const[e,t]of Object.entries(i))"string"==typeof t&&""!==t||"boolean"==typeof t||"boolean"==typeof t.checked&&"string"==typeof t.text?r[e]=t:delete r[e];0===Object.keys(r).length&&delete s[e][t],0===Object.keys(s[e]).length&&delete s[e],this._syncStorage()}customFields(e,t,i){this._migrateCustomFields(e,t,i);const s={},r=this._transientStorage.customFields;if(void 0===r||void 0===r[e])return s;const o=r[e][t];return void 0===o||i.forEach((e=>{const t=o[e]
;""!==t&&void 0!==t&&(s[e]=t)})),s}orderType(e){return this._getSectionValue("orderType",e)}setOrderType(e,t){this._getOrCreateNestedSection("orderType")[e]=t,this._syncStorage()}setTableColumnsOrder(e,t){this._getOrCreateNestedSection("tableColumnsOrder")[e]=t,this._syncStorage()}tableColumnsOrder(e){return this._getSectionValue("tableColumnsOrder",e)}setOrderSizeCalculatorQuantityType(e,t){null===t?this._removeValue("orderSizeCalculatorQuantityType",e):this._getOrCreateNestedSection("orderSizeCalculatorQuantityType")[e]=t,this._syncStorage()}orderSizeCalculatorQuantityType(e){return this._getSectionValue("orderSizeCalculatorQuantityType",e)}setOrderSizeCalculatorValue(e,t){this._getOrCreateNestedSection("orderSizeCalculatorValue")[e]=t,this._syncStorage()}orderSizeCalculatorValue(e){return this._getSectionValue("orderSizeCalculatorValue",e)}setLastUsedQuantityType(e,t){null===t?this._removeValue("lastUsedQuantityType",e):this._getOrCreateNestedSection("lastUsedQuantityType")[e]=t,this._syncStorage()}lastUsedQuantityType(e){return this._getSectionValue("lastUsedQuantityType",e)}summaryFieldsVisibilityInfo(){const e=new Map,t=this._transientStorage.summaryFields;if(void 0===t)return e;for(const[i,s]of Object.entries(t))e.set(i,{id:i,visible:s});return e}setSummaryFieldsVisibilityInfo(e){e.forEach((({id:e,visible:t})=>{this._getOrCreateNestedSection("summaryFields")[e]=t})),this._syncStorage()}setSuppressedQuestions(e){const t=this._transientStorage.suppressedQuestions??[];this._transientStorage.suppressedQuestions=[...new Set([...t,...e])],this._syncStorage()}getSuppressedQuestions(){const e=this._transientStorage.suppressedQuestions;return void 0===e?[]:e}clearSuppressedQuestions(){this._transientStorage.suppressedQuestions=[],this._syncStorage()}setActiveOrderPresetId(e){null===e?this._removeFlatSection("activeOrderPresetId"):this._setFlatSectionValue("activeOrderPresetId",e),this._syncStorage({forceFlush:!0})}activeOrderPresetId(){return this._transientStorage.activeOrderPresetId}setOrderPresets(e){this._setFlatSectionValue("orderPresets",e),this._syncStorage({forceFlush:!0})}orderPresets(){return this._transientStorage.orderPresets||[]}_getOrCreateNestedSection(e){return e in this._transientStorage||(this._transientStorage[e]={}),this._transientStorage[e]}_setFlatSectionValue(e,t){return this._transientStorage[e]=t}_removeFlatSection(e){delete this._transientStorage[e]}_getSectionValue(e,t){const i=this._transientStorage[e];return void 0!==i?i[t]:void 0}_removeValue(e,t){const i=this._transientStorage[e];void 0!==i&&(delete i[t],0===Object.keys(i).length&&delete this._transientStorage[e])}_setPips(e,t,i,s){const r=this._getSectionValue(e,t);if(!(void 0!==r&&r===i||void 0===r&&i===s)){if(void 0!==r&&i===s)this._removeValue(e,t);else{this._getOrCreateNestedSection(e)[t]=i}this._syncStorage()}}_setDuration(e,t,i){const s=this._getOrCreateNestedSection("duration");if(null===i){if(void 0===s[e])return;return delete s[e][t],void(0===Object.keys(s[e]).length&&delete s[e])}s[e]??={},s[e][t]=i}_migrateCustomFields(e,t,i){
const s={},r=this._transientStorage.customFields;void 0===r||"object"==typeof r&&void 0!==r[e]||(i.forEach((t=>{const i=r[`${e}.${t}`];""!==i&&void 0!==i&&(s[t]=i,this._removeValue("customFields",`${e}.${t}`))})),this.setCustomFields(e,t,s))}_migrateDuration(e,t){const i=this._getSectionValue("duration",e);if("string"!=typeof i)return;const s={type:i},r=this._getSectionValue("durationDatetime",e);"number"==typeof r&&(s.datetime=r,this._removeValue("durationDatetime",e)),this._removeValue("duration",e),this._setDuration(e,t,s),this._syncStorage()}_syncStorage(e){n.setJSON(this._persistentStorageKey,this._transientStorage,e)}}var cs=i(952285);const hs=(0,$.getLogger)("Trading.Core"),ps={1:"Connected",2:"Connecting",3:"Disconnected",4:"Error"};var _s,gs;!function(e){e.Desktop="showSellBuyButtons",e.Mobile="showSellBuyButtonsMobile"}(_s||(_s={})),function(e){e.NewOrder="trade-new-order",e.Properties="trade-properties"}(gs||(gs={}));const ys="alert/alarm_clock";function bs(e){return(0,d.alertSounds)().some((t=>e===t.path))}function ms(){return n.getJSON(ge.settingsKeys.PROPERTIES,{})}function vs(e){n.setJSON(ge.settingsKeys.PROPERTIES,e)}const fs=x.enabled("buy_sell_buttons"),Ps=x.enabled("static_dom"),Ss=!0,ks=(window.TRADING_SERVER_LOGGER_URL,"Shortcut"),Cs=a.Modifiers.Shift+a.Modifiers.Alt+66,Ts=`${(0,l.humanReadableModifiers)(a.Modifiers.Shift+a.Modifiers.Alt)} ${(0,l.humanReadableHash)(66)}`,ws=a.Modifiers.Shift+a.Modifiers.Alt+83,Bs=`${(0,l.humanReadableModifiers)(a.Modifiers.Shift+a.Modifiers.Alt)} ${(0,l.humanReadableHash)(83)}`,Os=a.Modifiers.Shift+66,Ms=a.Modifiers.Shift+83,Es=a.Modifiers.Shift+84,Is=a.Modifiers.Shift+68,Vs=a.Modifiers.Shift+a.Modifiers.Alt+67;class $s{constructor(e,t){this.accountType=new R.WatchedValue,this.onBrokerChange=new F.Delegate,this.onBrokerLoading=new F.Delegate,this.onConnectionStatusChange=new F.Delegate,this.onNewNotification=new F.Delegate,this.onNeedSelectBroker=new F.Delegate,this.onNotificationsChanged=new F.Delegate,this.showTradedSources=new R.WatchedValue(!0),this.showSellBuyButtons=null,this.noConfirmEnabled=new R.WatchedValue,this.showOnlyRejectionNotifications=new R.WatchedValue,this.showPricesWithZeroVolume=new R.WatchedValue,this.showSpread=new R.WatchedValue,this.orderExecutedSoundParams=function(){const e=bs(ys)?ys:(0,d.alertSounds)()[0].path;return{enabled:new R.WatchedValue(!1),volume:new R.WatchedValue(.5),path:new R.WatchedValue(e)}}(),this._activeBroker=null,this._orderViewController=null,this._orderControllerPromise=null,this._brokerCommandsUI=null,this._showPricesWithZeroVolume=new R.WatchedValue,this._showSpread=new R.WatchedValue,this._closePositionDialogVisibility=new ve.DialogVisibility,this._orderDialogVisibility=new ve.DialogVisibility,this._loginDialogVisibility=new ve.DialogVisibility,this._tradingPanelPopupVisibility=new ve.DialogVisibility,this._tradingSettingsStorage=null,this._offlineListener=this._offlineHandler.bind(this),this._onlineListener=this._onlineHandler.bind(this),this._notifications=[],this._account=null,
this._domPanelVisibility=new R.WatchedValue(!1),this._orderPanelVisibility=new R.WatchedValue(!1),this._pipValueType$=new c.BehaviorSubject(B.PipValueType.None),this._switchingBroker=!1,this._isDOMAvailable=(0,bt.checkIsDOMAvailable)(),this._isOrderPanelAvailable=x.enabled("order_panel"),this._isReconnectNeeded=!1,this._accountVerificationPromise=null,this._chartWidgetCollection=null,this._tradedItemsChartCollectionFacadePromise=null,this._tradeNowBrokerId=null,this._tradeNowSource=null,this._tradedGroupStyleOverrides=null,this._userActivityStatus=null,this._isInReplay=new R.WatchedValue(!1),this.getBrokerTradingSettingsStorage=()=>this._tradingSettingsStorage,this.getFavoriteBrokersStorage=()=>{throw new Error("Not implemented")},this.trackEvent=(e,t,i)=>{const s=e?`[${e}] ${t}`:t;if(this._gui()){const e=this._activeBroker?this._activeBroker.metainfo().id+" Trading":"Trading No Broker",t=this._activeBroker?this._activeBroker.currentAccountType():void 0;this._gui().trackEvent(e,s,i||t)}},this.showErrorNotification=(e,t,i=25e3)=>{this._showNotification(e,t,1,i),x.enabled("show_trading_notifications_history")&&this._addNotificationRow(e,t,1),this._log(e,t)},this.setDOMPanelVisibility=(e,t=!0,i,s)=>{e&&t&&!this._makeSureCanTrade(s)||(e?this.tradingPanel.openPage(fe.TradingPage.DOMPanel):this.tradingPanel.close(i))},this.setOrderPanelVisibility=async(e,t=!0,i,s)=>{if(e&&t&&!this._makeSureCanTrade(s))return;const{openPanel:r,closePanel:o}=await this._getOrderViewController();e?await r():o(i)},this.getTradeNowBrokerId=()=>this._tradeNowBrokerId,this.clearTradeNowBrokerId=()=>{this._tradeNowBrokerId=null,this._tradeNowSource=null},this.checkRealtimeDataPermissions=async e=>{const t=(0,s.ensureNotNull)(this._activeBroker),{id:i,altBrokerId:r}=t.metainfo();await checkRealtimeDataSubscription(i,e??t.getRealtimeDataCheckParams(),r)&&this._guiAccessor.reconnectChartApi(!0)},this.toggleTradingPanelVisibility=async()=>{const e=this._orderDialogVisibility.getValue().isVisible,t=this.tradingPanel.isOpened.value();e&&this._isDOMAvailable?this.setDOMPanelVisibility(!t):this._updateTradingPanelVisibility({isOpened:!t})},this.toggleOrderDialog=async()=>{if(!this._activeBroker)return void this._tradingWizard.drawAttention();const{openOrderDialog:e,closeDialogs:t}=await this._getOrderViewController(),i=this._orderDialogVisibility.getValue().isVisible;this.trackEvent(ks,i?"Close OT":"Open OT",this._getInstantTradingEventLabel()),i?t():e()},this._recreateOrderPresetsManagerConsumer=()=>{this._orderPresetsManagerConsumerPromise?.then((e=>e?.destroy())),this._orderPresetsManagerConsumerPromise=this._orderPresetsManager?.createConsumer(this._linking.value().symbol)},this._trackOrderPresetSnowplowEvent=e=>{0},this._updateOrderPresetsManagerBroker=async e=>{const t=1===this._activeBroker?.connectionStatus()?this._activeBroker:null;await(this._orderPresetsManager?.setBroker(t)),e?.aborted||this._recreateOrderPresetsManagerConsumer()},this._handleVisibilityChange=()=>{
null!==this._activeBroker&&this._activeBroker.metainfo().configFlags.usesActiveConnection&&"visible"!==document.visibilityState&&2!==this._activeBroker.connectionStatus()&&(this._isReconnectNeeded=!0,this._selectBrokerInternal({brokerId:null,isUserAction:!1,keepSessionAlive:!0,disconnectInfo:{disconnectType:B.DisconnectType.BrokenConnection}}).then((()=>{if(this._isReconnectNeeded)return this._tryReconnectLastBroker()})))},this._tryReconnectLastBroker=async()=>{if(this._isReconnectNeeded){if("hidden"===document.visibilityState)return window.addEventListener("visibilitychange",this._tryReconnectLastBroker,{once:!0});this._isReconnectNeeded=!1,await this._selectLastBroker({isConcurrentConnectionAllowed:!0})}},this._onCurrentAccountUpdate=()=>{const e=(0,s.ensureNotNull)(this._activeBroker).currentAccount();this._account!==e&&(this._tradedContextLinking.clear(),this._account=e,this.onNotificationsChanged.fire(this.getNotifications()))},this._handleQtyCalculatorOpening=()=>{if(this.tradingPanel.isOpened.value())this._orderViewController?.resetQuantityFocusToUnits();else{const{symbol:e}=this._linking.value(),t=this._tradingSettingsStorage?.lastUsedQuantityType(e);"units"!==t&&this._tradingSettingsStorage?.setLastUsedQuantityType(e,"units")}},this._setPipValueType=async()=>{const{symbol:e}=this._linking.value(),{type:t}=await this._realtimeProvider.symbolInfo(e),i="forex"===t||"spread"===t?B.PipValueType.Pips:B.PipValueType.Ticks;this._pipValueType$.next(i)},this._trackNonTradableSymbol=async()=>{if(1===this._activeBroker?.connectionStatus()){const{symbol:e}=this._linking.value();if(void 0===e)return;const t=await this._activeBroker.isTradable(e);t&&!t.tradable&&this.trackEvent("Symbol is not tradable",e)}},this._onBrokerChanged=e=>{if(null===e)return void(this._tradingSettingsStorage=null);const t=e.metainfo();this._tradingSettingsStorage=new us(t.id)},this._tradeNow=async()=>{if(void 0!==window.TradingView.bottomWidgetBar&&null!==this._tradeNowBrokerId)try{trackTradingPanelOpen(this._tradeNowSource??void 0),await window.TradingView.bottomWidgetBar.toggleWidget("paper_trading",!0)}catch{this._tradingWizard.drawAttention()}},this._updateTradingPanelVisibility=e=>{const{isOpeningAvailable:t=this.tradingPanel.isOpeningAvailable.value(),isOpened:i=this.tradingPanel.isOpened.value(),activePage:s=this.tradingPanel.activePage.value(),shouldCanTrade:r,shouldPersistState:o}=e,n=t&&i;s===fe.TradingPage.OrderPanel?this.setOrderPanelVisibility(n,r,o):this.setDOMPanelVisibility(n,r,o)},this._toggleTradingPanelPage=e=>{e!==this.tradingPanel.activePage.value()&&(e===fe.TradingPage.OrderPanel&&this.setOrderPanelVisibility(!0),e===fe.TradingPage.DOMPanel&&this.setDOMPanelVisibility(!0))},this._closePanelOrDialogs=async()=>{const{closeOrderView:e}=await this._getOrderViewController();e()},this._onLinkingSymbolChange=e=>{e.symbol!==this._tradedContextLinking.context()?.data().symbol&&this._tradedContextLinking.clear()},this._onUserActivityStatusChange=()=>{if(null===this._activeBroker)return
;const e=this._activeBroker.metainfo().id,t=this._getForceLogoutUserByInactivityTimerInfo()?.message;this._logOut(!1,!1),this._selectBrokerInternal({brokerId:e,isUserAction:!1,disconnectInfo:{disconnectType:B.DisconnectType.OauthError,message:t},shouldReconnect:!1})},this._updateOrderPresetsManagerBroker=(0,U.respectLatest)(this._updateOrderPresetsManagerBroker),this._linking=new Ki({source:o.linking,getContinuousFrontContractExtractor:()=>this._continuousFrontContractExtractor}),this._abortController=new AbortController,this._setPipValueType=(0,L.sequentialize)(this._setPipValueType),this._selectBrokerInternal=(0,L.sequentialize)(this._selectBroker),void 0!==navigator.locks&&(this._selectBrokerInternal=e=>navigator.locks.request(`select-broker-${e.brokerId}`,{ifAvailable:!0},(t=>this._selectBroker({...e,hasConcurrentSession:null===t})))),this._showSellBuyButtonsKey=this._makeShowSellBuyButtonsKey(),this._realtimeProvider=new Oe((()=>this.activeBroker()),this.onBrokerChange,this.onConnectionStatusChange,(e=>this.getActualSymbol(e))),this._positionService=new It.PositionsService(this),this._ordersService=new Vt.OrdersService(this,this._positionService),this._tradingStat=new Ve(this),this._serverLogger=null,this._tradedContextLinking=new ji,this.onBrokerChange.subscribe(this,this._onBrokerChanged),this.tradingPanelPopup=new ce(this),this.tradingPanelPopup.visible().subscribe((e=>{e?this._tradingPanelPopupVisibility.setValue({isVisible:e,isFullScreen:!0}):this._tradingPanelPopupVisibility.setValue({isVisible:e})}));const i=this._makeTradingPanelTabsConfig();this.tradingPanel=new vt(e,i);this._qtySuggester=new Wi({onResetNeeded:this.onConnectionStatusChange,symbolInfoGetter:e=>this._realtimeProvider.symbolInfo(e),qtySettingsStorageGetter:()=>1===this.connectStatus()?this._tradingSettingsStorage:null}),this._qtySuggesterWithOrderSizeCalculatorResetting={getQty:this._qtySuggester.getQty.bind(this._qtySuggester),suggestedQtyChanged:this._qtySuggester.suggestedQtyChanged.bind(this._qtySuggester),setQty:this._qtySuggester.setQty.bind(this._qtySuggester)},this._domPanelPage=new Ye({resizerBridge:e,closeFn:()=>this.tradingPanel.close(),trading:this,qtySuggester:this._qtySuggesterWithOrderSizeCalculatorResetting,tradingLinking:this._linking,headerState:new Yi,isLoading:this.tradingPanel.isLoading}),this.tradingPanel.addPage(fe.TradingPage.DOMPanel,this._domPanelPage),this._orderPanelHeaderState=new Yi;const r=new Xe(this._orderPanelHeaderState);this.tradingPanel.addPage(fe.TradingPage.OrderPanel,r),this._updateTradingPanelVisibility({shouldCanTrade:!1,shouldPersistState:!1}),this.tradingPanel.isOpeningAvailable.subscribe((async e=>{this._updateTradingPanelVisibility({isOpeningAvailable:e})})),this._domPanelVisibility.setValue(this.tradingPanel.isPageOpened(fe.TradingPage.DOMPanel)),this._orderPanelVisibility.setValue(this.tradingPanel.isPageOpened(fe.TradingPage.OrderPanel)),(0,q.combine)(((e,t)=>({})),this.tradingPanel.activePage.weakReference(),this.tradingPanel.isOpened.weakReference()).subscribe((()=>{
this._domPanelVisibility.setValue(this.tradingPanel.isPageOpened(fe.TradingPage.DOMPanel)),this._orderPanelVisibility.setValue(this.tradingPanel.isPageOpened(fe.TradingPage.OrderPanel))})),this.closePositionDialogVisibility=this._closePositionDialogVisibility.value$,this.orderDialogVisibility=this._orderDialogVisibility.value$,this.loginDialogVisibility=this._loginDialogVisibility.value$,this.possibleFullScreenDialogsVisibility=(0,h.merge)(this.closePositionDialogVisibility.pipe((0,p.map)((e=>({...e,name:"close-position-dialog"})))),this.orderDialogVisibility.pipe((0,p.map)((e=>({...e,name:"order-dialog"})))),this.loginDialogVisibility.pipe((0,p.map)((e=>({...e,name:"login-dialog"})))),this._tradingPanelPopupVisibility.value$.pipe((0,p.map)((e=>({...e,name:"trading-panel-popup"}))))),this._linking.valueObservable().subscribe(this._onLinkingSymbolChange)}setChartWidgetCollection(e){(0,s.assert)(null===this._chartWidgetCollection,"ChartWidgetCollection can be set only once"),this._chartWidgetCollection=e,this._guiAccessor=new De(e),this._loadState(),this._migrateOldSettings(ms()),this.showSellBuyButtons=function(e){const t=new R.WatchedValue(!1);return(0,q.accumulate)(((e,t)=>!!t.hasModel()&&(0,Gt.getBuySellButtonsVisibility)(t.model().model()).value()),(0,q.combine)((e=>e.reduce(((e,t)=>{const i=(0,Gt.getBuySellButtonsVisibility)(t.model());return e.push((0,Ct.createWVFromGetterAndSubscription)((()=>i.value()),i).ownership()),e}),[])),e.chartModels().weakReference()).ownership(),e.activeChartWidget.weakReference()).subscribe((e=>t.setValue(e)),{callWithLast:!0}),t.setValue=t=>{(0,Kt.setBuySellButtonsVisibility)(e.activeChartWidget.value().model(),t)},t.value=()=>(0,Gt.getBuySellButtonsVisibility)(e.activeChartWidget.value().model().model()).value(),t}(this._chartWidgetCollection),n.onSync.subscribe(this,this._loadState);const t=()=>{this._save()};this.noConfirmEnabled.subscribe(t),this.showOnlyRejectionNotifications.subscribe(t),this._showPricesWithZeroVolume.subscribe(t),this._showSpread.subscribe(t),this.orderExecutedSoundParams.enabled.subscribe(t),this.orderExecutedSoundParams.path.subscribe(t),this.orderExecutedSoundParams.volume.subscribe(t),window.addEventListener("offline",this._offlineListener),window.addEventListener("online",this._onlineListener),this.bindShortcuts(),this._tradedItemsChartCollectionFacadePromise=this._createTradedItemsChartCollectionFacade(e),this._registerCustomSources(e),this._registerCustomWidgets(e)}showPricesWith(){return{zeroVolume:this._showPricesWithZeroVolume,spread:this._showSpread}}domPanelVisibility(){return this._domPanelVisibility}orderPanelVisibility(){return this._orderPanelVisibility}getAccountManagerVisibilityMode(){if(!window.TradingView.bottomWidgetBar)throw new Error("Unable to provide bottom widget visibility mode: bottomWidgetBar undefined");return window.TradingView.bottomWidgetBar.mode()}setAccountManagerVisibilityMode(e){if(!window.TradingView.bottomWidgetBar)throw new Error("Unable to provide bottom widget visibility mode: bottomWidgetBar undefined")
;window.TradingView.bottomWidgetBar.setMode(e)}realtimeProvider(){return this._realtimeProvider}toggleTradingPanelPopup(e){this.tradingPanelPopup.visible().value()?this.tradingPanelPopup.hide():(trackTradingPanelOpen(e),this.tradingPanelPopup.show())}toggleTradingWidget(e){return window.TradingView.bottomWidgetBar?("minimized"===this.bottomWidgetBarMode().value()&&trackTradingPanelOpen(e),window.TradingView.bottomWidgetBar.activateTradingTab()):Promise.resolve()}toggleMinimizeBottomWidgetBar(){if(window.TradingView.bottomWidgetBar)return window.TradingView.bottomWidgetBar.toggleMinimize()}bottomWidgetBarMode(){if(!window.TradingView.bottomWidgetBar)throw new Error("Unable to provide bottom widget mode: bottomWidgetBar undefined");return window.TradingView.bottomWidgetBar.mode()}tradingWizard(){return this._tradingWizard}showTradingProperties(){this._gui()&&this._gui().showTradingProperties()}linking(){return this._linking}async brokersMetainfo(){return await this._brokersRegistrationPromise,Pe.brokersList()}brokersList(){return getBrokersList()}brokersPlans(){return this._getBrokersPlans()}activeBroker(){return this._activeBroker}brokerCommandsUI(){return this._brokerCommandsUI}async selectBroker(e,t){await this._selectBrokerInternal({brokerId:e,isUserAction:!0,keepSessionAlive:t})}async pickDefaultBroker(){if(this._activeBroker)return;let e=null;const t=(await this.brokersMetainfo()).filter((e=>!e.configFlags.isSuspended));if(1===t.length)e=t[0].id;else{const i=await he.get();i&&t.some((e=>e.id===i))&&(e=i)}e&&this._selectBrokerInternal({brokerId:e,isUserAction:!1})}async makeNewOrderContextMenuAction(e,t,s){const o=await this._qtySuggester.getQty(e);return{name:"trade-new-order",action:async()=>{const{symbol:i}=this._linking.value();i!==e&&await this._linking.setSymbol(e),this.trackEvent(t,"New Order"),this._checkAndOpenOrderDialog({symbol:e,qty:o,limitPrice:s,stopPrice:s},"chart_context")},text:(0,D.appendEllipsis)(r.t(null,void 0,i(767325))),statName:"NewOrder",shortcutHint:(0,l.humanReadableHash)(a.Modifiers.Shift+84)}}async defaultContextMenuActions(e,{onlyMainActions:t=!1,gaOrigin:i="Chart Context Menu",hideNotExecutableAction:s=!1}={}){const{symbol:r}=await this.getActualSymbol(e.symbol),o=(await Promise.all([this._makeContextMenuTradeActions({symbol:r,context:e,gaOrigin:i,hideNotExecutableAction:s}),[]])).flat();return!t&&x.enabled("property_pages"),o}defaultDropdownMenuActions(e){const t="Bottom Panel Dropdown",s=[],o=this.activeBroker(),n=e||{tradingProperties:!0,restoreConfirmations:o&&o.metainfo().configFlags.supportConfirmations};return x.enabled("property_pages")||(n.tradingProperties=!1),n.tradingProperties&&s.push({action:()=>{this.showTradingProperties(),this.trackEvent(t,"Trading Properties")},text:(0,D.appendEllipsis)(r.t(null,void 0,i(881352))),iconId:"Settings"}),n.restoreConfirmations&&s.push({action:()=>{this._showRestoreConfirmations(),this.trackEvent(t,"Restore confirmations")},text:(0,D.appendEllipsis)(r.t(null,void 0,i(18240)))}),s}async chartSeriesContextMenuAction(e){
const{symbol:t}=await this.getActualSymbol(e.symbol),{displaySymbol:s}=e,[o,n,d]=await Promise.all([this._qtySuggester.getQty(t),this._realtimeProvider.symbolInfo(t),this._realtimeProvider.formatter(t)]),u=e.value||e.last,c=n.variableMinTick?(0,I.makeVariableMinTickData)(n.minTick,n.variableMinTick):void 0,h=(0,M.alignToStep)(u,(p=u,(0,I.getMinTick)({minTick:n.minTick,price:p,variableMinTickData:c})));var p;const _=d.format(h);return new cs.ActionWithStandardIcon({actionId:"Trading.AddOrder",options:{name:"trade-new-order",label:(0,D.appendEllipsis)(r.t(null,void 0,i(105323)).format({displaySymbol:s,formattedPrice:_})),statName:"NewOrder",iconId:"Trading.AddOrder",shortcutHint:(0,l.humanReadableHash)(a.Modifiers.Shift+84),onExecute:()=>{const{symbol:e}=this._linking.value();e!==t&&this._linking.setSymbol(t),this.trackEvent("Chart Context Menu","New Order"),this._checkAndOpenOrderDialog({symbol:t,qty:o,limitPrice:h,stopPrice:h},"chart_context")}}})}async chartContextMenuActions(e,t){return(this._activeBroker&&1===this._activeBroker.connectionStatus()?this._activeBroker.chartContextMenuActions(e,t):this.defaultContextMenuActions(e,t)).then((e=>(0,O.convertActionDescriptionsToActions)(e,(()=>{this._chartWidgetCollection?.activeChartWidget.value().exitTrackingMode()}))))}connectStatus(){return this._activeBroker?this._activeBroker.connectionStatus():3}bindShortcuts(){if(this._hotkeys)return;this._hotkeys=a.createGroup({desc:"Trading"});const e=async({side:e,type:t,shouldOpenOrderDialog:i,openTradingPanelEventSource:s,price:r})=>{const{symbol:o}=this._linking.value(),n={qty:await this._qtySuggester.getQty(o),side:e,symbol:o,type:t,seenPrice:null};if(void 0!==r){const{limitPrice:e,stopPrice:i}=r;switch(t){case 1:n.limitPrice=e;break;case 3:n.stopPrice=i;break;case 4:n.limitPrice=e,n.stopPrice=i}}const a=(0,me.sideToText)(n.side),l=(0,me.orderTypeToText)({orderType:n.type}),d=await this._realtimeProvider.quotesSnapshot(o);d&&void 0!==d.ask&&void 0!==d.bid&&(n.currentQuotes={ask:d.ask,bid:d.bid}),this.trackEvent(ks,`${a} ${l}`,this._getInstantTradingEventLabel()),this._checkAndPlaceOrder(n,i,s)};if(this._hotkeys.add({desc:"Buy",hotkey:Os,handler:async()=>{const t=await this._orderPresetsManagerConsumerPromise;t?.activePreset();return e({side:1,type:2,shouldOpenOrderDialog:!0,openTradingPanelEventSource:"hotkeys"})}}),this._hotkeys.add({desc:"Sell",hotkey:Ms,handler:async()=>{const t=await this._orderPresetsManagerConsumerPromise;t?.activePreset();return e({side:-1,type:2,shouldOpenOrderDialog:!0,openTradingPanelEventSource:"hotkeys"})}}),this._hotkeys.add({desc:"Buy limit",hotkey:Cs,handler:async()=>{const t=await this._getPriceByCrossHair(),i=null!==t?t:(await this._realtimeProvider.quotesSnapshot(this._linking.value().symbol)).ask;e({side:1,type:1,shouldOpenOrderDialog:!1,openTradingPanelEventSource:"hotkeys",price:{limitPrice:i}})}}),this._hotkeys.add({desc:"Sell limit",hotkey:ws,handler:async()=>{
const t=await this._getPriceByCrossHair(),i=null!==t?t:(await this._realtimeProvider.quotesSnapshot(this._linking.value().symbol)).bid;e({side:-1,type:1,shouldOpenOrderDialog:!1,openTradingPanelEventSource:"hotkeys",price:{limitPrice:i}})}}),this._hotkeys.add({desc:"Open/close Order Panel",hotkey:Es,handler:async()=>{{const e=this._activeBroker?.metainfo();if(void 0!==e?.customUI?.showOrderDialog){const{symbol:t}=this._linking.value(),i={symbol:t};return void e.customUI.showOrderDialog(i)}}if(!(this._isOrderPanelAvailable&&this.tradingPanel.isOpeningAvailable.value()&&(await this._getOrderViewController()).getDisplayMode()===be.OrderEditorDisplayMode.Panel))return this.toggleOrderDialog();const e=this.tradingPanel.isOpened.value()&&this.tradingPanel.activePage.value()===fe.TradingPage.OrderPanel;this.trackEvent(ks,e?"Close OT":"Open OT",this._getInstantTradingEventLabel()),this.setOrderPanelVisibility(!e,void 0,void 0,"hotkeys")}}),this._isDOMAvailable&&(this._hotkeys.add({desc:"Open/close DOM",hotkey:Is,handler:()=>{if(!this.tradingPanel.isOpeningAvailable.value())return;const e=this.tradingPanel.isOpened.value()&&this.tradingPanel.activePage.value()===fe.TradingPage.DOMPanel;this.trackEvent(ks,e?"Close DOM":"Open DOM",this._getInstantTradingEventLabel()),this.setDOMPanelVisibility(!e,void 0,void 0,"hotkeys")}}),Ps)){let e;const t=t=>{void 0!==this._hotkeys&&(t&&void 0===e?e=this._hotkeys.add({desc:"Manual DOM centering",hotkey:Vs,handler:()=>{this._domPanelPage.centerDOM(),this.trackEvent(ks,"Center DOM",this._getInstantTradingEventLabel())}}):t||void 0===e||(this._hotkeys.remove(e),e=void 0))};t(this._domPanelVisibility.value()),this._domPanelVisibility.subscribe(t)}}formatter(e){return this.realtimeProvider().formatter(e)}showSuccessNotification(e,t,i=1e4){this.showOnlyRejectionNotifications.value()||this._showNotification(e,t,0,i),x.enabled("show_trading_notifications_history")&&this._addNotificationRow(e,t,0),this._log(e,t)}getNotifications(){return this._notifications.filter((e=>e.account===this._account&&e.broker===(this._activeBroker?this._activeBroker.metainfo().id:null)))}orderViewController(){return(0,s.ensureNotNull)(this._orderViewController)}findOrCreateOrderViewController(){return this._getOrderViewController()}tradingStat(){return this._tradingStat}async verifyBrokerLiveAccount(){return this._verifyLiveAccount(),null!==this._accountVerificationPromise?this._accountVerificationPromise:Promise.reject("Account verification is not needed")}pipValueType(){return this._pipValueType$.asObservable()}tradedItemsChartCollectionFacade(){return(0,s.ensureNotNull)(this._tradedItemsChartCollectionFacadePromise)}async removeRealtimeDataPermissions(){await removeRealtimeDataSubscription((0,s.ensureNotNull)(this._activeBroker).metainfo().id)&&this._guiAccessor.reconnectChartApi(!0)}makeActualSymbolObservable(e){return this._continuousFrontContractExtractor?.makeValueObservable(e)??(0,_.of)({symbol:e})}async getActualSymbol(e){return void 0===this._continuousFrontContractExtractor?{symbol:e
}:this._continuousFrontContractExtractor.makeValue(e)}async getVisibleSymbol(e){const{symbol:t}=await this.getActualSymbol(e);return{symbol:t??t}}getQtySuggester(){return this._qtySuggester}showOrderToast(e){const t=2===e.toastType,{title:i,text:s}=function(e){const t=(0,as.getHeadingText)(e),{primaryText:i,secondaryText:s=""}=(0,as.getOrderInfoTexts)({...e,primaryPrice:e.primaryPrice?e.priceFormatter.format(e.primaryPrice):void 0,secondaryPrice:e.secondaryPrice?e.priceFormatter.format(e.secondaryPrice):void 0});return{title:t+` (${e.orderId})`,text:i+s}}(e);if(x.enabled("show_trading_notifications_history")&&this._addNotificationRow(i,s,t?1:0,e.symbol,e.displaySymbol),this._log(i,s),this.showOnlyRejectionNotifications.value()&&!t)return;const r=(0,rs.guid)();os.toastManager.addToast(r,ss.ORDERS_GROUP_ID,e),(0,ns.setToastUserActivityBasedRemovalTimeout)(r,t?25e3:1e4)}clearTradedContextLinking(){null!==this._tradedContextLinking.context()&&this._tradedContextLinking.clear()}overrideTradedGroupStyles(e){this._tradedGroupStyleOverrides=e}shouldShowTradeButton(){const e=this.tradingPanel.isOpeningAvailable.value(),t=this._isDOMAvailable||this._isOrderPanelAvailable,i=1===this._activeBroker?.connectionStatus(),s=window.is_authenticated&&i;return(i||s)&&t&&e}isInReplay(){return this._isInReplay}_getInstantTradingEventLabel(){return this.noConfirmEnabled.value()?"Instant":"Not Instant"}async _getOrderViewController(){return null!==this._orderViewController?this._orderViewController:(await this._createOrderController(),this._getOrderViewController())}async _getPaperCompetitions(){return getPaperCompetitions().catch((()=>[]))}async _getActivePaperCompetitionsSinceTimestamp(e){const t=await this._getPaperCompetitions(),i=window.ChartApiInstance.serverTime(),s=window.countryCode;return t.flatMap((t=>{const r=new Date(t.properties.startTime).getTime(),o=new Date(t.properties.registrationEndTime).getTime(),n=(t.properties.clientRestriction?.prohibitedCountries??[]).includes(s);return e>r||i<r||i>o||n?[]:t})).sort(((e,t)=>e.properties.startTime<t.properties.startTime?-1:1))}async _showPaperCompetitionStartedDialogIfNeeded(){}async _selectBroker(e){const{brokerId:t,isUserAction:s,keepSessionAlive:o=!1,disconnectInfo:n,hasConcurrentSession:a,shouldReconnect:l,isConcurrentConnectionAllowed:d}=e;if(this._switchingBroker)return void hs.logWarn(`Broker is already selected, but a new broker id: ${t} was received.`);if(t!==(this._activeBroker?this._activeBroker.metainfo().id:null)){if(this._linkingSubscription?.unsubscribe(),this._destroyContinuousFrontContractTrading(),this._activeBroker){const e=this._isReconnectNeeded?null:this._activeBroker.disconnectWarningMessage(),t=()=>this._showReviewDialogIfNeeded(3,{disconnectType:B.DisconnectType.LogOut}),a=()=>{t(),this._logOut(s,o,n)};if(null!==e&&window.is_authenticated&&navigator.onLine){if(!await(0,Ne.showSimpleConfirmDialog)({title:r.t(null,void 0,i(672122)),text:e,mainButtonText:r.t(null,void 0,i(732114)),mainButtonIntent:"danger",cancelButtonText:r.t(null,void 0,i(904543)),onConfirm:a,
onCancel:()=>{t()}}))return}else a()}if(null!=t){let e;this.clearTradeNowBrokerId(),this._switchingBroker=!0;try{const i=await Pe.createBrokerConnection(this,t,this._serverLogger,null,e);0,await this._initBroker({brokerConnection:i,keepSessionAlive:o,shouldReconnect:l,disconnectInfo:n})}catch(e){this._switchingBroker=!1,hs.logError((0,V.getLoggerMessage)(e))}}else s&&!o&&setTimeout((()=>{he.clear()})),this.onBrokerChange.fire(null),this._closePositionDialogVisibilitySubscription?.unsubscribe(),this._brokerCommandsUI=null}else hs.logWarn(`${t} is already selected.`)}_destroyContinuousFrontContractTrading(){0}async _initContinuousFrontContractTrading(){0}_makeTradingPanelTabsConfig(){return function(e){const{onSelect:t,orderPanelAvailable:s,domPanelAvailable:o}=e;return s&&o?{items:[{id:fe.TradingPage.OrderPanel,children:W.createElement(es,{tooltipText:r.t(null,void 0,i(823887)),tooltipHotKey:ts},r.t(null,void 0,i(512686)))},{id:fe.TradingPage.DOMPanel,children:W.createElement(es,{tooltipText:r.t(null,void 0,i(611638)),tooltipHotKey:is},r.t(null,void 0,i(611638)))}],onSelect:t}:null}({onSelect:this._toggleTradingPanelPage,orderPanelAvailable:this._isOrderPanelAvailable,domPanelAvailable:this._isDOMAvailable})}_makeBrokerDependantWarningMessageObservable(e){let t,i=async(t,i)=>{const{tradable:s}=await(0,U.respectAbort)(t,e.isTradable(i));return s};i=(0,U.respectLatest)(i);try{t=e.currentAccount()}catch{}const s=(0,g.fromEventPattern)((t=>e.currentAccountUpdate.subscribe(null,t)),(t=>e.currentAccountUpdate.unsubscribe(null,t))).pipe((0,y.startWith)(t)),r=(0,g.fromEventPattern)((t=>e.connectionStatusUpdate.subscribe(null,t)),(t=>e.connectionStatusUpdate.unsubscribe(null,t))).pipe((0,y.startWith)(e.connectionStatus()));return(0,b.combineLatest)({value:this._linking.valueObservable(),currentAccountUpdate:s,connectionStatusUpdate:r}).pipe((0,m.mergeMap)((({value:e})=>(0,b.combineLatest)({isTradable:(0,v.from)(i(null,e.symbol)).pipe((0,y.startWith)(!1),k((()=>C.EMPTY))),value:(0,_.of)(e)}))),(0,p.map)((e=>e.isTradable?e.value.warning:void 0)))}async _initBroker({brokerConnection:e,shouldReconnect:t=!0,disconnectInfo:i}){this._activeBroker=e,this._activeBroker.connectionStatusUpdate.subscribe(this,this._connectionListener),this._activeBroker.currentAccountUpdate.subscribe(this,this._onCurrentAccountUpdate),this._realtimeProvider.onStatusChanged.subscribe(null,this._setPipValueType),this._realtimeProvider.onStatusChanged.subscribe(null,this._trackNonTradableSymbol),await this._initContinuousFrontContractTrading(),this._linkingSubscription=this._linking.valueObservable().subscribe((e=>{this._setPipValueType(),this._trackNonTradableSymbol(),this._recreateOrderPresetsManagerConsumer()})),this._brokerCommandsUI=new Ke({activeBroker:this._activeBroker,guiAccessor:this._guiAccessor,noConfirmEnabled:this.noConfirmEnabled,orderViewController:this._getOrderViewController.bind(this),showErrorNotification:this.showErrorNotification.bind(this),trackEvent:this.trackEvent,tradingLinking:this._linking,
tradedContextLinking:this._tradedContextLinking,abortSignalGetter:()=>this._abortController.signal,trackOrderPresetSnowplowEvent:this._trackOrderPresetSnowplowEvent}),this._closePositionDialogVisibilitySubscription=this._brokerCommandsUI.closePositionDialogVisibility.subscribe(this._makeDialogVisibilityHandler(this._closePositionDialogVisibility)),t&&this._activeBroker.tryRestoreSession(),await he.set(this._activeBroker.metainfo().id),this.onBrokerChange.fire(this._activeBroker),this._getOrderViewController(),this._updateConnectionStatus(this.connectStatus(),!1,i),this._switchingBroker=!1}async _showBrokerSideMaintenanceWarning(e,t){return(0,Ne.showSimpleConfirmDialog)({title:r.t(null,{replace:{brokerId:e}},i(637161)),text:t??r.t(null,void 0,i(943288)),cancelButtonText:r.t(null,void 0,i(904543)),mainButtonIntent:"primary",mainButtonText:r.t(null,void 0,i(116056)),showBackdrop:!0})}_makeDialogVisibilityHandler(e){return t=>{e.setValue(t)}}_gui(){return this._guiAccessor}_addNotificationRow(e,t,i,s,r){const o={id:this._notifications.length.toString(),account:this._account,broker:this._activeBroker?this._activeBroker.metainfo().id:null,time:new Date,title:e,text:t,type:i,symbol:s,displaySymbol:r};this._notifications.push(o),this.onNewNotification.fire(o)}_offlineHandler(){this._selectBrokerInternal({brokerId:null,isUserAction:!1,keepSessionAlive:!0,disconnectInfo:{disconnectType:B.DisconnectType.Offline}}),hs.logNormal("The connection to the Internet was interrupted")}async _onlineHandler(){await this._selectLastBroker()&&hs.logNormal("The connection to the Internet was restored")}_showNotification(e,t,i,s){const r=(0,rs.guid)();os.toastManager.addToast(r,ds.TRADING_NOTIFICATIONS_GROUP_ID,{title:e,content:t,notificationType:i}),(0,ns.setToastUserActivityBasedRemovalTimeout)(r,s)}_hideAllNotifications(){os.toastManager.removeGroup(ss.ORDERS_GROUP_ID),os.toastManager.removeGroup(ds.TRADING_NOTIFICATIONS_GROUP_ID)}_showReviewDialogIfNeeded(e,t){if(null===this._activeBroker)return;this._activeBroker}_connectionListener(e,t){const i=this.connectStatus();this._showReviewDialogIfNeeded(e,t);const s=this._getForceLogoutUserByInactivityTimerInfo();void 0!==s&&this._processForceLogoutUserByInactivityTimerInfoByStatus(e,s);const r=this._isReconnectNeeded=t?.disconnectType===B.DisconnectType.BrokenConnection;3!==e||t?.disconnectType!==B.DisconnectType.LogOut&&!this._isReconnectNeeded||this._selectBrokerInternal({brokerId:null,isUserAction:!1,keepSessionAlive:!0,disconnectInfo:t}).then((()=>{if(this._isReconnectNeeded)return this._tryReconnectLastBroker()})),t?.disconnectType===B.DisconnectType.CancelAuthorization&&this.trackEvent("Signin","OAuth popup closed","By user"),t?.disconnectType===B.DisconnectType.TimeOutForAuthorization&&this.trackEvent("Signin","OAuth popup closed","By timeout"),this._updateConnectionStatus(i,!r,t)}_processForceLogoutUserByInactivityTimerInfoByStatus(e,t){1===e?(this._userActivityStatus=createActivityStatus(t.timeout,{ignoreVisibilityChange:!0}),
this._userActivityStatus.subscribe(this._onUserActivityStatusChange)):null!==this._userActivityStatus&&this._unsubscribeUserActivityStatus()}async _selectLastBroker(e={}){const{isConcurrentConnectionAllowed:t}=e,i=await he.get();return null!==i&&(await this._selectBrokerInternal({brokerId:i,isUserAction:!1,isConcurrentConnectionAllowed:t}),!0)}_updateOrderPanelSpinnerState(){const e=this._orderViewController,t=2===this.connectStatus(),i=null!==e&&e.stateChanging.value();this.tradingPanel.isLoading.setValue(t||i)}_showConnectWarningMessage(e){const t=e.title??r.t(null,void 0,i(166231)),s=e.message;e.displayType===E.ConnectWarningMessageDisplayType.PopUp&&(0,Ne.showSimpleConfirmDialog)({title:t,text:s,mainButtonText:e.mainButtonText??r.t(null,void 0,i(819295)),mainButtonIntent:"primary",checkboxLabel:r.t(null,void 0,i(127328)),showDisableConfirmationsCheckbox:e.skippable??!0,showCancelButton:!1,closeOnOutsideClick:e.closeOnOutsideClick}),e.displayType===E.ConnectWarningMessageDisplayType.Notification&&(this._showNotification(t,s,2,1e4),x.enabled("show_trading_notifications_history")&&this._addNotificationRow(t,s,2))}async _updateConnectionStatus(e,t=!0,i){this._updateOrderPanelSpinnerState(),this._updateOrderPresetsManagerBroker(null),this.onConnectionStatusChange.fire(e,i),this._log("Connection status",ps[e]);this._activeBroker;if(this._abortController.abort(),this._abortController=new AbortController,3!==e&&4!==e||this._hideAllNotifications(),t){const e=this._activeBroker?.metainfo().id;void 0!==e&&await he.set(e)}null!==this._activeBroker?(3!==e&&4!==e||this._updateTradingPanelVisibility({isOpened:!1,shouldPersistState:!1}),1===e?(this._account=this._activeBroker.currentAccount(),this._guiAccessor.setBroker(this._activeBroker)):this._tradedContextLinking.clear()):(this._accountVerificationPromise=null,this._updateTradingPanelVisibility({isOpened:!1,shouldPersistState:!1}),this._guiAccessor.setBroker(null),this._tradedContextLinking.clear())}async _checkOrRemoveRealtimeDataIfNeeded(e){if(!e.configFlags.supportRealtimeDataCheck)return;const{realtimeDataPermissionsToggleConfig:t}=e;if(void 0===t)return void this.checkRealtimeDataPermissions();const s=`${ge.settingsKeys.REALTIME_DATA_ACCEPTED}.${e.id}`;switch(n.getValue(s)){case"true":return void this.checkRealtimeDataPermissions();case"false":return void this.removeRealtimeDataPermissions();default:const e=await showSimpleConfirmDialogWithSolutionLink({title:t.enableRealtimeDataPermissionsTitleText,text:t.enableRealtimeDataPermissionsToggleText,mainButtonText:r.t(null,void 0,i(605954)),cancelButtonText:r.t(null,void 0,i(612869)),showCloseButton:!1,closeOnOutsideClick:!1,mainButtonIntent:"primary",closeOnEscapePress:!1,solutionId:t.solutionId,showBackdrop:!0,closeOnBackDropClick:!1});e?await this.checkRealtimeDataPermissions():await this.removeRealtimeDataPermissions(),n.setValue(s,e)}}_verifyLiveAccount(){(0,s.ensureNotNull)(this._activeBroker)}_save(){vs({...ms(),noConfirmEnabled:+!!this.noConfirmEnabled.value(),qweqrq:+!!this.showOnlyRejectionNotifications.value(),
showPricesWithZeroVolume:+!!this._showPricesWithZeroVolume.value(),showSpread:+!!this._showSpread.value(),orderExecutedSoundParams:JSON.stringify({enabled:+!!this.orderExecutedSoundParams.enabled.value(),name:this.orderExecutedSoundParams.path.value(),volume:this.orderExecutedSoundParams.volume.value()})})}_loadState(){const e=ms();if(this.noConfirmEnabled.setValue(!!e.noConfirmEnabled),this.showOnlyRejectionNotifications.setValue(!!e.qweqrq),this._showPricesWithZeroVolume.setValue(!e.hasOwnProperty("showPricesWithZeroVolume")||Boolean(e.showPricesWithZeroVolume)),this._showSpread.setValue(!e.hasOwnProperty("showSpread")||Boolean(e.showSpread)),e.hasOwnProperty("orderExecutedSoundParams")&&void 0!==e.orderExecutedSoundParams){const t=JSON.parse(e.orderExecutedSoundParams);this.orderExecutedSoundParams.enabled.setValue(!!t.enabled),this.orderExecutedSoundParams.volume.setValue(t.volume??.5),this.orderExecutedSoundParams.path.setValue(bs(t.name)?t.name:this.orderExecutedSoundParams.path.value())}}async _migrateOldSettings(e){const t=e[this._showSellBuyButtonsKey];if(void 0!==t&&this._chartWidgetCollection){const e=this._chartWidgetCollection;await Promise.all(e.getAll().map((e=>new Promise((t=>{e.withModel(null,(()=>t))})))));for(const i of e.getAll()){const e=i.properties().childs().paneProperties.childs().legendProperties.child("showSellBuyButtons"===this._showSellBuyButtonsKey?"showTradingButtons":"showTradingButtonsMobile");e&&i.hasModel()&&i.model().setProperty(e,!!t,null)}const[i]=e.getAll();if(i.getSaveChartService()?.hasChanges()){await new Promise((e=>{i.getSaveChartService()?.getOnChanges().subscribe(null,e,!0)}));const e=ms();this._showSellBuyButtonsKey in e&&(delete e[this._showSellBuyButtonsKey],vs(e))}}}_makeShowSellBuyButtonsKey(){return"showSellBuyButtons"}_log(e,t){hs.logNormal(`${this._activeBroker?this._activeBroker.metainfo().id+" Trading: ":""}${e} - ${t}`)}_makeSureCanTrade(e){const t=this.activeBroker(),i=this.brokerCommandsUI();return t&&i?1===t.connectionStatus()||(this.toggleTradingWidget(e),!1):(this.toggleTradingWidget(e).then((()=>this.onNeedSelectBroker.fire())),!1)}_checkAndPlaceOrder(e,t=!1,i){this._makeSureCanTrade(i)&&(!1===t&&this._tradedContextLinking.clear(),(0,s.ensureNotNull)(this.brokerCommandsUI()).placeOrder(e,!0,void 0,void 0,t))}_checkAndOpenOrderDialog(e,t){this._makeSureCanTrade(t)&&(0,s.ensureNotNull)(this.brokerCommandsUI()).placeOrder(e)}_makeSubAction({symbol:e,visibleSymbol:t,side:s,orderType:o,orderPrices:n,currentQuotes:a,qty:l,gaOrigin:d,shortcutHint:u,isMainChartActions:c=!1}){const h=1===s?"Trading.Buy":"Trading.Sell",p=1===s?"Buy":"Sell",_=1===o?"Limit":3===o?"Stop":"StopLimit",g=function(e){return"altPrice"in e&&"formattedAltPrice"in e}(n),y=(0,Q.safeShortName)(t),b=p+_,m={BuyLimit:r.t(null,void 0,i(913571)).format({symbol:y,qty:(0,A.abbreviatedNumber)(l),value:n.formattedPrice}),SellStop:r.t(null,void 0,i(219027)).format({symbol:y,qty:(0,A.abbreviatedNumber)(l),value:n.formattedPrice}),SellLimit:r.t(null,void 0,i(132521)).format({symbol:y,qty:(0,
A.abbreviatedNumber)(l),value:n.formattedPrice}),BuyStop:r.t(null,void 0,i(253107)).format({symbol:y,qty:(0,A.abbreviatedNumber)(l),value:n.formattedPrice})},v={BuyLimit:r.t(null,void 0,i(913571)).format({symbol:y,qty:(0,A.abbreviatedNumber)(l),value:n.formattedPrice}),SellStop:r.t(null,void 0,i(219027)).format({symbol:y,qty:(0,A.abbreviatedNumber)(l),value:n.formattedPrice}),SellLimit:r.t(null,void 0,i(132521)).format({symbol:y,qty:(0,A.abbreviatedNumber)(l),value:n.formattedPrice}),BuyStop:r.t(null,void 0,i(253107)).format({symbol:y,qty:(0,A.abbreviatedNumber)(l),value:n.formattedPrice})};g&&(m.SellStopLimit=r.t(null,void 0,i(873554)).format({symbol:y,qty:(0,A.abbreviatedNumber)(l),value:n.formattedPrice,altValue:n.formattedAltPrice}),m.BuyStopLimit=r.t(null,void 0,i(278673)).format({symbol:y,qty:(0,A.abbreviatedNumber)(l),value:n.formattedPrice,altValue:n.formattedAltPrice}));const f=c?v:m;return{name:`trade-${p}-${_}`.toLowerCase(),action:()=>{this.trackEvent(d,`${p} ${_}`);const t=1===o?"limitPrice":"stopPrice",i={qty:l,side:s,symbol:e,type:o,seenPrice:(1===s?a?.ask:a?.bid)??null,currentQuotes:a};null!==n.price&&(i[t]=n.price),4===o&&g&&(i.limitPrice=n.altPrice),c?this._checkAndOpenOrderDialog(i):this._checkAndPlaceOrder(i,void 0,"chart_context")},iconId:h,text:f[b],statName:b,shortcutHint:u}}_createOrderController(){return null===this._orderControllerPromise&&(this._orderControllerPromise=Promise.resolve().then(i.bind(i,802672)).then((({OrderViewController:e})=>new e({tradingCommands:{onNeedSelectBroker:this.onNeedSelectBroker,realtimeProvider:this.realtimeProvider(),pipValueType$:this.pipValueType(),trackEvent:this.trackEvent,toggleTradingWidget:this.toggleTradingWidget.bind(this),toggleTradingPanelPopup:this.toggleTradingPanelPopup.bind(this),showErrorNotification:this.showErrorNotification.bind(this),getTradingSettingsStorage:()=>this._tradingSettingsStorage},tradingPanelCommands:{rootContainer:this.tradingPanel.rootContainer,container:this.tradingPanel.container,isOpened:this.tradingPanel.isOpened,isOpeningAvailable:this.tradingPanel.isOpeningAvailable,activePage:this.tradingPanel.activePage,close:this.tradingPanel.close.bind(this.tradingPanel),openPage:this.tradingPanel.openPage.bind(this.tradingPanel),setCoverIsShown:this.tradingPanel.setCoverIsShown.bind(this.tradingPanel)},qtySuggester:this._qtySuggester,tradingLinking:this._linking,orderViewHeaderState:this._orderPanelHeaderState,orderPresetsManager:this._orderPresetsManager,tradedContextLinking:void 0,orderByIdGetter:e=>this._ordersService.find(e),positionByIdGetter:e=>this._positionService.find(e),abortSignalGetter:()=>this._abortController.signal,trackOrderPresetSnowplowEvent:this._trackOrderPresetSnowplowEvent}))).then((e=>{this._orderControllerPromise=null,this._orderViewController=e,this._orderViewController.stateChanging.subscribe((()=>this._updateOrderPanelSpinnerState())),this._orderViewController.dialogVisibility.subscribe(this._makeDialogVisibilityHandler(this._orderDialogVisibility))}))),this._orderControllerPromise}
async _registerCustomSources(e){!async function(e,t){const s=await Promise.all([i.e(5018),i.e(4587),i.e(8865),i.e(6775),i.e(2650)]).then(i.bind(i,118875));e.addCustomSource("bidask",((i,r)=>new s.BidAsk(i,r,t.realtimeProvider(),(()=>{e.activeChartWidget.value().showGeneralChartProperties(N.TabNames.scales)}))))}(e,this),Mt(e,this,this.showTradedSources);new((await Promise.all([i.e(7205),i.e(4587),i.e(6775),i.e(1652)]).then(i.bind(i,697540))).TradedSourcesManager)({chartWidgetCollection:e,ordersService:this._ordersService,positionsService:this._positionService,styleOverridesGetter:()=>this._tradedGroupStyleOverrides,noConfirmEnabledGetter:()=>this.noConfirmEnabled.value(),noConfirmEnabled:this.noConfirmEnabled.readonly(),tradingServices:{activeTradedLinking:this._tradedContextLinking,showTradedSources:this.showTradedSources,realtimeProvider:this._realtimeProvider,qtySuggester:this._qtySuggesterWithOrderSizeCalculatorResetting,brokerCommandsUI:this.brokerCommandsUI.bind(this),tradingPanelCloser:this._closePanelOrDialogs,trackEvent:this.trackEvent,pipValueType$:this.pipValueType(),makeActualSymbolObservable:this.makeActualSymbolObservable.bind(this),getSymbolSpecificTradingOptions:e=>(0,s.ensureNotNull)(this._activeBroker).getSymbolSpecificTradingOptions(e),onCalculatorOpened:this._handleQtyCalculatorOpening}})}_registerCustomWidgets(e){fs&&function(e){const{trading:t,qtySuggester:i,orderPresetsManager:s,chartWidgetCollection:r,onCalculatorOpened:o,trackOrderPresetSnowplowEvent:n}=e;r.addCustomWidgetToLegend(((e,r,a)=>{const l=e.mainSeries(),d=(0,Ct.createWVFromGetterAndSubscriptions)((()=>l.isFailed()||"economic"===l.symbolInfo()?.type),[l.dataEvents().symbolResolved(),l.dataEvents().symbolError(),l.dataEvents().unsupportedResolutionRequested()]),u=e.properties().childs().paneProperties.childs().legendProperties.childs();return new Vi({chartModel:e,dataEvents:l.dataEvents(),getSymbolName:$i(l),isNonTradableInstrument:d.ownership(),qtySuggester:i,tradingCommands:{onNeedSelectBroker:t.onNeedSelectBroker,realtimeProvider:t.realtimeProvider(),onBrokerConnectionStatusChange:t.onConnectionStatusChange,brokerConnectionStatus:t.connectStatus.bind(t),trackEvent:t.trackEvent,toggleTradingWidget:t.toggleTradingWidget.bind(t),toggleTradingPanelPopup:t.toggleTradingPanelPopup.bind(t),brokerCommandsUI:t.brokerCommandsUI.bind(t),toggleMinimizeBottomWidgetBar:()=>t.toggleMinimizeBottomWidgetBar(),makeActualSymbolObservable:t.makeActualSymbolObservable.bind(t),isInReplay:()=>t.isInReplay(),onCalculatorOpened:o,trackOrderPresetSnowplowEvent:n},settings:{showSellBuyButtons:(0,$t.convertPropertyToWatchedValue)(u.showTradingButtons).ownership(),noConfirmEnabled:t.noConfirmEnabled.spawnOwnership(),themeName:r.ownership(),visuallyHidden:a.ownership()},hibernated:e.collapsed().spawnOwnership(),backgroundTopColor:e.backgroundTopColor().spawnOwnership(),orderPresetsManager:s})}),{block:0,position:0})}({trading:this,chartWidgetCollection:e,orderPresetsManager:this._orderPresetsManager,
trackOrderPresetSnowplowEvent:this._trackOrderPresetSnowplowEvent,qtySuggester:this._qtySuggesterWithOrderSizeCalculatorResetting,onCalculatorOpened:this._handleQtyCalculatorOpening})}async _makeSubActions(e){const{symbol:t,context:i,gaOrigin:s,hideNotExecutableAction:r=!1}=e;if(null===i.value||(0,u.isNaN)(i.value))return[];const o=this.activeBroker();let n,a,l,d,c,h,p,_,g,y,b,m,v,f,P=null===o,S=null===o,k=!r&&null===o,C=!r&&null!==o,T=!r&&null===o;null!==o&&1===o.connectionStatus()&&(v=await o.isTradable(t),f=await o.getSymbolSpecificTradingOptions(t));const[B,E,V,{ask:$,bid:D}]=await Promise.all([this._qtySuggester.getQty(t),this._realtimeProvider.symbolInfo(t),this._realtimeProvider.formatter(t),this._realtimeProvider.quotesSnapshot(t)]);if(void 0===$||void 0===D)return[];const L=E.variableMinTick?(0,I.makeVariableMinTickData)(E.minTick,E.variableMinTick):void 0,x=e=>(0,I.getMinTick)({minTick:E.minTick,price:e,variableMinTickData:L});if(null!==o&&v&&v.tradable){const e=o.metainfo().configFlags,t=(0,M.alignToStep)(i.value,x(i.value));n=t,l=t,d=t,a=t,c=w()(d).plus(x(d)).toNumber(),h=w()(a).minus(x(a)).toNumber(),P=Boolean(e.supportLimitOrders&&(0,O.isOrderTypeAllowed)(1,f?.allowedOrderTypes)),S=Boolean(e.supportStopOrders&&(0,O.isOrderTypeAllowed)(3,f?.allowedOrderTypes)),T=Boolean(e.supportStopLimitOrders&&(0,O.isOrderTypeAllowed)(4,f?.allowedOrderTypes)),k=Boolean(e.supportStopOrdersInBothDirectionsInUI),C=Boolean(e.supportStopLimitOrdersInBothDirections),void 0!==E.limitPriceStep&&(n=(0,me.roundToStepByPriceTypeAndSide)(i.value,E.limitPriceStep,1,1),l=(0,me.roundToStepByPriceTypeAndSide)(i.value,E.limitPriceStep,1,-1),c=(0,me.roundToStepByPriceTypeAndSide)(w()(i.value).plus(x(i.value)).toNumber(),E.limitPriceStep,1,1),h=(0,me.roundToStepByPriceTypeAndSide)(w()(i.value).minus(x(i.value)).toNumber(),E.limitPriceStep,1,-1)),void 0!==E.stopPriceStep&&(d=(0,me.roundToStepByPriceTypeAndSide)(i.value,E.stopPriceStep,2,1),a=(0,me.roundToStepByPriceTypeAndSide)(i.value,E.stopPriceStep,2,-1)),p=V.format(n),_=V.format(a),g=V.format(l),y=V.format(d),b=V.format(c),m=V.format(h)}else n=l=d=a=i.value,p=_=g=y=i.formattedValue,c=w()(d).plus(x(d)).toNumber(),h=w()(a).minus(x(a)).toNumber(),b=V.format(c),m=V.format(h);const A={ask:$,bid:D},q=(D+$)/2,R=[],{symbol:F}=await this.getVisibleSymbol(t);if(i.value<$&&i.value>D){if(P){const e={price:n,formattedPrice:p};R.push(this._makeSubAction({symbol:t,visibleSymbol:F,side:1,orderType:1,orderPrices:e,shortcutHint:Ts,qty:B,gaOrigin:s,currentQuotes:A}));const i={price:l,formattedPrice:g};R.push(this._makeSubAction({symbol:t,visibleSymbol:F,side:-1,orderType:1,orderPrices:i,shortcutHint:Bs,qty:B,gaOrigin:s,currentQuotes:A}))}}else if(i.value<=q){if(P){const e={price:n,formattedPrice:p};R.push(this._makeSubAction({symbol:t,visibleSymbol:F,side:1,orderType:1,shortcutHint:Ts,orderPrices:e,qty:B,gaOrigin:s,currentQuotes:A}))}if(k){const e={price:d,formattedPrice:y};R.push(this._makeSubAction({symbol:t,visibleSymbol:F,side:1,orderType:3,orderPrices:e,qty:B,gaOrigin:s,currentQuotes:A}))}if(S||k){
const e={price:a,formattedPrice:_};R.push(this._makeSubAction({symbol:t,visibleSymbol:F,side:-1,orderType:3,orderPrices:e,qty:B,gaOrigin:s,currentQuotes:A}))}if(T){const e={symbol:t,visibleSymbol:F,side:-1,orderType:4,orderPrices:{price:a,formattedPrice:_,altPrice:h,formattedAltPrice:m},qty:B,gaOrigin:s,currentQuotes:A};R.push(this._makeSubAction(e)),C&&R.push(this._makeSubAction({...e,side:1}))}}else{if(P){const e={price:l,formattedPrice:g};R.push(this._makeSubAction({symbol:t,visibleSymbol:F,side:-1,orderType:1,shortcutHint:Bs,orderPrices:e,qty:B,gaOrigin:s,currentQuotes:A}))}if(k){const e={price:a,formattedPrice:_};R.push(this._makeSubAction({symbol:t,visibleSymbol:F,side:-1,orderType:3,orderPrices:e,qty:B,gaOrigin:s,currentQuotes:A}))}if(S||k){const e={price:d,formattedPrice:y};R.push(this._makeSubAction({symbol:t,visibleSymbol:F,side:1,orderType:3,orderPrices:e,qty:B,gaOrigin:s,currentQuotes:A}))}if(T){const e={symbol:t,visibleSymbol:F,side:1,orderType:4,orderPrices:{price:d,formattedPrice:y,altPrice:c,formattedAltPrice:b},qty:B,gaOrigin:s,currentQuotes:A};R.push(this._makeSubAction(e)),C&&R.push(this._makeSubAction({...e,side:-1}))}}return R}async _makeContextMenuTradeActions(e){const{symbol:t,context:s,gaOrigin:o}=e;if(null===s.value||(0,u.isNaN)(s.value))return[];const n=this.activeBroker(),d=null!==n&&1===n.connectionStatus();let c,h,p,_,g,y,b,m,v,f,P,S,k,C,T,B=!0,E=!0;d&&(C=await n.isTradable(t),T=await n.getSymbolSpecificTradingOptions(t));const[V,$,L,{ask:x,bid:A}]=await Promise.all([this._qtySuggester.getQty(t),this._realtimeProvider.symbolInfo(t),this._realtimeProvider.formatter(t),this._realtimeProvider.quotesSnapshot(t)]);if(void 0===x||void 0===A)return[];const q=$.variableMinTick?(0,I.makeVariableMinTickData)($.minTick,$.variableMinTick):void 0,R=e=>(0,I.getMinTick)({minTick:$.minTick,price:e,variableMinTickData:q});if(d&&C&&C.tradable){const e=n.metainfo().configFlags,t=(0,M.alignToStep)(s.value,R(s.value));if(h=t,_=t,g=t,p=t,y=w()(g).plus(R(g)).toNumber(),b=w()(p).minus(R(p)).toNumber(),B=Boolean(e.supportLimitOrders&&(0,O.isOrderTypeAllowed)(1,T?.allowedOrderTypes)),E=Boolean(e.supportStopOrders&&(0,O.isOrderTypeAllowed)(3,T?.allowedOrderTypes)),c=Boolean(e.supportStopLimitOrders&&(0,O.isOrderTypeAllowed)(4,T?.allowedOrderTypes)),void 0!==$.limitPriceStep){h=(0,me.roundToStepByPriceTypeAndSide)(s.value,$.limitPriceStep,1,1),_=(0,me.roundToStepByPriceTypeAndSide)(s.value,$.limitPriceStep,1,-1);const e=w()(s.value);y=(0,me.roundToStepByPriceTypeAndSide)(e.plus(R(s.value)).toNumber(),$.limitPriceStep,1,1),b=(0,me.roundToStepByPriceTypeAndSide)(e.minus(R(s.value)).toNumber(),$.limitPriceStep,1,-1)}void 0!==$.stopPriceStep&&(g=(0,me.roundToStepByPriceTypeAndSide)(s.value,$.stopPriceStep,2,1),p=(0,me.roundToStepByPriceTypeAndSide)(s.value,$.stopPriceStep,2,-1)),m=L.format(h),v=L.format(p),f=L.format(_),P=L.format(g),S=L.format(y),k=L.format(b)}else h=_=g=p=s.value,m=v=f=P=s.formattedValue;const F={ask:x,bid:A},N=[],{symbol:Q}=await this.getVisibleSymbol(t);if(B&&s.value<x){const e={price:h,
formattedPrice:m};N.push(this._makeSubAction({symbol:t,visibleSymbol:Q,side:1,orderType:1,orderPrices:e,shortcutHint:Ts,qty:V,gaOrigin:o,currentQuotes:F}))}if(B&&s.value>A){const e={price:_,formattedPrice:f};N.push(this._makeSubAction({symbol:t,visibleSymbol:Q,side:-1,orderType:1,orderPrices:e,shortcutHint:Bs,qty:V,gaOrigin:o,currentQuotes:F}))}if(E&&s.value<=A){const e={price:p,formattedPrice:v};N.push(this._makeSubAction({symbol:t,visibleSymbol:Q,side:-1,orderType:3,orderPrices:e,qty:V,gaOrigin:o,currentQuotes:F}))}if(E&&s.value>=x){const e={price:g,formattedPrice:P};N.push(this._makeSubAction({symbol:t,visibleSymbol:Q,side:1,orderType:3,orderPrices:e,qty:V,gaOrigin:o,currentQuotes:F}))}if(c&&s.value<=A){const e={price:p,formattedPrice:v,altPrice:y,formattedAltPrice:S};N.push(this._makeSubAction({symbol:t,visibleSymbol:Q,side:-1,orderType:4,orderPrices:e,qty:V,gaOrigin:o,currentQuotes:F}))}if(c&&s.value>=x){const e={price:g,formattedPrice:P,altPrice:b,formattedAltPrice:k};N.push(this._makeSubAction({symbol:t,visibleSymbol:Q,side:1,orderType:4,orderPrices:e,qty:V,gaOrigin:o,currentQuotes:F}))}const{displaySymbol:U,value:W,formattedValue:z}=s,j={name:"trade-new-order",action:()=>{const{symbol:e}=this._linking.value();e!==t&&this._linking.setSymbol(t),this.trackEvent(o,"New Order"),this._checkAndOpenOrderDialog({symbol:t,qty:V,limitPrice:W,stopPrice:W},"chart_context")},text:(0,D.appendEllipsis)(r.t(null,void 0,i(116706)).format({displaySymbol:U,formattedValue:z})),iconId:"Trading.AddOrder",statName:"NewOrder",shortcutHint:(0,l.humanReadableHash)(a.Modifiers.Shift+84)};return N.push(j),N}_initPaidBrokersByUserRegion(){this._brokersPlansPromise=Promise.resolve([])}async _getBrokersPlans(){let e=[];try{if(e=await this._brokersPlansPromise,!Array.isArray(e))throw new Error("Request result is not valid")}catch(e){hs.logError(`Failed to fetch broker list by user region: ${e.message}`)}return e}async _getBrokerPlanByIntegrationId(e){return(await this._getBrokersPlans()).find((t=>t.integrations.some((({slug_name:t})=>e===t))))}async _showRestoreConfirmations(){const e=await(0,Ne.showSimpleConfirmDialog)({title:r.t(null,void 0,i(18240)),text:r.t(null,void 0,i(492299)),mainButtonIntent:"primary"});null!==this._activeBroker&&e&&((new pe.DisabledConfirmations).clear(),this._activeBroker?.resetConfirmations())}_logOut(e,t,i){const r=(0,s.ensureNotNull)(this._activeBroker);r.connectionStatusUpdate.unsubscribe(this,this._connectionListener),r.currentAccountUpdate.unsubscribe(this,this._onCurrentAccountUpdate),this._realtimeProvider.onStatusChanged.unsubscribe(null,this._setPipValueType),this._realtimeProvider.onStatusChanged.unsubscribe(null,this._trackNonTradableSymbol),null!==this._userActivityStatus&&this._unsubscribeUserActivityStatus(),r.disconnect(t||!e),r.destroy(),this._activeBroker=null,t||he.clear(),this._updateConnectionStatus(3,e,i)}async _createTradedItemsChartCollectionFacade(e){
return new((await Promise.all([i.e(5018),i.e(4587),i.e(8865),i.e(6775),i.e(2650)]).then(i.bind(i,221824))).TradedItemsChartCollectionFacade)(e)}_tradeNowInit(){const e=new URL(decodeURIComponent(window.location.href)),t=e.searchParams.get("trade-now"),i=e.searchParams.get("trade-now-source");e.searchParams.delete("trade-now"),e.searchParams.delete("trade-now-source"),window.history.replaceState(null,document.title,e.toString()),null!==t&&(this._tradeNowBrokerId=t,this._tradeNowSource=i,he.clear())}async _getPriceByCrossHair(){const e=this._chartWidgetCollection?.activeChartWidget.value();if(!0!==e?.isHovered().value())return null;const t=e.model().model().crosshairSource().price;if((0,u.isNaN)(t))return null;const i=await this._realtimeProvider.symbolInfo(this._linking.value().symbol),s=i.variableMinTick?(0,I.makeVariableMinTickData)(i.minTick,i.variableMinTick):void 0,r=(0,I.getMinTick)({minTick:i.minTick,price:t,variableMinTickData:s});return(0,O.alignToMinTick)(t,r)}_unsubscribeUserActivityStatus(){this._userActivityStatus?.unsubscribe(this._onUserActivityStatusChange),this._userActivityStatus=null}_getForceLogoutUserByInactivityTimerInfo(){return this._activeBroker?.metainfo().forceLogoutUserByInactivityTimerInfo}}},514970:(e,t,i)=>{"use strict";i.d(t,{checkQtyError:()=>l});var s=i(609838),r=i(960521),o=i.n(r);const n={min:s.t(null,void 0,i(96248)),max:s.t(null,void 0,i(59195)),step:s.t(null,void 0,i(3094))},a=s.t(null,void 0,i(784830));function l(e,t,i=!1){if(null===t)return{res:!0,msg:a};const s=e.step,r=e.min,l=e.max;if(t<r)return{res:!0,msg:n.min.format({min:r.toString()})};if(t>l)return{res:!0,msg:n.max.format({max:l.toString()})};const d=new(o())(t).minus(r).mod(s);return i&&!d.eq(0)?{res:!0,msg:n.step.format({step:s.toString()})}:{res:!1}}},558042:(e,t,i)=>{"use strict";i.d(t,{validateBalance:()=>a});var s=i(609838);const r=s.t(null,void 0,i(880452));function o(e,t){return s.t(null,{replace:{amount:String(e),currency:t}},i(544668))}function n(e,t,i){return null===e||null===t||e<=t?{res:!1}:{res:!0,msg:0!==t&&void 0!==i?`${r} ${o(t,i)}`:r}}function a(e){const{side:t,baseValue:i,baseBalanceValue:s,baseCurrency:r,quoteValue:o,quoteBalanceValue:a,quoteCurrency:l}=e;return-1===t?n(i,s,r):n(o,a,l)}},195321:(e,t,i)=>{"use strict";i.d(t,{checkBracketError:()=>b,makeBracketPercentPriceRuleChecker:()=>_});var s=i(609838),r=i(960521),o=i.n(r),n=i(894862),a=i(760775),l=i(166554),d=i(545373);const u={orderStopLoss:{long:s.t(null,void 0,i(91189)),short:s.t(null,void 0,i(753689))},orderTakeProfit:{long:s.t(null,void 0,i(327163)),short:s.t(null,void 0,i(482810))},positionStopLoss:{long:e=>s.t(null,{replace:{value:e}},i(833928)),short:e=>s.t(null,{replace:{value:e}},i(547602))},positionTakeProfit:{long:e=>s.t(null,{replace:{value:e}},i(345417)),short:e=>s.t(null,{replace:{value:e}},i(442403))}},c=1e13,h=-c,p={greaterThanMax:s.t(null,{replace:{max:String(c)}},i(625289)),lessThanMin:s.t(null,{replace:{min:String(h)}},i(443797))};function _({minPercent:e,maxPercent:t,isExpandedBoundary:r}){let a,d;const u=(e,t,i,s)=>{
const r=new(o())(t),n=r.mul(e).div(100);return r.minus(n.mul(i).mul(s)).toNumber()};return o=>{const{bracketPrice:c,originalBracketPrice:h,parentPrice:p,side:_,bracketType:g,priceType:y,priceStep:b}=o,m=-1===_?-1:1,v=g===n.BracketType.TakeProfit?-1:1,f=u(e,p,m,v),P=u(t,p,m,v),S=(0,l.roundToStepByPriceTypeAndSide)(f,b,y,_),k=(0,l.roundToStepByPriceTypeAndSide)(P,b,y,_),C=void 0!==h?h:c;a??=r?C:1/0,d??=r?C:-1/0;const T=Math.min(S,k,a),w=Math.max(S,k,d);if(!(c>=T&&c<=w))return{res:!0,msg:s.t(null,void 0,i(514236)).replace("{min}",T.toString()).replace("{max}",w.toString())};return(m*v==-1?S>=p&&k>=p:S<=p&&k<=p)?{res:!1}:{res:!0,msg:s.t(null,void 0,i(798702))}}}function g(e){const{side:t,price:i,originalBracketPrice:s,priceType:r,priceStep:o,parentPrice:n,bracketType:a,isStatusEditing:l,isEnabled:d,bracketPercentPriceRuleCheckers:u}=e;for(const e of u){const u=e({bracketPrice:i,originalBracketPrice:s,parentPrice:n,side:t,bracketType:a,priceType:r,priceStep:o,isStatusEditing:l,isEnabled:d});if(u.res)return u}return{res:!1}}function y(e){const{quotes:t,side:r,price:o,originalBracketPrice:l,priceType:d,priceStep:c,parentPrice:h,bracketType:p,isStatusEditing:_,isEnabled:y,bracketPercentPriceRuleCheckers:b}=e;let m={res:!1};b.length>0&&(m=g({side:r,price:o,originalBracketPrice:l,priceType:d,priceStep:c,parentPrice:h,bracketType:p,isStatusEditing:_,isEnabled:y,bracketPercentPriceRuleCheckers:b}));const v=(p===n.BracketType.TakeProfit?-1:1)*r,f=-1===r?(0,a.getAsk)(t):(0,a.getBid)(t);if(f&&Math.sign(o-f)===v){const e=p===n.BracketType.TakeProfit?u.positionTakeProfit:u.positionStopLoss,t=-1===r?s.t(null,void 0,i(115822)):s.t(null,void 0,i(473220));m={res:!0,msg:-1===r?e.short(t):e.long(t)}}return m}function b(e){const{quotes:t,side:r,price:o,originalBracketPrice:l,pips:_,priceType:b,priceStep:m,parentPrice:v,parentType:f,bracketType:P,isStatusEditing:S,isEnabled:k,bracketPercentPriceRuleCheckers:C,priceFormatter:T,isRoundToPriceStep:w,validateAgainstMarket:B=!1}=e;if(null===o||null===_)return{res:!0,msg:s.t(null,void 0,i(405196))};let O={res:!1};return O=2===f&&B?y({quotes:t,side:r,price:o,originalBracketPrice:l,priceType:b,priceStep:m,parentPrice:(0,a.getQuotePrice)(t,1===r?-1:1),bracketType:P,isStatusEditing:S,isEnabled:k,bracketPercentPriceRuleCheckers:C}):2===f?y({quotes:t,side:r,price:o,originalBracketPrice:l,priceType:b,priceStep:m,parentPrice:v,bracketType:P,isStatusEditing:S,isEnabled:k,bracketPercentPriceRuleCheckers:C}):function(e){const{side:t,pips:r,price:o,originalBracketPrice:a,priceType:l,priceStep:_,parentPrice:y,bracketType:b,isStatusEditing:m,isEnabled:v,bracketPercentPriceRuleCheckers:f}=e;let P={res:!1};f.length>0&&(P=g({side:t,price:o,originalBracketPrice:a,priceType:l,priceStep:_,parentPrice:y,bracketType:b,isStatusEditing:m,isEnabled:v,bracketPercentPriceRuleCheckers:f}));const S=(0,d.checkValueBoundaries)({value:o,min:h,max:c,boundariesErrorMessages:p});if(!S.isPassed)return{res:!0,msg:S.msg??s.t(null,void 0,i(160523))};if(r<=0){const e=b===n.BracketType.TakeProfit?u.orderTakeProfit:u.orderStopLoss;P={
res:!0,msg:1===t?e.long:e.short}}return P}({side:r,pips:_,price:o,originalBracketPrice:l,priceType:b,priceStep:m,parentPrice:v,bracketType:P,isStatusEditing:S,isEnabled:k,bracketPercentPriceRuleCheckers:C}),!O.res&&w&&(O=function(e,t,r){return(0,a.isMintickMultiple)(e,t)?{res:!1}:{res:!0,msg:s.t(null,void 0,i(173069)).format({minTick:r.format(t)})}}(o,m,T)),O}},769242:(e,t,i)=>{"use strict";i.d(t,{makeStopLimitPercentPriceRuleChecker:()=>c,validatePrice:()=>h});var s=i(609838),r=i(960521),o=i.n(r),n=i(760775),a=i(166554);const l=s.t(null,void 0,i(10833));function d(e,t){return o()(e).minus(t).abs().gt(o()(e).div(2))}function u(e,t,i,s){const r=new(o())(t),n=r.mul(e).div(100);return r.minus(n.mul(i).mul(s)).toNumber()}function c(e,t){return r=>{const{orderPrice:o,originalOrderPrice:n,currentPrice:l,side:d,orderType:c,priceStep:h,priceType:p,isStatusEditing:_}=r,g=-1===d?1:-1,y=3===c?1:-1,b=u(e,l,g,y),m=u(t,l,g,y),v=(0,a.roundToStepByPriceTypeAndSide)(b,h,p,d),f=(0,a.roundToStepByPriceTypeAndSide)(m,h,p,d);let P=Math.min(v,f),S=Math.max(v,f);_&&void 0!==n&&(P=Math.min(P,n),S=Math.max(S,n));return o>=P&&o<=S?{res:!1}:{res:!0,severity:"error",msg:s.t(null,void 0,i(775364)).replace("{min}",P.toString()).replace("{max}",S.toString())}}}function h(e){const{price:t,originalOrderPrice:r,askOrBid:a,orderType:u,side:c,priceType:h,isForex:p,formatter:_,isStatusEditing:g,stopLimitPercentPriceRuleCheckers:y,supportStopOrdersInBothDirections:b,supportStopLimitOrdersInBothDirections:m,supportStrictCheckingLimitOrderPrice:v,step:f,roundedToStep:P}=e;for(const e of y){const i=e({orderPrice:t,originalOrderPrice:r,currentPrice:a,side:c,orderType:u,priceStep:f,priceType:h,isStatusEditing:g});if(i.res)return i}if((!p||P)&&!1===(0,n.isMintickMultiple)(t,f))return{res:!0,severity:"error",msg:s.t(null,void 0,i(806280)).format({minTick:_.format(f)})};const S=t<0||o()(a).mul(100).lt(t)||function(e){const{price:t,askOrBid:i,orderType:s,side:r,isStopPrice:o,supportStopOrdersInBothDirections:n,supportStopLimitOrdersInBothDirections:a,supportStrictCheckingLimitOrderPrice:l}=e;return 1===s?1===r?t>i&&(d(i,t)||l):t<i&&(d(i,t)||l):!!(3===s&&!n||4===s&&o&&!a)&&(1===r?t<i:t>i)}({price:t,askOrBid:a,orderType:u,side:c,isStopPrice:2===h,supportStopOrdersInBothDirections:b,supportStopLimitOrdersInBothDirections:m,supportStrictCheckingLimitOrderPrice:v});return S?{res:!0,severity:"error",msg:l}:{res:!1}}},160471:(e,t,i)=>{"use strict";i.d(t,{extractGuaranteedStopValidationRules:()=>y,extractLimitValidationRules:()=>g,extractStopLossValidationRules:()=>p,extractStopValidationRules:()=>_,extractTakeProfitValidationRules:()=>h,isLimitPercentValidationRule:()=>d,isStopLimitPercentValidationRule:()=>l,isStopPercentValidationRule:()=>u});const s=["tpPercent"],r=["slPercent"],o=["stopPercent"],n=["limitPercent"],a=["gsPercent"];function l(e){return d(e)||u(e)}function d(e){return n.includes(e.id)}function u(e){return o.includes(e.id)}async function c(e,t,i){return(await e.getValidationRules(t))?.filter((e=>i.includes(e.id)))}async function h(e,t){return c(e,t,s)}
async function p(e,t){return c(e,t,r)}async function _(e,t){return c(e,t,o)}async function g(e,t){return c(e,t,n)}async function y(e,t){return c(e,t,a)}},563859:(e,t,i)=>{"use strict";i.d(t,{abbreviatedNumber:()=>n});i(960521);var s=i(714635);const r=["","K","M","G","T","P"];function o(e){return e<r.length?r[e]:"e"+3*e}function n(e){if(e<1)return s.NumericFormatter.formatNoE(e);let t=0,i=+e;if(isFinite(i))for(;i>=1e3&&i%100==0;)t++,i/=1e3;return i+o(t)}},236941:(e,t,i)=>{"use strict";i.d(t,{createPrimitivePropertyFromWatchedValue:()=>r});var s=i(851127);function r(e){const t=(0,s.createPrimitiveProperty)(e.value()),i=e=>t.setValue(e);return t.destroy=()=>{e.release(),e.unsubscribe(i)},e.subscribe(i),t}},649008:(e,t,i)=>{"use strict";function s(e,t,i="promise rejected by time-out"){return new Promise(((s,r)=>{const o=setTimeout((()=>r(i)),t);e.then((e=>{clearTimeout(o),s(e)})),e.catch((e=>{clearTimeout(o),r(e)}))}))}i.d(t,{makeTimeLimited:()=>s})},891495:(e,t,i)=>{"use strict";function s(e){let t=Promise.resolve();return function(...i){const s=t.then((()=>e.apply(this,i)));return t=s.catch((()=>{})),s}}function r(...e){let t=Promise.resolve();return e.map((e=>function(...i){const s=t.then((()=>e.apply(this,i)));return t=s.catch((()=>{})),s}))}i.d(t,{sequentialize:()=>s,sequentializeAll:()=>r})},117105:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path stroke="currentColor" stroke-width="1.2" d="m1.5 1.5 21 21m0-21-21 21"/></svg>'},315130:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path stroke="currentColor" stroke-width="1.2" d="m1.5 1.5 15 15m0-15-15 15"/></svg>'},238822:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 14" width="14" height="14"><path stroke="currentColor" stroke-width="1.2" d="m1.5 1.5 11 11m0-11-11 11"/></svg>'},663346:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12" width="12" height="12"><path stroke="currentColor" stroke-width="1.2" d="m1.5 1.5 9 9m0-9-9 9"/></svg>'},534983:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 10" width="10" height="10"><path stroke="currentColor" stroke-width="1.2" d="m1.5 1.5 7 7m0-7-7 7"/></svg>'},512646:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" d="M7.84 13.7H5.78V4.4l2.48-.06c1.35 0 2.42.4 3.22 1.2.8.78 1.19 1.83 1.19 3.15 0 3.34-1.61 5.01-4.83 5.01zm-.41-7.85v6.35c.26.02.55.03.86.03.83 0 1.48-.3 1.95-.9.48-.6.72-1.46.72-2.54 0-2-.93-2.99-2.78-2.99-.18 0-.43.02-.75.05z"/></svg>'},552828:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" d="M13.4 5.9c-.41 1.62-1.16 2.43-2.25 2.43-.52 0-1.25-.15-2.2-.45-.93-.3-1.58-.45-1.96-.45-.55 0-.98.3-1.27.9H4.66c.1-.67.36-1.24.76-1.71.4-.48.86-.72 1.4-.72.56 0 1.31.16 2.27.46.95.3 1.62.45 2.01.45.64 0 1.06-.3 1.27-.9h1.03zm0 3.87c-.41 1.62-1.16 2.43-2.25 2.43-.52 0-1.25-.15-2.2-.45-.93-.3-1.58-.46-1.96-.46-.55 0-.98.3-1.27.9H4.66c.1-.67.36-1.24.76-1.7.4-.48.86-.72 1.4-.72.56 0 1.31.15 2.27.46.95.3 1.62.44 2.01.44.64 0 1.06-.3 1.27-.9h1.03z"/></svg>'},513729:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path stroke="currentColor" stroke-width="1.2" d="M7 6l15 15m0-15L7 21"/></svg>'},73359:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M9 6h11v.5c0 1.115-.442 2.004-1.273 2.593-.7.498-1.637.755-2.727.814v2.267c2.867.677 5 3.252 5 6.326v.5h-6v4h-1v-4H8v-.5a6.502 6.502 0 0 1 5-6.326V9.907c-1.09-.059-2.027-.316-2.727-.814C9.443 8.503 9 7.615 9 6.5V6zm1.043 1c.102.56.383.976.809 1.278.57.405 1.452.642 2.648.642h.5V13.006l-.417.07A5.503 5.503 0 0 0 9.023 18h10.955a5.503 5.503 0 0 0-4.56-4.924l-.418-.07V8.92h.5c1.196 0 2.078-.237 2.648-.642A1.93 1.93 0 0 0 18.958 7h-8.915z"/></svg>'},350146:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M16.621 4.6l.354.354 7.07 7.071.354.354-.353.353c-.789.789-1.73 1.104-2.734.934-.847-.144-1.691-.624-2.504-1.353l-1.603 1.603a6.502 6.502 0 0 1-.937 8.008l-.354.354-.354-.354-3.889-3.889-2.828 2.829-.707-.707 2.828-2.829-3.889-3.889-.353-.353.353-.354a6.502 6.502 0 0 1 8.009-.937l1.603-1.604c-.73-.812-1.21-1.656-1.353-2.503-.17-1.005.145-1.945.934-2.734l.353-.354zm.03 1.445a1.93 1.93 0 0 0-.331 1.476c.117.689.573 1.48 1.418 2.326l.354.354-.354.353-2.236 2.237-.3.299-.344-.246a5.503 5.503 0 0 0-6.706.258l3.873 3.873 3.873 3.873a5.503 5.503 0 0 0 .257-6.706l-.245-.345.299-.3 2.236-2.236.354-.353.354.353c.845.846 1.637 1.302 2.326 1.419a1.93 1.93 0 0 0 1.476-.332l-6.303-6.303z"/></svg>'},576594:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72" width="72" height="72"><path fill="#DBDBDB" fill-rule="evenodd" d="M55 13H13a5 5 0 0 0-5 5v31a5 5 0 0 0 5 5h31.09q-.09-.75-.09-1.5a12.5 12.5 0 0 1 16-12V18a5 5 0 0 0-5-5m8 28.82V18a8 8 0 0 0-8-8H13a8 8 0 0 0-8 8v31a8 8 0 0 0 8 8h31.83A12.5 12.5 0 1 0 63 41.82m3 10.68a9.5 9.5 0 1 1-19 0 9.5 9.5 0 0 1 19 0m-9.44-1.93-3.18-3.18-2.12 2.12 3.18 3.18-3.18 3.18L53.38 58l3.18-3.18L59.74 58l2.13-2.12-3.19-3.18 3.19-3.18-2.13-2.12zM42.25 37.7l1.05-1.03 8.05-7.89-2.1-2.14-7 6.86-7-6.86-2.1 2.14 8.05 7.9zm-16.5-7.9 1.05 1.03 8.05 7.89-2.1 2.14-7-6.86-7 6.86-2.1-2.14 8.05-7.9z"/></svg>'},769762:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72" width="72" height="72"><path fill="#0F0F0F" fill-rule="evenodd" d="M55 13H13a5 5 0 0 0-5 5v31a5 5 0 0 0 5 5h31.09q-.09-.75-.09-1.5a12.5 12.5 0 0 1 16-12V18a5 5 0 0 0-5-5m8 28.82V18a8 8 0 0 0-8-8H13a8 8 0 0 0-8 8v31a8 8 0 0 0 8 8h31.83A12.5 12.5 0 1 0 63 41.82m3 10.68a9.5 9.5 0 1 1-19 0 9.5 9.5 0 0 1 19 0m-9.44-1.93-3.18-3.18-2.12 2.12 3.18 3.18-3.18 3.18L53.38 58l3.18-3.18L59.74 58l2.13-2.12-3.19-3.18 3.19-3.18-2.13-2.12zM42.25 37.7l1.05-1.03 8.05-7.89-2.1-2.14-7 6.86-7-6.86-2.1 2.14 8.05 7.9zm-16.5-7.9 1.05 1.03 8.05 7.89-2.1 2.14-7-6.86-7 6.86-2.1-2.14 8.05-7.9z"/></svg>'},29834:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M7.5 13a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM5 14.5a2.5 2.5 0 1 1 5 0 2.5 2.5 0 0 1-5 0zm9.5-1.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM12 14.5a2.5 2.5 0 1 1 5 0 2.5 2.5 0 0 1-5 0zm9.5-1.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM19 14.5a2.5 2.5 0 1 1 5 0 2.5 2.5 0 0 1-5 0z"/></svg>'},829883:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 16" width="20" height="16"><path fill="currentColor" fill-rule="evenodd" d="M7.5 2.5C7.5 1.67 8.17 1 9 1h2c.83 0 1.5.67 1.5 1.5v.15h-5V2.5zm6 0v.15H17a2.5 2.5 0 0 1 2.5 2.5v8.35A2.5 2.5 0 0 1 17 16H3a2.5 2.5 0 0 1-2.5-2.5V5.15A2.5 2.5 0 0 1 3 2.65h3.5V2.5A2.5 2.5 0 0 1 9 0h2a2.5 2.5 0 0 1 2.5 2.5zm-12 2.65c0-.83.67-1.5 1.5-1.5h14c.83 0 1.5.67 1.5 1.5v8.35c0 .83-.67 1.5-1.5 1.5H3a1.5 1.5 0 0 1-1.5-1.5V5.15zM9.25 6.5a1.75 1.75 0 1 0 0 3.5h1.5a.75.75 0 0 1 0 1.5h-1.5a.75.75 0 0 1-.75-.75h-1c0 .97.78 1.75 1.75 1.75h.25v1h1v-1h.25a1.75 1.75 0 1 0 0-3.5h-1.5a.75.75 0 0 1 0-1.5h1.5c.41 0 .75.34.75.75h1c0-.97-.78-1.75-1.75-1.75h-.25v-1h-1v1h-.25z"/></svg>'}}]);